diff -r f059ec7ced7a -r b230ffa2ecdc .hgtags
--- a/.hgtags	Mon May 17 17:57:40 2010 +0200
+++ b/.hgtags	Mon Jul 12 18:48:04 2010 +0200
@@ -20,3 +20,4 @@ a896064c7d437112256daac0cf5f871aea426dc6
 07ab245be51987baf7bdeb814cc9a5ba99cac89e Pacemaker-1.1.0
 1dbbee9bc278a7a0e3cbfcc6768ebc7548b3c593 Pacemaker-1.1.1
 c6b59218ee949eebff30e837ff6f3824ed0ab86b Pacemaker-1.1.2
+f059ec7ced7a86f18e5490b67ebf4a0b963bccfe Pacemaker-1.1.2.1
diff -r f059ec7ced7a -r b230ffa2ecdc GNUmakefile
--- a/GNUmakefile	Mon May 17 17:57:40 2010 +0200
+++ b/GNUmakefile	Mon Jul 12 18:48:04 2010 +0200
@@ -41,6 +41,7 @@ RPM_OPTS	= --define "_sourcedir $(RPM_RO
 getdistro = $(shell test -e /etc/SuSE-release || echo fedora; test -e /etc/SuSE-release && echo suse)
 DISTRO ?= $(call getdistro)
 TAG    ?= tip
+WITH   ?= 
 
 initialize:
 	./autogen.sh
@@ -48,7 +49,13 @@ initialize:
 
 export:
 	rm -f $(TARFILE)
-	hg archive -t tbz2 -r $(TAG) $(TARFILE)
+	if [ $(TAG) = scratch ]; then 				\
+		hg commit -m "DO-NOT-PUSH";			\
+		hg archive -t tbz2 -r tip $(TARFILE);		\
+		hg rollback; 					\
+	else							\
+		hg archive -t tbz2 -r $(TAG) $(TARFILE);	\
+	fi
 	echo `date`: Rebuilt $(TARFILE)
 
 pacemaker-fedora.spec: pacemaker.spec
@@ -80,9 +87,10 @@ srpm:	export $(PACKAGE)-$(DISTRO).spec
 	rm -f *.src.rpm
 	rpmbuild -bs --define "dist .$(DISTRO)" $(RPM_OPTS) $(PACKAGE)-$(DISTRO).spec
 
+# eg. WITH="--with cman" make rpm
 rpm:	srpm
 	@echo To create custom builds, edit the flags and options in $(PACKAGE)-$(DISTRO).spec first
-	rpmbuild --rebuild $(RPM_ROOT)/*.src.rpm
+	rpmbuild $(RPM_OPTS) $(WITH) --rebuild $(RPM_ROOT)/*.src.rpm
 
 mock-nodeps:
 	-rm -rf $(RPM_ROOT)/mock
diff -r f059ec7ced7a -r b230ffa2ecdc Makefile.am
--- a/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -23,7 +23,7 @@ EXTRA_DIST              = autogen.sh Con
 MAINTAINERCLEANFILES    = Makefile.in aclocal.m4 configure DRF/config-h.in \
                         DRF/stamp-h.in libtool.m4 ltdl.m4 libltdl.tar
 
-SUBDIRS	= $(LIBLTDL_DIR) replace include lib pengine cib crmd fencing tools shell xml cts extra doc
+SUBDIRS	= $(LIBLTDL_DIR) replace include lib mcp pengine cib crmd fencing tools shell xml cts extra doc
 
 doc_DATA = AUTHORS COPYING COPYING.LIB
 
@@ -36,7 +36,7 @@ install-exec-local:
 	$(INSTALL) -d -m 750 $(DESTDIR)/$(CRM_STATE_DIR)
 	-chown $(CRM_DAEMON_USER):$(CRM_DAEMON_GROUP) $(DESTDIR)/$(CRM_CONFIG_DIR)
 	-chown $(CRM_DAEMON_USER):$(CRM_DAEMON_GROUP) $(DESTDIR)/$(CRM_STATE_DIR)
-if BUILD_AIS_SUPPORT
+if BUILD_CS_SUPPORT
 	rm -f $(DESTDIR)$(LCRSODIR)/pacemaker.lcrso $(DESTDIR)$(LCRSODIR)/service_crm.so
 	cp $(DESTDIR)$(libdir)/service_crm.so $(DESTDIR)$(LCRSODIR)/pacemaker.lcrso
 endif
diff -r f059ec7ced7a -r b230ffa2ecdc cib/Makefile.am
--- a/cib/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/cib/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -33,6 +33,14 @@ COMMONLIBS	= $(top_builddir)/lib/common/
 halib_PROGRAMS	= cib cibmon
 sbin_PROGRAMS   = cibpipe
 
+if BUILD_HELP
+man8_MANS =	$(sbin_PROGRAMS:%=%.8)
+%.8:	%
+	echo Creating $@
+	chmod a+x $<
+	help2man --output $@ --no-info --section 8 --name "Part of the Pacemaker cluster resource manager" $(top_builddir)/cib/$<
+endif
+
 ## SOURCES
 noinst_HEADERS          = callbacks.h cibio.h cibmessages.h common.h notify.h
 
diff -r f059ec7ced7a -r b230ffa2ecdc cib/callbacks.c
--- a/cib/callbacks.c	Mon May 17 17:57:40 2010 +0200
+++ b/cib/callbacks.c	Mon Jul 12 18:48:04 2010 +0200
@@ -1085,7 +1085,7 @@ cib_peer_callback(xmlNode * msg, void* p
     }
 
     node = crm_get_peer(0, originator);
-    if(node == NULL || crm_is_member_active(node) == FALSE) {
+    if(node == NULL || (node->processes & crm_proc_cib) == 0) {
 	reason = "not in our membership";
 	goto bail;
     }
@@ -1268,7 +1268,7 @@ terminate_cib(const char *caller)
 	close(remote_tls_fd);
     }
     
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
     if(is_openais_cluster()) {
 	cib_ha_connection_destroy(NULL);
 	return;
diff -r f059ec7ced7a -r b230ffa2ecdc cib/cibmon.c
--- a/cib/cibmon.c	Mon May 17 17:57:40 2010 +0200
+++ b/cib/cibmon.c	Mon Jul 12 18:48:04 2010 +0200
@@ -85,7 +85,7 @@ main(int argc, char **argv)
 	};
 #endif
 
-	crm_log_init("cibmon", LOG_INFO, FALSE, FALSE, 0, NULL);
+	crm_log_init_quiet(NULL, LOG_INFO, FALSE, FALSE, argc, argv);
 
 	crm_signal(SIGTERM, cibmon_shutdown);
 	
diff -r f059ec7ced7a -r b230ffa2ecdc cib/cibpipe.c
--- a/cib/cibpipe.c	Mon May 17 17:57:40 2010 +0200
+++ b/cib/cibpipe.c	Mon Jul 12 18:48:04 2010 +0200
@@ -58,7 +58,7 @@ static struct cib_func_entry cib_pipe_op
     {CIB_OP_ERASE,      FALSE, cib_process_erase},
 };
 
-#define OPTARGS	"V?o:QDUCEX:t:MBfRx:P5S"
+#define OPTARGS	"V?o:QDUCEX:t:MBfRx:P5S$"
 
 int
 main(int argc, char ** argv)
@@ -108,6 +108,7 @@ main(int argc, char ** argv)
 	{"xml-save",    1, 0, 'S'},
 	{"obj_type",    1, 0, 'o'},
 
+	{"version",     0, 0, '$'},
 	{"verbose",     0, 0, 'V'},
 	{"help",        0, 0, '?'},
 
@@ -115,7 +116,7 @@ main(int argc, char ** argv)
     };
 #endif
 	
-    crm_log_init("cibpipe", LOG_ERR, FALSE, FALSE, 0, NULL);
+    crm_log_init_quiet(NULL, LOG_ERR, FALSE, FALSE, argc, argv);
 
     while (1) {
 #ifdef HAVE_GETOPT_H
@@ -190,6 +191,9 @@ main(int argc, char ** argv)
 	    case '?':		/* Help message */
 		usage(crm_system_name, LSB_EXIT_OK);
 		break;
+	    case '$':		/* Version message */
+		crm_help(flag, LSB_EXIT_OK);
+		break;
 	    default:
 		++argerr;
 		break;
diff -r f059ec7ced7a -r b230ffa2ecdc cib/common.c
--- a/cib/common.c	Mon May 17 17:57:40 2010 +0200
+++ b/cib/common.c	Mon Jul 12 18:48:04 2010 +0200
@@ -129,7 +129,8 @@ static enum cib_errors
 cib_cleanup_query(int options, xmlNode **data, xmlNode **output) 
 {
     CRM_DEV_ASSERT(*data == NULL);
-    if((options & cib_no_children) && (options & cib_xpath)) {
+    if((options & cib_no_children)
+       || safe_str_eq(crm_element_name(*output), "xpath-query")) {
 	free_xml(*output);
     }
     return cib_ok;
diff -r f059ec7ced7a -r b230ffa2ecdc cib/io.c
--- a/cib/io.c	Mon May 17 17:57:40 2010 +0200
+++ b/cib/io.c	Mon Jul 12 18:48:04 2010 +0200
@@ -116,6 +116,7 @@ validate_cib_digest(xmlNode *local_cib, 
 	length = ftell(expected_strm);
 	fseek(expected_strm, 0L, start);
 	
+	CRM_ASSERT(length >= 0);
 	CRM_ASSERT(start == ftell(expected_strm));
 
 	crm_debug_3("Reading %d bytes from file", length);
@@ -531,32 +532,58 @@ activateCibXml(xmlNode *new_cib, gboolea
 	return cib_ok;    
 }
 
+void crm_set_env_options(void);
+
 int
 write_cib_contents(gpointer p) 
 {
+	int exit_rc = LSB_EXIT_OK;
 	gboolean need_archive = FALSE;
 	struct stat buf;
 	char *digest = NULL;
-	int exit_rc = LSB_EXIT_OK;
 	xmlNode *cib_status_root = NULL;
+
+	xmlNode *local_cib = NULL;
 	
-	/* we can scribble on "the_cib" here and not affect the parent */
-	const char *epoch = crm_element_value(the_cib, XML_ATTR_GENERATION);
-	const char *admin_epoch = crm_element_value(the_cib, XML_ATTR_GENERATION_ADMIN);
+	char *tmp1 = NULL;
+	char *tmp2 = NULL;
+	char *digest_file = NULL;
+	char *primary_file = NULL;
 
-	char *tmp1 = crm_concat(cib_root, "cib.XXXXXX", '/');
-	char *tmp2 = crm_concat(cib_root, "cib.XXXXXX", '/');
+	const char *epoch = NULL;
+	const char *admin_epoch = NULL;
+	
+	if(p) {
+	    /* Synchronous write out */
+	    local_cib = copy_xml(p);
 
-	char *primary_file = crm_concat(cib_root, "cib.xml", '/');
-	char *digest_file = crm_concat(primary_file, "sig", '.');
+	} else {
+	    /* A-synchronous write out after a fork() */
+
+	    /* Do nothing until we've re-setup logging */
+	    crm_set_env_options();
+	    
+	    /* Don't log anything unless strictly necessary */
+	    crm_log_level = LOG_ERR;
+
+	    /* In theory we can scribble on "the_cib" here and not affect the parent
+	     * But lets be safe anyway
+	     */
+	    local_cib = copy_xml(the_cib);
+	}
+	
+	epoch = crm_element_value(local_cib, XML_ATTR_GENERATION);
+	admin_epoch = crm_element_value(local_cib, XML_ATTR_GENERATION_ADMIN);
+
+	tmp1 = crm_concat(cib_root, "cib.XXXXXX", '/');
+	tmp2 = crm_concat(cib_root, "cib.XXXXXX", '/');
+	
+	primary_file = crm_concat(cib_root, "cib.xml", '/');
+	digest_file = crm_concat(primary_file, "sig", '.');
 	
 	/* Always write out with num_updates=0 */
-	crm_xml_add(the_cib, XML_ATTR_NUMUPDATES, "0");
+	crm_xml_add(local_cib, XML_ATTR_NUMUPDATES, "0");
 	
-	if(crm_log_level > LOG_INFO) {
-	    crm_log_level--;
-	}
-
 	need_archive = (stat(primary_file, &buf) == 0);
 	if (need_archive) {
 	    char *backup_file = NULL;
@@ -566,7 +593,7 @@ write_cib_contents(gpointer p)
 	    /* check the admin didnt modify it underneath us */
 	    if(validate_on_disk_cib(primary_file, NULL) == FALSE) {
 		crm_err("%s was manually modified while the cluster was active!", primary_file);
-		exit_rc = LSB_EXIT_GENERIC;
+		exit_rc = 1;
 		goto cleanup;
 	    }
 
@@ -592,32 +619,32 @@ write_cib_contents(gpointer p)
 	 */
 	crm_debug("Writing CIB to disk");	    
 	if(p == NULL) {
-	    cib_status_root = find_xml_node(the_cib, XML_CIB_TAG_STATUS, TRUE);
+	    cib_status_root = find_xml_node(local_cib, XML_CIB_TAG_STATUS, TRUE);
 	    CRM_DEV_ASSERT(cib_status_root != NULL);
 	    
 	    if(cib_status_root != NULL) {
-		free_xml_from_parent(the_cib, cib_status_root);
+		free_xml_from_parent(local_cib, cib_status_root);
 	    }
 	}
 
 	tmp1 = mktemp(tmp1); /* cib    */
 	tmp2 = mktemp(tmp2); /* digest */
 	
-	if(write_xml_file(the_cib, tmp1, FALSE) <= 0) {
+	if(write_xml_file(local_cib, tmp1, FALSE) <= 0) {
 	    crm_err("Changes couldn't be written to %s", tmp1);
-		exit_rc = LSB_EXIT_GENERIC;
+		exit_rc = 2;
 		goto cleanup;
 	}
 	
 	/* Must calculate the digest after writing as write_xml_file() updates the last-written field */
-	digest = calculate_xml_digest(the_cib, FALSE, FALSE); 
+	digest = calculate_xml_digest(local_cib, FALSE, FALSE); 
 	crm_info("Wrote version %s.%s.0 of the CIB to disk (digest: %s)",
 		 admin_epoch?admin_epoch:"0",
 		 epoch?epoch:"0", digest);	
 
-	if(write_cib_digest(the_cib, tmp2, digest) <= 0) {
+	if(write_cib_digest(local_cib, tmp2, digest) <= 0) {
 	    crm_err("Digest couldn't be written to %s", tmp2);
-		exit_rc = LSB_EXIT_GENERIC;
+		exit_rc = 3;
 		goto cleanup;
 	}
 	crm_debug("Wrote digest %s to disk", digest);
@@ -636,12 +663,14 @@ write_cib_contents(gpointer p)
 	crm_free(tmp2);
 	crm_free(tmp1);
 
+	free_xml(local_cib);
+	
 	if(p == NULL) {
-		/* fork-and-write mode */
-		exit(exit_rc);
+	    /* exit() could potentially affect the parent by closing things it shouldn't
+	     * Use _exit instead
+	     */
+	    _exit(exit_rc);
 	}
-
-	/* stand-alone mode */
 	return exit_rc;
 }
 
diff -r f059ec7ced7a -r b230ffa2ecdc cib/main.c
--- a/cib/main.c	Mon May 17 17:57:40 2010 +0200
+++ b/cib/main.c	Mon Jul 12 18:48:04 2010 +0200
@@ -134,7 +134,7 @@ main(int argc, char ** argv)
 #endif
 
 	struct passwd *pwentry = NULL;	
-	crm_log_init(CRM_SYSTEM_CIB, LOG_INFO, TRUE, TRUE, argc, argv);
+	crm_log_init(NULL, LOG_INFO, TRUE, TRUE, argc, argv);
 	mainloop_add_signal(SIGTERM, cib_shutdown);
 	
 	cib_writer = G_main_add_tempproc_trigger(			
@@ -367,7 +367,7 @@ gboolean ccm_connect(void)
 }
 #endif
 
-#if SUPPORT_AIS	
+#if SUPPORT_COROSYNC	
 static gboolean cib_ais_dispatch(AIS_Message *wrapper, char *data, int sender) 
 {
     xmlNode *xml = NULL;
@@ -415,7 +415,7 @@ cib_init(void)
 	    void *destroy = cib_ha_connection_destroy;
 	    
 	    if(is_openais_cluster()) {
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 		destroy = cib_ais_destroy;
 		dispatch = cib_ais_dispatch;
 #endif
diff -r f059ec7ced7a -r b230ffa2ecdc cib/notify.c
--- a/cib/notify.c	Mon May 17 17:57:40 2010 +0200
+++ b/cib/notify.c	Mon Jul 12 18:48:04 2010 +0200
@@ -310,7 +310,6 @@ do_cib_notify(
 	enum cib_errors result, xmlNode *result_data, const char *msg_type) 
 {
 	xmlNode *update_msg = NULL;
-	const char *type = NULL;
 	const char *id = NULL;
 
 	update_msg = create_xml_node(NULL, "notify");
@@ -332,13 +331,11 @@ do_cib_notify(
 		crm_debug_4("Setting type to update->name: %s",
 			    crm_element_name(update));
 		crm_xml_add(update_msg, F_CIB_OBJTYPE, crm_element_name(update));
-		type = crm_element_name(update);
 
 	} else if(result_data != NULL) {
 		crm_debug_4("Setting type to new_obj->name: %s",
 			    crm_element_name(result_data));
 		crm_xml_add(update_msg, F_CIB_OBJTYPE, crm_element_name(result_data));
-		type = crm_element_name(result_data);
 		
 	} else {
 		crm_debug_4("Not Setting type");
diff -r f059ec7ced7a -r b230ffa2ecdc configure.ac
--- a/configure.ac	Mon May 17 17:57:40 2010 +0200
+++ b/configure.ac	Mon Jul 12 18:48:04 2010 +0200
@@ -128,17 +128,12 @@ AC_SUBST(PKGNAME)
 
 AC_ARG_ENABLE([ansi],
 [  --enable-ansi force GCC to compile to ANSI/ANSI standard for older compilers.
-     [default=yes]])
+     [default=no]])
 
 AC_ARG_ENABLE([fatal-warnings],
 [  --enable-fatal-warnings very pedantic and fatal warnings for gcc
      [default=yes]])
 
-AC_ARG_ENABLE([pretty],
-[  --enable-pretty 
-     Pretty-print compiler output unless there is an error
-     [default=no]])
-
 AC_ARG_ENABLE([quiet],
 [  --enable-quiet 
      Supress make output unless there is an error
@@ -154,9 +149,16 @@ LTDL_LIBS=""
 
 AC_ARG_WITH(ais,
     [  --with-ais     
-       Support the OpenAIS messaging and membership layer ],
-    [ SUPPORT_AIS=$withval ],
-    [ SUPPORT_AIS=try ],
+       Support the Corosync messaging and membership layer ],
+    [ SUPPORT_CS=$withval ],
+    [ SUPPORT_CS=try ],
+)
+
+AC_ARG_WITH(corosync,
+    [  --with-corosync     
+       Support the Corosync messaging and membership layer ],
+    [ SUPPORT_CS=$withval ],
+    [ SUPPORT_CS=try ],
 )
 
 AC_ARG_WITH(heartbeat,
@@ -166,6 +168,20 @@ AC_ARG_WITH(heartbeat,
     [ SUPPORT_HEARTBEAT=try ],
 )
 
+AC_ARG_WITH(cman,
+    [  --with-cman     
+       Support the consumption of membership and quorum from cman ],
+    [ SUPPORT_CMAN=$withval ],
+    [ SUPPORT_CMAN=try ],
+)
+
+AC_ARG_WITH(cpg,
+    [  --with-cs-quorum     
+       Support the consumption of membership and quorum from corosync ],
+    [ SUPPORT_CS_QUORUM=$withval ],
+    [ SUPPORT_CS_QUORUM=try ],
+)
+
 AC_ARG_WITH(snmp,
     [  --with-snmp     
        Support the SNMP protocol ],
@@ -180,15 +196,15 @@ AC_ARG_WITH(esmtp,
     [ SUPPORT_ESMTP=try ],
 )
 
-AISPREFIX=""
+CSPREFIX=""
 AC_ARG_WITH(ais-prefix,
-    [  --with-ais-prefix=DIR  Prefix used when OpenAIS was installed [$prefix]],
-    [ AISPREFIX=$withval ], 
-    [ AISPREFIX=$prefix ])
+    [  --with-ais-prefix=DIR  Prefix used when Corosync was installed [$prefix]],
+    [ CSPREFIX=$withval ], 
+    [ CSPREFIX=$prefix ])
 
 LCRSODIR=""
 AC_ARG_WITH(lcrso-dir, 
-    [  --with-lcrso-dir=DIR   OpenAIS lcrso files. ],
+    [  --with-lcrso-dir=DIR   Corosync lcrso files. ],
     [ LCRSODIR="$withval" ])
 
 INITDIR=""
@@ -224,11 +240,11 @@ case $exec_prefix in
   prefix) exec_prefix=$prefix;;
 esac
 
-AC_MSG_NOTICE(Sanitizing ais_prefix: ${AISPREFIX})
-case $AISPREFIX in
+AC_MSG_NOTICE(Sanitizing ais_prefix: ${CSPREFIX})
+case $CSPREFIX in
   dnl For consistency with Heartbeat, map NONE->$prefix
-  NONE)	  AISPREFIX=$prefix;;
-  prefix) AISPREFIX=$prefix;;
+  NONE)	  CSPREFIX=$prefix;;
+  prefix) CSPREFIX=$prefix;;
 esac
 
 AC_MSG_NOTICE(Sanitizing INITDIR: ${INITDIR})
@@ -435,7 +451,7 @@ HB_DAEMON_DIR=`extract_header_define $GL
 AC_DEFINE_UNQUOTED(HB_DAEMON_DIR,"$HB_DAEMON_DIR", Location for Heartbeat expects Pacemaker daemons to be in)
 AC_SUBST(HB_DAEMON_DIR)
 
-dnl Needed so that the AIS plugin can clear out the directory as Heartbeat does
+dnl Needed so that the Corosync plugin can clear out the directory as Heartbeat does
 HA_STATE_DIR=`extract_header_define $GLUE_HEADER HA_VARRUNDIR`
 AC_DEFINE_UNQUOTED(HA_STATE_DIR,"$HA_STATE_DIR", Where Heartbeat keeps state files and sockets)
 AC_SUBST(HA_STATE_DIR)
@@ -488,7 +504,7 @@ BUILD_VERSION=unknown
 if test -f $srcdir/.hg_archival.txt; then
    BUILD_VERSION=`cat $srcdir/.hg_archival.txt | awk '/node:/ { print $2 }'`
 elif test -x $HG -a -d .hg; then
-   BUILD_VERSION=`$HG id -itb`
+   BUILD_VERSION=`$HG id -i`
    if test $? != 0; then
        BUILD_VERSION=unknown
    fi
@@ -745,6 +761,7 @@ dnl Structures
 dnl ========================================================================
 
 AC_CHECK_MEMBERS([struct tm.tm_gmtoff],,,[[#include <time.h>]])
+AC_CHECK_MEMBERS([lrm_op_t.rsc_deleted],,,[[#include <lrm/lrm_api.h>]])
 
 dnl ========================================================================
 dnl Functions
@@ -923,51 +940,48 @@ AC_DEFINE_UNQUOTED(SUPPORT_HEARTBEAT, $S
 
 
 dnl ========================================================================
-dnl    Cluster stack - OpenAIS
+dnl    Cluster stack - Corosync
 dnl ========================================================================
 
-AISLIB=""
+CSLIB=""
 
 dnl Normalize the values
-case $SUPPORT_AIS in
+case $SUPPORT_CS in
      1|yes|true) missingisfatal=1;;
      try)        missingisfatal=0;;
-     *) SUPPORT_AIS=no;;
+     *) SUPPORT_CS=no;;
 esac
 
-AC_MSG_CHECKING(for native AIS)
+AC_MSG_CHECKING(for native corosync)
 AISMSGLIB=""
-AIS_VERSION="none"
+CS_VERSION="none"
 COROSYNC_PKG="$PKGCONFIG libcoroipcc"
 
-if test $SUPPORT_AIS = no; then
+if test $SUPPORT_CS = no; then
    AC_MSG_RESULT(no... not requested.)
 
 else
-   AC_MSG_RESULT($SUPPORT_AIS, with '$AISPREFIX')
+   AC_MSG_RESULT($SUPPORT_CS, with '$CSPREFIX')
 
    AC_CHECK_HEADERS(openais/saAis.h)
    AC_CHECK_HEADERS(corosync/coroipcc.h)
 
    $COROSYNC_PKG --exists
    if test $? = 0; then
-       AIS_VERSION="corosync"
-
-   elif test "$ac_cv_header_openais_saAis_h" = "yes"; then
-       AIS_VERSION="whitetank"
+       CS_VERSION="corosync"
    else
-       aisreason="Whitetank headers not found"
+       aisreason="Corosync installation not found by pkg_config"
    fi  
 fi
 
-if test $AIS_VERSION != "none"; then
-   AC_MSG_CHECKING(for OpenAIS branch)
-   AC_MSG_RESULT($AIS_VERSION)
+if test $CS_VERSION != "none"; then
+   AC_MSG_CHECKING(for Corosync branch)
+   AC_MSG_RESULT($CS_VERSION)
 fi
 
-if test $AIS_VERSION = "corosync"; then
+if test $CS_VERSION = "corosync"; then
    if test "$ac_cv_header_corosync_coroipcc_h" != "yes"; then
-       AIS_VERSION="none"
+       CS_VERSION="none"
        aisreason="Corosync headers not found"
    fi
 
@@ -977,109 +991,101 @@ if test $AIS_VERSION = "corosync"; then
    LIBS="$saveLIBS"
 
    if test $ac_cv_lib_coroipcc_coroipcc_msg_send_reply_receive != yes; then
-        AC_MSG_RESULT(Cannot locate AIS messaging library)
+        AC_MSG_RESULT(Cannot locate corosync messaging library)
 	aisreason="requred Corosync libraries not found"
-        AIS_VERSION="none"
+        CS_VERSION="none"
    fi
 
 fi
 
-dnl continue?
-if test $AIS_VERSION = "whitetank"; then
-   dnl Find it in lib, lib64, or wherever it wants to live...
-   AC_MSG_CHECKING(location of OpenAIS libraries)
-   dnl CoroSync location
-   alib=`ls ${AISPREFIX}/*/libcpg.so | head -n 1`
-   if test -z "$alib"; then
-      dnl Whitetank location
-      alib=`ls ${AISPREFIX}/*/*/libcpg.so | head -n 1`
-   fi
-   AISLIB=`dirname $alib`
-   AC_MSG_RESULT($AISLIB)
-   if test "x$AISLIB" = "x"; then
-     AC_MSG_WARN(Use --with-ais-prefix to specify the prefix OpenAIS was installed with)
-     aisreason="library directory not found"
-     AIS_VERSION="none"
-
-   elif test ! -d "$AISLIB"; then
-     AC_MSG_WARN(Use --with-ais-prefix to specify the prefix OpenAIS was installed with)
-     aisreason="specified library directory does not exist"
-     AIS_VERSION="none"
-   fi
-fi
-
-dnl continue?
-if test $AIS_VERSION = "whitetank"; then
-   AC_MSG_CHECKING(location of OpenAIS plugins)
-   if test -z "$LCRSODIR"; then
-      LCRSODIR="$libexecdir/lcrso"
-      alib=`ls ${AISPREFIX}/*/lcrso/objdb.lcrso | head -n 1`
-      LCRSODIR=`dirname $alib`
-   fi
-   AC_MSG_RESULT($LCRSODIR)
-
-   if test "x$LCRSODIR" = "x"; then
-     AC_MSG_RESULT(Invalid.  Please specify the correct location with --with-lcrso-dir)
-     aisreason="plugin directory not found"
-     AIS_VERSION="none"
-
-   elif test ! -d "$LCRSODIR"; then
-     AC_MSG_RESULT(Invalid.  Please specify the correct location with --with-lcrso-dir)
-     aisreason="specified plugin directory does not exist"
-     AIS_VERSION="none"
-   fi
-fi
-
-dnl continue?
-if test $AIS_VERSION = "whitetank"; then
-     dnl Don't add the messaging library to LIBS since most daemons don't need/use it
-     saveLIBS="$LIBS"
-     LIBS="$LIBS -L${AISLIB} -R${AISLIB}"
-
-     AC_CHECK_LIB(SaMsg, saSendReceiveReply, [])
-     AC_CHECK_LIB(SaMsg, openais_msg_send_reply_receive, [])
-
-     if test $ac_cv_lib_SaMsg_openais_msg_send_reply_receive = yes; then
-       :  OpenAIS
-     elif test $ac_cv_lib_SaMsg_saSendReceiveReply = yes; then
-       :  OpenAIS
-	AC_DEFINE_UNQUOTED(TRADITIONAL_AIS_IPC, 1, "Use the 'old' AIS IPC interface")
-     else
-        AC_MSG_RESULT(Cannot locate AIS messaging library)
-	aisreason="requred libraries not found"
-        AIS_VERSION="none"
-     fi
-     LIBS="$saveLIBS"
-fi
-
-SUPPORT_AIS=1
-case $AIS_VERSION in
+SUPPORT_CS=1
+case $CS_VERSION in
     corosync)
-	AC_DEFINE_UNQUOTED(AIS_COROSYNC, 1, "AIS target is the corosync series")
+	AC_DEFINE_UNQUOTED(SUPPORT_COROSYNC, 1, Support the Corosync messaging and membership layer)
    	LCRSODIR=`$PKGCONFIG corosync --variable=lcrsodir`
    	CFLAGS="$CFLAGS `$COROSYNC_PKG --cflags`"
-	AISMSGLIB=`$COROSYNC_PKG --libs`
-	;;
-    whitetank) 
-	AC_DEFINE_UNQUOTED(AIS_WHITETANK, 1, "AIS target is the whitetank series")
-	CFLAGS="$CFLAGS -I$AISPREFIX/include/openais"
-	AISMSGLIB="-L${AISLIB} -R${AISLIB} -lSaMsg"
+	CSMSGLIB=`$COROSYNC_PKG --libs`
 	;;
     none)
-     	SUPPORT_AIS=0
+     	SUPPORT_CS=0
 	if test "x$aisreason" != x; then
      	  if test $missingisfatal = 0; then
-	    AC_MSG_WARN(Unable to support OpenAIS: $aisreason) 
+	    AC_MSG_WARN(Unable to support Corosync: $aisreason) 
           else
-	    AC_MSG_FAILURE(Unable to support OpenAIS: $aisreason) 
+	    AC_MSG_FAILURE(Unable to support Corosync: $aisreason) 
           fi
         fi
 	;;
-    *) AC_MSG_FAILURE(Unknown OpenAIS branch: $AIS_VERSION);;
+    *) AC_MSG_FAILURE(Unknown Corosync branch: $CS_VERSION);;
 esac
 
-AC_DEFINE_UNQUOTED(SUPPORT_AIS, $SUPPORT_AIS, Support the OpenAIS messaging and membership layer)
-AM_CONDITIONAL(BUILD_AIS_SUPPORT, test $SUPPORT_AIS = 1)
+AC_DEFINE_UNQUOTED(AIS_COROSYNC, $SUPPORT_AIS, Compatability alias for SUPPORT_COROSYNC)
+AC_DEFINE_UNQUOTED(SUPPORT_AIS, $SUPPORT_AIS, Compatability alias for SUPPORT_COROSYNC)
+AM_CONDITIONAL(BUILD_CS_SUPPORT, test $SUPPORT_CS = 1)
+
+PCMK_SERVICE_ID=9
+if test $SUPPORT_CMAN != no; then
+    AC_MSG_CHECKING(for cman)
+    $PKGCONFIG libcman --exists
+    if test $? = 0; then
+	AC_MSG_RESULT(yes)
+    else
+	AC_MSG_RESULT(no)
+    fi
+
+    AC_MSG_CHECKING(for cpg)
+    $PKGCONFIG libcpg --exists
+    if test $? = 0; then
+	AC_MSG_RESULT(yes)
+    else
+	AC_MSG_RESULT(no)
+    fi
+
+    AC_MSG_CHECKING(for fenced)
+    $PKGCONFIG libfenced --exists
+    if test $? = 0; then
+	AC_MSG_RESULT(yes)
+    else
+	AC_MSG_RESULT(no)
+    fi
+
+    $PKGCONFIG libcpg libcman libfenced --exists
+    if test $? = 0; then
+	CFLAGS="$CFLAGS `$PKGCONFIG libcpg libcman libfenced --cflags`"
+	CSMSGLIB="$CSMSGLIB `$PKGCONFIG libcpg libcman libfenced --libs`"
+	
+	PKG_FEATURES="$PKG_FEATURES cman"
+	AC_DEFINE_UNQUOTED(SUPPORT_CMAN, 1, Support the consumption of membership and quorum from cman)
+    fi
+fi
+AC_DEFINE_UNQUOTED(PCMK_SERVICE_ID, $PCMK_SERVICE_ID, Corosync service number)
+
+if test $SUPPORT_CS_QUORUM != no; then
+    AC_MSG_CHECKING(for cpg)
+    $PKGCONFIG libcpg --exists
+    if test $? = 0; then
+	AC_MSG_RESULT(yes)
+    else
+	AC_MSG_RESULT(no)
+    fi
+
+    AC_MSG_CHECKING(for quorum)
+    $PKGCONFIG libquorum --exists
+    if test $? = 0; then
+	AC_MSG_RESULT(yes)
+    else
+	AC_MSG_RESULT(no)
+    fi
+
+    $PKGCONFIG libcpg libquorum --exists
+    if test $? = 0; then
+	CFLAGS="$CFLAGS `$PKGCONFIG libcpg libquorum --cflags`"
+	CSMSGLIB="$CSMSGLIB `$PKGCONFIG libcpg libquorum --libs`"
+	
+	PKG_FEATURES="$PKG_FEATURES cs-quorum"
+	AC_DEFINE_UNQUOTED(SUPPORT_CS_QUORUM, 1, Support the consumption of membership and quorum from corosync)
+    fi
+fi
 
 dnl
 dnl    Cluster stack - Sanity
@@ -1092,11 +1098,11 @@ if test $SUPPORT_HEARTBEAT = 1; then
    CLUSTERLIBS="$CLUSTERLIBS -lhbclient -lccmclient"
 fi
 
-if test $SUPPORT_AIS = 1; then
-   STACKS="$STACKS $AIS_VERSION"
-   CLUSTERLIBS="$CLUSTERLIBS ${AISMSGLIB}"
+if test $SUPPORT_CS = 1; then
+   STACKS="$STACKS $CS_VERSION"
+   CLUSTERLIBS="$CLUSTERLIBS ${CSMSGLIB}"
 else
-   AISPREFIX=""
+   CSPREFIX=""
    LCRSODIR="$libdir"
 fi
 
@@ -1350,7 +1356,10 @@ CC_ERRORS=""
 CC_EXTRAS=""
 
 if export | fgrep " CFLAGS=" > /dev/null; then
-	export -n CFLAGS || true # We don't want to bomb out if this fails
+	SAVED_CFLAGS="$CFLAGS"
+	unset CFLAGS
+	CFLAGS="$SAVED_CFLAGS"
+	unset SAVED_CFLAGS
 fi
 
 if test "$GCC" != yes; then
@@ -1418,7 +1427,7 @@ dnl System specific options
 	   enable_fatal_warnings=no
         fi
 
-	if test "x${enable_ansi}" != xno && cc_supports_flag -std=iso9899:199409 ; then
+	if test "x${enable_ansi}" = xyes && cc_supports_flag -std=iso9899:199409 ; then
 	  AC_MSG_NOTICE(Enabling ANSI Compatibility)
 	  CC_EXTRAS="$CC_EXTRAS -ansi -D_GNU_SOURCE -DANSI_ONLY"
 	fi
@@ -1473,6 +1482,7 @@ AC_SUBST(LIBTOOL)
 AC_SUBST(QUIET_MAKE_OPTS)
 AC_SUBST(QUIET_LIBTOOL_OPTS)
 AC_DEFINE_UNQUOTED(CRM_FEATURES, "$PKG_FEATURES", Set of enabled features)
+AC_SUBST(PKG_FEATURES)
 
 dnl The Makefiles and shell scripts we output
 AC_CONFIG_FILES(Makefile				        \
@@ -1486,8 +1496,6 @@ crmd/Makefile							\
 pengine/Makefile						\
 	pengine/regression.core.sh				\
 doc/Makefile							\
-	doc/cibadmin.8						\
-	doc/crm_resource.8					\
 	doc/Pacemaker_Explained/publican.cfg			\
 	doc/Clusters_from_Scratch/publican.cfg			\
 include/Makefile						\
@@ -1504,6 +1512,8 @@ lib/Makefile							\
 	lib/fencing/Makefile					\
 	lib/plugins/Makefile					\
 		lib/plugins/lrm/Makefile			\
+mcp/Makefile							\
+	mcp/pacemaker						\
 fencing/Makefile                                                \
 extra/Makefile							\
 	extra/resources/Makefile				\
@@ -1544,7 +1554,7 @@ AC_MSG_RESULT([  Header files           
 AC_MSG_RESULT([  Arch-independent files   = ${datadir}])
 AC_MSG_RESULT([  State information        = ${localstatedir}])
 AC_MSG_RESULT([  System configuration     = ${sysconfdir}])
-AC_MSG_RESULT([  AIS Plugins              = ${LCRSODIR}])
+AC_MSG_RESULT([  Corosync Plugins         = ${LCRSODIR}])
 AC_MSG_RESULT([])
 AC_MSG_RESULT([  Use system LTDL          = ${ac_cv_lib_ltdl_lt_dlopen}])
 AC_MSG_RESULT([])
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/Makefile.am
--- a/crmd/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -35,7 +35,7 @@ atest_SOURCES	= atest.c
 atest_LDADD	= $(top_builddir)/lib/common/libcrmcommon.la
 
 
-crmd_SOURCES	= main.c crmd.c 					\
+crmd_SOURCES	= main.c crmd.c corosync.c					\
 		fsa.c control.c messages.c ccm.c callbacks.c		\
 		election.c join_client.c join_dc.c subsystems.c 	\
 		cib.c pengine.c tengine.c lrm.c 			\
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/atest.c
--- a/crmd/atest.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/atest.c	Mon Jul 12 18:48:04 2010 +0200
@@ -42,7 +42,7 @@ main(int argc, char ** argv)
     const char *xml_file = NULL;
     const char *xpath = NULL;
     
-    crm_log_init("atest", LOG_DEBUG, FALSE, TRUE, argc, argv);
+    crm_log_init(NULL, LOG_DEBUG, FALSE, TRUE, argc, argv);
     while (1) {
 	flag = getopt(argc, argv, OPTARGS);
 	if (flag == -1)
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/callbacks.c
--- a/crmd/callbacks.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/callbacks.c	Mon Jul 12 18:48:04 2010 +0200
@@ -268,10 +268,57 @@ lrm_op_callback(lrm_op_t* op)
 	process_lrm_event(op);
 }
 
+static void crmd_peer_update(crm_node_t *member, enum crm_proc_flag client) 
+{
+    const char *status = NULL;
+
+    CRM_CHECK(member != NULL, return);
+    status = (member->processes&client)?ONLINESTATUS:OFFLINESTATUS;
+    crm_notice("Status update: Client %s/%s now has status [%s] (DC=%s)",
+	       member->uname, peer2text(client), status,
+	       AM_I_DC?"true":crm_str(fsa_our_dc));
+
+    if((client & crm_proc_crmd) == 0) {
+	return;
+    } else if(is_set(fsa_input_register, R_CIB_CONNECTED) == FALSE) {
+	return;
+    } else if(fsa_state == S_STOPPING) {
+	return;
+    }
+	
+    if(safe_str_eq(member->uname, fsa_our_dc) && crm_is_full_member(member) == FALSE){
+	/* Did the DC leave us? */
+	crm_info("Got client status callback - our DC is dead");
+	register_fsa_input(C_CRMD_STATUS_CALLBACK, I_ELECTION, NULL);
+		
+    } else if(AM_I_DC) {
+	xmlNode *update = NULL;
+	update = create_node_state(
+	    member->uname, NULL, NULL, status, NULL, NULL, FALSE, __FUNCTION__);
+	    
+	fsa_cib_anon_update(
+	    XML_CIB_TAG_STATUS, update, cib_scope_local|cib_quorum_override|cib_can_create);
+	free_xml(update);
+	    
+	if((member->processes & client) == 0) {
+	    erase_node_from_join(member->uname);
+	    check_join_state(fsa_state, __FUNCTION__);
+
+	} else {
+	    register_fsa_input_before(C_FSA_INTERNAL, I_NODE_JOIN, NULL);	    
+	}
+    }
+	
+    trigger_fsa(fsa_source);
+}
+
 void ais_status_callback(enum crm_status_type type, crm_node_t *node, const void *data) 
 {
     gboolean reset_status_entry = FALSE;
-    if(AM_I_DC == FALSE || node->uname == NULL) {
+    uint32_t old = 0 ;
+
+    set_bit_inplace(fsa_input_register, R_PEER_DATA);
+    if(node->uname == NULL) {
 	return;
     }
     
@@ -286,11 +333,18 @@ void ais_status_callback(enum crm_status
 	    reset_status_entry = TRUE;
 	    break;
 	case crm_status_processes:
+	    if (data) {
+		old = *(const uint32_t *)data;
+	    }
+
+	    if( (node->processes ^ old) & crm_proc_crmd ) {
+		crmd_peer_update(node, crm_proc_crmd);
+	    }
 	    break;
     }
 
     /* Can this be removed now that do_cl_join_finalize_respond() does the same thing? */
-    if(reset_status_entry && safe_str_eq(CRMD_STATE_ACTIVE, node->state)) {
+    if(AM_I_DC && reset_status_entry && safe_str_eq(CRMD_STATE_ACTIVE, node->state)) {
 	erase_status_tag(node->uname, XML_CIB_TAG_LRM, cib_scope_local);
 	erase_status_tag(node->uname, XML_TAG_TRANSIENT_NODEATTRS, cib_scope_local);
 	/* TODO: potentially we also want to set XML_CIB_ATTR_JOINSTATE and XML_CIB_ATTR_EXPSTATE here */
@@ -302,8 +356,7 @@ crmd_ha_status_callback(const char *node
 {
 	xmlNode *update = NULL;
 	crm_node_t *member = NULL;
-	crm_notice("Status update: Node %s now has status [%s] (DC=%s)",
-		   node, status, AM_I_DC?"true":"false");
+	crm_notice("Status update: Node %s now has status [%s]", node, status);
 
 	member = crm_get_peer(0, node);
 	if(member == NULL || crm_is_member_active(member) == FALSE) {
@@ -349,7 +402,6 @@ crmd_client_status_callback(const char *
 {
 	const char *join = NULL;
 	crm_node_t *member = NULL;
-	xmlNode *update = NULL;
 	gboolean clear_shutdown = FALSE;
 	
 	crm_debug_3("Invoked");
@@ -386,23 +438,8 @@ crmd_client_status_callback(const char *
 	    member = crm_update_peer(0, 0, 0, -1, 0, uuid, node, NULL, NULL);
 	}
 
-	crm_update_peer_proc(node, crm_proc_crmd, status);
-	
-	if(is_set(fsa_input_register, R_CIB_CONNECTED) == FALSE) {
-		return;
-	} else if(fsa_state == S_STOPPING) {
-		return;
-	}
-	
-	if(safe_str_eq(node, fsa_our_dc) && safe_str_eq(status, OFFLINESTATUS)){
-		/* did our DC leave us */
-		crm_info("Got client status callback - our DC is dead");
-		register_fsa_input(C_CRMD_STATUS_CALLBACK, I_ELECTION, NULL);
-		
-	} else if(AM_I_DC == FALSE) {
-		crm_info("Not the DC");
-
-	} else {
+	if(AM_I_DC) {
+	    xmlNode *update = NULL;
 	    crm_debug_3("Got client status callback");
 	    update = create_node_state(
 		node, NULL, NULL, status, join, NULL, clear_shutdown, __FUNCTION__);
@@ -410,14 +447,8 @@ crmd_client_status_callback(const char *
 	    fsa_cib_anon_update(
 		XML_CIB_TAG_STATUS, update, cib_scope_local|cib_quorum_override|cib_can_create);
 	    free_xml(update);
-	    
-	    if(safe_str_eq(status, OFFLINESTATUS)) {
-		erase_node_from_join(node);
-		check_join_state(fsa_state, __FUNCTION__);
-	    }
-	}
-	
-	trigger_fsa(fsa_source);
+	}	
+	crm_update_peer_proc(node, crm_proc_crmd, status);
 }
 
 void
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/control.c
--- a/crmd/control.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/control.c	Mon Jul 12 18:48:04 2010 +0200
@@ -41,7 +41,7 @@
 
 char *ipc_server = NULL;
 
-extern void post_cache_update(int seq);
+extern gboolean crm_connect_corosync(void);
 extern void crmd_ha_connection_destroy(gpointer user_data);
 
 void crm_shutdown(int nsig);
@@ -53,81 +53,6 @@ crm_trigger_t  *fsa_source = NULL;
 crm_trigger_t  *config_read = NULL;
 
 /*	 A_HA_CONNECT	*/
-#if SUPPORT_AIS	
-extern void crmd_ha_msg_filter(xmlNode * msg);
-
-static gboolean crm_ais_dispatch(AIS_Message *wrapper, char *data, int sender) 
-{
-    int seq = 0;
-    xmlNode *xml = NULL;
-    const char *seq_s = NULL;
-
-    xml = string2xml(data);
-    if(xml == NULL) {
-	crm_err("Could not parse message content (%d): %.100s", wrapper->header.id, data);
-	return TRUE;
-    }
-    
-    switch(wrapper->header.id) {
-	case crm_class_members:
-	    seq_s = crm_element_value(xml, "id");
-	    seq = crm_int_helper(seq_s, NULL);
-	    set_bit_inplace(fsa_input_register, R_PEER_DATA);
-	    post_cache_update(seq);
-
-	    /* fall through */
-	case crm_class_quorum:
-	    crm_update_quorum(crm_have_quorum, FALSE);
-	    if(AM_I_DC) {
-		const char *votes = crm_element_value(xml, "expected");
-		if(votes == NULL || check_number(votes) == FALSE) {
-		    crm_log_xml_err(xml, "Invalid quorum/membership update");
-
-		} else {
-		    int rc = update_attr(
-			fsa_cib_conn, cib_quorum_override|cib_scope_local|cib_inhibit_notify,
-			XML_CIB_TAG_CRMCONFIG, NULL, NULL, NULL, NULL, XML_ATTR_EXPECTED_VOTES, votes, FALSE);
-
-		    crm_info("Setting expected votes to %s", votes);
-		    if(cib_ok > rc) {
-			crm_err("Quorum update failed: %s", cib_error2string(rc));
-		    }
-		}
-	    }
-	    break;
-	    
-	case crm_class_cluster:
-	    crm_xml_add(xml, F_ORIG, wrapper->sender.uname);
-	    crm_xml_add_int(xml, F_SEQ, wrapper->id);
-	    crmd_ha_msg_filter(xml);
-	    break;
-
-	case crm_class_rmpeer:
-	    /* Ignore */
-	    break;
-
-	case crm_class_notify:
-	case crm_class_nodeid:
-	    crm_err("Unexpected message class (%d): %.100s", wrapper->header.id, data);
-	    break;
-
-	default:
-	    crm_err("Invalid message class (%d): %.100s", wrapper->header.id, data);
-    }
-    
-    free_xml(xml);    
-    return TRUE;
-}
-
-static void
-crm_ais_destroy(gpointer user_data)
-{
-    crm_err("AIS connection terminated");
-    ais_fd_sync = -1;
-    exit(1);
-}
-#endif
-
 void
 do_ha_control(long long action,
 	       enum crmd_fsa_cause cause,
@@ -151,31 +76,20 @@ do_ha_control(long long action,
 	}
 	
 	if(action & A_HA_CONNECT) {
-	    void *dispatch = NULL;
-	    void *destroy = NULL;
-	    
+	    crm_set_status_callback(&ais_status_callback);
+
 	    if(is_openais_cluster()) {
-#if SUPPORT_AIS
-		destroy = crm_ais_destroy;
-		dispatch = crm_ais_dispatch;
-		
+#if SUPPORT_COROSYNC
+		registered = crm_connect_corosync();
 #endif
 	    } else if(is_heartbeat_cluster()) {
 #if SUPPORT_HEARTBEAT
-		dispatch = crmd_ha_msg_callback;
-		destroy = crmd_ha_connection_destroy;
+		registered = crm_cluster_connect(
+		    &fsa_our_uname, &fsa_our_uuid, crmd_ha_msg_callback, crmd_ha_connection_destroy,
+		    &fsa_cluster_conn);
 #endif
 	    }
 	    
-	    crm_set_status_callback(&ais_status_callback);
-	    registered = crm_cluster_connect(
-		&fsa_our_uname, &fsa_our_uuid, dispatch, destroy,
-#if SUPPORT_HEARTBEAT
-		&fsa_cluster_conn
-#else
-		NULL
-#endif
-		);
 	    
 #if SUPPORT_HEARTBEAT
 	    if(is_heartbeat_cluster()) {	
@@ -641,29 +555,25 @@ do_started(long long action,
 	    return;
 	    
 	} else if(is_set(fsa_input_register, R_CCM_DATA) == FALSE) {
-		crm_info("Delaying start, CCM (%.16llx) not connected",
-			 R_CCM_DATA);
+		crm_info("Delaying start, no membership data (%.16llx)", R_CCM_DATA);
 
 		crmd_fsa_stall(NULL);
 		return;
 
 	} else if(is_set(fsa_input_register, R_LRM_CONNECTED) == FALSE) {
-		crm_info("Delaying start, LRM (%.16llx) not connected",
-			 R_LRM_CONNECTED);
+		crm_info("Delaying start, LRM not connected (%.16llx)", R_LRM_CONNECTED);
 
 		crmd_fsa_stall(NULL);
 		return;
 
 	} else if(is_set(fsa_input_register, R_CIB_CONNECTED) == FALSE) {
-		crm_info("Delaying start, CIB (%.16llx) not connected",
-			 R_CIB_CONNECTED);
+		crm_info("Delaying start, CIB not connected (%.16llx)", R_CIB_CONNECTED);
 
 		crmd_fsa_stall(NULL);
 		return;
 
 	} else if(is_set(fsa_input_register, R_READ_CONFIG) == FALSE) {
-		crm_info("Delaying start, Config not read (%.16llx)",
-			 R_READ_CONFIG);
+		crm_info("Delaying start, Config not read (%.16llx)", R_READ_CONFIG);
 
 		crmd_fsa_stall(NULL);
 		return;
@@ -672,8 +582,7 @@ do_started(long long action,
 		HA_Message *msg = NULL;
 
 		/* try reading from HA */
-		crm_info("Delaying start, Peer data (%.16llx) not received",
-			 R_PEER_DATA);
+		crm_info("Delaying start, No peer data (%.16llx)", R_PEER_DATA);
 
 		crm_debug_3("Looking for a HA message");
 #if SUPPORT_HEARTBEAT
@@ -819,8 +728,8 @@ config_query_callback(xmlNode *msg, int 
 	value = crmd_pref(config_hash, "crmd-finalization-timeout");
 	finalization_timer->period_ms = crm_get_msec(value);
 
-#if SUPPORT_AIS
-	if(is_openais_cluster()) {
+#if SUPPORT_COROSYNC
+	if(is_classic_ais_cluster()) {
 	    value = crmd_pref(config_hash, XML_ATTR_EXPECTED_VOTES);
 	    crm_info("Sending expected-votes=%s to corosync", value);
 	    send_ais_text(crm_class_quorum, value, TRUE, NULL, crm_msg_ais);	
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/corosync.c
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/crmd/corosync.c	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,174 @@
+/* 
+ * Copyright (C) 2004 Andrew Beekhof <andrew@beekhof.net>
+ * 
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ * 
+ * This software is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+#include <crm_internal.h>
+
+#include <sys/param.h>
+
+#include <crm/crm.h>
+#include <crm/common/cluster.h>
+#include <crm/common/xml.h>
+
+#include <crmd.h>
+#include <crmd_fsa.h>
+#include <fsa_proto.h>
+#include <crmd_messages.h>
+#include <crmd_callbacks.h>
+#include <crmd_lrm.h>
+#include <tengine.h>
+
+#include <sys/types.h>
+#include <sys/stat.h>
+
+
+extern void post_cache_update(int seq);
+extern void crmd_ha_connection_destroy(gpointer user_data);
+
+/*	 A_HA_CONNECT	*/
+#if SUPPORT_COROSYNC	
+extern void crmd_ha_msg_filter(xmlNode * msg);
+
+static gboolean crmd_ais_dispatch(AIS_Message *wrapper, char *data, int sender) 
+{
+    int seq = 0;
+    xmlNode *xml = NULL;
+    const char *seq_s = NULL;
+
+    xml = string2xml(data);
+    if(xml == NULL) {
+	crm_err("Could not parse message content (%d): %.100s", wrapper->header.id, data);
+	return TRUE;
+    }
+    
+    switch(wrapper->header.id) {
+	case crm_class_members:
+	    seq_s = crm_element_value(xml, "id");
+	    seq = crm_int_helper(seq_s, NULL);
+	    set_bit_inplace(fsa_input_register, R_PEER_DATA);
+	    post_cache_update(seq);
+
+	    /* fall through */
+	case crm_class_quorum:
+	    crm_update_quorum(crm_have_quorum, FALSE);
+	    if(AM_I_DC) {
+		const char *votes = crm_element_value(xml, "expected");
+		if(votes == NULL || check_number(votes) == FALSE) {
+		    crm_log_xml_err(xml, "Invalid quorum/membership update");
+
+		} else {
+		    int rc = update_attr(
+			fsa_cib_conn, cib_quorum_override|cib_scope_local|cib_inhibit_notify,
+			XML_CIB_TAG_CRMCONFIG, NULL, NULL, NULL, NULL, XML_ATTR_EXPECTED_VOTES, votes, FALSE);
+
+		    crm_info("Setting expected votes to %s", votes);
+		    if(cib_ok > rc) {
+			crm_err("Quorum update failed: %s", cib_error2string(rc));
+		    }
+		}
+	    }
+	    break;
+	    
+	case crm_class_cluster:
+	    crm_xml_add(xml, F_ORIG, wrapper->sender.uname);
+	    crm_xml_add_int(xml, F_SEQ, wrapper->id);
+	    crmd_ha_msg_filter(xml);
+	    break;
+
+	case crm_class_rmpeer:
+	    /* Ignore */
+	    break;
+
+	case crm_class_notify:
+	case crm_class_nodeid:
+	    crm_err("Unexpected message class (%d): %.100s", wrapper->header.id, data);
+	    break;
+
+	default:
+	    crm_err("Invalid message class (%d): %.100s", wrapper->header.id, data);
+    }
+    
+    free_xml(xml);    
+    return TRUE;
+}
+
+static gboolean crmd_cman_dispatch(unsigned long long seq, gboolean quorate) 
+{
+    crm_update_quorum(quorate, FALSE);
+    post_cache_update(seq);
+    return TRUE;
+}
+
+static void
+crmd_cman_destroy(gpointer user_data)
+{
+    if(is_set(fsa_input_register, R_HA_DISCONNECTED)) {
+	crm_err("connection terminated");
+	exit(1);
+
+    } else {
+	crm_info("connection closed");	
+    }
+}
+
+static void
+crmd_quorum_destroy(gpointer user_data)
+{
+    if(is_set(fsa_input_register, R_HA_DISCONNECTED)) {
+	crm_err("connection terminated");
+	exit(1);
+
+    } else {
+	crm_info("connection closed");	
+    }
+}
+
+static void
+crmd_ais_destroy(gpointer user_data)
+{
+    if(is_set(fsa_input_register, R_HA_DISCONNECTED)) {
+	crm_err("connection terminated");
+	exit(1);
+
+    } else {
+	crm_info("connection closed");	
+    }
+}
+
+extern gboolean crm_connect_corosync(void);
+
+gboolean crm_connect_corosync(void)
+{
+    gboolean rc = FALSE;
+    if(is_openais_cluster()) {
+	crm_set_status_callback(&ais_status_callback);
+	rc = crm_cluster_connect(
+	    &fsa_our_uname, &fsa_our_uuid, crmd_ais_dispatch, crmd_ais_destroy, NULL);
+    }
+    
+    if(rc && is_corosync_cluster()) {
+	init_quorum_connection(crmd_cman_dispatch, crmd_quorum_destroy);
+    }
+    
+    if(rc && is_cman_cluster()) {
+	init_cman_connection(crmd_cman_dispatch, crmd_cman_destroy);
+	set_bit_inplace(fsa_input_register, R_CCM_DATA);
+    }
+    return rc;
+}
+
+#endif
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/crmd_lrm.h
--- a/crmd/crmd_lrm.h	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/crmd_lrm.h	Mon Jul 12 18:48:04 2010 +0200
@@ -16,6 +16,5 @@
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
-extern void free_lrm_op(lrm_op_t *op);
 extern gboolean verify_stopped(enum crmd_fsa_state cur_state, int log_level);
 extern void lrm_connection_destroy(gpointer user_data);
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/crmd_messages.h
--- a/crmd/crmd_messages.h	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/crmd_messages.h	Mon Jul 12 18:48:04 2010 +0200
@@ -110,4 +110,6 @@ extern void lrm_op_callback(lrm_op_t* op
 
 extern void msg_queue_helper(void);
 
+extern ha_msg_input_t *copy_ha_msg_input(ha_msg_input_t *orig);
+
 #endif
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/election.c
--- a/crmd/election.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/election.c	Mon Jul 12 18:48:04 2010 +0200
@@ -17,6 +17,9 @@
  */
 #include <crm_internal.h>
 
+#include <sys/time.h>
+#include <sys/resource.h>
+
 #include <crm/cib.h>
 #include <crm/msg_xml.h>
 #include <crm/common/xml.h>
@@ -30,6 +33,51 @@ GHashTable *voted = NULL;
 uint highest_born_on = -1;
 static int current_election_id = 1;
 
+static int
+crm_uptime(struct timeval *output)
+{
+    struct rusage info;
+    int rc = getrusage(RUSAGE_SELF, &info);
+    output->tv_sec = 0;
+    output->tv_usec = 0;
+    
+    if(rc < 0) {
+	crm_perror(LOG_ERR, "Could not calculate the current uptime");
+	return -1;
+    }
+    output->tv_sec = info.ru_utime.tv_sec;
+    output->tv_usec = info.ru_utime.tv_usec;
+    crm_debug("Current CPU usage is: %lds, %ldus", (long)info.ru_utime.tv_sec, (long)info.ru_utime.tv_usec);
+    return 1;
+}
+
+static int crm_compare_age(struct timeval your_age)
+{
+    int fuzz = 10000;
+    struct timeval our_age;
+    if(crm_uptime(&our_age) < 0) {
+	return -1;
+    }
+
+    /* We want these times to be "significantly" different */
+
+    if(our_age.tv_sec > your_age.tv_sec) {
+	crm_debug("Win: %ld vs %ld (seconds)", (long)our_age.tv_sec, (long)your_age.tv_sec);
+	return 1;
+    } else if(our_age.tv_sec < your_age.tv_sec) {
+	crm_debug("Loose: %ld vs %ld (seconds)", (long)our_age.tv_sec, (long)your_age.tv_sec);
+	return -1;
+    } else if(our_age.tv_usec > (your_age.tv_usec + fuzz)) {
+	crm_debug("Win: %ld vs %ld  (nano seconds)", (long)our_age.tv_usec, (long)your_age.tv_usec);
+	return 1;
+    } else if(our_age.tv_usec < (your_age.tv_usec - fuzz)) {
+	crm_debug("Loose: %ld vs %ld(nano seconds)", (long)our_age.tv_usec, (long)your_age.tv_usec);
+	return -1;
+    }
+
+    return 0;
+}
+
 /*	A_ELECTION_VOTE	*/
 void
 do_election_vote(long long action,
@@ -38,8 +86,9 @@ do_election_vote(long long action,
 		 enum crmd_fsa_input current_input,
 		 fsa_data_t *msg_data)
 {
+	struct timeval age;
+	xmlNode *vote = NULL;
 	gboolean not_voting = FALSE;
-	xmlNode *vote = NULL;
 	
 	/* don't vote if we're in one of these states or wanting to shut down */
 	switch(cur_state) {
@@ -79,6 +128,11 @@ do_election_vote(long long action,
 	crm_xml_add(vote, F_CRM_ELECTION_OWNER, fsa_our_uuid);
 	crm_xml_add_int(vote, F_CRM_ELECTION_ID, current_election_id);
 
+	crm_uptime(&age);
+	crm_xml_add_int(vote, F_CRM_ELECTION_AGE_S, age.tv_sec);
+	crm_xml_add_int(vote, F_CRM_ELECTION_AGE_US, age.tv_usec);
+		
+
 	send_cluster_message(NULL, crm_msg_crmd, vote, TRUE);
 	free_xml(vote);
 
@@ -187,8 +241,10 @@ do_election_count_vote(long long action,
 		       enum crmd_fsa_input current_input,
 		       fsa_data_t *msg_data)
 {
+	struct timeval your_age;
 	int election_id = -1;
 	int log_level = LOG_INFO;
+	gboolean use_born_on = FALSE;
 	gboolean done = FALSE;
 	gboolean we_loose = FALSE;
 	const char *op             = NULL;	
@@ -216,7 +272,9 @@ do_election_count_vote(long long action,
 	your_version   = crm_element_value(vote->msg, F_CRM_VERSION);
 	election_owner = crm_element_value(vote->msg, F_CRM_ELECTION_OWNER);
 	crm_element_value_int(vote->msg, F_CRM_ELECTION_ID, &election_id);
-
+	crm_element_value_int(vote->msg, F_CRM_ELECTION_AGE_S, (int*)&(your_age.tv_sec));
+	crm_element_value_int(vote->msg, F_CRM_ELECTION_AGE_US, (int*)&(your_age.tv_usec));
+	
 	CRM_CHECK(vote_from != NULL, vote_from = fsa_our_uname);
 	
 	your_node = crm_get_peer(0, vote_from);
@@ -228,6 +286,12 @@ do_election_count_vote(long long action,
 			g_str_hash, g_str_equal,
 			g_hash_destroy_str, g_hash_destroy_str);
  	}
+
+	if(is_heartbeat_cluster()) {
+	    use_born_on = TRUE;
+	} else if(is_classic_ais_cluster()) {
+	    use_born_on = TRUE;
+	}	
 	
 	if(cur_state == S_STARTING) {
 	    reason = "Still starting";
@@ -275,13 +339,20 @@ do_election_count_vote(long long action,
 		
 	} else if(compare_version(your_version, CRM_FEATURE_SET) > 0) {
 	    reason = "Version";
-	    
-	} else if(your_node->born < our_node->born) {
-	    reason = "Age";
+
+	} else if(crm_compare_age(your_age) < 0) {
+	    reason = "Uptime";
 	    we_loose = TRUE;
 	    
-	} else if(your_node->born > our_node->born) {
-	    reason = "Age";
+	} else if(crm_compare_age(your_age) > 0) {
+	    reason = "Uptime";
+	    
+	} else if(use_born_on && your_node->born < our_node->born) {
+	    reason = "Born";
+	    we_loose = TRUE;
+	    
+	} else if(use_born_on && your_node->born > our_node->born) {
+	    reason = "Born";
 
 	} else if(fsa_our_uname == NULL) {
 	    reason = "Unknown host name";
@@ -328,7 +399,7 @@ do_election_count_vote(long long action,
 
 		crm_xml_add(novote, F_CRM_ELECTION_OWNER, election_owner);
 		crm_xml_add_int(novote, F_CRM_ELECTION_ID, election_id);
-		
+
 		send_cluster_message(vote_from, crm_msg_crmd, novote, TRUE);
 		free_xml(novote);
 
@@ -420,8 +491,8 @@ do_dc_takeover(long long action,
 	crm_info("Taking over DC status for this partition");
 	set_bit_inplace(fsa_input_register, R_THE_DC);
 
-#if SUPPORT_AIS
-	if(is_openais_cluster()) {
+#if SUPPORT_COROSYNC
+	if(is_classic_ais_cluster()) {
 	    send_ais_text(crm_class_quorum, NULL, TRUE, NULL, crm_msg_ais);
 	}
 #endif
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/fsa.c
--- a/crmd/fsa.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/fsa.c	Mon Jul 12 18:48:04 2010 +0200
@@ -633,7 +633,8 @@ do_state_transition(long long actions,
 					 crm_active_members());
 				
 			} else if(g_hash_table_size(confirmed_nodes) > crm_active_members()) {
-				crm_err("We have more confirmed nodes than our membership does");
+			    crm_err("We have more confirmed nodes than our membership does: %d vs. %d",
+				    g_hash_table_size(confirmed_nodes), crm_active_members());
 				register_fsa_input(C_FSA_INTERNAL, I_ELECTION, NULL);
 				
 			} else if(saved_ccm_membership_id != crm_peer_seq) {
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/fsa_matrix.h
--- a/crmd/fsa_matrix.h	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/fsa_matrix.h	Mon Jul 12 18:48:04 2010 +0200
@@ -1013,7 +1013,7 @@ const long long crmd_fsa_actions [MAXINP
 	{
 		/* S_IDLE		==> */	A_ERROR|O_RELEASE|O_EXIT,
 		/* S_ELECTION		==> */	O_RELEASE|O_EXIT,
-		/* S_INTEGRATION	==> */	A_ERROR|O_RELEASE|O_EXIT,
+		/* S_INTEGRATION	==> */	A_WARN|O_RELEASE|O_EXIT,
 		/* S_FINALIZE_JOIN	==> */	A_ERROR|O_RELEASE|O_EXIT,
 		/* S_NOT_DC		==> */	O_EXIT,
 		/* S_POLICY_ENGINE	==> */	A_WARN|O_RELEASE|O_EXIT,
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/lrm.c
--- a/crmd/lrm.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/lrm.c	Mon Jul 12 18:48:04 2010 +0200
@@ -47,6 +47,18 @@ struct recurring_op_s
 		gboolean cancelled;
 };
 
+struct pending_deletion_op_s 
+{
+	char           *rsc;
+	ha_msg_input_t *input;
+};
+
+struct delete_event_s 
+{
+	int   rc;
+	const char *rsc;
+};
+
 char *make_stop_id(const char *rsc, int call_id);
 void cib_rsc_callback(xmlNode *msg, int call_id, int rc, xmlNode *output, void *user_data);
 
@@ -69,9 +81,11 @@ void send_direct_ack(const char *to_host
 		     lrm_rsc_t *rsc, lrm_op_t* op, const char *rsc_id);
 
 void free_recurring_op(gpointer value);
+void free_deletion_op(gpointer value);
 
 GHashTable *resources = NULL;
 GHashTable *pending_ops = NULL;
+GHashTable *deletion_ops = NULL;
 GCHSource *lrm_source = NULL;
 
 int num_lrm_register_fails = 0;
@@ -122,6 +136,10 @@ do_lrm_control(long long action,
 	if(action & A_LRM_CONNECT) {
 		int ret = HA_OK;
 		
+		deletion_ops = g_hash_table_new_full(
+			g_str_hash, g_str_equal,
+			g_hash_destroy_str, free_deletion_op);
+
 		pending_ops = g_hash_table_new_full(
 			g_str_hash, g_str_equal,
 			g_hash_destroy_str, free_recurring_op);
@@ -687,6 +705,69 @@ do_lrm_query(gboolean is_replace)
 }
 
 
+static void notify_deleted(ha_msg_input_t *input, const char *rsc_id, int rc) 
+{
+    lrm_op_t* op = NULL;
+    const char *from_sys  = crm_element_value(input->msg, F_CRM_SYS_FROM);
+    const char *from_host = crm_element_value(input->msg, F_CRM_HOST_FROM);
+
+    crm_info("Notifying %s on %s that %s was%s deleted",
+	     from_sys, from_host, rsc_id, rc==HA_OK?"":" not");
+
+    op = construct_op(input->xml, rsc_id, CRMD_ACTION_DELETE);
+    CRM_ASSERT(op != NULL);
+
+    if(rc == HA_OK) {
+	op->op_status = LRM_OP_DONE;
+	op->rc = EXECRA_OK;
+    } else {
+	op->op_status = LRM_OP_ERROR;
+	op->rc = EXECRA_UNKNOWN_ERROR;
+    }
+    
+    send_direct_ack(from_host, from_sys, NULL, op, rsc_id);
+    free_lrm_op(op);
+    
+    if(safe_str_neq(from_sys, CRM_SYSTEM_TENGINE)) {
+	/* this isn't expected - trigger a new transition */
+	time_t now = time(NULL);
+	char *now_s = crm_itoa(now);
+	
+	crm_debug("Triggering a refresh after %s deleted %s from the LRM",
+		  from_sys, rsc_id);
+	
+	update_attr(fsa_cib_conn, cib_none, XML_CIB_TAG_CRMCONFIG,
+		    NULL, NULL, NULL, NULL, "last-lrm-refresh", now_s, FALSE);
+	crm_free(now_s);
+    }
+}
+
+static gboolean lrm_remove_deleted_rsc(
+    gpointer key, gpointer value, gpointer user_data)
+{
+    struct delete_event_s *event = user_data;
+    struct pending_deletion_op_s *op = value;
+
+    if(safe_str_eq(event->rsc, op->rsc)) {
+	notify_deleted(op->input, event->rsc, event->rc);
+	return TRUE;
+    }
+    return FALSE;
+}
+
+static gboolean lrm_remove_deleted_op(
+    gpointer key, gpointer value, gpointer user_data)
+{
+    const char *rsc = user_data;
+    struct recurring_op_s *pending = value;
+    if(safe_str_eq(rsc, pending->rsc_id)) {
+	crm_info("Removing op %s:%d for deleted resource %s",
+		 pending->op_key, pending->call_id, rsc);
+	return TRUE;
+    }
+    return FALSE;
+}
+
 /*
  * Remove the rsc from the CIB
  *
@@ -694,23 +775,37 @@ do_lrm_query(gboolean is_replace)
  */
 #define rsc_template "//"XML_CIB_TAG_STATE"[@uname='%s']//"XML_LRM_TAG_RESOURCE"[@id='%s']"
 static void
-delete_rsc_entry(const char *rsc_id) 
+delete_rsc_entry(ha_msg_input_t *input, const char *rsc_id, int rc) 
 {
-	int max = 0;
+    struct delete_event_s event;
+    
+    CRM_CHECK(rsc_id != NULL, return);
+    
+    if(rc == HA_OK) {
 	char *rsc_xpath = NULL;
-
-	CRM_CHECK(rsc_id != NULL, return);
-	
-	max = strlen(rsc_template) + strlen(rsc_id) + strlen(fsa_our_uname) + 1;
+	char *rsc_id_copy = crm_strdup(rsc_id);
+	int max = strlen(rsc_template) + strlen(rsc_id) + strlen(fsa_our_uname) + 1;
 	crm_malloc0(rsc_xpath, max);
 	snprintf(rsc_xpath, max, rsc_template, fsa_our_uname, rsc_id);
 	CRM_CHECK(rsc_id != NULL, return);
-
+	
 	crm_debug("sync: Sending delete op for %s", rsc_id);
 	fsa_cib_conn->cmds->delete(
 	    fsa_cib_conn, rsc_xpath, NULL, cib_quorum_override|cib_xpath);
 
+	g_hash_table_foreach_remove(pending_ops, lrm_remove_deleted_op, rsc_id_copy);
+    
+	crm_free(rsc_id_copy);
 	crm_free(rsc_xpath);
+    }    
+
+    if(input) {
+	notify_deleted(input, rsc_id, rc);
+    }
+
+    event.rc = rc;
+    event.rsc = rsc_id;
+    g_hash_table_foreach_remove(deletion_ops, lrm_remove_deleted_rsc, &event);    
 }
 
 /*
@@ -799,7 +894,13 @@ cancel_op(lrm_rsc_t *rsc, const char *ke
 	crm_debug("Cancelling op %d for %s (%s)", op, rsc->id, key);
 
 	rc = rsc->ops->cancel_op(rsc, op);
-	if(rc != HA_OK) {
+	if(rc == HA_OK) {
+	    crm_debug("Op %d for %s (%s): cancelled", op, rsc->id, key);
+#ifdef HAVE_LRM_OP_T_RSC_DELETED
+	} else if(rc == HA_RSCBUSY) {
+	    crm_debug("Op %d for %s (%s): cancelation pending", op, rsc->id, key);
+#endif
+	} else {
 		crm_debug("Op %d for %s (%s): Nothing to cancel", op, rsc->id, key);
 		/* The caller needs to make sure the entry is
 		 * removed from the pending_ops list
@@ -917,19 +1018,6 @@ get_lrm_resource(xmlNode *resource, xmlN
 	return rsc;
 }
 
-static gboolean lrm_remove_deleted_op(
-    gpointer key, gpointer value, gpointer user_data)
-{
-    const char *rsc = user_data;
-    struct recurring_op_s *pending = value;
-    if(safe_str_eq(rsc, pending->rsc_id)) {
-	crm_info("Removing op %s:%d for deleted resource %s",
-		 pending->op_key, pending->call_id, rsc);
-	return TRUE;
-    }
-    return FALSE;
-}
-
 
 /*	 A_LRM_INVOKE	*/
 void
@@ -963,28 +1051,41 @@ do_lrm_invoke(long long action,
 
 	} else if(safe_str_eq(crm_op, CRM_OP_LRM_FAIL)) {
 #if HAVE_STRUCT_LRM_OPS_FAIL_RSC
+		int rc = HA_OK;
+		lrm_op_t* op = NULL;
+
 		lrm_rsc_t *rsc = NULL;
 		xmlNode *xml_rsc = find_xml_node(
 			input->xml, XML_CIB_TAG_RESOURCE, TRUE);
 
 		CRM_CHECK(xml_rsc != NULL, return);
 
+		op = construct_op(input->xml, ID(xml_rsc), "fail");
+		op->op_status = LRM_OP_ERROR;
+		op->rc = EXECRA_UNKNOWN_ERROR;
+		CRM_ASSERT(op != NULL);
+	    
 		rsc = get_lrm_resource(xml_rsc, input->xml, create_rsc);
 		if(rsc) {
-		    int rc = HA_OK;
 		    crm_info("Failing resource %s...", rsc->id);
 
 		    rc = fsa_lrm_conn->lrm_ops->fail_rsc(fsa_lrm_conn, rsc->id, 1, "do_lrm_invoke: Async failure");
 		    if(rc != HA_OK) {
 			crm_err("Could not initiate an asynchronous failure for %s (%d)", rsc->id, rc);
+		    } else {
+			op->op_status = LRM_OP_DONE;
+			op->rc = EXECRA_OK;
 		    }
-
+		    
 		    lrm_free_rsc(rsc);
 		    
 		} else {
 		    crm_info("Cannot find/create resource in order to fail it...");
 		    crm_log_xml_warn(input->msg, "bad input");
 		}
+
+		send_direct_ack(from_host, from_sys, NULL, op, ID(xml_rsc));
+		free_lrm_op(op);
 		return;
 #else
 		crm_info("Failing resource...");
@@ -1049,9 +1150,8 @@ do_lrm_invoke(long long action,
 
 		} else if(rsc == NULL) {
 			lrm_op_t* op = NULL;
-			crm_err("Not creating resource for a %s event: %s",
-				operation, ID(input->xml));
-			crm_log_xml_warn(input->msg, "bad input");
+			crm_notice("Not creating resource for a %s event: %s",
+				   operation, ID(input->xml));
 
 			op = construct_op(input->xml, ID(xml_rsc), operation);
 			op->op_status = LRM_OP_DONE;
@@ -1129,42 +1229,32 @@ do_lrm_invoke(long long action,
 			
 		} else if(safe_str_eq(operation, CRMD_ACTION_DELETE)) {
 			int rc = HA_OK;
-			lrm_op_t* op = NULL;
 
 			CRM_ASSERT(rsc != NULL);
-			op = construct_op(input->xml, rsc->id, operation);
-			CRM_ASSERT(op != NULL);
-			op->op_status = LRM_OP_DONE;
-			op->rc = EXECRA_OK;
-
 			crm_info("Removing resource %s from the LRM", rsc->id);
 			rc = fsa_lrm_conn->lrm_ops->delete_rsc(fsa_lrm_conn, rsc->id);
 			
-			if(rc != HA_OK) {
-			    crm_err("Failed to remove resource %s", rsc->id);
-			    op->op_status = LRM_OP_ERROR;
-			    op->rc = EXECRA_UNKNOWN_ERROR;
-			}
-
-			delete_rsc_entry(rsc->id);
-			send_direct_ack(from_host, from_sys, rsc, op, rsc->id);
-			free_lrm_op(op);			
-
-			g_hash_table_foreach_remove(pending_ops, lrm_remove_deleted_op, rsc->id);
-			
-			if(safe_str_neq(from_sys, CRM_SYSTEM_TENGINE)) {
-				/* this isn't expected - trigger a new transition */
-				time_t now = time(NULL);
-				char *now_s = crm_itoa(now);
-
-				crm_debug("Triggering a refresh after %s deleted %s from the LRM",
-					  from_sys, rsc->id);
-
-				update_attr(fsa_cib_conn, cib_none, XML_CIB_TAG_CRMCONFIG,
-					    NULL, NULL, NULL, NULL, "last-lrm-refresh", now_s, FALSE);
-				crm_free(now_s);
-			}
-			
+			if(rc == HA_OK) {
+			    crm_info("Resource '%s' deleted for %s on %s",
+				     rsc->id, from_sys, from_host);
+			    delete_rsc_entry(input, rsc->id, rc);
+			    
+#ifdef HAVE_LRM_OP_T_RSC_DELETED
+			} else if(rc == HA_RSCBUSY) {
+			    struct pending_deletion_op_s *op = NULL;
+			    crm_info("Resource deletion scheduled for %s on %s", from_sys, from_host);
+    
+			    crm_malloc0(op, sizeof(struct pending_deletion_op_s));
+			    op->rsc = crm_strdup(rsc->id);
+			    op->input = copy_ha_msg_input(input);
+			    g_hash_table_insert(
+				deletion_ops, crm_element_value_copy(input->msg, XML_ATTR_REFERENCE), op);
+#endif
+			} else {
+			    crm_err("Deletion of resource '%s' for %s on %s failed: %d",
+				    rsc->id, from_sys, from_host, rc);
+			    delete_rsc_entry(input, rsc->id, rc);
+			}			
 			
 		} else if(rsc != NULL) {
 		    do_lrm_rsc_op(rsc, operation, input->xml, input->msg);
@@ -1440,6 +1530,15 @@ do_lrm_rsc_op(lrm_rsc_t *rsc, const char
 }
 
 void
+free_deletion_op(gpointer value)
+{
+	struct pending_deletion_op_s *op = value;
+	crm_free(op->rsc);
+	delete_ha_msg_input(op->input);
+	crm_free(op);
+}
+
+void
 free_recurring_op(gpointer value)
 {
 	struct recurring_op_s *op = (struct recurring_op_s*)value;
@@ -1448,20 +1547,6 @@ free_recurring_op(gpointer value)
 	crm_free(op);
 }
 
-
-void
-free_lrm_op(lrm_op_t *op) 
-{
-	g_hash_table_destroy(op->params);
-	crm_free(op->user_data);
-	crm_free(op->output);
-	crm_free(op->rsc_id);
-	crm_free(op->op_type);
-	crm_free(op->app_name);
-	crm_free(op);	
-}
-
-
 static void dup_attr(gpointer key, gpointer value, gpointer user_data)
 {
 	g_hash_table_replace(user_data, crm_strdup(key), crm_strdup(value));
@@ -1753,6 +1838,14 @@ process_lrm_event(lrm_op_t *op)
 		crm_debug("Result: %s", op->output);
 	}
 
+#ifdef HAVE_LRM_OP_T_RSC_DELETED
+	if(op->rsc_deleted) {
+	    crm_info("Deletion of resource '%s' complete after %s", op->rsc_id, op_key);
+	    delete_rsc_entry(NULL, op->rsc_id, HA_OK);
+	}
+#endif
+
+	
 	/* If a shutdown was escalated while operations were pending, 
 	 * then the FSA will be stalled right now... allow it to continue
 	 */
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/main.c
--- a/crmd/main.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/main.c	Mon Jul 12 18:48:04 2010 +0200
@@ -77,7 +77,7 @@ main(int argc, char ** argv)
 	    return 0;
     }
 
-    crm_log_init(CRM_SYSTEM_CRMD, LOG_INFO, TRUE, FALSE, argc, argv);
+    crm_log_init(NULL, LOG_INFO, TRUE, FALSE, argc, argv);
     
     crm_info("CRM Hg Version: %s\n", BUILD_VERSION);
     
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/messages.c
--- a/crmd/messages.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/messages.c	Mon Jul 12 18:48:04 2010 +0200
@@ -44,7 +44,6 @@ void handle_response(xmlNode *stored_msg
 enum crmd_fsa_input handle_request(xmlNode *stored_msg);
 enum crmd_fsa_input handle_shutdown_request(xmlNode *stored_msg);
 
-ha_msg_input_t *copy_ha_msg_input(ha_msg_input_t *orig);
 gboolean ipc_queue_helper(gpointer key, gpointer value, gpointer user_data);
 
 
@@ -460,7 +459,7 @@ relay_message(xmlNode *msg, gboolean ori
 			 *   the PE or TE's data should be discarded
 			 */
 			
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 		    if(is_openais_cluster()) {
 			dest = text2msg_type(sys_to);
 		    }
@@ -482,7 +481,7 @@ relay_message(xmlNode *msg, gboolean ori
 		send_msg_via_ipc(msg, sys_to);
 			
 	} else {
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 	    if(is_openais_cluster()) {
 		dest = text2msg_type(sys_to);
 	    }
@@ -682,8 +681,9 @@ handle_failcount_op(xmlNode *stored_msg)
     const char *rsc = NULL;
     xmlNode *xml_rsc = get_xpath_object("//"XML_CIB_TAG_RESOURCE, stored_msg, LOG_ERR);
 
-    rsc = ID(xml_rsc);
-    crm_log_xml_info(stored_msg, "failcount op");
+    if(xml_rsc) {
+	rsc = ID(xml_rsc);
+    }
     
     if(rsc) {
 	char *attr = NULL;
@@ -696,6 +696,9 @@ handle_failcount_op(xmlNode *stored_msg)
 	attr = crm_concat("last-failure", rsc, '-');
 	update_attrd(NULL, attr, NULL);
 	crm_free(attr);
+
+    } else {
+	crm_log_xml_warn(stored_msg, "invalid failcount op");
     }
     
     return I_NULL;
@@ -725,9 +728,6 @@ handle_request(xmlNode *stored_msg)
 	} else if(strcmp(op, CRM_OP_JOIN_CONFIRM) == 0) {
 	    return I_JOIN_RESULT;
 	    
-	} else if(strcmp(op, CRM_OP_CLEAR_FAILCOUNT) == 0) {
-	    return handle_failcount_op(stored_msg);
-	    
 	} else if(strcmp(op, CRM_OP_SHUTDOWN) == 0) {
 	    const char *host_from = crm_element_value(stored_msg, F_CRM_HOST_FROM);
 	    gboolean dc_match = safe_str_eq(host_from, fsa_our_dc);
@@ -761,6 +761,9 @@ handle_request(xmlNode *stored_msg)
 	register_fsa_input_adv(C_HA_MESSAGE, I_NULL, &fsa_input,
 			       A_ELECTION_COUNT|A_ELECTION_CHECK, FALSE, __FUNCTION__);
 	
+    } else if(strcmp(op, CRM_OP_CLEAR_FAILCOUNT) == 0) {
+	return handle_failcount_op(stored_msg);
+	    
     } else if(strcmp(op, CRM_OP_VOTE) == 0) {
 	/* count the vote and decide what to do after that */
 	ha_msg_input_t fsa_input;
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/te_actions.c
--- a/crmd/te_actions.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/te_actions.c	Mon Jul 12 18:48:04 2010 +0200
@@ -95,10 +95,8 @@ send_stonith_update(crm_action_t *action
 	
 	free_xml(node_state);
 	
-#if 0
 	/* Make sure the membership cache is accurate */ 
-	crm_update_peer(0, 0, 0, -1, 0, uuid, target, NULL, CRM_NODE_LOST);
-#endif
+	crm_update_peer(0, 0, 0, -1, crm_proc_none, uuid, target, NULL, CRM_NODE_LOST);
 	
 	return;
 }
@@ -135,10 +133,6 @@ te_fence_node(crm_graph_t *graph, crm_ac
 	/* Passing NULL means block until we can connect... */
 	te_connect_stonith(NULL);
 
-	if(type == NULL) {
-	    type = "reboot";
-	}
-
 	rc = stonith_api->cmds->fence(
 	    stonith_api, 0, target, action->params, type, transition_graph->stonith_timeout/1000);
 
@@ -208,7 +202,7 @@ te_crm_command(crm_graph_t *graph, crm_a
 	    return TRUE;
 	}
 	
-	cmd = create_request(task, NULL, on_node, CRM_SYSTEM_CRMD,
+	cmd = create_request(task, action->xml, on_node, CRM_SYSTEM_CRMD,
 			     CRM_SYSTEM_TENGINE, NULL);
 	
 	counter = generate_transition_key(
@@ -219,7 +213,6 @@ te_crm_command(crm_graph_t *graph, crm_a
 	crm_free(counter);
 	free_xml(cmd);
 	
-	value = crm_meta_value(action->params, XML_ATTR_TE_NOWAIT);
 	if(rc == FALSE) {
 		crm_err("Action %d failed: send", action->id);
 		return FALSE;
@@ -560,6 +553,8 @@ notify_crmd(crm_graph_t *graph)
 
 	if(event != I_NULL) {
 	    register_fsa_input(C_FSA_INTERNAL, event, NULL);
+
+	} else if(fsa_source) {
+	    mainloop_set_trigger(fsa_source);
 	}
-	
 }
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/te_events.c
--- a/crmd/te_events.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/te_events.c	Mon Jul 12 18:48:04 2010 +0200
@@ -43,7 +43,7 @@ need_abort(xmlNode *update)
 	return FALSE;
     }
     
-    xml_prop_iter(update, name, value,
+    xml_prop_name_iter(update, name,
 		  if(safe_str_eq(name, XML_ATTR_HAVE_QUORUM)) {
 		      goto do_abort; /* possibly not required */
 		  } else if(safe_str_eq(name, XML_ATTR_GENERATION)) {
diff -r f059ec7ced7a -r b230ffa2ecdc crmd/te_utils.c
--- a/crmd/te_utils.c	Mon May 17 17:57:40 2010 +0200
+++ b/crmd/te_utils.c	Mon Jul 12 18:48:04 2010 +0200
@@ -101,6 +101,10 @@ tengine_stonith_connection_destroy(stoni
       <st_calldata >
         <st-reply st_origin="stonith_construct_async_reply" t="stonith-ng" st_op="reboot" st_remote_op="1230801d-dba5-42ac-8e2c-bf444fb2a401" st_callid="0" st_callopt="0" st_rc="0" src="pcmk-4" seq="2" state="0" st_target="pcmk-1" />
 */
+#ifdef SUPPORT_CMAN
+#  include <libfenced.h>
+#  include "../lib/common/stack.h"
+#endif
 
 static void
 tengine_stonith_notify(stonith_t *st, const char *event, xmlNode *msg)
@@ -128,6 +132,27 @@ tengine_stonith_notify(stonith_t *st, co
 	     executioner, origin,
 	     crm_element_value(action, F_STONITH_REMOTE),
 	     stonith_error2string(rc));
+
+#ifdef SUPPORT_CMAN
+    if(rc == stonith_ok && is_cman_cluster()) {
+	int rc = 0;
+	char *target_copy = crm_strdup(target);
+	crm_info("Notifing CMAN that '%s' is now fenced", target);
+
+	rc = fenced_join();
+	if(rc != 0) {
+	    crm_notice("Could not connect to fenced: rc=%d", rc);
+
+	} else {
+	    rc = fenced_external(target_copy);
+	    if(rc != 0) {
+		crm_err("Could not notify fenced: rc=%d", rc);
+	    }
+	    fenced_leave();
+	}
+	crm_free(target_copy);
+    }
+#endif
     
     if(rc == stonith_ok && safe_str_eq(target, origin)) {
 	if(fsa_our_dc == NULL || safe_str_eq(fsa_our_dc, target)) {
diff -r f059ec7ced7a -r b230ffa2ecdc cts/CIB.py
--- a/cts/CIB.py	Mon May 17 17:57:40 2010 +0200
+++ b/cts/CIB.py	Mon Jul 12 18:48:04 2010 +0200
@@ -406,21 +406,8 @@ class CIB10(CibBase):
         # Tell the shell to mind its own business, we know what we're doing
         self.CM.rsh(self.target, "crm options check-mode relaxed")
 
-        # Now stop the shell from rejecting every update because we've not defined stonith resources yet
-        self._create('''property stonith-enabled=false''')
-
-        self._create('''property start-failure-is-fatal=false pe-input-series-max=5000''')
-        self._create('''property shutdown-escalation=5min startup-fencing=false batch-limit=10 dc-deadtime=5s''')
-        self._create('''property no-quorum-policy=%s expected-quorum-votes=%d''' % (no_quorum, self.num_nodes))
-
-        if self.CM.Env["DoBSC"] == 1:
-            self._create('''property ident-string="Linux-HA TEST configuration file - REMOVEME!!"''')
-
-        # Add resources?
-        if self.CM.Env["CIBResource"] == 1:
-            self.add_resources()
-
         # Fencing resource
+        # Define first so that the shell doesn't reject every update
         if self.CM.Env["DoFencing"]:
             params = None
             entries = string.split(self.CM.Env["stonith-params"], ',')
@@ -442,13 +429,23 @@ class CIB10(CibBase):
             self._create('''primitive FencingChild stonith::%s %s op monitor interval=120s timeout=300 op start interval=0 timeout=180s op stop interval=0 timeout=180s''' % (self.CM.Env["stonith-type"], params))
             # Set a threshold for unreliable stonith devices such as the vmware one
             self._create('''clone Fencing FencingChild meta globally-unique=false migration-threshold=5''')
-        
+
+        self._create('''property stonith-enabled=%s''' % (self.CM.Env["DoFencing"]))
+        self._create('''property start-failure-is-fatal=false pe-input-series-max=5000 default-action-timeout=60s''')
+        self._create('''property shutdown-escalation=5min startup-fencing=false batch-limit=10 dc-deadtime=5s''')
+        self._create('''property no-quorum-policy=%s expected-quorum-votes=%d''' % (no_quorum, self.num_nodes))
+
+        if self.CM.Env["DoBSC"] == 1:
+            self._create('''property ident-string="Linux-HA TEST configuration file - REMOVEME!!"''')
+
+        # Add resources?
+        if self.CM.Env["CIBResource"] == 1:
+            self.add_resources()
+
         if self.CM.cluster_monitor == 1:
             self._create('''primitive cluster_mon ocf:pacemaker:ClusterMon params update=10 extra_options="-r -n" user=abeekhof htmlfile=/suse/abeekhof/Export/cluster.html op start interval=0 requires=nothing op monitor interval=5s requires=nothing''')
             self._create('''location prefer-dc cluster_mon rule -INFINITY: \#is_dc eq false''')
 
-        self._create('''property stonith-enabled=%s''' % (self.CM.Env["DoFencing"]))
-            
         # generate cib
         self.cts_cib = self._show("xml")
 
@@ -460,9 +457,10 @@ class CIB10(CibBase):
     def add_resources(self):
         # Group Resource
         r1 = self.NewIP()
-        ip = self.NextIP()
-        r2 = "r"+ip
-        self._create('''primitive %s heartbeat::IPaddr params 1=%s/32 op monitor interval=5s''' % (r2, ip))
+        #ip = self.NextIP()
+        #r2 = "r"+ip
+        #self._create('''primitive %s heartbeat::IPaddr params 1=%s/32 op monitor interval=5s''' % (r2, ip))
+        r2 = self.NewIP()
         r3 = self.NewIP()
         self._create('''group group-1 %s %s %s''' % (r1, r2, r3))
 
@@ -486,7 +484,7 @@ class CIB10(CibBase):
         self._create('''clone Connectivity ping-1 meta globally-unique=false''')
 
         #master slave resource
-        self._create('''primitive stateful-1 ocf:pacemaker:Stateful op monitor interval=15s op monitor interval=16s role=Master''')
+        self._create('''primitive stateful-1 ocf:pacemaker:Stateful op monitor interval=15s timeout=60s op monitor interval=16s role=Master timeout=60s ''')
         self._create('''ms master-1 stateful-1 meta clone-max=%d clone-node-max=%d master-max=%d master-node-max=%d'''
                      % (self.num_nodes, 1, 1, 1))
 
diff -r f059ec7ced7a -r b230ffa2ecdc cts/CM_ais.py
--- a/cts/CM_ais.py	Mon May 17 17:57:40 2010 +0200
+++ b/cts/CM_ais.py	Mon Jul 12 18:48:04 2010 +0200
@@ -44,10 +44,10 @@ class crm_ais(crm_lha):
         self.update({
             "Name"           : "crm-ais",
 
-            "UUIDQueryCmd"   : "crmadmin -N",
-            "EpocheCmd"      : "crm_node -e",
-            "QuorumCmd"      : "crm_node -q",
-            "ParitionCmd"    : "crm_node -p",
+            "UUIDQueryCmd"   : "crmadmin -N --openais",
+            "EpocheCmd"      : "crm_node -e --openais",
+            "QuorumCmd"      : "crm_node -q --openais",
+            "ParitionCmd"    : "crm_node -p --openais",
 
             "Pat:They_stopped" : "%s crmd:.*Node %s: .* state=lost .new",            
             "Pat:ChildExit"    : "Child process .* exited",
@@ -255,8 +255,8 @@ class crm_flatiron(crm_ais):
 
         self.update({
             "Name"           : "crm-flatiron",
-            "StartCmd"       : CTSvars.INITDIR+"/corosync start",
-            "StopCmd"        : CTSvars.INITDIR+"/corosync stop",
+            "StartCmd"       : "service corosync start",
+            "StopCmd"        : "service corosync stop",
 
 # The next pattern is too early
 #            "Pat:We_stopped"   : "%s.*Service engine unloaded: Pacemaker Cluster Manager",
@@ -268,7 +268,6 @@ class crm_flatiron(crm_ais):
             
             "Pat:ChildKilled"  : "%s corosync.*Child process %s terminated with signal 9",
             "Pat:ChildRespawn" : "%s corosync.*Respawning failed child process: %s",
-            "Pat:ChildExit"    : "Child process .* exited",
         })
 
     def Components(self):    
@@ -297,3 +296,52 @@ class crm_flatiron(crm_ais):
         
     
         return self.complist
+
+class crm_mcp(crm_flatiron):
+    '''
+    The crm version 3 cluster manager class.
+    It implements the things we need to talk to and manipulate
+    crm clusters running on top of openais
+    '''
+    def __init__(self, Environment, randseed=None):
+        crm_flatiron.__init__(self, Environment, randseed=randseed)
+
+        self.update({
+            "Name"           : "crm-mcp",
+            "StartCmd"       : "service corosync start; service pacemaker start",
+            "StopCmd"        : "service pacemaker stop; service corosync stop",
+
+            "Pat:We_stopped"  : "%s.*Service engine unloaded: corosync cluster quorum service",
+            "Pat:They_stopped" : "%s crmd:.*Node %s: .* state=lost .new",
+            "Pat:They_dead"    : "crmd:.*Node %s: .* state=lost .new",
+            
+            "Pat:ChildKilled"  : "%s pacemakerd.*Child process %s terminated with signal 9",
+            "Pat:ChildRespawn" : "%s pacemakerd.*Respawning failed child process: %s",
+        })
+
+class crm_cman(crm_flatiron):
+    '''
+    The crm version 3 cluster manager class.
+    It implements the things we need to talk to and manipulate
+    crm clusters running on top of openais
+    '''
+    def __init__(self, Environment, randseed=None):
+        crm_flatiron.__init__(self, Environment, randseed=randseed)
+
+        self.update({
+            "Name"           : "crm-cman",
+            "StartCmd"       : "service corosync start; service pacemaker start",
+            "StopCmd"        : "service pacemaker stop; cman_tool leave",
+
+            "UUIDQueryCmd"   : "crmadmin -N --cman",
+            "EpocheCmd"      : "crm_node -e --cman",
+            "QuorumCmd"      : "crm_node -q --cman",
+            "ParitionCmd"    : "crm_node -p --cman",
+
+            "Pat:We_stopped"  : "%s.*Service engine unloaded: corosync cluster quorum service",
+            "Pat:They_stopped" : "%s crmd:.*Node %s: .* state=lost .new",
+            "Pat:They_dead"    : "crmd:.*Node %s: .* state=lost .new",
+            
+            "Pat:ChildKilled"  : "%s pacemakerd.*Child process %s terminated with signal 9",
+            "Pat:ChildRespawn" : "%s pacemakerd.*Respawning failed child process: %s",
+        })
diff -r f059ec7ced7a -r b230ffa2ecdc cts/CM_lha.py
--- a/cts/CM_lha.py	Mon May 17 17:57:40 2010 +0200
+++ b/cts/CM_lha.py	Mon Jul 12 18:48:04 2010 +0200
@@ -94,8 +94,8 @@ class crm_lha(ClusterManager):
             "LogFileName"    : Environment["LogFileName"],
 
             "UUIDQueryCmd"    : "crmadmin -N",
-            "StandbyCmd"      : "crm_standby -U %s -v %s 2>/dev/null",
-            "StandbyQueryCmd" : "crm_standby -GQ -U %s 2>/dev/null",
+            "StandbyCmd"      : "crm_attribute -Q  -U %s -n standby -l forever -v %s 2>/dev/null",
+            "StandbyQueryCmd" : "crm_attribute -GQ -U %s -n standby -l forever -d off 2>/dev/null",
 
             # Patterns to look for in the log files for various occasions...
             "Pat:DC_IDLE"      : "crmd.*State transition.*-> S_IDLE",
@@ -469,7 +469,10 @@ class crm_lha(ClusterManager):
             "ERROR: stonithd_signon: ",
             "update_failcount: Updating failcount for child_DoFencing",
             "ERROR: te_connect_stonith: Sign-in failed: triggered a retry",
-            ]
+            "lrmd: .*ERROR: cl_get_value: wrong argument (reply)",
+            "lrmd: .*ERROR: is_expected_msg:.* null message",
+            "lrmd: .*ERROR: stonithd_receive_ops_result failed.",
+             ]
 
         stonith_ignore.extend(common_ignore)
 
@@ -501,7 +504,7 @@ class crm_lha(ClusterManager):
 #                    "Processing I_NODE_JOIN:.* cause=C_HA_MESSAGE",
 #                    "State transition S_.* -> S_INTEGRATION.*input=I_NODE_JOIN",
                     "State transition S_STARTING -> S_PENDING",
-                    ], badnews_ignore = common_ignore)
+                    ], badnews_ignore = ccm_ignore)
 
         cib = Process(self, "cib", triggersreboot=self.fastfail, pats = [
                     "State transition .* S_RECOVERY",
diff -r f059ec7ced7a -r b230ffa2ecdc cts/CTS.py
--- a/cts/CTS.py	Mon May 17 17:57:40 2010 +0200
+++ b/cts/CTS.py	Mon Jul 12 18:48:04 2010 +0200
@@ -1053,6 +1053,8 @@ class ClusterManager(UserDict):
             return 1
 
         if self.rsh(node, self["StopCmd"]) == 0:
+            # Make sure we can continue even if corosync leaks
+            self.rsh(node, "rm -f /dev/shm/fdata-*")
             self.ShouldBeStatus[node]="down"
             self.cluster_stable(self["DeadTime"])
             return 1
diff -r f059ec7ced7a -r b230ffa2ecdc cts/CTSlab.py
--- a/cts/CTSlab.py	Mon May 17 17:57:40 2010 +0200
+++ b/cts/CTSlab.py	Mon Jul 12 18:48:04 2010 +0200
@@ -321,6 +321,13 @@ if __name__ == '__main__':
        elif args[i] == "--no-loop-tests":
            Environment["loop-tests"] = 0
 
+       elif args[i] == "--loop-minutes":
+           skipthis=1
+           try:
+               Environment["loop-minutes"]=int(args[i+1])
+           except ValueError:
+               usage(args[i])
+
        elif args[i] == "--no-unsafe-tests":
            Environment["unsafe-tests"] = 0
 
@@ -338,7 +345,6 @@ if __name__ == '__main__':
            except ValueError:
                usage(args[i])
 
-    Environment["loop-minutes"] = int(Environment["loop-minutes"])
     if Environment["DoBSC"]:
         NumIter = 2
         LimitNodes = 1
@@ -368,6 +374,16 @@ if __name__ == '__main__':
         Environment['CMclass']  = crm_flatiron
         Environment["use_logd"] = 0
 
+    elif Environment["Stack"] == "cman":
+        Environment["Stack"]    = "corosync (cman)"
+        Environment['CMclass']  = crm_cman
+        Environment["use_logd"] = 0
+
+    elif Environment["Stack"] == "mcp":
+        Environment["Stack"]    = "corosync (mcp)"
+        Environment['CMclass']  = crm_mcp
+        Environment["use_logd"] = 0
+
     else:
         print "Unknown stack: "+Environment["Stack"]
         sys.exit(1)
diff -r f059ec7ced7a -r b230ffa2ecdc cts/CTSscenarios.py
--- a/cts/CTSscenarios.py	Mon May 17 17:57:40 2010 +0200
+++ b/cts/CTSscenarios.py	Mon Jul 12 18:48:04 2010 +0200
@@ -93,7 +93,7 @@ A partially set up scenario is torn down
                 # OOPS!  We failed.  Tear partial setups down.
                 self.audit()
                 self.ClusterManager.log("Tearing down partial setup")
-                self.TearDown(self.ClusterManager, j)
+                self.TearDown(j)
                 return None
             j=j+1
 
diff -r f059ec7ced7a -r b230ffa2ecdc cts/CTStests.py
--- a/cts/CTStests.py	Mon May 17 17:57:40 2010 +0200
+++ b/cts/CTStests.py	Mon Jul 12 18:48:04 2010 +0200
@@ -852,7 +852,8 @@ class ValgrindTest(CTSTest):
                 (rc, output) = self.CM.rsh(node, "cat %s" % self.logPat, None)
                 for line in output:
                     self.CM.debug(line)
-                self.CM.rsh(node, "rm -f %s" % self.logPat, None)
+
+        self.CM.rsh(node, "rm -f %s" % self.logPat, None)
         return leaked
 
     def __call__(self, node):
diff -r f059ec7ced7a -r b230ffa2ecdc cts/Makefile.am
--- a/cts/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/cts/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -24,7 +24,7 @@ CLEANFILES      = LSBDummy
 EXTRA_DIST      = $(cts_SCRIPTS) $(cts_DATA)
 
 ctsdir		= $(datadir)/$(PACKAGE)/tests/cts
-ctslibdir	= $(pythondir)/cts
+ctslibdir	= $(pyexecdir)/cts
 
 ctslib_PYTHON	=	__init__.py		\
 			CTSvars.py		\
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Author_Group.xml
--- a/doc/Clusters_from_Scratch/en-US/Author_Group.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Author_Group.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -1,17 +1,10 @@
 <?xml version='1.0' encoding='utf-8' ?>
 <!DOCTYPE authorgroup PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
-<!ENTITY % BOOK_ENTITIES SYSTEM "Clusters_from_Scratch.ent">
-%BOOK_ENTITIES;
 ]>
-<authorgroup lang="en-US">
-	<author>
-		<firstname>Dude</firstname>
-		<surname>McPants</surname>
-		<affiliation>
-			<orgname>Somewhere</orgname>
-			<orgdiv>Someone</orgdiv>
-		</affiliation>
-		<email>Dude.McPants@example.com</email>
-	</author>
+<authorgroup>
+  <author>
+    <firstname>Andrew</firstname><surname>Beekhof</surname>
+    <affiliation><orgname>Red Hat</orgname></affiliation>
+    <email>andrew@beekhof.net</email>
+  </author>
 </authorgroup>
-
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Book_Info.xml
--- a/doc/Clusters_from_Scratch/en-US/Book_Info.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Book_Info.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -19,7 +19,7 @@
 			<orderedlist>
 				<listitem>
 					<para>
-						Fedora 12 as the host operating system
+						&DISTRO; &DISTRO_VERSION; as the host operating system
 					</para>
 				</listitem>
 				<listitem>
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Ch-Active-Active.xml
--- a/doc/Clusters_from_Scratch/en-US/Ch-Active-Active.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Ch-Active-Active.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -4,61 +4,551 @@
 %BOOK_ENTITIES;
 ]>
 <chapter lang="en-US">
-	<title>Reconfigure Pacemaker for Active/Active</title>
-	<para>
-		Almost everything is in place. Recent versions of DRBD are capable of operating in Primary/Primary mode and the filesystem were using is cluster aware. All we need to do now is reconfigure the cluster to take advantage of this.
-	</para>
-	<para>
-		This will involve a number of changes, so well again use interactive mode.
-	</para>
+  <title>Conversion to Active/Active</title>
+  <section>
+    <title>Requirements</title>
+    <para>
+      The primary requirement for an Active/Active cluster is that the data required for your services are available, simultaneously, on both machines.
+      Pacemaker makes no requirement on how this is achieved, you could use a SAN if you had one available, however since DRBD supports multiple Primaries, we can also use that.
+    </para>
+    <para>
+      The only hitch is that we need to use a cluster-aware filesystem (and the one we used earlier with DRBD, ext4, is not one of those).
+      Both OCFS2 and GFS2 are supported, however here we will use GFS2 which comes with &DISTRO; &DISTRO_VERSION; .
+    </para>
+  </section>
+  <section>
+    <title>Install a Cluster Filesystem - GFS2</title>
+    <para>
+      The first thing to do is install gfs2-utils on each machine.
+    </para>
+    <screen>
+[root@pcmk-1 ~]# <userinput>yum install -y gfs2-utils gfs-pcmk</userinput>
+Setting up Install Process
+Resolving Dependencies
+--&gt; Running transaction check
+---&gt; Package gfs-pcmk.x86_64 0:3.0.5-2.fc12 set to be updated
+--&gt; Processing Dependency: libSaCkpt.so.3(OPENAIS_CKPT_B.01.01)(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
+--&gt; Processing Dependency: dlm-pcmk for package: gfs-pcmk-3.0.5-2.fc12.x86_64
+--&gt; Processing Dependency: libccs.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
+--&gt; Processing Dependency: libdlmcontrol.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
+--&gt; Processing Dependency: liblogthread.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
+--&gt; Processing Dependency: libSaCkpt.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
+---&gt; Package gfs2-utils.x86_64 0:3.0.5-2.fc12 set to be updated
+--&gt; Running transaction check
+---&gt; Package clusterlib.x86_64 0:3.0.5-2.fc12 set to be updated
+---&gt; Package dlm-pcmk.x86_64 0:3.0.5-2.fc12 set to be updated
+---&gt; Package openaislib.x86_64 0:1.1.0-1.fc12 set to be updated
+--&gt; Finished Dependency Resolution
+
+Dependencies Resolved
+
+===========================================================================================
+Package        Arch        Version          Repository    Size
+===========================================================================================
+Installing:
+gfs-pcmk        x86_64       3.0.5-2.fc12       custom      101 k
+gfs2-utils       x86_64       3.0.5-2.fc12       custom      208 k
+Installing for dependencies:
+clusterlib       x86_64       3.0.5-2.fc12       custom      65 k
+dlm-pcmk        x86_64       3.0.5-2.fc12       custom      93 k
+openaislib       x86_64       1.1.0-1.fc12       fedora      76 k
+
+Transaction Summary
+===========================================================================================
+Install    5 Package(s)
+Upgrade    0 Package(s)
+
+Total download size: 541 k
+Downloading Packages:
+(1/5): clusterlib-3.0.5-2.fc12.x86_64.rpm                | 65 kB   00:00
+(2/5): dlm-pcmk-3.0.5-2.fc12.x86_64.rpm                 | 93 kB   00:00
+(3/5): gfs-pcmk-3.0.5-2.fc12.x86_64.rpm                 | 101 kB   00:00
+(4/5): gfs2-utils-3.0.5-2.fc12.x86_64.rpm                | 208 kB   00:00
+(5/5): openaislib-1.1.0-1.fc12.x86_64.rpm                | 76 kB   00:00
+-------------------------------------------------------------------------------------------
+Total                              992 kB/s | 541 kB   00:00
+Running rpm_check_debug
+Running Transaction Test
+Finished Transaction Test
+Transaction Test Succeeded
+Running Transaction
+ Installing   : clusterlib-3.0.5-2.fc12.x86_64                    1/5 
+ Installing   : openaislib-1.1.0-1.fc12.x86_64                    2/5 
+ Installing   : dlm-pcmk-3.0.5-2.fc12.x86_64                     3/5 
+ Installing   : gfs-pcmk-3.0.5-2.fc12.x86_64                     4/5 
+ Installing   : gfs2-utils-3.0.5-2.fc12.x86_64                    5/5 
+
+Installed:
+ gfs-pcmk.x86_64 0:3.0.5-2.fc12          gfs2-utils.x86_64 0:3.0.5-2.fc12
+
+Dependency Installed:
+ clusterlib.x86_64 0:3.0.5-2.fc12  dlm-pcmk.x86_64 0:3.0.5-2.fc12 
+ openaislib.x86_64 0:1.1.0-1.fc12 
+
+Complete!
+[root@pcmk-1 x86_64]#
+</screen>
+	</section>
 	
+	<section>
+		<title>Setup Pacemaker-GFS2 Integration</title>
+		<para>
+			GFS2 needs two services to be running, the first is the user-space interface to the kernels distributed lock manager (DLM). The DLM is used to co-ordinate which node(s) can access a given file (and when) and integrates with Pacemaker to obtain node membership <footnote>
+			<para>
+				The list of nodes the cluster considers to be available
+			</para>
+			</footnote> information and fencing capabilities.
+		</para>
+		<para>
+			The second service is GFS2s own control daemon which also integrates with Pacemaker to obtain node membership data.
+		</para>
+		<section>
+			<title>Add the DLM service</title>
+			<para>
+				The DLM control daemon needs to run on all active cluster nodes, so we will use the shells interactive mode to create a cloned resource.
+			</para>
+			
 <screen>
-crm 
-cib new active
+[root@pcmk-1 ~]# <userinput>crm</userinput>
+crm(live)# <userinput>cib new stack-glue</userinput>
+INFO: stack-glue shadow CIB created
+crm(stack-glue)# <userinput>configure primitive dlm ocf:pacemaker:controld op monitor interval=120s</userinput>
+crm(stack-glue)# <userinput>configure clone dlm-clone dlm meta interleave=true</userinput>
+crm(stack-glue)# <userinput>configure show xml</userinput>
+crm(stack-glue)# <userinput>configure show</userinput>
+node pcmk-1
+node pcmk-2
+primitive WebData ocf:linbit:drbd \
+    params drbd_resource="wwwdata" \
+    op monitor interval="60s"
+primitive WebFS ocf:heartbeat:Filesystem \
+    params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype="ext4"
+primitive WebSite ocf:heartbeat:apache \
+    params configfile="/etc/httpd/conf/httpd.conf" \
+    op monitor interval="1min"
+primitive ClusterIP ocf:heartbeat:IPaddr2 \
+    params ip="192.168.122.101" cidr_netmask="32" \
+    op monitor interval="30s"
+<emphasis>primitive dlm ocf:pacemaker:controld \</emphasis>
+<emphasis> op monitor interval="120s"</emphasis>
+ms WebDataClone WebData \
+    meta master-max="1" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
+<emphasis>clone dlm-clone dlm \</emphasis>
+<emphasis> meta interleave="true"</emphasis>
+location prefer-pcmk-1 WebSite 50: pcmk-1
+colocation WebSite-with-WebFS inf: WebSite WebFS
+colocation fs_on_drbd inf: WebFS WebDataClone:Master
+colocation website-with-ip inf: WebSite ClusterIP
+order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
+order WebSite-after-WebFS inf: WebFS WebSite
+order apache-after-ip inf: ClusterIP WebSite
+property $id="cib-bootstrap-options" \
+    dc-version="1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7" \
+    cluster-infrastructure="openais" \
+    expected-quorum-votes=2 \
+    stonith-enabled="false" \
+    no-quorum-policy="ignore"
+rsc_defaults $id="rsc-options" \
+    resource-stickiness=100
 </screen>
-	<para>
-		Theres no point making the services active on both locations if we cant reach them, so lets first clone the IP address. Cloned IPaddr2 resources use an iptables rule to ensure that each request only processed by one of the two clone instances. The additional meta options tell the cluster how many instances of the clone we want (one request bucket for each node) and that if all other nodes fail, then the remaining node should hold all of them. Otherwise the requests would be simply discarded.
-	</para>
+			<note>
+				<para>
+					TODO: Explain the meaning of the interleave option
+				</para>
+			</note>
+			<para>
+				Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
+			</para>
+			
+<screen>
+crm(stack-glue)# <userinput>cib commit stack-glue</userinput>
+INFO: commited 'stack-glue' shadow CIB to the cluster
+crm(stack-glue)# <userinput>quit</userinput>
+bye
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
+============
+Last updated: Thu Sep 3 20:49:54 2009
+Stack: openais
+Current DC: pcmk-2 - partition with quorum
+Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
+2 Nodes configured, 2 expected votes
+5 Resources configured.
+============
+
+Online: [ pcmk-1 pcmk-2 ]
+
+WebSite (ocf::heartbeat:apache):    Started pcmk-2
+Master/Slave Set: WebDataClone
+    Masters: [ pcmk-1 ]
+    Slaves: [ pcmk-2 ]
+ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-2
+<emphasis>Clone Set: dlm-clone</emphasis>
+<emphasis> Started: [ pcmk-2 pcmk-1 ]</emphasis>
+WebFS  (ocf::heartbeat:Filesystem):  Started pcmk-2
+</screen>
+		</section>
+		
+		<section>
+			<title>Add the GFS2 service</title>
+			<para>
+				Once the DLM is active, we can add the GFS2 control daemon.
+			</para>
+			<para>
+				Use the crm shell to create the gfs-control cluster resource:
+			</para>
+			
+<screen>
+[root@pcmk-1 ~]# <userinput>crm</userinput>
+crm(live)# <userinput>cib new gfs-glue --force</userinput>
+INFO: gfs-glue shadow CIB created
+crm(gfs-glue)# <userinput>configure primitive gfs-control ocf:pacemaker:controld params daemon=gfs_controld.pcmk args="-g 0" op monitor interval=120s</userinput>
+crm(gfs-glue)# <userinput>configure clone gfs-clone gfs-control meta interleave=true</userinput>
+</screen>
+			<para>
+				Now ensure Pacemaker only starts the gfs-control service on nodes that also have a copy of the dlm service (created above) already running
+			</para>
+			
+<screen>
+crm(gfs-glue)# <userinput>configure colocation gfs-with-dlm INFINITY: gfs-clone dlm-clone</userinput>
+crm(gfs-glue)# <userinput>configure order start-gfs-after-dlm mandatory: dlm-clone gfs-clone</userinput>
+</screen>
+			<para>
+				Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
+			</para>
+			
+<screen>
+crm(gfs-glue)# <userinput>configure show</userinput>
+node pcmk-1
+node pcmk-2
+primitive WebData ocf:linbit:drbd \
+    params drbd_resource="wwwdata" \
+    op monitor interval="60s"
+primitive WebFS ocf:heartbeat:Filesystem \
+    params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype="ext4"
+primitive WebSite ocf:heartbeat:apache \
+    params configfile="/etc/httpd/conf/httpd.conf" \
+    op monitor interval="1min"
+primitive ClusterIP ocf:heartbeat:IPaddr2 \
+    params ip="192.168.122.101" cidr_netmask="32" \
+    op monitor interval="30s"
+primitive dlm ocf:pacemaker:controld \
+    op monitor interval="120s"
+<emphasis>primitive gfs-control ocf:pacemaker:controld \</emphasis>
+<emphasis> params daemon=gfs_controld.pcmk args=-g 0 \</emphasis>
+<emphasis> op monitor interval="120s"</emphasis>
+ms WebDataClone WebData \
+    meta master-max="1" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
+clone dlm-clone dlm \
+    meta interleave="true"
+<emphasis>clone gfs-clone gfs-control \</emphasis>
+<emphasis> meta interleave="true"</emphasis>
+location prefer-pcmk-1 WebSite 50: pcmk-1
+colocation WebSite-with-WebFS inf: WebSite WebFS
+colocation fs_on_drbd inf: WebFS WebDataClone:Master
+<emphasis>colocation gfs-with-dlm inf: gfs-clone dlm-clone</emphasis>
+colocation website-with-ip inf: WebSite ClusterIP
+order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
+order WebSite-after-WebFS inf: WebFS WebSite
+order apache-after-ip inf: ClusterIP WebSite
+<emphasis>order start-gfs-after-dlm inf: dlm-clone gfs-clone</emphasis>
+property $id="cib-bootstrap-options" \
+    dc-version="1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7" \
+    cluster-infrastructure="openais" \
+    expected-quorum-votes=2 \
+    stonith-enabled="false" \
+    no-quorum-policy="ignore"
+rsc_defaults $id="rsc-options" \
+    resource-stickiness=100
+crm(gfs-glue)# <userinput>cib commit gfs-glue</userinput>
+INFO: commited 'gfs-glue' shadow CIB to the cluster
+crm(gfs-glue)# <userinput>quit</userinput>
+bye
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
+============
+Last updated: Thu Sep 3 20:49:54 2009
+Stack: openais
+Current DC: pcmk-2 - partition with quorum
+Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
+2 Nodes configured, 2 expected votes
+6 Resources configured.
+============
+
+Online: [ pcmk-1 pcmk-2 ]
+
+WebSite (ocf::heartbeat:apache):    Started pcmk-2
+Master/Slave Set: WebDataClone
+    Masters: [ pcmk-1 ]
+    Slaves: [ pcmk-2 ]
+ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-2
+Clone Set: dlm-clone
+    Started: [ pcmk-2 pcmk-1 ]
+<emphasis>Clone Set: gfs-clone</emphasis>
+<emphasis> Started: [ pcmk-2 pcmk-1 ]</emphasis>
+WebFS  (ocf::heartbeat:Filesystem):  Started pcmk-1
+</screen>
+		</section>
+
+	</section>
 	
+	<section>
+		<title>Create a GFS2 Filesystem</title>
+		<section>
+			<title>Preparation</title>
+			<para>
+				Before we do anything to the existing partition, we need to make sure it is unmounted. We do this by tell the cluster to stop the WebFS resource. This will ensure that other resources (in our case, Apache) using WebFS are not only stopped, but stopped in the correct order.
+			</para>
+			
 <screen>
-configure clone WebIP ClusterIP \
-    meta globally-unique=true clone-max=2 clone-node-max=2
+[root@pcmk-1 ~]# <userinput>crm_resource --resource WebFS --set-parameter target-role --meta --parameter-value Stopped</userinput>
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
+============
+Last updated: Thu Sep 3 15:18:06 2009
+Stack: openais
+Current DC: pcmk-1 - partition with quorum
+Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
+2 Nodes configured, 2 expected votes
+6 Resources configured.
+============
+
+Online: [ pcmk-1 pcmk-2 ]
+
+Master/Slave Set: WebDataClone
+    Masters: [ pcmk-1 ]
+    Slaves: [ pcmk-2 ]
+ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-1
+Clone Set: dlm-clone
+    Started: [ pcmk-2 pcmk-1 ]
+Clone Set: gfs-clone
+    Started: [ pcmk-2 pcmk-1 ]
 </screen>
-	<para>
-		Now we must tell the ClusterIP how to decide which requests are processed by which hosts. To do this we must specify the clusterip_hash parameter.
-	</para>
-	<para>
-		Open the ClusterIP resource
-	</para>
+			<note>
+				<para>
+					Note that both Apache and WebFS have been stopped.
+				</para>
+			</note>
+		</section>
+		
+		<section>
+			<title>Create and Populate an GFS2 Partition</title>
+			<para>
+				Now that the cluster stack and integration pieces are running smoothly, we can create an GFS2 partition.
+			</para>
+			<warning>
+				<para>
+					This will erase all previous content stored on the DRBD device. Ensure you have a copy of any important data.
+				</para>
+			</warning>
+			<para>
+				We need to specify a number of additional parameters when creating a GFS2 partition.
+			</para>
+			<para>
+				First we must use the -p option to specify that we want to use the the Kernels DLM. Next we use -j to indicate that it should reserve enough space for two journals (one per node accessing the filesystem).
+			</para>
+			<para>
+				Lastly, we use -t to specify the lock table name. The format for this field is clustername:fsname. For the fsname, we just need to pick something unique and descriptive and since we havent specified a clustername yet, we will use the default (pcmk).
+			</para>
+			<para>
+				To specify an alternate name for the cluster, locate the service section containing name: pacemaker in corosync.conf and insert the following line anywhere inside the block:
+			</para>
+			<para>
+				clustername: myname
+			</para>
+			<para>
+				Do this on each node in the cluster and be sure to restart them before continuing.
+			</para>
+			
+<screen>
+mkfs.gfs2 -p lock_dlm -j 2 -t pcmk:web /dev/drbd1
+[root@pcmk-1 ~]# <userinput>mkfs.gfs2 -t pcmk:web -p lock_dlm -j 2 /dev/vdb </userinput>
+This will destroy any data on /dev/vdb.
+It appears to contain: data
+
+Are you sure you want to proceed? [y/n] y
+
+Device:          /dev/vdb
+Blocksize:         4096
+Device Size        1.00 GB (131072 blocks)
+Filesystem Size:      1.00 GB (131070 blocks)
+Journals:         2
+Resource Groups:      2
+Locking Protocol:     "lock_dlm"
+Lock Table:        "pcmk:web"
+UUID:           6B776F46-177B-BAF8-2C2B-292C0E078613
+
+[root@pcmk-1 ~]#
+</screen>
+			<para>
+				Then (re)populate the new filesystem with data (web pages). For now well create another variation on our home page.
+			</para>
+			
+<screen>
+[root@pcmk-1 ~]# <userinput>mount /dev/drbd1 /mnt/</userinput>
+[root@pcmk-1 ~]# <userinput>cat &lt;&lt;-END &gt;/mnt/index.html</userinput>
+&lt;html&gt;
+&lt;body&gt;My Test Site - GFS2&lt;/body&gt;
+&lt;/html&gt;
+END
+[root@pcmk-1 ~]# <userinput>umount /dev/drbd1</userinput>
+[root@pcmk-1 ~]# <userinput>drbdadmverifywwwdata</userinput>
+[root@pcmk-1 ~]#
+</screen>
+		</section>
+
+	</section>
 	
-<screen>configure edit ClusterIP
+	<section>
+		<title>Reconfigure the Cluster for GFS2</title>
+		
+<screen>
+[root@pcmk-1 ~]# <userinput>crm</userinput>
+crm(live)# <userinput>cib new GFS2</userinput>
+INFO: GFS2 shadow CIB created
+crm(GFS2)# <userinput>configure delete WebFS</userinput>
+crm(GFS2)# <userinput>configure primitive WebFS ocf:heartbeat:Filesystem params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype=gfs2</userinput>
 </screen>
-	<para>
-		And add the following to the params line
-	</para>
-	
-<screen>clusterip_hash="sourceip"
+		<para>
+			Now that weve recreated the resource, we also need to recreate all the constraints that used it. This is because the shell will automatically remove any constraints that referenced WebFS.
+		</para>
+		
+<screen>
+crm(GFS2)# <userinput>configure colocation WebSite-with-WebFS inf: WebSite WebFS</userinput>
+crm(GFS2)# <userinput>configure colocation fs_on_drbd inf: WebFS WebDataClone:Master</userinput>
+crm(GFS2)# <userinput>configure order WebFS-after-WebData inf: WebDataClone:promote WebFS:start</userinput>
+crm(GFS2)# <userinput>configure order WebSite-after-WebFS inf: WebFS WebSite</userinput>
+crm(GFS2)# <userinput>configure colocation WebFS-with-gfs-control INFINITY: WebFS gfs-clone</userinput>
+crm(GFS2)# <userinput>configure order start-WebFS-after-gfs-control mandatory: gfs-clone WebFS</userinput>
+crm(GFS2)# <userinput>configure show</userinput>
+node pcmk-1
+node pcmk-2
+primitive WebData ocf:linbit:drbd \
+    params drbd_resource="wwwdata" \
+    op monitor interval="60s"
+<emphasis>primitive WebFS ocf:heartbeat:Filesystem \</emphasis>
+<emphasis> params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype=gfs2</emphasis>
+primitive WebSite ocf:heartbeat:apache \
+    params configfile="/etc/httpd/conf/httpd.conf" \
+    op monitor interval="1min"
+primitive ClusterIP ocf:heartbeat:IPaddr2 \
+    params ip="192.168.122.101" cidr_netmask="32" \
+    op monitor interval="30s"
+primitive dlm ocf:pacemaker:controld \
+    op monitor interval="120s"
+primitive gfs-control ocf:pacemaker:controld \
+ params daemon=gfs_controld.pcmk args=-g 0 \
+    op monitor interval="120s"
+ms WebDataClone WebData \
+    meta master-max="1" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
+clone dlm-clone dlm \
+    meta interleave="true"
+clone gfs-clone gfs-control \
+    meta interleave="true"
+colocation WebFS-with-gfs-control inf: WebFS gfs-clone
+colocation WebSite-with-WebFS inf: WebSite WebFS
+colocation fs_on_drbd inf: WebFS WebDataClone:Master
+colocation gfs-with-dlm inf: gfs-clone dlm-clone
+colocation website-with-ip inf: WebSite ClusterIP
+order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
+order WebSite-after-WebFS inf: WebFS WebSite
+order apache-after-ip inf: ClusterIP WebSite
+order start-WebFS-after-gfs-control inf: gfs-clone WebFS
+order start-gfs-after-dlm inf: dlm-clone gfs-clone
+property $id="cib-bootstrap-options" \
+    dc-version="1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7" \
+    cluster-infrastructure="openais" \
+    expected-quorum-votes=2 \
+    stonith-enabled="false" \
+    no-quorum-policy="ignore"
+rsc_defaults $id="rsc-options" \
+    resource-stickiness=100
 </screen>
-	<para>
-		So that the complete definition looks like:
-	</para>
-	
+		<para>
+			Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
+		</para>
+		
 <screen>
+crm(GFS2)# <userinput>cib commit GFS2</userinput>
+INFO: commited 'GFS2' shadow CIB to the cluster
+crm(GFS2)# <userinput>quit</userinput>
+bye
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
+============
+Last updated: Thu Sep 3 20:49:54 2009
+Stack: openais
+Current DC: pcmk-2 - partition with quorum
+Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
+2 Nodes configured, 2 expected votes
+6 Resources configured.
+============
+
+Online: [ pcmk-1 pcmk-2 ]
+
+WebSite (ocf::heartbeat:apache):    Started pcmk-2
+Master/Slave Set: WebDataClone
+    Masters: [ pcmk-1 ]
+    Slaves: [ pcmk-2 ]
+ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-2
+Clone Set: dlm-clone
+    Started: [ pcmk-2 pcmk-1 ]
+Clone Set: gfs-clone
+    Started: [ pcmk-2 pcmk-1 ]
+<emphasis>WebFS (ocf::heartbeat:Filesystem): Started pcmk-1</emphasis>
+</screen>
+	</section>
+  <section>
+    <title>Reconfigure Pacemaker for Active/Active</title>
+    <para>
+      Almost everything is in place.
+      Recent versions of DRBD are capable of operating in Primary/Primary mode and the filesystem were using is cluster aware.
+      All we need to do now is reconfigure the cluster to take advantage of this.
+    </para>
+    <para>
+      This will involve a number of changes, so well again use interactive mode.
+    </para>
+    
+    <screen>
+[root@pcmk-1 ~]# <userinput>crm</userinput>
+[root@pcmk-1 ~]# <userinput>cib new active</userinput>
+    </screen>
+    <para>
+      Theres no point making the services active on both locations if we cant reach them, so lets first clone the IP address.
+      Cloned IPaddr2 resources use an iptables rule to ensure that each request only processed by one of the two clone instances.
+      The additional meta options tell the cluster how many instances of the clone we want (one request bucket for each node) and that if all other nodes fail, then the remaining node should hold all of them.
+      Otherwise the requests would be simply discarded.
+    </para>
+    <screen>
+[root@pcmk-1 ~]# <userinput>configure clone WebIP ClusterIP \</userinput>
+<userinput>    meta globally-unique=true clone-max=2 clone-node-max=2</userinput>
+    </screen>
+    <para>
+      Now we must tell the ClusterIP how to decide which requests are processed by which hosts.
+      To do this we must specify the clusterip_hash parameter.
+    </para>
+    <para>
+      Open the ClusterIP resource
+    </para>
+    <screen>[root@pcmk-1 ~]# <userinput>configure edit ClusterIP</userinput></screen>
+    <para>
+      And add the following to the params line
+    </para>
+    <screen>clusterip_hash="sourceip"</screen>
+    <para>
+      So that the complete definition looks like:
+    </para>
+    <screen>
 primitive ClusterIP ocf:heartbeat:IPaddr2 \ 
     params ip="192.168.122.101" cidr_netmask="32" clusterip_hash="sourceip" \
     op monitor interval="30s"
-</screen>
-	<para>
-		Here is the full transcript
-	</para>
-	
-<screen>
-[root@pcmk-1 ~]# crm 
-crm(live)# cib new active
+    </screen>
+    <para>
+      Here is the full transcript
+    </para>
+    <screen>
+[root@pcmk-1 ~]# <userinput>crm </userinput>
+crm(live)# <userinput>cib new active</userinput>
 INFO: active shadow CIB created
-crm(active)# configure clone WebIP ClusterIP \
+crm(active)# <userinput>configure clone WebIP ClusterIP \</userinput>
     meta globally-unique=true clone-max=2 clone-node-max=2
-crm(active)# configure show
+crm(active)# <userinput>configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebData ocf:linbit:drbd \
@@ -103,34 +593,30 @@ property $id="cib-bootstrap-options" \
     no-quorum-policy="ignore"
 rsc_defaults $id="rsc-options" \
     resource-stickiness=100
-</screen>
-	<para>
-		Notice how any constraints that referenced ClusterIP have been updated to use WebIP instead. This is an additional benefit of using the crm shell.
-	</para>
-	<para>
-		Next we need to convert the filesystem and Apache resources into clones. Again, the shell will automatically update any relevant constraints.
-	</para>
-	
-<screen>
-configure clone WebFSClone WebFS 
-configure clone WebSiteClone WebSite
-</screen>
-	<para>
-		The last step is to tell the cluster that it is now allowed to promote both instances to be Primary (aka. Master).
-	</para>
-	
-<screen>
-configure edit WebDataClone
-</screen>
-	<para>
-		Change master-max to 2
-	</para>
-	<!-- para>configure show</para>
-  <para>crm(active)# configure clone WebFSClone WebFS</para>
-  <para>crm(active)# configure clone WebSiteClone WebSite</para>
-  <para>crm(active)# configure edit WebDataClone</para>
-  <para>crm(active)# configure show</para -->
-<screen>
+    </screen>
+    <para>
+      Notice how any constraints that referenced ClusterIP have been updated to use WebIP instead.
+      This is an additional benefit of using the crm shell.
+    </para>
+    <para>
+      Next we need to convert the filesystem and Apache resources into clones.
+      Again, the shell will automatically update any relevant constraints.
+    </para>
+    <screen>
+crm(active)# <userinput>configure clone WebFSClone WebFS</userinput>
+crm(active)# <userinput>configure clone WebSiteClone WebSite</userinput>
+    </screen>
+    <para>
+      The last step is to tell the cluster that it is now allowed to promote both instances to be Primary (aka. Master).
+    </para>	
+    <screen>
+crm(active)# <userinput>configure edit WebDataClone</userinput>
+    </screen>
+    <para>
+      Change master-max to 2
+    </para>
+    <screen>
+crm(active)# <userinput>configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebData ocf:linbit:drbd \
@@ -177,17 +663,16 @@ property $id="cib-bootstrap-options" \
     no-quorum-policy="ignore"
 rsc_defaults $id="rsc-options" \
     resource-stickiness=100
-</screen>
-	<para>
-		Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
-	</para>
-	
-<screen>
-crm(active)# cib commit active
+    </screen>
+    <para>
+      Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
+    </para>
+    <screen>
+crm(active)# <userinput>cib commit active</userinput>
 INFO: commited 'active' shadow CIB to the cluster
-crm(active)# quit
+crm(active)# <userinput>quit</userinput>
 bye
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Thu Sep 3 21:37:27 2009
 Stack: openais
@@ -211,15 +696,16 @@ Clone Set: gfs-clone
 <emphasis> Started: [ pcmk-1 pcmk-2 ]</emphasis>
 <emphasis>Clone Set: WebSiteClone</emphasis>
 <emphasis> Started: [ pcmk-1 pcmk-2 ]</emphasis>
-</screen>
-	<section>
-		<title>Recovery</title>
-		<note>
-			<para>
-				TODO: Put one node into standby to demonstrate failover
-			</para>
-		</note>
-	</section>
-
+    </screen>
+    <section>
+      <title>Testing Recovery</title>
+      <note>
+	<para>
+	  TODO: Put one node into standby to demonstrate failover
+	</para>
+      </note>
+    </section>
+  </section>
+    
 </chapter>
 
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Ch-Active-Passive.xml
--- a/doc/Clusters_from_Scratch/en-US/Ch-Active-Passive.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Ch-Active-Passive.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -196,7 +196,7 @@ Online: [ pcmk-1 pcmk-2 ]
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# crm resource status ClusterIP
+[root@pcmk-1 ~]# <userinput>crm resource status ClusterIP</userinput>
 resource ClusterIP is running on: pcmk-1
 [root@pcmk-1 ~]#
 </screen>
@@ -205,7 +205,7 @@ resource ClusterIP is running on: pcmk-1
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# ssh pcmk-1 -- /etc/init.d/corosync stop
+[root@pcmk-1 ~]# <userinput>ssh pcmk-1 -- /etc/init.d/corosync stop</userinput>
 <emphasis>Stopping Corosync Cluster Engine (corosync): [ OK ]</emphasis>
 <emphasis>Waiting for services to unload: [ OK ]</emphasis>
 [root@pcmk-1 ~]#
@@ -215,7 +215,7 @@ resource ClusterIP is running on: pcmk-1
 		</para>
 		
 <screen>
-[root@pcmk-2 ~]# crm_mon
+[root@pcmk-2 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 15:27:35 2009
 Stack: openais
@@ -251,8 +251,8 @@ Online: [ pcmk-2 ]
 			</para>
 			
 <screen>
-[root@pcmk-1 ~]# crm configure property no-quorum-policy=ignore
-[root@pcmk-1 ~]# crm configure show 
+[root@pcmk-1 ~]# <userinput>crm configure property no-quorum-policy=ignore</userinput>
+[root@pcmk-1 ~]# <userinput>crm configure show </userinput>
 node pcmk-1
 node pcmk-2
 primitive ClusterIP ocf:heartbeat:IPaddr2 \
@@ -270,7 +270,7 @@ property $id="cib-bootstrap-options" \
 			</para>
 			
 <screen>
-[root@pcmk-2 ~]# crm_mon
+[root@pcmk-2 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 15:30:18 2009
 Stack: openais
@@ -289,9 +289,9 @@ Online: [ pcmk-2 ]
 			</para>
 			
 <screen>
-[root@pcmk-1 ~]# /etc/init.d/corosync start
+[root@pcmk-1 ~]# <userinput>/etc/init.d/corosync start</userinput>
 <emphasis>Starting Corosync Cluster Engine (corosync): [ OK ]</emphasis>      
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 15:32:13 2009
 Stack: openais
@@ -324,7 +324,7 @@ ClusterIP    (ocf::heartbeat:IPa
 			
 <screen>
 crm configure rsc_defaults resource-stickiness=100
-[root@pcmk-2 ~]# crm configure show
+[root@pcmk-2 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive ClusterIP ocf:heartbeat:IPaddr2 \
@@ -344,10 +344,10 @@ property $id="cib-bootstrap-options" \
 			</para>
 			
 <screen>
-[root@pcmk-1 ~]# ssh pcmk-1 -- /etc/init.d/corosync stop
+[root@pcmk-1 ~]# <userinput>ssh pcmk-1 -- /etc/init.d/corosync stop</userinput>
 Stopping Corosync Cluster Engine (corosync):        [ OK ]
 Waiting for services to unload:              [ OK ]
-[root@pcmk-1 ~]# ssh pcmk-2 -- crm_mon -1
+[root@pcmk-1 ~]# <userinput>ssh pcmk-2 -- crm_mon -1</userinput>
 ============
 Last updated: Fri Aug 28 15:39:38 2009
 Stack: openais
@@ -367,9 +367,9 @@ ClusterIP    (ocf::heartbeat:IPa
 			</para>
 			
 <screen>
-[root@pcmk-1 ~]# /etc/init.d/corosync start
+[root@pcmk-1 ~]# <userinput>/etc/init.d/corosync start</userinput>
 <emphasis>Starting Corosync Cluster Engine (corosync): [ OK ]</emphasis>
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 15:41:23 2009
 Stack: openais
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Ch-Apache.xml
--- a/doc/Clusters_from_Scratch/en-US/Ch-Apache.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Ch-Apache.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -17,7 +17,7 @@
 		</para>
 		
 <screen>
-[root@ppcmk-1 ~]# yum install -y httpd
+[root@ppcmk-1 ~]# <userinput>yum install -y httpd</userinput>
 Setting up Install Process
 Resolving Dependencies
 --&gt; Running transaction check
@@ -92,7 +92,7 @@ Complete!
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# yum install -y wget
+[root@pcmk-1 ~]# <userinput>yum install -y wget</userinput>
 Setting up Install Process
 Resolving Dependencies
 --&gt; Running transaction check
@@ -137,7 +137,7 @@ Complete!
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# cat &lt;&lt;-END &gt;/var/www/html/index.html
+[root@pcmk-1 ~]# <userinput>cat &lt;&lt;-END &gt;/var/www/html/index.html</userinput>
  &lt;html&gt;
  &lt;body&gt;My Test Site - pcmk-1&lt;/body&gt;
  &lt;/html&gt;
@@ -149,7 +149,7 @@ Complete!
 		</para>
 		
 <screen>
-[root@pcmk-2 ~]# cat &lt;&lt;-END &gt;/var/www/html/index.html
+[root@pcmk-2 ~]# <userinput>cat &lt;&lt;-END &gt;/var/www/html/index.html</userinput>
  &lt;html&gt;
  &lt;body&gt;My Test Site - pcmk-2&lt;/body&gt;
  &lt;/html&gt;
@@ -169,8 +169,8 @@ Complete!
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# crm configure primitive WebSite ocf:heartbeat:apache params configfile=/etc/httpd/conf/httpd.conf op monitor interval=1min
-[root@pcmk-1 ~]# crm configure show
+[root@pcmk-1 ~]# <userinput>crm configure primitive WebSite ocf:heartbeat:apache params configfile=/etc/httpd/conf/httpd.conf op monitor interval=1min</userinput>
+[root@pcmk-1 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 <emphasis>primitive WebSite ocf:heartbeat:apache \</emphasis>
@@ -193,7 +193,7 @@ rsc_defaults $id="rsc-options" \
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 16:12:49 2009
 Stack: openais
@@ -220,8 +220,8 @@ WebSite    (ocf::heartbeat:apach
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# crm configure colocation website-with-ip INFINITY: WebSite ClusterIP
-[root@pcmk-1 ~]# crm configure show
+[root@pcmk-1 ~]# <userinput>crm configure colocation website-with-ip INFINITY: WebSite ClusterIP</userinput>
+[root@pcmk-1 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebSite ocf:heartbeat:apache \
@@ -239,7 +239,7 @@ property $id="cib-bootstrap-options" \
     no-quorum-policy="ignore"
 rsc_defaults $id="rsc-options" \
     resource-stickiness="100"
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 16:14:34 2009
 Stack: openais
@@ -263,8 +263,8 @@ WebSite    (ocf::heartbeat:apach
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# crm configure order apache-after-ip mandatory: ClusterIP WebSite
-[root@pcmk-1 ~]# crm configure show
+[root@pcmk-1 ~]# <userinput>crm configure order apache-after-ip mandatory: ClusterIP WebSite</userinput>
+[root@pcmk-1 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebSite ocf:heartbeat:apache \
@@ -293,8 +293,8 @@ rsc_defaults $id="rsc-options" \
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# crm configure location prefer-pcmk-1 WebSite 50: pcmk-1
-[root@pcmk-1 ~]# crm configure show
+[root@pcmk-1 ~]# <userinput>crm configure location prefer-pcmk-1 WebSite 50: pcmk-1</userinput>
+[root@pcmk-1 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebSite ocf:heartbeat:apache \
@@ -313,7 +313,7 @@ property $id="cib-bootstrap-options" \
     no-quorum-policy="ignore"
 rsc_defaults $id="rsc-options" \
     resource-stickiness="100"
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 16:17:35 2009
 Stack: openais
@@ -357,8 +357,8 @@ WebSite    (ocf::heartbeat:apach
 		</para>
 		
 <screen>
-[root@pcmk-1 ~]# crm resource move WebSite pcmk-1
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm resource move WebSite pcmk-1</userinput>
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 16:19:24 2009
 Stack: openais
@@ -375,7 +375,7 @@ WebSite    (ocf::heartbeat:apach
 Notice how the colocation rule we created has ensured that ClusterIP was also moved to pcmk-1.
 For the curious, we can see the effect of this command by examining the configuration
 crm configure show
-[root@pcmk-1 ~]# crm configure show
+[root@pcmk-1 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebSite ocf:heartbeat:apache \
@@ -407,8 +407,8 @@ rsc_defaults $id="rsc-options" \
 			</para>
 			
 <screen>
-[root@pcmk-1 ~]# crm resource unmove WebSite
-[root@pcmk-1 ~]# crm configure show
+[root@pcmk-1 ~]# <userinput>crm resource unmove WebSite</userinput>
+[root@pcmk-1 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebSite ocf:heartbeat:apache \
@@ -433,7 +433,7 @@ rsc_defaults $id="rsc-options" \
 			</para>
 			
 <screen>
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Fri Aug 28 16:20:53 2009
 Stack: openais
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Ch-ClusterFS.xml
--- a/doc/Clusters_from_Scratch/en-US/Ch-ClusterFS.xml	Mon May 17 17:57:40 2010 +0200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,489 +0,0 @@
-<?xml version='1.0' encoding='utf-8' ?>
-<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
-<!ENTITY % BOOK_ENTITIES SYSTEM "Clusters_from_Scratch.ent">
-%BOOK_ENTITIES;
-]>
-<chapter lang="en-US">
-	<title>Cluster Filesystems - GFS2</title>
-	<section>
-		<title>Install a Cluster Filesystem - GFS2</title>
-		<para>
-			The first thing to do is install gfs2-utils on each machine.
-		</para>
-		
-<screen>
-[root@pcmk-1 ~]# yum install -y gfs2-utils gfs-pcmk
-Setting up Install Process
-Resolving Dependencies
---&gt; Running transaction check
----&gt; Package gfs-pcmk.x86_64 0:3.0.5-2.fc12 set to be updated
---&gt; Processing Dependency: libSaCkpt.so.3(OPENAIS_CKPT_B.01.01)(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
---&gt; Processing Dependency: dlm-pcmk for package: gfs-pcmk-3.0.5-2.fc12.x86_64
---&gt; Processing Dependency: libccs.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
---&gt; Processing Dependency: libdlmcontrol.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
---&gt; Processing Dependency: liblogthread.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
---&gt; Processing Dependency: libSaCkpt.so.3()(64bit) for package: gfs-pcmk-3.0.5-2.fc12.x86_64
----&gt; Package gfs2-utils.x86_64 0:3.0.5-2.fc12 set to be updated
---&gt; Running transaction check
----&gt; Package clusterlib.x86_64 0:3.0.5-2.fc12 set to be updated
----&gt; Package dlm-pcmk.x86_64 0:3.0.5-2.fc12 set to be updated
----&gt; Package openaislib.x86_64 0:1.1.0-1.fc12 set to be updated
---&gt; Finished Dependency Resolution
-
-Dependencies Resolved
-
-===========================================================================================
-Package        Arch        Version          Repository    Size
-===========================================================================================
-Installing:
-gfs-pcmk        x86_64       3.0.5-2.fc12       custom      101 k
-gfs2-utils       x86_64       3.0.5-2.fc12       custom      208 k
-Installing for dependencies:
-clusterlib       x86_64       3.0.5-2.fc12       custom      65 k
-dlm-pcmk        x86_64       3.0.5-2.fc12       custom      93 k
-openaislib       x86_64       1.1.0-1.fc12       fedora      76 k
-
-Transaction Summary
-===========================================================================================
-Install    5 Package(s)
-Upgrade    0 Package(s)
-
-Total download size: 541 k
-Downloading Packages:
-(1/5): clusterlib-3.0.5-2.fc12.x86_64.rpm                | 65 kB   00:00
-(2/5): dlm-pcmk-3.0.5-2.fc12.x86_64.rpm                 | 93 kB   00:00
-(3/5): gfs-pcmk-3.0.5-2.fc12.x86_64.rpm                 | 101 kB   00:00
-(4/5): gfs2-utils-3.0.5-2.fc12.x86_64.rpm                | 208 kB   00:00
-(5/5): openaislib-1.1.0-1.fc12.x86_64.rpm                | 76 kB   00:00
--------------------------------------------------------------------------------------------
-Total                              992 kB/s | 541 kB   00:00
-Running rpm_check_debug
-Running Transaction Test
-Finished Transaction Test
-Transaction Test Succeeded
-Running Transaction
- Installing   : clusterlib-3.0.5-2.fc12.x86_64                    1/5 
- Installing   : openaislib-1.1.0-1.fc12.x86_64                    2/5 
- Installing   : dlm-pcmk-3.0.5-2.fc12.x86_64                     3/5 
- Installing   : gfs-pcmk-3.0.5-2.fc12.x86_64                     4/5 
- Installing   : gfs2-utils-3.0.5-2.fc12.x86_64                    5/5 
-
-Installed:
- gfs-pcmk.x86_64 0:3.0.5-2.fc12          gfs2-utils.x86_64 0:3.0.5-2.fc12
-
-Dependency Installed:
- clusterlib.x86_64 0:3.0.5-2.fc12  dlm-pcmk.x86_64 0:3.0.5-2.fc12 
- openaislib.x86_64 0:1.1.0-1.fc12 
-
-Complete!
-[root@pcmk-1 x86_64]#
-</screen>
-	</section>
-	
-	<section>
-		<title>Setup Pacemaker-GFS2 Integration</title>
-		<para>
-			GFS2 needs two services to be running, the first is the user-space interface to the kernels distributed lock manager (DLM). The DLM is used to co-ordinate which node(s) can access a given file (and when) and integrates with Pacemaker to obtain node membership <footnote>
-			<para>
-				The list of nodes the cluster considers to be available
-			</para>
-			</footnote> information and fencing capabilities.
-		</para>
-		<para>
-			The second service is GFS2s own control daemon which also integrates with Pacemaker to obtain node membership data.
-		</para>
-		<section>
-			<title>Add the DLM service</title>
-			<para>
-				The DLM control daemon needs to run on all active cluster nodes, so we will use the shells interactive mode to create a cloned resource.
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# crm
-crm(live)# cib new stack-glue
-INFO: stack-glue shadow CIB created
-crm(stack-glue)# configure primitive dlm ocf:pacemaker:controld op monitor interval=120s
-crm(stack-glue)# configure clone dlm-clone dlm meta interleave=true
-crm(stack-glue)# configure show xml
-crm(stack-glue)# configure show
-node pcmk-1
-node pcmk-2
-primitive WebData ocf:linbit:drbd \
-    params drbd_resource="wwwdata" \
-    op monitor interval="60s"
-primitive WebFS ocf:heartbeat:Filesystem \
-    params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype="ext4"
-primitive WebSite ocf:heartbeat:apache \
-    params configfile="/etc/httpd/conf/httpd.conf" \
-    op monitor interval="1min"
-primitive ClusterIP ocf:heartbeat:IPaddr2 \
-    params ip="192.168.122.101" cidr_netmask="32" \
-    op monitor interval="30s"
-<emphasis>primitive dlm ocf:pacemaker:controld \</emphasis>
-<emphasis> op monitor interval="120s"</emphasis>
-ms WebDataClone WebData \
-    meta master-max="1" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
-<emphasis>clone dlm-clone dlm \</emphasis>
-<emphasis> meta interleave="true"</emphasis>
-location prefer-pcmk-1 WebSite 50: pcmk-1
-colocation WebSite-with-WebFS inf: WebSite WebFS
-colocation fs_on_drbd inf: WebFS WebDataClone:Master
-colocation website-with-ip inf: WebSite ClusterIP
-order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
-order WebSite-after-WebFS inf: WebFS WebSite
-order apache-after-ip inf: ClusterIP WebSite
-property $id="cib-bootstrap-options" \
-    dc-version="1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7" \
-    cluster-infrastructure="openais" \
-    expected-quorum-votes=2 \
-    stonith-enabled="false" \
-    no-quorum-policy="ignore"
-rsc_defaults $id="rsc-options" \
-    resource-stickiness=100
-</screen>
-			<note>
-				<para>
-					TODO: Explain the meaning of the interleave option
-				</para>
-			</note>
-			<para>
-				Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
-			</para>
-			
-<screen>
-crm(stack-glue)# cib commit stack-glue
-INFO: commited 'stack-glue' shadow CIB to the cluster
-crm(stack-glue)# quit
-bye
-[root@pcmk-1 ~]# crm_mon
-============
-Last updated: Thu Sep 3 20:49:54 2009
-Stack: openais
-Current DC: pcmk-2 - partition with quorum
-Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
-2 Nodes configured, 2 expected votes
-5 Resources configured.
-============
-
-Online: [ pcmk-1 pcmk-2 ]
-
-WebSite (ocf::heartbeat:apache):    Started pcmk-2
-Master/Slave Set: WebDataClone
-    Masters: [ pcmk-1 ]
-    Slaves: [ pcmk-2 ]
-ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-2
-<emphasis>Clone Set: dlm-clone</emphasis>
-<emphasis> Started: [ pcmk-2 pcmk-1 ]</emphasis>
-WebFS  (ocf::heartbeat:Filesystem):  Started pcmk-2
-</screen>
-		</section>
-		
-		<section>
-			<title>Add the GFS2 service</title>
-			<para>
-				Once the DLM is active, we can add the GFS2 control daemon.
-			</para>
-			<para>
-				Use the crm shell to create the gfs-control cluster resource:
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# crm
-crm(live)# cib new gfs-glue --force
-INFO: gfs-glue shadow CIB created
-crm(gfs-glue)# configure primitive gfs-control ocf:pacemaker:controld params daemon=gfs_controld.pcmk args="-g 0" op monitor interval=120s
-crm(gfs-glue)# configure clone gfs-clone gfs-control meta interleave=true
-</screen>
-			<para>
-				Now ensure Pacemaker only starts the gfs-control service on nodes that also have a copy of the dlm service (created above) already running
-			</para>
-			
-<screen>
-crm(gfs-glue)# configure colocation gfs-with-dlm INFINITY: gfs-clone dlm-clone
-crm(gfs-glue)# configure order start-gfs-after-dlm mandatory: dlm-clone gfs-clone
-</screen>
-			<para>
-				Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
-			</para>
-			
-<screen>
-crm(gfs-glue)# configure show
-node pcmk-1
-node pcmk-2
-primitive WebData ocf:linbit:drbd \
-    params drbd_resource="wwwdata" \
-    op monitor interval="60s"
-primitive WebFS ocf:heartbeat:Filesystem \
-    params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype="ext4"
-primitive WebSite ocf:heartbeat:apache \
-    params configfile="/etc/httpd/conf/httpd.conf" \
-    op monitor interval="1min"
-primitive ClusterIP ocf:heartbeat:IPaddr2 \
-    params ip="192.168.122.101" cidr_netmask="32" \
-    op monitor interval="30s"
-primitive dlm ocf:pacemaker:controld \
-    op monitor interval="120s"
-<emphasis>primitive gfs-control ocf:pacemaker:controld \</emphasis>
-<emphasis> params daemon=gfs_controld.pcmk args=-g 0 \</emphasis>
-<emphasis> op monitor interval="120s"</emphasis>
-ms WebDataClone WebData \
-    meta master-max="1" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
-clone dlm-clone dlm \
-    meta interleave="true"
-<emphasis>clone gfs-clone gfs-control \</emphasis>
-<emphasis> meta interleave="true"</emphasis>
-location prefer-pcmk-1 WebSite 50: pcmk-1
-colocation WebSite-with-WebFS inf: WebSite WebFS
-colocation fs_on_drbd inf: WebFS WebDataClone:Master
-<emphasis>colocation gfs-with-dlm inf: gfs-clone dlm-clone</emphasis>
-colocation website-with-ip inf: WebSite ClusterIP
-order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
-order WebSite-after-WebFS inf: WebFS WebSite
-order apache-after-ip inf: ClusterIP WebSite
-<emphasis>order start-gfs-after-dlm inf: dlm-clone gfs-clone</emphasis>
-property $id="cib-bootstrap-options" \
-    dc-version="1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7" \
-    cluster-infrastructure="openais" \
-    expected-quorum-votes=2 \
-    stonith-enabled="false" \
-    no-quorum-policy="ignore"
-rsc_defaults $id="rsc-options" \
-    resource-stickiness=100
-crm(gfs-glue)# cib commit gfs-glue
-INFO: commited 'gfs-glue' shadow CIB to the cluster
-crm(gfs-glue)# quit
-bye
-[root@pcmk-1 ~]# crm_mon
-============
-Last updated: Thu Sep 3 20:49:54 2009
-Stack: openais
-Current DC: pcmk-2 - partition with quorum
-Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
-2 Nodes configured, 2 expected votes
-6 Resources configured.
-============
-
-Online: [ pcmk-1 pcmk-2 ]
-
-WebSite (ocf::heartbeat:apache):    Started pcmk-2
-Master/Slave Set: WebDataClone
-    Masters: [ pcmk-1 ]
-    Slaves: [ pcmk-2 ]
-ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-2
-Clone Set: dlm-clone
-    Started: [ pcmk-2 pcmk-1 ]
-<emphasis>Clone Set: gfs-clone</emphasis>
-<emphasis> Started: [ pcmk-2 pcmk-1 ]</emphasis>
-WebFS  (ocf::heartbeat:Filesystem):  Started pcmk-1
-</screen>
-		</section>
-
-	</section>
-	
-	<section>
-		<title>Create a GFS2 Filesystem</title>
-		<section>
-			<title>Preparation</title>
-			<para>
-				Before we do anything to the existing partition, we need to make sure it is unmounted. We do this by tell the cluster to stop the WebFS resource. This will ensure that other resources (in our case, Apache) using WebFS are not only stopped, but stopped in the correct order.
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# crm_resource --resource WebFS --set-parameter target-role --meta --parameter-value Stopped
-[root@pcmk-1 ~]# crm_mon
-============
-Last updated: Thu Sep 3 15:18:06 2009
-Stack: openais
-Current DC: pcmk-1 - partition with quorum
-Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
-2 Nodes configured, 2 expected votes
-6 Resources configured.
-============
-
-Online: [ pcmk-1 pcmk-2 ]
-
-Master/Slave Set: WebDataClone
-    Masters: [ pcmk-1 ]
-    Slaves: [ pcmk-2 ]
-ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-1
-Clone Set: dlm-clone
-    Started: [ pcmk-2 pcmk-1 ]
-Clone Set: gfs-clone
-    Started: [ pcmk-2 pcmk-1 ]
-</screen>
-			<note>
-				<para>
-					Note that both Apache and WebFS have been stopped.
-				</para>
-			</note>
-		</section>
-		
-		<section>
-			<title>Create and Populate an GFS2 Partition</title>
-			<para>
-				Now that the cluster stack and integration pieces are running smoothly, we can create an GFS2 partition.
-			</para>
-			<warning>
-				<para>
-					This will erase all previous content stored on the DRBD device. Ensure you have a copy of any important data.
-				</para>
-			</warning>
-			<para>
-				We need to specify a number of additional parameters when creating a GFS2 partition.
-			</para>
-			<para>
-				First we must use the -p option to specify that we want to use the the Kernels DLM. Next we use -j to indicate that it should reserve enough space for two journals (one per node accessing the filesystem).
-			</para>
-			<para>
-				Lastly, we use -t to specify the lock table name. The format for this field is clustername:fsname. For the fsname, we just need to pick something unique and descriptive and since we havent specified a clustername yet, we will use the default (pcmk).
-			</para>
-			<para>
-				To specify an alternate name for the cluster, locate the service section containing name: pacemaker in corosync.conf and insert the following line anywhere inside the block:
-			</para>
-			<para>
-				clustername: myname
-			</para>
-			<para>
-				Do this on each node in the cluster and be sure to restart them before continuing.
-			</para>
-			
-<screen>
-mkfs.gfs2 -p lock_dlm -j 2 -t pcmk:web /dev/drbd1
-[root@pcmk-1 ~]# mkfs.gfs2 -t pcmk:web -p lock_dlm -j 2 /dev/vdb 
-This will destroy any data on /dev/vdb.
-It appears to contain: data
-
-Are you sure you want to proceed? [y/n] y
-
-Device:          /dev/vdb
-Blocksize:         4096
-Device Size        1.00 GB (131072 blocks)
-Filesystem Size:      1.00 GB (131070 blocks)
-Journals:         2
-Resource Groups:      2
-Locking Protocol:     "lock_dlm"
-Lock Table:        "pcmk:web"
-UUID:           6B776F46-177B-BAF8-2C2B-292C0E078613
-
-[root@pcmk-1 ~]#
-</screen>
-			<para>
-				Then (re)populate the new filesystem with data (web pages). For now well create another variation on our home page.
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# mount /dev/drbd1 /mnt/
-[root@pcmk-1 ~]# cat &lt;&lt;-END &gt;/mnt/index.html
-&lt;html&gt;
-&lt;body&gt;My Test Site - GFS2&lt;/body&gt;
-&lt;/html&gt;
-END
-[root@pcmk-1 ~]# umount /dev/drbd1
-[root@pcmk-1 ~]# drbdadmverifywwwdata
-[root@pcmk-1 ~]#
-</screen>
-		</section>
-
-	</section>
-	
-	<section>
-		<title>Reconfigure the Cluster for GFS2</title>
-		
-<screen>
-[root@pcmk-1 ~]# crm
-crm(live)# cib new GFS2
-INFO: GFS2 shadow CIB created
-crm(GFS2)# configure delete WebFS
-crm(GFS2)# configure primitive WebFS ocf:heartbeat:Filesystem params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype=gfs2
-</screen>
-		<para>
-			Now that weve recreated the resource, we also need to recreate all the constraints that used it. This is because the shell will automatically remove any constraints that referenced WebFS.
-		</para>
-		
-<screen>
-crm(GFS2)# configure colocation WebSite-with-WebFS inf: WebSite WebFS
-crm(GFS2)# configure colocation fs_on_drbd inf: WebFS WebDataClone:Master
-crm(GFS2)# configure order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
-crm(GFS2)# configure order WebSite-after-WebFS inf: WebFS WebSite
-crm(GFS2)# configure colocation WebFS-with-gfs-control INFINITY: WebFS gfs-clone
-crm(GFS2)# configure order start-WebFS-after-gfs-control mandatory: gfs-clone WebFS
-crm(GFS2)# configure show
-node pcmk-1
-node pcmk-2
-primitive WebData ocf:linbit:drbd \
-    params drbd_resource="wwwdata" \
-    op monitor interval="60s"
-<emphasis>primitive WebFS ocf:heartbeat:Filesystem \</emphasis>
-<emphasis> params device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" fstype=gfs2</emphasis>
-primitive WebSite ocf:heartbeat:apache \
-    params configfile="/etc/httpd/conf/httpd.conf" \
-    op monitor interval="1min"
-primitive ClusterIP ocf:heartbeat:IPaddr2 \
-    params ip="192.168.122.101" cidr_netmask="32" \
-    op monitor interval="30s"
-primitive dlm ocf:pacemaker:controld \
-    op monitor interval="120s"
-primitive gfs-control ocf:pacemaker:controld \
- params daemon=gfs_controld.pcmk args=-g 0 \
-    op monitor interval="120s"
-ms WebDataClone WebData \
-    meta master-max="1" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
-clone dlm-clone dlm \
-    meta interleave="true"
-clone gfs-clone gfs-control \
-    meta interleave="true"
-colocation WebFS-with-gfs-control inf: WebFS gfs-clone
-colocation WebSite-with-WebFS inf: WebSite WebFS
-colocation fs_on_drbd inf: WebFS WebDataClone:Master
-colocation gfs-with-dlm inf: gfs-clone dlm-clone
-colocation website-with-ip inf: WebSite ClusterIP
-order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
-order WebSite-after-WebFS inf: WebFS WebSite
-order apache-after-ip inf: ClusterIP WebSite
-order start-WebFS-after-gfs-control inf: gfs-clone WebFS
-order start-gfs-after-dlm inf: dlm-clone gfs-clone
-property $id="cib-bootstrap-options" \
-    dc-version="1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7" \
-    cluster-infrastructure="openais" \
-    expected-quorum-votes=2 \
-    stonith-enabled="false" \
-    no-quorum-policy="ignore"
-rsc_defaults $id="rsc-options" \
-    resource-stickiness=100
-</screen>
-		<para>
-			Review the configuration before uploading it to the cluster, quitting the shell and watching the clusters response
-		</para>
-		
-<screen>
-crm(GFS2)# cib commit GFS2
-INFO: commited 'GFS2' shadow CIB to the cluster
-crm(GFS2)# quit
-bye
-[root@pcmk-1 ~]# crm_mon
-============
-Last updated: Thu Sep 3 20:49:54 2009
-Stack: openais
-Current DC: pcmk-2 - partition with quorum
-Version: 1.0.5-462f1569a43740667daf7b0f6b521742e9eb8fa7
-2 Nodes configured, 2 expected votes
-6 Resources configured.
-============
-
-Online: [ pcmk-1 pcmk-2 ]
-
-WebSite (ocf::heartbeat:apache):    Started pcmk-2
-Master/Slave Set: WebDataClone
-    Masters: [ pcmk-1 ]
-    Slaves: [ pcmk-2 ]
-ClusterIP    (ocf::heartbeat:IPaddr):    Started pcmk-2
-Clone Set: dlm-clone
-    Started: [ pcmk-2 pcmk-1 ]
-Clone Set: gfs-clone
-    Started: [ pcmk-2 pcmk-1 ]
-<emphasis>WebFS (ocf::heartbeat:Filesystem): Started pcmk-1</emphasis>
-</screen>
-	</section>
-
-</chapter>
-
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Ch-Installation.xml
--- a/doc/Clusters_from_Scratch/en-US/Ch-Installation.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Ch-Installation.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -9,7 +9,8 @@
     <title>OS Installation</title>
     <para>
       Detailed instructions for installing Fedora are available at
-      <ulink url="http://docs.fedoraproject.org/install-guide/f12/">http://docs.fedoraproject.org/install-guide/f12/</ulink>
+      <!-- Can't use DISTRO_VERSION in the actual URLs, it expands to nothing there fro some reason -->
+      <ulink url="http://docs.fedoraproject.org/install-guide/f13/">http://docs.fedoraproject.org/install-guide/f&DISTRO_VERSION;/</ulink>
       in a number of languages.
       The abbreviated version is as follows...
     </para>
@@ -31,8 +32,8 @@
       After clicking through the welcome screen, select your language and keyboard layout 
       <footnote>
 	<para>
-	  <ulink url="http://docs.fedoraproject.org/install-guide/f12/en-US/html/s1-langselection-x86.html">
-	    http://docs.fedoraproject.org/install-guide/f12/en-US/html/s1-langselection-x86.html
+	  <ulink url="http://docs.fedoraproject.org/install-guide/f13/en-US/html/s1-langselection-x86.html">
+	    http://docs.fedoraproject.org/install-guide/f&DISTRO_VERSION;/en-US/html/s1-langselection-x86.html
 	  </ulink>
 	</para>
       </footnote>
@@ -63,8 +64,8 @@
       Assign your machine a host name. 
       <footnote>
 	<para>
-	  <ulink url="http://docs.fedoraproject.org/install-guide/f12/en-US/html/sn-networkconfig-fedora.html">
-	    http://docs.fedoraproject.org/install-guide/f12/en-US/html/sn-networkconfig-fedora.html
+	  <ulink url="http://docs.fedoraproject.org/install-guide/f13/en-US/html/sn-networkconfig-fedora.html">
+	    http://docs.fedoraproject.org/install-guide/f&DISTRO_VERSION;/en-US/html/sn-networkconfig-fedora.html
 	  </ulink>
 	</para>
       </footnote>
@@ -83,8 +84,8 @@
       You will then be prompted to indicate the machines physical location and to supply a root password.
       <footnote>
 	<para>
-	  <ulink url="http://docs.fedoraproject.org/install-guide/f12/en-US/html/sn-account_configuration.html">
-	    http://docs.fedoraproject.org/install-guide/f12/en-US/html/sn-account_configuration.html
+	  <ulink url="http://docs.fedoraproject.org/install-guide/f13/en-US/html/sn-account_configuration.html">
+	    http://docs.fedoraproject.org/install-guide/f&DISTRO_VERSION;/en-US/html/sn-account_configuration.html
 	  </ulink>
 	</para>
       </footnote>
@@ -93,7 +94,7 @@
       Now select where you want Fedora installed.
       <footnote>
 	<para>
-	  <ulink url="http://docs.fedoraproject.org/install-guide/f12/en-US/html/s1-diskpartsetup-x86.html">http://docs.fedoraproject.org/install-guide/f12/en-US/html/s1-diskpartsetup-x86.html</ulink>
+	  <ulink url="http://docs.fedoraproject.org/install-guide/f13/en-US/html/s1-diskpartsetup-x86.html">http://docs.fedoraproject.org/install-guide/f13/en-US/html/s1-diskpartsetup-x86.html</ulink>
 	</para>
       </footnote>
       As I dont care about any existing data, I will accept the default and allow Fedora to use the complete drive.
@@ -189,8 +190,8 @@
       Once the node reboots, follow the on screen instructions 
       <footnote>
 	<para>
-	  <ulink url="http://docs.fedoraproject.org/install-guide/f12/en-US/html/ch-firstboot.html">
-	    http://docs.fedoraproject.org/install-guide/f12/en-US/html/ch-firstboot.html
+	  <ulink url="http://docs.fedoraproject.org/install-guide/f13/en-US/html/ch-firstboot.html">
+	    http://docs.fedoraproject.org/install-guide/f&DISTRO_VERSION;/en-US/html/ch-firstboot.html
 	  </ulink>
 	</para>
       </footnote> 
@@ -374,7 +375,6 @@ May  4 19:30:54 pcmk-1 setroubleshoot: S
 [root@pcmk-1 ~]# <userinput>sed -i.bak "s/enabled=0/enabled=1/g" /etc/yum.repos.d/fedora.repo</userinput>
 [root@pcmk-1 ~]# <userinput>sed -i.bak "s/enabled=0/enabled=1/g" /etc/yum.repos.d/fedora-updates.repo</userinput>
 [root@pcmk-1 ~]# <userinput>yum install -y pacemaker corosync</userinput>
-[root@pcmk-1 ~]# yum install -y pacemaker corosync
 Loaded plugins: presto, refresh-packagekit
 fedora/metalink                   	                           |  22 kB     00:00     
 fedora-debuginfo/metalink         	                           |  16 kB     00:00     
@@ -739,9 +739,9 @@ pcmk-2
 	See for yourself how the machine identifies itself:
       </para>
       <screen>
-[root@pcmk-1 ~]# uname -n
+[root@pcmk-1 ~]# <userinput>uname -n</userinput>
 pcmk-1<emphasis>.clusterlabs.org</emphasis>
-[root@pcmk-1 ~]# dnsdomainname 
+[root@pcmk-1 ~]# <userinput>dnsdomainname </userinput>
 clusterlabs.org
       </screen>
       <para>
@@ -749,7 +749,7 @@ clusterlabs.org
 	To address this, we need to update /etc/sysconfig/network. This is what it should look like before we start.
       </para>		
       <screen>
-cat /etc/sysconfig/network
+[root@pcmk-1 ~]# <userinput>cat /etc/sysconfig/network</userinput>
 NETWORKING=yes
 <emphasis>HOSTNAME=pcmk-1.clusterlabs.org</emphasis>
 GATEWAY=192.168.122.1
@@ -758,13 +758,13 @@ GATEWAY=192.168.122.1
 	All we need to do now is strip off the domain name portion, which is stored elsewhere anyway.
       </para>
       
-      <screen>sed -i.bak 's/\.[a-z].*//g' /etc/sysconfig/network</screen>
+      <screen>[root@pcmk-1 ~]# <userinput>sed -i.bak 's/\.[a-z].*//g' /etc/sysconfig/network</userinput></screen>
       <para>
 	Now confirm the change was successful.
 	The revised file contents should look something like this.
       </para>
       <screen>
-[root@pcmk-1 ~]# cat /etc/sysconfig/network
+[root@pcmk-1 ~]# <userinput>cat /etc/sysconfig/network</userinput>
 NETWORKING=yes
 <emphasis>HOSTNAME=pcmk-1</emphasis>
 GATEWAY=192.168.122.1
@@ -774,16 +774,16 @@ GATEWAY=192.168.122.1
 	The machine wont normally see the shortened host name until about it reboots, but we can force it to update.
       </para>
       <screen>
-[root@pcmk-1 ~]# source /etc/sysconfig/network
-[root@pcmk-1 ~]# hostname $HOSTNAME
+[root@pcmk-1 ~]# <userinput>source /etc/sysconfig/network</userinput>
+[root@pcmk-1 ~]# <userinput>hostname $HOSTNAME</userinput>
       </screen>
       <para>
 	Now check the machine is using the correct names
       </para>
       <screen>
-[root@pcmk-1 ~]# uname -n
+[root@pcmk-1 ~]# <userinput>uname -n</userinput>
 pcmk-1
-[root@pcmk-1 ~]# dnsdomainname 
+[root@pcmk-1 ~]# <userinput>dnsdomainname </userinput>
 clusterlabs.org
       </screen>
       <para>
@@ -815,19 +815,19 @@ clusterlabs.org
 	For this document, I have chosen port 4000 and used 226.94.1.1 as the multi-cast address.
       </para>
       <screen>
-<userinput>export ais_port=4000</userinput>
-<userinput>export ais_mcast=226.94.1.1</userinput>
+[root@pcmk-1 ~]# <userinput>export ais_port=4000</userinput>
+[root@pcmk-1 ~]# <userinput>export ais_mcast=226.94.1.1</userinput>
       </screen>
       <para>
 	Next we automatically determine the hosts address.
 	By not using the full address, we make the configuration suitable to be copied to other nodes.
       </para>
-      <screen>export ais_addr=`ip addr | grep "inet " | tail -n 1 | awk '{print $4}' | sed s/255/0/`</screen>
+      <screen>[root@pcmk-1 ~]# <userinput>export ais_addr=`ip addr | grep "inet " | tail -n 1 | awk '{print $4}' | sed s/255/0/`</userinput></screen>
       <para>
 	Display and verify the configuration options
       </para>
       <screen>
-[root@pcmk-1 ~]# env | grep ais_
+[root@pcmk-1 ~]# <userinput>env | grep ais_</userinput>
 ais_mcast=226.94.1.1
 ais_port=4000
 ais_addr=192.168.122.0
@@ -836,16 +836,16 @@ ais_addr=192.168.122.0
 	Once youre happy with the chosen values, update the Corosync configuration
       </para>
       <screen>
-cp /etc/corosync/corosync.conf.example  /etc/corosync/corosync.conf
-sed -i.bak "s/.*mcastaddr:.*/mcastaddr:\ $ais_mcast/g" /etc/corosync/corosync.conf
-sed -i.bak "s/.*mcastport:.*/mcastport:\ $ais_port/g" /etc/corosync/corosync.conf
-sed -i.bak "s/.*bindnetaddr:.*/bindnetaddr:\ $ais_addr/g" /etc/corosync/corosync.conf
+[root@pcmk-1 ~]# <userinput>cp /etc/corosync/corosync.conf.example  /etc/corosync/corosync.conf</userinput>
+[root@pcmk-1 ~]# <userinput>sed -i.bak "s/.*mcastaddr:.*/mcastaddr:\ $ais_mcast/g" /etc/corosync/corosync.conf</userinput>
+[root@pcmk-1 ~]# <userinput>sed -i.bak "s/.*mcastport:.*/mcastport:\ $ais_port/g" /etc/corosync/corosync.conf</userinput>
+[root@pcmk-1 ~]# <userinput>sed -i.bak "s/.*bindnetaddr:.*/bindnetaddr:\ $ais_addr/g" /etc/corosync/corosync.conf</userinput>
       </screen>
       <para>
 	Finally, tell Corosync to start Pacemaker
       </para>
       <screen>
-cat &lt;&lt;-END &gt;&gt;/etc/corosync/service.d/pcmk
+[root@pcmk-1 ~]# <userinput>cat &lt;&lt;-END &gt;&gt;/etc/corosync/service.d/pcmk</userinput>
 service {
         # Load the Pacemaker Cluster Resource Manager
         name: pacemaker
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Ch-Shared-Storage.xml
--- a/doc/Clusters_from_Scratch/en-US/Ch-Shared-Storage.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Ch-Shared-Storage.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -4,614 +4,130 @@
 %BOOK_ENTITIES;
 ]>
 <chapter lang="en-US">
-	<title>Shared Storage with DRBD</title>
-	<para>
-		Even if youre serving up static websites, having to manually synchronize the contents of that website to all the machines in the cluster is not ideal. For dynamic websites, such as a wiki, its not even an option. Not everyone care afford network-attached storage but somehow the data needs to be kept in sync. Enter DRBD which can be thought of as network based RAID-1. See <ulink url="http://www.drbd.org/">http://www.drbd.org</ulink>/ for more details.
-	</para>
-	<para>
-	</para>
-	<section>
-		<title>Install Pre-requisites</title>
-		<para>
-			DRBD does not currently ship with Fedora 12 and since there is a kernel component, can be sensitive to system updates which may change the kernels APIs and ABIs. For this reason well simply build our own DRBD packages - to be sure they are a perfect match for the machine.
-		</para>
-		<para>
-			First we need to install a few packages that DRBD needs:
-		</para>
-		
-<screen>
-[root@pcmk-1 ~]# yum install -y flex gcc glibc-devel kernel-headers kernel-devel rpm-build
+  <title>Replicated Storage with DRBD</title>
+  <para>
+    Even if youre serving up static websites, having to manually synchronize the contents of that website to all the machines in the cluster is not ideal.
+    For dynamic websites, such as a wiki, its not even an option.
+    Not everyone care afford network-attached storage but somehow the data needs to be kept in sync.
+    Enter DRBD which can be thought of as network based RAID-1.
+    See <ulink url="http://www.drbd.org/">http://www.drbd.org</ulink>/ for more details.
+  </para>
+  <para>
+  </para>
+  <section>
+    <title>Install the DRBD Packages</title>
+    <para>
+      Since its inclusion in the upstream 2.6.33 kernel, everything needed to use DRBD ships with &DISTRO; &DISTRO_VERSION;.
+      All you need to do is install it:
+    </para>
+    <screen>
+[root@pcmk-1 ~]# <userinput>yum install -y drbd-pacemaker</userinput>
+Loaded plugins: presto, refresh-packagekit
 Setting up Install Process
 Resolving Dependencies
---&gt; Running transaction check
----&gt; Package flex.x86_64 0:2.5.35-7.fc12 set to be updated
----&gt; Package gcc.x86_64 0:4.4.2-7.fc12 set to be updated
---&gt; Processing Dependency: libgomp = 4.4.2-7.fc12 for package: gcc-4.4.2-7.fc12.x86_64
---&gt; Processing Dependency: cpp = 4.4.2-7.fc12 for package: gcc-4.4.2-7.fc12.x86_64
---&gt; Processing Dependency: cloog-ppl &gt;= 0.15 for package: gcc-4.4.2-7.fc12.x86_64
---&gt; Processing Dependency: libgomp.so.1()(64bit) for package: gcc-4.4.2-7.fc12.x86_64
----&gt; Package glibc-devel.x86_64 0:2.11-2 set to be updated
---&gt; Processing Dependency: glibc-headers = 2.11-2 for package: glibc-devel-2.11-2.x86_64
---&gt; Processing Dependency: glibc-headers for package: glibc-devel-2.11-2.x86_64
----&gt; Package kernel-devel.x86_64 0:2.6.31.6-162.fc12 set to be installed
----&gt; Package kernel-headers.x86_64 0:2.6.31.6-162.fc12 set to be updated
----&gt; Package rpm-build.x86_64 0:4.7.1-6.fc12 set to be updated
---&gt; Processing Dependency: patch &gt;= 2.5 for package: rpm-build-4.7.1-6.fc12.x86_64
---&gt; Processing Dependency: elfutils &gt;= 0.128 for package: rpm-build-4.7.1-6.fc12.x86_64
---&gt; Processing Dependency: pkgconfig for package: rpm-build-4.7.1-6.fc12.x86_64
---&gt; Processing Dependency: unzip for package: rpm-build-4.7.1-6.fc12.x86_64
---&gt; Running transaction check
----&gt; Package cloog-ppl.x86_64 0:0.15.7-1.fc12 set to be updated
---&gt; Processing Dependency: libppl.so.7()(64bit) for package: cloog-ppl-0.15.7-1.fc12.x86_64
---&gt; Processing Dependency: libgmpxx.so.4()(64bit) for package: cloog-ppl-0.15.7-1.fc12.x86_64
---&gt; Processing Dependency: libppl_c.so.2()(64bit) for package: cloog-ppl-0.15.7-1.fc12.x86_64
---&gt; Processing Dependency: libgmp.so.3()(64bit) for package: cloog-ppl-0.15.7-1.fc12.x86_64
----&gt; Package cpp.x86_64 0:4.4.2-7.fc12 set to be updated
---&gt; Processing Dependency: libmpfr.so.1()(64bit) for package: cpp-4.4.2-7.fc12.x86_64
----&gt; Package elfutils.x86_64 0:0.143-1.fc12 set to be updated
---&gt; Processing Dependency: elfutils-libs-x86_64 = 0.143-1.fc12 for package: elfutils-0.143-1.fc12.x86_64
---&gt; Processing Dependency: libdw.so.1(ELFUTILS_0.127)(64bit) for package: elfutils-0.143-1.fc12.x86_64
---&gt; Processing Dependency: libasm.so.1(ELFUTILS_1.0)(64bit) for package: elfutils-0.143-1.fc12.x86_64
---&gt; Processing Dependency: libdw.so.1(ELFUTILS_0.126)(64bit) for package: elfutils-0.143-1.fc12.x86_64
---&gt; Processing Dependency: libdw.so.1(ELFUTILS_0.138)(64bit) for package: elfutils-0.143-1.fc12.x86_64
---&gt; Processing Dependency: libdw.so.1(ELFUTILS_0.122)(64bit) for package: elfutils-0.143-1.fc12.x86_64
---&gt; Processing Dependency: libdw.so.1()(64bit) for package: elfutils-0.143-1.fc12.x86_64
---&gt; Processing Dependency: libasm.so.1()(64bit) for package: elfutils-0.143-1.fc12.x86_64
----&gt; Package glibc-headers.x86_64 0:2.11-2 set to be updated
----&gt; Package libgomp.x86_64 0:4.4.2-7.fc12 set to be updated
----&gt; Package patch.x86_64 0:2.6-1.fc12 set to be updated
----&gt; Package pkgconfig.x86_64 1:0.23-9.fc12 set to be updated
----&gt; Package unzip.x86_64 0:5.52-11.fc12 set to be updated
---&gt; Running transaction check
----&gt; Package elfutils-libs.x86_64 0:0.143-1.fc12 set to be updated
----&gt; Package gmp.x86_64 0:4.3.1-5.fc12 set to be updated
----&gt; Package mpfr.x86_64 0:2.4.1-3.fc12 set to be updated
----&gt; Package ppl.x86_64 0:0.10.2-10.fc12 set to be updated
---&gt; Finished Dependency Resolution
+--> Running transaction check
+---> Package drbd-pacemaker.x86_64 0:8.3.7-2.fc13 set to be updated
+--> Processing Dependency: drbd-utils = 8.3.7-2.fc13 for package: drbd-pacemaker-8.3.7-2.fc13.x86_64
+--> Running transaction check
+---> Package drbd-utils.x86_64 0:8.3.7-2.fc13 set to be updated
+--> Finished Dependency Resolution
 
 Dependencies Resolved
 
-==========================================================================================
-Package         Arch      Version           Repository   Size
-==========================================================================================
+=================================================================================
+ Package                Arch           Version              Repository      Size
+=================================================================================
 Installing:
-flex           x86_64     2.5.35-7.fc12        fedora     274 k
-gcc           x86_64     4.4.2-7.fc12        fedora      10 M
-glibc-devel      x86_64     2.11-2           fedora     951 k
-kernel-devel       x86_64     2.6.31.6-162.fc12      updates     6.0 M
-kernel-headers      x86_64     2.6.31.6-162.fc12      updates     743 k
-rpm-build       x86_64     4.7.1-6.fc12        fedora     112 k
+ drbd-pacemaker         x86_64         8.3.7-2.fc13         fedora          19 k
 Installing for dependencies:
-cloog-ppl       x86_64     0.15.7-1.fc12       fedora      82 k
-cpp          x86_64     4.4.2-7.fc12         fedora     3.7 M
-elfutils         x86_64     0.143-1.fc12         fedora     177 k
-elfutils-libs     x86_64     0.143-1.fc12         fedora     162 k
-glibc-headers     x86_64     2.11-2            fedora     580 k
-gmp          x86_64     4.3.1-5.fc12         fedora     198 k
-libgomp        x86_64     4.4.2-7.fc12         fedora      90 k
-mpfr           x86_64     2.4.1-3.fc12         fedora     149 k
-patch         x86_64     2.6-1.fc12          updates     79 k
-pkgconfig       x86_64     1:0.23-9.fc12       fedora      68 k
-ppl          x86_64     0.10.2-10.fc12       fedora     1.1 M
-unzip         x86_64     5.52-11.fc12        fedora     125 k
+ drbd-utils             x86_64         8.3.7-2.fc13         fedora         165 k
 
 Transaction Summary
-==========================================================================================
-Install   18 Package(s)
-Upgrade    0 Package(s)
+=================================================================================
+Install       2 Package(s)
+Upgrade       0 Package(s)
 
-Total download size: 24 M
+Total download size: 184 k
+Installed size: 427 k
 Downloading Packages:
-(1/18): cloog-ppl-0.15.7-1.fc12.x86_64.rpm               | 82 kB   00:00
-(2/18): cpp-4.4.2-7.fc12.x86_64.rpm                  | 3.7 MB   00:02
-(3/18): elfutils-0.143-1.fc12.x86_64.rpm                | 177 kB   00:00
-(4/18): elfutils-libs-0.143-1.fc12.x86_64.rpm             | 162 kB   00:00
-(5/18): flex-2.5.35-7.fc12.x86_64.rpm                 | 274 kB   00:00
-(6/18): gcc-4.4.2-7.fc12.x86_64.rpm                  | 10 MB   00:06
-(7/18): glibc-devel-2.11-2.x86_64.rpm                 | 951 kB   00:00
-(8/18): glibc-headers-2.11-2.x86_64.rpm                | 580 kB   00:00
-(9/18): gmp-4.3.1-5.fc12.x86_64.rpm                  | 198 kB   00:00
-(10/18): kernel-devel-2.6.31.6-162.fc12.x86_64.rpm           | 6.0 MB   00:22
-(11/18): kernel-headers-2.6.31.6-162.fc12.x86_64.rpm          | 743 kB   00:01
-(12/18): libgomp-4.4.2-7.fc12.x86_64.rpm                | 90 kB   00:00
-(13/18): mpfr-2.4.1-3.fc12.x86_64.rpm                 | 149 kB   00:00
-(14/18): patch-2.6-1.fc12.x86_64.rpm                  | 79 kB   00:00
-(15/18): pkgconfig-0.23-9.fc12.x86_64.rpm               | 68 kB   00:00
-(16/18): ppl-0.10.2-10.fc12.x86_64.rpm                 | 1.1 MB   00:00
-(17/18): rpm-build-4.7.1-6.fc12.x86_64.rpm               | 112 kB   00:00
-(18/18): unzip-5.52-11.fc12.x86_64.rpm                 | 125 kB   00:00
-------------------------------------------------------------------------------------------
-Total                             662 kB/s | 24 MB   00:37
+Setting up and reading Presto delta metadata
+fedora/prestodelta                                        | 1.7 kB     00:00     
+Processing delta metadata
+Package(s) data still to download: 184 k
+(1/2): drbd-pacemaker-8.3.7-2.fc13.x86_64.rpm             |  19 kB     00:01     
+(2/2): drbd-utils-8.3.7-2.fc13.x86_64.rpm                 | 165 kB     00:02     
+---------------------------------------------------------------------------------
+Total                                             45 kB/s | 184 kB     00:04     
 Running rpm_check_debug
 Running Transaction Test
-Finished Transaction Test
 Transaction Test Succeeded
 Running Transaction
- Installing   : gmp-4.3.1-5.fc12.x86_64                      1/18 
- Installing   : mpfr-2.4.1-3.fc12.x86_64                     2/18 
- Installing   : cpp-4.4.2-7.fc12.x86_64                      3/18 
- Installing   : ppl-0.10.2-10.fc12.x86_64                     4/18 
- Installing   : cloog-ppl-0.15.7-1.fc12.x86_64                  5/18 
- Installing   : 1:pkgconfig-0.23-9.fc12.x86_64                  6/18 
- Installing   : libgomp-4.4.2-7.fc12.x86_64                    7/18 
- Installing   : elfutils-libs-0.143-1.fc12.x86_64                 8/18 
- Installing   : elfutils-0.143-1.fc12.x86_64                   9/18 
- Installing   : patch-2.6-1.fc12.x86_64                     10/18 
- Installing   : unzip-5.52-11.fc12.x86_64                    11/18 
- Installing   : kernel-headers-2.6.31.6-162.fc12.x86_64             12/18 
- Installing   : rpm-build-4.7.1-6.fc12.x86_64                  13/18 
- Installing   : flex-2.5.35-7.fc12.x86_64                    14/18 
- Installing   : glibc-headers-2.11-2.x86_64                   15/18 
- Installing   : glibc-devel-2.11-2.x86_64                    16/18 
- Installing   : gcc-4.4.2-7.fc12.x86_64                     17/18 
- Installing   : kernel-devel-2.6.31.6-162.fc12.x86_64              18/18 
+  Installing     : drbd-utils-8.3.7-2.fc13.x86_64                            1/2 
+  Installing     : drbd-pacemaker-8.3.7-2.fc13.x86_64                        2/2 
 
 Installed:
- flex.x86_64 0:2.5.35-7.fc12           gcc.x86_64 0:4.4.2-7.fc12
- glibc-devel.x86_64 0:2.11-2           kernel-devel.x86_64 0:2.6.31.6-162.fc12
- kernel-headers.x86_64 0:2.6.31.6-162.fc12    rpm-build.x86_64 0:4.7.1-6.fc12
+  drbd-pacemaker.x86_64 0:8.3.7-2.fc13                                           
 
 Dependency Installed:
- cloog-ppl.x86_64 0:0.15.7-1.fc12   cpp.x86_64 0:4.4.2-7.fc12   
- elfutils.x86_64 0:0.143-1.fc12    elfutils-libs.x86_64 0:0.143-1.fc12
- glibc-headers.x86_64 0:2.11-2     gmp.x86_64 0:4.3.1-5.fc12
- libgomp.x86_64 0:4.4.2-7.fc12     mpfr.x86_64 0:2.4.1-3.fc12  
- patch.x86_64 0:2.6-1.fc12       pkgconfig.x86_64 1:0.23-9.fc12   
- ppl.x86_64 0:0.10.2-10.fc12      unzip.x86_64 0:5.52-11.fc12
+  drbd-utils.x86_64 0:8.3.7-2.fc13                                               
 
 Complete!
 [root@pcmk-1 ~]#
-</screen>
-	</section>
-	
-	<section>
-		<title>Build DRBD Packages</title>
-		<para>
-			Once the development packages are installed, we can begin building DRBD.<footnote>
-			<para>
-				At the time of writing, the latest version was 8.3.6. If a later version is now available it would be advisable to try that first.
-			</para>
-			</footnote>
-		</para>
-		
-<screen>
-[root@pcmk-1 ~]# wget <ulink url="http://oss.linbit.com/drbd/8.3/drbd-8.3.6.tar.gz">http://oss.linbit.com/drbd/8.3/drbd-8.3.6.tar.gz</ulink>
---2009-12-08 11:04:36-- <ulink url="http://oss.linbit.com/drbd/8.3/drbd-8.3.6.tar.gz">http://oss.linbit.com/drbd/8.3/drbd-8.3.6.tar.gz</ulink>
-Resolving oss.linbit.com... 212.69.161.111
-Connecting to oss.linbit.com|212.69.161.111|:80... connected.
-HTTP request sent, awaiting response... 200 OK
-Length: 457469 (447K) [application/x-gzip]
-Saving to: drbd-8.3.6.tar.gz
-
-100%[==============================================================&gt;] 457,469   1.12M/s  in 0.4s  
-
-2009-12-08 11:04:37 (1.12 MB/s) - drbd-8.3.6.tar.gz saved [457469/457469]
-
-[root@pcmk-1 ~]# tar zxf drbd-8.3.6.tar.gz 
-[root@pcmk-1 ~]# cd drbd-8.3.6
-[root@pcmk-1 drbd-8.3.6]# make rpm
-make: *** No rule to make target `rpm'. Stop.
-[root@pcmk-1 drbd-8.3.6]# ./configure --with-km --enable-spec
-checking for gcc... gcc
-checking for C compiler default output file name... a.out
-checking whether the C compiler works... yes
-checking whether we are cross compiling... no
-checking for suffix of executables... 
-checking for suffix of object files... o
-checking whether we are using the GNU C compiler... yes
-checking whether gcc accepts -g... yes
-checking for gcc option to accept ISO C89... none needed
-checking whether ln -s works... yes
-checking for sed... /bin/sed
-checking for grep... /bin/grep
-checking for flex... /usr/bin/flex
-checking for rpmbuild... /usr/bin/rpmbuild
-checking for xsltproc... /usr/bin/xsltproc
-checking for tar... /bin/tar
-checking for git... no
-checking for dpkg-buildpackage... no
-checking for udevadm... /sbin/udevadm
-checking for udevinfo... /usr/bin/udevinfo
-configure: WARNING: No dpkg-buildpackage found, building Debian packages is disabled.
-configure: WARNING: Cannot update buildtag without git. You may safely ignore this warning when building from a tarball.
-checking for /Makefile... no
-configure: WARNING: Unable to find a kernel Makefile in . You will have to set KDIR correctly when invoking make.
-checking for /etc/gentoo-release... no
-checking for /etc/redhat-release... yes
-checking for /etc/slackware-version... no
-checking for /etc/debian_version... no
-checking for /etc/SuSErelease... no
-configure: configured for Red Hat (includes Fedora, RHEL, CentOS).
-configure: creating ./config.status
-config.status: creating drbd.spec
-config.status: creating drbd-km.spec
-</screen>
-		<para>
-			The following build log is quite long and is only included for reference in case it does not work on your machine. Most people can skip to the end.
-		</para>
-		
-<screen>
-[root@pcmk-1 drbd-8.3.6]# rpmbuild -ba --define "_sourcedir `pwd`/.." drbd-km.spec 
-Executing(%prep): /bin/sh -e /var/tmp/rpm-tmp.Q7iVhB
-+ umask 022
-+ cd /root/rpmbuild/BUILD
-+ cd /root/rpmbuild/BUILD
-+ rm -rf drbd-8.3.6
-+ /usr/bin/gzip -dc /root/drbd-8.3.6.tar.gz
-+ /bin/tar -xf -
-+ STATUS=0
-+ '[' 0 -ne 0 ']'
-+ cd drbd-8.3.6
-+ /bin/chmod -Rf a+rX,u+w,g-w,o-w .
-+ test -d /lib/modules/2.6.31.6-162.fc12.x86_64/build/.
-++ KDIR=/lib/modules/2.6.31.6-162.fc12.x86_64/build
-++ scripts/get_uts_release.sh
-+ test 2.6.31.6-162.fc12.x86_64 = 2.6.31.6-162.fc12.x86_64
-+ exit 0
-Executing(%build): /bin/sh -e /var/tmp/rpm-tmp.08bAH0
-+ umask 022
-+ cd /root/rpmbuild/BUILD
-+ cd drbd-8.3.6
-+ CFLAGS='-O2 -g'
-+ export CFLAGS
-+ CXXFLAGS='-O2 -g'
-+ export CXXFLAGS
-+ FFLAGS='-O2 -g'
-+ export FFLAGS
-+ ./configure --host=x86_64-unknown-linux-gnu --build=x86_64-unknown-linux-gnu    \
- --target=x86_64-redhat-linux --program-prefix= --prefix=/usr --exec-prefix=/usr  \
- --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --datadir=/usr/share     \
-  --includedir=/usr/include --libdir=/usr/lib64 --libexecdir=/usr/libexec         \
- --localstatedir=/var --sharedstatedir=/var/lib --mandir=/usr/share/man           \
- --infodir=/usr/share/info --without-utils --with-km --without-udev --without-xen \
- --without-pacemaker --without-heartbeat --without-rgmanager --without-bashcompletion
-checking for x86_64-unknown-linux-gnu-gcc... no
-checking for gcc... gcc
-checking for C compiler default output file name... a.out
-checking whether the C compiler works... yes
-checking whether we are cross compiling... no
-checking for suffix of executables... 
-checking for suffix of object files... o
-checking whether we are using the GNU C compiler... yes
-checking whether gcc accepts -g... yes
-checking for gcc option to accept ISO C89... none needed
-checking whether ln -s works... yes
-checking for sed... /bin/sed
-checking for grep... /bin/grep
-checking for flex... /usr/bin/flex
-checking for rpmbuild... /usr/bin/rpmbuild
-checking for xsltproc... /usr/bin/xsltproc
-checking for tar... /bin/tar
-checking for git... no
-checking for dpkg-buildpackage... no
-checking for udevadm... /sbin/udevadm
-checking for udevinfo... /usr/bin/udevinfo
-configure: WARNING: No dpkg-buildpackage found, building Debian packages is disabled.
-configure: WARNING: Cannot update buildtag without git. You may safely ignore this warning when building from a tarball.
-checking for /Makefile... no
-configure: WARNING: Unable to find a kernel Makefile in . You will have to set KDIR correctly when invoking make.
-checking for /etc/gentoo-release... no
-checking for /etc/redhat-release... yes
-checking for /etc/slackware-version... no
-checking for /etc/debian_version... no
-checking for /etc/SuSErelease... no
-configure: configured for Red Hat (includes Fedora, RHEL, CentOS).
-configure: creating ./config.status
-config.status: creating Makefile
-config.status: creating user/Makefile
-config.status: creating scripts/Makefile
-config.status: creating documentation/Makefile
-+ echo kernelversion=2.6.31.6-162.fc12.x86_64
-kernelversion=2.6.31.6-162.fc12.x86_64
-+ echo 'kversion=%{kversion}'
-kversion=%{kversion}
-+ echo krelver=2.6.31.6_162.fc12.x86_64
-krelver=2.6.31.6_162.fc12.x86_64
-+ make module KDIR=/lib/modules/2.6.31.6-162.fc12.x86_64/build
-make[1]: Entering directory `/root/rpmbuild/BUILD/drbd-8.3.6/drbd'
-
-  Calling toplevel makefile of kernel source tree, which I believe is in
-  KDIR=/lib/modules/2.6.31.6-162.fc12.x86_64/build
-
-test -f ../scripts/adjust_drbd_config_h.sh &amp;&amp; \
-     KDIR=/lib/modules/2.6.31.6-162.fc12.x86_64/build O= /bin/bash ../scripts/adjust_drbd_config_h.sh
-/lib/modules/2.6.31.6-162.fc12.x86_64/build ~/rpmbuild/BUILD/drbd-8.3.6/drbd
-~/rpmbuild/BUILD/drbd-8.3.6/drbd
-
- Using unmodified drbd_config.h
-</screen>
-		
-<screen>
-make -C /lib/modules/2.6.31.6-162.fc12.x86_64/build  SUBDIRS=/root/rpmbuild/BUILD/drbd-8.3.6/drbd modules
-make[2]: Entering directory `/usr/src/kernels/2.6.31.6-162.fc12.x86_64'
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_buildtag.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_bitmap.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_proc.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_worker.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_receiver.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_req.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_actlog.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/lru_cache.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_main.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_strings.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_nl.o
- CC [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_tracing.o
- LD [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd.o
- LD [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_trace.o
- Building modules, stage 2.
- MODPOST 2 modules
- CC   /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd.mod.o
- LD [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd.ko
- CC   /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_trace.mod.o
- LD [M] /root/rpmbuild/BUILD/drbd-8.3.6/drbd/drbd_trace.ko
-make[2]: Leaving directory `/usr/src/kernels/2.6.31.6-162.fc12.x86_64'
-mv .drbd_kernelrelease.new .drbd_kernelrelease
-Memorizing module configuration ... done.
-make[1]: Leaving directory `/root/rpmbuild/BUILD/drbd-8.3.6/drbd'
-
-    Module build was successful.
-+ exit 0
-Executing(%install): /bin/sh -e /var/tmp/rpm-tmp.sAoLRi
-+ umask 022
-+ cd /root/rpmbuild/BUILD
-+ cd drbd-8.3.6
-+ rm -rf /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64
-+ make install DESTDIR=/root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64
-make[1]: Entering directory `/root/rpmbuild/BUILD/drbd-8.3.6/user'
-make[1]: Nothing to be done for `install'.
-make[1]: Leaving directory `/root/rpmbuild/BUILD/drbd-8.3.6/user'
-make[1]: Entering directory `/root/rpmbuild/BUILD/drbd-8.3.6/scripts'
-make[1]: Nothing to be done for `install'.
-make[1]: Leaving directory `/root/rpmbuild/BUILD/drbd-8.3.6/scripts'
-make[1]: Entering directory `/root/rpmbuild/BUILD/drbd-8.3.6/documentation'
-set -e; for f in ; do \
-        s=${f##*.}; \
-        install -v -D -m 644 $f /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/usr/share/man/man$s/$f ; \
-    done
-make[1]: Leaving directory `/root/rpmbuild/BUILD/drbd-8.3.6/documentation'
-make -C drbd install
-make[1]: Entering directory `/root/rpmbuild/BUILD/drbd-8.3.6/drbd'
-install -d /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/lib/modules/2.6.31.6-162.fc12.x86_64/kernel/drivers/block
-install -m 644 drbd.ko /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/lib/modules/2.6.31.6-162.fc12.x86_64/kernel/drivers/block
-make[1]: Leaving directory `/root/rpmbuild/BUILD/drbd-8.3.6/drbd'
-+ cd drbd
-+ mv .kernel.config.gz k-config-2.6.31.6-162.fc12.x86_64.gz
-+ /usr/lib/rpm/brp-compress
-+ /usr/lib/rpm/brp-strip
-+ /usr/lib/rpm/brp-strip-static-archive
-+ /usr/lib/rpm/brp-strip-comment-note
-Processing files: drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64
-Executing(%doc): /bin/sh -e /var/tmp/rpm-tmp.ixFNFB
-+ umask 022
-+ cd /root/rpmbuild/BUILD
-+ cd drbd-8.3.6
-+ DOCDIR=/root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/usr/share/doc/drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6
-+ export DOCDIR
-+ rm -rf /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/usr/share/doc/drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6
-+ /bin/mkdir -p /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/usr/share/doc/drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6
-+ cp -pr COPYING /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/usr/share/doc/drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6
-+ cp -pr ChangeLog /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/usr/share/doc/drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6
-+ cp -pr drbd/k-config-2.6.31.6-162.fc12.x86_64.gz /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64/usr/share/doc/drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6
-+ exit 0
-Requires(interp): /bin/sh /bin/sh /bin/sh
-Requires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1
-Requires(post): /bin/sh
-Requires(preun): /bin/sh
-Requires(postun): /bin/sh
-Conflicts: drbd-kmod &lt;= 8.3.6_3
-Checking for unpackaged file(s): /usr/lib/rpm/check-files /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64
-Wrote: /root/rpmbuild/SRPMS/drbd-km-8.3.6-12.fc12.src.rpm
-Wrote: /root/rpmbuild/RPMS/x86_64/drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64.rpm
-Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.MB9N8D
-+ umask 022
-+ cd /root/rpmbuild/BUILD
-+ cd drbd-8.3.6
-+ rm -rf /root/rpmbuild/BUILDROOT/drbd-km-8.3.6-12.fc12.x86_64
-+ exit 0
-</screen>
-		<para>
-		</para>
-		<para>
-		</para>
-		<section>
-			<title>Install the DRBD Packages</title>
-			<para>
-				The completed build process will store the result in the ~/RPMS/x86_64/ directory and all that is required now is to install the ones we need with YUM.
-			</para>
-			<para>
-				yum install -y drbd-utils drbd-pacemaker
-			</para>
-			<para>
-				Now install the kernel module we built
-			</para>
-			
-<screen>
-cd /root/rpmbuild/RPMS/`uname -m`
-[root@pcmk-1 x86_64]# yum localinstall -y --nogpgcheck drbd-utils-8.3.6-*.rpm drbd-pacemaker-8.3.6-*.rpm drbd-km-*-8.3.6-*.rpm 
-Setting up Local Package Process
-Examining drbd-utils-8.3.6-1.fc12.x86_64.rpm: drbd-utils-8.3.6-1.fc12.x86_64
-Marking drbd-utils-8.3.6-1.fc12.x86_64.rpm to be installed
-custom                                      | 1.2 kB   00:00
-Examining drbd-pacemaker-8.3.6-1.fc12.x86_64.rpm: drbd-pacemaker-8.3.6-1.fc12.x86_64
-Marking drbd-pacemaker-8.3.6-1.fc12.x86_64.rpm to be installed
-Examining drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64.rpm: drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64
-Marking drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64.rpm to be installed
-Resolving Dependencies
---&gt; Running transaction check
----&gt; Package drbd-km-2.6.31.6_162.fc12.x86_64.x86_64 0:8.3.6-12.fc12 set to be updated
----&gt; Package drbd-pacemaker.x86_64 0:8.3.6-1.fc12 set to be updated
----&gt; Package drbd-utils.x86_64 0:8.3.6-1.fc12 set to be updated
---&gt; Finished Dependency Resolution
-
-Dependencies Resolved
-
-==========================================================================================
-Package     Arch  Version     Repository                  Size
-==========================================================================================
-Installing:
-drbd-km-2.6.31.6_162.fc12.x86_64
-        x86_64 8.3.6-12.fc12 /drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64
-                                          4.2 M
-drbd-pacemaker x86_64 8.3.6-1.fc12   /drbd-pacemaker-8.3.6-1.fc12.x86_64    40 k
-drbd-utils   x86_64 8.3.6-1.fc12   /drbd-utils-8.3.6-1.fc12.x86_64      580 k
-
-Transaction Summary
-==========================================================================================
-Install    3 Package(s)
-Upgrade    0 Package(s)
-
-Total size: 4.8 M
-Downloading Packages:
-Running rpm_check_debug
-Running Transaction Test
-Finished Transaction Test
-Transaction Test Succeeded
-Running Transaction
- Installing   : drbd-utils-8.3.6-1.fc12.x86_64                   1/3 
- Installing   : drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64       2/3 
- Installing   : drbd-pacemaker-8.3.6-1.fc12.x86_64                 3/3 
-
-Installed:
- drbd-km-2.6.31.6_162.fc12.x86_64.x86_64 0:8.3.6-12.fc12   
- drbd-pacemaker.x86_64 0:8.3.6-1.fc12   
- drbd-utils.x86_64 0:8.3.6-1.fc12              
-
-Complete!
-[root@pcmk-1 x86_64]#
-</screen>
-			<para>
-				By default DRBD configures itself to start when the machine is powered on, however since we want the cluster to manage it, we will need to disable this behavior:
-			</para>
-			<para>
-				chkconfig --del drbd
-			</para>
-			<para>
-			</para>
-			<para>
-				We could rebuild the drbd package on pcmk-2, however if they share the same architecture (x86_64 in this case) we can reuse the ones we built for pcmk-1. Assuming this is the case for you, copy them to pcmk-2 and install:
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# cd /root/rpmbuild/RPMS/`uname -m` 
-[root@pcmk-1 x86_64]# scp drbd-*.rpm pcmk-2:
-drbd-8.3.6-1.fc12.x86_64.rpm                100%  21KB 20.7KB/s  00:00
-drbd-bash-completion-8.3.6-1.fc12.x86_64.rpm        100% 5260   5.1KB/s  00:00
-drbd-heartbeat-8.3.6-1.fc12.x86_64.rpm           100% 6716   6.6KB/s  00:00
-drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64.rpm 100% 1271KB  1.2MB/s  00:00
-drbd-pacemaker-8.3.6-1.fc12.x86_64.rpm           100%  18KB 17.7KB/s  00:00
-drbd-udev-8.3.6-1.fc12.x86_64.rpm             100% 4103   4.0KB/s  00:00
-drbd-utils-8.3.6-1.fc12.x86_64.rpm             100% 265KB 264.8KB/s  00:00
-drbd-xen-8.3.6-1.fc12.x86_64.rpm              100% 6690   6.5KB/s  00:00
-[root@pcmk-1 x86_64]# ssh pcmk-2 -- yum localinstall -y --nogpgcheck drbd-utils-8.3.6-*.rpm drbd-pacemaker-8.3.6-*.rpm drbd-km-*-8.3.6-*.rpm
-Setting up Local Package Process
-Examining drbd-utils-8.3.6-1.fc12.x86_64.rpm: drbd-utils-8.3.6-1.fc12.x86_64
-Marking drbd-utils-8.3.6-1.fc12.x86_64.rpm to be installed
-Examining drbd-pacemaker-8.3.6-1.fc12.x86_64.rpm: drbd-pacemaker-8.3.6-1.fc12.x86_64
-Marking drbd-pacemaker-8.3.6-1.fc12.x86_64.rpm to be installed
-Examining drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64.rpm: drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64
-Marking drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64.rpm to be installed
-Resolving Dependencies
---&gt; Running transaction check
----&gt; Package drbd-km-2.6.31.6_162.fc12.x86_64.x86_64 0:8.3.6-12.fc12 set to be updated
----&gt; Package drbd-pacemaker.x86_64 0:8.3.6-1.fc12 set to be updated
----&gt; Package drbd-utils.x86_64 0:8.3.6-1.fc12 set to be updated
---&gt; Finished Dependency Resolution
-
-Dependencies Resolved
-
-================================================================================
-Package    Arch  Version    Repository              Size
-================================================================================
-Installing:
-drbd-km-2.6.31.6_162.fc12.x86_64
-        x86_64 8.3.6-12.fc12 /drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64
-                                     4.2 M
-drbd-pacemaker x86_64 8.3.6-1.fc12  /drbd-pacemaker-8.3.6-1.fc12.x86_64 40 k
-drbd-utils   x86_64 8.3.6-1.fc12  /drbd-utils-8.3.6-1.fc12.x86_64   580 k
-
-Transaction Summary
-================================================================================
-Install    3 Package(s)
-Upgrade    0 Package(s)
-
-Total size: 4.8 M
-Downloading Packages:
-Running rpm_check_debug
-Running Transaction Test
-Finished Transaction Test
-Transaction Test Succeeded
-Running Transaction
- Installing   : drbd-utils-8.3.6-1.fc12.x86_64              1/3 
- Installing   : drbd-km-2.6.31.6_162.fc12.x86_64-8.3.6-12.fc12.x86_64  2/3 
- Installing   : drbd-pacemaker-8.3.6-1.fc12.x86_64            3/3 
-
-Installed:
- drbd-km-2.6.31.6_162.fc12.x86_64.x86_64 0:8.3.6-12.fc12            
- drbd-pacemaker.x86_64 0:8.3.6-1.fc12                     
- drbd-utils.x86_64 0:8.3.6-1.fc12                       
-
-Complete!
-[root@pcmk-1 x86_64]# ssh pcmk-2 -- chkconfig --del drbd
-[root@pcmk-1 x86_64]#
-</screen>
-		</section>
-
-	</section>
-	
-	<section>
-		<title>Configure DRBD</title>
-		<para>
-			Before we configure DRBD, we need to set aside some disk for it to use.
-		</para>
-		<section>
-			<title>Create A Partition for DRBD</title>
-			<para>
-				If you have more than 1Gb free, feel free to use it. For this guide however, 1Gb is plenty of space for a single html file and sufficient for later holding the GFS2 metadata.
-			</para>
-			
-<screen>
-[root@pcmk-1 drbd-8.3.6]# lvcreate -n drbd-demo -L 1G VolGroup
+    </screen>
+  </section>
+  <section>
+    <title>Configure DRBD</title>
+    <para>
+      Before we configure DRBD, we need to set aside some disk for it to use.
+    </para>
+    <section>
+      <title>Create A Partition for DRBD</title>
+      <para>
+	If you have more than 1Gb free, feel free to use it.
+	For this guide however, 1Gb is plenty of space for a single html file and sufficient for later holding the GFS2 metadata.
+      </para>
+      <screen>
+[root@pcmk-1 ~]# <userinput>lvcreate -n drbd-demo -L 1G VolGroup</userinput>
  Logical volume "drbd-demo" created
-[root@pcmk-1 drbd-8.3.6]# lvs
+[root@pcmk-1 ~]# <userinput>lvs</userinput>
  LV    VG    Attr  LSize  Origin Snap% Move Log Copy% Convert
  <emphasis>drbd-demo VolGroup -wi-a- 1.00G</emphasis>                   
  lv_root  VolGroup -wi-ao  7.30G                   
  lv_swap  VolGroup -wi-ao 500.00M
-</screen>
-			<para>
-				Repeat this on the second node, be sure to use the same size partition.
-			</para>
-			
-<screen>
-[root@pcmk-2 ~]# lvs
+      </screen>
+      <para>
+	Repeat this on the second node, be sure to use the same size partition.
+      </para>
+      
+      <screen>
+[root@pcmk-2 ~]# <userinput>lvs</userinput>
  LV   VG    Attr  LSize  Origin Snap% Move Log Copy% Convert
  lv_root VolGroup -wi-ao  7.30G                   
  lv_swap <emphasis>VolGroup</emphasis> -wi-ao 500.00M                   
-[root@pcmk-2 ~]# lvcreate -n drbd-demo -L 1G VolGroup
+[root@pcmk-2 ~]# <userinput>lvcreate -n drbd-demo -L 1G VolGroup</userinput>
 <emphasis> Logical volume "drbd-demo" created</emphasis>
-[root@pcmk-2 ~]# lvs
+[root@pcmk-2 ~]# <userinput>lvs</userinput>
  LV    VG    Attr  LSize  Origin Snap% Move Log Copy% Convert
  <emphasis>drbd-demo VolGroup -wi-a- 1.00G </emphasis>                  
  lv_root  VolGroup -wi-ao  7.30G                   
  lv_swap  VolGroup -wi-ao 500.00M
-</screen>
-		</section>
-		
-		<section>
-			<title>Write the DRBD Config</title>
-			<para>
-				There is no series of commands for build a DRBD configuration, so simply copy the configuration below to /etc/drbd.conf
-			</para>
-			<para>
-				Detailed information on the directives used in this configuration (and other alternatives) is available from <ulink url="http://www.drbd.org/users-guide/ch-configure.html">http://www.drbd.org/users-guide/ch-configure.html</ulink>
-			</para>
-			<warning>
-				<para>
-					Be sure to use the names and addresses of <emphasis>your</emphasis> nodes if they differ from the ones used in this guide.
-				</para>
-			</warning>
-			
-<screen>
+      </screen>
+    </section>
+    
+    <section>
+      <title>Write the DRBD Config</title>
+      <para>
+	There is no series of commands for build a DRBD configuration, so simply copy the configuration below to /etc/drbd.conf
+      </para>
+      <para>
+	Detailed information on the directives used in this configuration (and other alternatives) is available from <ulink url="http://www.drbd.org/users-guide/ch-configure.html">http://www.drbd.org/users-guide/ch-configure.html</ulink>
+      </para>
+      <warning>
+	<para>
+	  Be sure to use the names and addresses of <emphasis>your</emphasis> nodes if they differ from the ones used in this guide.
+	</para>
+      </warning>
+      <screen>
 global { 
  usage-count yes; 
 }
@@ -637,22 +153,21 @@ resource wwwdata {
   address  192.168.122.102<emphasis>:7789;</emphasis>      
  }
 }
-</screen>
-			<note>
-				<para>
-					TODO: Explain the reason for the allow-two-primaries option
-				</para>
-			</note>
-		</section>
-		
-		<section>
-			<title>Initialize and Load DRBD</title>
-			<para>
-				With the configuration in place, we can now perform the DRBD initialization
-			</para>
-			
-<screen>
-[root@pcmk-1 drbd-8.3.6]# drbdadm create-md wwwdata
+      </screen>
+      <note>
+	<para>
+	  TODO: Explain the reason for the allow-two-primaries option
+	</para>
+      </note>
+    </section>
+    
+    <section>
+      <title>Initialize and Load DRBD</title>
+      <para>
+	With the configuration in place, we can now perform the DRBD initialization
+      </para>
+      <screen>
+[root@pcmk-1 ~]# <userinput>drbdadm create-md wwwdata</userinput>
 md_offset 12578816
 al_offset 12546048
 bm_offset 12541952
@@ -668,72 +183,70 @@ initializing activity log
 NOT initialized bitmap
 New drbd meta data block successfully created.
 success
-</screen>
-			<para>
-				Now load the DRBD kernel module and confirm that everything is sane
-			</para>
-			
-<screen>
-[root@pcmk-1 drbd-8.3.6]# modprobe drbd
-[root@pcmk-1 drbd-8.3.6]# drbdadm up wwwdata
-[root@pcmk-1 drbd-8.3.6]# cat /proc/drbd
+      </screen>
+      <para>
+	Now load the DRBD kernel module and confirm that everything is sane
+      </para>
+      <screen>
+[root@pcmk-1 ~]# <userinput>modprobe drbd</userinput>
+[root@pcmk-1 ~]# <userinput>drbdadm up wwwdata</userinput>
+[root@pcmk-1 ~]# <userinput>cat /proc/drbd</userinput>
 version: 8.3.6 (api:88/proto:86-90)
 GIT-hash: f3606c47cc6fcf6b3f086e425cb34af8b7a81bbf build by root@pcmk-1, 2009-12-08 11:22:57
 
 <emphasis> 1: cs:WFConnection ro:Secondary/Unknown ds:Inconsistent/DUnknown C r--</emphasis>--
   ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:12248
-[root@pcmk-1 drbd-8.3.6]# 
+[root@pcmk-1 ~]# 
 
 Repeat on the second node
 drbdadm --force create-md wwwdata 
 modprobe drbd
 drbdadm up wwwdata
 cat /proc/drbd
-[root@pcmk-2 ~]# drbdadm --force create-md wwwdata
+[root@pcmk-2 ~]# <userinput>drbdadm --force create-md wwwdata</userinput>
 Writing meta data...
 initializing activity log
 NOT initialized bitmap
 New drbd meta data block successfully created.
 success
-[root@pcmk-2 ~]# modprobe drbd
+[root@pcmk-2 ~]# <userinput>modprobe drbd</userinput>
 WARNING: Deprecated config file /etc/modprobe.conf, all config files belong into /etc/modprobe.d/.
-[root@pcmk-2 ~]# drbdadm up wwwdata
-[root@pcmk-2 ~]# cat /proc/drbd
+[root@pcmk-2 ~]# <userinput>drbdadm up wwwdata</userinput>
+[root@pcmk-2 ~]# <userinput>cat /proc/drbd</userinput>
 version: 8.3.6 (api:88/proto:86-90)
 GIT-hash: f3606c47cc6fcf6b3f086e425cb34af8b7a81bbf build by root@pcmk-1, 2009-12-08 11:22:57
 
 <emphasis> 1: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r----</emphasis>
   ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:12248
-</screen>
-			<para>
-				Now we need to tell DRBD which set of data to use. Since both sides contain garbage, we can run the following on pcmk-1:
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# drbdadm -- --overwrite-data-of-peer primary wwwdata
-[root@pcmk-1 ~]# cat /proc/drbd
+      </screen>
+      <para>
+	Now we need to tell DRBD which set of data to use. 
+	Since both sides contain garbage, we can run the following on pcmk-1:
+      </para>
+      <screen>
+[root@pcmk-1 ~]# <userinput>drbdadm -- --overwrite-data-of-peer primary wwwdata</userinput>
+[root@pcmk-1 ~]# <userinput>cat /proc/drbd</userinput>
 version: 8.3.6 (api:88/proto:86-90)
 GIT-hash: f3606c47cc6fcf6b3f086e425cb34af8b7a81bbf build by root@pcmk-1, 2009-12-08 11:22:57
 1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/<emphasis>Inconsistent</emphasis> C r----
   ns:2184 nr:0 dw:0 dr:2472 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:10064
     [=====&gt;..............] sync'ed: 33.4% (10064/12248)K
     finish: 0:00:37 speed: 240 (240) K/sec
-[root@pcmk-1 ~]# cat /proc/drbd
+[root@pcmk-1 ~]# <userinput>cat /proc/drbd</userinput>
 version: 8.3.6 (api:88/proto:86-90)
 GIT-hash: f3606c47cc6fcf6b3f086e425cb34af8b7a81bbf build by root@pcmk-1, 2009-12-08 11:22:57
 1: <emphasis>cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate</emphasis> C r----
   ns:12248 nr:0 dw:0 dr:12536 al:0 bm:1 lo:0 pe:0 ua:0 ap:0 ep:1 wo:b oos:0
-</screen>
-			<para>
-				pcmk-1 is now in the Primary state which allows it to be written to. Which means its a good point at which to create a filesystem and populate it with some data to serve up via our WebSite resource.
-			</para>
-		</section>
-		
-		<section>
-			<title>Populate DRBD with Data</title>
-			
-<screen>
-[root@pcmk-1 ~]# mkfs.ext4 /dev/drbd1
+      </screen>
+      <para>
+	pcmk-1 is now in the Primary state which allows it to be written to.
+	Which means its a good point at which to create a filesystem and populate it with some data to serve up via our WebSite resource.
+      </para>
+    </section>
+    <section>
+      <title>Populate DRBD with Data</title>
+      <screen>
+[root@pcmk-1 ~]# <userinput>mkfs.ext4 /dev/drbd1</userinput>
 mke2fs 1.41.4 (27-Jan-2009)
 Filesystem label=
 OS type: Linux
@@ -764,63 +277,48 @@ cat &lt;&lt;-END &gt;/mnt/index.html
 &lt;/html&gt;
 END
 umount /dev/drbd1
-[root@pcmk-1 ~]# mount /dev/drbd1 /mnt/
-[root@pcmk-1 ~]# cat &lt;&lt;-END &gt;/mnt/index.html
+[root@pcmk-1 ~]# <userinput>mount /dev/drbd1 /mnt/</userinput>
+[root@pcmk-1 ~]# <userinput>cat &lt;&lt;-END &gt;/mnt/index.html</userinput>
 &gt; &lt;html&gt;
 &gt; &lt;body&gt;My Test Site - drbd&lt;/body&gt;
 &gt; &lt;/html&gt;
 &gt; END
-[root@pcmk-1 ~]# umount /dev/drbd1
-</screen>
-			<para>
-				And finally, confirm the data is in sync between the two nodes
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# drbdadmverifywwwdata
-[root@pcmk-1 ~]# echo $?
-<emphasis>0</emphasis>
-</screen>
-		</section>
-
-	</section>
-	
-	<section>
-		<title>Configure the Cluster for DRBD</title>
-		<para>
-			One handy feature of the crm shell is that you can use it in interactive mode to make several changes atomically.
-		</para>
-		<para>
-			First we launch the shell. The prompt will change to indicate youre in interactive mode.
-		</para>
-		
-<screen>
-[root@pcmk-1 ~]# crm
+[root@pcmk-1 ~]# <userinput>umount /dev/drbd1</userinput>
+      </screen>
+    </section>
+  </section>
+  <section>
+    <title>Configure the Cluster for DRBD</title>
+    <para>
+      One handy feature of the crm shell is that you can use it in interactive mode to make several changes atomically.
+    </para>
+    <para>
+      First we launch the shell. The prompt will change to indicate youre in interactive mode.
+    </para>
+    <screen>
+[root@pcmk-1 ~]# <userinput>crm</userinput>
 cib crm(live)#
-</screen>
-		<para>
-			Next we must create a working copy or the current configuration. This is where all our changes will go. The cluster will not see any of them until we say its ok. Notice again how the prompt changes, this time to indicate that were no longer looking at the live cluster.
-		</para>
-		
-<screen>
-cib new drbd
-cib crm(live)# cib new drbd
+    </screen>
+    <para>
+      Next we must create a working copy or the current configuration.
+      This is where all our changes will go.
+      The cluster will not see any of them until we say its ok.
+      Notice again how the prompt changes, this time to indicate that were no longer looking at the live cluster.
+    </para>
+    <screen>
+cib crm(live)# <userinput>cib new drbd</userinput>
 INFO: drbd shadow CIB created
 crm(drbd)#
-</screen>
-		<para>
-			Now we can create our DRBD clone and display the revised configuration.
-		</para>
-		
-<screen>
-configure primitive wwwdrbd ocf:linbit:drbd params drbd_resource=wwwdata op monitor interval=60s
-configure ms WebData wwwdrbd meta master-max=1 master-node-max=1 \
-    clone-max=2 clone-node-max=1 notify=true
-configure show
-crm(drbd)# configure primitive ocf:linbit:drbd WebData params drbd_resource=wwwdata op monitor interval=60s
-crm(drbd)# configure ms WebDataClone WebData meta master-max=1 master-node-max=1 \
-    clone-max=2 clone-node-max=1 notify=true
-crm(drbd)# configure show
+    </screen>
+    <para>
+      Now we can create our DRBD clone and display the revised configuration.
+    </para>
+    <screen>
+crm(drbd)# <userinput>configure primitive ocf:linbit:drbd WebData params drbd_resource=wwwdata \</userinput>
+<userinput>    op monitor interval=60s</userinput>
+crm(drbd)# <userinput>configure ms WebDataClone WebData meta master-max=1 master-node-max=1 \</userinput>
+<userinput>    clone-max=2 clone-node-max=1 notify=true</userinput>
+crm(drbd)# <userinput>configure show</userinput>
 node pcmk-1
 node pcmk-2
 <emphasis>primitive WebData ocf:linbit:drbd \</emphasis>
@@ -845,17 +343,16 @@ property $id="cib-bootstrap-options" \
     no-quorum-policy="ignore"
 rsc_defaults $id="rsc-options" \
     resource-stickiness=100
-</screen>
-		<para>
-			Once were happy with the changes, we can tell the cluster to start using them and use crm_mon to check everything is functioning.
-		</para>
-		
-<screen>
-crm(drbd)# cib commit drbd
+    </screen>
+    <para>
+      Once were happy with the changes, we can tell the cluster to start using them and use crm_mon to check everything is functioning.
+    </para>
+    <screen>
+crm(drbd)# <userinput>cib commit drbd</userinput>
 INFO: commited 'drbd' shadow CIB to the cluster
-crm(drbd)# quit
+crm(drbd)# <userinput>quit</userinput>
 bye
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Tue Sep 1 09:37:13 2009
 Stack: openais
@@ -872,37 +369,40 @@ WebSite (ocf::heartbeat:apache):   
 <emphasis>Master/Slave Set: WebDataClone</emphasis>
 <emphasis> Masters: [ pcmk-2 ]</emphasis>
 <emphasis> Slaves: [ pcmk-1 ]</emphasis>
-</screen>
-		<note>
-			<para>
-				Include details on adding a second DRBD resource
-			</para>
-		</note>
-		<para>
-		</para>
-		<para>
-			Now that DRBD is functioning we can configure a Filesystem resource to use it. In addition to the filesystems definition, we also need to tell the cluster where it can be located (only on the DRBD Primary) and when it is allowed to start (after the Primary was promoted).
-		</para>
-		<para>
-			Once again well use the shells interactive mode
-		</para>
-		
-<screen>
-[root@pcmk-1 ~]# crm
-crm(live)# cib new fs
+    </screen>
+    <note>
+      <para>
+	Include details on adding a second DRBD resource
+      </para>
+    </note>
+    <para>
+      Now that DRBD is functioning we can configure a Filesystem resource to use it.
+      In addition to the filesystems definition, we also need to tell the cluster where it can be located (only on the DRBD Primary) and when it is allowed to start (after the Primary was promoted).
+    </para>
+    <para>
+      Once again well use the shells interactive mode
+    </para>
+    <screen>
+[root@pcmk-1 ~]# <userinput>crm</userinput>
+crm(live)# <userinput>cib new fs</userinput>
 INFO: fs shadow CIB created
-crm(fs)# configure primitive WebFS ocf:heartbeat:Filesystem params device="/dev/mapper/VolGroup-drbd--demo" directory="/var/www/html" fstype="ext4"
-crm(fs)# configure colocation fs_on_drbd inf: WebFS WebDataClone:Master
-crm(fs)# configure order WebFS-after-WebData inf: WebDataClone:promote WebFS:start
-</screen>
-		<para>
-			We also need to tell the cluster that Apache needs to run on the same machine as the filesystem and that it must be active before Apache can start.
-		</para>
-		
-<screen>
-crm(fs)# configure colocation WebSite-with-WebFS inf: WebSite WebFS
-crm(fs)# configure order WebSite-after-WebFS inf: WebFS WebSite
-[root@pcmk-1 ~]# crm configure show
+crm(fs)# <userinput>configure primitive WebFS ocf:heartbeat:Filesystem \</userinput>
+<userinput>    params device="/dev/mapper/VolGroup-drbd--demo" directory="/var/www/html" fstype="ext4"</userinput>
+crm(fs)# <userinput>configure colocation fs_on_drbd inf: WebFS WebDataClone:Master</userinput>
+crm(fs)# <userinput>configure order WebFS-after-WebData inf: WebDataClone:promote WebFS:start</userinput>
+    </screen>
+    <para>
+      We also need to tell the cluster that Apache needs to run on the same machine as the filesystem and that it must be active before Apache can start.
+    </para>
+    <screen>
+crm(fs)# <userinput>configure colocation WebSite-with-WebFS inf: WebSite WebFS</userinput>
+crm(fs)# <userinput>configure order WebSite-after-WebFS inf: WebFS WebSite</userinput>
+    </screen>
+    <para>
+      Time to review the updated configuration:
+    </para>    
+    <screen>
+[root@pcmk-1 ~]# <userinput>crm configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebData ocf:linbit:drbd \
@@ -933,17 +433,16 @@ property $id="cib-bootstrap-options" \
     no-quorum-policy="ignore"
 rsc_defaults $id="rsc-options" \
     resource-stickiness=100
-</screen>
-		<para>
-			After reviewing the new configuration, we again upload it and watch the cluster put it into effect.
-		</para>
-		
-<screen>
-crm(fs)# cib commit fs
+    </screen>
+    <para>
+      After reviewing the new configuration, we again upload it and watch the cluster put it into effect.
+    </para>
+    <screen>
+crm(fs)# <userinput>cib commit fs</userinput>
 INFO: commited 'fs' shadow CIB to the cluster
-crm(fs)# quit
+crm(fs)# <userinput>quit</userinput>
 bye
-[root@pcmk-1 ~]# crm_mon
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Tue Sep 1 10:08:44 2009
 Stack: openais
@@ -961,19 +460,22 @@ Master/Slave Set: WebDataClone
     Masters: [ pcmk-1 ]
     Slaves: [ pcmk-2 ]
 <emphasis>WebFS (ocf::heartbeat:Filesystem): Started pcmk-1</emphasis>
-</screen>
-		<section>
-			<title>Testing Migration</title>
-			<para>
-				We could shut down the active node again, but another way to safely simulate recovery is to put the node into what is called standby mode. Nodes in this state tell the cluster that they are not allowed to run resources. Any resources found active there will be moved elsewhere. This feature can be particularly useful when updating the resources packages.
-			</para>
-			<para>
-				Put the local node into standby mode and observe the cluster move all the resources to the other node. Note also that the nodes status will change to indicate that it can no longer host resources.
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# crm node standby
-[root@pcmk-1 ~]# crm_mon
+    </screen>
+    <section>
+      <title>Testing Migration</title>
+      <para>
+	We could shut down the active node again, but another way to safely simulate recovery is to put the node into what is called standby mode.
+	Nodes in this state tell the cluster that they are not allowed to run resources.
+	Any resources found active there will be moved elsewhere.
+	This feature can be particularly useful when updating the resources packages.
+      </para>
+      <para>
+	Put the local node into standby mode and observe the cluster move all the resources to the other node.
+	Note also that the nodes status will change to indicate that it can no longer host resources.
+      </para>
+      <screen>
+[root@pcmk-1 ~]# <userinput>crm node standby</userinput>
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Tue Sep 1 10:09:57 2009
 Stack: openais
@@ -992,14 +494,13 @@ Master/Slave Set: WebDataClone
     <emphasis>Masters: [ pcmk-2 ]</emphasis>
     Stopped: [ WebData:1 ]
 WebFS  (ocf::heartbeat:Filesystem):  <emphasis>Started pcmk-2</emphasis>
-</screen>
-			<para>
-				Once weve done everything we needed to on pcmk-1 (in this case nothing, we just wanted to see the resources move), we can allow the node to be a full cluster member again.
-			</para>
-			
-<screen>
-[root@pcmk-1 ~]# crm node online
-[root@pcmk-1 ~]# crm_mon
+      </screen>
+      <para>
+	Once weve done everything we needed to on pcmk-1 (in this case nothing, we just wanted to see the resources move), we can allow the node to be a full cluster member again.
+      </para>
+      <screen>
+[root@pcmk-1 ~]# <userinput>crm node online</userinput>
+[root@pcmk-1 ~]# <userinput>crm_mon</userinput>
 ============
 Last updated: Tue Sep 1 10:13:25 2009
 Stack: openais
@@ -1017,22 +518,11 @@ Master/Slave Set: WebDataClone
     Masters: [ pcmk-2 ]
     Slaves: [ pcmk-1 ]
 WebFS  (ocf::heartbeat:Filesystem):  Started pcmk-2
-</screen>
-			<para>
-				Notice that our resource stickiness settings prevent the services from migrating back to pcmk-1.
-			</para>
-			<para>
-				Conversion to Active/Active
-			</para>
-			<para>
-				The primary requirement for an Active/Active cluster is that the data required for your services are available, simultaneously, on both machines. Pacemaker makes no requirement on how this is achieved, you could use a SAN if you had one available, however since DRBD supports multiple Primaries, we can also use that.
-			</para>
-			<para>
-				The only hitch is that we need to use a cluster-aware filesystem (and the one we used earlier with DRBD, ext4, is not one of those). Both OCFS2 and GFS2 are supported, however here we will use GFS2 which comes with Fedora 12.
-			</para>
-		</section>
-
-	</section>
-
+      </screen>
+      <para>
+	Notice that our resource stickiness settings prevent the services from migrating back to pcmk-1.
+      </para>
+    </section>
+  </section>
 </chapter>
 
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Ch-Stonith.xml
--- a/doc/Clusters_from_Scratch/en-US/Ch-Stonith.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Ch-Stonith.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -79,7 +79,7 @@
 			
 <screen>
 stonith -t external/ibmrsa -n
-[root@pcmk-1 ~]# stonith -t external/ibmrsa -n
+[root@pcmk-1 ~]# <userinput>stonith -t external/ibmrsa -n</userinput>
 hostname ipaddr userid passwd type
 </screen>
 			<para>
@@ -87,21 +87,21 @@ hostname ipaddr userid passwd ty
 			</para>
 			
 <screen>
-[root@pcmk-1 ~]# crm 
-crm(live)# cib new stonith
+[root@pcmk-1 ~]# <userinput>crm </userinput>
+crm(live)# <userinput>cib new stonith</userinput>
 INFO: stonith shadow CIB created
-crm(stonith)# configure primitive rsa-fencing stonith::external/ibmrsa \
-    params hostname=pcmk-1 pcmk-2" ipaddr=192.168.122.31 userid=mgmt passwd=abc123 type=ibm \
-    op monitor interval="60s"
-crm(stonith)# configure clone Fencing rsa-fencing
+crm(stonith)# <userinput>configure primitive rsa-fencing stonith::external/ibmrsa \</userinput>
+<userinput>    params hostname=pcmk-1 pcmk-2" ipaddr=192.168.122.31 userid=mgmt passwd=abc123 type=ibm \</userinput>
+<userinput>    op monitor interval="60s"</userinput>
+crm(stonith)# <userinput>configure clone Fencing rsa-fencing</userinput>
 </screen>
 			<para>
 				And finally, since we disabled it earlier, we need to re-enable STONITH
 			</para>
 			
 <screen>
-crm(stonith)# configure property stonith-enabled="true"
-crm(stonith)# configure show
+crm(stonith)# <userinput>configure property stonith-enabled="true"</userinput>
+crm(stonith)# <userinput>configure show</userinput>
 node pcmk-1
 node pcmk-2
 primitive WebData ocf:linbit:drbd \
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Clusters_from_Scratch.ent
--- a/doc/Clusters_from_Scratch/en-US/Clusters_from_Scratch.ent	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Clusters_from_Scratch.ent	Mon Jul 12 18:48:04 2010 +0200
@@ -1,4 +1,6 @@
 <!ENTITY PRODUCT "Pacemaker">
 <!ENTITY BOOKID "Clusters_from_Scratch">
 <!ENTITY YEAR "2010">
-<!ENTITY HOLDER "| You need to change the HOLDER entity in the en-US/Clusters_from_Scratch.ent file |">
+<!ENTITY HOLDER "Andrew Beekhof">
+<!ENTITY DISTRO "Fedora">
+<!ENTITY DISTRO_VERSION "13">
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Clusters_from_Scratch.xml
--- a/doc/Clusters_from_Scratch/en-US/Clusters_from_Scratch.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Clusters_from_Scratch.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -13,7 +13,6 @@
 	<xi:include href="Ch-Active-Passive.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
 	<xi:include href="Ch-Apache.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
 	<xi:include href="Ch-Shared-Storage.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
-	<xi:include href="Ch-ClusterFS.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
 	<xi:include href="Ch-Active-Active.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
 	<xi:include href="Ch-Stonith.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
 	<xi:include href="Ap-Configuration.xml" xmlns:xi="http://www.w3.org/2001/XInclude" />
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Clusters_from_Scratch/en-US/Revision_History.xml
--- a/doc/Clusters_from_Scratch/en-US/Revision_History.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Clusters_from_Scratch/en-US/Revision_History.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -8,18 +8,10 @@
 	<simpara>
 		<revhistory>
 			<revision>
-				<revnumber>0</revnumber>
-				<date>Fri Apr 23 2010</date>
-				<author>
-					<firstname>Dude</firstname>
-					<surname>McPants</surname>
-					<email>Dude.McPants@example.com</email>
-				</author>
-				<revdescription>
-					<simplelist>
-						<member>Initial creation of book by publican</member>
-					</simplelist>
-				</revdescription>
+			  <revnumber>1</revnumber>
+			  <date>Mon May 17 2010</date>
+			  <author><firstname>Andrew</firstname><surname>Beekhof</surname><email>andrew@beekhof.net</email></author>
+			  <revdescription><simplelist><member>Import from Pages.app</member></simplelist></revdescription>
 			</revision>
 		</revhistory>
 	</simpara>
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Makefile.am
--- a/doc/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -23,8 +23,7 @@ helpdir		= $(datadir)/$(PACKAGE)
 
 ascii		= crm_cli.txt crm_fencing.txt
 help_DATA	= crm_cli.txt
-docbook		= Pacemaker_Explained
-man_MANS	= cibadmin.8 crm_resource.8
+docbook		= Pacemaker_Explained Clusters_from_Scratch
 doc_DATA	= README.hb2openais $(ascii) $(generated_docs)
 
 publican_docs    =
@@ -60,7 +59,7 @@ publican_docs	+= $(docbook)
 generated_docs	+= index.html
 endif
 
-EXTRA_DIST	= $(man_MANS) $(docbook:%=%.xml) 
+EXTRA_DIST	= $(docbook:%=%.xml) 
 
 index.html:  $(docbook_txt)
 	echo "Building documentation index"
@@ -71,7 +70,7 @@ index.html:  $(docbook_txt)
 	done
 if BUILD_DOCBOOK
 	for book in $(docbook); do 					\
-	    for lang in `ls -1 $(docbook)/publish`; do 			\
+	    for lang in `ls -1 $$book/publish`; do 			\
 	      echo "<li>$$book ($$lang)<ul>" >> index.html; 	\
 	      find $$book/publish/$$lang -name "*.pdf" -exec echo -n "<li><a href=\"{}\">" \; -exec basename {} \; -exec echo "</a></li>" \; | sed s:$$book/publish/:: >> index.html ;		\
 	      find $$book/publish/$$lang -name "*.txt" -exec echo -n "<li><a href=\"{}\">" \; -exec basename {} \; -exec echo "</a></li>" \; | sed s:$$book/publish/:: >> index.html ;		\
@@ -85,11 +84,11 @@ endif
 	echo "<p>You can find <a href=\"http://www.clusterlabs.org/wiki/Documentation\">additional documentation</a> and details about the Pacemaker project at <a href=\"http://www.clusterlabs.org\">http://www.clusterlabs.org</a></p>" >> index.html	
 	echo "</body></html>" >> index.html	
 
-
 %.html: %.txt
 	$(ASCIIDOC) --unsafe --backend=xhtml11 $<
 
 %.txt: %/en-US/*.xml
+	@echo Building $*
 	cd $* && $(PUBLICAN) build --publish --langs=all --formats=pdf,html,html-single,txt
 	touch $@
 
@@ -113,14 +112,19 @@ install-data-local: all-local
 	done
 endif
 
+brand:
+	find publican-clusterlabs -name "*.noarch.rpm" -exec rm -f \{\} \;
+	cd publican-clusterlabs && $(PUBLICAN) package --binary
+	find publican-clusterlabs -name "*.noarch.rpm" -exec sudo rpm -Uvh --force \{\} \;
+
 push:   all-local $(generated_docs)
 	echo Uploading current documentation set to clusterlabs.org
-	rsync -rtz --progress $(generated_docs) $(ascii) root@oss.clusterlabs.org:/srv/www/extras/doc/
+	rsync -rtz --progress $(generated_docs) $(ascii) root@oss.clusterlabs.org:/var/www/html/doc/
 if BUILD_DOCBOOK
 	for book in $(docbook); do 									\
 		echo Uploading $$book...;								\
 		echo "Generated on `date` from version: $(BUILD_VERSION)" > $$book/publish/build-$(PACKAGE_SERIES).txt;	\
-		rsync -rtz --progress $$book/publish/* root@oss.clusterlabs.org:/srv/www/extras/doc/;	\
+		rsync -rtz --progress $$book/publish/* root@oss.clusterlabs.org:/var/www/html/doc/;	\
 	done
 endif
 
diff -r f059ec7ced7a -r b230ffa2ecdc doc/Pacemaker_Explained/en-US/Book_Info.xml
--- a/doc/Pacemaker_Explained/en-US/Book_Info.xml	Mon May 17 17:57:40 2010 +0200
+++ b/doc/Pacemaker_Explained/en-US/Book_Info.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -5,7 +5,7 @@
   <title>Configuration Explained</title>
   <subtitle>An A-Z guide to Pacemaker's Configuration Options</subtitle>
   <productname>Pacemaker</productname>
-  <productnumber>1.0</productnumber>
+  <productnumber>1.1</productnumber>
   <edition>1</edition>
   <pubsnumber>0</pubsnumber>
   <abstract>
@@ -28,8 +28,7 @@
   <corpauthor>
     <inlinemediaobject>
       <imageobject>
-	<imagedata fileref="Common_Content/images/title_logo.svg" format="SVG">
-	</imagedata>
+	<imagedata fileref="Common_Content/images/title_logo.svg" format="SVG"/>
       </imageobject>
     </inlinemediaobject>
   </corpauthor>
diff -r f059ec7ced7a -r b230ffa2ecdc doc/cibadmin.8.in
--- a/doc/cibadmin.8.in	Mon May 17 17:57:40 2010 +0200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,244 +0,0 @@
-.TH CIBADMIN 8 "$Date: 2006/06/26 12:54:48 $" "Linux-HA/OpenHA Project" "Heartbeat @VERSION@ Adminstration Guide"
-.SH NAME
-\fIcibadmin\fP \- read, modify, or administer heartbeat Cluster Information Base
-.SH SYNOPSIS
-\fBcibadmin\fP (\-\-cib_query|\-Q) \-[Vrwlsmfbp] [-i xml-object-id|-o xml-object-type]
-[\-t t-flag-whatever] [\-h hostname]
-.PP
-\fBcibadmin\fP (\-\-cib_create|\-C) \-[Vrwlsmfbp] [\-X xml-string] [\-x xml-filename] [\-t t-flag-whatever] [\-h hostname]
-.PP
-\fBcibadmin\fP (\-\-cib_replace\-R) \-[Vrwlsmfbp] [\-i xml-object-id|-o xml-object-type] [\-X xml-string] [\-x xml-filename] [\-t t-flag-whatever] [\-h hostname]
-.PP
-\fBcibadmin\fP (\-\-cib_update|\-U) \-[Vrwlsmfbp] [\-i xml-object-id|-o xml-object-type] [\-X xml-string] [\-x xml-filename] [\-t t-flag-whatever] [\-h hostname]
-.PP
-\fBcibadmin\fP (\-\-cib_modify|\-M) \-[Vrwlsmfbp] [\-i xml-object-id|-o xml-object-type] [\-X xml-string] [\-x xml-filename] [\-t t-flag-whatever] [\-h hostname]
-.PP
-\fBcibadmin\fP (\-\-cib_delete|\-D) \-[Vrwlsmfbp] [\-i xml-object-id|-o xml-object-type] [\-t t-flag-whatever] [\-h hostname]
-.PP
-\fBcibadmin\fP (\-\-cib_delete_alt|\-d) \-[Vrwlsmfbp] \-o xml-object-type [\-X xml-string|\-x xml-filename] [\-t t-flag-whatever] [\-h hostname]
-.PP
-\fBcibadmin\fP \-\-cib_erase (\-E)
-.PP
-\fBcibadmin\fP \-\-cib_bump (\-B)
-.PP
-\fBcibadmin\fP \-\-cib_ismaster (\-m)
-.PP
-\fBcibadmin\fP \-\-cib_master (\-w)
-.PP
-\fBcibadmin\fP \-\-cib_slave (\-r)
-.PP
-\fBcibadmin\fP \-\-cib_sync (\-S)
-.PP
-\fBcibadmin\fP \-\-cib_help (\-?)
-.SH DESCRIPTION
-\fBCibadmin\fP is the primary administrative command for manipulating the
-heartbeat CIB.
-It can be used to dump all or part of the CIB, to update all or part of it
-to modify all or part of it, to delete the entire CIB, or to
-perform miscellaneous CIB administrative operations.
-
-\fBCibadmin\fP operates on the XML trees of the CIB, largely without knowledge of the meaning
-of the updates or queries being performed.
-This means that shortcuts that seem natural to humans who understand the meaning of
-the elements in the XML tree are impossible to use with \fBcibadmin\fP - which requires
-a complete lack of ambiguity, and can only deal with valid XML subtrees (tags/elements)
-\- both on input and output.
-
-.SH OPTIONS
-.TP 8
-.BI "\-\-id (\-i) " xml-object-id
-the XML \fIid\fP of the XML object being operated on.
-\fIThis option is deprecated, and may go away in future versions of \fBcibadmin\fP\fR.
-.TP 8
-.BI  "\-\-obj_type (\-o) " object-type
-the type of object being operated on.
-Valid values are \fInodes, resources, status, constraints\fP
-.TP 8
-.B \-\-verbose (\-V)
-turn on debug mode.  Additional \fB\-V\fP options increase the verbosity of the output.
-.TP 8
-.B \-\-help (\-?)
-obtain a help message from the \fBcibadmin\fP.
-.TP 8
-.B \-\-cib_erase (\-E)
-Erase the contents of the whole CIB.
-.TP 8
-.B \-\-cib_query (\-Q)
-Query a portion of the CIB.
-.TP 8
-.B \-\-cib_create (\-C)
-Create a new CIB from the argument XML content.
-.TP 8
-.B \-\-cib_replace (\-R)
-Recursively \fIreplace\fP an XML object in the CIB.
-.TP 8
-.B \-\-cib_update (\-U)
-Recursively \fIupdate\fP an object in the CIB.
-Updating an object replaces like members in the XML, but does not delete
-attributes not mentioned.
-.TP 8
-.B \-\-cib_modify (\-M)
-Modify the attributes of an object in the CIB.
-Object to be modified must be specified with a \fB\-\-id\fP option.
-.TP 8
-.B \-\-cib_delete (\-D)
-Delete the first object matching the specified criteria.
-e.g., \f(CW<\fItagname\fP id="rsc1_op1" name="monitor"/>\fR.
-The tagname and all attributes must match in order for the element to be deleted.
-.TP 8
-.B \-\-cib_delete_alt (\-d)
-Delete the object at the specified fully qualified location.
-e.g., <resource id="rsc1"><operations><op id="rsc1_op1"/>...
-Requires \fB\-o\fP \fItype\fP option.
-.TP 8
-.B \-\-cib_ismaster (\-m)
-Print a message indicating whether or not the local instance of the CIB
-software is the master instance or not.
-Exits with return code 0 if it \fIis\fP the master instance, or 35 otherwise.
-.TP 8
-.B \-\-cib_sync (\-S)
-Force a full sync of the local CIB against the master CIB.
-(or does this force all slave copies to be updated?).
-.TP 8
-.BI "\-\-crm_xml (\-X) " xml-fragment-string
-specifies an XML tag or fragment on the command line for \fBcrmadmin\fP to operate on.
-Note that it must be a complete tag or XML fragment.
-.TP 8
-.BI "\-\-xml\-file (\-x) " filename
-specifies XML in a file for \fBcibadmin\fP to operate on.
-Note that it must be a complete tag or XML fragment.
-.TP 8
-.B \-\-xml_pipe (\-p)
-specifies that the XML for \fIcibadmin\fP to operate on will come from standard input.
-Note that it must be a complete tag or XML fragment.
-.SH SPECIALIZED OPTIONS
-.TP 8
-.B \-\-cib_bump (\-B)
-This forcibly increases the update counter of the CIB.
-.TP 8
-.B \-\-cib_master (\-w)
-This command forces the local CIB instance into read-write mode. This is
-a highly dangerous command.
-.TP 8
-.B \-\-cib_slave (\-r)
-This command forces the local CIB instance into read-only mode. This is
-a highly dangerous command.
-.TP 8
-.B \-\-force_quorum (\-f)
-This will force a write to the CIB, regardless of whether the cluster
-has quorum or not. Use carefully.
-.TP 8
-.BI "\-\-host (\-h) " hostname
-specifies the host to send this command to (rarely used, advanced option)
-.TP 8
-.B \-\-local (\-l)
-command takes effect locally (rarely used, advanced option)
-.TP 8
-.B \-\-no\-bcast (\-b)
-Command will not be broadcast to other nodes, even if it modifies the CIB.
-This is a fairly dangerous, rarely used advanced option.
-.TP 8
-.B \-\-sync\-call (\-s)
-Wait for the operation given to \fIcibadmin\fP to complete before exiting.
-.SH EXAMPLES
-Need to put a few real examples here...
-To get a copy of the entire active CIB (including status section, etc.) delivered
-to stdout, issue this command:
-.RS
-\f(CWcibadmin \-Q\fP
-.RE
-.PP
-To get a copy of the status section (only) delivered
-to stdout, issue this command:
-.RS
-\f(CWcibadmin \-Q \-\-obj_type status\fP
-.RE
-.PP
-To add an IPaddr2 resource to the \fIresources\fP section, first
-create a file \fIfoo\fP with the following contents:
-.RS
-.nf
-\f(CW<primitive id="R_10.10.10.101" class="ocf" type="IPaddr2"
- provider="heartbeat">
- <instance_attributes id="RA_R_10.10.10.101">
-  <attributes>
-   <nvpair id="R_ip_P_ip" name="ip" value="10.10.10.101"/>
-   <nvpair id="R_ip_P_nic" name="nic" value="eth0"/>
-  </attributes>
- </instance_attributes>
-</primitive>\fP
-.fi
-.RE
-Then, issue the following command:
-.RS
-\f(CWcibadmin \-\-obj_type resources \-U \-x foo\fP
-.RE
-.PP
-To change the IP address of the IPaddr2 resource previously added, issue the command below:
-.RS
-\f(CWcibadmin \-\-id R_10.10.10.101 \-M \-X '<nvpair id="R_ip_P_ip" name="ip" value="10.10.10.102"/>'
-.RE
-\fBNote:\fP This does \fInot\fP change the resource name to match the new IP address.
-To do that you have to delete and re-add the resource with a new id tag.
-.PP
-To stop (disable) the IP address resource added previously without removing it, create a file
-called ''bar'' with the following content in it:
-.RS
-.nf
-\f(CW<primitive id="R_10.10.10.101">
- <instance_attributes id="RA_R_10.10.10.101">
-  <attributes>
-   <nvpair id="stop_R_10.10.10.101" name="target_role" value="Stopped"/>
-  </attributes>
- </instance_attributes>
-</primitive>\fP
-.fi
-.RE
-Then issue the following command:
-.RS
-\f(CWcibadmin \-\-obj_type resources \-U \-x bar\fP
-.RE
-.PP
-To restart the IP address resource stopped by the previous step, issue
-the command below:
-.RS
-\f(CWcibadmin \-D \-X '<nvpair id="stop_R_10.10.10.101">'\fP
-.RE
-.PP
-To completely remove the IP address resource from the CIB which was added earlier,
-issue the command below:
-.RS
-\f(CWcibadmin \-D \-X '<primitive id="R_10.10.10.101"/>'\fP
-.RE
-.PP
-To replace the CIB with a new hand-edited version of the CIB, issue the following command
-.RS
-\f(CWcibadmin \-R \-x $HOME/cib.xml\fP
-.RE
-\fBNOTE:\fP you should not edit the \fIcib.xml\fP file in place, but edit a copy of it,
-since it is frequently updated by the CIB at unpredictable times.
-.PP
-
-.SH FILES
-\f(CW@CRM_CONFIG_DIR@/cib.xml\fP \- the CIB (minus status section) on disk.
-.SH SEE ALSO
-crm_resource(8),
-crmadmin(8),
-lrmadmin(8),
-heartbeat(8)
-.SH AUTHOR
-\fBcibadmin\fP was written by Andrew Beekhof.
-.PP
-This manual page was originally written by Alan Robertson.
-.SH CAVEATS
-\fBcibadmin\fP is perfectly willing to completely mangle your CIB
-if you ask it reasonably nicely.
-.PP
-Because the CIB is updated continually as things change in the cluster, relying
-on using the automatically maintained previous copy of the CIB on disk as a backup
-is likely to be a dissapointing experience.
-.SH BUGS
-Note carefully the long options.
-Some have \fB\-\fP characters in them, and some have \fB_\fP characters in them.
-
-\fIWhat does the \-t xxx flag do?\fP
diff -r f059ec7ced7a -r b230ffa2ecdc doc/crm_cli.txt
--- a/doc/crm_cli.txt	Mon May 17 17:57:40 2010 +0200
+++ b/doc/crm_cli.txt	Mon Jul 12 18:48:04 2010 +0200
@@ -595,14 +595,15 @@ Example:
         meta stonith:ipmilan
 ...............
 
-[[cmdhelp_ra_providers,show providers for a RA]]
+[[cmdhelp_ra_providers,show providers for a RA and a class]]
 ==== `providers`
 
-List providers for a resource agent type.
+List providers for a resource agent type. The class parameter
+defaults to `ocf`.
 
 Usage:
 ...............
-        providers <type>
+        providers <type> [<class>]
 ...............
 Example:
 ...............
@@ -724,7 +725,7 @@ constraint will no longer be active.
 
 Usage:
 ...............
-        migrate <rsc> [<node>] [<lifetime>]
+        migrate <rsc> [<node>] [<lifetime>] [force]
 ...............
 
 [[cmdhelp_resource_unmigrate,unmigrate a resource to another node]]
@@ -1650,11 +1651,12 @@ to display the changes graphically.
 
 Add a string of `v` characters to increase verbosity. `ptest`
 can also show allocation scores. `utilization` turns on
-information about the remaining capacity of nodes.
+information about the remaining capacity of nodes. With the
+`actions` option, `ptest` will print all resource actions.
 
 Usage:
 ...............
-        ptest [nograph] [v...] [scores] [utilization]
+        ptest [nograph] [v...] [scores] [actions] [utilization]
 ...............
 Examples:
 ...............
diff -r f059ec7ced7a -r b230ffa2ecdc doc/crm_resource.8.in
--- a/doc/crm_resource.8.in	Mon May 17 17:57:40 2010 +0200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,216 +0,0 @@
-.TH CRM_RESOURCE 8 "$Date: 2006/08/31 11:53:00 $" "Linux\-HA/OpenHA Project" "Heartbeat @VERSION@ Administration Guide"
-.SH NAME
-\fIcrm_resource\fP \- Interact with the Cluster Resource Manager
-.SH SYNOPSIS
-\fBcrm_resource\fP [\-?VS] \-(L|Q|W|D|C|P|p) [options]
-.SH DESCRIPTION
-\fBcrm_resource\fP allow resources to be listed, started, stopped, migrated and so forth.
-.TP 8
-.BI \-\-help,\ \-?
-this help message
-.TP 8
-.BI \-\-verbose,\ \-V
-turn on debug info. additional instances increase verbosity
-.TP 8
-.BI \-\-quiet,\ \-Q
-Print only the value on stdout (for use with \fB\-W\fP)
-.SS COMMANDS
-.TP 8
-.BI \-\-list,\ \-L
-List all resources
-.TP 8
-.BI \-\-query\-xml,\ \-x
-Query a resource.
-
-Requires: \fB\-r\fP
-.TP 8
-.BI \-\-locate,\ \-W
-Locate a resource.
-
-Requires: \fB\-r\fP
-.TP 8
-.BI \-\-migrate,\ \-M
-Migrate a resource from it current location.
-
-Use \fB\-H\fP to specify a destination.  If \fB\-H\fP is not specified, we will force the resource to move by creating a rule for the current location and a score of \-INFINITY
-
-\fBNOTE:\fP This will prevent the resource from running on this node until the constraint is removed with \fB\-U\fP
-
-Requires: \fB\-r\fP, Optional: \fB\-H\fP, \fB\-f\fP
-.TP 8
-.BI \-\-un\-migrate,\ \-U
-Remove all constraints created by \fB\-M\fP
-
-Requires: \fB\-r\fP
-.TP 8
-.BI \-\-delete,\ \-D
-Delete a resource from the CIB.
-
-Requires: \fB\-r\fP, \fB\-t\fP
-.TP 8
-.BI \-\-cleanup,\ \-C
-Delete a resource from the LRM.
-
-Requires: \fB\-r\fP.  Optional: \fB\-H\fP
-.TP 8
-.BI \-\-reprobe,\ \-P
-Recheck for resources started outside of the CRM.
-
-Optional: \fB\-H\fP
-.TP 8
-.BI \-\-refresh,\ \-R
-Refresh the CIB from the LRM.
-
-Optional: \fB\-H\fP
-.TP 8
-.BI \-\-set\-parameter\  string ,\ \-p\  string
-Set the named parameter for a resource.
-
-Requires: \fB\-r\fP, \fB\-v\fP.  Optional: \fB\-i\fP, \fB\-s\fP
-.TP 8
-.BI \-\-get\-parameter\  string ,\ \-g\  string
-Get the named parameter for a resource.
-
-Requires: \fB\-r\fP.  Optional: \fB\-i\fP, \fB\-s\fP
-.TP 8
-.BI \-\-delete\-parameter\  string ,\ \-d\  string
-Delete the named parameter for a resource.
-
-Requires: \fB\-r\fP.  Optional: \fB\-i\fP
-.TP 8
-.BI \-\-get\-property\  string ,\ \-G\  string
-Get the named property (eg. class, type, is_managed) a resource.
-
-Requires: \fB\-r\fP
-.TP 8
-.BI \-\-set\-property\  string ,\ \-S\  string
-Set the named property (not parameter) for a resource.
-
-Requires: \fB\-r\fP, \fB\-t\fP, \fB\-v\fP
-.SS OPTIONS
-.TP 8
-.BI \-\-resource\  string ,\ \-r\  string
-Resource ID
-.TP 8
-.BI \-\-resource\-type\  string ,\ \-t\  string
-Resource type (primitive, clone, group, ...)
-.TP 8
-.BI \-\-property\-value\  string ,\ \-v\  string
-Property value
-.TP 8
-.BI \-\-host\-uname\  string ,\ \-H\  string
-Host name
-.TP 8
-.BI \-\-force\-relocation,\ \-f
-Force the resource to move by creating a rule for the current location and a score of \-INFINITY
-
-This should be used if the resource's stickiness and constraint scores total more than INFINITY (Currently 10,000)
-
-\fBNOTE:\fP This will prevent the resource from running on this node until the constraint is removed with \fB\-U\fP
-.TP 8
-.BI \-s\  string
-(Advanced Use Only) ID of the instance_attributes object to change
-.TP 8
-.BI \-i\  string
-(Advanced Use Only) ID of the nvpair object to change/delete
-
-.SH EXAMPLES
-
-Listing all resources
-.RS
-\fBcrm_resource \-L\fP
-.RE
-.PP
-Checking where a resource is running (and if it does)
-.RS
-\fBcrm_resource \-W \-r my_first_ip\fP
-
-\fBresource my_first_ip is running on: server1\fP
-
-\fBcrm_resource \-W \-r my_first_ip\fP
-
-\fBresource my_first_ip is NOT running\fP
-.RE
-.PP
-Start/stop a resource
-.RS
-\fBcrm_resource \-r my_first_ip \-p target_role \-v started\fP
-
-\fBcrm_resource \-r my_first_ip \-p target_role \-v stopped\fP
-.RE
-.PP
-Query the definition of a resource
-.RS
-\fBcrm_resource \-Q \-r my_first_ip\fP
-.RE
-.PP
-Migrating a resource away from its current location
-.RS
-\fBcrm_resource \-M \-r my_first_ip\fP
-.RE
-.PP
-Migrating a resource to a specific location
-.RS
-\fBcrm_resource \-M \-r my_first_ip \-H c001n02\fP
-.RE
-.PP
-Allow a resource to return to its normal location
-.RS
-\fBcrm_resource \-U \-r my_first_ip\fP
-
-\fBNOTE:\fP the values of resource_stickiness and default_resource_stickiness may mean that it doesnt move back. In such cases, you should use \fB\-M\fP to move it back and then run this command.
-.RE
-.PP
-Deleting a resource from the CR
-.RS
-\fBcrm_resource \-D \-r my_first_ip \-t primitive\fP
-.RE
-.PP
-Deleting a resource group from the CRM
-.RS
-\fBcrm_resource \-D \-r my_first_group \-t group\fP
-.RE
-.PP
-Disabling a resource management for a resource in the CRM
-.RS
-\fBcrm_resource \-p is_managed \-r my_first_ip \-t primitive \-v off\fP
-.RE
-.PP
-Enabling a resource management for a resource in the CRM
-.RS
-\fBcrm_resource \-p is_managed \-r my_first_ip \-t primitive \-v on\fP
-.RE
-.PP
-Resetting a failed resource after having been manually cleaned up
-.RS
-\fBcrm_resource \-C \-H c001n02 \-r my_first_ip\fP
-.RE
-.PP
-Rechecking all nodes for resources started outside of the CRM
-.RS
-\fBcrm_resource \-P\fP
-.RE
-.PP
-Rechecking one node for resources started outside of the CRM
-.RS
-\fBcrm_resource \-P \-H c001n02\fP
-.RE
-.PP
-.SH FILES
-.PP
-.SH SEE ALSO
-.BR cibadmin (8),
-.BR crmadmin (8),
-.BR lrmadmin (8),
-.BR heartbeat (8)
-.SH NOTES
-.PP
-.SH AUTHOR
-\fBcrm_resource\fP was written by Andrew Beekhof.
-.PP
-This manual page was originally written by Gildas Le Nadan (Genome Research Limited, 2006).
-.PP
-.SH CAVEATS
-.PP
-.SH BUGS
-.PP
diff -r f059ec7ced7a -r b230ffa2ecdc doc/publican-clusterlabs/en-US/css/overrides.css
--- a/doc/publican-clusterlabs/en-US/css/overrides.css	Mon May 17 17:57:40 2010 +0200
+++ b/doc/publican-clusterlabs/en-US/css/overrides.css	Mon Jul 12 18:48:04 2010 +0200
@@ -11,7 +11,7 @@ h1 {
 }
 
 .producttitle {
-	background: #800 url(../images/h1-bg.png) top left repeat;
+	background: #2C4081 url(../images/h1-bg.png) top left repeat;
 }
 
 .section h1.title {
diff -r f059ec7ced7a -r b230ffa2ecdc doc/publican-clusterlabs/xsl/common.xsl
--- a/doc/publican-clusterlabs/xsl/common.xsl	Mon May 17 17:57:40 2010 +0200
+++ b/doc/publican-clusterlabs/xsl/common.xsl	Mon Jul 12 18:48:04 2010 +0200
@@ -17,7 +17,7 @@
                 xmlns:fo="http://www.w3.org/1999/XSL/Format"
                 exclude-result-prefixes="#default">
 
-<xsl:param name="title.color">#843A39</xsl:param>
+<xsl:param name="title.color">#2C4081</xsl:param>
 <!-- http://docbook.sourceforge.net/release/xsl/current/doc/html/generate.toc.html -->
 <xsl:param name="generate.toc">
 appendix  toc,title
diff -r f059ec7ced7a -r b230ffa2ecdc extra/resources/Stateful
--- a/extra/resources/Stateful	Mon May 17 17:57:40 2010 +0200
+++ b/extra/resources/Stateful	Mon Jul 12 18:48:04 2010 +0200
@@ -58,8 +58,8 @@ Location to store the resource state in
 </parameters>
 
 <actions>
-<action name="start"   timeout="90" />
-<action name="stop"    timeout="100" />
+<action name="start"   timeout="20" />
+<action name="stop"    timeout="20" />
 <action name="monitor" depth="0"  timeout="20" interval="10" role="Master"/>
 <action name="monitor" depth="0"  timeout="20" interval="10" role="Slave"/>
 <action name="meta-data"  timeout="5" />
diff -r f059ec7ced7a -r b230ffa2ecdc extra/resources/controld
--- a/extra/resources/controld	Mon May 17 17:57:40 2010 +0200
+++ b/extra/resources/controld	Mon Jul 12 18:48:04 2010 +0200
@@ -186,18 +186,23 @@ controld_validate() {
 : ${OCF_RESKEY_configdir=/sys/kernel/config}
 : ${OCF_RESKEY_CRM_meta_gloablly_unique:="false"}
 
+case "$HA_quorum_type" in
+    cman) daemon_ext="";;
+    *) daemon_ext=".pcmk";;
+esac
+
 case "$OCF_RESOURCE_INSTANCE" in
     *[gG][fF][sS]*) 
 	: ${OCF_RESKEY_args=-g 0}
-	: ${OCF_RESKEY_daemon=gfs_controld.pcmk}
+	: ${OCF_RESKEY_daemon=gfs_controld${daemon_ext}}
 	;;
     *[dD][lL][mM]*)
 	: ${OCF_RESKEY_args=-q 0}
-	: ${OCF_RESKEY_daemon=dlm_controld.pcmk}
+	: ${OCF_RESKEY_daemon=dlm_controld${daemon_ext}}
 	;;
     *)
 	: ${OCF_RESKEY_args=-q 0}
-	: ${OCF_RESKEY_daemon=dlm_controld.pcmk}
+	: ${OCF_RESKEY_daemon=dlm_controld${daemon_ext}}
 esac
 
 case $__OCF_ACTION in
diff -r f059ec7ced7a -r b230ffa2ecdc extra/resources/ping
--- a/extra/resources/ping	Mon May 17 17:57:40 2010 +0200
+++ b/extra/resources/ping	Mon Jul 12 18:48:04 2010 +0200
@@ -67,7 +67,7 @@ The time to wait (dampening) further cha
 The name of the attributes to set.  This is the name to be used in the constraints.
 </longdesc>
 <shortdesc lang="en">Attribute name</shortdesc>
-<content type="string" default="${OCF_RESOURCE_INSTANCE}"/>
+<content type="string" default="pingd"/>
 </parameter>
 
 <parameter name="multiplier" unique="0">
@@ -254,8 +254,13 @@ ping_update() {
 : ${OCF_RESKEY_CRM_meta_globally_unique:="true"}
 
 if [ -z ${OCF_RESKEY_timeout} ]; then
-    OCF_RESKEY_timeout=`expr $OCF_RESKEY_CRM_meta_timeout / $OCF_RESKEY_attempts`
-    OCF_RESKEY_timeout=`expr $OCF_RESKEY_timeout / 1100` # Convert to seconds and finish 10% early
+    if [ x"$OCF_RESKEY_host_list" != x ]; then
+	host_count=`echo $OCF_RESKEY_host_list | awk '{print NF}'`
+	OCF_RESKEY_timeout=`expr $OCF_RESKEY_CRM_meta_timeout / $host_count / $OCF_RESKEY_attempts`
+	OCF_RESKEY_timeout=`expr $OCF_RESKEY_timeout / 1100` # Convert to seconds and finish 10% early
+    else
+	OCF_RESKEY_timeout=5
+    fi
 fi
 
 if [ ${OCF_RESKEY_timeout} -lt 1 ]; then
diff -r f059ec7ced7a -r b230ffa2ecdc extra/resources/pingd
--- a/extra/resources/pingd	Mon May 17 17:57:40 2010 +0200
+++ b/extra/resources/pingd	Mon Jul 12 18:48:04 2010 +0200
@@ -30,26 +30,55 @@
 #######################################################################
 # Initialization:
 
-if [ "x" != "x$OCF_RESKEY_host_list" ]; then 
-    ocf_log err "It is recommended that you use the ping resource instead"
-#    ${OCF_ROOT}/resource.d/pacemaker/ping $1
-#    exit $?
-fi
-
 . ${OCF_ROOT}/resource.d/heartbeat/.ocf-shellfuncs
 
-#######################################################################
+: ${OCF_RESKEY_name:="pingd"}
+: ${OCF_RESKEY_interval:="1"}
+: ${OCF_RESKEY_CRM_meta_interval:=0}
 
-meta_data() {
+upgrade1="This agent (ocf:pacemaker:pingd) has been replaced by the more reliable ocf:pacemaker:ping."
+upgrade2="Attempting automated conversion, run 'crm ra info ocf:pacemaker:ping' for all configuration options"
+upgrade3="You will need to remove the existing resource and replace it with one that uses 'ocf:pacemaker:ping' directly"
+
+case $__OCF_ACTION in
+    start|monitor)
+	if [ "x" != "x$OCF_RESKEY_host_list" ]; then
+	    ocf_log err "$upgrade1"
+	    ocf_log err "$upgrade2"
+	    ocf_log err "Automatic conversion to ocf:pacemaker:ping failed: no hosts were configured to check for connectivity"
+	    ocf_log err "$upgrade3"
+	    exit $OCF_ERR_ARGS
+	fi
+
+	recurring=`crm configure show $OCF_RESOURCE_INSTANCE | grep "op monitor.*interval=\"[1-9]" | sed s/.*interval=// | awk -F\" '{print $2}' | sed s/.*interval=// | awk -F\" '{print $2}' | sort | head -n 1`
+
+	if [ -z $recurring ]; then
+	    ocf_log err "$upgrade1"
+	    ocf_log err "$upgrade2"
+	    ocf_log err "Automatic conversion to ocf:pacemaker:ping failed: no monitor operation configured"
+	    ocf_log err "Without an explicit monitor operation for '$OCF_RESOURCE_INSTANCE', connectivity changes will not be noticed"
+	    ocf_log err "Preventing startup to ensure the issue is addressed before it matters"
+	    exit $OCF_ERR_ARGS
+	fi
+	
+	if [ $OCF_RESKEY_CRM_meta_interval = 0 ]; then
+	    ocf_log warn "$upgrade1"
+	    ocf_log warn "$upgrade2"
+	    if [ $recurring != $OCF_RESKEY_interval ]; then
+		ocf_log warn "Your monitor operation happens every $recurring, which means that the $OCF_RESKEY_name attribute will be updated with a different frequency than the previously configured ( $OCF_RESKEY_interval )"
+		ocf_log warn "Either change the monitor interval to match or, ideally, switch to the ocf:pacemaker:ping agent and avoid all this compatibility nonsense."
+	    fi
+	fi
+	;;
+    meta-data)
 	cat <<END
 <?xml version="1.0"?>
 <!DOCTYPE resource-agent SYSTEM "ra-api-1.dtd">
 <resource-agent name="pingd">
 <version>1.0</version>
-
 <longdesc lang="en">
-This is a pingd Resource Agent.
-It records (in the CIB) the current number of ping nodes a node can connect to.
+This agent (ocf:pacemaker:pingd) has been replaced by the more reliable ocf:pacemaker:ping.
+It records (in the CIB) the current number of ping nodes (specified in the 'host_list' parameter) a cluster node can connect to.
 </longdesc>
 <shortdesc lang="en">pingd resource agent</shortdesc>
 
@@ -91,7 +120,7 @@ The name of the instance_attributes set 
 The name of the attributes to set.  This is the name to be used in the constraints.
 </longdesc>
 <shortdesc lang="en">Attribute name</shortdesc>
-<content type="string" default="${OCF_RESOURCE_INSTANCE}"/>
+<content type="string" default="pingd"/>
 </parameter>
 
 <parameter name="section" unique="0">
@@ -161,156 +190,9 @@ A catch all for any other options that n
 </actions>
 </resource-agent>
 END
-}
-
-#######################################################################
-
-pingd_usage() {
-	cat <<END
-usage: $0 {start|stop|monitor|validate-all|meta-data}
-
-Expects to have a fully populated OCF RA-compliant environment set.
-END
-}
-
-pingd_start() {
-    extras=""
-    if [ ! -z "$OCF_RESKEY_multiplier" ]; then
-	extras="$extras -m $OCF_RESKEY_multiplier"
-    fi
-    if [ ! -z "$OCF_RESKEY_set" ]; then
-	extras="$extras -s $OCF_RESKEY_set"
-    fi
-    if [ ! -z "$OCF_RESKEY_section" ]; then
-	extras="$extras -S $OCF_RESKEY_section"
-    fi
-    if [ ! -z "$OCF_RESKEY_interval" ]; then
-        extras="$extras -i $OCF_RESKEY_interval"
-    fi
-    if [ ! -z "$OCF_RESKEY_attempts" ]; then
-        extras="$extras -n $OCF_RESKEY_attempts"
-    fi
-    if [ ! -z "$OCF_RESKEY_timeout" ]; then
-        extras="$extras -t $OCF_RESKEY_timeout"
-    fi
-    for a_host in $OCF_RESKEY_host_list; do
-	extras="$extras -h $a_host"
-    done
-    pingd_cmd="${HA_BIN}/pingd -D -p $OCF_RESKEY_pidfile -a $OCF_RESKEY_name -d $OCF_RESKEY_dampen $extras $OCF_RESKEY_options"
-
-    if [ ! -z $OCF_RESKEY_user ]; then
-	sudo -u $OCF_RESKEY_user $pingd_cmd
-    else
-	$pingd_cmd
-    fi
-
-    rc=$?
-    if [ $rc = 0 ]; then
 	exit $OCF_SUCCESS
-    fi
-    
-    ocf_log err "Could not run $pingd_cmd : rc=$rc"
-    exit $OCF_ERR_GENERIC
-}
-
-pingd_stop() {
-    if [ -f $OCF_RESKEY_pidfile ]; then
-	pid=`cat $OCF_RESKEY_pidfile`
-    fi
-    if [ ! -z $pid ]; then
-	kill -TERM $pid
-	rc=$?
-
-	if [ $rc = 0 -o $rc = 1 ]; then
-	    rm $OCF_RESKEY_pidfile
-	    exit $OCF_SUCCESS
-	fi
-
-	ocf_log err "Unexpected result from kill -TERM $pid: $rc"
-	exit $OCF_ERR_GENERIC
-    fi
-    exit $OCF_SUCCESS
-}
-
-pingd_monitor() {
-    if [ -f $OCF_RESKEY_pidfile ]; then
-	pid=`cat $OCF_RESKEY_pidfile`
-    fi
-    if [ ! -z $pid ]; then
-	kill -0 $pid
-	if [ $? = 0 ]; then
-	    exit $OCF_SUCCESS
-	fi
-    fi
-    exit $OCF_NOT_RUNNING
-}
-
-pingd_validate() {
-# Existence of the user
-    if [ ! -z $OCF_RESKEY_user ]; then
-	getent passwd "$OCF_RESKEY_user" >/dev/null
-	if [ $? -eq 0 ]; then
-	    : Yes, user exists. We can further check his permission on crm_mon if necessary
-	else
-	    ocf_log err "The user $OCF_RESKEY_user does not exist!"
-	    exit $OCF_ERR_ARGS
-	fi
-    fi
-
-# Pidfile better be an absolute path
-    case $OCF_RESKEY_pidfile in
-	/*) ;;
-	*) ocf_log warn "You should have pidfile($OCF_RESKEY_pidfile) of absolute path!" ;;
-    esac
-
-# Check the ping interval
-    if ocf_is_decimal "$OCF_RESKEY_interval" && [ $OCF_RESKEY_interval -gt 0 ]; then
-	:
-    else
-	ocf_log err "Invalid ping interval $OCF_RESKEY_interval. It should be positive integer!"
-	exit $OCF_ERR_ARGS
-    fi
-
-    echo "Validate OK"
-    return $OCF_SUCCESS
-}
-
-if [ $# -ne 1 ]; then
-    pingd_usage
-    exit $OCF_ERR_ARGS
-fi
-
-: ${OCF_RESKEY_options:=""}
-: ${OCF_RESKEY_dampen:="5s"}
-: ${OCF_RESKEY_interval:="1"}
-: ${OCF_RESKEY_name:="pingd"}
-: ${OCF_RESKEY_CRM_meta_interval:=0}
-: ${OCF_RESKEY_CRM_meta_globally_unique:="true"}
-
-if [ ${OCF_RESKEY_CRM_meta_globally_unique} = "false" ]; then
-    : ${OCF_RESKEY_pidfile:="$HA_VARRUN/pingd-${OCF_RESKEY_name}"}
-else 
-    : ${OCF_RESKEY_pidfile:="$HA_VARRUN/pingd-${OCF_RESOURCE_INSTANCE}"}
-fi
-
-case $__OCF_ACTION in
-meta-data)	meta_data
-		exit $OCF_SUCCESS
-		;;
-start)		pingd_start
-		;;
-stop)		pingd_stop
-		;;
-monitor)	pingd_monitor
-		;;
-validate-all)	pingd_validate
-		;;
-usage|help)	pingd_usage
-		exit $OCF_SUCCESS
-		;;
-*)		pingd_usage
-		exit $OCF_ERR_UNIMPLEMENTED
-		;;
+	;;
 esac
 
+${OCF_ROOT}/resource.d/pacemaker/ping $1
 exit $?
diff -r f059ec7ced7a -r b230ffa2ecdc fencing/Makefile.am
--- a/fencing/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/fencing/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -26,6 +26,14 @@ halib_PROGRAMS	= stonithd stonith-test
 sbin_PROGRAMS  = stonith_admin
 sbin_SCRIPTS   = fence_legacy
 
+if BUILD_HELP
+man8_MANS =	$(sbin_PROGRAMS:%=%.8) fence_legacy.8
+%.8:	%
+	echo Creating $@
+	chmod a+x $<
+	help2man --output $@ --no-info --section 8 --name "Part of the Pacemaker cluster resource manager" $(top_builddir)/fencing/$<
+endif
+
 stonith_test_SOURCES	= test.c
 
 stonith_test_LDADD	= $(CRYPTOLIB) $(CLUSTERLIBS)			\
diff -r f059ec7ced7a -r b230ffa2ecdc fencing/admin.c
--- a/fencing/admin.c	Mon May 17 17:57:40 2010 +0200
+++ b/fencing/admin.c	Mon Jul 12 18:48:04 2010 +0200
@@ -50,6 +50,7 @@ static struct crm_option long_options[] 
     {"query",       1, 0, 'Q', "Check the device's status"},
     {"fence",       1, 0, 'F', "Fence the named host"},
     {"unfence",     1, 0, 'U', "Unfence the named host"},
+    {"confirm",     1, 0, 'C', "Confirm the named host is now safely down"},
 
     {"register",    1, 0, 'R', "Register a stonith device"},
     {"deregister",  1, 0, 'D', "De-register a stonith device"},
@@ -86,7 +87,7 @@ main(int argc, char ** argv)
     stonith_t *st = NULL;
     GHashTable *hash = g_hash_table_new(g_str_hash, g_str_equal);
     
-    crm_log_init("stonith-admin", LOG_INFO, TRUE, TRUE, argc, argv);
+    crm_log_init(NULL, LOG_INFO, TRUE, TRUE, argc, argv);
     crm_set_options("V?$LQ:R:D:o:a:l:e:F:U:M", "mode [options]", long_options,
 		    "Provides access to the stonith-ng API.\n");
 
@@ -125,6 +126,7 @@ main(int argc, char ** argv)
 		break;
 	    case 'F':
 	    case 'U':
+	    case 'C':
 		target = optarg;
 		action = flag;
 		break;
@@ -223,6 +225,9 @@ main(int argc, char ** argv)
 	    }
 	    break;
 	    
+	case 'C':
+	    rc = st->cmds->confirm(st, st_opts, target);
+	    break;
 	case 'F':
 	    rc = st->cmds->fence(st, st_opts, target, hash, "off", 120);
 	    break;
diff -r f059ec7ced7a -r b230ffa2ecdc fencing/commands.c
--- a/fencing/commands.c	Mon May 17 17:57:40 2010 +0200
+++ b/fencing/commands.c	Mon Jul 12 18:48:04 2010 +0200
@@ -60,6 +60,20 @@ static ProcTrack_ops StonithdProcessTrac
 };
 
 
+static void free_async_command(async_command_t *cmd) 
+{
+    if(cmd->node_attrs) {
+	g_hash_table_destroy(cmd->node_attrs);
+    }    
+    crm_free(cmd->action);
+    crm_free(cmd->victim);
+    crm_free(cmd->remote);
+    crm_free(cmd->client);
+    crm_free(cmd->origin);
+    crm_free(cmd->op);
+    crm_free(cmd);    
+}
+
 static async_command_t *create_async_command(xmlNode *msg, const char *action) 
 {
     async_command_t *cmd = NULL;
@@ -77,26 +91,12 @@ static async_command_t *create_async_com
     cmd->victim = crm_element_value_copy(msg, F_STONITH_TARGET);
     cmd->pt_ops = &StonithdProcessTrackOps;
 
-    CRM_CHECK(cmd->op != NULL,     crm_log_xml_warn(msg, "NoOp");     return NULL);
+    CRM_CHECK(cmd->op != NULL, crm_log_xml_warn(msg, "NoOp"); free_async_command(cmd); return NULL);
     CRM_CHECK(cmd->client != NULL || cmd->remote != NULL, crm_log_xml_warn(msg, "NoClient"));
     
     return cmd;
 }
 
-static void free_async_command(async_command_t *cmd) 
-{
-    if(cmd->node_attrs) {
-	g_hash_table_destroy(cmd->node_attrs);
-    }    
-    crm_free(cmd->action);
-    crm_free(cmd->victim);
-    crm_free(cmd->remote);
-    crm_free(cmd->client);
-    crm_free(cmd->origin);
-    crm_free(cmd->op);
-    crm_free(cmd);    
-}
-
 static void free_device(gpointer data)
 {
     stonith_device_t *device = data;
@@ -112,7 +112,6 @@ static void free_device(gpointer data)
 static GHashTable *build_port_aliases(const char *hostmap, GListPtr *targets) 
 {
     char *name = NULL;
-    char *value = NULL;
     int last = 0, lpc = 0, max = 0;
     GHashTable *aliases = g_hash_table_new_full(g_str_hash, g_str_equal, g_hash_destroy_str, g_hash_destroy_str);
     
@@ -129,11 +128,13 @@ static GHashTable *build_port_aliases(co
 	    /* keep going */
 	    
 	} else if(hostmap[lpc] == '=') {
+	    crm_free(name);
 	    crm_malloc0(name, 1 + lpc - last);
 	    strncpy(name, hostmap + last, lpc - last);
 	    last = lpc + 1;
 	    
 	} else if(name && isspace(hostmap[lpc])) {
+	    char *value = NULL;
 	    crm_malloc0(value, 1 + lpc - last);
 	    strncpy(value, hostmap + last, lpc - last);
 	    last = lpc + 1;
@@ -150,6 +151,7 @@ static GHashTable *build_port_aliases(co
 	    last = lpc;
 	}   
     }
+    crm_free(name);
     return aliases;
 }
 
@@ -211,11 +213,12 @@ static GListPtr parse_host_list(const ch
     int last = 0;
     GListPtr output = NULL;
 
-    if(hosts) {
-	max = strlen(hosts);
+    if(hosts == NULL) {
+	return output;
     }
     
-    for(lpc = 0; lpc < max; lpc++) {
+    max = strlen(hosts);
+    for(lpc = 0; lpc <= max; lpc++) {
 	if(hosts[lpc] == '\n' || hosts[lpc] == 0) {
 	    char *line = NULL;
 
@@ -338,6 +341,7 @@ static int stonith_device_action(xmlNode
 
 	cmd = create_async_command(msg, action);
 	if(cmd == NULL) {
+	    free_device(device);
 	    return st_err_internal;
 	}
 
@@ -359,7 +363,7 @@ static int stonith_device_action(xmlNode
 		     action, device->id, exec_rc, rc, *output);
 	    
 	} else if(exec_rc > 0) {
-	    crm_info("Operation %s on %s active with pid: %d", action, device->id, exec_rc);
+	    crm_debug("Operation %s on %s active with pid: %d", action, device->id, exec_rc);
 	    rc = exec_rc;
 	    
 	} else {
@@ -380,8 +384,8 @@ static int stonith_device_action(xmlNode
 static gboolean can_fence_host_with_device(stonith_device_t *dev, const char *host)
 {
     gboolean can = FALSE;
-    const char *victim = get_victim_name(dev, host);
-    const char *check_type = g_hash_table_lookup(dev->params, STONITH_ATTR_HOSTCHECK);
+    const char *victim = NULL;
+    const char *check_type = NULL;
 
     if(dev == NULL) {
 	return FALSE;
@@ -390,8 +394,16 @@ static gboolean can_fence_host_with_devi
 	return TRUE;
     }
 
+    victim = get_victim_name(dev, host);
+    check_type = g_hash_table_lookup(dev->params, STONITH_ATTR_HOSTCHECK);
+    
     if(check_type == NULL) {
-	check_type = "dynamic-list";
+
+	if(g_hash_table_lookup(dev->params, STONITH_ATTR_HOSTLIST)) {
+	    check_type = "static-list";
+	} else {
+	    check_type = "dynamic-list";
+	}
     }
     
     if(safe_str_eq(check_type, "none")) {
@@ -562,7 +574,7 @@ static void log_operation(async_command_
 		   cmd->action, pid, cmd->victim, cmd->device, rc, next?". Trying: ":"", next?next:"",
 		   cmd->id, cmd->client);
     } else {
-	do_crm_log(rc==0?LOG_INFO:LOG_NOTICE,
+	do_crm_log(rc==0?LOG_DEBUG:LOG_NOTICE,
 		   "Operation '%s' [%d] for device '%s' returned: %d%s%s",
 		   cmd->action, pid, cmd->device, rc, next?". Trying: ":"", next?next:"");
     }
@@ -655,6 +667,8 @@ exec_child_done(ProcTrack* proc, int sta
 	crm_free(output); output = NULL;
 
     } else if(crm_str_eq(cmd->action, "reboot", TRUE)
+	   || crm_str_eq(cmd->action, "poweroff", TRUE)
+	   || crm_str_eq(cmd->action, "poweron", TRUE)
 	   || crm_str_eq(cmd->action, "off", TRUE)
 	   || crm_str_eq(cmd->action, "on", TRUE)) {
 	bcast = TRUE;
@@ -720,6 +734,7 @@ static int stonith_fence(xmlNode *msg)
     crm_info("Found %d matching devices for '%s'", g_list_length(search.capable), search.host);
 
     if(g_list_length(search.capable) == 0) {
+	free_async_command(cmd);	
 	return st_err_none_available;
     }
 
@@ -840,6 +855,17 @@ stonith_command(stonith_client_t *client
 	do_stonith_notify(call_options, op, rc, request, NULL);
 	
 
+    } else if(crm_str_eq(op, STONITH_OP_CONFIRM, TRUE)) {
+	async_command_t *cmd = create_async_command(request, crm_element_value(request, F_STONITH_ACTION));
+	xmlNode *reply = stonith_construct_async_reply(cmd, NULL, NULL, 0);
+
+	crm_xml_add(reply, F_STONITH_OPERATION, T_STONITH_NOTIFY);
+	crm_notice("Broadcasting manual fencing confirmation for node %s", cmd->victim);
+	send_cluster_message(NULL, crm_msg_stonith_ng, reply, FALSE);
+
+	free_async_command(cmd);
+	free_xml(reply);
+
     } else if(crm_str_eq(op, STONITH_OP_EXEC, TRUE)) {
 	rc = stonith_device_action(request, &output);
 
@@ -899,8 +925,8 @@ stonith_command(stonith_client_t *client
 	crm_log_xml_warn(request, "UnknownOp");
     }
 
-    crm_info("Processed %s%s from %s: rc=%d", op, is_reply?" reply":"",
-	     client?client->name:remote, rc);
+    do_crm_log(rc>0?LOG_DEBUG:LOG_INFO,"Processed %s%s from %s: rc=%d", op, is_reply?" reply":"",
+	       client?client->name:remote, rc);
     
     if(is_reply) {
 	/* Nothing */	
diff -r f059ec7ced7a -r b230ffa2ecdc fencing/fence_legacy
--- a/fencing/fence_legacy	Mon May 17 17:57:40 2010 +0200
+++ b/fencing/fence_legacy	Mon Jul 12 18:48:04 2010 +0200
@@ -1,6 +1,6 @@
 #!/usr/bin/perl
 
-use Getopt::Std;
+use Getopt::Long;
 
 my $ME = $0;
 
@@ -23,9 +23,10 @@ my $pname = $_;
 
 sub usage
 {
-    print "Usage:\n";
+    print "Helper that presents a RHCS-style interface for Linux-HA stonith plugins\n\n";
+    print "Should never need to use invoked by the user directly\n\n";
     print "\n";
-    print "$pname [options]\n";
+    print "Usage: $pname [options]\n";
     print "\n";
     print "Options:\n";
     print "  -h               usage\n";
@@ -121,8 +122,20 @@ sub get_options_stdin
 # MAIN
 
 if (@ARGV > 0) {
-   getopts("ht:n:o:s:qV") || fail_usage ;
-
+    GetOptions("t=s"=>\$opt_t,
+	       "n=s"=>\$opt_n,
+	       "o=s"=>\$opt_o,
+	       "s=s"=>\$opt_s,
+	       "q"  =>\$opt_q,
+	       "V"  =>\$opt_V,
+	       "version"  =>\$opt_V,
+	       "help"  =>\$opt_h,
+	       "h"  =>\$opt_h) || fail_usage;
+    foreach (@ARGV) {
+	print "$_\n";
+    }
+#   getopts("ht:n:o:s:qV") || fail_usage ;
+    
    usage if defined $opt_h;
    version if defined $opt_V;
 
@@ -133,13 +146,21 @@ get_options_stdin();
 
 $opt_o=lc($opt_o);
 fail "failed: unrecognised action: $opt_o"
-    unless $opt_o =~ /^(on|off|reset|reboot|stat|status|monitor|list|hostlist)$/;
+    unless $opt_o =~ /^(on|off|reset|reboot|stat|status|monitor|list|hostlist|poweroff|poweron)$/;
 
 if ( $pid=fork() == 0 )
 {
    if ( $opt_o eq "reboot" ) 
    {
        $opt_o="reset";
+   } 
+   elsif ( $opt_o eq "poweron" ) 
+   {
+       $opt_o="on";
+   }
+   elsif ( $opt_o eq "poweroff" ) 
+   {
+       $opt_o="off";
    }
 
    if ( $opt_o eq "hostlist"|| $opt_o eq "list" )
diff -r f059ec7ced7a -r b230ffa2ecdc fencing/main.c
--- a/fencing/main.c	Mon May 17 17:57:40 2010 +0200
+++ b/fencing/main.c	Mon Jul 12 18:48:04 2010 +0200
@@ -247,7 +247,7 @@ stonith_peer_hb_callback(HA_Message * ms
 }
 
 
-#if SUPPORT_AIS	
+#if SUPPORT_COROSYNC	
 static gboolean stonith_peer_ais_callback(
     AIS_Message *wrapper, char *data, int sender) 
 {
@@ -546,18 +546,58 @@ main(int argc, char ** argv)
 	printf("<resource-agent name=\"stonithd\">\n");
 	printf("<version>1.0</version>\n");
 	printf("<longdesc lang=\"en\">This is a fake resource that details the instance attributes handled by stonithd.</longdesc>\n");
-	printf("<shortdesc lang=\"en\">stonithd Options</shortdesc>\n");
+	printf("<shortdesc lang=\"en\">Options available for all stonith resources</shortdesc>\n");
 	printf("<parameters>\n");
+
 	printf("<parameter name=\"stonith-timeout\" unique=\"0\">\n");
-	printf("<shortdesc lang=\"en\">How long to wait for the STONITH action to complete. Overrides the stonith-timeout cluster property</shortdesc>\n");
+	printf("<shortdesc lang=\"en\">How long to wait for the STONITH action to complete.</shortdesc>\n");
+	printf("<longdesc lang=\"en\">Overrides the stonith-timeout cluster property</longdesc>\n");
 	printf("<content type=\"time\" default=\"60s\"/>\n");
-	printf("<longdesc lang=\"en\">How long to wait for the STONITH action to complete. Overrides the stonith-timeout cluster property</longdesc>\n");
 	printf("</parameter>\n");
+
 	printf("<parameter name=\"priority\" unique=\"0\">\n");
 	printf("<shortdesc lang=\"en\">The priority of the stonith resource. The lower the number, the higher the priority.</shortdesc>\n");
 	printf("<content type=\"integer\" default=\"0\"/>\n");
-	printf("<longdesc lang=\"en\">The priority of the stonith resource. The lower the number, the higher the priority.</longdesc>\n");
 	printf("</parameter>\n");
+
+	printf("<parameter name=\"%s\" unique=\"0\">\n", STONITH_ATTR_ARGMAP);
+	printf("<shortdesc lang=\"en\">A mapping of host attributes to device arguments.</shortdesc>\n");
+	printf("<longdesc lang=\"en\">Eg. uname:domain would tell the cluster to pass the machines name as the domain argument to the device.  Useful for devices that have non-standard interfaces</longdesc>\n");
+	printf("<content type=\"string\" default=\"\"/>\n");
+	printf("</parameter>\n");
+
+	printf("<parameter name=\"%s\" unique=\"0\">\n", STONITH_ATTR_HOSTMAP);
+	printf("<shortdesc lang=\"en\">A mapping of host names to ports numbers for devices that do not support names.</shortdesc>\n");
+	printf("<longdesc lang=\"en\">Eg. node1:1,node2:3 would tell the cluster to use port 1 for node1 and port 3 for node2</longdesc>\n");
+	printf("<content type=\"string\" default=\"\"/>\n");
+	printf("</parameter>\n");
+
+	printf("<parameter name=\"%s\" unique=\"0\">\n", STONITH_ATTR_HOSTLIST);
+	printf("<shortdesc lang=\"en\">A list of machines controlled by this device (Optional unless %s=static-list).</shortdesc>\n", STONITH_ATTR_HOSTCHECK);
+	printf("<content type=\"string\" default=\"\"/>\n");
+	printf("</parameter>\n");
+
+	printf("<parameter name=\"%s\" unique=\"0\">\n", STONITH_ATTR_HOSTCHECK);
+	printf("<shortdesc lang=\"en\">How to determin which machines are controlled by the device.</shortdesc>\n");
+	printf("<longdesc lang=\"en\">Allowed values: dynamic-list (query the device), static-list (check the %s attribute), none (assume every device can fence every machine)</longdesc>\n", STONITH_ATTR_HOSTLIST);
+	printf("<content type=\"string\" default=\"dynamic-list\"/>\n");
+	printf("</parameter>\n");
+
+	printf("<parameter name=\"%s\" unique=\"0\">\n", STONITH_ATTR_LIST_OP);
+	printf("<shortdesc lang=\"en\">Which device operation to use for listing machines controlled by the device.</shortdesc>\n");
+	printf("<content type=\"string\" default=\"list\"/>\n");
+	printf("</parameter>\n");
+
+	printf("<parameter name=\"%s\" unique=\"0\">\n", STONITH_ATTR_STATUS_OP);
+	printf("<shortdesc lang=\"en\">Which device operation to use for testing the state of a machine controlled by the device.</shortdesc>\n");
+	printf("<content type=\"string\" default=\"status\"/>\n");
+	printf("</parameter>\n");
+
+	printf("<parameter name=\"%s\" unique=\"0\">\n", STONITH_ATTR_MONITOR_OP);
+	printf("<shortdesc lang=\"en\">Which device operation to use for monitoring the health of the device.</shortdesc>\n");
+	printf("<content type=\"string\" default=\"monitor\"/>\n");
+	printf("</parameter>\n");
+	
 	printf("</parameters>\n");
 	printf("</resource-agent>\n");
 	return 0;
@@ -585,7 +625,7 @@ main(int argc, char ** argv)
 	void *destroy = stonith_peer_hb_destroy;
 	    
 	if(is_openais_cluster()) {
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 	    destroy = stonith_peer_ais_destroy;
 	    dispatch = stonith_peer_ais_callback;
 #endif
diff -r f059ec7ced7a -r b230ffa2ecdc fencing/remote.c
--- a/fencing/remote.c	Mon May 17 17:57:40 2010 +0200
+++ b/fencing/remote.c	Mon Jul 12 18:48:04 2010 +0200
@@ -463,6 +463,9 @@ int process_remote_stonith_query(xmlNode
 	} else {
 	    free_remote_query(result);
 	}
+
+    } else {
+	free_remote_query(result);
     }
     
     return 0;
diff -r f059ec7ced7a -r b230ffa2ecdc fencing/test.c
--- a/fencing/test.c	Mon May 17 17:57:40 2010 +0200
+++ b/fencing/test.c	Mon Jul 12 18:48:04 2010 +0200
@@ -74,7 +74,7 @@ main(int argc, char ** argv)
 
     gboolean passive_mode = FALSE;
     
-    crm_log_init("stonith-test", LOG_INFO, TRUE, TRUE, argc, argv);
+    crm_log_init(NULL, LOG_INFO, TRUE, TRUE, argc, argv);
     crm_set_options("V?$p", "mode [options]", long_options,
 		    "Provides a summary of cluster's current state."
 		    "\n\nOutputs varying levels of detail in a number of different formats.\n");
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm/Makefile.am
--- a/include/crm/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -19,6 +19,6 @@ MAINTAINERCLEANFILES	= Makefile.in
 
 headerdir=$(pkgincludedir)/crm
 
-header_HEADERS		= crm.h cib.h msg_xml.h transition.h ais.h cib_util.h cib_ops.h
+header_HEADERS		= crm.h cib.h msg_xml.h transition.h ais.h cib_util.h cib_ops.h stonith-ng.h
 
 SUBDIRS                 = common pengine
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm/ais.h
--- a/include/crm/ais.h	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm/ais.h	Mon Jul 12 18:48:04 2010 +0200
@@ -28,81 +28,11 @@
 
 #define AIS_IPC_MESSAGE_SIZE 8192*128
 
-#if SUPPORT_AIS
-#  ifdef AIS_COROSYNC
-#    include <corosync/corodefs.h>
-#    include <corosync/coroipcc.h>
-#    include <corosync/coroipc_types.h>
-#  endif
-#  ifdef AIS_WHITETANK 
-/* cheap hacks for building against the stable series of openais */
+#if SUPPORT_COROSYNC
 
-#    include <openais/saAis.h>
-
-enum service_types {
-	EVS_SERVICE = 0,
-	CLM_SERVICE = 1,
-	AMF_SERVICE = 2,
-	CKPT_SERVICE = 3,
-	EVT_SERVICE = 4,
-	LCK_SERVICE = 5,
-	MSG_SERVICE = 6,
-	CFG_SERVICE = 7,
-	CPG_SERVICE = 8
-};
-
-typedef struct {
-	int size; __attribute__((aligned(8))) 
-	int id __attribute__((aligned(8)));
-	SaAisErrorT error __attribute__((aligned(8)));
-} coroipc_response_header_t __attribute__((aligned(8)));
-
-typedef struct {
-	int size __attribute__((aligned(8)));
-	int id __attribute__((aligned(8)));
-} coroipc_request_header_t __attribute__((aligned(8)));
-
-#    ifdef TRADITIONAL_AIS_IPC
-extern SaAisErrorT saRecvRetry (int s, void *msg, size_t len);
-extern SaAisErrorT saServiceConnect (int *responseOut, int *callbackOut, enum service_types service);
-extern SaAisErrorT saSendReceiveReply (int s, void *requestMessage, int requestLen, void *responseMessage, int responseLen);
-#    else
-extern int openais_fd_get(void *ipc_context);
-extern int openais_dispatch_recv (void *ipc_context, void *buf, int timeout);
-extern SaAisErrorT openais_service_disconnect (void *ipc_context);
-extern SaAisErrorT openais_service_connect (enum service_types service, void **ipc_context);
-extern SaAisErrorT openais_msg_send_reply_receive (void *ipc_context, struct iovec *iov, int iov_len, void *res_msg, int res_len);
-#    endif
-
-#define CS_OK			SA_AIS_OK
-#define CS_ERR_LIBRARY		SA_AIS_ERR_LIBRARY
-#define CS_ERR_VERSION		SA_AIS_ERR_VERSION
-#define CS_ERR_INIT		SA_AIS_ERR_INIT
-#define CS_ERR_TIMEOUT		SA_AIS_ERR_TIMEOUT
-#define CS_ERR_TRY_AGAIN	SA_AIS_ERR_TRY_AGAIN
-#define CS_ERR_INVALID_PARAM	SA_AIS_ERR_INVALID_PARAM
-#define CS_ERR_NO_MEMORY	SA_AIS_ERR_NO_MEMORY
-#define CS_ERR_BAD_HANDLE	SA_AIS_ERR_BAD_HANDLE
-#define CS_ERR_BUSY		SA_AIS_ERR_BUSY
-#define CS_ERR_ACCESS		SA_AIS_ERR_ACCESS
-#define CS_ERR_NOT_EXIST	SA_AIS_ERR_NOT_EXIST
-#define CS_ERR_NAME_TOO_LONG	SA_AIS_ERR_NAME_TOO_LONG
-#define CS_ERR_EXIST		SA_AIS_ERR_EXIST
-#define CS_ERR_NO_SPACE		SA_AIS_ERR_NO_SPACE
-#define CS_ERR_INTERRUPT	SA_AIS_ERR_INTERRUPT
-#define CS_ERR_NAME_NOT_FOUND	SA_AIS_ERR_NAME_NOT_FOUND
-#define CS_ERR_NO_RESOURCES	SA_AIS_ERR_NO_RESOURCES
-#define CS_ERR_NOT_SUPPORTED	SA_AIS_ERR_NOT_SUPPORTED
-#define CS_ERR_BAD_OPERATION	SA_AIS_ERR_BAD_OPERATION
-#define CS_ERR_FAILED_OPERATION SA_AIS_ERR_FAILED_OPERATION
-#define CS_ERR_MESSAGE_ERROR	SA_AIS_ERR_MESSAGE_ERROR
-#define CS_ERR_QUEUE_FULL	SA_AIS_ERR_QUEUE_FULL
-#define CS_ERR_QUEUE_NOT_AVAILABLE SA_AIS_ERR_QUEUE_NOT_AVAILABLE
-#define CS_ERR_BAD_FLAGS	SA_AIS_ERR_BAD_FLAGS
-#define CS_ERR_TOO_BIG		SA_AIS_ERR_TOO_BIG
-#define CS_ERR_NO_SECTIONS	SA_AIS_ERR_NO_SECTIONS
-
-#  endif
+#  include <corosync/corodefs.h>
+#  include <corosync/coroipcc.h>
+#  include <corosync/coroipc_types.h>
 
 #else
 typedef struct {
@@ -117,8 +47,7 @@ typedef struct {
 } coroipc_response_header_t __attribute__((aligned(8)));
 #endif
 
-#define PCMK_SERVICE_ID         9
-#define CRM_MESSAGE_IPC_ACK     0
+#define CRM_MESSAGE_IPC_ACK	0
 
 #ifndef CRM_SERVICE
 #define CRM_SERVICE PCMK_SERVICE_ID
@@ -339,7 +268,7 @@ static inline AIS_Message *ais_msg_copy(
 static inline const char *ais_error2text(int error) 
 {
 	const char *text = "unknown";
-# if SUPPORT_AIS
+# if SUPPORT_COROSYNC
 	switch(error) {
 	    case CS_OK:
 		text = "None";
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm/common/cluster.h
--- a/include/crm/common/cluster.h	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm/common/cluster.h	Mon Jul 12 18:48:04 2010 +0200
@@ -45,6 +45,12 @@ extern gboolean crm_cluster_connect(
 #endif
     );
 
+extern gboolean init_cman_connection(
+    gboolean (*dispatch)(unsigned long long, gboolean), void (*destroy)(gpointer));
+    
+extern gboolean init_quorum_connection(
+    gboolean (*dispatch)(unsigned long long, gboolean), void (*destroy)(gpointer));
+
 extern gboolean send_cluster_message(
     const char *node, enum crm_ais_msg_types service, xmlNode *data, gboolean ordered);
 
@@ -53,6 +59,7 @@ extern void destroy_crm_node(gpointer da
 extern crm_node_t *crm_get_peer(unsigned int id, const char *uname);
 
 extern crm_node_t *crm_update_ais_node(xmlNode *member, long long seq);
+extern crm_node_t *crm_update_cman_node(xmlNode *member, long long seq);
 extern void crm_update_peer_proc(
     const char *uname, uint32_t flag, const char *status);
 extern crm_node_t *crm_update_peer(
@@ -60,6 +67,7 @@ extern crm_node_t *crm_update_peer(
     const char *uuid, const char *uname, const char *addr, const char *state);
 
 extern gboolean crm_is_member_active(const crm_node_t *node);
+extern gboolean crm_is_full_member(const crm_node_t *node);
 extern guint crm_active_members(void);
 extern guint reap_crm_member(uint32_t id);
 extern guint crm_active_members(void);
@@ -76,7 +84,7 @@ extern crm_node_t *crm_update_ccm_node(
     const oc_ev_membership_t *oc, int offset, const char *state, uint64_t seq);
 #endif
 
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 extern int ais_fd_sync;
 extern GFDSource *ais_source;
 extern gboolean send_ais_text(
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm/common/util.h
--- a/include/crm/common/util.h	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm/common/util.h	Mon Jul 12 18:48:04 2010 +0200
@@ -84,12 +84,21 @@ struct crm_option
 #define crm_config_err(fmt...) { crm_config_error = TRUE; crm_err(fmt); }
 #define crm_config_warn(fmt...) { crm_config_warning = TRUE; crm_warn(fmt); }
 
+
 extern void crm_log_deinit(void);
 
 extern gboolean crm_log_init(
     const char *entity, int level, gboolean coredir, gboolean to_stderr,
     int argc, char **argv);
 
+extern gboolean crm_log_init_quiet(
+    const char *entity, int level, gboolean coredir, gboolean to_stderr,
+    int argc, char **argv);
+
+extern gboolean crm_log_init_worker(
+    const char *entity, int level, gboolean coredir, gboolean to_stderr,
+    int argc, char **argv, gboolean quiet);
+
 /* returns the old value */
 extern unsigned int set_crm_log_level(unsigned int level);
 
@@ -248,7 +257,23 @@ is_set_any(long long word, long long bit
 	return ((word & bit) != 0);
 }
 
+enum cluster_type_e 
+{
+    pcmk_cluster_unknown     = 0x0001,
+    pcmk_cluster_invalid     = 0x0002,
+    pcmk_cluster_heartbeat   = 0x0004,
+    pcmk_cluster_classic_ais = 0x0010,
+    pcmk_cluster_corosync    = 0x0020,
+    pcmk_cluster_cman        = 0x0040,
+};
+
+extern enum cluster_type_e get_cluster_type(void);
+extern const char *name_for_cluster_type(enum cluster_type_e type);
+
+extern gboolean is_corosync_cluster(void);
+extern gboolean is_cman_cluster(void);
 extern gboolean is_openais_cluster(void);
+extern gboolean is_classic_ais_cluster(void);
 extern gboolean is_heartbeat_cluster(void);
 
 extern xmlNode *cib_recv_remote_msg(void *session, gboolean encrypted);
@@ -271,5 +296,6 @@ extern int node_score_infinity;
 
 #include <lrm/lrm_api.h>
 extern xmlNode *create_operation_update(xmlNode *parent, lrm_op_t *op, const char *caller_version, int target_rc, const char *origin, int level);
+extern void free_lrm_op(lrm_op_t *op);
 
 #endif
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm/common/xml.h
--- a/include/crm/common/xml.h	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm/common/xml.h	Mon Jul 12 18:48:04 2010 +0200
@@ -254,7 +254,21 @@ extern const char *get_schema_name(int v
 	    const char *prop_value = NULL;				\
 	    while(prop_iter != NULL) {					\
 		prop_name = (const char *)prop_iter->name;		\
-		prop_value = crm_element_value(parent, prop_name);\
+		prop_value = crm_element_value(parent, prop_name);	\
+		prop_iter = prop_iter->next;				\
+		if(prop_name) {						\
+		    code;						\
+		}							\
+	    }								\
+	}								\
+    } while(0)
+
+#  define xml_prop_name_iter(parent, prop_name, code) do {		\
+	if(parent != NULL) {						\
+	    xmlAttrPtr prop_iter = parent->properties;			\
+	    const char *prop_name = NULL;				\
+	    while(prop_iter != NULL) {					\
+		prop_name = (const char *)prop_iter->name;		\
 		prop_iter = prop_iter->next;				\
 		if(prop_name) {						\
 		    code;						\
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm/msg_xml.h
--- a/include/crm/msg_xml.h	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm/msg_xml.h	Mon Jul 12 18:48:04 2010 +0200
@@ -32,6 +32,8 @@
 #define F_CRM_ORIGIN			"origin"
 #define F_CRM_JOIN_ID			"join_id"
 #define F_CRM_ELECTION_ID		"election-id"
+#define F_CRM_ELECTION_AGE_S		"election-age-sec"
+#define F_CRM_ELECTION_AGE_US		"election-age-nano-sec"
 #define F_CRM_ELECTION_OWNER		"election-owner"
 #define F_CRM_TGRAPH			"crm-tgraph"
 #define F_CRM_TGRAPH_INPUT		"crm-tgraph-in"
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm/stonith-ng.h
--- a/include/crm/stonith-ng.h	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm/stonith-ng.h	Mon Jul 12 18:48:04 2010 +0200
@@ -101,6 +101,7 @@ enum stonith_errors {
 #define STONITH_OP_EXEC		"st_execute"
 #define STONITH_OP_QUERY	"st_query"
 #define STONITH_OP_FENCE	"st_fence"
+#define STONITH_OP_CONFIRM	"st_confirm"
 #define STONITH_OP_DEVICE_ADD	"st_device_register"
 #define STONITH_OP_DEVICE_DEL	"st_device_remove"
 #define STONITH_OP_DEVICE_METADATA "st_device_metadata"
@@ -129,6 +130,7 @@ typedef struct stonith_api_operations_s
 
 	int (*query)(stonith_t *st, int options, const char *node, GListPtr *devices, int timeout);
 	int (*fence)(stonith_t *st, int options, const char *node, GHashTable *parameters, const char *action, int timeout);
+	int (*confirm)(stonith_t *st, int options, const char *node);
 		
 	int (*register_notification)(
 	    stonith_t *st, const char *event,
diff -r f059ec7ced7a -r b230ffa2ecdc include/crm_config.h.in
--- a/include/crm_config.h.in	Mon May 17 17:57:40 2010 +0200
+++ b/include/crm_config.h.in	Mon Jul 12 18:48:04 2010 +0200
@@ -60,18 +60,15 @@
 /* Support the Heartbeat messaging and membership layer */
 #undef SUPPORT_HEARTBEAT
 
-/* Support the OpenAIS messaging and membership layer */
+/* Support the Corosync messaging and membership layer */
+#undef SUPPORT_COROSYNC
+
+/* Compatability alias for SUPPORT_COROSYNC */
 #undef SUPPORT_AIS
 
-/* AIS target is the whitetank series */
-#undef AIS_WHITETANK
-
-/* AIS target is the corosync series */
+/* Compatability alias for SUPPORT_COROSYNC */
 #undef AIS_COROSYNC
 
-/* AIS target is the latest development series */
-#undef AIS_TRUNK
-
 /* Correct printf format for logging uint64_t */
 #undef U64T
 
diff -r f059ec7ced7a -r b230ffa2ecdc lib/Makefile.am
--- a/lib/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/lib/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -21,7 +21,7 @@ MAINTAINERCLEANFILES    = Makefile.in
 SUBDIRS	= common pengine transition cib fencing plugins
 DIST_SUBDIRS =  $(SUBDIRS) ais
 
-if BUILD_AIS_SUPPORT
+if BUILD_CS_SUPPORT
 SUBDIRS			+= ais
 endif
 
diff -r f059ec7ced7a -r b230ffa2ecdc lib/ais/plugin.c
--- a/lib/ais/plugin.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/ais/plugin.c	Mon Jul 12 18:48:04 2010 +0200
@@ -31,11 +31,9 @@
 #include <signal.h>
 #include <string.h>
 
-#ifdef AIS_COROSYNC
-#  include <corosync/totem/totempg.h>
-#  include <corosync/engine/objdb.h>
-#  include <corosync/engine/config.h>
-#endif
+#include <corosync/totem/totempg.h>
+#include <corosync/engine/objdb.h>
+#include <corosync/engine/config.h>
 
 #include <config.h>
 #include <crm/ais.h>
@@ -71,6 +69,7 @@ static uint64_t local_born_on = 0;
 uint64_t membership_seq = 0;
 pthread_t pcmk_wait_thread;
 
+gboolean use_mcp = FALSE;
 gboolean wait_active = TRUE;
 gboolean have_reliable_membership_id = FALSE;
 GHashTable *ipc_client_list = NULL;
@@ -112,7 +111,6 @@ int send_cluster_msg_raw(const AIS_Messa
 char *pcmk_generate_membership_data(void);
 gboolean check_message_sanity(const AIS_Message *msg, const char *data);
 
-#ifdef AIS_COROSYNC
 typedef const void ais_void_ptr;
 int pcmk_shutdown(void);
 void pcmk_peer_update(enum totem_configuration_type configuration_type,
@@ -120,17 +118,6 @@ void pcmk_peer_update(enum totem_configu
 		      const unsigned int *left_list, size_t left_list_entries,
 		      const unsigned int *joined_list, size_t joined_list_entries,
 		      const struct memb_ring_id *ring_id);
-#else
-
-typedef void ais_void_ptr;
-extern totempg_groups_handle openais_group_handle;
-int pcmk_shutdown(struct objdb_iface_ver0 *objdb);
-void pcmk_peer_update(enum totem_configuration_type configuration_type,
-		      unsigned int *member_list, int member_list_entries,
-		      unsigned int *left_list, int left_list_entries,
-		      unsigned int *joined_list, int joined_list_entries,
-		      struct memb_ring_id *ring_id);
-#endif
 
 int pcmk_startup (struct corosync_api_v1 *corosync_api);
 int pcmk_config_init(struct corosync_api_v1 *corosync_api);
@@ -157,6 +144,11 @@ static uint32_t get_process_list(void)
 {
     int lpc = 0;
     uint32_t procs = crm_proc_ais;
+
+    if(use_mcp) {
+	return 0;
+    }
+    
     for (lpc = 0; lpc < SIZEOF(pcmk_children); lpc++) {
 	if(pcmk_children[lpc].pid != 0) {
 	    procs |= pcmk_children[lpc].flag;
@@ -165,56 +157,31 @@ static uint32_t get_process_list(void)
     return procs;
 }
 
-
 static struct corosync_lib_handler pcmk_lib_service[] =
 {
     { /* 0 */
 	.lib_handler_fn		= pcmk_ipc,
 	.flow_control		= COROSYNC_LIB_FLOW_CONTROL_NOT_REQUIRED,
-#ifdef AIS_WHITETANK
-	.response_size		= sizeof (coroipc_response_header_t),
-	.response_id		= CRM_MESSAGE_IPC_ACK,
-#endif
     },
     { /* 1 */
 	.lib_handler_fn		= pcmk_nodes,
 	.flow_control		= COROSYNC_LIB_FLOW_CONTROL_NOT_REQUIRED,
-#ifdef AIS_WHITETANK
-	.response_size		= sizeof (coroipc_response_header_t),
-	.response_id		= CRM_MESSAGE_IPC_ACK,
-#endif
     },
     { /* 2 */
 	.lib_handler_fn		= pcmk_notify,
 	.flow_control		= COROSYNC_LIB_FLOW_CONTROL_NOT_REQUIRED,
-#ifdef AIS_WHITETANK
-	.response_size		= sizeof (coroipc_response_header_t),
-	.response_id		= CRM_MESSAGE_IPC_ACK,
-#endif
     },
     { /* 3 */
 	.lib_handler_fn		= pcmk_nodeid,
 	.flow_control		= COROSYNC_LIB_FLOW_CONTROL_NOT_REQUIRED,
-#ifdef AIS_WHITETANK
-	.response_size		= sizeof (struct crm_ais_nodeid_resp_s),
-	.response_id		= crm_class_nodeid,
-#endif
     },
     { /* 4 */
 	.lib_handler_fn		= pcmk_remove_member,
 	.flow_control		= COROSYNC_LIB_FLOW_CONTROL_NOT_REQUIRED,
-#ifdef AIS_WHITETANK
-	.response_size		= sizeof (coroipc_response_header_t),
-	.response_id		= CRM_MESSAGE_IPC_ACK,
-#endif
     },
     { /* 5 */
 	.lib_handler_fn		= pcmk_quorum,
 	.flow_control		= COROSYNC_LIB_FLOW_CONTROL_NOT_REQUIRED,
-#ifdef AIS_WHITETANK
-	.response_size		= sizeof (coroipc_response_header_t),
-	.response_id		= CRM_MESSAGE_IPC_ACK,
-#endif
     },
 };
 
@@ -238,23 +205,17 @@ struct corosync_service_engine pcmk_serv
     .id				= PCMK_SERVICE_ID,
     .private_data_size		= 0,
     .flow_control		= COROSYNC_LIB_FLOW_CONTROL_NOT_REQUIRED, 
+    .allow_inquorate		= CS_LIB_ALLOW_INQUORATE,
     .lib_init_fn		= pcmk_ipc_connect,
     .lib_exit_fn		= pcmk_ipc_exit,
     .exec_init_fn		= pcmk_startup,
     .exec_exit_fn		= pcmk_shutdown,
     .config_init_fn		= pcmk_config_init,
-#ifdef AIS_COROSYNC
     .priority			= 50,    
     .lib_engine			= pcmk_lib_service,
     .lib_engine_count		= sizeof (pcmk_lib_service) / sizeof (struct corosync_lib_handler),
     .exec_engine		= pcmk_exec_service,
     .exec_engine_count		= sizeof (pcmk_exec_service) / sizeof (struct corosync_exec_handler),
-#else
-    .lib_service		= pcmk_lib_service,
-    .lib_service_count		= sizeof (pcmk_lib_service) / sizeof (struct corosync_lib_handler),
-    .exec_service		= pcmk_exec_service,
-    .exec_service_count		= sizeof (pcmk_exec_service) / sizeof (struct corosync_exec_handler),
-#endif
     .confchg_fn			= pcmk_peer_update,
     .exec_dump_fn		= pcmk_exec_dump,
 /* 	void (*sync_init) (void); */
@@ -269,17 +230,11 @@ struct corosync_service_engine pcmk_serv
  */
 struct corosync_service_engine *pcmk_get_handler_ver0 (void);
 
-#ifdef AIS_COROSYNC
 struct corosync_service_engine_iface_ver0 pcmk_service_handler_iface = {
     .corosync_get_service_engine_ver0 = pcmk_get_handler_ver0
 };
-#else
-struct openais_service_handler_iface_ver0 pcmk_service_handler_iface = {
-    .openais_get_service_handler_ver0 = pcmk_get_handler_ver0
-};
-#endif
 
-static struct lcr_iface openais_pcmk_ver0[1] = {
+static struct lcr_iface openais_pcmk_ver0[2] = {
     {
 	.name				= "pacemaker",
 	.version			= 0,
@@ -290,11 +245,22 @@ static struct lcr_iface openais_pcmk_ver
 	.constructor			= NULL,
 	.destructor			= NULL,
 	.interfaces			= NULL
+    },
+    {
+	.name				= "pacemaker",
+	.version			= 1,
+	.versions_replace		= 0,
+	.versions_replace_count		= 0,
+	.dependencies			= 0,
+	.dependency_count		= 0,
+	.constructor			= NULL,
+	.destructor			= NULL,
+	.interfaces			= NULL
     }
 };
 
 static struct lcr_comp pcmk_comp_ver0 = {
-    .iface_count				= 1,
+    .iface_count				= 2,
     .ifaces					= openais_pcmk_ver0
 };
 
@@ -305,6 +271,7 @@ struct corosync_service_engine *pcmk_get
 
 __attribute__ ((constructor)) static void register_this_component (void) {
     lcr_interfaces_set (&openais_pcmk_ver0[0], &pcmk_service_handler_iface);
+    lcr_interfaces_set (&openais_pcmk_ver0[1], &pcmk_service_handler_iface);
 
     lcr_component_register (&pcmk_comp_ver0);
 }
@@ -365,25 +332,25 @@ static void process_ais_conf(void)
 	    uid_t pcmk_uid = geteuid();
 	    uid_t pcmk_gid = getegid();
 
-	    pcmk_env.logfile = value;
+	    FILE *logfile = fopen(value, "a");
+	    if(logfile) {
+		int logfd = fileno(logfile);
 
-	    if(pcmk_uid >= 0 && pcmk_gid >= 0) {
+		pcmk_env.logfile = value;
+	
 		/* Ensure the file has the correct permissions */
-		FILE *logfile = fopen(value, "a");
-		int logfd = fileno(logfile);
-		
 		fchown(logfd, pcmk_uid, pcmk_gid);
 		fchmod(logfd, S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP);
 		
 		fprintf(logfile, "Set r/w permissions for uid=%d, gid=%d on %s\n",
 			pcmk_uid, pcmk_gid, value);
 		fflush(logfile);
-		fsync(fileno(logfile));
+		fsync(logfd);
 		fclose(logfile);
 		any_log = TRUE;
 
 	    } else {
-		ais_err("Couldn't setup correct logfile permissions, some logs may be lost");
+		ais_err("Couldn't create logfile: %s", value);
 	    }
 	}
     }
@@ -403,6 +370,13 @@ static void process_ais_conf(void)
     pcmk_env.syslog = value;
 
     config_find_done(pcmk_api, local_handle);
+
+    top_handle = config_find_init(pcmk_api, "quorum");
+    local_handle = config_find_next(pcmk_api, "quorum", top_handle);
+    get_config_opt(pcmk_api, local_handle, "provider", &value, NULL);
+    if(value && ais_str_eq("quorum_cman", value)) {
+	pcmk_env.quorum = "cman";
+    }
     
     top_handle = config_find_init(pcmk_api, "service");
     local_handle = config_find_next(pcmk_api, "service", top_handle);
@@ -415,6 +389,12 @@ static void process_ais_conf(void)
 	local_handle = config_find_next(pcmk_api, "service", top_handle);
     }
 
+    get_config_opt(pcmk_api, local_handle, "ver", &value, "0");
+    if(ais_str_eq(value, "1")) {
+	ais_info("Enabling MCP mode: Use the Pacemaker init script to complete Pacemaker startup");
+	use_mcp = TRUE;
+    }
+    
     get_config_opt(pcmk_api, local_handle, "clustername", &local_cname, "pcmk");
     local_cname_len = strlen(local_cname);
     
@@ -498,9 +478,8 @@ static void *pcmk_wait_dispatch (void *a
 		    ais_notice("Respawning failed child process: %s",
 			       pcmk_children[lpc].name);
 		    spawn_child(&(pcmk_children[lpc]));
-		} else {
-		    send_cluster_id();
 		}
+		send_cluster_id();
 	    }
 	}
 	sched_yield ();
@@ -512,11 +491,7 @@ static void *pcmk_wait_dispatch (void *a
 static uint32_t pcmk_update_nodeid(void)  
 {
     int last = local_nodeid;
-#if AIS_COROSYNC
     local_nodeid = pcmk_api->totem_nodeid_get();
-#else
-    local_nodeid = totempg_my_nodeid_get();
-#endif
 
     if(last != local_nodeid) {
 	if(last == 0) {
@@ -576,10 +551,6 @@ int pcmk_startup(struct corosync_api_v1 
 
     pcmk_api = init_with;
 
-#ifdef AIS_WHITETANK 
-    log_init ("crm");
-#endif
-
     pcmk_env.debug    = "0";
     pcmk_env.logfile  = NULL;
     pcmk_env.use_logd = "false";
@@ -652,6 +623,7 @@ int pcmk_startup(struct corosync_api_v1 
     ais_info("Local hostname: %s", local_uname);
     pcmk_update_nodeid();    
     
+  if(use_mcp == FALSE) {
     pthread_create (&pcmk_wait_thread, NULL, pcmk_wait_dispatch, NULL);
     for (start_seq = 1; start_seq < max; start_seq++) {
 	/* dont start anything with start_seq < 1 */
@@ -661,7 +633,7 @@ int pcmk_startup(struct corosync_api_v1 
 	    }
 	}
     }
-    
+  }
     return 0;
 }
 
@@ -724,17 +696,10 @@ static void ais_mark_unseen_peer_dead(
 
 void pcmk_peer_update (
     enum totem_configuration_type configuration_type,
-#ifdef AIS_COROSYNC 
     const unsigned int *member_list, size_t member_list_entries,
     const unsigned int *left_list, size_t left_list_entries,
     const unsigned int *joined_list, size_t joined_list_entries,
     const struct memb_ring_id *ring_id
-#else
-    unsigned int *member_list, int member_list_entries,
-    unsigned int *left_list, int left_list_entries,
-    unsigned int *joined_list, int joined_list_entries,
-    struct memb_ring_id *ring_id
-#endif
     )
 {
     int lpc = 0;
@@ -973,11 +938,7 @@ static void send_ipc_ack(void *conn)
     res_overlay->header.id = CRM_MESSAGE_IPC_ACK;
     res_overlay->header.size = sizeof (coroipc_response_header_t);
     res_overlay->header.error = CS_OK;
-#ifdef AIS_COROSYNC
     pcmk_api->ipc_response_send (conn, res_overlay, res_overlay->header.size);
-#else
-    openais_response_send (conn, res_overlay, res_overlay->header.size);
-#endif
 }
 
 
@@ -1019,12 +980,15 @@ void pcmk_ipc(void *conn, ais_void_ptr *
 	transient = FALSE;
     }
     
+#if 0
     /* If this check fails, the order of pcmk_children probably 
      *   doesn't match that of the crm_ais_msg_types enum
      */
     AIS_CHECK(transient || mutable->sender.pid == pcmk_children[type].pid,
 	      ais_err("Sender: %d, child[%d]: %d", mutable->sender.pid, type, pcmk_children[type].pid);
+	      ais_free(mutable);
 	      return);
+#endif
     
     if(transient == FALSE
        && type > crm_msg_none
@@ -1064,19 +1028,26 @@ void pcmk_ipc(void *conn, ais_void_ptr *
     ais_free(mutable);
 }
 
-int pcmk_shutdown (
-#ifdef AIS_COROSYNC
-    void
-#else
-    struct objdb_iface_ver0 *objdb
-#endif
-    )
+int pcmk_shutdown (void)
 {
     int lpc = 0;
     static int phase = 0;
     static int max_wait = 0;
     static time_t next_log = 0;
     static int max = SIZEOF(pcmk_children);
+
+    if(use_mcp) {
+	if(pcmk_children[crm_msg_crmd].conn || pcmk_children[crm_msg_stonith_ng].conn) {
+	    time_t now = time(NULL);
+	    if(now > next_log) {
+		next_log = now + 300;
+		ais_notice("Preventing Corosync shutdown.  Please ensure Pacemaker is stopped first.");
+	    }
+	    return -1;
+	}
+	ais_notice("Unloading Pacemaker plugin");    
+	return 0;
+    }
     
     if(phase == 0) {
 	ais_notice("Shuting down Pacemaker");    
@@ -1093,10 +1064,6 @@ int pcmk_shutdown (
 		continue;
 	    }
 		
-#ifdef AIS_WHITETANK
-	  retry:
-#endif
-	    
 	    if(pcmk_children[lpc].pid) {
 		pid_t pid = 0;
 		int status = 0;
@@ -1125,21 +1092,8 @@ int pcmk_shutdown (
 			    stop_child(&(pcmk_children[lpc]), SIGKILL);
 			}
 		    }		    
-#ifdef AIS_WHITETANK
-		    {
-			struct timespec waitsleep = {
-			    .tv_sec = 1,
-			    .tv_nsec = 0
-			};
-			
-			sched_yield ();
-			nanosleep (&waitsleep, 0);
-			goto retry;
-		    }
-#else
 		    /* Return control to corosync */
 		    return -1;
-#endif
 		}
 	    }
 	    
@@ -1155,19 +1109,6 @@ int pcmk_shutdown (
     ais_notice("Shutdown complete");
     /* TODO: Add back the logsys flush call once its written */
     
-#ifdef AIS_WHITETANK
-    /* Bug bnc#482847, bnc#482905
-     *
-     * All cluster services are now down, we could allow OpenAIS to continue
-     * unloading plugins, but its kinda new at that and there are a bunch of
-     * race conditions that get exercised.
-     *
-     * Take the easy way out for now (on whitetank) and eventually fix for
-     * CoroSync which is where everyone wants to be eventually anyway
-     */
-    ais_notice("Forcing clean exit of OpenAIS");
-    exit(0);
-#endif
     return 0;
 }
 
@@ -1330,11 +1271,7 @@ void pcmk_nodeid(void *conn, ais_void_pt
     memset(resp.cname, 0, MAX_NAME);
     memcpy(resp.cname, local_cname, local_cname_len);
     
-#ifdef AIS_COROSYNC
     pcmk_api->ipc_response_send (conn, &resp, resp.header.size);
-#else
-    openais_response_send (conn, &resp, resp.header.size);
-#endif
 }
 
 static gboolean
@@ -1580,11 +1517,7 @@ int send_cluster_msg_raw(const AIS_Messa
     iovec.iov_len = mutable->header.size;
 
     ais_debug_3("Sending message (size=%u)", (unsigned int)iovec.iov_len);
-#if AIS_COROSYNC
     rc = pcmk_api->totem_mcast(&iovec, 1, TOTEMPG_SAFE);
-#else
-    rc = totempg_groups_mcast_joined(openais_group_handle, &iovec, 1, TOTEMPG_SAFE);
-#endif
 
     if(rc == 0 && mutable->is_compressed == FALSE) {
 	ais_debug_2("Message sent: %.80s", mutable->data);
@@ -1659,11 +1592,7 @@ void send_cluster_id(void)
     iovec.iov_base = (char *)msg;
     iovec.iov_len = msg->header.size;
     
-#if AIS_COROSYNC
     rc = pcmk_api->totem_mcast(&iovec, 1, TOTEMPG_SAFE);
-#else
-    rc = totempg_groups_mcast_joined(openais_group_handle, &iovec, 1, TOTEMPG_SAFE);
-#endif
 
     AIS_CHECK(rc == 0, ais_err("Message not sent (%d)", rc));
 
diff -r f059ec7ced7a -r b230ffa2ecdc lib/ais/utils.c
--- a/lib/ais/utils.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/ais/utils.c	Mon Jul 12 18:48:04 2010 +0200
@@ -122,6 +122,14 @@ gboolean spawn_child(crm_child_t *child)
 	use_valgrind = FALSE;
     }
 
+    if(child->uid) {
+	if(pcmk_user_lookup(child->uid, &uid, NULL) < 0) {
+	    ais_err("Invalid uid (%s) specified for %s",
+		    child->uid, child->name);
+	    return FALSE;
+	}
+    }
+	
     child->pid = fork();
     AIS_ASSERT(child->pid != -1);
 
@@ -143,14 +151,6 @@ gboolean spawn_child(crm_child_t *child)
 	}
 #endif
 
-	if(child->uid) {
-	    if(pcmk_user_lookup(child->uid, &uid, NULL) < 0) {
-		ais_err("Invalid uid (%s) specified for %s",
-			child->uid, child->name);
-		return TRUE;
-	    }
-	}
-	
 	if(uid && setuid(uid) < 0) {
 	    ais_perror("Could not set user to %d (%s)", uid, child->uid);
 	}
@@ -171,6 +171,8 @@ gboolean spawn_child(crm_child_t *child)
 	setenv("HA_logfacility",	pcmk_env.syslog,   1);
 	setenv("HA_LOGFACILITY",	pcmk_env.syslog,   1);
 	setenv("HA_use_logd",		pcmk_env.use_logd, 1);
+	setenv("HA_quorum_type",	pcmk_env.quorum,   1);
+    
 	if(pcmk_env.logfile) {
 	    setenv("HA_debugfile", pcmk_env.logfile, 1);
 	}
@@ -183,7 +185,7 @@ gboolean spawn_child(crm_child_t *child)
 	ais_perror("FATAL: Cannot exec %s", child->command);
 	exit(100);
     }
-    return TRUE; /* never reached */
+    return TRUE;
 }
 
 gboolean
@@ -245,6 +247,7 @@ int update_member(unsigned int id, uint6
 	g_hash_table_insert(membership_list, GUINT_TO_POINTER(id), node);
 	node = g_hash_table_lookup(membership_list, GUINT_TO_POINTER(id));
     }
+    AIS_ASSERT(node != NULL);
 
     if(seq != 0) {
 	node->last_seen = seq;
@@ -295,7 +298,6 @@ int update_member(unsigned int id, uint6
 	}
     }
     
-    AIS_ASSERT(node != NULL);
     return changed;
 }
 
@@ -429,8 +431,10 @@ int send_cluster_msg(
     ais_msg->header.id = 0;
     
     ais_msg->size = data_len;
-    memcpy(ais_msg->data, data, data_len);
     ais_msg->sender.type = crm_msg_ais;
+    if(data != NULL) {
+	memcpy(ais_msg->data, data, data_len);
+    }
 
     ais_msg->host.type = type;
     ais_msg->host.id = 0;
@@ -468,10 +472,7 @@ int send_client_ipc(void *conn, const AI
 /* 	    ais_err("Connection is throttled: %d", queue->size); */
 
     } else {
-#ifdef AIS_WHITETANK
-	rc = openais_dispatch_send (conn, (void*)ais_msg, ais_msg->header.size);
-#endif
-#ifdef AIS_COROSYNC
+#ifdef SUPPORT_COROSYNC
 	rc = pcmk_api->ipc_dispatch_send (conn, ais_msg, ais_msg->header.size);
 #endif
     }
@@ -505,7 +506,9 @@ int send_client_msg(
     ais_msg->header.error = CS_OK;
     
     ais_msg->size = data_len;
-    memcpy(ais_msg->data, data, data_len);
+    if(data != NULL) {
+	memcpy(ais_msg->data, data, data_len);
+    }
     
     ais_msg->host.size = 0;
     ais_msg->host.type = type;
@@ -548,14 +551,11 @@ ais_concat(const char *prefix, const cha
 hdb_handle_t config_find_init(struct corosync_api_v1 *config, char *name) 
 {
     hdb_handle_t local_handle = 0;
-#ifdef AIS_COROSYNC
+#ifdef SUPPORT_COROSYNC
     config->object_find_create(OBJECT_PARENT_HANDLE, name, strlen(name), &local_handle);
     ais_info("Local handle: %lld for %s", local_handle, name);
 #endif
     
-#ifdef AIS_WHITETANK 
-    config->object_find_reset (OBJECT_PARENT_HANDLE);
-#endif
     return local_handle;
 }
 
@@ -564,14 +564,10 @@ hdb_handle_t config_find_next(struct cor
     int rc = 0;
     hdb_handle_t local_handle = 0;
 
-#ifdef AIS_COROSYNC
+#ifdef SUPPORT_COROSYNC
     rc = config->object_find_next (top_handle, &local_handle);
 #endif
     
-#ifdef AIS_WHITETANK 
-    rc = config->object_find(OBJECT_PARENT_HANDLE, name, strlen (name), &local_handle);
-#endif
-
     if(rc < 0) {
 	ais_info("No additional configuration supplied for: %s", name);
 	local_handle = 0;
@@ -583,7 +579,7 @@ hdb_handle_t config_find_next(struct cor
 
 void config_find_done(struct corosync_api_v1 *config, hdb_handle_t local_handle) 
 {
-#ifdef AIS_COROSYNC
+#ifdef SUPPORT_COROSYNC
     config->object_find_destroy (local_handle);
 #endif
 }
diff -r f059ec7ced7a -r b230ffa2ecdc lib/ais/utils.h
--- a/lib/ais/utils.h	Mon May 17 17:57:40 2010 +0200
+++ b/lib/ais/utils.h	Mon Jul 12 18:48:04 2010 +0200
@@ -47,7 +47,7 @@ extern int openais_dispatch_send (void *
 
 #endif
 
-#ifdef AIS_COROSYNC
+#ifdef SUPPORT_COROSYNC
 #  include <corosync/corodefs.h>
 #  include <corosync/coroipc_types.h>
 #  include <corosync/swab.h>
@@ -226,6 +226,7 @@ struct pcmk_env_s
 	const char *syslog;
 	const char *logfile;
 	const char *use_logd;
+	const char *quorum;
 };
 
 extern struct pcmk_env_s pcmk_env;
diff -r f059ec7ced7a -r b230ffa2ecdc lib/cib/cib_file.c
--- a/lib/cib/cib_file.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/cib/cib_file.c	Mon Jul 12 18:48:04 2010 +0200
@@ -197,13 +197,17 @@ cib_file_free (cib_t* cib)
 
     if(cib->state != cib_disconnected) {
 	rc = cib_file_signoff(cib);
-	if(rc == cib_ok) {
-	    cib_file_opaque_t *private = cib->variant_opaque;
-	    crm_free(private->filename);
-	    crm_free(cib->cmds);
-	    crm_free(private);
-	    crm_free(cib);
-	}
+    }
+    
+    if(rc == cib_ok) {
+	cib_file_opaque_t *private = cib->variant_opaque;
+	crm_free(private->filename);
+	crm_free(cib->cmds);
+	crm_free(private);
+	crm_free(cib);
+
+    } else {
+	fprintf(stderr, "Couldn't sign off: %d\n", rc);
     }
 	
     return rc;
@@ -297,7 +301,9 @@ cib_file_perform_op(
 	*output_data = copy_xml(output);
     }
 
-    if(query == FALSE) {
+    if(query == FALSE || (call_options & cib_no_children)) {
+	free_xml(output);
+    } else if(safe_str_eq(crm_element_name(output), "xpath-query")) {
 	free_xml(output);
     }
     
diff -r f059ec7ced7a -r b230ffa2ecdc lib/cib/cib_ops.c
--- a/lib/cib/cib_ops.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/cib/cib_ops.c	Mon Jul 12 18:48:04 2010 +0200
@@ -101,12 +101,11 @@ cib_process_upgrade(
     int new_version = 0;
     int current_version = 0;
 
-    const char *value = NULL;
+    const char *value = crm_element_value(existing_cib, XML_ATTR_VALIDATION);;
 
     *answer = NULL;
     crm_debug_2("Processing \"%s\" event", op);
     
-    value = crm_element_value_copy(existing_cib, XML_ATTR_VALIDATION);
     if(value != NULL) {
 	current_version = get_schema_version(value);
     }
@@ -589,14 +588,12 @@ cib_process_diff(
 			crm_log_xml_warn(input, "Bad global update");
 			
 		} else if(diff_add_admin_epoch == -1 && diff_add_epoch == -1 && diff_add_updates == -1) {
-			crm_err("Massaging diff versions");
 			diff_add_epoch = this_epoch;
 			diff_add_updates = this_updates + 1;
 			diff_add_admin_epoch = this_admin_epoch;
 			diff_del_epoch = this_epoch;
 			diff_del_updates = this_updates;
 			diff_del_admin_epoch = this_admin_epoch;
-			crm_log_xml_err(input, __FUNCTION__);
 
 		} else {
 			apply_diff = FALSE;
@@ -802,7 +799,7 @@ cib_config_changed(xmlNode *last, xmlNod
 	int lpc = 0, max = xpathObj->nodesetval->nodeNr;
 	for(lpc = 0; lpc < max; lpc++) {
 	    xmlNode *top = getXpathResult(xpathObj, lpc);
-	    xml_prop_iter(top, name, value,
+	    xml_prop_name_iter(top, name,
 			  if(crm_str_eq(XML_ATTR_NUMUPDATES, name, TRUE) == FALSE) {
 			      config_changes = TRUE;
 			      goto done;
@@ -930,16 +927,15 @@ cib_process_xpath(
 	
 	if(safe_str_eq(op, CIB_OP_DELETE)) {
 	    free_xml_from_parent(NULL, match);
-	    break;
-
+	    if((options & cib_multiple) == 0) {
+		break;
+	    }
+	    
 	} else if(safe_str_eq(op, CIB_OP_MODIFY)) {
 	    if(update_xml_child(match, input) == FALSE) {
 		rc = cib_NOTEXISTS;		
-	    } else {
-		rc = cib_ok;
-		if((options & cib_multiple) == 0) {
-		    break;
-		}
+	    } else if((options & cib_multiple) == 0) {
+		break;
 	    }
 	    
 	} else if(safe_str_eq(op, CIB_OP_CREATE)) {
@@ -950,9 +946,12 @@ cib_process_xpath(
 
 	    if(options & cib_no_children) {
 		const char *tag = TYPE(match);
-		*answer = create_xml_node(NULL, tag);
-		copy_in_properties(*answer, match);
-		break;
+		xmlNode *shallow = create_xml_node(*answer, tag);
+		copy_in_properties(shallow, match);
+
+		if(*answer == NULL) {
+		    *answer = shallow;
+		}
 		
 	    } else if(*answer) {
 		add_node_copy(*answer, match);
diff -r f059ec7ced7a -r b230ffa2ecdc lib/cib/cib_utils.c
--- a/lib/cib/cib_utils.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/cib/cib_utils.c	Mon Jul 12 18:48:04 2010 +0200
@@ -378,10 +378,11 @@ gboolean
 cib_version_details(
 	xmlNode *cib, int *admin_epoch, int *epoch, int *updates)
 {
+	*epoch  = -1;
+	*updates = -1;
+	*admin_epoch = -1;
+
 	if(cib == NULL) {
-	    *admin_epoch = -1;
-	    *epoch  = -1;
-	    *updates = -1;
 	    return FALSE;
 		
 	} else {
@@ -445,7 +446,7 @@ get_object_root(const char *object_type,
 	return the_root; /* or return NULL? */
     }
 
-    return get_xpath_object(xpath, the_root, LOG_DEBUG_2);
+    return get_xpath_object(xpath, the_root, LOG_DEBUG_4);
 }
 
 xmlNode*
@@ -499,12 +500,12 @@ create_cib_fragment_adv(
 xmlNode*
 createEmptyCib(void)
 {
-	xmlNode *cib_root = NULL, *config = NULL, *status = NULL;
+	xmlNode *cib_root = NULL, *config = NULL;
 	
 	cib_root = create_xml_node(NULL, XML_TAG_CIB);
 
 	config = create_xml_node(cib_root, XML_CIB_TAG_CONFIGURATION);
-	status = create_xml_node(cib_root, XML_CIB_TAG_STATUS);
+	create_xml_node(cib_root, XML_CIB_TAG_STATUS);
 
 /* 	crm_xml_add(cib_root, "version", "1"); */
 	create_xml_node(config, XML_CIB_TAG_CRMCONFIG);
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/Makefile.am
--- a/lib/common/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -29,7 +29,7 @@ lib_LTLIBRARIES	= libcrmcommon.la libcrm
 
 libcrmcluster_la_SOURCES = cluster.c membership.c stack.h
 
-if BUILD_AIS_SUPPORT
+if BUILD_CS_SUPPORT
 libcrmcluster_la_SOURCES += ais.c
 endif
 
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/ais.c
--- a/lib/common/ais.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/ais.c	Mon Jul 12 18:48:04 2010 +0200
@@ -19,13 +19,48 @@
 #include <crm_internal.h>
 #include <bzlib.h>
 #include <crm/ais.h>
+#include <crm/common/ipc.h>
 #include <crm/common/cluster.h>
 #include <sys/utsname.h>
 #include "stack.h"
-#ifdef AIS_COROSYNC
+#ifdef SUPPORT_COROSYNC
 #  include <corosync/corodefs.h>
 #endif
 
+#ifdef SUPPORT_CMAN
+#  include <libcman.h>
+cman_handle_t pcmk_cman_handle = NULL;
+#endif
+
+#ifdef SUPPORT_CS_QUORUM
+#  include <sys/socket.h>
+#  include <netinet/in.h>
+#  include <arpa/inet.h>
+
+#  include <corosync/cpg.h>
+#  include <corosync/quorum.h>
+
+quorum_handle_t pcmk_quorum_handle = 0;
+cpg_handle_t pcmk_cpg_handle = 0;
+struct cpg_name pcmk_cpg_group = {
+    .length = 0,
+    .value[0] = 0,
+};
+#endif
+
+static char *pcmk_uname = NULL;
+static int pcmk_uname_len = 0;
+static uint32_t pcmk_nodeid = 0;
+
+#define cs_repeat(counter, max, code) do {		\
+	code;						\
+	if(rc == CS_ERR_TRY_AGAIN) {			\
+	    counter++;					\
+	    crm_debug("Retrying operation after %ds", counter);	\
+	    sleep(counter);				\
+	}						\
+    } while(rc == CS_ERR_TRY_AGAIN && counter < max)
+
 enum crm_ais_msg_types text2msg_type(const char *text) 
 {
 	int type = crm_msg_none;
@@ -84,7 +119,7 @@ char *get_ais_data(const AIS_Message *ms
 	rc = BZ2_bzBuffToBuffDecompress(
 	    uncompressed, &new_size, (char*)msg->data, msg->compressed_size, 1, 0);
 	
-	CRM_ASSERT(rc = BZ_OK);
+	CRM_ASSERT(rc == BZ_OK);
 	CRM_ASSERT(new_size == msg->size);
     }
     
@@ -92,17 +127,16 @@ char *get_ais_data(const AIS_Message *ms
 }
 
 
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 int ais_fd_sync = -1;
 int ais_fd_async = -1; /* never send messages via this channel */
 void *ais_ipc_ctx = NULL;
-#ifdef AIS_COROSYNC
-#  ifndef TRADITIONAL_AIS_IPC
-   hdb_handle_t ais_ipc_handle = 0;
-#  endif
-#endif
+hdb_handle_t ais_ipc_handle = 0;
 GFDSource *ais_source = NULL;
 GFDSource *ais_source_sync = NULL;
+GFDSource *cman_source = NULL;
+GFDSource *cpg_source = NULL;
+GFDSource *quorumd_source = NULL;
 static char *ais_cluster_name = NULL;
 
 gboolean get_ais_nodeid(uint32_t *id, char **uname)
@@ -125,17 +159,8 @@ gboolean get_ais_nodeid(uint32_t *id, ch
     
   retry:
     errno = 0;
-#ifdef TRADITIONAL_AIS_IPC
-    rc = saSendReceiveReply(ais_fd_sync, &header, header.size, &answer, sizeof (struct crm_ais_nodeid_resp_s));
-#else
-#  ifdef AIS_WHITETANK
-    rc = openais_msg_send_reply_receive(
-	ais_ipc_ctx, &iov, 1, &answer, sizeof (answer));
-#  else
     rc = coroipcc_msg_send_reply_receive(
 	ais_ipc_handle, &iov, 1, &answer, sizeof (answer));
-#  endif
-#endif
     if(rc == CS_OK) {
 	CRM_CHECK(answer.header.size == sizeof (struct crm_ais_nodeid_resp_s),
 		  crm_err("Odd message: id=%d, size=%d, error=%d",
@@ -185,6 +210,7 @@ send_ais_text(int class, const char *dat
 {
     static int msg_id = 0;
     static int local_pid = 0;
+    enum cluster_type_e cluster_type = get_cluster_type();
 
     int retries = 0;
     int rc = CS_OK;
@@ -192,7 +218,8 @@ send_ais_text(int class, const char *dat
 
     char *buf = NULL;
     struct iovec iov;
-    coroipc_response_header_t *header;
+    const char *transport = "pcmk";
+    coroipc_response_header_t *header = NULL;
     AIS_Message *ais_msg = NULL;
     enum crm_ais_msg_types sender = text2msg_type(crm_system_name);
 
@@ -230,12 +257,13 @@ send_ais_text(int class, const char *dat
 	memset(ais_msg->host.uname, 0, MAX_NAME);
 	ais_msg->host.id = 0;
     }
-    
+
+    ais_msg->sender.id = 0;
     ais_msg->sender.type = sender;
     ais_msg->sender.pid = local_pid;
-    ais_msg->sender.size = 0;
+    ais_msg->sender.size = pcmk_uname_len;
     memset(ais_msg->sender.uname, 0, MAX_NAME);
-    ais_msg->sender.id = 0;
+    memcpy(ais_msg->sender.uname, pcmk_uname, ais_msg->sender.size);
 
     ais_msg->size = 1 + strlen(data);
 
@@ -284,53 +312,54 @@ send_ais_text(int class, const char *dat
 
     iov.iov_base = ais_msg;
     iov.iov_len = ais_msg->header.size;
-  retry:
-    errno = 0;
     crm_realloc(buf, buf_len);
-    
-#ifdef TRADITIONAL_AIS_IPC
-    rc = saSendReceiveReply(ais_fd_sync, ais_msg, ais_msg->header.size, buf, buf_len);
-#else
-#  ifdef AIS_WHITETANK
-    rc = openais_msg_send_reply_receive(ais_ipc_ctx, &iov, 1, buf, buf_len);
-#  else
-    rc = coroipcc_msg_send_reply_receive(ais_ipc_handle, &iov, 1, buf, buf_len);
-#  endif
-#endif
-    header = (coroipc_response_header_t *)buf;
 
-    if(rc == CS_ERR_TRY_AGAIN && retries < 20) {
-	retries++;
-	crm_info("Peer overloaded: Re-sending message (Attempt %d of 20)", retries);
-	sleep(retries); /* Proportional back off */
-	goto retry;
+    do {
+	if(rc == CS_ERR_TRY_AGAIN) {
+	    retries++;
+	    crm_info("Peer overloaded or membership in flux:"
+		     " Re-sending message (Attempt %d of 20)", retries);
+	    sleep(retries); /* Proportional back off */
+	}
+	
+	errno = 0;
+	switch(cluster_type) {
+	    case pcmk_cluster_classic_ais:
+		rc = coroipcc_msg_send_reply_receive(ais_ipc_handle, &iov, 1, buf, buf_len);
+		header = (coroipc_response_header_t *)buf;
+		if(rc == CS_OK) {
+		    CRM_CHECK_AND_STORE(header->size == sizeof (coroipc_response_header_t),
+					crm_err("Odd message: id=%d, size=%d, class=%d, error=%d",
+						header->id, header->size, class, header->error));
+		    
+		    CRM_ASSERT(buf_len >= header->size);
+		    CRM_CHECK_AND_STORE(header->id == CRM_MESSAGE_IPC_ACK,
+					crm_err("Bad response id (%d) for request (%d)", header->id, ais_msg->header.id));
+		    CRM_CHECK(header->error == CS_OK, rc = header->error);
+		}
+		break;
+		
+	    case pcmk_cluster_corosync:
+	    case pcmk_cluster_cman:
+		transport = "cpg";
+		CRM_CHECK_AND_STORE(dest != crm_msg_ais, rc = CS_ERR_MESSAGE_ERROR; goto bail);
+		rc = cpg_mcast_joined(pcmk_cpg_handle, CPG_TYPE_AGREED, &iov, 1);
+		break;
+		
+	    case pcmk_cluster_unknown:
+	    case pcmk_cluster_invalid:
+	    case pcmk_cluster_heartbeat:
+		CRM_ASSERT(is_openais_cluster());
+		break;
+	}
+	
+    } while (rc == CS_ERR_TRY_AGAIN && retries < 20);
 
-    } else if(rc == CS_OK) {
+  bail:
+    if(rc != CS_OK) {    
+	crm_perror(LOG_ERR,"Sending message %d via %s: FAILED (rc=%d): %s",
+		   ais_msg->id, transport, rc, ais_error2text(rc));
 
-	CRM_CHECK_AND_STORE(header->size == sizeof (coroipc_response_header_t),
-			    crm_err("Odd message: id=%d, size=%d, class=%d, error=%d",
-				    header->id, header->size, class, header->error));
-
-	if(buf_len < header->size) {
-	    crm_err("Increasing buffer length to %d and retrying", header->size);
-	    buf_len = header->size + 1;
-	    goto retry;
-
-	} else if(header->id == crm_class_nodeid && header->size == sizeof (struct crm_ais_nodeid_resp_s)){
-	    struct crm_ais_nodeid_resp_s *answer = (struct crm_ais_nodeid_resp_s *)header;
-	    crm_err("Server details: id=%u uname=%s counter=%u", answer->id, answer->uname, answer->counter);
-
-	} else {
-	    CRM_CHECK_AND_STORE(header->id == CRM_MESSAGE_IPC_ACK,
-				crm_err("Bad response id (%d) for request (%d)", header->id, ais_msg->header.id));
-	    CRM_CHECK(header->error == CS_OK, rc = header->error);
-	}
-    }
-    
-    if(rc != CS_OK) {    
-	crm_perror(LOG_ERR,"Sending message %d: FAILED (rc=%d): %s",
-		  ais_msg->id, rc, ais_error2text(rc));
-	ais_fd_async = -1;
     } else {
 	crm_debug_4("Message %d: sent", ais_msg->id);
     }
@@ -347,9 +376,11 @@ send_ais_message(xmlNode *msg,
     gboolean rc = TRUE;
     char *data = NULL;
 
-    if(ais_fd_async < 0 || ais_source == NULL) {
-	crm_err("Not connected to AIS");
-	return FALSE;
+    if(is_classic_ais_cluster()) {
+	if(ais_fd_async < 0 || ais_source == NULL) {
+	    crm_err("Not connected to AIS: %d %p", ais_fd_async, ais_source);
+	    return FALSE;
+	}
     }
 
     data = dump_xml_unformatted(msg);
@@ -360,97 +391,42 @@ send_ais_message(xmlNode *msg,
 
 void terminate_ais_connection(void) 
 {
-#ifndef TRADITIONAL_AIS_IPC
-    if(ais_ipc_ctx) {
-#  ifdef AIS_WHITETANK
-	openais_service_disconnect(ais_ipc_ctx);
-#  else
-	coroipcc_service_disconnect(ais_ipc_handle);
-#  endif
-    }
-#else
-    if(ais_fd_sync > 0) {
-	close(ais_fd_sync);
-    }
-    if(ais_fd_async > 0) {
-	close(ais_fd_async);
+    crm_notice("Disconnecting from AIS");
+    
+/*     G_main_del_fd(ais_source); */
+/*     G_main_del_fd(ais_source_sync);     */
+
+#ifdef SUPPORT_CMAN
+    if(is_cman_cluster()) {
+	cman_stop_notification(pcmk_cman_handle);
+	cman_finish(pcmk_cman_handle);
     }
 #endif
-    crm_notice("Disconnected from AIS");
-/*     G_main_del_fd(ais_source); */
-/*     G_main_del_fd(ais_source_sync);     */
+
+    if(is_corosync_cluster()) {
+	quorum_finalize(pcmk_quorum_handle);
+    }
+
+    if(is_classic_ais_cluster() == FALSE) {
+	coroipcc_service_disconnect(ais_ipc_handle);
+
+    } else {
+	cpg_leave(pcmk_cpg_handle, &pcmk_cpg_group);
+    }
 }
 
 int ais_membership_timer = 0;
 gboolean ais_membership_force = FALSE;
 
-gboolean ais_dispatch(int sender, gpointer user_data)
+static gboolean ais_dispatch_message(
+    AIS_Message *msg, gboolean (*dispatch)(AIS_Message*,char*,int))
 {
     char *data = NULL;
-    char *buffer = NULL;
     char *uncompressed = NULL;
     
-    int rc = CS_OK;
     xmlNode *xml = NULL;
-    AIS_Message *msg = NULL;
-    gboolean (*dispatch)(AIS_Message*,char*,int) = user_data;
-
-#ifdef TRADITIONAL_AIS_IPC
-    coroipc_response_header_t *header = NULL;
-    static int header_len = sizeof(coroipc_response_header_t);
-
-    crm_malloc0(header, header_len);
-    buffer = (char*)header;
+    CRM_ASSERT(msg != NULL);
     
-    errno = 0;
-    rc = saRecvRetry(sender, header, header_len);
-    
-    if (rc != CS_OK) {
-	crm_perror(LOG_ERR, "Receiving message header failed: (%d/%d) %s", rc, errno, ais_error2text(rc));
-	goto bail;
-
-    } else if(header->size == header_len) {
-	crm_err("Empty message: id=%d, size=%d, error=%d, header_len=%d",
-		header->id, header->size, header->error, header_len);
-	goto done;
-	
-    } else if(header->size == 0 || header->size < header_len) {
-	crm_err("Mangled header: size=%d, header=%d, error=%d",
-		header->size, header_len, header->error);
-	goto done;
-	
-    } else if(header->error != CS_OK) {
-	crm_err("Header contined error: %d", header->error);
-    }
-    
-    crm_debug_2("Looking for %d (%d - %d) more bytes",
-		header->size - header_len, header->size, header_len);
-
-    crm_realloc(header, header->size);
-    /* Use a char* so we can store the remainder into an offset */
-    buffer = (char*)header;
-
-    errno = 0;
-    rc = saRecvRetry(sender, buffer+header_len, header->size - header_len);
-#else
-#  ifdef AIS_WHITETANK
-    crm_malloc0(buffer, 1000000);
-    rc = openais_dispatch_recv (ais_ipc_ctx, buffer, 0);
-#  else
-    rc = coroipcc_dispatch_get (ais_ipc_handle, (void**)&buffer, 0);
-#  endif
-#endif
-
-    if (rc == 0) {
-	/* Zero is a legal "no message afterall" value */
-	goto done;
-	
-    } else if (rc != CS_OK) {
-	crm_perror(LOG_ERR,"Receiving message body failed: (%d) %s", rc, ais_error2text(rc));
-	goto bail;
-    }
-
-    msg = (AIS_Message*)buffer;
     crm_debug_3("Got new%s message (size=%d, %d, %d)",
 		msg->is_compressed?" compressed":"",
 		ais_data_len(msg), msg->size, msg->compressed_size);
@@ -502,52 +478,49 @@ gboolean ais_dispatch(int sender, gpoint
 
     } else if(msg->header.id == crm_class_members
 	|| msg->header.id == crm_class_quorum) {
-	const char *value = NULL;
-	gboolean quorate = FALSE;	
-	
+
 	xml = string2xml(data);
 	if(xml == NULL) {
 	    crm_err("Invalid membership update: %s", data);
 	    goto badmsg;
 	}
 	
-	value = crm_element_value(xml, "quorate");
-	CRM_CHECK(value != NULL, crm_log_xml_err(xml, "No quorum value:"); goto badmsg);
-	if(crm_is_true(value)) {
-	    quorate = TRUE;
-	}
-
-	value = crm_element_value(xml, "id");
-	CRM_CHECK(value != NULL, crm_log_xml_err(xml, "No membership id"); goto badmsg);
-	crm_peer_seq = crm_int_helper(value, NULL);
-
-	if(quorate != crm_have_quorum) {
-	    crm_notice("Membership %s: quorum %s", value, quorate?"acquired":"lost");
-	    crm_have_quorum = quorate;
+	if(is_classic_ais_cluster() == FALSE) {
+	    xml_child_iter(xml, node, crm_update_cman_node(node, crm_peer_seq));
 
 	} else {
-	    crm_info("Membership %s: quorum %s", value, quorate?"retained":"still lost");
+	    const char *value = NULL;
+	    gboolean quorate = FALSE;	
+	    
+	    value = crm_element_value(xml, "quorate");
+	    CRM_CHECK(value != NULL, crm_log_xml_err(xml, "No quorum value:"); goto badmsg);
+	    if(crm_is_true(value)) {
+		quorate = TRUE;
+	    }
+	    
+	    value = crm_element_value(xml, "id");
+	    CRM_CHECK(value != NULL, crm_log_xml_err(xml, "No membership id"); goto badmsg);
+	    crm_peer_seq = crm_int_helper(value, NULL);
+	    
+	    if(quorate != crm_have_quorum) {
+		crm_notice("Membership %s: quorum %s", value, quorate?"acquired":"lost");
+		crm_have_quorum = quorate;
+		
+	    } else {
+		crm_info("Membership %s: quorum %s", value, quorate?"retained":"still lost");
+	    }
+	
+	    xml_child_iter(xml, node, crm_update_ais_node(node, crm_peer_seq));
 	}
-	
-	xml_child_iter(xml, node, crm_update_ais_node(node, crm_peer_seq));
     }
 
     if(dispatch != NULL) {
-	dispatch(msg, data, sender);
+	dispatch(msg, data, 0);
     }
     
   done:
     crm_free(uncompressed);
     free_xml(xml);
-    
-#ifdef AIS_COROSYNC
-#  ifndef TRADITIONAL_AIS_IPC
-    coroipcc_dispatch_put (ais_ipc_handle);
-    buffer = NULL;
-#  endif
-#endif
-
-    crm_free(buffer);
     return TRUE;
 
   badmsg:
@@ -558,15 +531,32 @@ gboolean ais_dispatch(int sender, gpoint
 	    msg->sender.pid, (int)sizeof(AIS_Message),
 	    msg->header.size, msg->size, msg->compressed_size);
     goto done;
-    
+}
+
+gboolean ais_dispatch(int sender, gpointer user_data)
+{
+    int rc = CS_OK;
+    char *buffer = NULL;
+    gboolean good = TRUE;
+    gboolean (*dispatch)(AIS_Message*,char*,int) = user_data;
+
+    rc = coroipcc_dispatch_get (ais_ipc_handle, (void**)&buffer, 0);
+
+    if (rc == 0 || buffer == NULL) {
+	/* Zero is a legal "no message afterall" value */
+	return TRUE;
+	
+    } else if (rc != CS_OK) {
+	crm_perror(LOG_ERR,"Receiving message body failed: (%d) %s", rc, ais_error2text(rc));
+	goto bail;
+    }
+
+    good = ais_dispatch_message((AIS_Message*)buffer, dispatch);
+    coroipcc_dispatch_put (ais_ipc_handle);
+    return good;
+
   bail:
     crm_err("AIS connection failed");
-#ifdef AIS_COROSYNC
-#  ifndef TRADITIONAL_AIS_IPC
-    buffer = NULL;
-#  endif
-#endif
-    crm_free(buffer);
     return FALSE;
 }
 
@@ -578,29 +568,395 @@ ais_destroy(gpointer user_data)
     exit(1);
 }
 
-gboolean init_ais_connection(
+static gboolean pcmk_proc_dispatch(IPC_Channel *ch, gpointer user_data)
+{
+    xmlNode *msg = NULL;
+    gboolean stay_connected = TRUE;
+	
+    while(IPC_ISRCONN(ch)) {
+	if(ch->ops->is_message_pending(ch) == 0) {
+	    break;
+	}
+
+	msg = xmlfromIPC(ch, MAX_IPC_DELAY);
+
+	if(msg) {
+	    xml_child_iter(msg, node,
+
+			   int id = 0;
+			   int children = 0;
+			   const char *uname = crm_element_value(node, "uname");
+			   crm_element_value_int(node, "processes", &children);
+			   
+			   crm_update_peer(id, 0, 0, 0, children, NULL, uname, NULL, NULL);
+		);
+	    free_xml(msg);
+	}
+
+	if(ch->ch_status != IPC_CONNECT) {
+	    break;
+	}
+    }
+	
+    if (ch->ch_status != IPC_CONNECT) {
+	stay_connected = FALSE;
+    }
+    return stay_connected;
+}
+
+#ifdef SUPPORT_CMAN
+
+static gboolean pcmk_cman_dispatch(int sender, gpointer user_data)
+{
+    int rc = cman_dispatch(pcmk_cman_handle, CMAN_DISPATCH_ONE);
+    if(rc < 0) {
+	crm_err("Connection to cman failed: %d", rc);
+	return FALSE;
+    }
+    return TRUE;
+}
+
+#define MAX_NODES 256
+
+static void cman_event_callback(cman_handle_t handle, void *privdata, int reason, int arg)
+{
+    int rc = 0, lpc = 0, node_count = 0;
+
+    cman_cluster_t cluster;
+    static cman_node_t cman_nodes[MAX_NODES];
+    gboolean (*dispatch)(unsigned long long, gboolean) = privdata;
+    
+    switch (reason) {
+	case CMAN_REASON_STATECHANGE:
+
+	    memset(&cluster, 0, sizeof(cluster));
+	    rc = cman_get_cluster(pcmk_cman_handle, &cluster);
+	    if (rc < 0) {
+		crm_err("Couldn't query cman cluster details: %d %d", rc, errno);
+		return;
+	    }
+
+	    crm_peer_seq = cluster.ci_generation;
+	    if(arg != crm_have_quorum) {
+		crm_notice("Membership %llu: quorum %s", crm_peer_seq, arg?"acquired":"lost");
+		crm_have_quorum = arg;
+		
+	    } else {
+		crm_info("Membership %llu: quorum %s", crm_peer_seq, arg?"retained":"still lost");
+	    }
+
+	    rc = cman_get_nodes(pcmk_cman_handle, MAX_NODES, &node_count, cman_nodes);
+	    if (rc < 0) {
+		crm_err("Couldn't query cman node list: %d %d", rc, errno);
+		return;
+	    }
+
+	    for (lpc = 0; lpc < node_count; lpc++) {
+		if (cman_nodes[lpc].cn_nodeid == 0) {
+		    /* Never allow node ID 0 to be considered a member #315711 */
+		    cman_nodes[lpc].cn_member = 0;
+		}
+		crm_update_peer(cman_nodes[lpc].cn_nodeid, cman_nodes[lpc].cn_incarnation,
+				cman_nodes[lpc].cn_member?crm_peer_seq:0, 0, 0,
+				cman_nodes[lpc].cn_name,   cman_nodes[lpc].cn_name, NULL,
+				cman_nodes[lpc].cn_member?CRM_NODE_MEMBER:CRM_NODE_LOST);
+	    }
+
+	    if(dispatch) {
+		dispatch(crm_peer_seq, crm_have_quorum);		
+	    }
+	    break;
+
+	case CMAN_REASON_TRY_SHUTDOWN:
+	    /* Always reply with a negative - pacemaker needs to be stopped first */
+	    crm_info("CMAN wants to shut down: %s", arg?"forced":"optional");
+	    cman_replyto_shutdown(pcmk_cman_handle, 0);
+	    break;
+	    
+	case CMAN_REASON_CONFIG_UPDATE:
+	    /* Ignore */
+	    break;
+    }
+}
+#endif
+
+gboolean init_cman_connection(
+    gboolean (*dispatch)(unsigned long long, gboolean), void (*destroy)(gpointer))
+{
+#ifdef SUPPORT_CMAN
+    int rc = -1, fd = -1;
+    cman_cluster_t cluster;
+    
+    crm_info("Configuring Pacemaker to obtain quorum from cman");
+
+    memset(&cluster, 0, sizeof(cluster));
+
+    pcmk_cman_handle = cman_init(dispatch);
+    if(pcmk_cman_handle == NULL || cman_is_active(pcmk_cman_handle) == FALSE) {
+	crm_err("Couldn't connect to cman");
+	goto cman_bail;
+    }
+
+    rc = cman_get_cluster(pcmk_cman_handle, &cluster);
+    if (rc < 0) {
+	crm_err("Couldn't query cman cluster details: %d %d", rc, errno);
+	goto cman_bail;	
+    }
+    ais_cluster_name = crm_strdup(cluster.ci_name);
+    
+    rc = cman_start_notification(pcmk_cman_handle, cman_event_callback);
+    if (rc < 0) {
+	crm_err("Couldn't register for cman notifications: %d %d", rc, errno);
+	goto cman_bail;
+    }
+
+    /* Get the current membership state */
+    cman_event_callback(pcmk_cman_handle, dispatch, CMAN_REASON_STATECHANGE,
+			cman_is_quorate(pcmk_cman_handle));
+
+    fd = cman_get_fd(pcmk_cman_handle);
+    crm_debug("Adding fd=%d to mainloop", fd);
+    cman_source = G_main_add_fd(
+	G_PRIORITY_HIGH, fd, FALSE, pcmk_cman_dispatch, dispatch, destroy);
+
+  cman_bail:
+    if (rc < 0) {
+	cman_finish(pcmk_cman_handle);
+	return FALSE;
+    }
+#else
+    crm_err("cman qorum is not supported in this build");
+    exit(100);
+#endif
+    return TRUE;
+}
+
+#ifdef SUPPORT_CS_QUORUM
+gboolean (*pcmk_cpg_dispatch_fn)(AIS_Message*,char*,int) = NULL;
+
+static gboolean pcmk_cpg_dispatch(int sender, gpointer user_data)
+{
+    int rc = 0;
+    pcmk_cpg_dispatch_fn = user_data;
+    rc = cpg_dispatch(pcmk_cpg_handle, CS_DISPATCH_ALL);
+    if(rc != CS_OK) {
+	crm_err("Connection to the CPG API failed: %d", rc);
+	return FALSE;
+    }
+    return TRUE;
+}
+
+static void pcmk_cpg_deliver (
+	cpg_handle_t handle,
+	const struct cpg_name *groupName,
+	uint32_t nodeid,
+	uint32_t pid,
+	void *msg,
+	size_t msg_len)
+{
+    AIS_Message *ais_msg = (AIS_Message*)msg;
+    if(ais_msg->sender.id > 0 && ais_msg->sender.id != nodeid) {
+	crm_err("Nodeid mismatch from %d.%d: claimed nodeid=%u",
+		nodeid, pid, ais_msg->sender.id);
+	return;
+
+    } else if(ais_msg->host.size != 0
+	      && safe_str_neq(ais_msg->host.uname, pcmk_uname)) {
+	/* Not for us */
+	return;
+    }
+
+    ais_msg->sender.id = nodeid;
+    if(ais_msg->sender.size == 0) {
+	crm_node_t *peer = crm_get_peer(nodeid, NULL);
+	if(peer == NULL) {
+	    crm_err("Peer with nodeid=%u is unknown", nodeid);
+
+	} else if(peer->uname == NULL) {
+	    crm_err("No uname for peer with nodeid=%u", nodeid);
+
+	} else {
+	    crm_notice("Fixing uname for peer with nodeid=%u", nodeid);
+	    ais_msg->sender.size = strlen(peer->uname);
+	    memset(ais_msg->sender.uname, 0, MAX_NAME);
+	    memcpy(ais_msg->sender.uname, peer->uname, ais_msg->sender.size);
+	}
+    }
+
+    ais_dispatch_message(ais_msg, pcmk_cpg_dispatch_fn);
+}
+
+static void pcmk_cpg_membership(
+	cpg_handle_t handle,
+	const struct cpg_name *groupName,
+	const struct cpg_address *member_list, size_t member_list_entries,
+	const struct cpg_address *left_list, size_t left_list_entries,
+	const struct cpg_address *joined_list, size_t joined_list_entries)
+{
+    /* Don't care about CPG membership */
+}
+
+static gboolean pcmk_quorum_dispatch(int sender, gpointer user_data)
+{
+    int rc = 0;
+    rc = quorum_dispatch(pcmk_quorum_handle, CS_DISPATCH_ALL);
+    if(rc < 0) {
+	crm_err("Connection to the Quorum API failed: %d", rc);
+	return FALSE;
+    }
+    return TRUE;
+}
+
+static void pcmk_quorum_notification(
+	quorum_handle_t handle,
+	uint32_t quorate,
+	uint64_t ring_id,
+	uint32_t view_list_entries,
+	uint32_t *view_list)
+{
+	int i;
+
+	if(quorate != crm_have_quorum) {
+	    crm_notice("Membership "U64T": quorum %s (%lu)", ring_id,
+		       quorate?"acquired":"lost", (long unsigned int)view_list_entries);
+	    crm_have_quorum = quorate;
+	    
+	} else {
+	    crm_info("Membership "U64T": quorum %s (%lu)", ring_id,
+		     quorate?"retained":"still lost", (long unsigned int)view_list_entries);
+	}
+	for (i=0; i<view_list_entries; i++) {
+		crm_debug(" %d ", view_list[i]);
+	}
+}
+
+cpg_callbacks_t cpg_callbacks = {
+    .cpg_deliver_fn =            pcmk_cpg_deliver,
+    .cpg_confchg_fn =            pcmk_cpg_membership,
+};
+
+quorum_callbacks_t quorum_callbacks = {
+    .quorum_notify_fn = pcmk_quorum_notification,
+};
+
+#endif
+
+static gboolean init_cpg_connection(
+    gboolean (*dispatch)(AIS_Message*,char*,int), void (*destroy)(gpointer), uint32_t *nodeid)
+{
+#ifdef SUPPORT_CS_QUORUM
+    int rc = -1;
+    int fd = 0;
+    int retries = 0;
+	
+    strcpy(pcmk_cpg_group.value, crm_system_name);
+    pcmk_cpg_group.length = strlen(crm_system_name)+1;
+
+    cs_repeat(retries, 30, rc = cpg_initialize (&pcmk_cpg_handle, &cpg_callbacks));
+    if (rc != CS_OK) {
+	crm_err("Could not connect to the Cluster Process Group API: %d\n", rc);
+	goto bail;
+    }
+
+    retries = 0;
+    cs_repeat(
+	retries, 30, rc = cpg_local_get (pcmk_cpg_handle, (unsigned int*)nodeid));
+    if (rc != CS_OK) {
+	crm_err("Could not get local node id from the CPG API");
+	goto bail;
+    }	
+
+    retries = 0;
+    cs_repeat(retries, 30, rc = cpg_join(pcmk_cpg_handle, &pcmk_cpg_group));
+    if (rc != CS_OK) {
+	crm_err("Could not join the CPG group '%s': %d", crm_system_name, rc);
+	goto bail;
+    }
+
+    rc = cpg_fd_get(pcmk_cpg_handle, &fd);
+    if (rc != CS_OK) {
+	crm_err("Could not obtain the CPG API connection: %d\n", rc);
+	goto bail;
+    }
+
+    crm_debug("Adding fd=%d to mainloop", fd);
+    cpg_source = G_main_add_fd(
+	G_PRIORITY_HIGH, fd, FALSE, pcmk_cpg_dispatch, dispatch, destroy);
+
+  bail:
+    if (rc != CS_OK) {
+	cpg_finalize(pcmk_cpg_handle);
+	return FALSE;
+    }
+#else
+    crm_err("corosync qorum is not supported in this build");
+    exit(100);
+#endif
+    return TRUE;
+}
+
+gboolean init_quorum_connection(
+    gboolean (*dispatch)(unsigned long long, gboolean), void (*destroy)(gpointer))
+{
+#ifdef SUPPORT_CS_QUORUM
+    int rc = -1;
+    int fd = 0;
+    int quorate = 0;
+	
+    crm_info("Configuring Pacemaker to obtain quorum from Corosync");
+
+    rc = quorum_initialize(&pcmk_quorum_handle, &quorum_callbacks);
+    if ( rc != CS_OK) {
+	crm_err("Could not connect to the Quorum API: %d\n", rc);
+	goto bail;
+    }
+
+    rc = quorum_getquorate(pcmk_quorum_handle, &quorate);
+    if ( rc != CS_OK) {
+	crm_err("Could not obtain the current Quorum API state: %d\n", rc);
+	goto bail;
+    }
+    crm_notice("Quorum %s", quorate?"acquired":"lost");
+    crm_have_quorum = quorate;
+
+    rc = quorum_trackstart(pcmk_quorum_handle, CS_TRACK_CHANGES|CS_TRACK_CURRENT);
+    if ( rc != CS_OK) {
+	crm_err("Could not setup Quorum API notifications: %d\n", rc);
+	goto bail;
+    }
+
+    rc = quorum_fd_get(pcmk_quorum_handle, &fd);
+    if (rc != CS_OK) {
+	crm_err("Could not obtain the Quorum API connection: %d\n", rc);
+	goto bail;
+    }
+
+    quorumd_source = G_main_add_fd(
+	G_PRIORITY_HIGH, fd, FALSE, pcmk_quorum_dispatch, dispatch, destroy);
+
+  bail:
+    if (rc != CS_OK) {
+	quorum_finalize(pcmk_quorum_handle);
+	return FALSE;
+    }
+	
+#else
+    crm_err("corosync quorum is not supported in this build");
+    exit(100);
+#endif
+    return TRUE;
+}
+
+static gboolean init_ais_connection_classic(
     gboolean (*dispatch)(AIS_Message*,char*,int),
     void (*destroy)(gpointer), char **our_uuid, char **our_uname, int *nodeid)
 {
+    int rc;
     int pid = 0;
-    int retries = 0;
-    int rc = CS_OK;
     char *pid_s = NULL;
     struct utsname name;
-    uint32_t local_nodeid = 0;
-    char *local_uname = NULL;
     
-  retry:
-    crm_info("Creating connection to our AIS plugin");
-#ifdef TRADITIONAL_AIS_IPC
-    rc = saServiceConnect (&ais_fd_sync, &ais_fd_async, PCMK_SERVICE_ID);
-#else
-#  ifdef AIS_WHITETANK
-    rc = openais_service_connect(PCMK_SERVICE_ID, &ais_ipc_ctx);
-    if(ais_ipc_ctx) {
-	ais_fd_async = openais_fd_get(ais_ipc_ctx);
-    }
-#  else
+    crm_info("Creating connection to our Corosync plugin");
     rc = coroipcc_service_connect(
 	COROSYNC_SOCKET_NAME, PCMK_SERVICE_ID,
 	AIS_IPC_MESSAGE_SIZE, AIS_IPC_MESSAGE_SIZE, AIS_IPC_MESSAGE_SIZE,
@@ -608,8 +964,6 @@ gboolean init_ais_connection(
     if(ais_ipc_handle) {
 	coroipcc_fd_get(ais_ipc_handle, &ais_fd_async);
     }
-#  endif
-#endif
     if(ais_fd_async <= 0 && rc == CS_OK) {
 	crm_err("No context created, but connection reported 'ok'");
 	rc = CS_ERR_LIBRARY;
@@ -617,69 +971,170 @@ gboolean init_ais_connection(
     if (rc != CS_OK) {
 	crm_info("Connection to our AIS plugin (%d) failed: %s (%d)", PCMK_SERVICE_ID, ais_error2text(rc), rc);
     }
-
-    switch(rc) {
-	case CS_OK:
-	    break;
-	case CS_ERR_TRY_AGAIN:
-	    if(retries < 30) {
-		sleep(1);
-		retries++;
-		goto retry;
-	    }
-	    crm_err("Retry count exceeded");
-	    return FALSE;
-	default:
-	    return FALSE;
+	
+    if(rc != CS_OK) {
+	return FALSE;
     }
 
     if(destroy == NULL) {
 	destroy = ais_destroy;
     } 
-   
+	
+    if(dispatch) {
+	crm_debug("Adding fd=%d to mainloop", ais_fd_async);
+	ais_source = G_main_add_fd(
+	    G_PRIORITY_HIGH, ais_fd_async, FALSE, ais_dispatch, dispatch, destroy);
+    }
+    
     crm_info("AIS connection established");
-    
+
     pid = getpid();
     pid_s = crm_itoa(pid);
     send_ais_text(0, pid_s, TRUE, NULL, crm_msg_ais);
     crm_free(pid_s);
 
-    crm_peer_init();
-    get_ais_nodeid(&local_nodeid, &local_uname);
-
     if(uname(&name) < 0) {
-	crm_perror(LOG_ERR,"uname(2) call failed");
+	crm_perror(LOG_ERR,"Could not determin the current host");
 	exit(100);
     }
-
-    if(safe_str_neq(name.nodename, local_uname)) {
-	crm_crit("Node name mismatch!  OpenAIS supplied %s, our lookup returned %s", local_uname, name.nodename);
+    
+    get_ais_nodeid(&pcmk_nodeid, &pcmk_uname);
+    if(safe_str_neq(name.nodename, pcmk_uname)) {
+	crm_crit("Node name mismatch!  OpenAIS supplied %s, our lookup returned %s",
+		 pcmk_uname, name.nodename);
 	crm_notice("Node name mismatches usually occur when assigned automatically by DHCP servers");
 	crm_notice("If this node was part of the cluster with a different name,"
 		   " you will need to remove the old entry with crm_node --remove");
     }
+    return TRUE;
+}
+
+gboolean init_ais_connection(
+    gboolean (*dispatch)(AIS_Message*,char*,int), void (*destroy)(gpointer),
+    char **our_uuid, char **our_uname, int *nodeid)
+{
+    int retries = 0;
+    enum cluster_type_e type = get_cluster_type();
+
+    while(retries++ < 30) {
+	int rc = init_ais_connection_once(type, dispatch, destroy, our_uuid, our_uname, nodeid);
+	switch(rc) {
+	    case CS_OK:
+		if(getenv("HA_mcp")) {
+		    IPC_Channel *ch = init_client_ipc_comms_nodispatch("pcmk");
+		    G_main_add_IPC_Channel(G_PRIORITY_HIGH, ch, FALSE, pcmk_proc_dispatch, NULL, destroy);
+		}
+		return TRUE;
+		break;
+	    case CS_ERR_TRY_AGAIN:
+		break;
+	    default:
+		return FALSE;
+	}
+    }
+
+    crm_err("Retry count exceeded: %d", retries);
+    return FALSE;
+}
+
+static char *get_local_node_name(void) 
+{
+    char *name = NULL;
+    struct utsname res;
     
+    if(is_cman_cluster()) {
+#ifdef SUPPORT_CMAN
+	cman_node_t us;
+	cman_handle_t cman;
+
+	cman = cman_init(NULL);
+	if(cman != NULL && cman_is_active(cman)) {
+	    us.cn_name[0] = 0;
+	    cman_get_node(cman, CMAN_NODEID_US, &us);
+	    name = crm_strdup(us.cn_name);
+	    crm_info("Using CMAN node name: %s", name);
+
+	} else {
+	    crm_err("Couldn't determin node name from CMAN");
+	}
+	    
+	cman_finish(cman);
+#endif
+	
+    } else if(uname(&res) < 0) {
+	crm_perror(LOG_ERR,"Could not determin the current host");
+	exit(100);
+	
+    } else {
+	name = crm_strdup(res.nodename);
+    }
+    return name;
+}
+
+extern int set_cluster_type(enum cluster_type_e type);
+
+gboolean init_ais_connection_once(
+    enum cluster_type_e type,
+    gboolean (*dispatch)(AIS_Message*,char*,int),
+    void (*destroy)(gpointer), char **our_uuid, char **our_uname, int *nodeid)
+{
+    enum cluster_type_e use_type = 0;
+    crm_peer_init();
+    if(type) {
+	set_cluster_type(type);
+    }
+    
+    use_type = get_cluster_type();
+    /* Here we just initialize comms */
+    switch(use_type) {
+	case pcmk_cluster_classic_ais:
+	    if(init_ais_connection_classic(
+		   dispatch, destroy, our_uuid, &pcmk_uname, nodeid) == FALSE) {
+		goto bail;
+	    }
+	    break;
+	case pcmk_cluster_cman:
+	case pcmk_cluster_corosync:
+	    if(init_cpg_connection(dispatch, destroy, &pcmk_nodeid) == FALSE) {
+		goto bail;
+	    }
+	    pcmk_uname = get_local_node_name();
+	    break;
+	default:
+	    crm_err("Invalid cluster type: %s (%d)", name_for_cluster_type(use_type), use_type);
+	    goto bail;
+	    break;
+    }
+
+    crm_info("Connection to '%s': established", name_for_cluster_type(type));
+    
+    CRM_ASSERT(pcmk_uname != NULL);
+    pcmk_uname_len = strlen(pcmk_uname);
+    
+    if(pcmk_nodeid != 0) {
+	/* Ensure the local node always exists */
+	crm_update_peer(pcmk_nodeid, 0, 0, 0, 0, pcmk_uname, pcmk_uname, NULL, NULL);
+    }
+
     if(our_uuid != NULL) {
-	*our_uuid = crm_strdup(local_uname);
+	*our_uuid = crm_strdup(pcmk_uname);
     }
+
     if(our_uname != NULL) {
-	*our_uname = local_uname;
+	*our_uname = crm_strdup(pcmk_uname);
     }
 
     if(nodeid != NULL) {
-	*nodeid = local_nodeid;
-    }
-    
-    if(local_nodeid != 0) {
-	/* Ensure the local node always exists */
-	crm_update_peer(local_nodeid, 0, 0, 0, 0, local_uname, local_uname, NULL, NULL);
+	*nodeid = pcmk_nodeid;
     }
 
-    if(dispatch) {
-	ais_source = G_main_add_fd(
-	    G_PRIORITY_HIGH, ais_fd_async, FALSE, ais_dispatch, dispatch, destroy);
+    return TRUE;
+
+  bail:
+    if(type) {
+	set_cluster_type(pcmk_cluster_unknown);
     }
-    return TRUE;
+    return FALSE;
 }
 
 gboolean check_message_sanity(const AIS_Message *msg, const char *data) 
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/cluster.c
--- a/lib/common/cluster.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/cluster.c	Mon Jul 12 18:48:04 2010 +0200
@@ -33,7 +33,6 @@
 #include <crm/common/cluster.h>
 #include "stack.h"
 
-
 xmlNode *create_common_message(
 	xmlNode *original_request, xmlNode *xml_response_data);
 
@@ -45,14 +44,15 @@ gboolean crm_cluster_connect(
     void **hb_conn
 #endif
     ) {
+    enum cluster_type_e type = get_cluster_type();
+    crm_info("Connecting to cluster infrastructure: %s", name_for_cluster_type(type));
     if(hb_conn != NULL) {
 	*hb_conn = NULL;
     }
     
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
     if(is_openais_cluster()) {
 	crm_peer_init();
-	crm_info("Connecting to OpenAIS");
 	return init_ais_connection(dispatch, destroy, our_uuid, our_uname, NULL);
     }
 #endif
@@ -69,7 +69,6 @@ gboolean crm_cluster_connect(
 	/* make sure we are disconnected first */
 	heartbeat_cluster->llc_ops->signoff(heartbeat_cluster, FALSE);
 
-	crm_info("Connecting to Heartbeat");
 	return register_heartbeat_conn(
 	    heartbeat_cluster, our_uuid, our_uname, dispatch, destroy);
     }
@@ -81,7 +80,7 @@ gboolean crm_cluster_connect(
 gboolean send_cluster_message(
     const char *node, enum crm_ais_msg_types service, xmlNode *data, gboolean ordered) {
 
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
     if(is_openais_cluster()) {
 	return send_ais_message(data, FALSE, node, service);
     }
@@ -135,7 +134,7 @@ get_uuid(const char *uname)
 	return uuid_calc;
     }
     
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
     if(is_openais_cluster()) {
 	uuid_calc = crm_strdup(uname);
 	goto fallback;
@@ -196,7 +195,7 @@ get_uname(const char *uuid)
 	return uname;
     }
     
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
     if(is_openais_cluster()) {
 	g_hash_table_insert(crm_uname_cache, crm_strdup(uuid), crm_strdup(uuid));
     }
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/ipc.c
--- a/lib/common/ipc.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/ipc.c	Mon Jul 12 18:48:04 2010 +0200
@@ -556,7 +556,6 @@ xmlNode *
 validate_crm_message(
 	xmlNode *msg, const char *sys, const char *uuid, const char *msg_type)
 {
-	const char *from = NULL;
 	const char *to = NULL;
 	const char *type = NULL;
 	const char *crm_msg_reference = NULL;
@@ -569,7 +568,6 @@ validate_crm_message(
 		return NULL;
 	}
 
-	from = crm_element_value(msg, F_CRM_SYS_FROM);
 	to   = crm_element_value(msg, F_CRM_SYS_TO);
 	type = crm_element_value(msg, F_CRM_MSG_TYPE);
 	
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/iso8601.c
--- a/lib/common/iso8601.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/iso8601.c	Mon Jul 12 18:48:04 2010 +0200
@@ -485,6 +485,7 @@ parse_time_duration(char **interval_str)
 				diff->has->seconds = TRUE;
 				break;
 			default:
+				goto bail;
 				break;
 		}
 	}
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/membership.c
--- a/lib/common/membership.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/membership.c	Mon Jul 12 18:48:04 2010 +0200
@@ -45,6 +45,14 @@ gboolean crm_is_member_active(const crm_
     return FALSE;
 }
 
+gboolean crm_is_full_member(const crm_node_t *node) 
+{
+    if(crm_is_member_active(node) && (node->processes & crm_proc_crmd)) {
+	return TRUE;
+    }
+    return FALSE;
+}
+
 static gboolean crm_reap_dead_member(
     gpointer key, gpointer value, gpointer user_data)
 {
@@ -93,7 +101,7 @@ static void crm_count_member(
     gpointer key, gpointer value, gpointer user_data)
 {
     guint *count = user_data;
-    if(crm_is_member_active(value)) {
+    if(crm_is_full_member(value)) {
 	*count = *count + 1;
     }
 }
@@ -373,6 +381,19 @@ crm_node_t *crm_update_ais_node(xmlNode 
     return crm_update_peer(id, born, seen, votes, procs, uname, uname, addr, state);
 }
 
+crm_node_t *crm_update_cman_node(xmlNode *member, long long seq)
+{
+    const char *id_s = crm_element_value(member, "id");
+    const char *uname = crm_element_value(member, "uname");
+    const char *procs_s = crm_element_value(member, "processes");
+
+    unsigned int id = crm_int_helper(id_s, NULL);
+    unsigned int procs = crm_int_helper(procs_s, NULL);
+
+    crm_info("Updating peer processes for %s", crm_str(uname));
+    return crm_update_peer(id, 0, 0, 0, procs, uname, uname, NULL, NULL);
+}
+
 #if SUPPORT_HEARTBEAT
 crm_node_t *crm_update_ccm_node(
     const oc_ev_membership_t *oc, int offset, const char *state, uint64_t seq)
@@ -400,6 +421,7 @@ crm_node_t *crm_update_ccm_node(
 
 void crm_update_peer_proc(const char *uname, uint32_t flag, const char *status) 
 {
+    uint32_t last = 0;
     crm_node_t *node = NULL;
     gboolean changed = FALSE;
     CRM_ASSERT(crm_peer_cache != NULL);
@@ -410,6 +432,7 @@ void crm_update_peer_proc(const char *un
 	      crm_err("Could not set %s.%s to %s", uname, peer2text(flag), status);
 	      return);
 
+    last = node->processes;
     if(safe_str_eq(status, ONLINESTATUS)) {
 	if((node->processes & flag) == 0) {
 	    set_bit_inplace(node->processes, flag);
@@ -423,6 +446,9 @@ void crm_update_peer_proc(const char *un
 
     if(changed) {
 	crm_info("%s.%s is now %s", uname, peer2text(flag), status);
+	if(crm_status_callback) {
+	    crm_status_callback(crm_status_processes, node, &last);
+	}
     }
 }
 
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/stack.h
--- a/lib/common/stack.h	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/stack.h	Mon Jul 12 18:48:04 2010 +0200
@@ -32,7 +32,7 @@ extern gboolean register_heartbeat_conn(
 
 #endif
 
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 
 extern gboolean send_ais_message(
     xmlNode *msg, gboolean local,
@@ -42,7 +42,19 @@ extern void terminate_ais_connection(voi
 extern gboolean init_ais_connection(
     gboolean (*dispatch)(AIS_Message*,char*,int),
     void (*destroy)(gpointer), char **our_uuid, char **our_uname, int *nodeid);
+extern gboolean init_ais_connection_once(
+    enum cluster_type_e type, gboolean (*dispatch)(AIS_Message*,char*,int),
+    void (*destroy)(gpointer), char **our_uuid, char **our_uname, int *nodeid);
 
 #endif
 
+enum crm_quorum_source 
+{
+    crm_quorum_cman,
+    crm_quorum_corosync,
+    crm_quorum_pacemaker,
+};
+
+extern enum crm_quorum_source get_quorum_source(void);
+
 #endif
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/utils.c
--- a/lib/common/utils.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/utils.c	Mon Jul 12 18:48:04 2010 +0200
@@ -36,6 +36,7 @@
 #include <pwd.h>
 #include <grp.h>
 #include <time.h>
+#include <libgen.h>
 
 #include <crm/crm.h>
 #include <crm/msg_xml.h>
@@ -472,11 +473,25 @@ void crm_log_deinit(void) {
 #endif
 }
 
-gboolean
-crm_log_init(
+gboolean crm_log_init(
     const char *entity, int level, gboolean coredir, gboolean to_stderr,
     int argc, char **argv)
 {
+    return crm_log_init_worker(entity, level, coredir, to_stderr, argc, argv, FALSE);
+}
+
+gboolean crm_log_init_quiet(
+    const char *entity, int level, gboolean coredir, gboolean to_stderr,
+    int argc, char **argv)
+{
+    return crm_log_init_worker(entity, level, coredir, to_stderr, argc, argv, TRUE);
+}
+
+gboolean
+crm_log_init_worker(
+    const char *entity, int level, gboolean coredir, gboolean to_stderr,
+    int argc, char **argv, gboolean quiet)
+{
 	/* Redirect messages from glib functions to our handler */
 /*  	cl_malloc_forced_for_glib(); */
 #ifdef HAVE_G_LOG_SET_DEFAULT_HANDLER
@@ -485,33 +500,51 @@ crm_log_init(
 	
 	/* and for good measure... - this enum is a bit field (!) */
 	g_log_set_always_fatal((GLogLevelFlags)0); /*value out of range*/
+
+	if(entity) {
+	    crm_system_name = entity;
+
+	} else if(argc > 0 && argv != NULL) {
+	    crm_system_name = basename(argv[0]);
+	    if(strstr(crm_system_name, "lt-") == crm_system_name) {
+		crm_system_name += 3;
+	    }
+	    
+	} else if(crm_system_name == NULL) {
+	    crm_system_name = "Unknown";	    
+	}
 	
-	crm_system_name = entity;
 	setenv("PCMK_service", crm_system_name, 1);
-	cl_log_set_entity(entity);
-	if(argc == 0) {
+	cl_log_set_entity(crm_system_name);
+	set_crm_log_level(level);
+	crm_set_env_options();
+
+	if(quiet) {
 	    /* Nuke any syslog activity */
 	    unsetenv("HA_logfacility");
 
-	} else if(getenv("HA_logfacility") == NULL) {
-	    /* Set a default */
-	    cl_log_set_facility(HA_LOG_FACILITY);
-	} /* else: picked up by crm_set_env_options() */
-
+	} else {
+	    cl_log_args(argc, argv);
+	    if(getenv("HA_logfacility") == NULL) {
+		/* Set a default */
+		cl_log_set_facility(HA_LOG_FACILITY);
+	    } /* else: picked up by crm_set_env_options() */
+	}
+	
+	cl_log_enable_stderr(to_stderr);
+	
 	if(coredir) {
 	    const char *user = getenv("USER");
-	    if(safe_str_neq(user, "root") && safe_str_neq(user, CRM_DAEMON_USER)) {
-		crm_info("Not switching to corefile directory");
+	    if(user != NULL && safe_str_neq(user, "root") && safe_str_neq(user, CRM_DAEMON_USER)) {
+		crm_info("Not switching to corefile directory for %s", user);
 		coredir = FALSE;
 	    }
 	}
+
 	if(coredir) {
 	    int user = getuid();
-	    struct passwd *pwent = NULL;
 	    const char *base = HA_COREDIR;
-	    
-	    pwent = getpwuid(user);
-
+	    struct passwd *pwent = getpwuid(user);
 	    
 	    if (pwent == NULL) {
 		crm_perror(LOG_ERR, "Cannot get name for uid: %d", user);
@@ -532,12 +565,6 @@ crm_log_init(
 	    }
 	}
 	
-	set_crm_log_level(level);
-	crm_set_env_options();
-
-	cl_log_args(argc, argv);
-	cl_log_enable_stderr(to_stderr);
-
 	crm_signal(DEBUG_INC, alter_debug);
 	crm_signal(DEBUG_DEC, alter_debug);
 
@@ -549,14 +576,7 @@ unsigned int
 set_crm_log_level(unsigned int level)
 {
 	unsigned int old = crm_log_level;
-
-	while(crm_log_level < 100 && crm_log_level < level) {
-		alter_debug(DEBUG_INC);
-	}
-	while(crm_log_level > 0 && crm_log_level > level) {
-		alter_debug(DEBUG_DEC);
-	}
-	
+	crm_log_level = level;	
 	return old;
 }
 
@@ -1113,7 +1133,7 @@ decode_transition_magic(
     CRM_CHECK(op_rc != NULL, return FALSE);
     CRM_CHECK(op_status != NULL, return FALSE);
     
-    crm_malloc0(key, strlen(magic));
+    crm_malloc0(key, strlen(magic)+1);
     res = sscanf(magic, "%d:%d;%s", op_status, op_rc, key);
     if(res != 3) {
 	crm_crit("Only found %d items in: %s", res, magic);
@@ -1162,7 +1182,7 @@ decode_transition_key(
 	CRM_CHECK(action_id != NULL, return FALSE);
 	CRM_CHECK(transition_id != NULL, return FALSE);
 	
-	crm_malloc0(*uuid, strlen(key));
+	crm_malloc0(*uuid, strlen(key)+1);
 	res = sscanf(key, "%d:%d:%d:%s", action_id, transition_id, target_rc, *uuid);
 	switch(res) {
 	    case 4:
@@ -1305,7 +1325,7 @@ filter_action_parameters(xmlNode *param_
 	key = crm_meta_name(XML_ATTR_TIMEOUT);
 	timeout = crm_element_value_copy(param_set, key);
 	
-	xml_prop_iter(param_set, prop_name, prop_value,      
+	xml_prop_name_iter(param_set, prop_name,      
 		      do_delete = FALSE;
 		      if(strncasecmp(prop_name, CRM_META, meta_len) == 0) {
 			      do_delete = TRUE;
@@ -1339,7 +1359,7 @@ filter_reload_parameters(xmlNode *param_
 		return;
 	}
 
-	xml_prop_iter(param_set, prop_name, prop_value,      
+	xml_prop_name_iter(param_set, prop_name,
 		      name = NULL;
 		      len = strlen(prop_name) + 3;
 
@@ -1460,6 +1480,7 @@ get_last_sequence(const char *directory,
 	length = ftell(file_strm);
 	fseek(file_strm, 0L, start);
 	
+	CRM_ASSERT(length >= 0);
 	CRM_ASSERT(start == ftell(file_strm));
 
 	crm_debug_3("Reading %d bytes from file", length);
@@ -1596,7 +1617,7 @@ crm_read_pidfile(const char *filename)
     }
     
   bail:
-    close(fd);
+    if(fd >= 0) { close(fd); }
     return pid;
 }
 
@@ -1821,43 +1842,128 @@ crm_set_bit(const char *function, long l
 	return word;
 }
 
-static const char *cluster_type = NULL;
+const char *
+name_for_cluster_type(enum cluster_type_e type)
+{
+    switch(type) {
+	case pcmk_cluster_classic_ais:
+	    return "classic openais (with plugin)";
+	case pcmk_cluster_cman:
+	    return "cman";
+	case pcmk_cluster_corosync:
+	    return "corosync";
+	case pcmk_cluster_heartbeat:
+	    return "heartbeat";
+	case pcmk_cluster_unknown:
+	    return "unknown";
+	case pcmk_cluster_invalid:
+	    return "invalid";
+    }
+    crm_err("Invalid cluster type: %d", type);
+    return "invalid";
+}
+
+/* Do not expose these two */
+int set_cluster_type(enum cluster_type_e type);
+static enum cluster_type_e cluster_type = pcmk_cluster_unknown;
+
+int set_cluster_type(enum cluster_type_e type) 
+{
+    if(cluster_type == pcmk_cluster_unknown) {
+	crm_info("Cluster type set to: %s", name_for_cluster_type(cluster_type));
+	cluster_type = type;
+	return 0;
+    } else if(cluster_type == type) {
+	return 0;
+
+    } else if(pcmk_cluster_unknown == type) {
+	cluster_type = type;
+	return 0;
+    }
+    crm_err("Cluster type already set to %s", name_for_cluster_type(cluster_type));
+    return -1;
+}
+
+enum cluster_type_e
+get_cluster_type(void) 
+{
+    if(cluster_type == pcmk_cluster_unknown) {
+	const char *cluster = getenv("HA_cluster_type");
+	cluster_type = pcmk_cluster_invalid;
+	if(cluster) {
+	    crm_info("Cluster type is: '%s'.", cluster);
+	}
+	if(cluster == NULL || safe_str_eq(cluster, "heartbeat")) {
+#if SUPPORT_HEARTBEAT
+	    cluster_type = pcmk_cluster_heartbeat;
+#else
+	    crm_crit("This installation of Pacemaker does not support the '%s' cluster infrastructure.  Terminating.",
+		     cluster);
+	    exit(100);
+#endif
+	} else if(safe_str_eq(cluster, "openais")) {
+#if SUPPORT_COROSYNC
+	    cluster_type = pcmk_cluster_classic_ais;
+#else
+	    crm_crit("This installation of Pacemaker does not support the '%s' cluster infrastructure.  Terminating.",
+		     cluster);
+	    exit(100);
+#endif
+	} else if(safe_str_eq(cluster, "corosync")) {
+#if SUPPORT_COROSYNC
+	    cluster_type = pcmk_cluster_corosync;
+#else
+	    crm_crit("This installation of Pacemaker does not support the '%s' cluster infrastructure.  Terminating.",
+		     cluster);
+	    exit(100);
+#endif
+	} else if(safe_str_eq(cluster, "cman")) {
+#if SUPPORT_CMAN
+	    cluster_type = pcmk_cluster_cman;
+#else
+	    crm_crit("This installation of Pacemaker does not support the '%s' cluster infrastructure.  Terminating.",
+		     cluster);
+	    exit(100);
+#endif
+	} else {
+	    crm_crit("Unknown cluster type: '%s'.  Terminating.", cluster);
+	    exit(100);
+	}
+    }
+    return cluster_type;
+}
+
+gboolean is_cman_cluster(void)
+{
+    return get_cluster_type() == pcmk_cluster_cman;
+}
+
+gboolean is_corosync_cluster(void)
+{
+    return get_cluster_type() == pcmk_cluster_corosync;
+}
+
+gboolean is_classic_ais_cluster(void)
+{
+    return get_cluster_type() == pcmk_cluster_classic_ais;
+}
 
 gboolean is_openais_cluster(void)
 {
-    if(cluster_type == NULL) {
-	cluster_type = getenv("HA_cluster_type");
-	if(cluster_type == NULL) {
-	    cluster_type = "Heartbeat";
-	}
-    }
-    
-    if(safe_str_eq("openais", cluster_type)) {
-#if SUPPORT_AIS
+    enum cluster_type_e type = get_cluster_type();
+    if(type == pcmk_cluster_classic_ais) {
 	return TRUE;
-#else
-	crm_crit("The installation of Pacemaker only supports Heartbeat"
-		 " but you're trying to run it on %s.  Terminating.",
-		 cluster_type);
-	exit(100);
-#endif
+    } else if(type == pcmk_cluster_corosync) {
+	return TRUE;
+    } else if(type == pcmk_cluster_cman) {
+	return TRUE;
     }
     return FALSE;
 }
 
 gboolean is_heartbeat_cluster(void)
 {
-#if SUPPORT_HEARTBEAT
-    return !is_openais_cluster();
-#else
-    if(is_openais_cluster() == FALSE) {
-	crm_crit("The installation of Pacemaker only supports OpenAIS"
-		 " but you're trying to run it on %s.  Terminating.",
-		 cluster_type);
-	exit(100);
-    }
-    return FALSE;
-#endif
+    return get_cluster_type() == pcmk_cluster_heartbeat;
 }
 
 gboolean crm_str_eq(const char *a, const char *b, gboolean use_case) 
@@ -2014,17 +2120,13 @@ void crm_help(char cmd, int exit_code)
     FILE *stream = (exit_code ? stderr : stdout);
 
     if(cmd == 'v' || cmd == '$') {
-	fprintf(stream, "%s %s for %s (Build: %s)\n",
-		crm_system_name, VERSION,
-		#if !SUPPORT_HEARTBEAT
-		"OpenAIS",
-		#elif !SUPPORT_AIS
-		"Heartbeat",
-		#else
-		"OpenAIS and Heartbeat",
-		#endif
-		BUILD_VERSION);
-	fprintf(stream, "\nWritten by Andrew Beekhof\n");
+	fprintf(stream, "Pacemaker %s\n", VERSION);
+	fprintf(stream, "Written by Andrew Beekhof\n");
+	goto out;
+    }
+
+    if(cmd == '!') {
+	fprintf(stream, "Pacemaker %s (Build: %s): %s\n", VERSION, BUILD_VERSION, CRM_FEATURES);
 	goto out;
     }
     
@@ -2360,3 +2462,15 @@ create_operation_update(
     crm_free(op_id);
     return xml_op;
 }
+
+void
+free_lrm_op(lrm_op_t *op) 
+{
+	g_hash_table_destroy(op->params);
+	crm_free(op->user_data);
+	crm_free(op->output);
+	crm_free(op->rsc_id);
+	crm_free(op->op_type);
+	crm_free(op->app_name);
+	crm_free(op);	
+}
diff -r f059ec7ced7a -r b230ffa2ecdc lib/common/xml.c
--- a/lib/common/xml.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/common/xml.c	Mon Jul 12 18:48:04 2010 +0200
@@ -539,6 +539,7 @@ stdin2xml(void)
 
 	if(data_length == 0) {
 	    crm_warn("No XML supplied on stdin");
+	    crm_free(xml_buffer);
 	    return NULL;
 	}
 
@@ -810,7 +811,7 @@ convert_xml_message_struct(HA_Message *p
     }
     
     if(field) {
-	HA_Message *holder = holder = ha_msg_new(3);
+	HA_Message *holder = ha_msg_new(3);
 	CRM_ASSERT(holder != NULL);
 	
 	ha_msg_add(holder, F_XML_TAGNAME, field);
@@ -929,7 +930,7 @@ convert_ha_field(xmlNode *parent, HA_Mes
 	    convert_ha_message(parent, cl_get_struct(msg, name), name);
 	    break;
 	case FT_STRING:
-	    value = cl_get_string(msg, name);
+	    value = msg->values[lpc];
 	    CRM_CHECK_AND_STORE(value != NULL, return);
 	    crm_debug_5("Converting %s/%d/%s", name, type, value[0] == '<' ? "xml":"field");
 
@@ -1461,7 +1462,7 @@ diff_xml_object(xmlNode *old, xmlNode *n
 			diff = create_xml_node(NULL, "diff");
 		}
 		if(removed == NULL) {
-			removed = create_xml_node(diff, "diff-removed");
+			create_xml_node(diff, "diff-removed");
 		}
 		if(added == NULL) {
 			added = create_xml_node(diff, "diff-added");
@@ -1478,7 +1479,7 @@ can_prune_leaf(xmlNode *xml_node)
 	gboolean can_prune = TRUE;
 /* 	return FALSE; */
 	
-	xml_prop_iter(xml_node, prop_name, prop_value,
+	xml_prop_name_iter(xml_node, prop_name,
 		      if(safe_str_eq(prop_name, XML_ATTR_ID)) {
 			      continue;
 		      }		      
@@ -1540,7 +1541,7 @@ in_upper_context(int depth, int context,
 		return 0;
 	}
 	
-	xml_prop_iter(xml_node, prop_name, prop_value,
+	xml_prop_name_iter(xml_node, prop_name,
 		      has_attributes = TRUE;
 		      break;
 		);
@@ -2016,7 +2017,7 @@ sorted_xml(xmlNode *input, xmlNode *pare
 	GListPtr unsorted = NULL;
 	name_value_t *pair = NULL;
 	xmlNode *result = NULL;
-	const char *name = crm_element_name(input);
+	const char *name = NULL;
 
 	CRM_CHECK(input != NULL, return NULL);
 	
@@ -2755,7 +2756,7 @@ get_xpath_object(const char *xpath, xmlN
     nodePath = (char *)xmlGetNodePath(xml_obj);
     if(xpathObj == NULL || xpathObj->nodesetval == NULL || xpathObj->nodesetval->nodeNr < 1) {
 	do_crm_log(error_level, "No match for %s in %s", xpath, crm_str(nodePath));
-	crm_log_xml(LOG_DEBUG_2, "Bad Input", xml_obj);
+	crm_log_xml(error_level+1, "Unexpected Input", xml_obj);
 	
     } else if(xpathObj->nodesetval->nodeNr > 1) {
 	int lpc = 0, max = xpathObj->nodesetval->nodeNr;
diff -r f059ec7ced7a -r b230ffa2ecdc lib/fencing/st_client.c
--- a/lib/fencing/st_client.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/fencing/st_client.c	Mon Jul 12 18:48:04 2010 +0200
@@ -238,6 +238,7 @@ static void append_host_specific_args(co
 	    /* keep going */
 	    
 	} else if(map[lpc] == '=' || map[lpc] == ':') {
+	    crm_free(name);
 	    crm_malloc0(name, 1 + lpc - last);
 	    strncpy(name, map + last, lpc - last);
 	    crm_debug("Got name: %s", name);
@@ -284,6 +285,7 @@ static void append_host_specific_args(co
 	    last = lpc;
 	}   
     }
+    crm_free(name);    
 }
 
 static char *make_args(GHashTable *dev_hash, GHashTable *node_hash, const char *action, const char *victim)
@@ -298,7 +300,7 @@ static char *make_args(GHashTable *dev_h
     }
     
     append_const_arg(STONITH_ATTR_ACTION_OP, action, &arg_list);
-    if(victim) {
+    if(victim && safe_str_neq("none", map)) {
 	append_const_arg("nodename", victim, &arg_list);
 	append_host_specific_args(victim, map, node_hash, &arg_list);
     }
@@ -355,7 +357,7 @@ int run_stonith_agent(
 	} while (ret < 0 && errno == EINTR);
 
 	if (ret != len) {
-	    if(rc >= 0) {
+	    if(ret >= 0) {
 		rc = st_err_generic;
 	    }
 	    goto fail;
@@ -440,11 +442,12 @@ int run_stonith_agent(
   fail:
     crm_free(args);
 
-    close(p_read_fd);
-    close(p_write_fd);
+    if(p_read_fd >= 0) { close(p_read_fd); }
+    if(p_write_fd >= 0) { close(p_write_fd); }
 
-    close(c_read_fd);
-    close(c_write_fd);
+    if(c_read_fd >= 0) { close(c_read_fd); }
+    if(c_write_fd >= 0) { close(c_write_fd); }
+	
     return rc;
 }
 
@@ -554,6 +557,20 @@ static int stonith_api_device_metadata(
     return rc;
 }
 
+static int stonith_api_confirm(
+    stonith_t *stonith, int call_options, const char *target)
+{
+    int rc = 0; 
+    xmlNode *data = NULL;
+
+    data = create_xml_node(NULL, __FUNCTION__);
+    crm_xml_add(data, F_STONITH_TARGET, target);
+    rc = stonith_send_command(stonith, STONITH_OP_FENCE, data, NULL, call_options, 0);
+    free_xml(data);
+    
+    return rc;
+}
+
 static int stonith_api_query(
     stonith_t *stonith, int call_options, const char *target, GListPtr *devices, int timeout)
 {
@@ -575,16 +592,18 @@ static int stonith_api_query(
     }
     
     xpathObj = xpath_search(output, "//@agent");
-    max = xpathObj->nodesetval->nodeNr;
+    if(xpathObj) {
+	max = xpathObj->nodesetval->nodeNr;
 
-    for(lpc = 0; lpc < max; lpc++) {
-	xmlNode *match = getXpathResult(xpathObj, lpc);
-	CRM_CHECK(match != NULL, continue);
-	
-	crm_info("%s[%d] = %s", "//@agent", lpc, xmlGetNodePath(match));
-	*devices = g_list_append(*devices, crm_element_value_copy(match, XML_ATTR_ID));
+	for(lpc = 0; lpc < max; lpc++) {
+	    xmlNode *match = getXpathResult(xpathObj, lpc);
+	    CRM_CHECK(match != NULL, continue);
+	    
+	    crm_info("%s[%d] = %s", "//@agent", lpc, xmlGetNodePath(match));
+	    *devices = g_list_append(*devices, crm_element_value_copy(match, XML_ATTR_ID));
+	}
     }
-
+    
     free_xml(output);
     free_xml(data);
     return max;
@@ -1575,6 +1594,7 @@ stonith_t *stonith_api_new(void)
     
     new_stonith->cmds->call       = stonith_api_call;
     new_stonith->cmds->fence      = stonith_api_fence;
+    new_stonith->cmds->confirm    = stonith_api_confirm;
     new_stonith->cmds->metadata   = stonith_api_device_metadata;
 
     new_stonith->cmds->query           = stonith_api_query;
diff -r f059ec7ced7a -r b230ffa2ecdc lib/pengine/common.c
--- a/lib/pengine/common.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/pengine/common.c	Mon Jul 12 18:48:04 2010 +0200
@@ -136,7 +136,7 @@ pe_cluster_option pe_opts[] = {
 
 	/* Orphans and stopping */
 	{ "stop-all-resources", NULL, "boolean", NULL, "false", &check_boolean,
-	  "Should the cluster stop all active resources", NULL },
+	  "Should the cluster stop all active resources (except those needed for fencing)", NULL },
 	{ "stop-orphan-resources", "stop_orphan_resources", "boolean", NULL, "true", &check_boolean,
 	  "Should deleted resources be stopped", NULL },
 	{ "stop-orphan-actions", "stop_orphan_actions", "boolean", NULL, "true", &check_boolean,
diff -r f059ec7ced7a -r b230ffa2ecdc lib/pengine/status.c
--- a/lib/pengine/status.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/pengine/status.c	Mon Jul 12 18:48:04 2010 +0200
@@ -32,9 +32,6 @@
 #include <utils.h>
 #include <unpack.h>
 
-xmlNode * do_calculations(
-	pe_working_set_t *data_set, xmlNode *xml_input, ha_time_t *now);
-
 extern xmlNode*get_object_root(
     const char *object_type, xmlNode *the_root);
 
@@ -74,9 +71,11 @@ cluster_status(pe_working_set_t *data_se
 		data_set->input, XML_ATTR_HAVE_QUORUM);
 	
 	crm_debug_3("Beginning unpack");
+	pe_dataset = data_set;
 	
 	/* reset remaining global variables */
-	
+	data_set->failed = create_xml_node(NULL, "failed-ops");
+
 	if(data_set->input == NULL) {
 		return FALSE;
 	}
@@ -179,6 +178,7 @@ pe_free_nodes(GListPtr nodes)
 void
 cleanup_calculations(pe_working_set_t *data_set)
 {
+	pe_dataset = NULL;
 	if(data_set == NULL) {
 		return;
 	}
@@ -195,8 +195,9 @@ cleanup_calculations(pe_working_set_t *d
 	crm_debug_3("deleting actions");
 	pe_free_actions(data_set->actions);
 
-	g_hash_table_destroy(data_set->domains);
-	data_set->domains = NULL;
+	if(data_set->domains) {
+	    g_hash_table_destroy(data_set->domains);
+	}
 	
 	crm_debug_3("deleting nodes");
 	pe_free_nodes(data_set->nodes);
@@ -205,7 +206,8 @@ cleanup_calculations(pe_working_set_t *d
 	free_ha_date(data_set->now);
 	free_xml(data_set->input);
 	free_xml(data_set->failed);
-	data_set->stonith_action = NULL;
+
+	set_working_set_defaults(data_set);
 
 	CRM_CHECK(data_set->ordering_constraints == NULL, ;);
 	CRM_CHECK(data_set->placement_constraints == NULL, ;);
@@ -215,36 +217,18 @@ cleanup_calculations(pe_working_set_t *d
 void
 set_working_set_defaults(pe_working_set_t *data_set) 
 {
-	data_set->failed = create_xml_node(NULL, "failed-ops");
-	
-	data_set->now			  = NULL;
-	data_set->input			  = NULL;
-	data_set->graph			  = NULL;
-	data_set->dc_uuid		  = NULL;
-	data_set->dc_node		  = NULL;
+    pe_dataset = data_set;
+    memset(data_set, 0, sizeof(pe_working_set_t));
 
-	data_set->nodes			  = NULL;
-	data_set->actions		  = NULL;	
-	data_set->resources		  = NULL;
-	data_set->config_hash		  = NULL;
-	data_set->stonith_action	  = NULL;
-	data_set->ordering_constraints    = NULL;
-	data_set->placement_constraints   = NULL;
-	data_set->colocation_constraints  = NULL;
+    data_set->order_id		  = 1;
+    data_set->action_id		  = 1;
+    data_set->no_quorum_policy	  = no_quorum_freeze;
 
-	data_set->order_id		  = 1;
-	data_set->action_id		  = 1;
-	data_set->num_synapse		  = 0;
-	data_set->max_valid_nodes	  = 0;
-	data_set->no_quorum_policy	  = no_quorum_freeze;
-
-	data_set->default_resource_stickiness = 0;
-
-	data_set->flags = 0x0ULL;
-	set_bit_inplace(data_set->flags, pe_flag_stop_rsc_orphans);
-	set_bit_inplace(data_set->flags, pe_flag_symmetric_cluster);
-	set_bit_inplace(data_set->flags, pe_flag_is_managed_default);
-	set_bit_inplace(data_set->flags, pe_flag_stop_action_orphans);	
+    data_set->flags = 0x0ULL;
+    set_bit_inplace(data_set->flags, pe_flag_stop_rsc_orphans);
+    set_bit_inplace(data_set->flags, pe_flag_symmetric_cluster);
+    set_bit_inplace(data_set->flags, pe_flag_is_managed_default);
+    set_bit_inplace(data_set->flags, pe_flag_stop_action_orphans);	
 }
 
 
diff -r f059ec7ced7a -r b230ffa2ecdc lib/pengine/unpack.c
--- a/lib/pengine/unpack.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/pengine/unpack.c	Mon Jul 12 18:48:04 2010 +0200
@@ -334,7 +334,6 @@ unpack_domains(xmlNode *xml_domains, pe_
 	    node = pe_find_node(data_set->nodes, uname);
 	    if(node == NULL) {
 		node = pe_find_node_id(data_set->nodes, uname);
-		continue;
 	    }
 	    if(node == NULL) {
 		crm_config_warn("Invalid domain %s: Node %s does not exist", id, uname);
@@ -488,9 +487,6 @@ determine_online_status_no_fencing(pe_wo
 		crm_debug_2("Node is down: ha_state=%s, ccm_state=%s",
 			    crm_str(ha_state), crm_str(ccm_state));
 		
-	} else if(!crm_is_true(ccm_state)
-		  || safe_str_eq(ha_state, DEADSTATUS)) {
-
 	} else if(safe_str_eq(crm_state, ONLINESTATUS)) {
 		if(safe_str_eq(join_state, CRMD_JOINSTATE_MEMBER)) {
 			online = TRUE;
@@ -831,9 +827,11 @@ create_fake_resource(const char *rsc_id,
 	crm_xml_add(xml_rsc, XML_ATTR_ID, rsc_id);
 	crm_log_xml_debug(xml_rsc, "Orphan resource");
 	
-	common_unpack(xml_rsc, &rsc, NULL, data_set);
+	if(!common_unpack(xml_rsc, &rsc, NULL, data_set)) {
+	    return NULL;
+	}
+
 	set_bit(rsc->flags, pe_rsc_orphan);
-	
 	data_set->resources = g_list_append(data_set->resources, rsc);
 	return rsc;
 }
@@ -1061,7 +1059,7 @@ process_rsc_state(resource_t *rsc, node_
 		break;
 		
 	    case action_migrate_failure:
-		/* anything extra? */
+		/* Unreachable, leave to satisfy compiler */
 		break;
 	}
 	
@@ -1315,13 +1313,13 @@ unpack_rsc_op(resource_t *rsc, node_t *n
 /* 	const char *target_rc   = NULL;	 */
 	const char *task_status = NULL;
 	const char *interval_s  = NULL;
-	const char *op_digest   = NULL;
 	const char *op_version  = NULL;
 
 	int interval = 0;
 	int task_status_i = -2;
 	int actual_rc_i = 0;
 	int target_rc = -1;
+	int last_failure = 0;
 	
 	action_t *action = NULL;
 	node_t *effective_node = NULL;
@@ -1338,7 +1336,6 @@ unpack_rsc_op(resource_t *rsc, node_t *n
 	task        = crm_element_value(xml_op, XML_LRM_ATTR_TASK);
  	task_id     = crm_element_value(xml_op, XML_LRM_ATTR_CALLID);
 	task_status = crm_element_value(xml_op, XML_LRM_ATTR_OPSTATUS);
-	op_digest   = crm_element_value(xml_op, XML_LRM_ATTR_OP_DIGEST);
 	op_version  = crm_element_value(xml_op, XML_ATTR_CRM_VERSION);
 	magic	    = crm_element_value(xml_op, XML_ATTR_TRANSITION_MAGIC);
 	key	    = crm_element_value(xml_op, XML_ATTR_TRANSITION_KEY);
@@ -1420,14 +1417,16 @@ unpack_rsc_op(resource_t *rsc, node_t *n
 
 	if(task_status_i != actual_rc_i
 	   && rsc->failure_timeout > 0
-	   && get_failcount(node, rsc, NULL, data_set) == 0) {
-	    action_t *clear_op = NULL;
-	    clear_op = custom_action(
-		rsc, crm_concat(rsc->id, CRM_OP_CLEAR_FAILCOUNT, '_'),
-		CRM_OP_CLEAR_FAILCOUNT, node, FALSE, TRUE, data_set);
-	    
-	    add_hash_param(clear_op->meta, XML_ATTR_TE_NOWAIT, XML_BOOLEAN_TRUE);	    
-	    crm_notice("Clearing expired failcount for %s on %s", rsc->id, node->details->uname);
+	   && get_failcount(node, rsc, &last_failure, data_set) == 0) {
+	    if(last_failure > 0) {
+		action_t *clear_op = NULL;
+		clear_op = custom_action(
+		    rsc, crm_concat(rsc->id, CRM_OP_CLEAR_FAILCOUNT, '_'),
+		    CRM_OP_CLEAR_FAILCOUNT, node, FALSE, TRUE, data_set);
+		
+		add_hash_param(clear_op->meta, XML_ATTR_TE_NOWAIT, XML_BOOLEAN_TRUE);	    
+		crm_notice("Clearing expired failcount for %s on %s", rsc->id, node->details->uname);
+	    }
 	}
 	
 	if(expired
diff -r f059ec7ced7a -r b230ffa2ecdc lib/pengine/utils.c
--- a/lib/pengine/utils.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/pengine/utils.c	Mon Jul 12 18:48:04 2010 +0200
@@ -26,6 +26,8 @@
 #include <crm/pengine/rules.h>
 #include <utils.h>
 
+pe_working_set_t *pe_dataset = NULL;
+
 extern xmlNode *get_object_root(const char *object_type,xmlNode *the_root);
 void print_str_str(gpointer key, gpointer value, gpointer user_data);
 gboolean ghash_free_str_str(gpointer key, gpointer value, gpointer user_data);
@@ -140,9 +142,7 @@ GListPtr
 node_list_exclude(GListPtr list1, GListPtr list2, gboolean merge_scores)
 {
     node_t *other_node = NULL;
-    GListPtr result = NULL;
-    
-    result = node_list_dup(list1, FALSE, FALSE);
+    GListPtr result = list1;
     
     slist_iter(
 	node, node_t, result, lpc,
@@ -535,7 +535,9 @@ custom_action(resource_t *rsc, char *key
 		action->rsc  = rsc;
 		CRM_ASSERT(task != NULL);
 		action->task = crm_strdup(task);
-		action->node = on_node;
+		if(on_node) {
+		    action->node = node_copy(on_node);
+		}
 		action->uuid = key;
 		
 		action->failure_is_fatal = TRUE;
@@ -929,12 +931,15 @@ xmlNode *
 find_rsc_op_entry(resource_t *rsc, const char *key) 
 {
 	int number = 0;
+	gboolean do_retry = TRUE;
+	char *local_key = NULL;
 	const char *name = NULL;
 	const char *value = NULL;
 	const char *interval = NULL;
 	char *match_key = NULL;
 	xmlNode *op = NULL;
-	
+
+  retry:
 	xml_child_iter_filter(
 		rsc->ops_xml, operation, "op",
 
@@ -958,20 +963,29 @@ find_rsc_op_entry(resource_t *rsc, const
 		crm_free(match_key);
 
 		if(op != NULL) {
-			return op;
+		    crm_free(local_key);
+		    return op;
 		}
 		);
 
+	crm_free(local_key);
+	if(do_retry == FALSE) {
+	    return NULL;
+	}
+	
+	do_retry = FALSE;
 	if(strstr(key, CRMD_ACTION_MIGRATE) || strstr(key, CRMD_ACTION_MIGRATED)) {
-	    match_key = generate_op_key(rsc->id, "migrate", 0);
-	    op = find_rsc_op_entry(rsc, match_key);
-	    crm_free(match_key);
+	    local_key = generate_op_key(rsc->id, "migrate", 0);
+	    key = local_key;
+	    goto retry;
+	    
+	} else if(strstr(key, "_notify_")) {
+	    local_key = generate_op_key(rsc->id, "notify", 0);
+	    key = local_key;
+	    goto retry;
 	}
-
-	if(op == NULL) {
-	    crm_debug_3("No match for %s", key);
-	}
-	return op;
+	
+	return NULL;
 }
 
 void
@@ -1053,6 +1067,7 @@ pe_free_action(action_t *action)
 	}
 	crm_free(action->task);
 	crm_free(action->uuid);
+	crm_free(action->node);
 	crm_free(action);
 }
 
@@ -1136,7 +1151,7 @@ find_actions(GListPtr input, const char 
 				    " it to the requested node...",
 				    key, on_node->details->uname);
 
-			action->node = on_node;
+			action->node = node_copy(on_node);
 			result = g_list_append(result, action);
 			
 		} else if(on_node->details == action->node->details) {
diff -r f059ec7ced7a -r b230ffa2ecdc lib/pengine/utils.h
--- a/lib/pengine/utils.h	Mon May 17 17:57:40 2010 +0200
+++ b/lib/pengine/utils.h	Mon Jul 12 18:48:04 2010 +0200
@@ -20,6 +20,7 @@
 #include <crm/pengine/common.h>
 #include <crm/pengine/status.h>
 
+extern pe_working_set_t *pe_dataset;
 
 extern node_t *node_copy(node_t *this_node) ;
 extern time_t get_timet_now(pe_working_set_t *data_set);
diff -r f059ec7ced7a -r b230ffa2ecdc lib/plugins/lrm/raexecstonith.c
--- a/lib/plugins/lrm/raexecstonith.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/plugins/lrm/raexecstonith.c	Mon Jul 12 18:48:04 2010 +0200
@@ -244,8 +244,7 @@ get_resource_list(GList ** rsc_info)
 	    
 	    snprintf(buffer,FILENAME_MAX,"%s/%s",
 		     RH_STONITH_DIR, namelist[file_num]->d_name);
-	    stat(buffer, &prop);
-	    if (S_ISREG(prop.st_mode)) {
+	    if(stat(buffer, &prop) == 0 && S_ISREG(prop.st_mode)) {
 		*rsc_info = g_list_append(*rsc_info, g_strdup(namelist[file_num]->d_name));
 	    }
 
@@ -262,9 +261,6 @@ get_provider_list(const char* op_type, G
 {
     if(providers == NULL) {
 	return -1;
-
-    } else if(op_type == NULL) {
-	return -2;
     }
 
     if(op_type == NULL) {
diff -r f059ec7ced7a -r b230ffa2ecdc lib/transition/unpack.c
--- a/lib/transition/unpack.c	Mon May 17 17:57:40 2010 +0200
+++ b/lib/transition/unpack.c	Mon Jul 12 18:48:04 2010 +0200
@@ -282,13 +282,12 @@ lrm_op_t *convert_graph_action(xmlNode *
     CRM_CHECK(action != NULL, return NULL);
     CRM_CHECK(action->type == action_type_rsc, return NULL);
     
+    action_resource = first_named_child(action->xml, XML_CIB_TAG_RESOURCE);
+    CRM_CHECK(action_resource != NULL, crm_log_xml_warn(action->xml, "Bad"); return NULL);
+
     crm_malloc0(op, sizeof(lrm_op_t));
-    
     op->app_name = crm_strdup(crm_system_name);
 
-    action_resource = first_named_child(action->xml, XML_CIB_TAG_RESOURCE);
-    CRM_CHECK(action_resource != NULL, crm_log_xml_warn(action->xml, "Bad"); return NULL);
-    
     op->rsc_id = crm_strdup(ID(action_resource));
     op->interval = action->interval;
     op->op_type = crm_strdup(crm_element_value(action->xml, XML_LRM_ATTR_TASK));
diff -r f059ec7ced7a -r b230ffa2ecdc mcp/Makefile.am
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/mcp/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,50 @@
+#
+# Copyright (C) 2004-2009 Andrew Beekhof
+#
+# This program is free software; you can redistribute it and/or
+# modify it under the terms of the GNU General Public License
+# as published by the Free Software Foundation; either version 2
+# of the License, or (at your option) any later version.
+# 
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+# 
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+#
+MAINTAINERCLEANFILES    = Makefile.in 
+
+INCLUDES                = -I$(top_builddir)/include -I$(top_srcdir)/include   \
+			  -I$(top_builddir)/libltdl -I$(top_srcdir)/libltdl
+
+initdir			= $(INITDIR)
+init_SCRIPTS		= pacemaker
+sbin_PROGRAMS		= pacemakerd 
+
+if BUILD_HELP
+man8_MANS =	$(sbin_PROGRAMS:%=%.8)
+endif
+
+## SOURCES
+
+noinst_HEADERS		= 
+
+pacemakerd_SOURCES	= pacemaker.c corosync.c
+pacemakerd_LDADD	= $(CLUSTERLIBS) $(top_builddir)/lib/common/libcrmcommon.la -lcfg -lconfdb
+
+%.8:	%
+	echo Creating $@
+	chmod a+x $(top_builddir)/mcp/$<
+	help2man --output $@ --no-info --section 8 --name "Part of the Pacemaker cluster resource manager" $(top_builddir)/mcp/$<
+
+clean-generic:
+	rm -f *.log *.debug *.xml *~
+
+install-exec-local:
+
+uninstall-local:
+
+.PHONY: install-exec-hook
diff -r f059ec7ced7a -r b230ffa2ecdc mcp/corosync.c
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/mcp/corosync.c	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,634 @@
+/* 
+ * Copyright (C) 2010 Andrew Beekhof <andrew@beekhof.net>
+ * 
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ * 
+ * This software is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+#include <crm_internal.h>
+#include <pacemaker.h>
+
+#include <sys/utsname.h>
+
+#include <corosync/cfg.h>
+#include <corosync/cpg.h>
+#include <corosync/confdb.h>
+
+#ifdef SUPPORT_CMAN
+#include <libcman.h>
+#endif
+
+static struct cpg_name cpg_group = {
+    .length = 0,
+    .value[0] = 0,
+};
+
+gboolean use_cman = FALSE;
+static cpg_handle_t cpg_handle;
+static corosync_cfg_handle_t cfg_handle;
+static corosync_cfg_state_notification_t cfg_buffer;
+
+static inline const char *ais_error2text(int error) 
+{
+	const char *text = "unknown";
+	switch(error) {
+	    case CS_OK:
+		text = "None";
+		break;
+	    case CS_ERR_LIBRARY:
+		text = "Library error";
+		break;
+	    case CS_ERR_VERSION:
+		text = "Version error";
+		break;
+	    case CS_ERR_INIT:
+		text = "Initialization error";
+		break;
+	    case CS_ERR_TIMEOUT:
+		text = "Timeout";
+		break;
+	    case CS_ERR_TRY_AGAIN:
+		text = "Try again";
+		break;
+	    case CS_ERR_INVALID_PARAM:
+		text = "Invalid parameter";
+		break;
+	    case CS_ERR_NO_MEMORY:
+		text = "No memory";
+		break;
+	    case CS_ERR_BAD_HANDLE:
+		text = "Bad handle";
+		break;
+	    case CS_ERR_BUSY:
+		text = "Busy";
+		break;
+	    case CS_ERR_ACCESS:
+		text = "Access error";
+		break;
+	    case CS_ERR_NOT_EXIST:
+		text = "Doesn't exist";
+		break;
+	    case CS_ERR_NAME_TOO_LONG:
+		text = "Name too long";
+		break;
+	    case CS_ERR_EXIST:
+		text = "Exists";
+		break;
+	    case CS_ERR_NO_SPACE:
+		text = "No space";
+		break;
+	    case CS_ERR_INTERRUPT:
+		text = "Interrupt";
+		break;
+	    case CS_ERR_NAME_NOT_FOUND:
+		text = "Name not found";
+		break;
+	    case CS_ERR_NO_RESOURCES:
+		text = "No resources";
+		break;
+	    case CS_ERR_NOT_SUPPORTED:
+		text = "Not supported";
+		break;
+	    case CS_ERR_BAD_OPERATION:
+		text = "Bad operation";
+		break;
+	    case CS_ERR_FAILED_OPERATION:
+		text = "Failed operation";
+		break;
+	    case CS_ERR_MESSAGE_ERROR:
+		text = "Message error";
+		break;
+	    case CS_ERR_QUEUE_FULL:
+		text = "Queue full";
+		break;
+	    case CS_ERR_QUEUE_NOT_AVAILABLE:
+		text = "Queue not available";
+		break;
+	    case CS_ERR_BAD_FLAGS:
+		text = "Bad flags";
+		break;
+	    case CS_ERR_TOO_BIG:
+		text = "To big";
+		break;
+	    case CS_ERR_NO_SECTIONS:
+		text = "No sections";
+		break;
+	}
+	return text;
+}
+
+/* =::=::=::= CFG - Shutdown stuff =::=::=::= */
+
+static void cfg_shutdown_callback(corosync_cfg_handle_t h,
+				  corosync_cfg_shutdown_flags_t flags)
+{
+    crm_info("Corosync wants to shut down: %s",
+		 (flags==COROSYNC_CFG_SHUTDOWN_FLAG_IMMEDIATE)?"immediate":
+		 (flags==COROSYNC_CFG_SHUTDOWN_FLAG_REGARDLESS)?"forced":"optional"
+	);
+
+    /* Never allow corosync to shut down while we're running */
+    corosync_cfg_replyto_shutdown(h, COROSYNC_CFG_SHUTDOWN_FLAG_NO);
+}
+
+static corosync_cfg_callbacks_t cfg_callbacks =
+{
+    .corosync_cfg_shutdown_callback = cfg_shutdown_callback,
+    .corosync_cfg_state_track_callback = NULL,
+};
+
+static gboolean pcmk_cfg_dispatch(int sender, gpointer user_data)
+{
+    corosync_cfg_handle_t *handle = (corosync_cfg_handle_t*)user_data;
+    cs_error_t rc = corosync_cfg_dispatch(*handle, CS_DISPATCH_ALL);
+    if (rc != CS_OK) {
+	return FALSE;
+    }
+    return TRUE;
+}
+
+static void
+cfg_connection_destroy(gpointer user_data)
+{
+    crm_err("Connection destroyed");
+    cfg_handle = 0;
+    return;
+}
+
+gboolean cluster_disconnect_cfg(void)
+{
+    if(cfg_handle) {
+	corosync_cfg_finalize(cfg_handle);
+	cfg_handle = 0;
+    }
+    return TRUE;
+}
+
+#define cs_repeat(counter, max, code) do {		\
+	code;						\
+	if(rc == CS_ERR_TRY_AGAIN) {			\
+	    counter++;					\
+	    crm_debug("Retrying operation after %ds", counter);	\
+	    sleep(counter);				\
+	}						\
+    } while(rc == CS_ERR_TRY_AGAIN && counter < max)
+
+gboolean cluster_connect_cfg(uint32_t *nodeid)
+{
+    cs_error_t rc;
+    int fd = 0, retries = 0;
+
+    cs_repeat(
+	retries, 30, rc = corosync_cfg_initialize(&cfg_handle, &cfg_callbacks));
+    
+    if (rc != CS_OK) {
+	crm_err("corosync cfg init error %d", rc);
+	return FALSE;
+    }
+
+    rc = corosync_cfg_fd_get(cfg_handle, &fd);
+    if (rc != CS_OK) {
+	crm_err("corosync cfg fd_get error %d", rc);
+	goto bail;
+    }
+
+    retries = 0;
+    cs_repeat(retries, 30, rc = corosync_cfg_local_get(cfg_handle, nodeid));
+
+    if (rc != CS_OK) {
+	crm_err("corosync cfg local_get error %d", rc);
+	goto bail;
+    }
+
+    crm_debug("Our nodeid: %d", *nodeid);
+
+    retries = 0;
+    cs_repeat(
+	retries, 30, rc = corosync_cfg_state_track (cfg_handle, 0, &cfg_buffer));
+    
+    if (rc != CS_OK) {
+	crm_err("corosync cfg stack_track error %d", rc);
+	goto bail;
+    }
+    
+    crm_debug("Adding fd=%d to mainloop", fd);
+    G_main_add_fd(
+	G_PRIORITY_HIGH, fd, FALSE, pcmk_cfg_dispatch, &cfg_handle, cfg_connection_destroy);
+    
+    return TRUE;
+
+  bail:
+    corosync_cfg_finalize(cfg_handle);
+    return FALSE;
+}
+
+/* =::=::=::= CPG - Closed Process Group Messaging =::=::=::= */
+
+static gboolean pcmk_cpg_dispatch(int sender, gpointer user_data)
+{
+    cpg_handle_t *handle = (cpg_handle_t*)user_data;
+    cs_error_t rc = cpg_dispatch(*handle, CS_DISPATCH_ALL);
+    if (rc != CS_OK) {
+	return FALSE;
+    }
+    return TRUE;
+}
+
+static void
+cpg_connection_destroy(gpointer user_data)
+{
+    crm_err("Connection destroyed");
+    cpg_handle = 0;
+    return;
+}
+
+static void pcmk_cpg_deliver (
+	cpg_handle_t handle,
+	const struct cpg_name *groupName,
+	uint32_t nodeid,
+	uint32_t pid,
+	void *msg,
+	size_t msg_len)
+{
+    if(nodeid != local_nodeid) {
+	uint32_t procs = 0;
+	xmlNode *xml = string2xml(msg);
+	const char *uname = crm_element_value(xml, "uname");
+
+	crm_element_value_int(xml, "proclist", (int*)&procs);
+	/* crm_debug("Got proclist %.32x from %s", procs, uname); */
+	if(update_node_processes(nodeid, uname, procs)) {
+	    update_process_clients();
+	}
+    }
+}
+
+static void pcmk_cpg_membership(
+	cpg_handle_t handle,
+	const struct cpg_name *groupName,
+	const struct cpg_address *member_list, size_t member_list_entries,
+	const struct cpg_address *left_list, size_t left_list_entries,
+	const struct cpg_address *joined_list, size_t joined_list_entries)
+{
+    /* Don't care about CPG membership */
+    update_process_peers();
+}
+
+cpg_callbacks_t cpg_callbacks = {
+    .cpg_deliver_fn =            pcmk_cpg_deliver,
+    .cpg_confchg_fn =            pcmk_cpg_membership,
+};
+
+gboolean cluster_disconnect_cpg(void)
+{
+    if(cpg_handle) {
+	cpg_finalize(cpg_handle);
+	cpg_handle = 0;
+    }
+    return TRUE;
+}
+
+gboolean cluster_connect_cpg(void)
+{
+    cs_error_t rc;
+    unsigned int nodeid;
+    int fd;
+    int retries = 0;
+    
+    strcpy(cpg_group.value, "pcmk");
+    cpg_group.length = strlen(cpg_group.value)+1;
+    
+    retries = 0;
+    cs_repeat(retries, 30, rc = cpg_initialize(&cpg_handle, &cpg_callbacks));
+    if (rc != CS_OK) {
+	crm_err("corosync cpg init error %d", rc);
+	return FALSE;
+    }
+
+    rc = cpg_fd_get(cpg_handle, &fd);
+    if (rc != CS_OK) {
+	crm_err("corosync cpg fd_get error %d", rc);
+	goto bail;
+    }
+
+    retries = 0;
+    cs_repeat(retries, 30, rc = cpg_local_get(cpg_handle, &nodeid));
+    if (rc != CS_OK) {
+	crm_err("corosync cpg local_get error %d", rc);
+	goto bail;
+    }
+
+    crm_debug("Our nodeid: %d", nodeid);
+
+    retries = 0;
+    cs_repeat(retries, 30, rc = cpg_join(cpg_handle, &cpg_group));
+    
+    if (rc != CS_OK) {
+	crm_err("Could not join the CPG group '%s': %d", crm_system_name, rc);
+	goto bail;
+    }
+    
+    crm_debug("Adding fd=%d to mainloop", fd);
+    G_main_add_fd(
+	G_PRIORITY_HIGH, fd, FALSE, pcmk_cpg_dispatch, &cpg_handle, cpg_connection_destroy);
+    
+    return TRUE;
+
+  bail:
+    cpg_finalize(cpg_handle);
+    return FALSE;
+}
+
+gboolean send_cpg_message(struct iovec *iov) 
+{
+    int rc = CS_OK;
+    int retries = 0;
+
+    errno = 0;
+    cs_repeat(
+	/* 5 retires is plenty, we'll resend once the membership reforms anyway */
+	retries, 5, rc = cpg_mcast_joined(cpg_handle, CPG_TYPE_AGREED, iov, 1));
+    
+    if(rc != CS_OK) {    
+	crm_perror(LOG_ERR,"Sending message via cpg FAILED: (rc=%d) %s",
+		   rc, ais_error2text(rc));
+    }
+
+    return (rc == CS_OK);
+}
+
+
+/* =::=::=::= Configuration =::=::=::= */
+
+static int get_config_opt(
+    confdb_handle_t config,
+    hdb_handle_t object_handle,
+    const char *key, char **value, const char *fallback)
+{
+    size_t len = 0;
+    char *env_key = NULL;
+    const char *env_value = NULL;
+    char buffer[256];
+
+    if(*value) {
+	crm_free(*value);
+	*value = NULL;
+    }
+
+    if(object_handle > 0) {
+	if(CS_OK == confdb_key_get(config, object_handle, key, strlen(key), &buffer, &len)) {
+	    *value = crm_strdup(buffer);
+	}
+    }
+    
+    if (*value) {
+	crm_info("Found '%s' for option: %s", *value, key);
+	return 0;
+    }
+
+    env_key = crm_concat("HA", key, '_');
+    env_value = getenv(env_key);
+    crm_free(env_key);
+
+    if (*value) {
+	crm_info("Found '%s' in ENV for option: %s", *value, key);
+	*value = crm_strdup(env_value);
+	return 0;
+    }
+
+    if(fallback) {
+	crm_info("Defaulting to '%s' for option: %s", fallback, key);
+	*value = crm_strdup(fallback);
+
+    } else {
+	crm_info("No default for option: %s", key);
+    }
+    
+    return -1;
+}
+
+static confdb_handle_t config_find_init(confdb_handle_t config) 
+{
+    cs_error_t rc = CS_OK;    
+    confdb_handle_t local_handle = OBJECT_PARENT_HANDLE;
+
+    rc = confdb_object_find_start(config, local_handle);
+    if(rc == CS_OK) {
+	return local_handle;
+    } else {
+	crm_err("Couldn't create search context: %d", rc);
+    }
+    return 0;
+}
+
+static hdb_handle_t config_find_next(
+    confdb_handle_t config, const char *name, confdb_handle_t top_handle) 
+{
+    cs_error_t rc = CS_OK;
+    hdb_handle_t local_handle = 0;
+
+    if(top_handle == 0) {
+	crm_err("Couldn't search for %s: no valid context", name);
+	return 0;
+    }
+    
+    crm_debug_2("Searching for %s in "HDB_X_FORMAT, name, top_handle);
+    rc = confdb_object_find(config, top_handle, name, strlen(name), &local_handle);
+    if(rc != CS_OK) {
+	crm_info("No additional configuration supplied for: %s", name);
+	local_handle = 0;
+    } else {
+	crm_info("Processing additional %s options...", name);
+    }
+    return local_handle;
+}
+
+char *get_local_node_name(void) 
+{
+    char *name = NULL;
+    struct utsname res;
+    
+    if(use_cman) {
+#ifdef SUPPORT_CMAN
+	cman_node_t us;
+	cman_handle_t cman;
+
+	cman = cman_init(NULL);
+	if(cman != NULL && cman_is_active(cman)) {
+	    us.cn_name[0] = 0;
+	    cman_get_node(cman, CMAN_NODEID_US, &us);
+	    name = crm_strdup(us.cn_name);
+	    crm_info("Using CMAN node name: %s", name);
+
+	} else {
+	    crm_err("Couldn't determin node name from CMAN");
+	}
+	    
+	cman_finish(cman);
+#endif
+	
+    } else if(uname(&res) < 0) {
+	crm_perror(LOG_ERR,"Could not determin the current host");
+	exit(100);
+	
+    } else {
+	name = crm_strdup(res.nodename);
+    }
+    return name;
+}
+
+gboolean read_config(void) 
+{
+    confdb_handle_t config;
+
+    int rc;
+    char *value = NULL;
+    gboolean have_log = FALSE;
+    gboolean have_quorum = FALSE;
+    confdb_handle_t top_handle = 0;
+    hdb_handle_t local_handle = 0;
+    static confdb_callbacks_t callbacks = {};
+
+
+    rc = confdb_initialize (&config, &callbacks);
+    if (rc != CS_OK) {
+	printf ("Could not initialize Cluster Configuration Database API instance error %d\n", rc);
+	return FALSE;
+    }
+
+    crm_info("Reading configure");
+
+    /* =::=::= Should we be here =::=::= */
+    
+    top_handle = config_find_init(config);
+    local_handle = config_find_next(config, "service", top_handle);
+    while(local_handle && have_quorum == FALSE) {
+	crm_free(value);
+	get_config_opt(config, local_handle, "name", &value, NULL);
+	if(safe_str_eq("pacemaker", value)) {
+	    have_quorum = TRUE;
+	    setenv("HA_cluster_type", "openais",  1);
+
+	    crm_free(value);
+	    get_config_opt(config, local_handle, "ver", &value, "0");
+	    if(safe_str_eq(value, "1")) {
+		crm_free(value);
+		get_config_opt(config, local_handle, "use_logd", &value, "no");
+		setenv("HA_use_logd", value, 1);
+		
+		crm_free(value);
+		get_config_opt(config, local_handle, "use_mgmtd", &value, "no");
+		enable_mgmtd(crm_is_true(value));
+
+	    } else {
+		crm_err("We can only start Pacemaker from init if using version 1"
+			" of the Pacemaker plugin for Corosync.  Terminating.");
+		exit(100);
+	    }
+
+	}
+	local_handle = config_find_next(config, "service", top_handle);
+    }
+    
+    /* =::=::= Logging =::=::= */
+
+    crm_free(value);
+    top_handle = config_find_init(config);
+    local_handle = config_find_next(config, "logging", top_handle);
+    
+    get_config_opt(config, local_handle, "debug", &value, "on");
+    if(crm_is_true(value) && crm_log_level < LOG_DEBUG) {
+	crm_log_level = LOG_DEBUG;
+    }    
+
+    if(crm_log_level >= LOG_DEBUG) {
+	char *level = crm_itoa(crm_log_level - LOG_INFO);
+	setenv("HA_debug", level, 1);
+	crm_free(level);
+    }
+    
+    get_config_opt(config, local_handle, "to_logfile", &value, "off");
+    if(crm_is_true(value)) {
+	get_config_opt(config, local_handle, "logfile", &value, NULL);
+
+	if(value == NULL) {
+	    crm_err("Logging to a file requested but no log file specified");
+
+	} else {
+	    uid_t pcmk_uid = geteuid();
+	    uid_t pcmk_gid = getegid();
+
+	    FILE *logfile = fopen(value, "a");
+	    if(logfile) {
+		int logfd = fileno(logfile);
+
+		setenv("HA_debugfile", value, 1);
+	
+		/* Ensure the file has the correct permissions */
+		fchown(logfd, pcmk_uid, pcmk_gid);
+		fchmod(logfd, S_IRUSR|S_IWUSR|S_IRGRP|S_IWGRP);
+		
+		fprintf(logfile, "Set r/w permissions for uid=%d, gid=%d on %s\n",
+			pcmk_uid, pcmk_gid, value);
+		fflush(logfile);
+		fsync(logfd);
+		fclose(logfile);
+		have_log = TRUE;
+
+	    } else {
+		crm_err("Couldn't create logfile: %s", value);
+	    }
+	}
+    }
+
+    get_config_opt(config, local_handle, "to_syslog", &value, "on");
+    if(have_log && crm_is_true(value) == FALSE) {
+	crm_info("User configured file based logging and explicitly disabled syslog.");
+	value = NULL;
+
+    } else {
+	if(crm_is_true(value) == FALSE) {
+	    crm_err("Please enable some sort of logging, either 'to_file: on' or  'to_syslog: on'.");
+	    crm_err("If you use file logging, be sure to also define a value for 'logfile'");	    
+	}
+	get_config_opt(config, local_handle, "syslog_facility", &value, "daemon");
+    }
+    
+    setenv("HA_logfacility", value?value:"none", 1);
+    setenv("HA_LOGFACILITY", value?value:"none", 1);
+
+    /* =::=::= Quorum =::=::= */
+
+    if(have_quorum == FALSE) {
+	top_handle = config_find_init(config);
+	local_handle = config_find_next(config, "quorum", top_handle);
+	get_config_opt(config, local_handle, "provider", &value, NULL);
+
+	if(value) {
+	    have_quorum = TRUE;
+	    if(safe_str_eq("quorum_cman", value)) {
+#ifdef SUPPORT_CMAN
+		setenv("HA_cluster_type", "cman",  1);
+		use_cman = TRUE;
+#else
+		crm_err("Corosync configured for CMAN but this build of Pacemaker doesn't support it");
+		exit(100);
+#endif
+	    }
+	}
+    }
+    
+    confdb_finalize (config);
+    crm_free(value);
+    return TRUE;
+}
diff -r f059ec7ced7a -r b230ffa2ecdc mcp/pacemaker.c
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/mcp/pacemaker.c	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,750 @@
+/* 
+ * Copyright (C) 2010 Andrew Beekhof <andrew@beekhof.net>
+ * 
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ * 
+ * This software is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+#include <crm_internal.h>
+#include <pacemaker.h>
+
+#include <pwd.h>
+
+#include <crm/common/ipc.h>
+#include <clplumbing/proctrack.h>
+
+
+GMainLoop *mainloop = NULL;
+GHashTable *client_list = NULL;
+GHashTable *peers = NULL;
+
+char ipc_name[] = "pcmk";
+char *local_name = NULL;
+uint32_t local_nodeid = 0;
+crm_trigger_t  *shutdown_trigger = NULL;
+const char *pid_file = "/var/run/pacemaker.pid";
+
+enum crm_proc_flag {
+    crm_proc_none       = 0x00000001,
+    crm_proc_ais        = 0x00000002,
+    crm_proc_lrmd       = 0x00000010,
+    crm_proc_cib        = 0x00000100,
+    crm_proc_crmd       = 0x00000200,
+    crm_proc_attrd      = 0x00001000,
+    crm_proc_stonithd   = 0x00002000,
+    crm_proc_pe         = 0x00010000,
+    crm_proc_te         = 0x00020000,
+    crm_proc_mgmtd      = 0x00040000,
+    crm_proc_stonith_ng = 0x00100000,
+};
+
+typedef struct pcmk_child_s {
+	int pid;
+	long flag;
+	int start_seq;
+	int respawn_count;
+	gboolean respawn;
+	const char *name;
+	const char *uid;
+	const char *command;
+    
+} pcmk_child_t;
+
+/* Index into the array below */
+#define pcmk_child_crmd  4
+#define pcmk_child_mgmtd 8
+static pcmk_child_t pcmk_children[] = {
+    { 0, crm_proc_none,       0, 0, FALSE, "none",       NULL,		  NULL },
+    { 0, crm_proc_ais,        0, 0, FALSE, "ais",        NULL,		  NULL },
+    { 0, crm_proc_lrmd,       3, 0, TRUE,  "lrmd",       NULL,		  HB_DAEMON_DIR"/lrmd" },
+    { 0, crm_proc_cib,        2, 0, TRUE,  "cib",        CRM_DAEMON_USER, CRM_DAEMON_DIR"/cib" },
+    { 0, crm_proc_crmd,       6, 0, TRUE,  "crmd",       CRM_DAEMON_USER, CRM_DAEMON_DIR"/crmd" },
+    { 0, crm_proc_attrd,      4, 0, TRUE,  "attrd",      CRM_DAEMON_USER, CRM_DAEMON_DIR"/attrd" },
+    { 0, crm_proc_stonithd,   0, 0, TRUE,  "stonithd",   NULL,		  NULL },
+    { 0, crm_proc_pe,         5, 0, TRUE,  "pengine",    CRM_DAEMON_USER, CRM_DAEMON_DIR"/pengine" },
+    { 0, crm_proc_mgmtd,      0, 0, TRUE,  "mgmtd",      NULL,		  HB_DAEMON_DIR"/mgmtd" },
+    { 0, crm_proc_stonith_ng, 1, 0, TRUE,  "stonith-ng", NULL,		  CRM_DAEMON_DIR"/stonithd" },
+};
+
+static gboolean start_child(pcmk_child_t *child);
+
+void enable_mgmtd(gboolean enable)
+{
+    if(enable) {
+	pcmk_children[pcmk_child_mgmtd].start_seq = 7;
+    } else {
+	pcmk_children[pcmk_child_mgmtd].start_seq = 0;
+    }
+}
+
+static uint32_t get_process_list(void) 
+{
+    int lpc = 0;
+    uint32_t procs = crm_proc_ais;
+    for (lpc = 0; lpc < SIZEOF(pcmk_children); lpc++) {
+	if(pcmk_children[lpc].pid != 0) {
+	    procs |= pcmk_children[lpc].flag;
+	}
+    }
+    return procs;
+}
+
+static int pcmk_user_lookup(const char *name, uid_t *uid, gid_t *gid)
+{
+    int rc = -1;
+    char *buffer = NULL;
+    struct passwd pwd;
+    struct passwd *pwentry = NULL;
+
+    crm_malloc0(buffer, PW_BUFFER_LEN);
+    getpwnam_r(name, &pwd, buffer, PW_BUFFER_LEN, &pwentry);
+    if(pwentry) {
+	rc = 0;
+	if(uid) { *uid = pwentry->pw_uid; }
+	if(gid) { *gid = pwentry->pw_gid; }
+	crm_debug_2("Cluster user %s has uid=%d gid=%d",
+		    name, pwentry->pw_uid, pwentry->pw_gid);
+
+    } else {
+	crm_err("Cluster user %s does not exist", name);
+    }
+
+    crm_free(buffer);
+    return rc;
+}
+
+static void
+pcmk_child_exit(
+    ProcTrack* p, int status, int signo, int exitcode, int waslogged)
+{
+    pcmk_child_t *child = p->privatedata;
+    p->privatedata = NULL;
+
+    if(signo) {
+	crm_notice("Child process %s terminated with signal %d (pid=%d, rc=%d)",
+		   child->name, signo, child->pid, exitcode);
+    } else {
+	do_crm_log(exitcode==0?LOG_NOTICE:LOG_ERR,
+		   "Child process %s exited (pid=%d, rc=%d)", child->name, child->pid, exitcode);
+    }
+    
+    child->pid = 0;
+    if(exitcode == 100) {
+	crm_notice("Child process %s no longer wishes"
+		   " to be respawned", child->name);
+	child->respawn = FALSE;
+    }
+
+    child->respawn_count += 1;
+    if(child->respawn_count > MAX_RESPAWN) {
+	crm_err("Child respawn count exceeded by %s", child->name);
+	child->respawn = FALSE;
+    }
+
+    if(shutdown_trigger) {
+	mainloop_set_trigger(shutdown_trigger);
+	update_node_processes(local_nodeid, NULL, get_process_list());
+
+    } else if(child->respawn) {
+	crm_notice("Respawning failed child process: %s", child->name);
+	start_child(child);
+    }	
+}
+
+static void
+pcmkManagedChildRegistered(ProcTrack* p)
+{
+    pcmk_child_t *child = p->privatedata;
+    child->pid = p->pid;
+}
+
+static const char *
+pcmkManagedChildName(ProcTrack* p)
+{
+    pcmk_child_t *child = p->privatedata;
+    return child->name;
+}
+
+static ProcTrack_ops pcmk_managed_child_ops = {
+    pcmk_child_exit,
+    pcmkManagedChildRegistered,
+    pcmkManagedChildName
+};
+
+static gboolean
+stop_child(pcmk_child_t *child, int signal)
+{
+    if(signal == 0) {
+	signal = SIGTERM;
+    }
+	
+    if(child->command == NULL) {
+	crm_debug("Nothing to do for child \"%s\"", child->name);
+	return TRUE;
+    }
+    
+    if (child->pid <= 0) {
+	crm_debug_2("Client %s not running", child->name);
+	return TRUE;
+    }
+	
+    errno = 0;
+    if(kill(child->pid, signal) == 0) {
+	crm_notice("Stopping %s: Sent -%d to process %d", child->name, signal, child->pid);
+	    
+    } else {
+	crm_perror(LOG_ERR, "Stopping %s: Could not send -%d to process %d failed",
+		   child->name, signal, child->pid);
+    }
+    
+    return TRUE;
+}
+
+static char *opts_default[] = { NULL, NULL };
+static char *opts_vgrind[]  = { NULL, NULL, NULL };
+
+static gboolean
+start_child(pcmk_child_t *child)
+{
+    int lpc = 0;
+    uid_t uid = 0;
+    struct rlimit oflimits;
+    gboolean use_valgrind = FALSE;
+    const char *devnull = "/dev/null";
+    const char *env_valgrind = getenv("HA_VALGRIND_ENABLED");
+    
+    if(child->command == NULL) {
+	crm_info("Nothing to do for child \"%s\"", child->name);
+	return TRUE;
+    }
+    
+    if(env_valgrind == NULL) {
+	use_valgrind = FALSE;
+
+    } else if(crm_is_true(env_valgrind)) {
+	use_valgrind = TRUE;
+
+    } else if(strstr(env_valgrind, child->name)) {
+	use_valgrind = TRUE;
+    }
+
+    if(use_valgrind && strlen(VALGRIND_BIN) == 0) {
+	crm_warn("Cannot enable valgrind for %s:"
+		 " The location of the valgrind binary is unknown", child->name);
+	use_valgrind = FALSE;
+    }
+
+    child->pid = fork();
+    CRM_ASSERT(child->pid != -1);
+
+    if(child->pid > 0) {
+	/* parent */
+	NewTrackedProc(child->pid, 0, PT_LOGNORMAL, child, &pcmk_managed_child_ops);
+	crm_info("Forked child %d for process %s%s", child->pid, child->name,
+		 use_valgrind?" (valgrind enabled: "VALGRIND_BIN")":"");
+	update_node_processes(local_nodeid, NULL, get_process_list());
+	return TRUE;
+
+    } else {
+	/* Start a new session */
+	(void)setsid();
+
+	/* Setup the two alternate arg arrarys */ 
+	opts_vgrind[0] = crm_strdup(VALGRIND_BIN);
+	opts_vgrind[1] = crm_strdup(child->command);
+	opts_default[0] = opts_vgrind[1];
+	
+#if 0
+	/* Dont set the group for now - it prevents connection to the cluster */
+	if(gid && setgid(gid) < 0) {
+	    crm_perror("Could not set group to %d", gid);
+	}
+#endif
+
+	if(child->uid) {
+	    if(pcmk_user_lookup(child->uid, &uid, NULL) < 0) {
+		crm_err("Invalid uid (%s) specified for %s",
+			child->uid, child->name);
+		return TRUE;
+	    }
+	}
+	
+	if(uid && setuid(uid) < 0) {
+	    crm_perror(LOG_ERR, "Could not set user to %d (%s)", uid, child->uid);
+	}
+	
+	/* Close all open file descriptors */
+	getrlimit(RLIMIT_NOFILE, &oflimits);
+	for (lpc = 0; lpc < oflimits.rlim_cur; lpc++) {
+	    close(lpc);
+	}
+	
+	(void)open(devnull, O_RDONLY);	/* Stdin:  fd 0 */
+	(void)open(devnull, O_WRONLY);	/* Stdout: fd 1 */
+	(void)open(devnull, O_WRONLY);	/* Stderr: fd 2 */
+
+	if(use_valgrind) {
+	    (void)execvp(VALGRIND_BIN, opts_vgrind);
+	} else {
+	    (void)execvp(child->command, opts_default);
+	}
+	crm_perror(LOG_ERR, "FATAL: Cannot exec %s", child->command);
+	exit(100);
+    }
+    return TRUE; /* never reached */
+}
+
+static gboolean
+escalate_shutdown(gpointer data)
+{
+    
+    pcmk_child_t *child = data;
+    if(child->pid) {
+	/* Use SIGSEGV instead of SIGKILL to create a core so we can see what it was up to */
+	crm_err("Child %s not terminating in a timely manner, forcing", child->name);
+	stop_child(child, SIGSEGV); 
+    }
+    return FALSE;
+}
+
+static gboolean
+pcmk_shutdown_worker(gpointer user_data) 
+{
+    static int phase = 0;
+    static time_t next_log = 0;
+    static int max = SIZEOF(pcmk_children);
+
+    int lpc = 0;
+	
+    if(phase == 0) {
+	crm_notice("Shuting down Pacemaker");    
+	phase = max;
+    }
+	
+    for (; phase > 0; phase--) {
+	/* dont stop anything with start_seq < 1 */
+	    
+	for (lpc = max - 1; lpc >= 0; lpc--) {
+	    pcmk_child_t *child = &(pcmk_children[lpc]);
+	    if(phase != child->start_seq) {
+		continue;
+	    }
+		
+	    if(child->pid) {
+		time_t now = time(NULL);
+		    
+		if(child->respawn) {
+		    next_log = now + 30;
+		    child->respawn = FALSE;
+		    stop_child(child, SIGTERM);
+		    if(phase < pcmk_children[pcmk_child_crmd].start_seq) {
+			g_timeout_add(180000/* 3m */, escalate_shutdown, child);
+		    }
+
+		} else if(now >= next_log) {
+		    next_log = now + 30;
+		    crm_notice("Still waiting for %s (pid=%d, seq=%d) to terminate...",
+			       child->name, child->pid, child->start_seq);
+		}		    
+		return TRUE;
+	    }
+		
+	    /* cleanup */
+	    crm_notice("%s confirmed stopped", child->name);
+	    child->pid = 0;
+	}
+    }
+	
+    /* send_cluster_id(); */
+    crm_notice("Shutdown complete");
+    g_main_loop_quit(mainloop);
+    return TRUE;	
+}
+
+static void
+pcmk_shutdown(int nsig)
+{
+    shutdown_trigger = mainloop_add_trigger(G_PRIORITY_HIGH, pcmk_shutdown_worker, NULL);
+    mainloop_set_trigger(shutdown_trigger);
+}
+
+
+static void build_path(const char *path_c, mode_t mode)
+{
+    int offset = 1, len = 0;
+    char *path = crm_strdup(path_c);
+
+    CRM_CHECK(path != NULL, return);
+    for(len = strlen(path); offset < len; offset++) {
+	if(path[offset] == '/') {
+	    path[offset] = 0;
+	    if(mkdir(path, mode) < 0 && errno != EEXIST) {
+		crm_perror(LOG_ERR, "Could not create directory '%s'", path);
+		break;
+	    }
+	    path[offset] = '/';
+	}
+    }
+    if(mkdir(path, mode) < 0 && errno != EEXIST) {
+	crm_perror(LOG_ERR, "Could not create directory '%s'", path);
+    }
+    crm_free(path);
+}
+
+static void
+pcmk_server_destroy(gpointer user_data)
+{
+    crm_info("Server destroyed");
+    return;
+}
+
+static void
+pcmk_client_destroy(gpointer user_data)
+{
+    crm_debug("Client %p disconnected", user_data);
+    g_hash_table_remove(client_list, user_data);
+    return;
+}
+
+static gboolean
+pcmk_client_msg(IPC_Channel *client, gpointer user_data)
+{
+    xmlNode *msg = NULL;
+    gboolean stay_connected = TRUE;
+	
+    while(IPC_ISRCONN(client)) {
+	if(client->ops->is_message_pending(client) == 0) {
+	    break;
+	}
+
+	msg = xmlfromIPC(client, MAX_IPC_DELAY);
+	free_xml(msg);
+
+	if(client->ch_status != IPC_CONNECT) {
+	    break;
+	}
+    }
+	
+    if (client->ch_status != IPC_CONNECT) {
+	stay_connected = FALSE;
+    }
+    return stay_connected;
+}
+
+static gboolean
+pcmk_client_connect(IPC_Channel *ch, gpointer user_data)
+{
+    if (ch == NULL) {
+	crm_err("Channel was invalid");
+
+    } else if (ch->ch_status == IPC_DISCONNECT) {
+	crm_err("Channel was disconnected");
+
+    } else {
+	ch->ops->set_recv_qlen(ch, 1024);
+	ch->ops->set_send_qlen(ch, 1024);
+
+	g_hash_table_insert(client_list, ch, user_data);
+	crm_debug("Channel %p connected: %d children", ch, g_hash_table_size(client_list));
+	update_process_clients();
+	
+	G_main_add_IPC_Channel(
+	    G_PRIORITY_LOW, ch, FALSE,  pcmk_client_msg, ch, pcmk_client_destroy);
+    }
+    return TRUE;
+}
+
+static gboolean
+ghash_send_proc_details(gpointer key, gpointer value, gpointer data)
+{
+    if(send_ipc_message(key, data) == FALSE) {
+	/* remove it */
+	return TRUE;
+    }
+    return FALSE;
+}
+
+static void peer_loop_fn(gpointer key, gpointer value, gpointer user_data)
+{
+    pcmk_peer_t *node = value;
+    xmlNode *update = user_data;    
+
+    xmlNode *xml = create_xml_node(update, "node");
+
+    crm_xml_add_int(xml, "id", node->id);
+    crm_xml_add(xml, "uname", node->uname);
+    crm_xml_add_int(xml, "processes", node->processes);
+}
+
+void update_process_clients(void)
+{
+    xmlNode *update = create_xml_node(NULL, "nodes");
+    
+    crm_debug_2("Sending process list to %d children", g_hash_table_size(client_list));
+
+    g_hash_table_foreach(peers, peer_loop_fn, update);
+    g_hash_table_foreach_remove(client_list, ghash_send_proc_details, update);
+    
+    free_xml(update);
+}
+
+void update_process_peers(void) 
+{
+    char buffer[1024];
+    struct iovec iov;
+    int rc = 0;
+
+    memset(buffer, SIZEOF(buffer), 0);
+
+    if(local_name) {
+	rc = snprintf(buffer, SIZEOF(buffer) - 1, "<node uname=\"%s\" proclist=\"%u\"/>", local_name, get_process_list());
+    } else {
+	rc = snprintf(buffer, SIZEOF(buffer) - 1, "<node proclist=\"%u\"/>", get_process_list());
+    }
+    
+    iov.iov_base = buffer;
+    iov.iov_len = rc + 1;
+    
+    send_cpg_message(&iov);
+}
+
+gboolean update_node_processes(uint32_t id, const char *uname, uint32_t procs) 
+{
+    gboolean changed = FALSE;
+    pcmk_peer_t *node = g_hash_table_lookup(peers, GUINT_TO_POINTER(id));	
+    if(node == NULL) {	
+	changed = TRUE;
+	
+	crm_malloc0(node, sizeof(pcmk_peer_t));
+	node->id = id;
+	
+	g_hash_table_insert(peers, GUINT_TO_POINTER(id), node);
+	node = g_hash_table_lookup(peers, GUINT_TO_POINTER(id));
+	CRM_ASSERT(node != NULL);
+    }
+
+    if(uname != NULL) {
+	if(node->uname == NULL || safe_str_eq(node->uname, uname) == FALSE) {
+	    crm_info("%p Node %u now known as %s (was: %s)",
+		     node, id, uname, node->uname);
+	    crm_free(node->uname);
+	    node->uname = crm_strdup(uname);
+	    changed = TRUE;
+	}
+    }
+    
+    if(procs != 0 && procs != node->processes) {
+	crm_info("Node %s now has process list: %.32x (was %.32x)",
+		 node->uname, procs, node->processes);
+	node->processes = procs;
+	changed = TRUE;
+    }
+
+    if(changed && id == local_nodeid) {
+	update_process_clients();
+	update_process_peers();	
+    }
+    return changed;
+}
+
+static struct crm_option long_options[] = {
+    /* Top-level Options */
+    {"help",           0, 0, '?', "\tThis text"},
+    {"version",        0, 0, '$', "\tVersion information"  },
+    {"verbose",        0, 0, 'V', "\tIncrease debug output"},
+    {"features",       0, 0, 'F', "\tDisplay the full version and list of features Pacemaker was built with"},
+
+    {"-spacer-",       1, 0, '-', "\nAdditional Options:"},
+    {"foreground",     0, 0, 'f', "\tRun in the foreground instead of as a daemon"},
+    {"pid-file",       1, 0, 'p', "\t(Advanced) Daemon pid file location"},
+
+    {NULL, 0, 0, 0}
+};
+
+int
+main(int argc, char **argv)
+{
+    int rc;
+    int flag;
+    int argerr = 0;
+
+    int option_index = 0;	
+    gboolean daemonize = TRUE;
+
+    int start_seq = 1, lpc = 0;
+    static int max = SIZEOF(pcmk_children);
+    
+    uid_t pcmk_uid = 0;
+    gid_t pcmk_gid = 0;
+    struct rlimit cores;
+
+    /* =::=::= Default Environment =::=::= */
+    setenv("HA_mcp",		"true",    1);
+    setenv("HA_COMPRESSION",	"bz2",     1);
+    setenv("HA_cluster_type",	"corosync",1);
+    setenv("HA_debug",		"0",       1);
+    setenv("HA_logfacility",	"daemon",  1);
+    setenv("HA_LOGFACILITY",	"daemon",  1);
+    setenv("HA_use_logd",       "off",     1);
+    
+    crm_log_init(NULL, LOG_INFO, TRUE, FALSE, argc, argv);
+    crm_set_options("V?$fp:F", "mode [options]", long_options,
+		    "Start/Stop Pacemaker\n");
+
+#ifndef ON_DARWIN
+    /* prevent zombies */
+    signal(SIGCLD, SIG_IGN);
+#endif
+    
+    while (1) {
+	flag = crm_get_option(argc, argv, &option_index);
+	if (flag == -1)
+	    break;
+
+	switch(flag) {
+	    case 'V':
+		cl_log_enable_stderr(TRUE);
+		alter_debug(DEBUG_INC);
+		break;
+	    case 'f':
+		daemonize = FALSE;
+		break;
+	    case 'p':
+		pid_file = optarg;
+		break;
+	    case '$':
+	    case '?':
+		crm_help(flag, LSB_EXIT_OK);
+		break;
+	    case 'F':
+		printf("Pacemaker %s (Build: %s)\n Supporting: %s\n", VERSION, BUILD_VERSION, CRM_FEATURES);
+		exit (0);
+	    default:
+		printf("Argument code 0%o (%c) is not (?yet?) supported\n", flag, flag);
+		++argerr;
+		break;
+	}
+    }
+
+    if (optind < argc) {
+	printf("non-option ARGV-elements: ");
+	while (optind < argc)
+	    printf("%s ", argv[optind++]);
+	printf("\n");
+    }
+    if (argerr) {
+	crm_help('?', LSB_EXIT_GENERIC);
+    }
+    
+    if(read_config() == FALSE) {
+	return 1;
+    }
+
+    if(daemonize) {
+	cl_log_enable_stderr(FALSE);
+	crm_make_daemon(crm_system_name, TRUE, pid_file);
+
+	/* Only Re-init if we're running daemonized */
+	crm_log_init_quiet(NULL, LOG_INFO, TRUE, FALSE, argc, argv);
+    }
+
+    crm_info("Starting Pacemaker %s (Build: %s): %s\n", VERSION, BUILD_VERSION, CRM_FEATURES);    
+    mainloop = g_main_new(FALSE);
+
+    rc = getrlimit(RLIMIT_CORE, &cores);
+    if(rc < 0) {
+	crm_perror(LOG_ERR, "Cannot determine current maximum core size.");
+    }
+    
+    if(cores.rlim_max <= 0) {
+	cores.rlim_max = RLIM_INFINITY;
+	
+	rc = setrlimit(RLIMIT_CORE, &cores);
+	if(rc < 0) {
+	    crm_perror(LOG_ERR,
+		       "Core file generation will remain disabled."
+		       " Core files are an important diagnositic tool,"
+		       " please consider enabling them by default.");
+	}
+	
+    } else {
+	crm_info("Maximum core file size is: %lu", cores.rlim_max);
+#if 0
+	/* system() is not thread-safe, can't call from here
+	 * Actually, its a pretty hacky way to try and achieve this anyway
+	 */
+	if(system("echo 1 > /proc/sys/kernel/core_uses_pid") != 0) {
+	    crm_perror(LOG_ERR, "Could not enable /proc/sys/kernel/core_uses_pid");
+	}
+#endif
+    }
+
+    if(pcmk_user_lookup(CRM_DAEMON_USER, &pcmk_uid, &pcmk_gid) < 0) {
+	crm_err("Cluster user %s does not exist, aborting Pacemaker startup", CRM_DAEMON_USER);
+	return TRUE;
+    }
+    
+    mkdir(CRM_STATE_DIR, 0750);
+    chown(CRM_STATE_DIR, pcmk_uid, pcmk_gid);
+    
+    /* Used by stonithd */
+    build_path(HA_STATE_DIR"/heartbeat", 0755); 
+
+    /* Used by RAs - Leave owned by root */
+    build_path(CRM_RSCTMP_DIR, 0755);    
+
+    client_list = g_hash_table_new(g_direct_hash, g_direct_equal);
+    peers = g_hash_table_new(g_direct_hash, g_direct_equal);
+
+    if(init_server_ipc_comms(ipc_name, pcmk_client_connect, pcmk_server_destroy)) {
+	crm_err("Couldn't start IPC server");
+	return 1;
+    }
+
+    if(cluster_connect_cfg(&local_nodeid) == FALSE) {
+	return 1;
+    }
+
+    if(cluster_connect_cpg() == FALSE) {
+	return 1;
+    }
+
+    local_name = get_local_node_name();
+    update_node_processes(local_nodeid, local_name, get_process_list());    
+    
+    mainloop_add_signal(SIGTERM, pcmk_shutdown);
+    mainloop_add_signal(SIGINT, pcmk_shutdown);
+    set_sigchld_proctrack(G_PRIORITY_HIGH, DEFAULT_MAXDISPATCHTIME);
+    
+    for (start_seq = 1; start_seq < max; start_seq++) {
+	/* dont start anything with start_seq < 1 */
+	for (lpc = 0; lpc < max; lpc++) {
+	    if(start_seq == pcmk_children[lpc].start_seq) {
+		start_child(&(pcmk_children[lpc]));
+	    }
+	}
+    }
+
+    crm_info("Starting mainloop");	
+
+    g_main_run(mainloop);
+    g_main_destroy(mainloop);
+
+    cluster_disconnect_cpg();
+    cluster_disconnect_cfg();
+    
+    crm_info("Exiting %s", crm_system_name);	
+
+    return 0;
+}
diff -r f059ec7ced7a -r b230ffa2ecdc mcp/pacemaker.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/mcp/pacemaker.h	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,60 @@
+/* 
+ * Copyright (C) 2010 Andrew Beekhof <andrew@beekhof.net>
+ * 
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ * 
+ * This software is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * General Public License for more details.
+ * 
+ * You should have received a copy of the GNU General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+#include <crm_internal.h>
+
+#include <sys/param.h>
+#include <sys/types.h>
+#include <sys/wait.h>
+
+#include <stdint.h>
+
+#include <crm/crm.h>
+#include <crm/common/xml.h>
+
+#define SIZEOF(a)   (sizeof(a) / sizeof(a[0]))
+#define crm_flag_none		0x00000000
+#define crm_flag_members	0x00000001
+#define MAX_RESPAWN		100
+#define PW_BUFFER_LEN		500
+
+extern uint32_t local_nodeid;
+
+typedef struct pcmk_peer_s 
+{
+	uint32_t id;
+	uint32_t processes;
+	char *uname;
+} pcmk_peer_t;
+
+extern gboolean read_config(void);
+
+extern gboolean cluster_connect_cfg(uint32_t *nodeid);
+extern gboolean cluster_disconnect_cfg(void);
+
+extern gboolean cluster_connect_cpg(void);
+extern gboolean cluster_disconnect_cpg(void);
+extern gboolean send_cpg_message(struct iovec *iov);
+
+extern void update_process_clients(void);
+extern void update_process_peers(void);
+extern gboolean update_node_processes(uint32_t node, const char *uname, uint32_t procs);
+
+extern char *get_local_node_name(void);
+extern void enable_mgmtd(gboolean enable);
+
diff -r f059ec7ced7a -r b230ffa2ecdc mcp/pacemaker.in
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/mcp/pacemaker.in	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,157 @@
+#!/bin/bash
+
+# Authors:
+#  Andrew Beekhof <abeekhof@redhat.com>
+#  Fabio M. Di Nitto <fdinitto@redhat.com>
+#
+# License: Revised BSD
+
+# chkconfig: - 90 90
+# description: Pacemaker Cluster Manager
+# processname: pacemaker
+#
+### BEGIN INIT INFO
+# Provides:		pacemaker
+# Required-Start:	$network corosync
+# Should-Start:		$syslog
+# Required-Stop:	$network
+# Default-Start:
+# Default-Stop:
+# Short-Description:	Starts and stops Pacemaker Cluster Manager.
+# Description:		Starts and stops Pacemaker Cluster Manager.
+### END INIT INFO
+
+# Variables for running child daemons under valgrind and/or checking for memory problems
+#export G_SLICE=always-malloc
+#export MALLOC_PERTURB_=221 # or 0
+#export MALLOC_CHECK_=3     # or 0,1,2
+#export HA_VALGRIND_ENABLED=yes
+#export HA_VALGRIND_ENABLED=cib,crmd
+#export VALGRIND_OPTS="--leak-check=full --trace-children=no --num-callers=25 --log-file=/tmp/pacemaker-%p.valgrind"
+
+desc="Pacemaker Cluster Manager"
+prog="pacemakerd"
+
+# set secure PATH
+PATH="/sbin:/bin:/usr/sbin:/usr/bin:@sbindir@"
+
+success()
+{
+	echo -ne "[  OK  ]\r"
+}
+
+failure()
+{
+	echo -ne "[FAILED]\r"
+}
+
+status()
+{
+	pid=$(pidof $1 2>/dev/null)
+	rtrn=$?
+	if [ $rtrn -ne 0 ]; then
+		echo "$1 is stopped"
+	else
+		echo "$1 (pid $pid) is running..."
+	fi
+	return $rtrn
+}
+
+# rpm based distros
+if [ -d @sysconfdir@/sysconfig ]; then
+	[ -f @INITDIR@/functions ] && . @INITDIR@/functions
+	[ -f @sysconfdir@/sysconfig/pacemaker ] && . @sysconfdir@/sysconfig/pacemaker
+	[ -z "$LOCK_FILE" ] && LOCK_FILE="@localstatedir@/lock/subsys/pacemaker"
+fi
+
+# deb based distros
+if [ -d @sysconfdir@/default ]; then
+	[ -f @sysconfdir@/default/pacemaker ] && . @sysconfdir@/default/pacemaker
+	[ -z "$LOCK_FILE" ] && LOCK_FILE="@localstatedir@/lock/pacemaker"
+fi
+
+start()
+{
+	echo -n "Starting $desc ($prog): "
+
+	# most recent distributions use tmpfs for $@localstatedir@/run
+	# to avoid to clean it up on every boot.
+	# they also assume that init scripts will create
+	# required subdirectories for proper operations
+	mkdir -p $@localstatedir@/run
+
+	if status $prog > /dev/null 2>&1; then
+		success
+	else
+		$prog > /dev/null 2>&1
+		
+		# Time to connect to corosync and fail
+		sleep 5
+
+		if status $prog > /dev/null 2>&1; then
+			touch $LOCK_FILE
+			pidof $prog > $@localstatedir@/run/$prog.pid
+			success
+		else
+			failure
+			rtrn=1
+		fi
+	fi
+	echo
+}
+
+stop()
+{
+	! status $prog > /dev/null 2>&1 && return
+
+	echo -n "Signaling $desc ($prog) to terminate: "
+	kill -TERM $(pidof $prog) > /dev/null 2>&1
+	success
+	echo
+
+	echo -n "Waiting for $prog services to unload:"
+	while status $prog > /dev/null 2>&1; do
+		sleep 1
+		echo -n "."
+	done
+
+	rm -f $LOCK_FILE
+	rm -f $@localstatedir@/run/$prog.pid
+	success
+	echo
+}
+
+restart()
+{
+	stop
+	start
+}
+
+rtrn=0
+
+case "$1" in
+start)
+	start
+;;
+restart|reload|force-reload)
+	restart
+;;
+condrestart|try-restart)
+	if status $prog > /dev/null 2>&1; then
+		restart
+	fi
+;;
+status)
+	status $prog
+	rtrn=$?
+;;
+stop)
+	stop
+;;
+*)
+	echo "usage: $0 {start|stop|restart|reload|force-reload|condrestart|try-restart|status}"
+	rtrn=2
+;;
+esac
+
+exit $rtrn
diff -r f059ec7ced7a -r b230ffa2ecdc pacemaker.spec
--- a/pacemaker.spec	Mon May 17 17:57:40 2010 +0200
+++ b/pacemaker.spec	Mon Jul 12 18:48:04 2010 +0200
@@ -2,7 +2,7 @@
 %global uname hacluster
 %global pcmk_docdir %{_docdir}/%{name}
 
-%global specversion 1
+%global specversion 0.14
 #global upstream_version tip
 %global upstream_prefix pacemaker
 
@@ -15,12 +15,9 @@
 # Do this instead of trying to conditionally %include %{_rpmconfigdir}/macros.python
 %{!?py_ver:     %{expand: %%global py_ver      %%(echo `python -c "import sys; print sys.version[:3]"`)}}
 %{!?py_prefix:  %{expand: %%global py_prefix   %%(echo `python -c "import sys; print sys.prefix"`)}}
-%{!?py_libdir:  %{expand: %%global py_libdir   %%{expand:%%%%{py_prefix}/lib/python%%%%{py_ver}}}}
+%{!?py_libdir:  %{expand: %%global py_libdir   %%{expand:%%%%{py_prefix}/%%%%{_lib}/python%%%%{py_ver}}}}
 %{!?py_sitedir: %{expand: %%global py_sitedir  %%{expand:%%%%{py_libdir}/site-packages}}}
 
-# Uncomment for openSUSE11.2 which advertises lib64 but uses lib
-#global py_sitedir %{py_prefix}/lib/python%{py_ver}/site-packages
-
 # Compatibility macro wrappers for legacy RPM versions that do not
 # support conditional builds
 %{!?bcond_without: %{expand: %%global bcond_without() %%{expand:%%%%{!?_without_%%{1}:%%%%global with_%%{1} 1}}}}
@@ -33,6 +30,7 @@
 # to disable or enable specific features
 
 # Supported cluster stacks, must support at least one
+%bcond_with cman
 %bcond_without ais
 %bcond_without heartbeat
 
@@ -46,7 +44,7 @@
 
 Name:		pacemaker
 Summary:	Scalable High-Availability cluster resource manager
-Version:	1.1.2.1
+Version:	1.1.3
 Release:	%{pcmk_release}
 License:	GPLv2+ and LGPLv2+
 Url:		http://www.clusterlabs.org
@@ -69,6 +67,7 @@ BuildRequires:  help2man libtool-ltdl-de
 BuildRequires:  help2man tcpd-devel
 # Suse splits this off into a separate package
 Requires:       python-curses python-xml
+BuildRequires:  python-curses python-xml
 %endif
 
 # Required for core functionality
@@ -77,13 +76,17 @@ BuildRequires:	glib2-devel cluster-glue-
 BuildRequires:	pkgconfig python-devel gcc-c++ bzip2-devel gnutls-devel pam-devel
 
 # Enables optional functionality
-BuildRequires:	ncurses-devel openssl-devel libselinux-devel docbook-style-xsl
+BuildRequires:	ncurses-devel openssl-devel libselinux-devel docbook-style-xsl resource-agents
 
 
 %ifarch alpha %{ix86} x86_64
 BuildRequires:  lm_sensors-devel
 %endif
 
+%if %{with cman}
+BuildRequires:	clusterlib-devel
+%endif
+
 %if %{with esmtp}
 BuildRequires:	libesmtp-devel
 %endif
@@ -197,13 +200,16 @@ resource health.
 ./autogen.sh
 
 # RHEL <= 5 does not support --docdir
-docdir=%{pcmk_docdir} %{configure} \
-	%{?_without_heartbeat} \
-	%{?_without_ais} \
-	%{?_without_esmtp} \
-	%{?_without_snmp} \
-	--localstatedir=%{_var} \
+docdir=%{pcmk_docdir} %{configure}	\
+	%{?_without_heartbeat}		\
+	%{?_without_ais}		\
+	%{?_with_cman}			\
+	%{?_without_esmtp}		\
+	%{?_without_snmp}		\
+        --with-initdir=%{_initddir}	\
+	--localstatedir=%{_var}		\
 	--enable-fatal-warnings=no
+
 make %{_smp_mflags} docdir=%{pcmk_docdir}
 
 %install
@@ -233,6 +239,15 @@ rm -f %{buildroot}/%{_libdir}/service_cr
 %clean
 rm -rf %{buildroot}
 
+%post
+/sbin/chkconfig --add pacemaker || :
+
+%preun
+if [ $1 -eq 0 ]; then
+        /sbin/service pacemaker stop &>/dev/null || :
+        /sbin/chkconfig --del pacemaker || :
+fi
+
 %post -n pacemaker-libs -p /sbin/ldconfig
 
 %postun -n pacemaker-libs -p /sbin/ldconfig
@@ -242,6 +257,10 @@ rm -rf %{buildroot}
 %defattr(-,root,root)
 
 %exclude %{_datadir}/pacemaker/tests
+
+%{_initddir}/pacemaker
+%{_sbindir}/pacemakerd
+
 %{_datadir}/pacemaker
 %{_datadir}/snmp/mibs/PCMK-MIB.txt
 %{_libdir}/heartbeat/*
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/Makefile.am
--- a/pengine/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -27,7 +27,7 @@ PE_TESTS	= $(wildcard test10/*.scores)
 
 testdir			= $(datadir)/$(PACKAGE)/tests/pengine
 test_SCRIPTS		= regression.sh
-test_DATA		= regression.core.sh
+test_DATA		= regression.core.sh ptest.supp
 
 test10dir		= $(datadir)/$(PACKAGE)/tests/pengine/test10
 test10_DATA		= $(PE_TESTS) $(PE_TESTS:%.scores=%.xml) $(PE_TESTS:%.scores=%.exp) $(PE_TESTS:%.scores=%.dot)
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/allocate.c
--- a/pengine/allocate.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/allocate.c	Mon Jul 12 18:48:04 2010 +0200
@@ -152,7 +152,6 @@ static void CancelXmlOp(resource_t *rsc,
     char *key = NULL;
     const char *task = NULL;
     const char *call_id = NULL;
-    const char *op_version = NULL;
     const char *interval_s = NULL;
     
     CRM_CHECK(xml_op != NULL, return);
@@ -160,7 +159,6 @@ static void CancelXmlOp(resource_t *rsc,
 
     task = crm_element_value(xml_op, XML_LRM_ATTR_TASK);
     call_id = crm_element_value(xml_op, XML_LRM_ATTR_CALLID);
-    op_version = crm_element_value(xml_op, XML_ATTR_CRM_VERSION);
     interval_s = crm_element_value(xml_op, XML_LRM_ATTR_INTERVAL);
     
     interval = crm_parse_int(interval_s, "0");
@@ -333,7 +331,6 @@ check_actions_for(xmlNode *rsc_entry, re
 	int stop_index = 0;
 	int start_index = 0;
 
-	const char *id = NULL;
 	const char *task = NULL;
 	const char *interval_s = NULL;
 
@@ -378,7 +375,6 @@ check_actions_for(xmlNode *rsc_entry, re
 			continue;
 		}
 		
-		id   = ID(rsc_op);
 		is_probe = FALSE;
 		task = crm_element_value(rsc_op, XML_LRM_ATTR_TASK);
 
@@ -415,6 +411,9 @@ find_rsc_list(
 	slist_iter(child, resource_t, data_set->resources, lpc, 
 		   result = find_rsc_list(result, child, id, renamed_clones, partial, NULL));
 	return result;
+
+    } else if(rsc == NULL) {
+	return NULL;
     }
 
     if(partial) {
@@ -705,6 +704,29 @@ stage0(pe_working_set_t *data_set)
 	return TRUE;
 }
 
+
+static void wait_for_probe(
+    resource_t *rsc, const char *action, action_t *probe_complete, pe_working_set_t *data_set) 
+{
+    if(probe_complete == NULL) {
+	return;
+    }
+    
+    if(rsc->children) {
+	slist_iter(
+	    child, resource_t, rsc->children, lpc,
+	    wait_for_probe(child, action, probe_complete, data_set);
+	    );
+	
+    } else {
+	char *key = generate_op_key(rsc->id, action, 0);
+	custom_action_order(
+	    NULL, NULL, probe_complete, rsc, key, NULL,
+	    pe_order_optional, data_set);
+    }
+}
+
+
 /*
  * Check nodes for resources started outside of the LRM
  */
@@ -760,19 +782,15 @@ probe_resources(pe_working_set_t *data_s
 				probe_complete->optional = FALSE;
 				probe_node_complete->optional = FALSE;
 
-				custom_action_order(
-					NULL, NULL, probe_complete,
-					rsc, start_key(rsc), NULL,
-					pe_order_optional, data_set);
-
-				custom_action_order(
-					NULL, NULL, probe_complete,
-					rsc, stop_key(rsc), NULL,
-					pe_order_optional, data_set);
+				wait_for_probe(rsc, CRMD_ACTION_START, probe_complete, data_set);
 			}
 			);
 		);
 
+	slist_iter(
+	    rsc, resource_t, data_set->resources, lpc,
+	    wait_for_probe(rsc, CRMD_ACTION_STOP, probe_complete, data_set));
+
 	return TRUE;
 }
 
@@ -1182,7 +1200,7 @@ expand_list(GListPtr list, char **rsc_li
 
 static void dup_attr(gpointer key, gpointer value, gpointer user_data)
 {
-    g_hash_table_replace(user_data, crm_strdup(key), crm_strdup(value));
+    add_hash_param(user_data, key, value);
 }
 
 static action_t *
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/clone.c
--- a/pengine/clone.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/clone.c	Mon Jul 12 18:48:04 2010 +0200
@@ -819,18 +819,29 @@ clone_internal_constraints(resource_t *r
 		);
 }
 
-resource_t*
-find_compatible_child(
-    resource_t *local_child, resource_t *rsc, enum rsc_role_e filter, gboolean current)
+static void
+assign_node(resource_t *rsc, node_t *node, gboolean force)
 {
-	node_t *local_node = NULL;
+    if(rsc->children) {
+	slist_iter(
+		child_rsc, resource_t, rsc->children, lpc,
+		native_assign_node(child_rsc, NULL, node, force);
+	    );
+	return;
+    }
+    native_assign_node(rsc, NULL, node, force);
+}
+
+static resource_t*
+find_compatible_child_by_node(
+    resource_t *local_child, node_t *local_node, resource_t *rsc, enum rsc_role_e filter, gboolean current)
+{
 	node_t *node = NULL;
 	clone_variant_data_t *clone_data = NULL;
 	get_clone_variant_data(clone_data, rsc);
 	
-	local_node = local_child->fns->location(local_child, NULL, current);
 	if(local_node == NULL) {
-		crm_debug("Can't colocate unrunnable child %s with %s",
+		crm_err("Can't colocate unrunnable child %s with %s",
 			 local_child->id, rsc->id);
 		return NULL;
 	}
@@ -838,125 +849,110 @@ find_compatible_child(
 	slist_iter(
 		child_rsc, resource_t, rsc->children, lpc,
 
+		/* enum rsc_role_e next_role = minimum_resource_state(child_rsc, current); */
 		enum rsc_role_e next_role = child_rsc->fns->state(child_rsc, current);
 		node = child_rsc->fns->location(child_rsc, NULL, current);
 
 		if(filter != RSC_ROLE_UNKNOWN && next_role != filter) {
-		    crm_debug_2("Filtered %s", child_rsc->id);
+		    crm_debug_3("Filtered %s", child_rsc->id);
 		    continue;
 		}
 		
 		if(node && local_node && node->details == local_node->details) {
-			crm_info("Colocating %s with %s on %s",
-				 local_child->id, child_rsc->id, node->details->uname);
+			crm_debug_2("Pairing %s with %s on %s",
+				    local_child->id, child_rsc->id, node->details->uname);
 			return child_rsc;
 		}
 		);
-	crm_debug("Can't colocate child %s with %s",
-		 local_child->id, rsc->id);
+
+	crm_debug_3("Can't pair %s with %s", local_child->id, rsc->id);
 	return NULL;
 }
 
+resource_t*
+find_compatible_child(
+    resource_t *local_child, resource_t *rsc, enum rsc_role_e filter, gboolean current)
+{
+	resource_t *pair = NULL;
+	GListPtr scratch = NULL;
+	node_t *local_node = NULL;
+	clone_variant_data_t *clone_data = NULL;
+	get_clone_variant_data(clone_data, rsc);
+	
+	local_node = local_child->fns->location(local_child, NULL, current);
+	if(local_node) {
+	    return find_compatible_child_by_node(local_child, local_node, rsc, filter, current);
+	}
+
+	scratch = node_list_dup(local_child->allowed_nodes, FALSE, TRUE);
+	scratch = g_list_sort_with_data(scratch, sort_node_weight, NULL);
+
+	slist_iter(
+		node, node_t, scratch, lpc,
+
+		pair = find_compatible_child_by_node(
+		    local_child, node, rsc, filter, current);
+		if(pair) {
+		    goto done;
+		}
+		);
+	
+	crm_debug("Can't pair %s with %s", local_child->id, rsc->id);
+  done:
+	slist_destroy(node_t, node, scratch, crm_free(node));
+	return pair;
+}
+
 void clone_rsc_colocation_lh(
 	resource_t *rsc_lh, resource_t *rsc_rh, rsc_colocation_t *constraint)
 {
-	gboolean do_interleave = FALSE;
-	resource_t *rsc = constraint->rsc_lh;
-	clone_variant_data_t *clone_data = NULL;
-	clone_variant_data_t *clone_data_rh = NULL;
+	/* -- Never called --
+	 *
+	 * Instead we add the colocation constraints to the child and call from there
+	 */
 	
-	if(rsc == NULL) {
-		pe_err("rsc_lh was NULL for %s", constraint->id);
-		return;
-
-	} else if(constraint->rsc_rh == NULL) {
-		pe_err("rsc_rh was NULL for %s", constraint->id);
-		return;
-		
-	} else {
-		crm_debug_4("Processing constraints from %s", rsc->id);
-	}
-	
-	get_clone_variant_data(clone_data, rsc);
-
-	if(constraint->rsc_rh->variant == pe_clone
-	    || constraint->rsc_rh->variant == pe_master) {
-		get_clone_variant_data(
-			clone_data_rh, constraint->rsc_rh);
-		if(clone_data->clone_node_max
-		   != clone_data_rh->clone_node_max) {
-			crm_config_err("Cannot interleave "XML_CIB_TAG_INCARNATION
-				       " %s and %s because"
-				       " they do not support the same number of"
-					" resources per node",
-				       constraint->rsc_lh->id, constraint->rsc_rh->id);
-			
-		/* only the LHS side needs to be labeled as interleave */
-		} else if(clone_data->interleave) {
-			do_interleave = TRUE;
-
-		} else if(constraint->score >= INFINITY) {
-			GListPtr lhs = NULL, rhs = NULL;
-			lhs = rsc_lh->allowed_nodes;
-			
-			slist_iter(
-				child_rsc, resource_t, rsc_rh->children, lpc,
-				node_t *chosen = child_rsc->fns->location(child_rsc, NULL, FALSE);
-				if(chosen != NULL) {
-					rhs = g_list_append(rhs, chosen);
-				}
-				);
-			
-			rsc_lh->allowed_nodes = node_list_exclude(lhs, rhs, TRUE);
-			
-			pe_free_shallow_adv(rhs, FALSE);
-			pe_free_shallow(lhs);
-			return;
-		}
-
-	} else if(constraint->score >= INFINITY) {
-		crm_config_err("Manditory co-location of clones (%s) with other"
-			       " non-clone (%s) resources is not supported",
-			       rsc_lh->id, rsc_rh->id);
-		return;
-	}
-	
-	if(do_interleave) {
-		resource_t *rh_child = NULL;
-		
-		slist_iter(lh_child, resource_t, rsc->children, lpc,
-
-			   CRM_ASSERT(lh_child != NULL);
-			   rh_child = find_compatible_child(
-			       lh_child, rsc_rh, RSC_ROLE_UNKNOWN, FALSE);
-			   if(rh_child == NULL) {
-			       crm_debug_2("No match found for %s", lh_child->id);
-			       continue;
-			   }
-			   crm_debug("Interleaving %s with %s", lh_child->id, rh_child->id);
-			   lh_child->cmds->rsc_colocation_lh(
-				   lh_child, rh_child, constraint);
-			);
-		return;
-	}
+	CRM_CHECK(FALSE, crm_err("This functionality is not thought to be used. Please report a bug."));
+	CRM_CHECK(rsc_lh, return);
+	CRM_CHECK(rsc_rh, return);
 	
 	slist_iter(
-		child_rsc, resource_t, rsc->children, lpc,
+		child_rsc, resource_t, rsc_lh->children, lpc,
 		
-		child_rsc->cmds->rsc_colocation_lh(child_rsc, constraint->rsc_rh, constraint);
+		child_rsc->cmds->rsc_colocation_lh(child_rsc, rsc_rh, constraint);
 		);
+
+	return;
 }
 
 void clone_rsc_colocation_rh(
 	resource_t *rsc_lh, resource_t *rsc_rh, rsc_colocation_t *constraint)
 {
+	gboolean do_interleave = FALSE;
 	clone_variant_data_t *clone_data = NULL;
+	clone_variant_data_t *clone_data_lh = NULL;
+
 	CRM_CHECK(rsc_lh != NULL, return);
 	CRM_CHECK(rsc_lh->variant == pe_native, return);
 	
-	get_clone_variant_data(clone_data, rsc_rh);
-	
-	crm_debug_3("Processing constraint %s: %s -> %s %d", constraint->id, rsc_lh->id, rsc_rh->id, constraint->score);
+	get_clone_variant_data(clone_data, constraint->rsc_rh);
+	crm_debug_3("Processing constraint %s: %s -> %s %d",
+		    constraint->id, rsc_lh->id, rsc_rh->id, constraint->score);
+
+	if(constraint->rsc_lh->variant >= pe_clone) {
+
+	    get_clone_variant_data(clone_data_lh, constraint->rsc_lh);
+	    if(clone_data->clone_node_max != clone_data_lh->clone_node_max) {
+		crm_config_err("Cannot interleave "XML_CIB_TAG_INCARNATION
+			       " %s and %s because"
+			       " they do not support the same number of"
+			       " resources per node",
+			       constraint->rsc_lh->id, constraint->rsc_rh->id);
+			
+		/* only the LHS side needs to be labeled as interleave */
+	    } else if(clone_data_lh->interleave) {
+		do_interleave = TRUE;
+	    }
+	}
 
 	if(rsc_rh == NULL) {
 		pe_err("rsc_rh was NULL for %s", constraint->id);
@@ -965,10 +961,28 @@ void clone_rsc_colocation_rh(
 	} else if(is_set(rsc_rh->flags, pe_rsc_provisional)) {
 		crm_debug_3("%s is still provisional", rsc_rh->id);
 		return;
-		
+
+	} else if(do_interleave) {
+	    resource_t *rh_child = NULL;
+
+	    rh_child = find_compatible_child(rsc_lh, rsc_rh, RSC_ROLE_UNKNOWN, FALSE);
+	    
+	    if(rh_child) {
+		crm_debug("Pairing %s with %s", rsc_lh->id, rh_child->id);
+		rsc_lh->cmds->rsc_colocation_lh(rsc_lh, rh_child, constraint);
+
+	    } else if(constraint->score >= INFINITY) {
+		crm_notice("Cannot pair %s with instance of %s", rsc_lh->id, rsc_rh->id);
+		assign_node(rsc_lh, NULL, TRUE);
+
+	    } else {
+		crm_debug("Cannot pair %s with instance of %s", rsc_lh->id, rsc_rh->id);
+	    }
+	    
+	    return;
+	    
 	} else if(constraint->score >= INFINITY) {
-		GListPtr lhs = NULL, rhs = NULL;
-		lhs = rsc_lh->allowed_nodes;
+		GListPtr rhs = NULL;
 		
 		slist_iter(
 			child_rsc, resource_t, rsc_rh->children, lpc,
@@ -978,10 +992,8 @@ void clone_rsc_colocation_rh(
 			}
 			);
 
-		rsc_lh->allowed_nodes = node_list_exclude(lhs, rhs, FALSE);
-
-		pe_free_shallow_adv(rhs, FALSE);
-		pe_free_shallow(lhs);
+		rsc_lh->allowed_nodes = node_list_exclude(rsc_lh->allowed_nodes, rhs, FALSE);
+		g_list_free(rhs);
 		return;
 	}
 
@@ -1339,11 +1351,25 @@ void clone_rsc_order_lh(resource_t *rsc,
 		
 		CRM_ASSERT(rh_child != NULL);
 		lh_child = find_compatible_child(rh_child, rsc, RSC_ROLE_UNKNOWN, current);
-		if(lh_child == NULL) {
-		    crm_debug_2("No match found for %s", rh_child->id);
+		if(lh_child == NULL && current) {
+		    continue;
+		    
+		} else if(lh_child == NULL) {
+		    crm_debug("No match found for %s (%d)", rh_child->id, current);
+
+		    /* Me no like this hack - but what else can we do?
+		     *
+		     * If there is no-one active or about to be active
+		     *   on the same node as rh_child, then they must
+		     *   not be allowed to start
+		     */
+		    if(order->type & (pe_order_runnable_left|pe_order_implies_right) /* Mandatory */) {
+			crm_info("Inhibiting %s from being active", rh_child->id);
+			assign_node(rh_child, NULL, TRUE);
+		    }
 		    continue;
 		}
-		crm_notice("Interleaving %s with %s", lh_child->id, rh_child->id);
+		crm_debug("Pairing %s with %s", lh_child->id, rh_child->id);
 		order->rh_rsc = rh_child;
 		lh_child->cmds->rsc_order_lh(lh_child, order, data_set);
 		order->rh_rsc = rh_saved;
@@ -1545,11 +1571,6 @@ void clone_rsc_order_rh(
 		child_rsc->cmds->rsc_order_rh(lh_action, child_rsc, order);
 		);
 
-	    if(rsc->fns->state(rsc, TRUE) < RSC_ROLE_STARTED
-		&& rsc->fns->state(rsc, FALSE) > RSC_ROLE_STOPPED) {
-		order->type |= pe_order_implies_right;
-	    }
-
 	} else if(lh_p && lh_p != rsc && lh_p->variant < pe_clone) {
 	    clone_rsc_order_rh_non_clone(lh_p, lh_action, rsc, order);
 	    return;
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/constraints.c
--- a/pengine/constraints.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/constraints.c	Mon Jul 12 18:48:04 2010 +0200
@@ -783,9 +783,11 @@ unpack_order_set(xmlNode *set, enum pe_o
     const char *sequential_s = crm_element_value(set, "sequential");
     const char *kind_s = crm_element_value(set, XML_ORDER_ATTR_KIND);
 
+    /*
     char *pseudo_id = NULL;
     char *end_id    = NULL;
     char *begin_id  = NULL;
+    */
 
     if(action == NULL) {
 	action = RSC_START;
@@ -815,20 +817,24 @@ unpack_order_set(xmlNode *set, enum pe_o
 	*begin = NULL;
 	*inv_end = NULL;
 	*inv_begin = NULL;
-	return TRUE;
+	goto done;
     }
 
+    /*
     pseudo_id = crm_concat(id, action, '-');
     end_id    = crm_concat(pseudo_id, "end", '-');
     begin_id  = crm_concat(pseudo_id, "begin", '-');
+    */
 
     *rsc = NULL;
+    /*
     *end = get_pseudo_op(end_id, data_set);
     *begin = get_pseudo_op(begin_id, data_set);    
 
     crm_free(pseudo_id);
     crm_free(begin_id);
     crm_free(end_id);
+    */
     
     set_iter = resources;
     while(set_iter != NULL) {
@@ -837,11 +843,13 @@ unpack_order_set(xmlNode *set, enum pe_o
 
 	key = generate_op_key(resource->id, action, 0);
 
+	/*
 	custom_action_order(NULL, NULL, *begin, resource, crm_strdup(key), NULL,
 			    flags|pe_order_implies_left_printed, data_set);
 	
 	custom_action_order(resource, crm_strdup(key), NULL, NULL, NULL, *end,
 			    flags|pe_order_implies_right_printed, data_set);
+	*/
 	
 	if(local_kind == pe_order_kind_serialize) {
 	    /* Serialize before everything that comes after */
@@ -877,6 +885,7 @@ unpack_order_set(xmlNode *set, enum pe_o
     last = NULL;
     action = invert_action(action);
     
+    /*
     pseudo_id = crm_concat(id, action, '-');
     end_id    = crm_concat(pseudo_id, "end", '-');
     begin_id  = crm_concat(pseudo_id, "begin", '-');
@@ -887,6 +896,7 @@ unpack_order_set(xmlNode *set, enum pe_o
     crm_free(pseudo_id);
     crm_free(begin_id);
     crm_free(end_id);
+    */
     
     flags = get_flags(id, local_kind, action, action, TRUE);
 
@@ -895,6 +905,7 @@ unpack_order_set(xmlNode *set, enum pe_o
 	resource = (resource_t *) set_iter->data;
 	set_iter = set_iter->next;
 
+	/*
 	key = generate_op_key(resource->id, action, 0);
 
 	custom_action_order(NULL, NULL, *inv_begin, resource, crm_strdup(key), NULL,
@@ -902,6 +913,7 @@ unpack_order_set(xmlNode *set, enum pe_o
 
 	custom_action_order(resource, key, NULL, NULL, NULL, *inv_end,
 			    flags|pe_order_implies_right_printed, data_set);
+	*/
 	
 	if(sequential) {
 	    if(last != NULL) {
@@ -917,7 +929,7 @@ unpack_order_set(xmlNode *set, enum pe_o
 }
 
 static gboolean order_rsc_sets(
-    const char *id, xmlNode *set1, xmlNode *set2, enum pe_order_kind kind, pe_working_set_t *data_set) {
+    const char *id, xmlNode *set1, xmlNode *set2, enum pe_order_kind kind, pe_working_set_t *data_set, gboolean invert) {
 		
     resource_t *rsc_1 = NULL;
     resource_t *rsc_2 = NULL;
@@ -928,25 +940,61 @@ static gboolean order_rsc_sets(
     const char *sequential_1 = crm_element_value(set1, "sequential");
     const char *sequential_2 = crm_element_value(set2, "sequential");
 
-    enum pe_ordering flags = get_flags(id, kind, action_1, action_2, FALSE);
-	    
+    enum pe_ordering flags = pe_order_none;
+
+    if (action_1 == NULL) {
+	action_1 = RSC_START;	  
+    };
+
+    if (action_2 == NULL) {
+	action_2 = RSC_START;	  
+    };
+
+    if (invert == FALSE) {
+	flags = get_flags(id, kind, action_1, action_2, FALSE);
+    } else {
+	action_1 = invert_action(action_1);
+	action_2 = invert_action(action_2);
+	flags = get_flags(id, kind, action_2, action_1, TRUE);
+    }
+
     if(crm_is_true(sequential_1)) {
-	/* get the first one */
-	xml_child_iter_filter(
-	    set1, xml_rsc, XML_TAG_RESOURCE_REF,
-	    rsc_1 = pe_find_resource(data_set->resources, ID(xml_rsc));
-	    break;
-	    );
+	if(invert == FALSE) {
+	    /* get the last one */
+	    const char *rid = NULL;
+	    xml_child_iter_filter(
+		set1, xml_rsc, XML_TAG_RESOURCE_REF,
+		rid = ID(xml_rsc);
+		);
+	    rsc_1 = pe_find_resource(data_set->resources, rid);
+
+	} else {
+	    /* get the first one */
+	    xml_child_iter_filter(
+		set1, xml_rsc, XML_TAG_RESOURCE_REF,
+		rsc_1 = pe_find_resource(data_set->resources, ID(xml_rsc));
+		break;
+		);
+	}
     }
 
     if(crm_is_true(sequential_2)) {
-	/* get the last one */
-	const char *rid = NULL;
-	xml_child_iter_filter(
-	    set2, xml_rsc, XML_TAG_RESOURCE_REF,
-	    rid = ID(xml_rsc);
-	    );
-	rsc_2 = pe_find_resource(data_set->resources, rid);
+	if(invert == FALSE) {
+	    /* get the first one */
+	    xml_child_iter_filter(
+		set2, xml_rsc, XML_TAG_RESOURCE_REF,
+		rsc_2 = pe_find_resource(data_set->resources, ID(xml_rsc));
+		break;
+		);
+	} else {
+	    /* get the last one */
+	    const char *rid = NULL;
+	    xml_child_iter_filter(
+		set2, xml_rsc, XML_TAG_RESOURCE_REF,
+		rid = ID(xml_rsc);
+		);
+	    rsc_2 = pe_find_resource(data_set->resources, rid);
+	}
     }
 
     if(rsc_1 != NULL && rsc_2 != NULL) {
@@ -981,6 +1029,7 @@ static gboolean order_rsc_sets(
     return TRUE;
 }
 
+/*
 static char *null_or_opkey(resource_t *rsc, const char *action) 
 {
     if(rsc == NULL) {
@@ -988,6 +1037,7 @@ static char *null_or_opkey(resource_t *r
     }
     return generate_op_key(rsc->id, action, 0);
 }
+*/
 
 gboolean
 unpack_rsc_order(xmlNode *xml_obj, pe_working_set_t *data_set)
@@ -995,7 +1045,9 @@ unpack_rsc_order(xmlNode *xml_obj, pe_wo
 	gboolean any_sets = FALSE;
 
 	resource_t *rsc = NULL;
+	/*
 	resource_t *last_rsc = NULL;
+	*/
 
 	action_t *set_end = NULL;
 	action_t *set_begin = NULL;
@@ -1004,10 +1056,12 @@ unpack_rsc_order(xmlNode *xml_obj, pe_wo
 	action_t *set_inv_begin = NULL;
 	
 	xmlNode *last = NULL;
+	/*
 	action_t *last_end = NULL;
 	action_t *last_begin = NULL;
 	action_t *last_inv_end = NULL;
 	action_t *last_inv_begin = NULL;
+	*/
 	
 	const char *id    = crm_element_value(xml_obj, XML_ATTR_ID);
 	const char *invert = crm_element_value(xml_obj, XML_CONS_ATTR_SYMMETRICAL);
@@ -1026,6 +1080,8 @@ unpack_rsc_order(xmlNode *xml_obj, pe_wo
 				&set_inv_begin, &set_inv_end, invert, data_set) == FALSE) {
 		return FALSE;
 
+	    /* Expand orders in order_rsc_sets() instead of via pseudo actions. */
+	    /*
 	    } else if(last) {
 		const char *set_action = crm_element_value(set, "action");
 		const char *last_action = crm_element_value(last, "action");
@@ -1059,17 +1115,26 @@ unpack_rsc_order(xmlNode *xml_obj, pe_wo
 			    flags, data_set);
 		    }
 		}
+	    */
 		    
-	    } else if(/* never called */last && order_rsc_sets(id, last, set, kind, data_set) == FALSE) {
-		return FALSE;
+	    } else if(/* never called -- Now call it for supporting clones in resource sets */last) {
+		if(order_rsc_sets(id, last, set, kind, data_set, FALSE) == FALSE) {
+			return FALSE;
+		}
+
+		if(crm_is_true(invert) && order_rsc_sets(id, set, last, kind, data_set, TRUE) == FALSE) {
+			return FALSE;
+		}
 
 	    }
 	    last = set;
+	    /*
 	    last_rsc = rsc;
 	    last_end = set_end;
 	    last_begin = set_begin;
 	    last_inv_end = set_inv_end;
 	    last_inv_begin = set_inv_begin;
+	    */
 	    );
 
 	if(any_sets == FALSE) {
@@ -1094,7 +1159,10 @@ unpack_colocation_set(xmlNode *set, int 
 	local_score = char2score(score_s);
     }
     
-    if(sequential == NULL || crm_is_true(sequential)) {
+    if(sequential != NULL && crm_is_true(sequential) == FALSE) {
+	return TRUE;
+
+    } else if(local_score >= 0) {
 	xml_child_iter_filter(
 	    set, xml_rsc, XML_TAG_RESOURCE_REF,
 	    
@@ -1106,6 +1174,29 @@ unpack_colocation_set(xmlNode *set, int 
 
 	    with = resource;
 	    );
+	
+    } else {
+	/* Anti-colocating with every prior resource is
+	 * the only way to ensure the intuitive result
+	 * (ie. that no-one in the set can run with anyone
+	 * else in the set)
+	 */
+	
+	xml_child_iter_filter(
+	    set, xml_rsc, XML_TAG_RESOURCE_REF,
+	    
+	    resource = pe_find_resource(data_set->resources, ID(xml_rsc));
+
+	    xml_child_iter_filter(
+		set, xml_rsc_with, XML_TAG_RESOURCE_REF,
+		if(safe_str_eq(resource->id, ID(xml_rsc_with))) {
+		    break;
+		}
+		with = pe_find_resource(data_set->resources, ID(xml_rsc_with));
+		crm_debug_2("Anti-Colocating %s with %s", resource->id, with->id);
+		rsc_colocation_new(set_id, NULL, local_score, resource, with, role, role, data_set);
+		);
+	    );
     }
     
     return TRUE;
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/graph.c
--- a/pengine/graph.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/graph.c	Mon Jul 12 18:48:04 2010 +0200
@@ -675,6 +675,16 @@ should_dump_input(int last_action, actio
 		   wrapper->action->id, wrapper->action->uuid, action->uuid);
 	return FALSE;
 
+    } else if(wrapper->action->rsc
+	      && wrapper->action->rsc != action->rsc
+	      && is_set(wrapper->action->rsc->flags, pe_rsc_failed)
+	      && is_not_set(wrapper->action->rsc->flags, pe_rsc_managed)
+	      && strstr(wrapper->action->uuid, "_stop_0")) {
+	crm_warn("Ignoring requirement that %s comeplete before %s:"
+		 " unmanaged failed resources cannot prevent shutdown",
+		 wrapper->action->uuid, action->uuid);
+	return FALSE;
+
     } else if(wrapper->action->dumped || should_dump_action(wrapper->action)) {
 	do_crm_log_unlikely(log_dump, "Input (%d) %s should be dumped for %s",
 		   wrapper->action->id, wrapper->action->uuid, action->uuid);
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/group.c
--- a/pengine/group.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/group.c	Mon Jul 12 18:48:04 2010 +0200
@@ -132,10 +132,6 @@ void group_create_actions(resource_t *rs
 	    op = custom_action(rsc, promoted_key(rsc), RSC_PROMOTED, NULL, TRUE, TRUE, data_set);
 	    op->pseudo = TRUE; op->runnable = TRUE;
 	}
-
-	
-	rsc->actions = rsc->actions;
-/* 	rsc->actions = NULL; */
 }
 
 void
@@ -336,8 +332,16 @@ void group_rsc_colocation_rh(
 		return;
 	
 	} else if(group_data->colocated && group_data->first_child) {
-		group_data->first_child->cmds->rsc_colocation_rh(
+		if(constraint->score >= INFINITY) {
+		    /* Ensure RHS is _fully_ up before can start LHS */
+		    group_data->last_child->cmds->rsc_colocation_rh(
+			rsc_lh, group_data->last_child, constraint);
+		} else {
+		    /* A partially active RHS is fine */
+		    group_data->first_child->cmds->rsc_colocation_rh(
 			rsc_lh, group_data->first_child, constraint); 
+		}
+		
 		return;
 
 	} else if(constraint->score >= INFINITY) {
@@ -411,6 +415,7 @@ void group_rsc_order_rh(
 	    char *task_s = NULL;
 	    int interval = 0;
 	    enum action_tasks task = 0;
+	    enum rsc_role_e next_role = minimum_resource_state(rsc, FALSE);
 	    
 	    parse_op_key(order->lh_action_task, &tmp, &task_s, &interval);
 	    task = text2task(task_s);
@@ -445,6 +450,12 @@ void group_rsc_order_rh(
 		    child_rsc->cmds->rsc_order_rh(lh_action, child_rsc, order);
 		    );
 	    }
+
+	    if(next_role < RSC_ROLE_STARTED
+	       && task == stop_rsc
+	       && next_role != rsc->fns->state(rsc, FALSE) /* Group is partially up */) {
+		native_rsc_order_rh(lh_action, group_data->last_child, order);	    
+	    }
 	}
 	
 	native_rsc_order_rh(lh_action, rsc, order);
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/main.c
--- a/pengine/main.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/main.c	Mon Jul 12 18:48:04 2010 +0200
@@ -135,7 +135,7 @@ main(int argc, char ** argv)
 		usage(crm_system_name,LSB_EXIT_GENERIC);
 	}
 
-	crm_log_init(CRM_SYSTEM_PENGINE, LOG_INFO, TRUE, FALSE, argc, argv);
+	crm_log_init(NULL, LOG_INFO, TRUE, FALSE, argc, argv);
 
 	if(crm_is_writable(PE_STATE_DIR, NULL, CRM_DAEMON_USER, CRM_DAEMON_GROUP, FALSE) == FALSE) {
 	    crm_err("Bad permissions on "PE_STATE_DIR". Terminating");
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/master.c
--- a/pengine/master.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/master.c	Mon Jul 12 18:48:04 2010 +0200
@@ -370,7 +370,7 @@ master_score(resource_t *rsc, node_t *no
 
 	if(rsc->running_on) {
 	    node_t *match = pe_find_node_id(rsc->allowed_nodes, node->details->id);
-	    if(match->weight < 0) {
+	    if(match && match->weight < 0) {
 		crm_debug_2("%s on %s has score: %d - ignoring master pref",
 			    rsc->id, match->details->uname, match->weight);
 		return score;
@@ -833,8 +833,7 @@ void master_rsc_colocation_rh(
 			);
 
 	} else if(is_set(rsc_lh->flags, pe_rsc_provisional)) {
-		GListPtr lhs = NULL, rhs = NULL;
-		lhs = rsc_lh->allowed_nodes;
+		GListPtr rhs = NULL;
 		slist_iter(
 			child_rsc, resource_t, rsc_rh->children, lpc,
 			node_t *chosen = child_rsc->fns->location(child_rsc, NULL, FALSE);
@@ -857,11 +856,10 @@ void master_rsc_colocation_rh(
 		if(constraint->role_lh != RSC_ROLE_MASTER
 		   || constraint->role_rh != RSC_ROLE_MASTER) {
 		    if(constraint->score > 0) {
-			rsc_lh->allowed_nodes = node_list_exclude(lhs, rhs, TRUE);
-			pe_free_shallow(lhs);
+			rsc_lh->allowed_nodes = node_list_exclude(rsc_lh->allowed_nodes, rhs, TRUE);
 		    }
 		}
-		pe_free_shallow_adv(rhs, FALSE);
+		g_list_free(rhs);
 
 	} else if(constraint->role_lh == RSC_ROLE_MASTER) {
 	    resource_t *rh_child = find_compatible_child(rsc_lh, rsc_rh, constraint->role_rh, FALSE);
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/native.c
--- a/pengine/native.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/native.c	Mon Jul 12 18:48:04 2010 +0200
@@ -303,6 +303,7 @@ node_t *
 native_color(resource_t *rsc, pe_working_set_t *data_set)
 {
         int alloc_details = scores_log_level+1;
+	const char *class = crm_element_value(rsc->xml, XML_AGENT_ATTR_CLASS);
 	if(rsc->parent && is_not_set(rsc->parent->flags, pe_rsc_allocating)) {
 		/* never allocate children on their own */
 		crm_debug("Escalating allocation of %s to its parent: %s",
@@ -388,7 +389,8 @@ native_color(resource_t *rsc, pe_working
 		     assign_to?assign_to->details->uname:"'nowhere'", reason);
 	    native_assign_node(rsc, NULL, assign_to, TRUE);
 
-	} else if(is_set(data_set->flags, pe_flag_stop_everything)) {
+	} else if(is_set(data_set->flags, pe_flag_stop_everything)
+		  && safe_str_neq(class, "stonith")) {
 	    crm_debug("Forcing %s to stop", rsc->id);
 	    native_assign_node(rsc, NULL, NULL, TRUE);
 
@@ -743,8 +745,10 @@ void native_internal_constraints(resourc
 
 			char *load_stopped_task = crm_concat(LOAD_STOPPED, current->details->uname, '_');
 			action_t *load_stopped = get_pseudo_op(load_stopped_task, data_set);
-			load_stopped->node = current;
-			load_stopped->optional = FALSE;
+			if(load_stopped->node == NULL) {
+			    load_stopped->node = node_copy(current);
+			    load_stopped->optional = FALSE;
+			}
 
 	    		custom_action_order(
 				rsc, stop_key(rsc), NULL,
@@ -757,8 +761,10 @@ void native_internal_constraints(resourc
 
 			char *load_stopped_task = crm_concat(LOAD_STOPPED, next->details->uname, '_');
 			action_t *load_stopped = get_pseudo_op(load_stopped_task, data_set);
-			load_stopped->node = next;
-			load_stopped->optional = FALSE;
+			if(load_stopped->node == NULL) {
+			    load_stopped->node = node_copy(next);
+			    load_stopped->optional = FALSE;
+			}
 
     			custom_action_order(
 				NULL, load_stopped_task, load_stopped,
@@ -1205,7 +1211,7 @@ LogActions(resource_t *rsc, pe_working_s
 	
 	CRM_CHECK(next != NULL,);
 	if(next == NULL) {
-	} else if(possible_matches) {
+	} else if(possible_matches && current) {
 	    crm_notice("Migrate resource %s\t(%s %s -> %s)",
 		       rsc->id, role2text(rsc->role), current->details->uname, next->details->uname);
 	    g_list_free(possible_matches);
@@ -1341,7 +1347,6 @@ NoRoleChange(resource_t *rsc, node_t *cu
 gboolean
 StopRsc(resource_t *rsc, node_t *next, gboolean optional, pe_working_set_t *data_set)
 {
-	action_t *stop = NULL;
 	const char *class = crm_element_value(rsc->xml, XML_AGENT_ATTR_CLASS);
 
 	crm_debug_2("Executing: %s", rsc->id);
@@ -1358,7 +1363,7 @@ StopRsc(resource_t *rsc, node_t *next, g
 	
 	slist_iter(
 		current, node_t, rsc->running_on, lpc,
-		stop = stop_action(rsc, current, optional);
+		stop_action(rsc, current, optional);
 
 		if(is_set(data_set->flags, pe_flag_remove_after_stop)) {
 			DeleteRsc(rsc, current, optional, data_set);
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/ptest.c
--- a/pengine/ptest.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/ptest.c	Mon Jul 12 18:48:04 2010 +0200
@@ -175,7 +175,7 @@ main(int argc, char **argv)
 
         g_mem_set_vtable(&vtable);
 
-	crm_log_init("ptest", LOG_CRIT, FALSE, FALSE, 0, NULL);
+	crm_log_init_quiet(NULL, LOG_CRIT, FALSE, FALSE, argc, argv);
 	crm_set_options("V?$XD:G:I:Lwx:d:aSsU", "[-?Vv] -[Xxp] {other options}", long_options,
 			"Calculate the cluster's response to the supplied cluster state\n");
 	
@@ -292,6 +292,10 @@ main(int argc, char **argv)
 	    crm_help('?', 1);
 	}
 	
+	if(get_object_root(XML_CIB_TAG_STATUS, cib_object) == NULL) {
+		create_xml_node(cib_object, XML_CIB_TAG_STATUS);
+	}
+
 	if(cli_config_update(&cib_object, NULL, FALSE) == FALSE) {
 	    free_xml(cib_object);
 	    return cib_STALE;
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/ptest.supp
--- a/pengine/ptest.supp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/ptest.supp	Mon Jul 12 18:48:04 2010 +0200
@@ -1,18 +1,1 @@
-{
-   Libxml2 Mutex
-   Memcheck:Leak
-   fun:malloc
-   fun:xmlNewRMutex
-   fun:xmlDictFree
-   fun:xmlHashFree
-   fun:xmlFreeDoc
-}
-
-{
-   GLib global allocator object
-   Memcheck:Leak
-   fun:calloc
-   fun:g_malloc0
-   obj:*
-   fun:g_slice_alloc
-}
+# Valgrind suppressions for PE testing
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/regression.core.sh.in
--- a/pengine/regression.core.sh.in	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/regression.core.sh.in	Mon Jul 12 18:48:04 2010 +0200
@@ -105,6 +105,7 @@ function do_test {
 
     scores=$io_dir/${base}.scores
     score_output=$io_dir/${base}.scores.pe
+    valgrind_output=$io_dir/${base}.valgrind
 
     if [ "x$1" = "x--rc" ]; then
 	expected_rc=$2
@@ -125,13 +126,20 @@ function do_test {
     fi
 
 #    ../admin/crm_verify -X $input
-    CIB_shadow_dir=$io_dir $test_cmd -x $input -D $dot_output -G $output -SQ -s $* > $score_output
+    CIB_shadow_dir=$io_dir $test_cmd -x $input -D $dot_output -G $output -SQ -s $* > $score_output 2> $valgrind_output
     rc=$?
     if [ $rc != $expected_rc ]; then
 	failed "Test returned: $rc";
 	num_failed=`expr $num_failed + 1`
     fi
 
+    if [ -s $valgrind_output ]; then
+	error "Valgrind reported errors";
+	num_failed=`expr $num_failed + 1`
+	cat $valgrind_output
+    fi
+    rm -f $valgrind_output
+
     if [ -s core ]; then
 	error "Core-file detected: core.${base}";
 	num_failed=`expr $num_failed + 1`
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/regression.sh
--- a/pengine/regression.sh	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/regression.sh	Mon Jul 12 18:48:04 2010 +0200
@@ -113,6 +113,14 @@ do_test coloc-slave-anti "Anti-colocatio
 do_test coloc-attr "Colocation based on node attributes"
 do_test coloc-negative-group "Negative colocation with a group"
 do_test coloc-intra-set "Intra-set colocation"
+do_test bug-lf-2435 "Colocation sets with a negative score"
+
+echo ""
+do_test rsc-sets-seq-true "Resource Sets - sequential=false"
+do_test rsc-sets-seq-false "Resource Sets - sequential=true"
+do_test rsc-sets-clone "Resource Sets - Clone"
+do_test rsc-sets-master "Resource Sets - Master"
+do_test rsc-sets-clone-1 "Resource Sets - Clone (lf#2404)"
 
 #echo ""
 #do_test agent1 "version: lt (empty)"
@@ -214,6 +222,7 @@ do_test group14 "Group stop (graph termi
 do_test group15 "-ve group colocation"
 do_test bug-1573 "Partial stop of a group with two children"
 do_test bug-1718 "Mandatory group ordering - Stop group_FUN"
+do_test bug-lf-2422 "Dependancy on partially active group - stop ocfs:*"
 
 echo ""
 do_test clone-anon-probe-1 "Probe the correct (anonymous) clone instance for each node"
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/594.dot
--- a/pengine/test10/594.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/594.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -33,7 +33,6 @@
 "probe_complete hadev2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "DcIPaddr_start_0 hadev1" [ style = bold]
 "probe_complete" -> "DcIPaddr_stop_0 hadev2" [ style = bold]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_stop_0 hadev2" [ style = bold]
 "probe_complete" -> "child_DoFencing:2_stop_0 hadev1" [ style = bold]
 "probe_complete" -> "rsc_hadev2_start_0 hadev1" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/594.exp
--- a/pengine/test10/594.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/594.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -175,11 +175,7 @@
         <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="9" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="14" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/662.dot
--- a/pengine/test10/662.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/662.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -41,7 +41,6 @@
 "probe_complete c001n04" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n09" -> "probe_complete" [ style = bold]
 "probe_complete c001n09" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_stop_0 c001n02" [ style = bold]
 "probe_complete" -> "rsc_c001n02_start_0 c001n03" [ style = bold]
 "probe_complete" -> "rsc_c001n02_stop_0 c001n02" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/662.exp
--- a/pengine/test10/662.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/662.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -273,11 +273,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="28" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/696.dot
--- a/pengine/test10/696.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/696.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -38,7 +38,6 @@
 "probe_complete hadev3" -> "probe_complete" [ style = bold]
 "probe_complete hadev3" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "DcIPaddr_start_0 hadev2" [ style = bold]
-"probe_complete" -> "DoFencing_start_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:2_start_0 hadev1" [ style = bold]
 "probe_complete" -> "rsc_hadev1_start_0 hadev1" [ style = bold]
 "probe_complete" -> "rsc_hadev1_stop_0 hadev3" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/696.exp
--- a/pengine/test10/696.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/696.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -290,11 +290,7 @@
         <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="28" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/726.dot
--- a/pengine/test10/726.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/726.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -13,8 +13,6 @@
 "DoFencing_start_0" -> "child_DoFencing:2_start_0 sgi2" [ style = bold]
 "DoFencing_start_0" -> "child_DoFencing:3_start_0 ibm1" [ style = bold]
 "DoFencing_start_0" [ style=bold color="green" fontcolor="orange" ]
-"DoFencing_stop_0" -> "DoFencing_start_0" [ style = bold]
-"DoFencing_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "child_DoFencing:0_monitor_0 ibm1" -> "probe_complete ibm1" [ style = bold]
 "child_DoFencing:0_monitor_0 ibm1" [ style=bold color="green" fontcolor="black" ]
@@ -66,8 +64,6 @@
 "probe_complete test02" [ style=bold color="green" fontcolor="black" ]
 "probe_complete test03" -> "probe_complete" [ style = bold]
 "probe_complete test03" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_start_0" [ style = bold]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_start_0 test02" [ style = bold]
 "probe_complete" -> "child_DoFencing:1_start_0 test03" [ style = bold]
 "probe_complete" -> "child_DoFencing:2_start_0 sgi2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/726.exp
--- a/pengine/test10/726.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/726.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -503,14 +503,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="60" operation="stop" operation_key="DoFencing_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="48" priority="1000000">
      <action_set>
@@ -538,18 +531,6 @@
    </synapse>
    <synapse id="49">
      <action_set>
-       <pseudo_event id="60" operation="stop" operation_key="DoFencing_stop_0">
-        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="50">
-     <action_set>
        <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -560,7 +541,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="51">
+  <synapse id="50">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -581,7 +562,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="52" priority="1000000">
+  <synapse id="51" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="test03" on_node_uuid="f9c593eb-ca0d-4ab3-ba88-fde12c02334a">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -602,7 +583,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="53" priority="1000000">
+  <synapse id="52" priority="1000000">
      <action_set>
        <rsc_op id="8" operation="probe_complete" operation_key="probe_complete" on_node="test02" on_node_uuid="f75e684a-be1e-4036-89e5-a14f8dcdc947">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -635,7 +616,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="54" priority="1000000">
+  <synapse id="53" priority="1000000">
      <action_set>
        <rsc_op id="17" operation="probe_complete" operation_key="probe_complete" on_node="sgi2" on_node_uuid="619e8a37-147a-4782-ac11-46afad7c32b8">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -671,7 +652,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="55" priority="1000000">
+  <synapse id="54" priority="1000000">
      <action_set>
        <rsc_op id="27" operation="probe_complete" operation_key="probe_complete" on_node="ibm1" on_node_uuid="d0d76dd9-7a01-4c12-bbec-98aa2a669638">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/735.dot
--- a/pengine/test10/735.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/735.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -6,8 +6,6 @@
 "DoFencing_start_0" -> "child_DoFencing:0_start_0 hadev2" [ style = bold]
 "DoFencing_start_0" -> "child_DoFencing:1_start_0 hadev3" [ style = bold]
 "DoFencing_start_0" [ style=bold color="green" fontcolor="orange" ]
-"DoFencing_stop_0" -> "DoFencing_start_0" [ style = bold]
-"DoFencing_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "child_DoFencing:0_monitor_0 hadev3" -> "probe_complete hadev3" [ style = bold]
 "child_DoFencing:0_monitor_0 hadev3" [ style=bold color="green" fontcolor="black" ]
@@ -23,10 +21,9 @@
 "child_DoFencing:2_monitor_0 hadev3" [ style=bold color="green" fontcolor="black" ]
 "probe_complete hadev3" -> "probe_complete" [ style = bold]
 "probe_complete hadev3" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_start_0" [ style = bold]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_start_0 hadev2" [ style = bold]
 "probe_complete" -> "child_DoFencing:1_start_0 hadev3" [ style = bold]
+"probe_complete" -> "rsc_hadev1_stop_0 hadev2" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc_hadev1_monitor_5000 hadev3" [ style=bold color="green" fontcolor="black" ]
 "rsc_hadev1_start_0 hadev3" -> "rsc_hadev1_monitor_5000 hadev3" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/735.exp
--- a/pengine/test10/735.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/735.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -15,7 +15,11 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </rsc_op>
      </action_set>
-    <inputs/>
+    <inputs>
+      <trigger>
+        <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
    </synapse>
    <synapse id="2">
      <action_set>
@@ -156,14 +160,7 @@
         <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="DoFencing_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="14" priority="1000000">
      <action_set>
@@ -185,18 +182,6 @@
    </synapse>
    <synapse id="15">
      <action_set>
-       <pseudo_event id="26" operation="stop" operation_key="DoFencing_stop_0">
-        <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="16">
-     <action_set>
        <pseudo_event id="3" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -207,7 +192,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="17">
+  <synapse id="16">
      <action_set>
        <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -219,7 +204,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18" priority="1000000">
+  <synapse id="17" priority="1000000">
      <action_set>
        <rsc_op id="6" operation="probe_complete" operation_key="probe_complete" on_node="hadev3" on_node_uuid="879e65f8-4b38-4c56-9552-4752ad436669">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/797.dot
--- a/pengine/test10/797.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/797.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -56,8 +56,6 @@
 "probe_complete c001n03" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "DcIPaddr_start_0 c001n03" [ style = dashed]
 "probe_complete" -> "DcIPaddr_stop_0 c001n03" [ style = bold]
-"probe_complete" -> "DoFencing_start_0" [ style = bold]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_stop_0 c001n01" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_stop_0 c001n03" [ style = bold]
 "probe_complete" -> "child_DoFencing:1_start_0 c001n01" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/797.exp
--- a/pengine/test10/797.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/797.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -288,9 +288,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="13" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="50" operation="stop" operation_key="DoFencing_stop_0"/>
        </trigger>
        <trigger>
@@ -319,11 +316,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="13" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="27" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/829.dot
--- a/pengine/test10/829.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/829.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -28,7 +28,6 @@
 "probe_complete c001n03" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n08" -> "probe_complete" [ style = bold]
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_stop_0 c001n02" [ style = bold]
 "probe_complete" -> "rsc_c001n02_start_0 c001n03" [ style = bold]
 "probe_complete" -> "rsc_c001n02_stop_0 c001n02" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/829.exp
--- a/pengine/test10/829.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/829.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -217,11 +217,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="9" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="22" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bnc-515172.dot
--- a/pengine/test10/bnc-515172.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bnc-515172.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -3,9 +3,6 @@ digraph "g" {
 "GRP_Web_Server_start_0" -> "GRP_Web_Server_running_0" [ style = bold]
 "GRP_Web_Server_start_0" -> "PRIM_Web_IP1_start_0 sles11-ha2" [ style = bold]
 "GRP_Web_Server_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"PRIM_Web_IP1_clear_failcount sles11-ha1" [ style=bold color="green" fontcolor="black"  ]
-"PRIM_Web_IP1_clear_failcount sles11-ha2" [ style=bold color="green" fontcolor="black"  ]
-"PRIM_Web_IP1_clear_failcount sles11-ha3" [ style=bold color="green" fontcolor="black"  ]
 "PRIM_Web_IP1_monitor_5000 sles11-ha2" [ style=bold color="green" fontcolor="black"  ]
 "PRIM_Web_IP1_start_0 sles11-ha2" -> "GRP_Web_Server_running_0" [ style = bold]
 "PRIM_Web_IP1_start_0 sles11-ha2" -> "PRIM_Web_IP1_monitor_5000 sles11-ha2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bnc-515172.exp
--- a/pengine/test10/bnc-515172.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bnc-515172.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1,7 +1,7 @@
 <transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
   <synapse id="0">
     <action_set>
-      <pseudo_event id="30" operation="start" operation_key="GRP_Web_Server_start_0">
+      <pseudo_event id="27" operation="start" operation_key="GRP_Web_Server_start_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
@@ -9,69 +9,42 @@
   </synapse>
   <synapse id="1">
     <action_set>
-      <pseudo_event id="31" operation="running" operation_key="GRP_Web_Server_running_0">
+      <pseudo_event id="28" operation="running" operation_key="GRP_Web_Server_running_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="28" operation="start" operation_key="PRIM_Web_IP1_start_0" on_node="sles11-ha2" on_node_uuid="sles11-ha2"/>
+        <rsc_op id="25" operation="start" operation_key="PRIM_Web_IP1_start_0" on_node="sles11-ha2" on_node_uuid="sles11-ha2"/>
       </trigger>
       <trigger>
-        <pseudo_event id="30" operation="start" operation_key="GRP_Web_Server_start_0"/>
+        <pseudo_event id="27" operation="start" operation_key="GRP_Web_Server_start_0"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="2">
     <action_set>
-      <crm_event id="1" operation="clear_failcount" operation_key="PRIM_Web_IP1_clear_failcount" on_node="sles11-ha1" on_node_uuid="sles11-ha1">
-        <primitive id="PRIM_Web_IP1" long-id="GRP_Web_Server:PRIM_Web_IP1" class="ocf" provider="heartbeat" type="IPaddr"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" ip="192.168.2.45"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="3">
-    <action_set>
-      <crm_event id="6" operation="clear_failcount" operation_key="PRIM_Web_IP1_clear_failcount" on_node="sles11-ha2" on_node_uuid="sles11-ha2">
-        <primitive id="PRIM_Web_IP1" long-id="GRP_Web_Server:PRIM_Web_IP1" class="ocf" provider="heartbeat" type="IPaddr"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" ip="192.168.2.45"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="4">
-    <action_set>
-      <crm_event id="12" operation="clear_failcount" operation_key="PRIM_Web_IP1_clear_failcount" on_node="sles11-ha3" on_node_uuid="sles11-ha3">
-        <primitive id="PRIM_Web_IP1" long-id="GRP_Web_Server:PRIM_Web_IP1" class="ocf" provider="heartbeat" type="IPaddr"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" ip="192.168.2.45"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="5">
-    <action_set>
-      <rsc_op id="28" operation="start" operation_key="PRIM_Web_IP1_start_0" on_node="sles11-ha2" on_node_uuid="sles11-ha2">
+      <rsc_op id="25" operation="start" operation_key="PRIM_Web_IP1_start_0" on_node="sles11-ha2" on_node_uuid="sles11-ha2">
         <primitive id="PRIM_Web_IP1" long-id="GRP_Web_Server:PRIM_Web_IP1" class="ocf" provider="heartbeat" type="IPaddr"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2" ip="192.168.2.45"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="30" operation="start" operation_key="GRP_Web_Server_start_0"/>
+        <pseudo_event id="27" operation="start" operation_key="GRP_Web_Server_start_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="6">
+  <synapse id="3">
     <action_set>
-      <rsc_op id="29" operation="monitor" operation_key="PRIM_Web_IP1_monitor_5000" on_node="sles11-ha2" on_node_uuid="sles11-ha2">
+      <rsc_op id="26" operation="monitor" operation_key="PRIM_Web_IP1_monitor_5000" on_node="sles11-ha2" on_node_uuid="sles11-ha2">
         <primitive id="PRIM_Web_IP1" long-id="GRP_Web_Server:PRIM_Web_IP1" class="ocf" provider="heartbeat" type="IPaddr"/>
         <attributes CRM_meta_interval="5000" CRM_meta_name="monitor" CRM_meta_on_fail="restart" CRM_meta_start_delay="1000" CRM_meta_timeout="6000" crm_feature_set="3.0.2" ip="192.168.2.45"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="28" operation="start" operation_key="PRIM_Web_IP1_start_0" on_node="sles11-ha2" on_node_uuid="sles11-ha2"/>
+        <rsc_op id="25" operation="start" operation_key="PRIM_Web_IP1_start_0" on_node="sles11-ha2" on_node_uuid="sles11-ha2"/>
       </trigger>
     </inputs>
   </synapse>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-1820-1.dot
--- a/pengine/test10/bug-1820-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-1820-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -23,6 +23,8 @@ digraph "g" {
 "probe_complete world" -> "probe_complete" [ style = bold]
 "probe_complete world" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "p1_start_0 world" [ style = bold]
+"probe_complete" -> "test1_stop_0 star" [ style = bold]
+"probe_complete" -> "test2_stop_0 star" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "test1_monitor_10000 world" [ style=bold color="green" fontcolor="black"  ]
 "test1_start_0 world" -> "gr1_running_0" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-1820-1.exp
--- a/pengine/test10/bug-1820-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-1820-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -69,7 +69,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs/>
+    <inputs/>
    </synapse>
    <synapse id="6">
      <action_set>
@@ -98,6 +98,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="13" operation="stop" operation_key="test2_stop_0" on_node="star" on_node_uuid="3f368213-61d5-409a-a30e-1428efe70f63"/>
        </trigger>
        <trigger>
@@ -143,6 +146,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <pseudo_event id="18" operation="stop" operation_key="gr1_stop_0"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2106.dot
--- a/pengine/test10/bug-lf-2106.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-lf-2106.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,27 +1,5 @@
 digraph "g" {
 "all_stopped" [ style=bold color="green" fontcolor="orange"  ]
-"apcstonith_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"apcstonith_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"bugtrack_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"bugtrack_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"drbd-bugtrack:0_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"drbd-bugtrack:1_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"drbd-infotos:0_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"drbd-infotos:1_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"drbd-itwiki:0_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"drbd-itwiki:1_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"drbd-medomus-cvs:0_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"drbd-medomus-cvs:1_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"drbd-servsyslog:0_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"drbd-servsyslog:1_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"drbd-smsprod2:0_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"drbd-smsprod2:1_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"infotos_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"infotos_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"itwiki_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"itwiki_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"medomus-cvs_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"medomus-cvs_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
 "pingd:0_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
 "pingd:0_monitor_30000 cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
 "pingd:0_start_0 cl-virt-1" -> "pingd:0_monitor_30000 cl-virt-1" [ style = bold]
@@ -52,14 +30,4 @@ digraph "g" {
 "pingdclone_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "pingdclone_stopped_0" -> "pingdclone_start_0" [ style = bold]
 "pingdclone_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
-"servsyslog_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"servsyslog_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"smsprod2_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"smsprod2_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"ssh-bin_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"ssh-bin_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"ssh-ip1_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"ssh-ip1_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
-"ssh-ip2_clear_failcount cl-virt-1" [ style=bold color="green" fontcolor="black"  ]
-"ssh-ip2_clear_failcount cl-virt-2" [ style=bold color="green" fontcolor="black"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2106.exp
--- a/pengine/test10/bug-lf-2106.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-lf-2106.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1,465 +1,177 @@
 <transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
   <synapse id="0">
     <action_set>
-      <crm_event id="1" operation="clear_failcount" operation_key="apcstonith_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="apcstonith" long-id="apcstonith" class="stonith" type="apcmastersnmp"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" community="private" crm_feature_set="3.0.2" ipaddr="10.2.50.154" port="161"/>
+      <crm_event id="2" operation="clear_failcount" operation_key="pingd:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
+        <primitive id="pingd:0" long-id="pingdclone:pingd:0" class="ocf" provider="pacemaker" type="pingd"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" dampen="10" host_list="10.2.50.103 10.2.50.11 10.2.50.40 10.2.50.8" interval="5"/>
       </crm_event>
     </action_set>
     <inputs/>
   </synapse>
   <synapse id="1">
     <action_set>
-      <crm_event id="26" operation="clear_failcount" operation_key="apcstonith_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="apcstonith" long-id="apcstonith" class="stonith" type="apcmastersnmp"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" community="private" crm_feature_set="3.0.2" ipaddr="10.2.50.154" port="161"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="2">
-    <action_set>
-      <crm_event id="3" operation="clear_failcount" operation_key="pingd:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="pingd:0" long-id="pingdclone:pingd:0" class="ocf" provider="pacemaker" type="pingd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" dampen="10" host_list="10.2.50.103 10.2.50.11 10.2.50.40 10.2.50.8" interval="5"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="3">
-    <action_set>
-      <rsc_op id="4" operation="monitor" operation_key="pingd:0_monitor_30000" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
+      <rsc_op id="3" operation="monitor" operation_key="pingd:0_monitor_30000" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
         <primitive id="pingd:0" long-id="pingdclone:pingd:0" class="ocf" provider="pacemaker" type="pingd"/>
         <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_interval="30000" CRM_meta_name="monitor" CRM_meta_notify="false" CRM_meta_timeout="30000" crm_feature_set="3.0.2" dampen="10" host_list="10.2.50.103 10.2.50.11 10.2.50.40 10.2.50.8" interval="5"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="57" operation="start" operation_key="pingd:0_start_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
+        <rsc_op id="25" operation="start" operation_key="pingd:0_start_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="4">
+  <synapse id="2">
     <action_set>
-      <rsc_op id="57" operation="start" operation_key="pingd:0_start_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
+      <rsc_op id="25" operation="start" operation_key="pingd:0_start_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
         <primitive id="pingd:0" long-id="pingdclone:pingd:0" class="ocf" provider="pacemaker" type="pingd"/>
         <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" dampen="10" host_list="10.2.50.103 10.2.50.11 10.2.50.40 10.2.50.8" interval="5"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="64" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
+        <rsc_op id="32" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
       </trigger>
       <trigger>
-        <pseudo_event id="66" operation="start" operation_key="pingdclone_start_0"/>
+        <pseudo_event id="34" operation="start" operation_key="pingdclone_start_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="5">
+  <synapse id="3">
     <action_set>
-      <rsc_op id="64" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
+      <rsc_op id="32" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
         <primitive id="pingd:0" long-id="pingdclone:pingd:0" class="ocf" provider="pacemaker" type="pingd"/>
         <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="68" operation="stop" operation_key="pingdclone_stop_0"/>
+        <pseudo_event id="36" operation="stop" operation_key="pingdclone_stop_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="6">
+  <synapse id="4">
     <action_set>
-      <crm_event id="27" operation="clear_failcount" operation_key="pingd:0_clear_failcount_0" internal_operation_key="pingd:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
+      <crm_event id="10" operation="clear_failcount" operation_key="pingd:0_clear_failcount_0" internal_operation_key="pingd:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
         <primitive id="pingd:0" long-id="pingd:1" class="ocf" provider="pacemaker" type="pingd"/>
         <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" dampen="10" host_list="10.2.50.103 10.2.50.11 10.2.50.40 10.2.50.8" interval="5"/>
       </crm_event>
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="7">
+  <synapse id="5">
     <action_set>
-      <rsc_op id="28" operation="monitor" operation_key="pingd:0_monitor_30000" internal_operation_key="pingd:1_monitor_30000" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
+      <rsc_op id="11" operation="monitor" operation_key="pingd:0_monitor_30000" internal_operation_key="pingd:1_monitor_30000" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
         <primitive id="pingd:0" long-id="pingd:1" class="ocf" provider="pacemaker" type="pingd"/>
         <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_interval="30000" CRM_meta_name="monitor" CRM_meta_notify="false" CRM_meta_timeout="30000" crm_feature_set="3.0.2" dampen="10" host_list="10.2.50.103 10.2.50.11 10.2.50.40 10.2.50.8" interval="5"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="58" operation="start" operation_key="pingd:0_start_0" internal_operation_key="pingd:1_start_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
+        <rsc_op id="26" operation="start" operation_key="pingd:0_start_0" internal_operation_key="pingd:1_start_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="8">
+  <synapse id="6">
     <action_set>
-      <rsc_op id="58" operation="start" operation_key="pingd:0_start_0" internal_operation_key="pingd:1_start_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
+      <rsc_op id="26" operation="start" operation_key="pingd:0_start_0" internal_operation_key="pingd:1_start_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
         <primitive id="pingd:0" long-id="pingd:1" class="ocf" provider="pacemaker" type="pingd"/>
         <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" dampen="10" host_list="10.2.50.103 10.2.50.11 10.2.50.40 10.2.50.8" interval="5"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="65" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
+        <rsc_op id="33" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
       </trigger>
       <trigger>
-        <pseudo_event id="66" operation="start" operation_key="pingdclone_start_0"/>
+        <pseudo_event id="34" operation="start" operation_key="pingdclone_start_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="9">
+  <synapse id="7">
     <action_set>
-      <rsc_op id="65" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
+      <rsc_op id="33" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
         <primitive id="pingd:0" long-id="pingd:1" class="ocf" provider="pacemaker" type="pingd"/>
         <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="68" operation="stop" operation_key="pingdclone_stop_0"/>
+        <pseudo_event id="36" operation="stop" operation_key="pingdclone_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8">
+    <action_set>
+      <pseudo_event id="34" operation="start" operation_key="pingdclone_start_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="36" operation="stop" operation_key="pingdclone_stop_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="37" operation="stopped" operation_key="pingdclone_stopped_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="9" priority="1000000">
+    <action_set>
+      <pseudo_event id="35" operation="running" operation_key="pingdclone_running_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="25" operation="start" operation_key="pingd:0_start_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="26" operation="start" operation_key="pingd:0_start_0" internal_operation_key="pingd:1_start_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="34" operation="start" operation_key="pingdclone_start_0"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="10">
     <action_set>
-      <pseudo_event id="66" operation="start" operation_key="pingdclone_start_0">
+      <pseudo_event id="36" operation="stop" operation_key="pingdclone_stop_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="11" priority="1000000">
+    <action_set>
+      <pseudo_event id="37" operation="stopped" operation_key="pingdclone_stopped_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="68" operation="stop" operation_key="pingdclone_stop_0"/>
+        <rsc_op id="32" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
       </trigger>
       <trigger>
-        <pseudo_event id="69" operation="stopped" operation_key="pingdclone_stopped_0"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="11" priority="1000000">
-    <action_set>
-      <pseudo_event id="67" operation="running" operation_key="pingdclone_running_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <rsc_op id="57" operation="start" operation_key="pingd:0_start_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
+        <rsc_op id="33" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
       </trigger>
       <trigger>
-        <rsc_op id="58" operation="start" operation_key="pingd:0_start_0" internal_operation_key="pingd:1_start_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="66" operation="start" operation_key="pingdclone_start_0"/>
+        <pseudo_event id="36" operation="stop" operation_key="pingdclone_stop_0"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="12">
     <action_set>
-      <pseudo_event id="68" operation="stop" operation_key="pingdclone_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="13" priority="1000000">
-    <action_set>
-      <pseudo_event id="69" operation="stopped" operation_key="pingdclone_stopped_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <rsc_op id="64" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="65" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="68" operation="stop" operation_key="pingdclone_stop_0"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="14">
-    <action_set>
-      <crm_event id="5" operation="clear_failcount" operation_key="ssh-ip1_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="ssh-ip1" long-id="ssh:ssh-ip1" class="ocf" provider="heartbeat" type="IPaddr2"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" broadcast="10.2.50.255" cidr_netmask="24" crm_feature_set="3.0.2" ip="10.2.50.83" nic="br1"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="15">
-    <action_set>
-      <crm_event id="29" operation="clear_failcount" operation_key="ssh-ip1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="ssh-ip1" long-id="ssh:ssh-ip1" class="ocf" provider="heartbeat" type="IPaddr2"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" broadcast="10.2.50.255" cidr_netmask="24" crm_feature_set="3.0.2" ip="10.2.50.83" nic="br1"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="16">
-    <action_set>
-      <crm_event id="6" operation="clear_failcount" operation_key="ssh-ip2_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="ssh-ip2" long-id="ssh:ssh-ip2" class="ocf" provider="heartbeat" type="IPaddr2"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" broadcast="10.2.50.255" cidr_netmask="24" crm_feature_set="3.0.2" ip="10.2.50.82" nic="br1"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="17">
-    <action_set>
-      <crm_event id="30" operation="clear_failcount" operation_key="ssh-ip2_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="ssh-ip2" long-id="ssh:ssh-ip2" class="ocf" provider="heartbeat" type="IPaddr2"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" broadcast="10.2.50.255" cidr_netmask="24" crm_feature_set="3.0.2" ip="10.2.50.82" nic="br1"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="18">
-    <action_set>
-      <crm_event id="13" operation="clear_failcount" operation_key="ssh-bin_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="ssh-bin" long-id="ssh:ssh-bin" class="ocf" provider="dk" type="opensshd"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" port="42222" ssh="/usr/local/openssh-5.2/bin/ssh" sshd="/usr/local/openssh-5.2/sbin/sshd" sshd_config="/usr/local/openssh-5.2/etc/sshd_config"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="19">
-    <action_set>
-      <crm_event id="39" operation="clear_failcount" operation_key="ssh-bin_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="ssh-bin" long-id="ssh:ssh-bin" class="ocf" provider="dk" type="opensshd"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" port="42222" ssh="/usr/local/openssh-5.2/bin/ssh" sshd="/usr/local/openssh-5.2/sbin/sshd" sshd_config="/usr/local/openssh-5.2/etc/sshd_config"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="20">
-    <action_set>
-      <crm_event id="19" operation="clear_failcount" operation_key="itwiki_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="itwiki" long-id="itwiki" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/itwiki.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="21">
-    <action_set>
-      <crm_event id="40" operation="clear_failcount" operation_key="itwiki_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="itwiki" long-id="itwiki" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/itwiki.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="22">
-    <action_set>
-      <crm_event id="14" operation="clear_failcount" operation_key="drbd-itwiki:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="drbd-itwiki:0" long-id="ms-itwiki:drbd-itwiki:0" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="itwiki"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="23">
-    <action_set>
-      <crm_event id="46" operation="clear_failcount" operation_key="drbd-itwiki:0_clear_failcount_0" internal_operation_key="drbd-itwiki:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="drbd-itwiki:0" long-id="drbd-itwiki:1" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="itwiki"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="24">
-    <action_set>
-      <crm_event id="18" operation="clear_failcount" operation_key="bugtrack_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="bugtrack" long-id="bugtrack" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/bugtrack.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="25">
-    <action_set>
-      <crm_event id="31" operation="clear_failcount" operation_key="bugtrack_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="bugtrack" long-id="bugtrack" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/bugtrack.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="26">
-    <action_set>
-      <crm_event id="7" operation="clear_failcount" operation_key="drbd-bugtrack:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="drbd-bugtrack:0" long-id="ms-bugtrack:drbd-bugtrack:0" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="bugtrack"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="27">
-    <action_set>
-      <crm_event id="35" operation="clear_failcount" operation_key="drbd-bugtrack:0_clear_failcount_0" internal_operation_key="drbd-bugtrack:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="drbd-bugtrack:0" long-id="drbd-bugtrack:1" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="bugtrack"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="28">
-    <action_set>
-      <crm_event id="11" operation="clear_failcount" operation_key="servsyslog_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="servsyslog" long-id="servsyslog" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/servsyslog.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="29">
-    <action_set>
-      <crm_event id="33" operation="clear_failcount" operation_key="servsyslog_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="servsyslog" long-id="servsyslog" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/servsyslog.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="30">
-    <action_set>
-      <crm_event id="9" operation="clear_failcount" operation_key="drbd-servsyslog:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="drbd-servsyslog:0" long-id="ms-servsyslog:drbd-servsyslog:0" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="servsyslog"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="31">
-    <action_set>
-      <crm_event id="37" operation="clear_failcount" operation_key="drbd-servsyslog:0_clear_failcount_0" internal_operation_key="drbd-servsyslog:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="drbd-servsyslog:0" long-id="drbd-servsyslog:1" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="servsyslog"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="32">
-    <action_set>
-      <crm_event id="12" operation="clear_failcount" operation_key="smsprod2_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="smsprod2" long-id="smsprod2" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/smsprod2.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="33">
-    <action_set>
-      <crm_event id="42" operation="clear_failcount" operation_key="smsprod2_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="smsprod2" long-id="smsprod2" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/smsprod2.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="34">
-    <action_set>
-      <crm_event id="16" operation="clear_failcount" operation_key="drbd-smsprod2:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="drbd-smsprod2:0" long-id="ms-smsprod2:drbd-smsprod2:0" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="smsprod2"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="35">
-    <action_set>
-      <crm_event id="48" operation="clear_failcount" operation_key="drbd-smsprod2:0_clear_failcount_0" internal_operation_key="drbd-smsprod2:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="drbd-smsprod2:0" long-id="drbd-smsprod2:1" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="smsprod2"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="36">
-    <action_set>
-      <crm_event id="21" operation="clear_failcount" operation_key="medomus-cvs_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="medomus-cvs" long-id="medomus-cvs" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/medomus-cvs.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="37">
-    <action_set>
-      <crm_event id="44" operation="clear_failcount" operation_key="medomus-cvs_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="medomus-cvs" long-id="medomus-cvs" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/medomus-cvs.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="38">
-    <action_set>
-      <crm_event id="22" operation="clear_failcount" operation_key="drbd-medomus-cvs:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="drbd-medomus-cvs:0" long-id="ms-medomus-cvs:drbd-medomus-cvs:0" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="medomus-cvs"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="39">
-    <action_set>
-      <crm_event id="50" operation="clear_failcount" operation_key="drbd-medomus-cvs:0_clear_failcount_0" internal_operation_key="drbd-medomus-cvs:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="drbd-medomus-cvs:0" long-id="drbd-medomus-cvs:1" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="medomus-cvs"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="40">
-    <action_set>
-      <crm_event id="20" operation="clear_failcount" operation_key="infotos_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="infotos" long-id="infotos" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/infotos.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="41">
-    <action_set>
-      <crm_event id="52" operation="clear_failcount" operation_key="infotos_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="infotos" long-id="infotos" class="ocf" provider="heartbeat" type="VirtualDomain"/>
-        <attributes CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" config="/etc/libvirt/qemu/infotos.xml" crm_feature_set="3.0.2" hypervisor="qemu:///system"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="42">
-    <action_set>
-      <crm_event id="24" operation="clear_failcount" operation_key="drbd-infotos:0_clear_failcount" on_node="cl-virt-1" on_node_uuid="cl-virt-1">
-        <primitive id="drbd-infotos:0" long-id="ms-infotos:drbd-infotos:0" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="infotos"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="43">
-    <action_set>
-      <crm_event id="54" operation="clear_failcount" operation_key="drbd-infotos:0_clear_failcount_0" internal_operation_key="drbd-infotos:1_clear_failcount" on_node="cl-virt-2" on_node_uuid="cl-virt-2">
-        <primitive id="drbd-infotos:0" long-id="drbd-infotos:1" class="ocf" provider="heartbeat" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="infotos"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="44">
-    <action_set>
-      <pseudo_event id="56" operation="all_stopped" operation_key="all_stopped">
+      <pseudo_event id="24" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="64" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
+        <rsc_op id="32" operation="stop" operation_key="pingd:0_stop_0" on_node="cl-virt-1" on_node_uuid="cl-virt-1"/>
       </trigger>
       <trigger>
-        <rsc_op id="65" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
+        <rsc_op id="33" operation="stop" operation_key="pingd:0_stop_0" internal_operation_key="pingd:1_stop_0" on_node="cl-virt-2" on_node_uuid="cl-virt-2"/>
       </trigger>
     </inputs>
   </synapse>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2317.exp
--- a/pengine/test10/bug-lf-2317.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-lf-2317.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -44,7 +44,7 @@
     <action_set>
       <rsc_op id="53" operation="notify" operation_key="drbd_r0:0_pre_notify_promote_0" on_node="ibm1.isg.si" on_node_uuid="4b2047c8-f3a0-4935-84a2-967b548598c9">
         <primitive id="drbd_r0:0" long-id="ms_drbd_r0:drbd_r0:0" class="ocf" provider="linbit" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="r0"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_name="notify" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="pre" CRM_meta_timeout="90000" crm_feature_set="3.0.2" drbd_resource="r0"/>
       </rsc_op>
     </action_set>
     <inputs>
@@ -57,7 +57,7 @@
     <action_set>
       <rsc_op id="54" operation="notify" operation_key="drbd_r0:0_post_notify_promote_0" on_node="ibm1.isg.si" on_node_uuid="4b2047c8-f3a0-4935-84a2-967b548598c9">
         <primitive id="drbd_r0:0" long-id="ms_drbd_r0:drbd_r0:0" class="ocf" provider="linbit" type="drbd"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="post" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="r0"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_name="notify" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="post" CRM_meta_timeout="90000" crm_feature_set="3.0.2" drbd_resource="r0"/>
       </rsc_op>
     </action_set>
     <inputs>
@@ -70,7 +70,7 @@
     <action_set>
       <rsc_op id="55" operation="notify" operation_key="drbd_r0:1_pre_notify_promote_0" on_node="ibm2.isg.si" on_node_uuid="3d430f49-b915-4d52-a32b-b0799fa17ae7">
         <primitive id="drbd_r0:1" long-id="ms_drbd_r0:drbd_r0:1" class="ocf" provider="linbit" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="r0"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_name="notify" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="pre" CRM_meta_timeout="90000" crm_feature_set="3.0.2" drbd_resource="r0"/>
       </rsc_op>
     </action_set>
     <inputs>
@@ -83,7 +83,7 @@
     <action_set>
       <rsc_op id="56" operation="notify" operation_key="drbd_r0:1_post_notify_promote_0" on_node="ibm2.isg.si" on_node_uuid="3d430f49-b915-4d52-a32b-b0799fa17ae7">
         <primitive id="drbd_r0:1" long-id="ms_drbd_r0:drbd_r0:1" class="ocf" provider="linbit" type="drbd"/>
-        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="post" CRM_meta_timeout="20000" crm_feature_set="3.0.2" drbd_resource="r0"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_name="notify" CRM_meta_notify="true" CRM_meta_notify_active_resource=" " CRM_meta_notify_active_uname=" " CRM_meta_notify_demote_resource=" " CRM_meta_notify_demote_uname=" " CRM_meta_notify_inactive_resource=" " CRM_meta_notify_master_resource="drbd_r0:1 " CRM_meta_notify_master_uname="ibm2.isg.si " CRM_meta_notify_operation="promote" CRM_meta_notify_promote_resource="drbd_r0:0 " CRM_meta_notify_promote_uname="ibm1.isg.si " CRM_meta_notify_slave_resource="drbd_r0:0 " CRM_meta_notify_slave_uname="ibm1.isg.si " CRM_meta_notify_start_resource=" " CRM_meta_notify_start_uname=" " CRM_meta_notify_stop_resource=" " CRM_meta_notify_stop_uname=" " CRM_meta_notify_type="post" CRM_meta_timeout="90000" crm_feature_set="3.0.2" drbd_resource="r0"/>
       </rsc_op>
     </action_set>
     <inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2422.dot
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2422.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,93 @@
+digraph "g" {
+"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
+"c-o2stage_stop_0" -> "c-o2stage_stopped_0" [ style = bold]
+"c-o2stage_stop_0" -> "o2stage:0_stop_0" [ style = bold]
+"c-o2stage_stop_0" -> "o2stage:1_stop_0" [ style = bold]
+"c-o2stage_stop_0" -> "o2stage:2_stop_0" [ style = bold]
+"c-o2stage_stop_0" -> "o2stage:3_stop_0" [ style = bold]
+"c-o2stage_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"c-o2stage_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"c-ocfs_stop_0" -> "c-ocfs_stopped_0" [ style = bold]
+"c-ocfs_stop_0" -> "ocfs:0_stop_0 qa-suse-4" [ style = bold]
+"c-ocfs_stop_0" -> "ocfs:1_stop_0 qa-suse-1" [ style = bold]
+"c-ocfs_stop_0" -> "ocfs:2_stop_0 qa-suse-3" [ style = bold]
+"c-ocfs_stop_0" -> "ocfs:3_stop_0 qa-suse-2" [ style = bold]
+"c-ocfs_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"c-ocfs_stopped_0" -> "c-o2stage_stop_0" [ style = bold]
+"c-ocfs_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"cmirror:0_stop_0 qa-suse-4" -> "all_stopped" [ style = bold]
+"cmirror:0_stop_0 qa-suse-4" -> "o2cb:0_stop_0 qa-suse-4" [ style = bold]
+"cmirror:0_stop_0 qa-suse-4" -> "o2stage:0_stopped_0" [ style = bold]
+"cmirror:0_stop_0 qa-suse-4" [ style=bold color="green" fontcolor="black"  ]
+"cmirror:1_stop_0 qa-suse-1" -> "all_stopped" [ style = bold]
+"cmirror:1_stop_0 qa-suse-1" -> "o2cb:1_stop_0 qa-suse-1" [ style = bold]
+"cmirror:1_stop_0 qa-suse-1" -> "o2stage:1_stopped_0" [ style = bold]
+"cmirror:1_stop_0 qa-suse-1" [ style=bold color="green" fontcolor="black"  ]
+"cmirror:2_stop_0 qa-suse-3" -> "all_stopped" [ style = bold]
+"cmirror:2_stop_0 qa-suse-3" -> "o2cb:2_stop_0 qa-suse-3" [ style = bold]
+"cmirror:2_stop_0 qa-suse-3" -> "o2stage:2_stopped_0" [ style = bold]
+"cmirror:2_stop_0 qa-suse-3" [ style=bold color="green" fontcolor="black"  ]
+"cmirror:3_stop_0 qa-suse-2" -> "all_stopped" [ style = bold]
+"cmirror:3_stop_0 qa-suse-2" -> "o2cb:3_stop_0 qa-suse-2" [ style = bold]
+"cmirror:3_stop_0 qa-suse-2" -> "o2stage:3_stopped_0" [ style = bold]
+"cmirror:3_stop_0 qa-suse-2" [ style=bold color="green" fontcolor="black"  ]
+"o2cb:0_stop_0 qa-suse-4" -> "all_stopped" [ style = bold]
+"o2cb:0_stop_0 qa-suse-4" -> "o2stage:0_stopped_0" [ style = bold]
+"o2cb:0_stop_0 qa-suse-4" [ style=bold color="green" fontcolor="black"  ]
+"o2cb:1_stop_0 qa-suse-1" -> "all_stopped" [ style = bold]
+"o2cb:1_stop_0 qa-suse-1" -> "o2stage:1_stopped_0" [ style = bold]
+"o2cb:1_stop_0 qa-suse-1" [ style=bold color="green" fontcolor="black"  ]
+"o2cb:2_stop_0 qa-suse-3" -> "all_stopped" [ style = bold]
+"o2cb:2_stop_0 qa-suse-3" -> "o2stage:2_stopped_0" [ style = bold]
+"o2cb:2_stop_0 qa-suse-3" [ style=bold color="green" fontcolor="black"  ]
+"o2cb:3_stop_0 qa-suse-2" -> "all_stopped" [ style = bold]
+"o2cb:3_stop_0 qa-suse-2" -> "o2stage:3_stopped_0" [ style = bold]
+"o2cb:3_stop_0 qa-suse-2" [ style=bold color="green" fontcolor="black"  ]
+"o2stage:0_stop_0" -> "cmirror:0_stop_0 qa-suse-4" [ style = bold]
+"o2stage:0_stop_0" -> "o2cb:0_stop_0 qa-suse-4" [ style = bold]
+"o2stage:0_stop_0" -> "o2stage:0_stopped_0" [ style = bold]
+"o2stage:0_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"o2stage:0_stopped_0" -> "c-o2stage_stopped_0" [ style = bold]
+"o2stage:0_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"o2stage:1_stop_0" -> "cmirror:1_stop_0 qa-suse-1" [ style = bold]
+"o2stage:1_stop_0" -> "o2cb:1_stop_0 qa-suse-1" [ style = bold]
+"o2stage:1_stop_0" -> "o2stage:1_stopped_0" [ style = bold]
+"o2stage:1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"o2stage:1_stopped_0" -> "c-o2stage_stopped_0" [ style = bold]
+"o2stage:1_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"o2stage:2_stop_0" -> "cmirror:2_stop_0 qa-suse-3" [ style = bold]
+"o2stage:2_stop_0" -> "o2cb:2_stop_0 qa-suse-3" [ style = bold]
+"o2stage:2_stop_0" -> "o2stage:2_stopped_0" [ style = bold]
+"o2stage:2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"o2stage:2_stopped_0" -> "c-o2stage_stopped_0" [ style = bold]
+"o2stage:2_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"o2stage:3_stop_0" -> "cmirror:3_stop_0 qa-suse-2" [ style = bold]
+"o2stage:3_stop_0" -> "o2cb:3_stop_0 qa-suse-2" [ style = bold]
+"o2stage:3_stop_0" -> "o2stage:3_stopped_0" [ style = bold]
+"o2stage:3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"o2stage:3_stopped_0" -> "c-o2stage_stopped_0" [ style = bold]
+"o2stage:3_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"ocfs:0_stop_0 qa-suse-4" -> "all_stopped" [ style = bold]
+"ocfs:0_stop_0 qa-suse-4" -> "c-ocfs_stopped_0" [ style = bold]
+"ocfs:0_stop_0 qa-suse-4" -> "cmirror:0_stop_0 qa-suse-4" [ style = bold]
+"ocfs:0_stop_0 qa-suse-4" -> "o2stage:0_stop_0" [ style = bold]
+"ocfs:0_stop_0 qa-suse-4" [ style=bold color="green" fontcolor="black"  ]
+"ocfs:1_stop_0 qa-suse-1" -> "all_stopped" [ style = bold]
+"ocfs:1_stop_0 qa-suse-1" -> "c-ocfs_stopped_0" [ style = bold]
+"ocfs:1_stop_0 qa-suse-1" -> "cmirror:1_stop_0 qa-suse-1" [ style = bold]
+"ocfs:1_stop_0 qa-suse-1" -> "o2stage:1_stop_0" [ style = bold]
+"ocfs:1_stop_0 qa-suse-1" -> "ocfs:0_stop_0 qa-suse-4" [ style = bold]
+"ocfs:1_stop_0 qa-suse-1" [ style=bold color="green" fontcolor="black"  ]
+"ocfs:2_stop_0 qa-suse-3" -> "all_stopped" [ style = bold]
+"ocfs:2_stop_0 qa-suse-3" -> "c-ocfs_stopped_0" [ style = bold]
+"ocfs:2_stop_0 qa-suse-3" -> "cmirror:2_stop_0 qa-suse-3" [ style = bold]
+"ocfs:2_stop_0 qa-suse-3" -> "o2stage:2_stop_0" [ style = bold]
+"ocfs:2_stop_0 qa-suse-3" -> "ocfs:1_stop_0 qa-suse-1" [ style = bold]
+"ocfs:2_stop_0 qa-suse-3" [ style=bold color="green" fontcolor="black"  ]
+"ocfs:3_stop_0 qa-suse-2" -> "all_stopped" [ style = bold]
+"ocfs:3_stop_0 qa-suse-2" -> "c-ocfs_stopped_0" [ style = bold]
+"ocfs:3_stop_0 qa-suse-2" -> "cmirror:3_stop_0 qa-suse-2" [ style = bold]
+"ocfs:3_stop_0 qa-suse-2" -> "o2stage:3_stop_0" [ style = bold]
+"ocfs:3_stop_0 qa-suse-2" -> "ocfs:2_stop_0 qa-suse-3" [ style = bold]
+"ocfs:3_stop_0 qa-suse-2" [ style=bold color="green" fontcolor="black"  ]
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2422.exp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2422.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,437 @@
+<transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
+  <synapse id="0">
+    <action_set>
+      <pseudo_event id="22" operation="stop" operation_key="o2stage:0_stop_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="56" operation="stop" operation_key="c-o2stage_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="58" operation="stop" operation_key="ocfs:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="1">
+    <action_set>
+      <pseudo_event id="23" operation="stopped" operation_key="o2stage:0_stopped_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="18" operation="stop" operation_key="o2cb:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="19" operation="stop" operation_key="cmirror:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="22" operation="stop" operation_key="o2stage:0_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="2">
+    <action_set>
+      <rsc_op id="18" operation="stop" operation_key="o2cb:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4">
+        <primitive id="o2cb:0" long-id="c-o2stage:o2stage:0:o2cb:0" class="ocf" provider="ocfs2" type="o2cb"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="19" operation="stop" operation_key="cmirror:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="22" operation="stop" operation_key="o2stage:0_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="3">
+    <action_set>
+      <rsc_op id="19" operation="stop" operation_key="cmirror:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4">
+        <primitive id="cmirror:0" long-id="c-o2stage:o2stage:0:cmirror:0" class="ocf" provider="lvm2" type="cmirrord"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="22" operation="stop" operation_key="o2stage:0_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="58" operation="stop" operation_key="ocfs:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="4">
+    <action_set>
+      <pseudo_event id="32" operation="stop" operation_key="o2stage:1_stop_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="56" operation="stop" operation_key="c-o2stage_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="59" operation="stop" operation_key="ocfs:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="5">
+    <action_set>
+      <pseudo_event id="33" operation="stopped" operation_key="o2stage:1_stopped_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="28" operation="stop" operation_key="o2cb:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="29" operation="stop" operation_key="cmirror:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="32" operation="stop" operation_key="o2stage:1_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="6">
+    <action_set>
+      <rsc_op id="28" operation="stop" operation_key="o2cb:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1">
+        <primitive id="o2cb:1" long-id="c-o2stage:o2stage:1:o2cb:1" class="ocf" provider="ocfs2" type="o2cb"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="29" operation="stop" operation_key="cmirror:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="32" operation="stop" operation_key="o2stage:1_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="7">
+    <action_set>
+      <rsc_op id="29" operation="stop" operation_key="cmirror:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1">
+        <primitive id="cmirror:1" long-id="c-o2stage:o2stage:1:cmirror:1" class="ocf" provider="lvm2" type="cmirrord"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="32" operation="stop" operation_key="o2stage:1_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="59" operation="stop" operation_key="ocfs:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8">
+    <action_set>
+      <pseudo_event id="42" operation="stop" operation_key="o2stage:2_stop_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="56" operation="stop" operation_key="c-o2stage_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="60" operation="stop" operation_key="ocfs:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="9">
+    <action_set>
+      <pseudo_event id="43" operation="stopped" operation_key="o2stage:2_stopped_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="38" operation="stop" operation_key="o2cb:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="39" operation="stop" operation_key="cmirror:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="42" operation="stop" operation_key="o2stage:2_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="10">
+    <action_set>
+      <rsc_op id="38" operation="stop" operation_key="o2cb:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3">
+        <primitive id="o2cb:2" long-id="c-o2stage:o2stage:2:o2cb:2" class="ocf" provider="ocfs2" type="o2cb"/>
+        <attributes CRM_meta_clone="2" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="39" operation="stop" operation_key="cmirror:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="42" operation="stop" operation_key="o2stage:2_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="11">
+    <action_set>
+      <rsc_op id="39" operation="stop" operation_key="cmirror:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3">
+        <primitive id="cmirror:2" long-id="c-o2stage:o2stage:2:cmirror:2" class="ocf" provider="lvm2" type="cmirrord"/>
+        <attributes CRM_meta_clone="2" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="42" operation="stop" operation_key="o2stage:2_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="60" operation="stop" operation_key="ocfs:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="12">
+    <action_set>
+      <pseudo_event id="52" operation="stop" operation_key="o2stage:3_stop_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="56" operation="stop" operation_key="c-o2stage_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="61" operation="stop" operation_key="ocfs:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="13">
+    <action_set>
+      <pseudo_event id="53" operation="stopped" operation_key="o2stage:3_stopped_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="48" operation="stop" operation_key="o2cb:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="49" operation="stop" operation_key="cmirror:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="52" operation="stop" operation_key="o2stage:3_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="14">
+    <action_set>
+      <rsc_op id="48" operation="stop" operation_key="o2cb:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2">
+        <primitive id="o2cb:3" long-id="c-o2stage:o2stage:3:o2cb:3" class="ocf" provider="ocfs2" type="o2cb"/>
+        <attributes CRM_meta_clone="3" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="49" operation="stop" operation_key="cmirror:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="52" operation="stop" operation_key="o2stage:3_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="15">
+    <action_set>
+      <rsc_op id="49" operation="stop" operation_key="cmirror:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2">
+        <primitive id="cmirror:3" long-id="c-o2stage:o2stage:3:cmirror:3" class="ocf" provider="lvm2" type="cmirrord"/>
+        <attributes CRM_meta_clone="3" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="52" operation="stop" operation_key="o2stage:3_stop_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="61" operation="stop" operation_key="ocfs:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="16">
+    <action_set>
+      <pseudo_event id="56" operation="stop" operation_key="c-o2stage_stop_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="65" operation="stopped" operation_key="c-ocfs_stopped_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="17" priority="1000000">
+    <action_set>
+      <pseudo_event id="57" operation="stopped" operation_key="c-o2stage_stopped_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="23" operation="stopped" operation_key="o2stage:0_stopped_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="33" operation="stopped" operation_key="o2stage:1_stopped_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="43" operation="stopped" operation_key="o2stage:2_stopped_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="53" operation="stopped" operation_key="o2stage:3_stopped_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="56" operation="stop" operation_key="c-o2stage_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="18">
+    <action_set>
+      <rsc_op id="58" operation="stop" operation_key="ocfs:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4">
+        <primitive id="ocfs:0" long-id="c-ocfs:ocfs:0" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="59" operation="stop" operation_key="ocfs:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="64" operation="stop" operation_key="c-ocfs_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="19">
+    <action_set>
+      <rsc_op id="59" operation="stop" operation_key="ocfs:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1">
+        <primitive id="ocfs:1" long-id="c-ocfs:ocfs:1" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="60" operation="stop" operation_key="ocfs:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="64" operation="stop" operation_key="c-ocfs_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="20">
+    <action_set>
+      <rsc_op id="60" operation="stop" operation_key="ocfs:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3">
+        <primitive id="ocfs:2" long-id="c-ocfs:ocfs:2" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="2" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="61" operation="stop" operation_key="ocfs:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="64" operation="stop" operation_key="c-ocfs_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="21">
+    <action_set>
+      <rsc_op id="61" operation="stop" operation_key="ocfs:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2">
+        <primitive id="ocfs:3" long-id="c-ocfs:ocfs:3" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="3" CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="64" operation="stop" operation_key="c-ocfs_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="22">
+    <action_set>
+      <pseudo_event id="64" operation="stop" operation_key="c-ocfs_stop_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="23" priority="1000000">
+    <action_set>
+      <pseudo_event id="65" operation="stopped" operation_key="c-ocfs_stopped_0">
+        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="60000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="58" operation="stop" operation_key="ocfs:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="59" operation="stop" operation_key="ocfs:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="60" operation="stop" operation_key="ocfs:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="61" operation="stop" operation_key="ocfs:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="64" operation="stop" operation_key="c-ocfs_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="24">
+    <action_set>
+      <pseudo_event id="6" operation="all_stopped" operation_key="all_stopped">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="18" operation="stop" operation_key="o2cb:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="19" operation="stop" operation_key="cmirror:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="28" operation="stop" operation_key="o2cb:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="29" operation="stop" operation_key="cmirror:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="38" operation="stop" operation_key="o2cb:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="39" operation="stop" operation_key="cmirror:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="48" operation="stop" operation_key="o2cb:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="49" operation="stop" operation_key="cmirror:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="58" operation="stop" operation_key="ocfs:0_stop_0" on_node="qa-suse-4" on_node_uuid="qa-suse-4"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="59" operation="stop" operation_key="ocfs:1_stop_0" on_node="qa-suse-1" on_node_uuid="qa-suse-1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="60" operation="stop" operation_key="ocfs:2_stop_0" on_node="qa-suse-3" on_node_uuid="qa-suse-3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="61" operation="stop" operation_key="ocfs:3_stop_0" on_node="qa-suse-2" on_node_uuid="qa-suse-2"/>
+      </trigger>
+    </inputs>
+  </synapse>
+</transition_graph>
+
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2422.scores
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2422.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,269 @@
+Allocation scores:
+native_color: sbd_stonith allocation score on qa-suse-2: 0
+native_color: sbd_stonith allocation score on qa-suse-3: 0
+native_color: sbd_stonith allocation score on qa-suse-4: 0
+native_color: sbd_stonith allocation score on qa-suse-1: 0
+clone_color: c-o2stage allocation score on qa-suse-2: 0
+clone_color: c-o2stage allocation score on qa-suse-3: 0
+clone_color: c-o2stage allocation score on qa-suse-4: 0
+clone_color: c-o2stage allocation score on qa-suse-1: 0
+clone_color: o2stage:0 allocation score on qa-suse-2: 0
+clone_color: o2stage:0 allocation score on qa-suse-3: 0
+clone_color: o2stage:0 allocation score on qa-suse-4: 0
+clone_color: o2stage:0 allocation score on qa-suse-1: 0
+clone_color: dlm:0 allocation score on qa-suse-2: 0
+clone_color: dlm:0 allocation score on qa-suse-3: 0
+clone_color: dlm:0 allocation score on qa-suse-4: 1
+clone_color: dlm:0 allocation score on qa-suse-1: 0
+clone_color: clvm:0 allocation score on qa-suse-2: 0
+clone_color: clvm:0 allocation score on qa-suse-3: 0
+clone_color: clvm:0 allocation score on qa-suse-4: 1
+clone_color: clvm:0 allocation score on qa-suse-1: 0
+clone_color: o2cb:0 allocation score on qa-suse-2: 0
+clone_color: o2cb:0 allocation score on qa-suse-3: 0
+clone_color: o2cb:0 allocation score on qa-suse-4: 1
+clone_color: o2cb:0 allocation score on qa-suse-1: 0
+clone_color: cmirror:0 allocation score on qa-suse-2: 0
+clone_color: cmirror:0 allocation score on qa-suse-3: 0
+clone_color: cmirror:0 allocation score on qa-suse-4: 1
+clone_color: cmirror:0 allocation score on qa-suse-1: 0
+clone_color: o2stage:1 allocation score on qa-suse-2: 0
+clone_color: o2stage:1 allocation score on qa-suse-3: 0
+clone_color: o2stage:1 allocation score on qa-suse-4: 0
+clone_color: o2stage:1 allocation score on qa-suse-1: 0
+clone_color: dlm:1 allocation score on qa-suse-2: 0
+clone_color: dlm:1 allocation score on qa-suse-3: 0
+clone_color: dlm:1 allocation score on qa-suse-4: 0
+clone_color: dlm:1 allocation score on qa-suse-1: 1
+clone_color: clvm:1 allocation score on qa-suse-2: 0
+clone_color: clvm:1 allocation score on qa-suse-3: 0
+clone_color: clvm:1 allocation score on qa-suse-4: 0
+clone_color: clvm:1 allocation score on qa-suse-1: 1
+clone_color: o2cb:1 allocation score on qa-suse-2: 0
+clone_color: o2cb:1 allocation score on qa-suse-3: 0
+clone_color: o2cb:1 allocation score on qa-suse-4: 0
+clone_color: o2cb:1 allocation score on qa-suse-1: 1
+clone_color: cmirror:1 allocation score on qa-suse-2: 0
+clone_color: cmirror:1 allocation score on qa-suse-3: 0
+clone_color: cmirror:1 allocation score on qa-suse-4: 0
+clone_color: cmirror:1 allocation score on qa-suse-1: 1
+clone_color: o2stage:2 allocation score on qa-suse-2: 0
+clone_color: o2stage:2 allocation score on qa-suse-3: 0
+clone_color: o2stage:2 allocation score on qa-suse-4: 0
+clone_color: o2stage:2 allocation score on qa-suse-1: 0
+clone_color: dlm:2 allocation score on qa-suse-2: 0
+clone_color: dlm:2 allocation score on qa-suse-3: 1
+clone_color: dlm:2 allocation score on qa-suse-4: 0
+clone_color: dlm:2 allocation score on qa-suse-1: 0
+clone_color: clvm:2 allocation score on qa-suse-2: 0
+clone_color: clvm:2 allocation score on qa-suse-3: 1
+clone_color: clvm:2 allocation score on qa-suse-4: 0
+clone_color: clvm:2 allocation score on qa-suse-1: 0
+clone_color: o2cb:2 allocation score on qa-suse-2: 0
+clone_color: o2cb:2 allocation score on qa-suse-3: 1
+clone_color: o2cb:2 allocation score on qa-suse-4: 0
+clone_color: o2cb:2 allocation score on qa-suse-1: 0
+clone_color: cmirror:2 allocation score on qa-suse-2: 0
+clone_color: cmirror:2 allocation score on qa-suse-3: 1
+clone_color: cmirror:2 allocation score on qa-suse-4: 0
+clone_color: cmirror:2 allocation score on qa-suse-1: 0
+clone_color: o2stage:3 allocation score on qa-suse-2: 0
+clone_color: o2stage:3 allocation score on qa-suse-3: 0
+clone_color: o2stage:3 allocation score on qa-suse-4: 0
+clone_color: o2stage:3 allocation score on qa-suse-1: 0
+clone_color: dlm:3 allocation score on qa-suse-2: 1
+clone_color: dlm:3 allocation score on qa-suse-3: 0
+clone_color: dlm:3 allocation score on qa-suse-4: 0
+clone_color: dlm:3 allocation score on qa-suse-1: 0
+clone_color: clvm:3 allocation score on qa-suse-2: 1
+clone_color: clvm:3 allocation score on qa-suse-3: 0
+clone_color: clvm:3 allocation score on qa-suse-4: 0
+clone_color: clvm:3 allocation score on qa-suse-1: 0
+clone_color: o2cb:3 allocation score on qa-suse-2: 1
+clone_color: o2cb:3 allocation score on qa-suse-3: 0
+clone_color: o2cb:3 allocation score on qa-suse-4: 0
+clone_color: o2cb:3 allocation score on qa-suse-1: 0
+clone_color: cmirror:3 allocation score on qa-suse-2: 1
+clone_color: cmirror:3 allocation score on qa-suse-3: 0
+clone_color: cmirror:3 allocation score on qa-suse-4: 0
+clone_color: cmirror:3 allocation score on qa-suse-1: 0
+group_color: o2stage:0 allocation score on qa-suse-2: 0
+group_color: o2stage:0 allocation score on qa-suse-3: 0
+group_color: o2stage:0 allocation score on qa-suse-4: 0
+group_color: o2stage:0 allocation score on qa-suse-1: 0
+group_color: dlm:0 allocation score on qa-suse-2: 0
+group_color: dlm:0 allocation score on qa-suse-3: 0
+group_color: dlm:0 allocation score on qa-suse-4: 1
+group_color: dlm:0 allocation score on qa-suse-1: 0
+group_color: clvm:0 allocation score on qa-suse-2: 0
+group_color: clvm:0 allocation score on qa-suse-3: 0
+group_color: clvm:0 allocation score on qa-suse-4: 1
+group_color: clvm:0 allocation score on qa-suse-1: 0
+group_color: o2cb:0 allocation score on qa-suse-2: 0
+group_color: o2cb:0 allocation score on qa-suse-3: 0
+group_color: o2cb:0 allocation score on qa-suse-4: 1
+group_color: o2cb:0 allocation score on qa-suse-1: 0
+group_color: cmirror:0 allocation score on qa-suse-2: 0
+group_color: cmirror:0 allocation score on qa-suse-3: 0
+group_color: cmirror:0 allocation score on qa-suse-4: 1
+group_color: cmirror:0 allocation score on qa-suse-1: 0
+native_color: dlm:0 allocation score on qa-suse-2: 0
+native_color: dlm:0 allocation score on qa-suse-3: 0
+native_color: dlm:0 allocation score on qa-suse-4: 4
+native_color: dlm:0 allocation score on qa-suse-1: 0
+native_color: clvm:0 allocation score on qa-suse-2: -INFINITY
+native_color: clvm:0 allocation score on qa-suse-3: -INFINITY
+native_color: clvm:0 allocation score on qa-suse-4: 3
+native_color: clvm:0 allocation score on qa-suse-1: -INFINITY
+native_color: o2cb:0 allocation score on qa-suse-2: -INFINITY
+native_color: o2cb:0 allocation score on qa-suse-3: -INFINITY
+native_color: o2cb:0 allocation score on qa-suse-4: -INFINITY
+native_color: o2cb:0 allocation score on qa-suse-1: -INFINITY
+native_color: cmirror:0 allocation score on qa-suse-2: -INFINITY
+native_color: cmirror:0 allocation score on qa-suse-3: -INFINITY
+native_color: cmirror:0 allocation score on qa-suse-4: -INFINITY
+native_color: cmirror:0 allocation score on qa-suse-1: -INFINITY
+group_color: o2stage:1 allocation score on qa-suse-2: 0
+group_color: o2stage:1 allocation score on qa-suse-3: 0
+group_color: o2stage:1 allocation score on qa-suse-4: -INFINITY
+group_color: o2stage:1 allocation score on qa-suse-1: 0
+group_color: dlm:1 allocation score on qa-suse-2: 0
+group_color: dlm:1 allocation score on qa-suse-3: 0
+group_color: dlm:1 allocation score on qa-suse-4: -INFINITY
+group_color: dlm:1 allocation score on qa-suse-1: 1
+group_color: clvm:1 allocation score on qa-suse-2: 0
+group_color: clvm:1 allocation score on qa-suse-3: 0
+group_color: clvm:1 allocation score on qa-suse-4: -INFINITY
+group_color: clvm:1 allocation score on qa-suse-1: 1
+group_color: o2cb:1 allocation score on qa-suse-2: 0
+group_color: o2cb:1 allocation score on qa-suse-3: 0
+group_color: o2cb:1 allocation score on qa-suse-4: -INFINITY
+group_color: o2cb:1 allocation score on qa-suse-1: 1
+group_color: cmirror:1 allocation score on qa-suse-2: 0
+group_color: cmirror:1 allocation score on qa-suse-3: 0
+group_color: cmirror:1 allocation score on qa-suse-4: -INFINITY
+group_color: cmirror:1 allocation score on qa-suse-1: 1
+native_color: dlm:1 allocation score on qa-suse-2: 0
+native_color: dlm:1 allocation score on qa-suse-3: 0
+native_color: dlm:1 allocation score on qa-suse-4: -INFINITY
+native_color: dlm:1 allocation score on qa-suse-1: 4
+native_color: clvm:1 allocation score on qa-suse-2: -INFINITY
+native_color: clvm:1 allocation score on qa-suse-3: -INFINITY
+native_color: clvm:1 allocation score on qa-suse-4: -INFINITY
+native_color: clvm:1 allocation score on qa-suse-1: 3
+native_color: o2cb:1 allocation score on qa-suse-2: -INFINITY
+native_color: o2cb:1 allocation score on qa-suse-3: -INFINITY
+native_color: o2cb:1 allocation score on qa-suse-4: -INFINITY
+native_color: o2cb:1 allocation score on qa-suse-1: -INFINITY
+native_color: cmirror:1 allocation score on qa-suse-2: -INFINITY
+native_color: cmirror:1 allocation score on qa-suse-3: -INFINITY
+native_color: cmirror:1 allocation score on qa-suse-4: -INFINITY
+native_color: cmirror:1 allocation score on qa-suse-1: -INFINITY
+group_color: o2stage:2 allocation score on qa-suse-2: 0
+group_color: o2stage:2 allocation score on qa-suse-3: 0
+group_color: o2stage:2 allocation score on qa-suse-4: -INFINITY
+group_color: o2stage:2 allocation score on qa-suse-1: -INFINITY
+group_color: dlm:2 allocation score on qa-suse-2: 0
+group_color: dlm:2 allocation score on qa-suse-3: 1
+group_color: dlm:2 allocation score on qa-suse-4: -INFINITY
+group_color: dlm:2 allocation score on qa-suse-1: -INFINITY
+group_color: clvm:2 allocation score on qa-suse-2: 0
+group_color: clvm:2 allocation score on qa-suse-3: 1
+group_color: clvm:2 allocation score on qa-suse-4: -INFINITY
+group_color: clvm:2 allocation score on qa-suse-1: -INFINITY
+group_color: o2cb:2 allocation score on qa-suse-2: 0
+group_color: o2cb:2 allocation score on qa-suse-3: 1
+group_color: o2cb:2 allocation score on qa-suse-4: -INFINITY
+group_color: o2cb:2 allocation score on qa-suse-1: -INFINITY
+group_color: cmirror:2 allocation score on qa-suse-2: 0
+group_color: cmirror:2 allocation score on qa-suse-3: 1
+group_color: cmirror:2 allocation score on qa-suse-4: -INFINITY
+group_color: cmirror:2 allocation score on qa-suse-1: -INFINITY
+native_color: dlm:2 allocation score on qa-suse-2: 0
+native_color: dlm:2 allocation score on qa-suse-3: 4
+native_color: dlm:2 allocation score on qa-suse-4: -INFINITY
+native_color: dlm:2 allocation score on qa-suse-1: -INFINITY
+native_color: clvm:2 allocation score on qa-suse-2: -INFINITY
+native_color: clvm:2 allocation score on qa-suse-3: 3
+native_color: clvm:2 allocation score on qa-suse-4: -INFINITY
+native_color: clvm:2 allocation score on qa-suse-1: -INFINITY
+native_color: o2cb:2 allocation score on qa-suse-2: -INFINITY
+native_color: o2cb:2 allocation score on qa-suse-3: -INFINITY
+native_color: o2cb:2 allocation score on qa-suse-4: -INFINITY
+native_color: o2cb:2 allocation score on qa-suse-1: -INFINITY
+native_color: cmirror:2 allocation score on qa-suse-2: -INFINITY
+native_color: cmirror:2 allocation score on qa-suse-3: -INFINITY
+native_color: cmirror:2 allocation score on qa-suse-4: -INFINITY
+native_color: cmirror:2 allocation score on qa-suse-1: -INFINITY
+group_color: o2stage:3 allocation score on qa-suse-2: 0
+group_color: o2stage:3 allocation score on qa-suse-3: -INFINITY
+group_color: o2stage:3 allocation score on qa-suse-4: -INFINITY
+group_color: o2stage:3 allocation score on qa-suse-1: -INFINITY
+group_color: dlm:3 allocation score on qa-suse-2: 1
+group_color: dlm:3 allocation score on qa-suse-3: -INFINITY
+group_color: dlm:3 allocation score on qa-suse-4: -INFINITY
+group_color: dlm:3 allocation score on qa-suse-1: -INFINITY
+group_color: clvm:3 allocation score on qa-suse-2: 1
+group_color: clvm:3 allocation score on qa-suse-3: -INFINITY
+group_color: clvm:3 allocation score on qa-suse-4: -INFINITY
+group_color: clvm:3 allocation score on qa-suse-1: -INFINITY
+group_color: o2cb:3 allocation score on qa-suse-2: 1
+group_color: o2cb:3 allocation score on qa-suse-3: -INFINITY
+group_color: o2cb:3 allocation score on qa-suse-4: -INFINITY
+group_color: o2cb:3 allocation score on qa-suse-1: -INFINITY
+group_color: cmirror:3 allocation score on qa-suse-2: 1
+group_color: cmirror:3 allocation score on qa-suse-3: -INFINITY
+group_color: cmirror:3 allocation score on qa-suse-4: -INFINITY
+group_color: cmirror:3 allocation score on qa-suse-1: -INFINITY
+native_color: dlm:3 allocation score on qa-suse-2: 4
+native_color: dlm:3 allocation score on qa-suse-3: -INFINITY
+native_color: dlm:3 allocation score on qa-suse-4: -INFINITY
+native_color: dlm:3 allocation score on qa-suse-1: -INFINITY
+native_color: clvm:3 allocation score on qa-suse-2: 3
+native_color: clvm:3 allocation score on qa-suse-3: -INFINITY
+native_color: clvm:3 allocation score on qa-suse-4: -INFINITY
+native_color: clvm:3 allocation score on qa-suse-1: -INFINITY
+native_color: o2cb:3 allocation score on qa-suse-2: -INFINITY
+native_color: o2cb:3 allocation score on qa-suse-3: -INFINITY
+native_color: o2cb:3 allocation score on qa-suse-4: -INFINITY
+native_color: o2cb:3 allocation score on qa-suse-1: -INFINITY
+native_color: cmirror:3 allocation score on qa-suse-2: -INFINITY
+native_color: cmirror:3 allocation score on qa-suse-3: -INFINITY
+native_color: cmirror:3 allocation score on qa-suse-4: -INFINITY
+native_color: cmirror:3 allocation score on qa-suse-1: -INFINITY
+clone_color: c-ocfs allocation score on qa-suse-2: 0
+clone_color: c-ocfs allocation score on qa-suse-3: 0
+clone_color: c-ocfs allocation score on qa-suse-4: 0
+clone_color: c-ocfs allocation score on qa-suse-1: 0
+clone_color: ocfs:0 allocation score on qa-suse-2: 0
+clone_color: ocfs:0 allocation score on qa-suse-3: 0
+clone_color: ocfs:0 allocation score on qa-suse-4: 1
+clone_color: ocfs:0 allocation score on qa-suse-1: 0
+clone_color: ocfs:1 allocation score on qa-suse-2: 0
+clone_color: ocfs:1 allocation score on qa-suse-3: 0
+clone_color: ocfs:1 allocation score on qa-suse-4: 0
+clone_color: ocfs:1 allocation score on qa-suse-1: 1
+clone_color: ocfs:2 allocation score on qa-suse-2: 0
+clone_color: ocfs:2 allocation score on qa-suse-3: 1
+clone_color: ocfs:2 allocation score on qa-suse-4: 0
+clone_color: ocfs:2 allocation score on qa-suse-1: 0
+clone_color: ocfs:3 allocation score on qa-suse-2: 1
+clone_color: ocfs:3 allocation score on qa-suse-3: 0
+clone_color: ocfs:3 allocation score on qa-suse-4: 0
+clone_color: ocfs:3 allocation score on qa-suse-1: 0
+native_color: ocfs:0 allocation score on qa-suse-2: -INFINITY
+native_color: ocfs:0 allocation score on qa-suse-3: -INFINITY
+native_color: ocfs:0 allocation score on qa-suse-4: -INFINITY
+native_color: ocfs:0 allocation score on qa-suse-1: -INFINITY
+native_color: ocfs:1 allocation score on qa-suse-2: -INFINITY
+native_color: ocfs:1 allocation score on qa-suse-3: -INFINITY
+native_color: ocfs:1 allocation score on qa-suse-4: -INFINITY
+native_color: ocfs:1 allocation score on qa-suse-1: -INFINITY
+native_color: ocfs:2 allocation score on qa-suse-2: -INFINITY
+native_color: ocfs:2 allocation score on qa-suse-3: -INFINITY
+native_color: ocfs:2 allocation score on qa-suse-4: -INFINITY
+native_color: ocfs:2 allocation score on qa-suse-1: -INFINITY
+native_color: ocfs:3 allocation score on qa-suse-2: -INFINITY
+native_color: ocfs:3 allocation score on qa-suse-3: -INFINITY
+native_color: ocfs:3 allocation score on qa-suse-4: -INFINITY
+native_color: ocfs:3 allocation score on qa-suse-1: -INFINITY
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2422.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2422.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,220 @@
+<cib validate-with="pacemaker-1.2" crm_feature_set="3.0.2" have-quorum="1" admin_epoch="0" epoch="56" num_updates="1" cib-last-written="Wed May 19 13:42:42 2010" dc-uuid="qa-suse-3">
+  <configuration>
+    <crm_config>
+      <cluster_property_set id="cib-bootstrap-options">
+        <nvpair id="cib-bootstrap-options-dc-version" name="dc-version" value="1.1.2-2e096a41a5f9e184a1c1537c82c6da1093698eb5"/>
+        <nvpair id="cib-bootstrap-options-cluster-infrastructure" name="cluster-infrastructure" value="openais"/>
+        <nvpair id="cib-bootstrap-options-expected-quorum-votes" name="expected-quorum-votes" value="4"/>
+        <nvpair id="cib-bootstrap-options-last-lrm-refresh" name="last-lrm-refresh" value="1274268501"/>
+      </cluster_property_set>
+    </crm_config>
+    <nodes>
+      <node id="qa-suse-2" type="normal" uname="qa-suse-2"/>
+      <node id="qa-suse-3" type="normal" uname="qa-suse-3"/>
+      <node id="qa-suse-4" type="normal" uname="qa-suse-4"/>
+      <node id="qa-suse-1" type="normal" uname="qa-suse-1"/>
+    </nodes>
+    <resources>
+      <primitive class="stonith" id="sbd_stonith" type="external/sbd">
+        <meta_attributes id="sbd_stonith-meta_attributes">
+          <nvpair id="sbd_stonith-meta_attributes-target-role" name="target-role" value="Started"/>
+        </meta_attributes>
+        <operations>
+          <op id="sbd_stonith-monitor-15" interval="15" name="monitor" start-delay="15" timeout="15"/>
+        </operations>
+        <instance_attributes id="sbd_stonith-instance_attributes">
+          <nvpair id="sbd_stonith-instance_attributes-sbd_device" name="sbd_device" value="/dev/sda1"/>
+        </instance_attributes>
+      </primitive>
+      <clone id="c-o2stage">
+        <meta_attributes id="c-o2stage-meta_attributes">
+          <nvpair id="c-o2stage-meta_attributes-interleave" name="interleave" value="true"/>
+        </meta_attributes>
+        <group id="o2stage">
+          <primitive class="ocf" id="dlm" provider="pacemaker" type="controld"/>
+          <primitive class="ocf" id="clvm" provider="lvm2" type="clvmd"/>
+          <primitive class="ocf" id="o2cb" provider="ocfs2" type="o2cb">
+            <meta_attributes id="o2cb-meta_attributes">
+              <nvpair id="o2cb-meta_attributes-target-role" name="target-role" value="Stopped"/>
+            </meta_attributes>
+          </primitive>
+          <primitive class="ocf" id="cmirror" provider="lvm2" type="cmirrord"/>
+        </group>
+      </clone>
+      <clone id="c-ocfs">
+        <meta_attributes id="c-ocfs-meta_attributes">
+          <nvpair id="c-ocfs-meta_attributes-interleave" name="interleave" value="true"/>
+          <nvpair id="c-ocfs-meta_attributes-ordered" name="ordered" value="true"/>
+          <nvpair id="c-ocfs-meta_attributes-target-role" name="target-role" value="Started"/>
+        </meta_attributes>
+        <primitive class="ocf" id="ocfs" provider="heartbeat" type="Filesystem">
+          <instance_attributes id="ocfs-instance_attributes">
+            <nvpair id="ocfs-instance_attributes-directory" name="directory" value="/ocfs2"/>
+            <nvpair id="ocfs-instance_attributes-fstype" name="fstype" value="ocfs2"/>
+            <nvpair id="ocfs-instance_attributes-device" name="device" value="/dev/sdb1"/>
+          </instance_attributes>
+          <operations>
+            <op id="ocfs-monitor-20" interval="20" name="monitor" timeout="40"/>
+          </operations>
+        </primitive>
+      </clone>
+    </resources>
+    <constraints>
+      <rsc_colocation id="colo-ocfs-o2stage" rsc="c-ocfs" score="INFINITY" with-rsc="c-o2stage"/>
+      <rsc_order first="c-o2stage" id="order-ocfs-o2stage" score="INFINITY" then="c-ocfs"/>
+    </constraints>
+    <op_defaults>
+      <meta_attributes id="op-options">
+        <nvpair id="op-options-timeout" name="timeout" value="60s"/>
+      </meta_attributes>
+    </op_defaults>
+    <rsc_defaults/>
+  </configuration>
+  <status>
+    <node_state id="qa-suse-1" uname="qa-suse-1" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="do_state_transition" shutdown="0">
+      <transient_attributes id="qa-suse-1">
+        <instance_attributes id="status-qa-suse-1">
+          <nvpair id="status-qa-suse-1-probe_complete" name="probe_complete" value="true"/>
+        </instance_attributes>
+      </transient_attributes>
+      <lrm id="qa-suse-1">
+        <lrm_resources>
+          <lrm_resource id="sbd_stonith" type="external/sbd" class="stonith">
+            <lrm_rsc_op id="sbd_stonith_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="18:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;18:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="2" rc-code="7" op-status="0" interval="0" last-run="1274268688" last-rc-change="1274268688" exec-time="60" queue-time="0" op-digest="9fa747955de71bdb7463aadceed8756a"/>
+          </lrm_resource>
+          <lrm_resource id="ocfs:1" type="Filesystem" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="ocfs:1_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="23:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;23:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="7" rc-code="7" op-status="0" interval="0" last-run="1274268689" last-rc-change="1274268689" exec-time="230" queue-time="1000" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:1_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="49:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;49:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="12" rc-code="0" op-status="0" interval="0" last-run="1274268716" last-rc-change="1274268716" exec-time="37480" queue-time="0" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:1_monitor_20000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="50:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;50:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="13" rc-code="0" op-status="0" interval="20000" last-run="1274268814" last-rc-change="1274268754" exec-time="160" queue-time="0" op-digest="925820149485b43468de022b9943e65c"/>
+          </lrm_resource>
+          <lrm_resource id="cmirror:1" type="cmirrord" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="cmirror:1_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="22:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;22:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="6" rc-code="7" op-status="0" interval="0" last-run="1274268689" last-rc-change="1274268689" exec-time="90" queue-time="1000" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="cmirror:1_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="24:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;24:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="11" rc-code="0" op-status="0" interval="0" last-run="1274268714" last-rc-change="1274268714" exec-time="40" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="clvm:1" type="clvmd" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="clvm:1_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="20:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;20:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="4" rc-code="7" op-status="0" interval="0" last-run="1274268688" last-rc-change="1274268688" exec-time="220" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="clvm:1_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="15:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;15:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="9" rc-code="0" op-status="0" interval="0" last-run="1274268706" last-rc-change="1274268706" exec-time="5170" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dlm:1" type="controld" class="ocf" provider="pacemaker">
+            <lrm_rsc_op id="dlm:1_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="19:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;19:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="3" rc-code="7" op-status="0" interval="0" last-run="1274268688" last-rc-change="1274268688" exec-time="190" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="dlm:1_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="14:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;14:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="8" rc-code="0" op-status="0" interval="0" last-run="1274268704" last-rc-change="1274268704" exec-time="1230" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="o2cb:1" type="o2cb" class="ocf" provider="ocfs2">
+            <lrm_rsc_op id="o2cb:1_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="21:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;21:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="5" rc-code="7" op-status="0" interval="0" last-run="1274268688" last-rc-change="1274268688" exec-time="300" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="o2cb:1_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="23:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;23:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="10" rc-code="0" op-status="0" interval="0" last-run="1274268712" last-rc-change="1274268712" exec-time="2290" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="qa-suse-4" uname="qa-suse-4" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="do_state_transition" shutdown="0">
+      <transient_attributes id="qa-suse-4">
+        <instance_attributes id="status-qa-suse-4">
+          <nvpair id="status-qa-suse-4-probe_complete" name="probe_complete" value="true"/>
+        </instance_attributes>
+      </transient_attributes>
+      <lrm id="qa-suse-4">
+        <lrm_resources>
+          <lrm_resource id="sbd_stonith" type="external/sbd" class="stonith">
+            <lrm_rsc_op id="sbd_stonith_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="11:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;11:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="2" rc-code="7" op-status="0" interval="0" last-run="1274268727" last-rc-change="1274268727" exec-time="130" queue-time="0" op-digest="9fa747955de71bdb7463aadceed8756a"/>
+          </lrm_resource>
+          <lrm_resource id="cmirror:0" type="cmirrord" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="cmirror:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="15:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;15:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="6" rc-code="7" op-status="0" interval="0" last-run="1274268729" last-rc-change="1274268729" exec-time="290" queue-time="1000" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="cmirror:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="14:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;14:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="11" rc-code="0" op-status="0" interval="0" last-run="1274268754" last-rc-change="1274268754" exec-time="80" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="clvm:0" type="clvmd" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="clvm:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="13:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;13:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="4" rc-code="7" op-status="0" interval="0" last-run="1274268728" last-rc-change="1274268728" exec-time="470" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="clvm:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="9:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;9:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="9" rc-code="0" op-status="0" interval="0" last-run="1274268746" last-rc-change="1274268746" exec-time="5540" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dlm:0" type="controld" class="ocf" provider="pacemaker">
+            <lrm_rsc_op id="dlm:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="12:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;12:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="3" rc-code="7" op-status="0" interval="0" last-run="1274268728" last-rc-change="1274268728" exec-time="590" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="dlm:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="8:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;8:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="8" rc-code="0" op-status="0" interval="0" last-run="1274268744" last-rc-change="1274268744" exec-time="1490" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="o2cb:0" type="o2cb" class="ocf" provider="ocfs2">
+            <lrm_rsc_op id="o2cb:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="14:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;14:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="5" rc-code="7" op-status="0" interval="0" last-run="1274268728" last-rc-change="1274268728" exec-time="540" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="o2cb:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="13:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;13:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="10" rc-code="0" op-status="0" interval="0" last-run="1274268752" last-rc-change="1274268752" exec-time="2720" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="ocfs:0" type="Filesystem" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="ocfs:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="16:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;16:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="7" rc-code="7" op-status="0" interval="0" last-run="1274268729" last-rc-change="1274268729" exec-time="900" queue-time="1010" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="47:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;47:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="12" rc-code="0" op-status="0" interval="0" last-run="1274268754" last-rc-change="1274268754" exec-time="1240" queue-time="0" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:0_monitor_20000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="48:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;48:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="13" rc-code="0" op-status="0" interval="20000" last-run="1274268858" last-rc-change="1274268756" exec-time="220" queue-time="0" op-digest="925820149485b43468de022b9943e65c"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="qa-suse-3" uname="qa-suse-3" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="do_update_resource" shutdown="0">
+      <transient_attributes id="qa-suse-3">
+        <instance_attributes id="status-qa-suse-3">
+          <nvpair id="status-qa-suse-3-probe_complete" name="probe_complete" value="true"/>
+        </instance_attributes>
+      </transient_attributes>
+      <lrm id="qa-suse-3">
+        <lrm_resources>
+          <lrm_resource id="sbd_stonith" type="external/sbd" class="stonith">
+            <lrm_rsc_op id="sbd_stonith_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="4:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;4:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="2" rc-code="7" op-status="0" interval="0" last-run="1274268660" last-rc-change="1274268660" exec-time="130" queue-time="0" op-digest="9fa747955de71bdb7463aadceed8756a"/>
+            <lrm_rsc_op id="sbd_stonith_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="6:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;6:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="8" rc-code="0" op-status="0" interval="0" last-run="1274268662" last-rc-change="1274268662" exec-time="10" queue-time="0" op-digest="9fa747955de71bdb7463aadceed8756a"/>
+            <lrm_rsc_op id="sbd_stonith_monitor_15000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="7:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;7:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="9" rc-code="0" op-status="0" interval="15000" last-run="1274268778" last-rc-change="1274268678" exec-time="1320" queue-time="0" op-digest="e755ae48928de0d5f7a0371bebb9db84"/>
+            <lrm_rsc_op id="sbd_stonith_stop_0" operation="stop" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="17:5:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;17:5:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="16" rc-code="0" op-status="0" interval="0" last-run="1274268793" last-rc-change="1274268793" exec-time="10" queue-time="0" op-digest="9fa747955de71bdb7463aadceed8756a"/>
+          </lrm_resource>
+          <lrm_resource id="ocfs:2" type="Filesystem" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="ocfs:2_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="9:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;9:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="7" rc-code="7" op-status="0" interval="0" last-run="1274268661" last-rc-change="1274268661" exec-time="140" queue-time="1000" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:2_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="51:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;51:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="14" rc-code="0" op-status="0" interval="0" last-run="1274268726" last-rc-change="1274268726" exec-time="790" queue-time="0" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:2_monitor_20000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="52:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;52:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="15" rc-code="0" op-status="0" interval="20000" last-run="1274268786" last-rc-change="1274268726" exec-time="100" queue-time="0" op-digest="925820149485b43468de022b9943e65c"/>
+          </lrm_resource>
+          <lrm_resource id="o2cb:2" type="o2cb" class="ocf" provider="ocfs2">
+            <lrm_rsc_op id="o2cb:2_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="7:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;7:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="5" rc-code="7" op-status="0" interval="0" last-run="1274268660" last-rc-change="1274268660" exec-time="250" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="o2cb:2_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="33:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;33:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="12" rc-code="0" op-status="0" interval="0" last-run="1274268683" last-rc-change="1274268683" exec-time="2270" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="cmirror:2" type="cmirrord" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="cmirror:2_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="8:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;8:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="6" rc-code="7" op-status="0" interval="0" last-run="1274268661" last-rc-change="1274268661" exec-time="40" queue-time="1000" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="cmirror:2_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="34:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;34:4:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="13" rc-code="0" op-status="0" interval="0" last-run="1274268685" last-rc-change="1274268685" exec-time="30" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="clvm:2" type="clvmd" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="clvm:2_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="6:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;6:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="4" rc-code="7" op-status="0" interval="0" last-run="1274268660" last-rc-change="1274268660" exec-time="230" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="clvm:2_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="21:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;21:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="11" rc-code="0" op-status="0" interval="0" last-run="1274268677" last-rc-change="1274268677" exec-time="5170" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dlm:2" type="controld" class="ocf" provider="pacemaker">
+            <lrm_rsc_op id="dlm:2_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="5:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;5:1:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="3" rc-code="7" op-status="0" interval="0" last-run="1274268660" last-rc-change="1274268660" exec-time="270" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="dlm:2_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.2" transition-key="20:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;20:3:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="10" rc-code="0" op-status="0" interval="0" last-run="1274268676" last-rc-change="1274268676" exec-time="1220" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="qa-suse-2" uname="qa-suse-2" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="do_update_resource" shutdown="0">
+      <lrm id="qa-suse-2">
+        <lrm_resources>
+          <lrm_resource id="sbd_stonith" type="external/sbd" class="stonith">
+            <lrm_rsc_op id="sbd_stonith_monitor_0" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="8:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;8:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="2" rc-code="7" op-status="0" interval="0" last-run="1274268858" last-rc-change="1274268858" exec-time="130" queue-time="0" op-digest="9fa747955de71bdb7463aadceed8756a"/>
+            <lrm_rsc_op id="sbd_stonith_start_0" operation="start" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="18:5:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;18:5:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="8" rc-code="0" op-status="0" interval="0" last-run="1274268860" last-rc-change="1274268860" exec-time="30" queue-time="0" op-digest="9fa747955de71bdb7463aadceed8756a"/>
+            <lrm_rsc_op id="sbd_stonith_monitor_15000" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="12:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;12:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="10" rc-code="0" op-status="0" interval="15000" last-run="1274268878" last-rc-change="1274268878" exec-time="1580" queue-time="0" op-digest="e755ae48928de0d5f7a0371bebb9db84"/>
+          </lrm_resource>
+          <lrm_resource id="clvm:3" type="clvmd" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="clvm:3_monitor_0" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="10:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;10:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="4" rc-code="7" op-status="0" interval="0" last-run="1274268858" last-rc-change="1274268858" exec-time="440" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="clvm:3_start_0" operation="start" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="51:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;51:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="11" rc-code="0" op-status="0" interval="0" last-run="1274268863" last-rc-change="1274268863" exec-time="5980" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="o2cb:3" type="o2cb" class="ocf" provider="ocfs2">
+            <lrm_rsc_op id="o2cb:3_monitor_0" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="11:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;11:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="5" rc-code="7" op-status="0" interval="0" last-run="1274268858" last-rc-change="1274268858" exec-time="590" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="o2cb:3_start_0" operation="start" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="52:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;52:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="12" rc-code="0" op-status="0" interval="0" last-run="1274268869" last-rc-change="1274268869" exec-time="3770" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dlm:3" type="controld" class="ocf" provider="pacemaker">
+            <lrm_rsc_op id="dlm:3_monitor_0" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="9:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;9:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="3" rc-code="7" op-status="0" interval="0" last-run="1274268858" last-rc-change="1274268858" exec-time="630" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="dlm:3_start_0" operation="start" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="56:5:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;56:5:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="9" rc-code="0" op-status="0" interval="0" last-run="1274268860" last-rc-change="1274268860" exec-time="2130" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="cmirror:3" type="cmirrord" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="cmirror:3_monitor_0" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="12:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;12:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="6" rc-code="7" op-status="0" interval="0" last-run="1274268859" last-rc-change="1274268859" exec-time="210" queue-time="1000" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="cmirror:3_start_0" operation="start" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="53:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;53:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="13" rc-code="0" op-status="0" interval="0" last-run="1274268873" last-rc-change="1274268873" exec-time="350" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="ocfs:3" type="Filesystem" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="ocfs:3_monitor_0" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="13:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:7;13:5:7:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="7" rc-code="7" op-status="0" interval="0" last-run="1274268859" last-rc-change="1274268859" exec-time="1230" queue-time="1000" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:3_start_0" operation="start" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="68:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;68:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="14" rc-code="0" op-status="0" interval="0" last-run="1274268874" last-rc-change="1274268874" exec-time="1890" queue-time="0" op-digest="705cd8f91667568b1512ccbe8f34ac98"/>
+            <lrm_rsc_op id="ocfs:3_monitor_20000" operation="monitor" crm-debug-origin="do_update_resource" crm_feature_set="3.0.2" transition-key="69:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" transition-magic="0:0;69:6:0:62f2737b-5303-4c2f-a6eb-1d6686a31e90" call-id="15" rc-code="0" op-status="0" interval="20000" last-run="1274268875" last-rc-change="1274268875" exec-time="720" queue-time="0" op-digest="925820149485b43468de022b9943e65c"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+      <transient_attributes id="qa-suse-2">
+        <instance_attributes id="status-qa-suse-2">
+          <nvpair id="status-qa-suse-2-probe_complete" name="probe_complete" value="true"/>
+        </instance_attributes>
+      </transient_attributes>
+    </node_state>
+  </status>
+</cib>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2435.dot
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2435.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,24 @@
+digraph "g" {
+"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
+"dummy2_start_0 c21.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"dummy2_stop_0 c20.chepkov.lan" -> "all_stopped" [ style = bold]
+"dummy2_stop_0 c20.chepkov.lan" -> "dummy2_start_0 c21.chepkov.lan" [ style = bold]
+"dummy2_stop_0 c20.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"dummy3_stop_0 c21.chepkov.lan" -> "all_stopped" [ style = bold]
+"dummy3_stop_0 c21.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"dummy4_monitor_0 c19.chepkov.lan" -> "probe_complete c19.chepkov.lan" [ style = bold]
+"dummy4_monitor_0 c19.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"dummy4_monitor_0 c20.chepkov.lan" -> "probe_complete c20.chepkov.lan" [ style = bold]
+"dummy4_monitor_0 c20.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"dummy4_monitor_0 c21.chepkov.lan" -> "probe_complete c21.chepkov.lan" [ style = bold]
+"dummy4_monitor_0 c21.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete c19.chepkov.lan" -> "probe_complete" [ style = bold]
+"probe_complete c19.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete c20.chepkov.lan" -> "probe_complete" [ style = bold]
+"probe_complete c20.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete c21.chepkov.lan" -> "probe_complete" [ style = bold]
+"probe_complete c21.chepkov.lan" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete" -> "dummy2_stop_0 c20.chepkov.lan" [ style = bold]
+"probe_complete" -> "dummy3_stop_0 c21.chepkov.lan" [ style = bold]
+"probe_complete" [ style=bold color="green" fontcolor="orange"  ]
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2435.exp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2435.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,138 @@
+<transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="1" batch-limit="30" transition_id="0">
+  <synapse id="0">
+    <action_set>
+      <rsc_op id="11" operation="stop" operation_key="dummy2_stop_0" on_node="c20.chepkov.lan" on_node_uuid="c20.chepkov.lan">
+        <primitive id="dummy2" long-id="dummy2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="120000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="1">
+    <action_set>
+      <rsc_op id="12" operation="start" operation_key="dummy2_start_0" on_node="c21.chepkov.lan" on_node_uuid="c21.chepkov.lan">
+        <primitive id="dummy2" long-id="dummy2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="120000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="dummy2_stop_0" on_node="c20.chepkov.lan" on_node_uuid="c20.chepkov.lan"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="2">
+    <action_set>
+      <rsc_op id="4" operation="monitor" operation_key="dummy4_monitor_0" on_node="c19.chepkov.lan" on_node_uuid="c19.chepkov.lan">
+        <primitive id="dummy4" long-id="dummy4" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="120000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="3">
+    <action_set>
+      <rsc_op id="6" operation="monitor" operation_key="dummy4_monitor_0" on_node="c20.chepkov.lan" on_node_uuid="c20.chepkov.lan">
+        <primitive id="dummy4" long-id="dummy4" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="120000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="4">
+    <action_set>
+      <rsc_op id="8" operation="monitor" operation_key="dummy4_monitor_0" on_node="c21.chepkov.lan" on_node_uuid="c21.chepkov.lan">
+        <primitive id="dummy4" long-id="dummy4" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="120000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="5">
+    <action_set>
+      <rsc_op id="13" operation="stop" operation_key="dummy3_stop_0" on_node="c21.chepkov.lan" on_node_uuid="c21.chepkov.lan">
+        <primitive id="dummy3" long-id="dummy3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="120000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="6">
+    <action_set>
+      <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="dummy2_stop_0" on_node="c20.chepkov.lan" on_node_uuid="c20.chepkov.lan"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="13" operation="stop" operation_key="dummy3_stop_0" on_node="c21.chepkov.lan" on_node_uuid="c21.chepkov.lan"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="7">
+    <action_set>
+      <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="c19.chepkov.lan" on_node_uuid="c19.chepkov.lan"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="5" operation="probe_complete" operation_key="probe_complete" on_node="c20.chepkov.lan" on_node_uuid="c20.chepkov.lan"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="c21.chepkov.lan" on_node_uuid="c21.chepkov.lan"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8" priority="1000000">
+    <action_set>
+      <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="c19.chepkov.lan" on_node_uuid="c19.chepkov.lan">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="4" operation="monitor" operation_key="dummy4_monitor_0" on_node="c19.chepkov.lan" on_node_uuid="c19.chepkov.lan"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="9" priority="1000000">
+    <action_set>
+      <rsc_op id="5" operation="probe_complete" operation_key="probe_complete" on_node="c20.chepkov.lan" on_node_uuid="c20.chepkov.lan">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="6" operation="monitor" operation_key="dummy4_monitor_0" on_node="c20.chepkov.lan" on_node_uuid="c20.chepkov.lan"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="10" priority="1000000">
+    <action_set>
+      <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="c21.chepkov.lan" on_node_uuid="c21.chepkov.lan">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="8" operation="monitor" operation_key="dummy4_monitor_0" on_node="c21.chepkov.lan" on_node_uuid="c21.chepkov.lan"/>
+      </trigger>
+    </inputs>
+  </synapse>
+</transition_graph>
+
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2435.scores
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2435.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,13 @@
+Allocation scores:
+native_color: dummy1 allocation score on c19.chepkov.lan: 1000
+native_color: dummy1 allocation score on c20.chepkov.lan: -INFINITY
+native_color: dummy1 allocation score on c21.chepkov.lan: 0
+native_color: dummy2 allocation score on c19.chepkov.lan: -INFINITY
+native_color: dummy2 allocation score on c20.chepkov.lan: -INFINITY
+native_color: dummy2 allocation score on c21.chepkov.lan: 1000
+native_color: dummy4 allocation score on c19.chepkov.lan: -INFINITY
+native_color: dummy4 allocation score on c20.chepkov.lan: 0
+native_color: dummy4 allocation score on c21.chepkov.lan: -INFINITY
+native_color: dummy3 allocation score on c19.chepkov.lan: -INFINITY
+native_color: dummy3 allocation score on c20.chepkov.lan: 0
+native_color: dummy3 allocation score on c21.chepkov.lan: -INFINITY
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-lf-2435.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/bug-lf-2435.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,99 @@
+<cib epoch="3" num_updates="1" admin_epoch="0" validate-with="pacemaker-1.2" cib-last-written="Thu Jun 10 14:47:38 2010">
+  <configuration>
+    <crm_config>
+      <cluster_property_set id="cib-bootstrap-options">
+        <nvpair id="cib-bootstrap-options-dc-version" name="dc-version" value="1.0.8-unknown"/>
+        <nvpair id="cib-bootstrap-options-cluster-infrastructure" name="cluster-infrastructure" value="openais"/>
+        <nvpair id="cib-bootstrap-options-expected-quorum-votes" name="expected-quorum-votes" value="3"/>
+        <nvpair id="cib-bootstrap-options-stonith-enabled" name="stonith-enabled" value="false"/>
+        <nvpair id="cib-bootstrap-options-no-quorum-policy" name="no-quorum-policy" value="ignore"/>
+        <nvpair id="cib-bootstrap-options-start-failure-is-fatal" name="start-failure-is-fatal" value="false"/>
+      </cluster_property_set>
+    </crm_config>
+    <nodes>
+      <node id="c19.chepkov.lan" type="normal" uname="c19.chepkov.lan"/>
+      <node id="c20.chepkov.lan" type="normal" uname="c20.chepkov.lan">
+        <instance_attributes id="nodes-c20.chepkov.lan">
+          <nvpair id="nodes-c20.chepkov.lan-standby" name="standby" value="on"/>
+        </instance_attributes>
+      </node>
+      <node id="c21.chepkov.lan" type="normal" uname="c21.chepkov.lan"/>
+    </nodes>
+    <resources>
+      <primitive class="ocf" id="dummy1" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="dummy2" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="dummy4" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="dummy3" provider="pacemaker" type="Dummy"/>
+    </resources>
+    <constraints>
+      <rsc_colocation id="only-one" score="-INFINITY">
+        <resource_set id="only-one-0" sequential="true">
+          <resource_ref id="dummy1"/>
+          <resource_ref id="dummy2"/>
+          <resource_ref id="dummy4"/>
+          <resource_ref id="dummy3"/>
+        </resource_set>
+      </rsc_colocation>
+    </constraints>
+    <op_defaults>
+      <meta_attributes id="op-options">
+        <nvpair id="op-options-timeout" name="timeout" value="120"/>
+      </meta_attributes>
+    </op_defaults>
+    <rsc_defaults>
+      <meta_attributes id="rsc-options">
+        <nvpair id="rsc-options-resource-stickiness" name="resource-stickiness" value="1000"/>
+      </meta_attributes>
+    </rsc_defaults>
+  </configuration>
+  <status>
+    <node_state id="c19.chepkov.lan" uname="c19.chepkov.lan" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="c19.chepkov.lan">
+        <lrm_resources>
+          <lrm_resource id="dummy1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="dummy1_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dummy2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dummy3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="c20.chepkov.lan" uname="c20.chepkov.lan" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="c20.chepkov.lan">
+        <lrm_resources>
+          <lrm_resource id="dummy1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dummy2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="dummy2_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dummy3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="c21.chepkov.lan" uname="c21.chepkov.lan" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="c21.chepkov.lan">
+        <lrm_resources>
+          <lrm_resource id="dummy1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dummy2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="dummy3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="dummy3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="dummy3_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+  </status>
+</cib>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-n-387749.dot
--- a/pengine/test10/bug-n-387749.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-n-387749.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -48,9 +48,6 @@ digraph "g" {
 "probe_complete power720-1" -> "probe_complete" [ style = bold]
 "probe_complete power720-1" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "export_home_ocfs2:0_start_0 power720-1" [ style = bold]
-"probe_complete" -> "export_home_ocfs2_clone_set_start_0" [ style = bold]
-"probe_complete" -> "group_nfs_start_0" [ style = bold]
-"probe_complete" -> "group_nfs_stop_0" [ style = bold]
 "probe_complete" -> "resource_ipaddr1_single_start_0 power720-1" [ style = bold]
 "probe_complete" -> "resource_ipaddr1_single_stop_0 power720-2" [ style = bold]
 "probe_complete" -> "resource_nfsserver_single_start_0 power720-1" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-n-387749.exp
--- a/pengine/test10/bug-n-387749.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-n-387749.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -89,9 +89,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="18" operation="notified" operation_key="export_home_ocfs2_clone_set_confirmed-pre_notify_start_0"/>
        </trigger>
      </inputs>
@@ -175,9 +172,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <rsc_op id="12" operation="start" operation_key="export_home_ocfs2:0_start_0" on_node="power720-1" on_node_uuid="ac446085-4c9d-4d4a-a94d-5e63b6e421e3"/>
       </trigger>
       <trigger>
@@ -218,11 +212,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="16">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-pm-11.dot
--- a/pengine/test10/bug-pm-11.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-pm-11.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -28,9 +28,6 @@ digraph "g" {
 "probe_complete node-a" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete node-b" -> "probe_complete" [ style = bold]
 "probe_complete node-b" [ style=bold color="green" fontcolor="black"  ]
-"probe_complete" -> "group:0_start_0" [ style = bold]
-"probe_complete" -> "group:1_start_0" [ style = bold]
-"probe_complete" -> "ms-sf_start_0" [ style = bold]
 "probe_complete" -> "stateful-2:0_start_0 node-b" [ style = bold]
 "probe_complete" -> "stateful-2:1_start_0 node-a" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/bug-pm-11.exp
--- a/pengine/test10/bug-pm-11.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/bug-pm-11.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -7,9 +7,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="35" operation="start" operation_key="ms-sf_start_0"/>
        </trigger>
      </inputs>
@@ -71,9 +68,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="35" operation="start" operation_key="ms-sf_start_0"/>
        </trigger>
      </inputs>
@@ -176,11 +170,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="14" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-anon-dup.dot
--- a/pengine/test10/clone-anon-dup.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-anon-dup.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,18 +1,12 @@
 digraph "g" {
 "all_stopped" [ style=bold color="green" fontcolor="orange"  ]
-"apache2:0_clear_failcount wc01" [ style=bold color="green" fontcolor="black"  ]
-"apache2:2_clear_failcount wc02" [ style=bold color="green" fontcolor="black"  ]
 "apache2:2_stop_0 wc02" -> "all_stopped" [ style = bold]
 "apache2:2_stop_0 wc02" -> "group_webservice:2_stopped_0" [ style = bold]
 "apache2:2_stop_0 wc02" [ style=bold color="green" fontcolor="black"  ]
-"apache2:3_clear_failcount wc03" [ style=bold color="green" fontcolor="black"  ]
 "clone_webservice_stop_0" -> "clone_webservice_stopped_0" [ style = bold]
 "clone_webservice_stop_0" -> "group_webservice:2_stop_0" [ style = bold]
 "clone_webservice_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "clone_webservice_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
-"fs_www:0_clear_failcount wc01" [ style=bold color="green" fontcolor="black"  ]
-"fs_www:0_clear_failcount wc02" [ style=bold color="green" fontcolor="black"  ]
-"fs_www:2_clear_failcount wc03" [ style=bold color="green" fontcolor="black"  ]
 "group_webservice:2_stop_0" -> "apache2:2_stop_0 wc02" [ style = bold]
 "group_webservice:2_stop_0" -> "group_webservice:2_stopped_0" [ style = bold]
 "group_webservice:2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
@@ -24,6 +18,7 @@ digraph "g" {
 "probe_complete wc02" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete wc03" -> "probe_complete" [ style = bold]
 "probe_complete wc03" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete" -> "apache2:2_stop_0 wc02" [ style = bold]
 "probe_complete" -> "stonith-1_start_0 wc01" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "stonith-1_monitor_0 wc01" -> "probe_complete wc01" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-anon-dup.exp
--- a/pengine/test10/clone-anon-dup.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-anon-dup.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1,7 +1,7 @@
 <transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
   <synapse id="0">
     <action_set>
-      <rsc_op id="14" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
+      <rsc_op id="8" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
         <primitive id="stonith-1" long-id="stonith-1" class="stonith" type="dummy"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
@@ -10,7 +10,7 @@
   </synapse>
   <synapse id="1">
     <action_set>
-      <rsc_op id="16" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
+      <rsc_op id="10" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
         <primitive id="stonith-1" long-id="stonith-1" class="stonith" type="dummy"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
@@ -19,7 +19,7 @@
   </synapse>
   <synapse id="2">
     <action_set>
-      <rsc_op id="18" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e">
+      <rsc_op id="12" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e">
         <primitive id="stonith-1" long-id="stonith-1" class="stonith" type="dummy"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
@@ -28,197 +28,146 @@
   </synapse>
   <synapse id="3">
     <action_set>
-      <rsc_op id="19" operation="start" operation_key="stonith-1_start_0" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
+      <rsc_op id="13" operation="start" operation_key="stonith-1_start_0" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
         <primitive id="stonith-1" long-id="stonith-1" class="stonith" type="dummy"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="probe_complete" operation_key="probe_complete"/>
+        <pseudo_event id="6" operation="probe_complete" operation_key="probe_complete"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="4">
     <action_set>
-      <crm_event id="1" operation="clear_failcount" operation_key="fs_www:0_clear_failcount" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
-        <primitive id="fs_www:0" long-id="clone_webservice:group_webservice:0:fs_www:0" class="ocf" provider="heartbeat" type="Filesystem"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" clone-max="2" clone-node-max="1" crm_feature_set="3.0.2" device="wcnfs:/share/drbd_www/data/" directory="/data/www" fstype="nfs"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="5">
-    <action_set>
-      <crm_event id="5" operation="clear_failcount" operation_key="fs_www:0_clear_failcount" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
-        <primitive id="fs_www:0" long-id="clone_webservice:group_webservice:0:fs_www:0" class="ocf" provider="heartbeat" type="Filesystem"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" clone-max="2" clone-node-max="1" crm_feature_set="3.0.2" device="wcnfs:/share/drbd_www/data/" directory="/data/www" fstype="nfs"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="6">
-    <action_set>
-      <crm_event id="7" operation="clear_failcount" operation_key="apache2:0_clear_failcount" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
-        <primitive id="apache2:0" long-id="clone_webservice:group_webservice:0:apache2:0" class="ocf" provider="heartbeat" type="apache"/>
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" clone-max="2" clone-node-max="1" configfile="/etc/apache2/apache2.conf" crm_feature_set="3.0.2" envfiles="/etc/apache2/envvars" httpd="/usr/sbin/apache2" options="-k start" statusurl="http://localhost/server-status/"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="7">
-    <action_set>
-      <pseudo_event id="39" operation="stop" operation_key="group_webservice:2_stop_0">
+      <pseudo_event id="33" operation="stop" operation_key="group_webservice:2_stop_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="clone_webservice_stop_0"/>
+        <pseudo_event id="41" operation="stop" operation_key="clone_webservice_stop_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="8">
+  <synapse id="5">
     <action_set>
-      <pseudo_event id="40" operation="stopped" operation_key="group_webservice:2_stopped_0">
+      <pseudo_event id="34" operation="stopped" operation_key="group_webservice:2_stopped_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="36" operation="stop" operation_key="apache2:0_stop_0" internal_operation_key="apache2:2_stop_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
+        <rsc_op id="30" operation="stop" operation_key="apache2:0_stop_0" internal_operation_key="apache2:2_stop_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
       </trigger>
       <trigger>
-        <pseudo_event id="39" operation="stop" operation_key="group_webservice:2_stop_0"/>
+        <pseudo_event id="33" operation="stop" operation_key="group_webservice:2_stop_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="9">
+  <synapse id="6">
     <action_set>
-      <crm_event id="9" operation="clear_failcount" operation_key="fs_www:2_clear_failcount" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e">
-        <primitive id="fs_www:2" long-id="clone_webservice:group_webservice:2:fs_www:2" class="ocf" provider="heartbeat" type="Filesystem"/>
-        <attributes CRM_meta_clone="2" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" clone-max="2" clone-node-max="1" crm_feature_set="3.0.2" device="wcnfs:/share/drbd_www/data/" directory="/data/www" fstype="nfs"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="10">
-    <action_set>
-      <crm_event id="4" operation="clear_failcount" operation_key="apache2:0_clear_failcount_0" internal_operation_key="apache2:2_clear_failcount" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
-        <primitive id="apache2:0" long-id="apache2:2" class="ocf" provider="heartbeat" type="apache"/>
-        <attributes CRM_meta_clone="2" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" clone-max="2" clone-node-max="1" configfile="/etc/apache2/apache2.conf" crm_feature_set="3.0.2" envfiles="/etc/apache2/envvars" httpd="/usr/sbin/apache2" options="-k start" statusurl="http://localhost/server-status/"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="11">
-    <action_set>
-      <rsc_op id="36" operation="stop" operation_key="apache2:0_stop_0" internal_operation_key="apache2:2_stop_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
+      <rsc_op id="30" operation="stop" operation_key="apache2:0_stop_0" internal_operation_key="apache2:2_stop_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
         <primitive id="apache2:0" long-id="apache2:2" class="ocf" provider="heartbeat" type="apache"/>
         <attributes CRM_meta_clone="2" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="39" operation="stop" operation_key="group_webservice:2_stop_0"/>
+        <pseudo_event id="6" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="33" operation="stop" operation_key="group_webservice:2_stop_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="12">
+  <synapse id="7">
     <action_set>
-      <crm_event id="10" operation="clear_failcount" operation_key="apache2:3_clear_failcount" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e">
-        <primitive id="apache2:3" long-id="clone_webservice:group_webservice:3:apache2:3" class="ocf" provider="heartbeat" type="apache"/>
-        <attributes CRM_meta_clone="3" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_no_wait="true" CRM_meta_timeout="20000" clone-max="2" clone-node-max="1" configfile="/etc/apache2/apache2.conf" crm_feature_set="3.0.2" envfiles="/etc/apache2/envvars" httpd="/usr/sbin/apache2" options="-k start" statusurl="http://localhost/server-status/"/>
-      </crm_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="13">
-    <action_set>
-      <pseudo_event id="47" operation="stop" operation_key="clone_webservice_stop_0">
+      <pseudo_event id="41" operation="stop" operation_key="clone_webservice_stop_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="14" priority="1000000">
+  <synapse id="8" priority="1000000">
     <action_set>
-      <pseudo_event id="48" operation="stopped" operation_key="clone_webservice_stopped_0">
+      <pseudo_event id="42" operation="stopped" operation_key="clone_webservice_stopped_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="40" operation="stopped" operation_key="group_webservice:2_stopped_0"/>
+        <pseudo_event id="34" operation="stopped" operation_key="group_webservice:2_stopped_0"/>
       </trigger>
       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="clone_webservice_stop_0"/>
+        <pseudo_event id="41" operation="stop" operation_key="clone_webservice_stop_0"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="15">
+  <synapse id="9">
     <action_set>
-      <pseudo_event id="11" operation="all_stopped" operation_key="all_stopped">
+      <pseudo_event id="5" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="36" operation="stop" operation_key="apache2:0_stop_0" internal_operation_key="apache2:2_stop_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
+        <rsc_op id="30" operation="stop" operation_key="apache2:0_stop_0" internal_operation_key="apache2:2_stop_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="16">
+  <synapse id="10">
     <action_set>
-      <pseudo_event id="12" operation="probe_complete" operation_key="probe_complete">
+      <pseudo_event id="6" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="13" operation="probe_complete" operation_key="probe_complete" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca"/>
+        <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca"/>
       </trigger>
       <trigger>
-        <rsc_op id="15" operation="probe_complete" operation_key="probe_complete" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
+        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
       </trigger>
       <trigger>
-        <rsc_op id="17" operation="probe_complete" operation_key="probe_complete" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e"/>
+        <rsc_op id="11" operation="probe_complete" operation_key="probe_complete" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="17" priority="1000000">
+  <synapse id="11" priority="1000000">
     <action_set>
-      <rsc_op id="13" operation="probe_complete" operation_key="probe_complete" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
+      <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="14" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca"/>
+        <rsc_op id="8" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc01" on_node_uuid="31de4ab3-2d05-476e-8f9a-627ad6cd94ca"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="18" priority="1000000">
+  <synapse id="12" priority="1000000">
     <action_set>
-      <rsc_op id="15" operation="probe_complete" operation_key="probe_complete" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
+      <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="16" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
+        <rsc_op id="10" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc02" on_node_uuid="f36760d8-d84a-46b2-b452-4c8cac8b3396"/>
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="19" priority="1000000">
+  <synapse id="13" priority="1000000">
     <action_set>
-      <rsc_op id="17" operation="probe_complete" operation_key="probe_complete" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e">
+      <rsc_op id="11" operation="probe_complete" operation_key="probe_complete" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="18" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e"/>
+        <rsc_op id="12" operation="monitor" operation_key="stonith-1_monitor_0" on_node="wc03" on_node_uuid="f61edb1d-6f49-4ffa-a46a-42ceef796f6e"/>
       </trigger>
     </inputs>
   </synapse>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-anon-probe-1.dot
--- a/pengine/test10/clone-anon-probe-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-anon-probe-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -12,15 +12,11 @@ digraph "g" {
 "ms-drbd0_start_0" -> "drbd0:1_start_0 mysql-01" [ style = bold]
 "ms-drbd0_start_0" -> "ms-drbd0_running_0" [ style = bold]
 "ms-drbd0_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"ms-drbd0_stop_0" -> "ms-drbd0_start_0" [ style = bold]
-"ms-drbd0_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete mysql-01" -> "probe_complete" [ style = bold]
 "probe_complete mysql-01" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete mysql-02" -> "probe_complete" [ style = bold]
 "probe_complete mysql-02" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "drbd0:0_start_0 mysql-02" [ style = bold]
 "probe_complete" -> "drbd0:1_start_0 mysql-01" [ style = bold]
-"probe_complete" -> "ms-drbd0_start_0" [ style = bold]
-"probe_complete" -> "ms-drbd0_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-anon-probe-1.exp
--- a/pengine/test10/clone-anon-probe-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-anon-probe-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -55,14 +55,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="11" operation="stop" operation_key="ms-drbd0_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="5" priority="1000000">
      <action_set>
@@ -84,18 +77,6 @@
    </synapse>
    <synapse id="6">
      <action_set>
-       <pseudo_event id="11" operation="stop" operation_key="ms-drbd0_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="7">
-     <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -109,7 +90,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="8" priority="1000000">
+  <synapse id="7" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="mysql-02" on_node_uuid="06f7483d-273b-4c51-95a6-bccde94d7fdb">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -121,7 +102,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="9" priority="1000000">
+  <synapse id="8" priority="1000000">
      <action_set>
        <rsc_op id="5" operation="probe_complete" operation_key="probe_complete" on_node="mysql-01" on_node_uuid="3f3eb909-e719-4bc4-a700-d7aa91a65098">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-colocate-instance-1.dot
--- a/pengine/test10/clone-colocate-instance-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-colocate-instance-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -4,8 +4,6 @@ digraph "g" {
 "cl_dummy_start_0" -> "dummy:0_start_0 alice.demo" [ style = bold]
 "cl_dummy_start_0" -> "dummy:1_start_0 bob.demo" [ style = bold]
 "cl_dummy_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"cl_dummy_stop_0" -> "cl_dummy_start_0" [ style = bold]
-"cl_dummy_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "dummy1_monitor_0 alice.demo" -> "probe_complete alice.demo" [ style = bold]
 "dummy1_monitor_0 alice.demo" [ style=bold color="green" fontcolor="black"  ]
 "dummy1_monitor_0 bob.demo" -> "probe_complete bob.demo" [ style = bold]
@@ -28,8 +26,6 @@ digraph "g" {
 "probe_complete alice.demo" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete bob.demo" -> "probe_complete" [ style = bold]
 "probe_complete bob.demo" [ style=bold color="green" fontcolor="black"  ]
-"probe_complete" -> "cl_dummy_start_0" [ style = bold]
-"probe_complete" -> "cl_dummy_stop_0" [ style = bold]
 "probe_complete" -> "dummy1_start_0 alice.demo" [ style = bold]
 "probe_complete" -> "dummy2_start_0 bob.demo" [ style = bold]
 "probe_complete" -> "dummy:0_start_0 alice.demo" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-colocate-instance-1.exp
--- a/pengine/test10/clone-colocate-instance-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-colocate-instance-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -117,14 +117,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="17" operation="stop" operation_key="cl_dummy_stop_0"/>
-      </trigger>
-    </inputs>
+    <inputs/>
   </synapse>
   <synapse id="11" priority="1000000">
     <action_set>
@@ -146,18 +139,6 @@
   </synapse>
   <synapse id="12">
     <action_set>
-      <pseudo_event id="17" operation="stop" operation_key="cl_dummy_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="13">
-    <action_set>
       <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
@@ -171,7 +152,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="14" priority="1000000">
+  <synapse id="13" priority="1000000">
     <action_set>
       <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="alice.demo" on_node_uuid="df0d4306-9cf3-4c5c-a23a-027ac36da131">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -189,7 +170,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="15" priority="1000000">
+  <synapse id="14" priority="1000000">
     <action_set>
       <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="bob.demo" on_node_uuid="0af1add7-22b5-4342-9816-67e6351605de">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-colocate-instance-2.dot
--- a/pengine/test10/clone-colocate-instance-2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-colocate-instance-2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -4,8 +4,6 @@ digraph "g" {
 "cl_dummy_start_0" -> "dummy:0_start_0 alice.demo" [ style = bold]
 "cl_dummy_start_0" -> "dummy:1_start_0 bob.demo" [ style = bold]
 "cl_dummy_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"cl_dummy_stop_0" -> "cl_dummy_start_0" [ style = bold]
-"cl_dummy_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "dummy1_monitor_0 alice.demo" -> "probe_complete alice.demo" [ style = bold]
 "dummy1_monitor_0 alice.demo" [ style=bold color="green" fontcolor="black"  ]
 "dummy1_monitor_0 bob.demo" -> "probe_complete bob.demo" [ style = bold]
@@ -28,8 +26,6 @@ digraph "g" {
 "probe_complete alice.demo" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete bob.demo" -> "probe_complete" [ style = bold]
 "probe_complete bob.demo" [ style=bold color="green" fontcolor="black"  ]
-"probe_complete" -> "cl_dummy_start_0" [ style = bold]
-"probe_complete" -> "cl_dummy_stop_0" [ style = bold]
 "probe_complete" -> "dummy1_start_0 bob.demo" [ style = bold]
 "probe_complete" -> "dummy2_start_0 alice.demo" [ style = bold]
 "probe_complete" -> "dummy:0_start_0 alice.demo" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-colocate-instance-2.exp
--- a/pengine/test10/clone-colocate-instance-2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-colocate-instance-2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -117,14 +117,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="17" operation="stop" operation_key="cl_dummy_stop_0"/>
-      </trigger>
-    </inputs>
+    <inputs/>
   </synapse>
   <synapse id="11" priority="1000000">
     <action_set>
@@ -146,18 +139,6 @@
   </synapse>
   <synapse id="12">
     <action_set>
-      <pseudo_event id="17" operation="stop" operation_key="cl_dummy_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="13">
-    <action_set>
       <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
@@ -171,7 +152,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="14" priority="1000000">
+  <synapse id="13" priority="1000000">
     <action_set>
       <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="alice.demo" on_node_uuid="df0d4306-9cf3-4c5c-a23a-027ac36da131">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -189,7 +170,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="15" priority="1000000">
+  <synapse id="14" priority="1000000">
     <action_set>
       <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="bob.demo" on_node_uuid="0af1add7-22b5-4342-9816-67e6351605de">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-no-shuffle.dot
--- a/pengine/test10/clone-no-shuffle.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-no-shuffle.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -79,8 +79,6 @@ digraph "g" {
 "probe_complete dktest2sles10" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "drbd1:0_stop_0 dktest2sles10" [ style = bold]
 "probe_complete" -> "drbd1:1_start_0 dktest1sles10" [ style = bold]
-"probe_complete" -> "ms-drbd1_start_0" [ style = bold]
-"probe_complete" -> "ms-drbd1_stop_0" [ style = bold]
 "probe_complete" -> "stonith-1_start_0 dktest2sles10" [ style = bold]
 "probe_complete" -> "testip_stop_0 dktest2sles10" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-no-shuffle.exp
--- a/pengine/test10/clone-no-shuffle.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-no-shuffle.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -166,9 +166,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <pseudo_event id="19" operation="notified" operation_key="ms-drbd1_confirmed-pre_notify_start_0"/>
        </trigger>
        <trigger>
@@ -262,9 +259,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <pseudo_event id="25" operation="notified" operation_key="ms-drbd1_confirmed-pre_notify_stop_0"/>
        </trigger>
        <trigger>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-order-instance.dot
--- a/pengine/test10/clone-order-instance.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-order-instance.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -4,8 +4,6 @@ digraph "g" {
 "cl_dummy_start_0" -> "dummy:0_start_0 bob.demo" [ style = bold]
 "cl_dummy_start_0" -> "dummy:1_start_0 alice.demo" [ style = bold]
 "cl_dummy_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"cl_dummy_stop_0" -> "cl_dummy_start_0" [ style = bold]
-"cl_dummy_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "dummy1_monitor_0 alice.demo" -> "probe_complete alice.demo" [ style = bold]
 "dummy1_monitor_0 alice.demo" [ style=bold color="green" fontcolor="black"  ]
 "dummy1_monitor_0 bob.demo" -> "probe_complete bob.demo" [ style = bold]
@@ -24,8 +22,6 @@ digraph "g" {
 "probe_complete alice.demo" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete bob.demo" -> "probe_complete" [ style = bold]
 "probe_complete bob.demo" [ style=bold color="green" fontcolor="black"  ]
-"probe_complete" -> "cl_dummy_start_0" [ style = bold]
-"probe_complete" -> "cl_dummy_stop_0" [ style = bold]
 "probe_complete" -> "dummy1_start_0 alice.demo" [ style = bold]
 "probe_complete" -> "dummy:0_start_0 bob.demo" [ style = bold]
 "probe_complete" -> "dummy:1_start_0 alice.demo" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/clone-order-instance.exp
--- a/pengine/test10/clone-order-instance.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/clone-order-instance.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -89,14 +89,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="14" operation="stop" operation_key="cl_dummy_stop_0"/>
-      </trigger>
-    </inputs>
+    <inputs/>
   </synapse>
   <synapse id="8" priority="1000000">
     <action_set>
@@ -118,18 +111,6 @@
   </synapse>
   <synapse id="9">
     <action_set>
-      <pseudo_event id="14" operation="stop" operation_key="cl_dummy_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="10">
-    <action_set>
       <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
@@ -143,7 +124,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="11" priority="1000000">
+  <synapse id="10" priority="1000000">
     <action_set>
       <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="alice.demo" on_node_uuid="df0d4306-9cf3-4c5c-a23a-027ac36da131">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -158,7 +139,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="12" priority="1000000">
+  <synapse id="11" priority="1000000">
     <action_set>
       <rsc_op id="6" operation="probe_complete" operation_key="probe_complete" on_node="bob.demo" on_node_uuid="0af1add7-22b5-4342-9816-67e6351605de">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/coloc-group.dot
--- a/pengine/test10/coloc-group.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/coloc-group.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,32 +1,18 @@
 digraph "g" {
-"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "group1_running_0" [ style=dashed color="red" fontcolor="orange"  ]
 "group1_start_0" -> "group1_running_0" [ style = dashed]
 "group1_start_0" -> "rsc2_start_0 node2" [ style = bold]
 "group1_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"group1_stop_0" -> "group1_start_0" [ style = bold]
-"group1_stop_0" -> "group1_stopped_0" [ style = bold]
-"group1_stop_0" -> "rsc2_stop_0" [ style = bold]
-"group1_stop_0" -> "rsc3_stop_0" [ style = bold]
-"group1_stop_0" -> "rsc4_stop_0" [ style = bold]
-"group1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"group1_stopped_0" -> "group1_start_0" [ style = bold]
-"group1_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete node3" -> "probe_complete" [ style = bold]
 "probe_complete node3" [ style=bold color="green" fontcolor="black"  ]
-"probe_complete" -> "group1_start_0" [ style = bold]
-"probe_complete" -> "group1_stop_0" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node2" [ style = bold]
 "probe_complete" -> "rsc2_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" -> "rsc3_start_0 <none>" [ style = dashed]
-"probe_complete" -> "rsc3_stop_0" [ style = bold]
 "probe_complete" -> "rsc4_start_0 <none>" [ style = dashed]
-"probe_complete" -> "rsc4_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black"  ]
@@ -40,9 +26,6 @@ digraph "g" {
 "rsc2_start_0 node2" -> "group1_running_0" [ style = dashed]
 "rsc2_start_0 node2" -> "rsc3_start_0 <none>" [ style = dashed]
 "rsc2_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
-"rsc2_stop_0" -> "all_stopped" [ style = bold]
-"rsc2_stop_0" -> "group1_stopped_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black"  ]
 "rsc3_monitor_0 node3" -> "probe_complete node3" [ style = bold]
@@ -50,10 +33,6 @@ digraph "g" {
 "rsc3_start_0 <none>" -> "group1_running_0" [ style = dashed]
 "rsc3_start_0 <none>" -> "rsc4_start_0 <none>" [ style = dashed]
 "rsc3_start_0 <none>" [ style=dashed color="red" fontcolor="black"  ]
-"rsc3_stop_0" -> "all_stopped" [ style = bold]
-"rsc3_stop_0" -> "group1_stopped_0" [ style = bold]
-"rsc3_stop_0" -> "rsc2_stop_0" [ style = bold]
-"rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc4_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc4_monitor_0 node1" [ style=bold color="green" fontcolor="black"  ]
 "rsc4_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -62,8 +41,4 @@ digraph "g" {
 "rsc4_monitor_0 node3" [ style=bold color="green" fontcolor="black"  ]
 "rsc4_start_0 <none>" -> "group1_running_0" [ style = dashed]
 "rsc4_start_0 <none>" [ style=dashed color="red" fontcolor="black"  ]
-"rsc4_stop_0" -> "all_stopped" [ style = bold]
-"rsc4_stop_0" -> "group1_stopped_0" [ style = bold]
-"rsc4_stop_0" -> "rsc3_stop_0" [ style = bold]
-"rsc4_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/coloc-group.exp
--- a/pengine/test10/coloc-group.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/coloc-group.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -45,53 +45,10 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="19" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="20" operation="stopped" operation_key="group1_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="5">
      <action_set>
-       <pseudo_event id="19" operation="stop" operation_key="group1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="6">
-     <action_set>
-       <pseudo_event id="20" operation="stopped" operation_key="group1_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="19" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="24" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="25" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="27" operation="stop" operation_key="rsc4_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="7">
-     <action_set>
        <rsc_op id="9" operation="monitor" operation_key="rsc2_monitor_0" on_node="node2" on_node_uuid="node2">
          <primitive id="rsc2" long-id="group1:rsc2" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -99,7 +56,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="8">
+  <synapse id="6">
      <action_set>
        <rsc_op id="16" operation="start" operation_key="rsc2_start_0" on_node="node2" on_node_uuid="node2">
          <primitive id="rsc2" long-id="group1:rsc2" class="heartbeat" type="apache"/>
@@ -115,25 +72,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="9">
-     <action_set>
-      <pseudo_event id="24" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="19" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="25" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="10">
+  <synapse id="7">
      <action_set>
        <rsc_op id="5" operation="monitor" operation_key="rsc3_monitor_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc3" long-id="group1:rsc3" class="heartbeat" type="apache"/>
@@ -142,7 +81,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="11">
+  <synapse id="8">
      <action_set>
        <rsc_op id="13" operation="monitor" operation_key="rsc3_monitor_0" on_node="node3" on_node_uuid="node3">
          <primitive id="rsc3" long-id="group1:rsc3" class="heartbeat" type="apache"/>
@@ -151,25 +90,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="12">
-     <action_set>
-      <pseudo_event id="25" operation="stop" operation_key="rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="19" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="27" operation="stop" operation_key="rsc4_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="13">
+  <synapse id="9">
      <action_set>
        <rsc_op id="6" operation="monitor" operation_key="rsc4_monitor_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc4" long-id="group1:rsc4" class="heartbeat" type="apache"/>
@@ -178,7 +99,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="14">
+  <synapse id="10">
      <action_set>
        <rsc_op id="10" operation="monitor" operation_key="rsc4_monitor_0" on_node="node2" on_node_uuid="node2">
          <primitive id="rsc4" long-id="group1:rsc4" class="heartbeat" type="apache"/>
@@ -187,7 +108,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="15">
+  <synapse id="11">
      <action_set>
        <rsc_op id="14" operation="monitor" operation_key="rsc4_monitor_0" on_node="node3" on_node_uuid="node3">
          <primitive id="rsc4" long-id="group1:rsc4" class="heartbeat" type="apache"/>
@@ -196,40 +117,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="16">
-     <action_set>
-      <pseudo_event id="27" operation="stop" operation_key="rsc4_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="19" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="17">
-     <action_set>
-       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="24" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="25" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="27" operation="stop" operation_key="rsc4_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="18">
+  <synapse id="12">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -247,7 +135,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="19" priority="1000000">
+  <synapse id="13" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="node1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -265,7 +153,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="20" priority="1000000">
+  <synapse id="14" priority="1000000">
      <action_set>
        <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="node2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -283,7 +171,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="21" priority="1000000">
+  <synapse id="15" priority="1000000">
      <action_set>
        <rsc_op id="11" operation="probe_complete" operation_key="probe_complete" on_node="node3" on_node_uuid="node3">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group1.dot
--- a/pengine/test10/group1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,5 +1,4 @@
  digraph "g" {
-"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc1_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -7,9 +6,6 @@
 "child_rsc1_start_0 node1" -> "child_rsc2_start_0 node1" [ style = bold]
 "child_rsc1_start_0 node1" -> "rsc1_running_0" [ style = bold]
 "child_rsc1_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc1_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc1_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"child_rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc2_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc2_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc2_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -17,32 +13,19 @@
 "child_rsc2_start_0 node1" -> "child_rsc3_start_0 node1" [ style = bold]
 "child_rsc2_start_0 node1" -> "rsc1_running_0" [ style = bold]
 "child_rsc2_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc2_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"child_rsc2_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"child_rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "child_rsc3_monitor_0 node2" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_start_0 node1" -> "rsc1_running_0" [ style = bold]
 "child_rsc3_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc3_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc3_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"child_rsc3_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"child_rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc1_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc2_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc2_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc3_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc3_stop_0" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_start_0" -> "child_rsc1_start_0 node1" [ style = bold]
@@ -50,12 +33,4 @@
 "rsc1_start_0" -> "child_rsc3_start_0 node1" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"rsc1_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"rsc1_stop_0" -> "child_rsc3_stop_0" [ style = bold]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"rsc1_stopped_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group1.exp
--- a/pengine/test10/group1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -5,17 +5,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="16" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="17" operation="stopped" operation_key="rsc1_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="1">
      <action_set>
@@ -40,39 +30,6 @@
    </synapse>
    <synapse id="2">
      <action_set>
-       <pseudo_event id="16" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="3">
-     <action_set>
-       <pseudo_event id="17" operation="stopped" operation_key="rsc1_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="16" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="20" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="21" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="22" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="4">
-     <action_set>
        <rsc_op id="4" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc1:child_rsc1" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -80,7 +37,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="5">
+  <synapse id="3">
      <action_set>
        <rsc_op id="8" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc1" long-id="rsc1:child_rsc1" class="heartbeat" type="apache"/>
@@ -89,7 +46,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="6">
+  <synapse id="4">
      <action_set>
        <rsc_op id="11" operation="start" operation_key="child_rsc1_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc1:child_rsc1" class="heartbeat" type="apache"/>
@@ -105,25 +62,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="7">
-     <action_set>
-      <pseudo_event id="20" operation="stop" operation_key="child_rsc1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="16" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="21" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="8">
+  <synapse id="5">
      <action_set>
        <rsc_op id="5" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc1:child_rsc2" class="heartbeat" type="apache"/>
@@ -132,7 +71,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="9">
+  <synapse id="6">
      <action_set>
        <rsc_op id="9" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2" long-id="rsc1:child_rsc2" class="heartbeat" type="apache"/>
@@ -141,7 +80,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="10">
+  <synapse id="7">
      <action_set>
        <rsc_op id="12" operation="start" operation_key="child_rsc2_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc1:child_rsc2" class="heartbeat" type="apache"/>
@@ -160,25 +99,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="11">
-     <action_set>
-      <pseudo_event id="21" operation="stop" operation_key="child_rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="16" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="22" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="12">
+  <synapse id="8">
      <action_set>
        <rsc_op id="6" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc1:child_rsc3" class="heartbeat" type="apache"/>
@@ -187,7 +108,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="13">
+  <synapse id="9">
      <action_set>
        <rsc_op id="10" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc3" long-id="rsc1:child_rsc3" class="heartbeat" type="apache"/>
@@ -196,7 +117,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="14">
+  <synapse id="10">
      <action_set>
        <rsc_op id="13" operation="start" operation_key="child_rsc3_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc1:child_rsc3" class="heartbeat" type="apache"/>
@@ -215,40 +136,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="15">
-     <action_set>
-      <pseudo_event id="22" operation="stop" operation_key="child_rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="16" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="16">
-     <action_set>
-       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="20" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="21" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="22" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="17">
+  <synapse id="11">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -263,7 +151,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18" priority="1000000">
+  <synapse id="12" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -281,7 +169,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="19" priority="1000000">
+  <synapse id="13" priority="1000000">
      <action_set>
        <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group10.dot
--- a/pengine/test10/group10.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group10.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -68,5 +68,8 @@
 "probe_complete c001n03" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n08" -> "probe_complete" [ style = bold]
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
+"probe_complete" -> "child_192.168.100.181_stop_0 c001n01" [ style = bold]
+"probe_complete" -> "child_192.168.100.182_stop_0 c001n01" [ style = bold]
+"probe_complete" -> "child_192.168.100.183_stop_0 c001n01" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group10.exp
--- a/pengine/test10/group10.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group10.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -41,7 +41,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs/>
+    <inputs/>
    </synapse>
    <synapse id="3">
      <action_set>
@@ -86,6 +86,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="15" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="32" operation="stop" operation_key="child_192.168.100.182_stop_0" on_node="c001n01" on_node_uuid="de937e3d-0309-4b5d-b85c-f96edc1ed8e3"/>
        </trigger>
        <trigger>
@@ -131,6 +134,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="15" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="34" operation="stop" operation_key="child_192.168.100.183_stop_0" on_node="c001n01" on_node_uuid="de937e3d-0309-4b5d-b85c-f96edc1ed8e3"/>
        </trigger>
        <trigger>
@@ -179,6 +185,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="15" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <pseudo_event id="38" operation="stop" operation_key="group-1_stop_0"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group15.dot
--- a/pengine/test10/group15.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group15.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,31 +1,17 @@
  digraph "g" {
-"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "bar_running_0" [ style=bold color="green" fontcolor="orange"  ]
 "bar_start_0" -> "bar_running_0" [ style = bold]
 "bar_start_0" -> "rsc6_start_0 node1" [ style = bold]
 "bar_start_0" -> "rsc7_start_0 node1" [ style = bold]
 "bar_start_0" -> "rsc8_start_0 node1" [ style = bold]
 "bar_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"bar_stop_0" -> "bar_start_0" [ style = bold]
-"bar_stop_0" -> "bar_stopped_0" [ style = bold]
-"bar_stop_0" -> "rsc6_stop_0" [ style = bold]
-"bar_stop_0" -> "rsc7_stop_0" [ style = bold]
-"bar_stop_0" -> "rsc8_stop_0" [ style = bold]
-"bar_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"bar_stopped_0" -> "bar_start_0" [ style = bold]
-"bar_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black"  ]
-"probe_complete" -> "bar_start_0" [ style = bold]
-"probe_complete" -> "bar_stop_0" [ style = bold]
 "probe_complete" -> "rsc6_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc6_stop_0" [ style = bold]
 "probe_complete" -> "rsc7_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc7_stop_0" [ style = bold]
 "probe_complete" -> "rsc8_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc8_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black"  ]
@@ -46,9 +32,6 @@
 "rsc6_start_0 node1" -> "bar_running_0" [ style = bold]
 "rsc6_start_0 node1" -> "rsc7_start_0 node1" [ style = bold]
 "rsc6_start_0 node1" [ style=bold color="green" fontcolor="black"  ]
-"rsc6_stop_0" -> "all_stopped" [ style = bold]
-"rsc6_stop_0" -> "bar_stopped_0" [ style = bold]
-"rsc6_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc7_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc7_monitor_0 node1" [ style=bold color="green" fontcolor="black"  ]
 "rsc7_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -56,18 +39,10 @@
 "rsc7_start_0 node1" -> "bar_running_0" [ style = bold]
 "rsc7_start_0 node1" -> "rsc8_start_0 node1" [ style = bold]
 "rsc7_start_0 node1" [ style=bold color="green" fontcolor="black"  ]
-"rsc7_stop_0" -> "all_stopped" [ style = bold]
-"rsc7_stop_0" -> "bar_stopped_0" [ style = bold]
-"rsc7_stop_0" -> "rsc6_stop_0" [ style = bold]
-"rsc7_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc8_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc8_monitor_0 node1" [ style=bold color="green" fontcolor="black"  ]
 "rsc8_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "rsc8_monitor_0 node2" [ style=bold color="green" fontcolor="black"  ]
 "rsc8_start_0 node1" -> "bar_running_0" [ style = bold]
 "rsc8_start_0 node1" [ style=bold color="green" fontcolor="black"  ]
-"rsc8_stop_0" -> "all_stopped" [ style = bold]
-"rsc8_stop_0" -> "bar_stopped_0" [ style = bold]
-"rsc8_stop_0" -> "rsc7_stop_0" [ style = bold]
-"rsc8_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group15.exp
--- a/pengine/test10/group15.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group15.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -59,17 +59,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="bar_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="27" operation="stopped" operation_key="bar_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="7">
      <action_set>
@@ -94,39 +84,6 @@
    </synapse>
    <synapse id="8">
      <action_set>
-       <pseudo_event id="26" operation="stop" operation_key="bar_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="9">
-     <action_set>
-       <pseudo_event id="27" operation="stopped" operation_key="bar_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="bar_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="36" operation="stop" operation_key="rsc6_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="37" operation="stop" operation_key="rsc7_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="38" operation="stop" operation_key="rsc8_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="10">
-     <action_set>
        <rsc_op id="7" operation="monitor" operation_key="rsc6_monitor_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc6" long-id="bar:rsc6" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -134,7 +91,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="11">
+  <synapse id="9">
      <action_set>
        <rsc_op id="14" operation="monitor" operation_key="rsc6_monitor_0" on_node="node2" on_node_uuid="node2">
          <primitive id="rsc6" long-id="bar:rsc6" class="heartbeat" type="apache"/>
@@ -143,7 +100,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="12">
+  <synapse id="10">
      <action_set>
        <rsc_op id="21" operation="start" operation_key="rsc6_start_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc6" long-id="bar:rsc6" class="heartbeat" type="apache"/>
@@ -159,25 +116,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="13">
-     <action_set>
-      <pseudo_event id="36" operation="stop" operation_key="rsc6_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="bar_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="37" operation="stop" operation_key="rsc7_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="14">
+  <synapse id="11">
      <action_set>
        <rsc_op id="8" operation="monitor" operation_key="rsc7_monitor_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc7" long-id="bar:rsc7" class="heartbeat" type="apache"/>
@@ -186,7 +125,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="15">
+  <synapse id="12">
      <action_set>
        <rsc_op id="15" operation="monitor" operation_key="rsc7_monitor_0" on_node="node2" on_node_uuid="node2">
          <primitive id="rsc7" long-id="bar:rsc7" class="heartbeat" type="apache"/>
@@ -195,7 +134,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="16">
+  <synapse id="13">
      <action_set>
        <rsc_op id="22" operation="start" operation_key="rsc7_start_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc7" long-id="bar:rsc7" class="heartbeat" type="apache"/>
@@ -214,25 +153,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="17">
-     <action_set>
-      <pseudo_event id="37" operation="stop" operation_key="rsc7_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="bar_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="38" operation="stop" operation_key="rsc8_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="18">
+  <synapse id="14">
      <action_set>
        <rsc_op id="9" operation="monitor" operation_key="rsc8_monitor_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc8" long-id="bar:rsc8" class="heartbeat" type="apache"/>
@@ -241,7 +162,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="19">
+  <synapse id="15">
      <action_set>
        <rsc_op id="16" operation="monitor" operation_key="rsc8_monitor_0" on_node="node2" on_node_uuid="node2">
          <primitive id="rsc8" long-id="bar:rsc8" class="heartbeat" type="apache"/>
@@ -250,7 +171,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="20">
+  <synapse id="16">
      <action_set>
        <rsc_op id="23" operation="start" operation_key="rsc8_start_0" on_node="node1" on_node_uuid="node1">
          <primitive id="rsc8" long-id="bar:rsc8" class="heartbeat" type="apache"/>
@@ -269,40 +190,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="21">
-     <action_set>
-      <pseudo_event id="38" operation="stop" operation_key="rsc8_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="bar_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="22">
-     <action_set>
-       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="36" operation="stop" operation_key="rsc6_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="37" operation="stop" operation_key="rsc7_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="38" operation="stop" operation_key="rsc8_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="23">
+  <synapse id="17">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -317,7 +205,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="24" priority="1000000">
+  <synapse id="18" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="node1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -344,7 +232,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="25" priority="1000000">
+  <synapse id="19" priority="1000000">
      <action_set>
        <rsc_op id="10" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="node2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group2.dot
--- a/pengine/test10/group2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,5 +1,4 @@
  digraph "g" {
-"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc1_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -7,9 +6,6 @@
 "child_rsc1_start_0 node2" -> "child_rsc2_start_0 node2" [ style = bold]
 "child_rsc1_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc1_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc1_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc1_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc2_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc2_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc2_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -17,33 +13,20 @@
 "child_rsc2_start_0 node2" -> "child_rsc3_start_0 node2" [ style = bold]
 "child_rsc2_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc2_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc2_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"child_rsc2_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "child_rsc3_monitor_0 node2" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc3_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc3_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc3_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"child_rsc3_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc1_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc2_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc2_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc3_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc3_stop_0" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" -> "rsc3_start_0 node1" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
@@ -59,14 +42,6 @@
 "rsc2_start_0" -> "child_rsc3_start_0 node2" [ style = bold]
 "rsc2_start_0" -> "rsc2_running_0" [ style = bold]
 "rsc2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc3_stop_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"rsc2_stopped_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "rsc3_monitor_0 node2" -> "probe_complete node2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group2.exp
--- a/pengine/test10/group2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -38,17 +38,8 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <rsc_op id="15" operation="start" operation_key="rsc1_start_0" on_node="node1" on_node_uuid="uuid1"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="22" operation="stopped" operation_key="rsc2_stopped_0"/>
-       </trigger>
      </inputs>
    </synapse>
    <synapse id="4">
@@ -74,39 +65,6 @@
    </synapse>
    <synapse id="5">
      <action_set>
-       <pseudo_event id="21" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="6">
-     <action_set>
-       <pseudo_event id="22" operation="stopped" operation_key="rsc2_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="28" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="29" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="30" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="7">
-     <action_set>
        <rsc_op id="5" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -114,7 +72,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="8">
+  <synapse id="6">
      <action_set>
        <rsc_op id="11" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
@@ -123,7 +81,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="9">
+  <synapse id="7">
      <action_set>
        <rsc_op id="16" operation="start" operation_key="child_rsc1_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
@@ -139,25 +97,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="10">
-     <action_set>
-      <pseudo_event id="28" operation="stop" operation_key="child_rsc1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="29" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="11">
+  <synapse id="8">
      <action_set>
        <rsc_op id="6" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -166,7 +106,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="12">
+  <synapse id="9">
      <action_set>
        <rsc_op id="12" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -175,7 +115,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="13">
+  <synapse id="10">
      <action_set>
        <rsc_op id="17" operation="start" operation_key="child_rsc2_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -194,25 +134,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="14">
-     <action_set>
-      <pseudo_event id="29" operation="stop" operation_key="child_rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="30" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="15">
+  <synapse id="11">
      <action_set>
        <rsc_op id="7" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -221,7 +143,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="16">
+  <synapse id="12">
      <action_set>
        <rsc_op id="13" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -230,7 +152,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="17">
+  <synapse id="13">
      <action_set>
        <rsc_op id="18" operation="start" operation_key="child_rsc3_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -249,22 +171,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18">
-     <action_set>
-      <pseudo_event id="30" operation="stop" operation_key="child_rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="19">
+  <synapse id="14">
      <action_set>
        <rsc_op id="8" operation="monitor" operation_key="rsc3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="rsc3" long-id="rsc3" class="heartbeat" type="apache"/>
@@ -273,7 +180,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="20">
+  <synapse id="15">
      <action_set>
        <rsc_op id="14" operation="monitor" operation_key="rsc3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc3" long-id="rsc3" class="heartbeat" type="apache"/>
@@ -282,7 +189,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="21">
+  <synapse id="16">
      <action_set>
        <rsc_op id="23" operation="start" operation_key="rsc3_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="rsc3" long-id="rsc3" class="heartbeat" type="apache"/>
@@ -298,25 +205,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="22">
-     <action_set>
-       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="28" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="29" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="30" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="23">
+  <synapse id="17">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -331,7 +220,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="24" priority="1000000">
+  <synapse id="18" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -355,7 +244,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="25" priority="1000000">
+  <synapse id="19" priority="1000000">
      <action_set>
        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group3.dot
--- a/pengine/test10/group3.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group3.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,5 +1,4 @@
  digraph "g" {
-"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc1_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -7,9 +6,6 @@
 "child_rsc1_start_0 node1" -> "child_rsc2_start_0 node1" [ style = bold]
 "child_rsc1_start_0 node1" -> "rsc1_running_0" [ style = bold]
 "child_rsc1_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc1_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc1_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"child_rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc2_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc2_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc2_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -17,20 +13,12 @@
 "child_rsc2_start_0 node1" -> "child_rsc3_start_0 node1" [ style = bold]
 "child_rsc2_start_0 node1" -> "rsc1_running_0" [ style = bold]
 "child_rsc2_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc2_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"child_rsc2_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"child_rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "child_rsc3_monitor_0 node2" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_start_0 node1" -> "rsc1_running_0" [ style = bold]
 "child_rsc3_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc3_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc3_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"child_rsc3_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"child_rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc4_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc4_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc4_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -38,9 +26,6 @@
 "child_rsc4_start_0 node2" -> "child_rsc5_start_0 node2" [ style = bold]
 "child_rsc4_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc4_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc4_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc4_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc4_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc5_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc5_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc5_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -48,40 +33,22 @@
 "child_rsc5_start_0 node2" -> "child_rsc6_start_0 node2" [ style = bold]
 "child_rsc5_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc5_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc5_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc5_stop_0" -> "child_rsc4_stop_0" [ style = bold]
-"child_rsc5_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc5_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc6_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc6_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc6_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "child_rsc6_monitor_0 node2" [ style=bold color="green" fontcolor="black" ]
 "child_rsc6_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc6_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc6_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc6_stop_0" -> "child_rsc5_stop_0" [ style = bold]
-"child_rsc6_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc6_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc1_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc2_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc2_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc3_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc3_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc4_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc4_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc5_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc5_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc6_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc6_stop_0" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" -> "rsc2_start_0" [ style = bold]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
@@ -90,27 +57,10 @@
 "rsc1_start_0" -> "child_rsc3_start_0 node1" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"rsc1_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"rsc1_stop_0" -> "child_rsc3_stop_0" [ style = bold]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" -> "rsc1_stopped_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"rsc1_stopped_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc2_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc2_start_0" -> "child_rsc4_start_0 node2" [ style = bold]
 "rsc2_start_0" -> "child_rsc5_start_0 node2" [ style = bold]
 "rsc2_start_0" -> "child_rsc6_start_0 node2" [ style = bold]
 "rsc2_start_0" -> "rsc2_running_0" [ style = bold]
 "rsc2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc2_stop_0" -> "child_rsc4_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc5_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc6_stop_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"rsc2_stopped_0" -> "rsc1_stop_0" [ style = bold]
-"rsc2_stopped_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group3.exp
--- a/pengine/test10/group3.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group3.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -5,17 +5,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="23" operation="stopped" operation_key="rsc1_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="1">
      <action_set>
@@ -40,42 +30,6 @@
    </synapse>
    <synapse id="2">
      <action_set>
-       <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="30" operation="stopped" operation_key="rsc2_stopped_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="3">
-     <action_set>
-       <pseudo_event id="23" operation="stopped" operation_key="rsc1_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="33" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="34" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="35" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="4">
-     <action_set>
        <rsc_op id="4" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc1:child_rsc1" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -83,7 +37,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="5">
+  <synapse id="3">
      <action_set>
        <rsc_op id="11" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc1" long-id="rsc1:child_rsc1" class="heartbeat" type="apache"/>
@@ -92,7 +46,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="6">
+  <synapse id="4">
      <action_set>
        <rsc_op id="17" operation="start" operation_key="child_rsc1_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc1:child_rsc1" class="heartbeat" type="apache"/>
@@ -108,25 +62,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="7">
-     <action_set>
-      <pseudo_event id="33" operation="stop" operation_key="child_rsc1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="34" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="8">
+  <synapse id="5">
      <action_set>
        <rsc_op id="5" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc1:child_rsc2" class="heartbeat" type="apache"/>
@@ -135,7 +71,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="9">
+  <synapse id="6">
      <action_set>
        <rsc_op id="12" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2" long-id="rsc1:child_rsc2" class="heartbeat" type="apache"/>
@@ -144,7 +80,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="10">
+  <synapse id="7">
      <action_set>
        <rsc_op id="18" operation="start" operation_key="child_rsc2_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc1:child_rsc2" class="heartbeat" type="apache"/>
@@ -163,25 +99,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="11">
-     <action_set>
-      <pseudo_event id="34" operation="stop" operation_key="child_rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="35" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="12">
+  <synapse id="8">
      <action_set>
        <rsc_op id="6" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc1:child_rsc3" class="heartbeat" type="apache"/>
@@ -190,7 +108,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="13">
+  <synapse id="9">
      <action_set>
        <rsc_op id="13" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc3" long-id="rsc1:child_rsc3" class="heartbeat" type="apache"/>
@@ -199,7 +117,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="14">
+  <synapse id="10">
      <action_set>
        <rsc_op id="19" operation="start" operation_key="child_rsc3_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc1:child_rsc3" class="heartbeat" type="apache"/>
@@ -218,22 +136,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="15">
-     <action_set>
-      <pseudo_event id="35" operation="stop" operation_key="child_rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="16">
+  <synapse id="11">
      <action_set>
        <pseudo_event id="27" operation="start" operation_key="rsc2_start_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -241,20 +144,11 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="21" operation="running" operation_key="rsc1_running_0"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="29" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="30" operation="stopped" operation_key="rsc2_stopped_0"/>
-       </trigger>
      </inputs>
    </synapse>
-   <synapse id="17">
+  <synapse id="12">
      <action_set>
        <pseudo_event id="28" operation="running" operation_key="rsc2_running_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -275,40 +169,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18">
-     <action_set>
-       <pseudo_event id="29" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="19">
-     <action_set>
-       <pseudo_event id="30" operation="stopped" operation_key="rsc2_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="29" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="36" operation="stop" operation_key="child_rsc4_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="37" operation="stop" operation_key="child_rsc5_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="38" operation="stop" operation_key="child_rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="20">
+  <synapse id="13">
      <action_set>
        <rsc_op id="7" operation="monitor" operation_key="child_rsc4_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc4" long-id="rsc2:child_rsc4" class="heartbeat" type="apache"/>
@@ -317,7 +178,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="21">
+  <synapse id="14">
      <action_set>
        <rsc_op id="14" operation="monitor" operation_key="child_rsc4_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc4" long-id="rsc2:child_rsc4" class="heartbeat" type="apache"/>
@@ -326,7 +187,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="22">
+  <synapse id="15">
      <action_set>
        <rsc_op id="24" operation="start" operation_key="child_rsc4_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc4" long-id="rsc2:child_rsc4" class="heartbeat" type="apache"/>
@@ -342,25 +203,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="23">
-     <action_set>
-      <pseudo_event id="36" operation="stop" operation_key="child_rsc4_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="29" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="37" operation="stop" operation_key="child_rsc5_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="24">
+  <synapse id="16">
      <action_set>
        <rsc_op id="8" operation="monitor" operation_key="child_rsc5_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc5" long-id="rsc2:child_rsc5" class="heartbeat" type="apache"/>
@@ -369,7 +212,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="25">
+  <synapse id="17">
      <action_set>
        <rsc_op id="15" operation="monitor" operation_key="child_rsc5_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc5" long-id="rsc2:child_rsc5" class="heartbeat" type="apache"/>
@@ -378,7 +221,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="26">
+  <synapse id="18">
      <action_set>
        <rsc_op id="25" operation="start" operation_key="child_rsc5_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc5" long-id="rsc2:child_rsc5" class="heartbeat" type="apache"/>
@@ -397,25 +240,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="27">
-     <action_set>
-      <pseudo_event id="37" operation="stop" operation_key="child_rsc5_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="29" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="38" operation="stop" operation_key="child_rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="28">
+  <synapse id="19">
      <action_set>
        <rsc_op id="9" operation="monitor" operation_key="child_rsc6_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc6" long-id="rsc2:child_rsc6" class="heartbeat" type="apache"/>
@@ -424,7 +249,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="29">
+  <synapse id="20">
      <action_set>
        <rsc_op id="16" operation="monitor" operation_key="child_rsc6_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc6" long-id="rsc2:child_rsc6" class="heartbeat" type="apache"/>
@@ -433,7 +258,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="30">
+  <synapse id="21">
      <action_set>
        <rsc_op id="26" operation="start" operation_key="child_rsc6_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc6" long-id="rsc2:child_rsc6" class="heartbeat" type="apache"/>
@@ -452,49 +277,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="31">
-     <action_set>
-      <pseudo_event id="38" operation="stop" operation_key="child_rsc6_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="29" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="32">
-     <action_set>
-       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="33" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="34" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="35" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="36" operation="stop" operation_key="child_rsc4_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="37" operation="stop" operation_key="child_rsc5_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="38" operation="stop" operation_key="child_rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="33">
+  <synapse id="22">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -509,7 +292,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="34" priority="1000000">
+  <synapse id="23" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -536,7 +319,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="35" priority="1000000">
+  <synapse id="24" priority="1000000">
      <action_set>
        <rsc_op id="10" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group5.dot
--- a/pengine/test10/group5.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group5.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -40,8 +40,6 @@
 "probe_complete" -> "child_rsc3_stop_0 node1" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node2" [ style = bold]
 "probe_complete" -> "rsc1_stop_0 node1" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" -> "rsc3_start_0 node2" [ style = bold]
 "probe_complete" -> "rsc3_stop_0 node1" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group5.exp
--- a/pengine/test10/group5.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group5.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -48,9 +48,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <rsc_op id="11" operation="start" operation_key="rsc1_start_0" on_node="node2" on_node_uuid="uuid2"/>
        </trigger>
        <trigger>
@@ -90,9 +87,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <rsc_op id="22" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="uuid1"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group6.dot
--- a/pengine/test10/group6.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group6.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -72,10 +72,6 @@
 "probe_complete" -> "child_rsc5_stop_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc6_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc6_stop_0 node1" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" -> "rsc2_start_0" [ style = bold]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group6.exp
--- a/pengine/test10/group6.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group6.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -7,9 +7,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="19" operation="stop" operation_key="rsc1_stop_0"/>
        </trigger>
        <trigger>
@@ -46,9 +43,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="30" operation="stopped" operation_key="rsc2_stopped_0"/>
        </trigger>
      </inputs>
@@ -226,9 +220,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="18" operation="running" operation_key="rsc1_running_0"/>
        </trigger>
        <trigger>
@@ -266,11 +257,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="16">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group7.dot
--- a/pengine/test10/group7.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group7.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,5 +1,4 @@
  digraph "g" {
-"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc1_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -9,9 +8,6 @@
 "child_rsc1_start_0 node2" -> "child_rsc2_start_0 node2" [ style = bold]
 "child_rsc1_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc1_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc1_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc1_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc2_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc2_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc2_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -21,10 +17,6 @@
 "child_rsc2_start_0 node2" -> "child_rsc3_start_0 node2" [ style = bold]
 "child_rsc2_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc2_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc2_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"child_rsc2_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -33,10 +25,6 @@
 "child_rsc3_monitor_0 node3" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_start_0 node2" -> "rsc2_running_0" [ style = bold]
 "child_rsc3_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc3_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc3_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"child_rsc3_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc4_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc4_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc4_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -46,9 +34,6 @@
 "child_rsc4_start_0 node2" -> "child_rsc5_start_0 node2" [ style = bold]
 "child_rsc4_start_0 node2" -> "rsc3_running_0" [ style = bold]
 "child_rsc4_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc4_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc4_stop_0" -> "rsc3_stopped_0" [ style = bold]
-"child_rsc4_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc5_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc5_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc5_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -58,10 +43,6 @@
 "child_rsc5_start_0 node2" -> "child_rsc6_start_0 node2" [ style = bold]
 "child_rsc5_start_0 node2" -> "rsc3_running_0" [ style = bold]
 "child_rsc5_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc5_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc5_stop_0" -> "child_rsc4_stop_0" [ style = bold]
-"child_rsc5_stop_0" -> "rsc3_stopped_0" [ style = bold]
-"child_rsc5_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc6_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc6_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc6_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -70,10 +51,6 @@
 "child_rsc6_monitor_0 node3" [ style=bold color="green" fontcolor="black" ]
 "child_rsc6_start_0 node2" -> "rsc3_running_0" [ style = bold]
 "child_rsc6_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"child_rsc6_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc6_stop_0" -> "child_rsc5_stop_0" [ style = bold]
-"child_rsc6_stop_0" -> "rsc3_stopped_0" [ style = bold]
-"child_rsc6_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
@@ -81,22 +58,12 @@
 "probe_complete node3" -> "probe_complete" [ style = bold]
 "probe_complete node3" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc1_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc2_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc2_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc3_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc3_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc4_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc4_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc5_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc5_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc6_start_0 node2" [ style = bold]
-"probe_complete" -> "child_rsc6_stop_0" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
-"probe_complete" -> "rsc3_start_0" [ style = bold]
-"probe_complete" -> "rsc3_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
@@ -112,27 +79,10 @@
 "rsc2_start_0" -> "child_rsc3_start_0 node2" [ style = bold]
 "rsc2_start_0" -> "rsc2_running_0" [ style = bold]
 "rsc2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc3_stop_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"rsc2_stopped_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc3_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc3_start_0" -> "child_rsc4_start_0 node2" [ style = bold]
 "rsc3_start_0" -> "child_rsc5_start_0 node2" [ style = bold]
 "rsc3_start_0" -> "child_rsc6_start_0 node2" [ style = bold]
 "rsc3_start_0" -> "rsc3_running_0" [ style = bold]
 "rsc3_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc3_stop_0" -> "child_rsc4_stop_0" [ style = bold]
-"rsc3_stop_0" -> "child_rsc5_stop_0" [ style = bold]
-"rsc3_stop_0" -> "child_rsc6_stop_0" [ style = bold]
-"rsc3_stop_0" -> "rsc3_start_0" [ style = bold]
-"rsc3_stop_0" -> "rsc3_stopped_0" [ style = bold]
-"rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"rsc3_stopped_0" -> "rsc2_stop_0" [ style = bold]
-"rsc3_stopped_0" -> "rsc3_start_0" [ style = bold]
-"rsc3_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group7.exp
--- a/pengine/test10/group7.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group7.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -45,17 +45,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="33" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="34" operation="stopped" operation_key="rsc2_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="5">
      <action_set>
@@ -80,42 +70,6 @@
    </synapse>
    <synapse id="6">
      <action_set>
-       <pseudo_event id="33" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="41" operation="stopped" operation_key="rsc3_stopped_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="7">
-     <action_set>
-       <pseudo_event id="34" operation="stopped" operation_key="rsc2_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="33" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="45" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="46" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="8">
-     <action_set>
        <rsc_op id="5" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -123,7 +77,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="9">
+  <synapse id="7">
      <action_set>
        <rsc_op id="13" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
@@ -132,7 +86,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="10">
+  <synapse id="8">
      <action_set>
        <rsc_op id="21" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
@@ -141,7 +95,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="11">
+  <synapse id="9">
      <action_set>
        <rsc_op id="28" operation="start" operation_key="child_rsc1_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
@@ -157,25 +111,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="12">
-     <action_set>
-      <pseudo_event id="45" operation="stop" operation_key="child_rsc1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="33" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="46" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="13">
+  <synapse id="10">
      <action_set>
        <rsc_op id="6" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -184,7 +120,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="14">
+  <synapse id="11">
      <action_set>
        <rsc_op id="14" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -193,7 +129,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="15">
+  <synapse id="12">
      <action_set>
        <rsc_op id="22" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -202,7 +138,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="16">
+  <synapse id="13">
      <action_set>
        <rsc_op id="29" operation="start" operation_key="child_rsc2_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -221,25 +157,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="17">
-     <action_set>
-      <pseudo_event id="46" operation="stop" operation_key="child_rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="33" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="18">
+  <synapse id="14">
      <action_set>
        <rsc_op id="7" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -248,7 +166,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="19">
+  <synapse id="15">
      <action_set>
        <rsc_op id="15" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -257,7 +175,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="20">
+  <synapse id="16">
      <action_set>
        <rsc_op id="23" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -266,7 +184,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="21">
+  <synapse id="17">
      <action_set>
        <rsc_op id="30" operation="start" operation_key="child_rsc3_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -285,22 +203,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="22">
-     <action_set>
-      <pseudo_event id="47" operation="stop" operation_key="child_rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="33" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="23">
+  <synapse id="18">
      <action_set>
        <pseudo_event id="38" operation="start" operation_key="rsc3_start_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -308,20 +211,11 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="32" operation="running" operation_key="rsc2_running_0"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="40" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="41" operation="stopped" operation_key="rsc3_stopped_0"/>
-       </trigger>
      </inputs>
    </synapse>
-   <synapse id="24">
+  <synapse id="19">
      <action_set>
        <pseudo_event id="39" operation="running" operation_key="rsc3_running_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -342,40 +236,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="25">
-     <action_set>
-       <pseudo_event id="40" operation="stop" operation_key="rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="26">
-     <action_set>
-       <pseudo_event id="41" operation="stopped" operation_key="rsc3_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="40" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="48" operation="stop" operation_key="child_rsc4_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="49" operation="stop" operation_key="child_rsc5_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="50" operation="stop" operation_key="child_rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="27">
+  <synapse id="20">
      <action_set>
        <rsc_op id="8" operation="monitor" operation_key="child_rsc4_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc4" long-id="rsc3:child_rsc4" class="heartbeat" type="apache"/>
@@ -384,7 +245,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="28">
+  <synapse id="21">
      <action_set>
        <rsc_op id="16" operation="monitor" operation_key="child_rsc4_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc4" long-id="rsc3:child_rsc4" class="heartbeat" type="apache"/>
@@ -393,7 +254,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="29">
+  <synapse id="22">
      <action_set>
        <rsc_op id="24" operation="monitor" operation_key="child_rsc4_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc4" long-id="rsc3:child_rsc4" class="heartbeat" type="apache"/>
@@ -402,7 +263,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="30">
+  <synapse id="23">
      <action_set>
        <rsc_op id="35" operation="start" operation_key="child_rsc4_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc4" long-id="rsc3:child_rsc4" class="heartbeat" type="apache"/>
@@ -418,25 +279,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="31">
-     <action_set>
-      <pseudo_event id="48" operation="stop" operation_key="child_rsc4_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="40" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="49" operation="stop" operation_key="child_rsc5_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="32">
+  <synapse id="24">
      <action_set>
        <rsc_op id="9" operation="monitor" operation_key="child_rsc5_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc5" long-id="rsc3:child_rsc5" class="heartbeat" type="apache"/>
@@ -445,7 +288,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="33">
+  <synapse id="25">
      <action_set>
        <rsc_op id="17" operation="monitor" operation_key="child_rsc5_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc5" long-id="rsc3:child_rsc5" class="heartbeat" type="apache"/>
@@ -454,7 +297,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="34">
+  <synapse id="26">
      <action_set>
        <rsc_op id="25" operation="monitor" operation_key="child_rsc5_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc5" long-id="rsc3:child_rsc5" class="heartbeat" type="apache"/>
@@ -463,7 +306,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="35">
+  <synapse id="27">
      <action_set>
        <rsc_op id="36" operation="start" operation_key="child_rsc5_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc5" long-id="rsc3:child_rsc5" class="heartbeat" type="apache"/>
@@ -482,25 +325,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="36">
-     <action_set>
-      <pseudo_event id="49" operation="stop" operation_key="child_rsc5_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="40" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="50" operation="stop" operation_key="child_rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="37">
+  <synapse id="28">
      <action_set>
        <rsc_op id="10" operation="monitor" operation_key="child_rsc6_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc6" long-id="rsc3:child_rsc6" class="heartbeat" type="apache"/>
@@ -509,7 +334,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="38">
+  <synapse id="29">
      <action_set>
        <rsc_op id="18" operation="monitor" operation_key="child_rsc6_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc6" long-id="rsc3:child_rsc6" class="heartbeat" type="apache"/>
@@ -518,7 +343,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="39">
+  <synapse id="30">
      <action_set>
        <rsc_op id="26" operation="monitor" operation_key="child_rsc6_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc6" long-id="rsc3:child_rsc6" class="heartbeat" type="apache"/>
@@ -527,7 +352,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="40">
+  <synapse id="31">
      <action_set>
        <rsc_op id="37" operation="start" operation_key="child_rsc6_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc6" long-id="rsc3:child_rsc6" class="heartbeat" type="apache"/>
@@ -546,49 +371,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="41">
-     <action_set>
-      <pseudo_event id="50" operation="stop" operation_key="child_rsc6_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="40" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="42">
-     <action_set>
-       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="45" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="46" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="48" operation="stop" operation_key="child_rsc4_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="49" operation="stop" operation_key="child_rsc5_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="50" operation="stop" operation_key="child_rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="43">
+  <synapse id="32">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -606,7 +389,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="44" priority="1000000">
+  <synapse id="33" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -636,7 +419,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="45" priority="1000000">
+  <synapse id="34" priority="1000000">
      <action_set>
        <rsc_op id="11" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -666,7 +449,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="46" priority="1000000">
+  <synapse id="35" priority="1000000">
      <action_set>
        <rsc_op id="19" operation="probe_complete" operation_key="probe_complete" on_node="node3" on_node_uuid="uuid3">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group8.dot
--- a/pengine/test10/group8.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group8.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,30 +1,18 @@
  digraph "g" {
-"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc1_start_0 node1" -> "child_rsc2_start_0 node1" [ style = bold]
 "child_rsc1_start_0 node1" -> "rsc2_running_0" [ style = bold]
 "child_rsc1_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc1_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc1_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc2_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc2_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc2_start_0 node1" -> "child_rsc3_start_0 node1" [ style = bold]
 "child_rsc2_start_0 node1" -> "rsc2_running_0" [ style = bold]
 "child_rsc2_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc2_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"child_rsc2_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc3_start_0 node1" -> "rsc2_running_0" [ style = bold]
 "child_rsc3_start_0 node1" [ style=bold color="green" fontcolor="black" ]
-"child_rsc3_stop_0" -> "all_stopped" [ style = bold]
-"child_rsc3_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"child_rsc3_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"child_rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_rsc4_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "child_rsc4_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "child_rsc5_monitor_0 node1" -> "probe_complete node1" [ style = bold]
@@ -34,14 +22,9 @@
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc1_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc2_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc2_stop_0" [ style = bold]
 "probe_complete" -> "child_rsc3_start_0 node1" [ style = bold]
-"probe_complete" -> "child_rsc3_stop_0" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc1_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
@@ -52,12 +35,4 @@
 "rsc2_start_0" -> "child_rsc3_start_0 node1" [ style = bold]
 "rsc2_start_0" -> "rsc2_running_0" [ style = bold]
 "rsc2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc2_stop_0" -> "child_rsc1_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc2_stop_0" [ style = bold]
-"rsc2_stop_0" -> "child_rsc3_stop_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stop_0" -> "rsc2_stopped_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"rsc2_stopped_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group8.exp
--- a/pengine/test10/group8.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group8.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -27,17 +27,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="17" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="18" operation="stopped" operation_key="rsc2_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="3">
      <action_set>
@@ -62,39 +52,6 @@
    </synapse>
    <synapse id="4">
      <action_set>
-       <pseudo_event id="17" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="5">
-     <action_set>
-       <pseudo_event id="18" operation="stopped" operation_key="rsc2_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="17" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="26" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="27" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="28" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="6">
-     <action_set>
        <rsc_op id="5" operation="monitor" operation_key="child_rsc1_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -102,7 +59,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="7">
+  <synapse id="5">
      <action_set>
        <rsc_op id="12" operation="start" operation_key="child_rsc1_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc1" long-id="rsc2:child_rsc1" class="heartbeat" type="apache"/>
@@ -118,25 +75,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="8">
-     <action_set>
-      <pseudo_event id="26" operation="stop" operation_key="child_rsc1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="17" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="27" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="9">
+  <synapse id="6">
      <action_set>
        <rsc_op id="6" operation="monitor" operation_key="child_rsc2_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -145,7 +84,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="10">
+  <synapse id="7">
      <action_set>
        <rsc_op id="13" operation="start" operation_key="child_rsc2_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2" long-id="rsc2:child_rsc2" class="heartbeat" type="apache"/>
@@ -164,25 +103,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="11">
-     <action_set>
-      <pseudo_event id="27" operation="stop" operation_key="child_rsc2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="17" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="28" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="12">
+  <synapse id="8">
      <action_set>
        <rsc_op id="7" operation="monitor" operation_key="child_rsc3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -191,7 +112,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="13">
+  <synapse id="9">
      <action_set>
        <rsc_op id="14" operation="start" operation_key="child_rsc3_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc3" long-id="rsc2:child_rsc3" class="heartbeat" type="apache"/>
@@ -210,22 +131,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="14">
-     <action_set>
-      <pseudo_event id="28" operation="stop" operation_key="child_rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="17" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="15">
+  <synapse id="10">
      <action_set>
        <rsc_op id="8" operation="monitor" operation_key="child_rsc4_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc4" long-id="rsc3:child_rsc4" class="heartbeat" type="apache"/>
@@ -234,7 +140,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="16">
+  <synapse id="11">
      <action_set>
        <rsc_op id="9" operation="monitor" operation_key="child_rsc5_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc5" long-id="rsc3:child_rsc5" class="heartbeat" type="apache"/>
@@ -243,7 +149,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="17">
+  <synapse id="12">
      <action_set>
        <rsc_op id="10" operation="monitor" operation_key="child_rsc6_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc6" long-id="rsc3:child_rsc6" class="heartbeat" type="apache"/>
@@ -252,25 +158,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="18">
-     <action_set>
-       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="26" operation="stop" operation_key="child_rsc1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="27" operation="stop" operation_key="child_rsc2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="28" operation="stop" operation_key="child_rsc3_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="19">
+  <synapse id="13">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -282,7 +170,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="20" priority="1000000">
+  <synapse id="14" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group9.dot
--- a/pengine/test10/group9.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group9.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -30,10 +30,6 @@
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "bar_start_0" [ style = bold]
-"probe_complete" -> "bar_stop_0" [ style = bold]
-"probe_complete" -> "foo_start_0" [ style = bold]
-"probe_complete" -> "foo_stop_0" [ style = bold]
 "probe_complete" -> "rsc4_start_0 node1" [ style = bold]
 "probe_complete" -> "rsc4_stop_0 node1" [ style = bold]
 "probe_complete" -> "rsc5_start_0 node1" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/group9.exp
--- a/pengine/test10/group9.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/group9.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -25,9 +25,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="26" operation="stop" operation_key="foo_stop_0"/>
        </trigger>
        <trigger>
@@ -59,11 +56,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="5">
      <action_set>
@@ -194,9 +187,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="35" operation="stop" operation_key="bar_stop_0"/>
        </trigger>
        <trigger>
@@ -231,11 +221,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="16">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc0.dot
--- a/pengine/test10/inc0.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc0.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -35,8 +35,6 @@
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc1:2_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:3_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_start_0" -> "child_rsc1:0_start_0 node1" [ style = bold]
@@ -45,6 +43,4 @@
 "rsc1_start_0" -> "child_rsc1:3_start_0 node2" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc0.exp
--- a/pengine/test10/inc0.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc0.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -159,14 +159,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="15" priority="1000000">
      <action_set>
@@ -194,18 +187,6 @@
    </synapse>
    <synapse id="16">
      <action_set>
-       <pseudo_event id="21" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="17">
-     <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -219,7 +200,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18" priority="1000000">
+  <synapse id="17" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -243,7 +224,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="19" priority="1000000">
+  <synapse id="18" priority="1000000">
      <action_set>
        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc1.dot
--- a/pengine/test10/inc1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -38,8 +38,6 @@
 "probe_complete" -> "child_rsc2:2_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc2:3_start_0 node1" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" -> "rsc3_start_0 node2" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_monitor_0 node1" -> "probe_complete node1" [ style = bold]
@@ -58,8 +56,6 @@
 "rsc2_start_0" -> "child_rsc2:3_start_0 node1" [ style = bold]
 "rsc2_start_0" -> "rsc2_running_0" [ style = bold]
 "rsc2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc2_stop_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc3_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc3_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "rsc3_monitor_0 node2" -> "probe_complete node2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc1.exp
--- a/pengine/test10/inc1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -198,14 +198,8 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <rsc_op id="19" operation="start" operation_key="rsc1_start_0" on_node="node1" on_node_uuid="uuid1"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
    <synapse id="18" priority="1000000">
@@ -234,18 +228,6 @@
    </synapse>
    <synapse id="19">
      <action_set>
-       <pseudo_event id="26" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="20">
-     <action_set>
        <rsc_op id="10" operation="monitor" operation_key="rsc3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="rsc3" long-id="rsc3" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -253,7 +235,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="21">
+  <synapse id="20">
      <action_set>
        <rsc_op id="18" operation="monitor" operation_key="rsc3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc3" long-id="rsc3" class="heartbeat" type="apache"/>
@@ -262,7 +244,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="22">
+  <synapse id="21">
      <action_set>
        <rsc_op id="28" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc3" long-id="rsc3" class="heartbeat" type="apache"/>
@@ -284,7 +266,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="23">
+  <synapse id="22">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -299,7 +281,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="24" priority="1000000">
+  <synapse id="23" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -329,7 +311,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="25" priority="1000000">
+  <synapse id="24" priority="1000000">
      <action_set>
        <rsc_op id="11" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc11.dot
--- a/pengine/test10/inc11.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc11.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -26,8 +26,6 @@
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1:0_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" -> "simple-rsc_start_0 node2" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_promote_0" -> "child_rsc1:1_promote_0 node2" [ style = bold]
@@ -40,8 +38,6 @@
 "rsc1_start_0" -> "rsc1_promote_0" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "simple-rsc_monitor_0 node0" -> "probe_complete node0" [ style = bold]
 "simple-rsc_monitor_0 node0" [ style=bold color="green" fontcolor="black" ]
 "simple-rsc_monitor_0 node1" -> "probe_complete node1" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc11.exp
--- a/pengine/test10/inc11.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc11.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -147,14 +147,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="14" priority="1000000">
      <action_set>
@@ -176,18 +169,6 @@
    </synapse>
    <synapse id="15">
      <action_set>
-       <pseudo_event id="21" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="16">
-     <action_set>
        <pseudo_event id="23" operation="promote" operation_key="rsc1_promote_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -201,7 +182,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="17" priority="1000000">
+  <synapse id="16" priority="1000000">
      <action_set>
        <pseudo_event id="24" operation="promoted" operation_key="rsc1_promoted_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -213,7 +194,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18">
+  <synapse id="17">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -231,7 +212,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="19" priority="1000000">
+  <synapse id="18" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node0" on_node_uuid="uuid0">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -249,7 +230,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="20" priority="1000000">
+  <synapse id="19" priority="1000000">
      <action_set>
        <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -267,7 +248,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="21" priority="1000000">
+  <synapse id="20" priority="1000000">
      <action_set>
        <rsc_op id="11" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc2.dot
--- a/pengine/test10/inc2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -32,8 +32,6 @@
 "probe_complete" -> "child_rsc1:3_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc1:3_stop_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:4_stop_0 node1" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_start_0" -> "child_rsc1:2_start_0 node2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc2.exp
--- a/pengine/test10/inc2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -138,9 +138,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="21" operation="stop" operation_key="rsc1_stop_0"/>
        </trigger>
        <trigger>
@@ -172,11 +169,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="13" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc3.dot
--- a/pengine/test10/inc3.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc3.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -60,10 +60,6 @@
 "probe_complete" -> "child_rsc2:3_stop_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc2:4_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc2:4_stop_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" -> "rsc2_start_0" [ style = bold]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc3.exp
--- a/pengine/test10/inc3.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc3.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -138,9 +138,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="26" operation="stop" operation_key="rsc1_stop_0"/>
        </trigger>
        <trigger>
@@ -174,9 +171,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="41" operation="stopped" operation_key="rsc2_stopped_0"/>
        </trigger>
      </inputs>
@@ -325,9 +319,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="25" operation="running" operation_key="rsc1_running_0"/>
        </trigger>
        <trigger>
@@ -362,11 +353,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="3" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="26" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc4.dot
--- a/pengine/test10/inc4.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc4.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -65,10 +65,6 @@
 "probe_complete" -> "child_rsc2:3_stop_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc2:4_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc2:4_stop_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" -> "rsc2_start_0" [ style = bold]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc4.exp
--- a/pengine/test10/inc4.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc4.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -147,9 +147,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="26" operation="stop" operation_key="rsc1_stop_0"/>
        </trigger>
        <trigger>
@@ -183,9 +180,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="41" operation="stopped" operation_key="rsc2_stopped_0"/>
        </trigger>
      </inputs>
@@ -340,9 +334,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="25" operation="running" operation_key="rsc1_running_0"/>
        </trigger>
        <trigger>
@@ -377,11 +368,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="3" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
   <synapse id="26" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc5.dot
--- a/pengine/test10/inc5.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc5.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -100,14 +100,6 @@
 "probe_complete" -> "child_rsc5:1_stop_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc7:1_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc7:1_stop_0 node2" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
-"probe_complete" -> "rsc4_start_0" [ style = bold]
-"probe_complete" -> "rsc4_stop_0" [ style = bold]
-"probe_complete" -> "rsc5_start_0" [ style = bold]
-"probe_complete" -> "rsc5_stop_0" [ style = bold]
-"probe_complete" -> "rsc7_start_0" [ style = bold]
-"probe_complete" -> "rsc7_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc2_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc2_start_0" -> "child_rsc2:1_start_0 node2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc5.exp
--- a/pengine/test10/inc5.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc5.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -114,9 +114,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="51" operation="stop" operation_key="rsc2_stop_0"/>
        </trigger>
        <trigger>
@@ -145,11 +142,7 @@
         <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="13" priority="1000000">
      <action_set>
@@ -281,9 +274,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="67" operation="stop" operation_key="rsc4_stop_0"/>
        </trigger>
        <trigger>
@@ -312,11 +302,7 @@
         <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="27" priority="1000000">
      <action_set>
@@ -412,9 +398,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="75" operation="stop" operation_key="rsc5_stop_0"/>
        </trigger>
        <trigger>
@@ -443,11 +426,7 @@
         <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="37" priority="1000000">
      <action_set>
@@ -579,9 +558,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="91" operation="stop" operation_key="rsc7_stop_0"/>
        </trigger>
        <trigger>
@@ -610,11 +586,7 @@
         <attributes CRM_meta_clone_max="3" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="51" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc7.dot
--- a/pengine/test10/inc7.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc7.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -101,10 +101,6 @@
 "probe_complete" -> "child_rsc2:3_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc2:4_start_0 node3" [ style = bold]
 "probe_complete" -> "rsc0_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc0_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc0_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
@@ -121,8 +117,6 @@
 "rsc1_start_0" -> "child_rsc1:4_start_0 node2" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc2_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc2_start_0" -> "child_rsc2:0_start_0 node2" [ style = bold]
 "rsc2_start_0" -> "child_rsc2:1_start_0 node3" [ style = bold]
@@ -131,6 +125,4 @@
 "rsc2_start_0" -> "child_rsc2:4_start_0 node3" [ style = bold]
 "rsc2_start_0" -> "rsc2_running_0" [ style = bold]
 "rsc2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc2_stop_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc7.exp
--- a/pengine/test10/inc7.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc7.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -260,14 +260,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="47" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="25" priority="1000000">
      <action_set>
@@ -298,18 +291,6 @@
    </synapse>
    <synapse id="26">
      <action_set>
-       <pseudo_event id="47" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="27">
-     <action_set>
        <rsc_op id="10" operation="monitor" operation_key="child_rsc2:0_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2:0" long-id="rsc2:child_rsc2:0" class="heartbeat" type="apache"/>
         <attributes CRM_meta_clone="0" CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -317,7 +298,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="28">
+  <synapse id="27">
      <action_set>
        <rsc_op id="22" operation="monitor" operation_key="child_rsc2:0_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2:0" long-id="rsc2:child_rsc2:0" class="heartbeat" type="apache"/>
@@ -326,7 +307,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="29">
+  <synapse id="28">
      <action_set>
        <rsc_op id="34" operation="monitor" operation_key="child_rsc2:0_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2:0" long-id="rsc2:child_rsc2:0" class="heartbeat" type="apache"/>
@@ -335,7 +316,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="30">
+  <synapse id="29">
      <action_set>
        <rsc_op id="49" operation="start" operation_key="child_rsc2:0_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2:0" long-id="rsc2:child_rsc2:0" class="heartbeat" type="apache"/>
@@ -354,7 +335,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="31">
+  <synapse id="30">
      <action_set>
        <rsc_op id="11" operation="monitor" operation_key="child_rsc2:1_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2:1" long-id="rsc2:child_rsc2:1" class="heartbeat" type="apache"/>
@@ -363,7 +344,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="32">
+  <synapse id="31">
      <action_set>
        <rsc_op id="23" operation="monitor" operation_key="child_rsc2:1_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2:1" long-id="rsc2:child_rsc2:1" class="heartbeat" type="apache"/>
@@ -372,7 +353,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="33">
+  <synapse id="32">
      <action_set>
        <rsc_op id="35" operation="monitor" operation_key="child_rsc2:1_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2:1" long-id="rsc2:child_rsc2:1" class="heartbeat" type="apache"/>
@@ -381,7 +362,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="34">
+  <synapse id="33">
      <action_set>
        <rsc_op id="50" operation="start" operation_key="child_rsc2:1_start_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2:1" long-id="rsc2:child_rsc2:1" class="heartbeat" type="apache"/>
@@ -400,7 +381,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="35">
+  <synapse id="34">
      <action_set>
        <rsc_op id="12" operation="monitor" operation_key="child_rsc2:2_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2:2" long-id="rsc2:child_rsc2:2" class="heartbeat" type="apache"/>
@@ -409,7 +390,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="36">
+  <synapse id="35">
      <action_set>
        <rsc_op id="24" operation="monitor" operation_key="child_rsc2:2_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2:2" long-id="rsc2:child_rsc2:2" class="heartbeat" type="apache"/>
@@ -418,7 +399,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="37">
+  <synapse id="36">
      <action_set>
        <rsc_op id="36" operation="monitor" operation_key="child_rsc2:2_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2:2" long-id="rsc2:child_rsc2:2" class="heartbeat" type="apache"/>
@@ -427,7 +408,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="38">
+  <synapse id="37">
      <action_set>
        <rsc_op id="51" operation="start" operation_key="child_rsc2:2_start_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2:2" long-id="rsc2:child_rsc2:2" class="heartbeat" type="apache"/>
@@ -446,7 +427,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="39">
+  <synapse id="38">
      <action_set>
        <rsc_op id="13" operation="monitor" operation_key="child_rsc2:3_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2:3" long-id="rsc2:child_rsc2:3" class="heartbeat" type="apache"/>
@@ -455,7 +436,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="40">
+  <synapse id="39">
      <action_set>
        <rsc_op id="25" operation="monitor" operation_key="child_rsc2:3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2:3" long-id="rsc2:child_rsc2:3" class="heartbeat" type="apache"/>
@@ -464,7 +445,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="41">
+  <synapse id="40">
      <action_set>
        <rsc_op id="37" operation="monitor" operation_key="child_rsc2:3_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2:3" long-id="rsc2:child_rsc2:3" class="heartbeat" type="apache"/>
@@ -473,7 +454,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="42">
+  <synapse id="41">
      <action_set>
        <rsc_op id="52" operation="start" operation_key="child_rsc2:3_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2:3" long-id="rsc2:child_rsc2:3" class="heartbeat" type="apache"/>
@@ -492,7 +473,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="43">
+  <synapse id="42">
      <action_set>
        <rsc_op id="14" operation="monitor" operation_key="child_rsc2:4_monitor_0" on_node="node1" on_node_uuid="uuid1">
          <primitive id="child_rsc2:4" long-id="rsc2:child_rsc2:4" class="heartbeat" type="apache"/>
@@ -501,7 +482,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="44">
+  <synapse id="43">
      <action_set>
        <rsc_op id="26" operation="monitor" operation_key="child_rsc2:4_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="child_rsc2:4" long-id="rsc2:child_rsc2:4" class="heartbeat" type="apache"/>
@@ -510,7 +491,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="45">
+  <synapse id="44">
      <action_set>
        <rsc_op id="38" operation="monitor" operation_key="child_rsc2:4_monitor_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2:4" long-id="rsc2:child_rsc2:4" class="heartbeat" type="apache"/>
@@ -519,7 +500,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="46">
+  <synapse id="45">
      <action_set>
        <rsc_op id="53" operation="start" operation_key="child_rsc2:4_start_0" on_node="node3" on_node_uuid="uuid3">
          <primitive id="child_rsc2:4" long-id="rsc2:child_rsc2:4" class="heartbeat" type="apache"/>
@@ -538,22 +519,15 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="47">
+  <synapse id="46">
      <action_set>
        <pseudo_event id="54" operation="start" operation_key="rsc2_start_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="56" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
-   <synapse id="48" priority="1000000">
+  <synapse id="47" priority="1000000">
      <action_set>
        <pseudo_event id="55" operation="running" operation_key="rsc2_running_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -580,19 +554,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="49">
-     <action_set>
-       <pseudo_event id="56" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="50">
+  <synapse id="48">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -610,7 +572,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="51" priority="1000000">
+  <synapse id="49" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -652,7 +614,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="52" priority="1000000">
+  <synapse id="50" priority="1000000">
      <action_set>
        <rsc_op id="15" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -694,7 +656,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="53" priority="1000000">
+  <synapse id="51" priority="1000000">
      <action_set>
        <rsc_op id="27" operation="probe_complete" operation_key="probe_complete" on_node="node3" on_node_uuid="uuid3">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc7.scores
--- a/pengine/test10/inc7.scores	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc7.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -54,17 +54,17 @@ native_color: child_rsc2:4 allocation sc
 native_color: child_rsc2:4 allocation score on node2: -INFINITY
 native_color: child_rsc2:4 allocation score on node3: 0
 native_color: child_rsc1:0 allocation score on node1: 0
-native_color: child_rsc1:0 allocation score on node2: 0
-native_color: child_rsc1:0 allocation score on node3: 0
-native_color: child_rsc1:1 allocation score on node1: 0
+native_color: child_rsc1:0 allocation score on node2: -INFINITY
+native_color: child_rsc1:0 allocation score on node3: -INFINITY
+native_color: child_rsc1:1 allocation score on node1: -INFINITY
 native_color: child_rsc1:1 allocation score on node2: 0
-native_color: child_rsc1:1 allocation score on node3: 0
-native_color: child_rsc1:2 allocation score on node1: 0
-native_color: child_rsc1:2 allocation score on node2: 0
+native_color: child_rsc1:1 allocation score on node3: -INFINITY
+native_color: child_rsc1:2 allocation score on node1: -INFINITY
+native_color: child_rsc1:2 allocation score on node2: -INFINITY
 native_color: child_rsc1:2 allocation score on node3: 0
 native_color: child_rsc1:3 allocation score on node1: 0
-native_color: child_rsc1:3 allocation score on node2: 0
-native_color: child_rsc1:3 allocation score on node3: 0
+native_color: child_rsc1:3 allocation score on node2: -INFINITY
+native_color: child_rsc1:3 allocation score on node3: -INFINITY
 native_color: child_rsc1:4 allocation score on node1: -INFINITY
 native_color: child_rsc1:4 allocation score on node2: 0
-native_color: child_rsc1:4 allocation score on node3: 0
+native_color: child_rsc1:4 allocation score on node3: -INFINITY
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc8.dot
--- a/pengine/test10/inc8.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc8.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -50,8 +50,6 @@
 "probe_complete" -> "child_rsc2:0_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc2:1_start_0 node1" [ style = bold]
 "probe_complete" -> "rsc0_start_0 node1" [ style = bold]
-"probe_complete" -> "rsc2_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc0_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "rsc0_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
@@ -63,6 +61,4 @@
 "rsc2_start_0" -> "child_rsc2:1_start_0 node1" [ style = bold]
 "rsc2_start_0" -> "rsc2_running_0" [ style = bold]
 "rsc2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc2_stop_0" -> "rsc2_start_0" [ style = bold]
-"rsc2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/inc8.exp
--- a/pengine/test10/inc8.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/inc8.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -248,14 +248,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="36" operation="stop" operation_key="rsc2_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="26" priority="1000000">
      <action_set>
@@ -277,18 +270,6 @@
    </synapse>
    <synapse id="27">
      <action_set>
-       <pseudo_event id="36" operation="stop" operation_key="rsc2_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="28">
-     <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -302,7 +283,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="29" priority="1000000">
+  <synapse id="28" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -344,7 +325,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="30" priority="1000000">
+  <synapse id="29" priority="1000000">
      <action_set>
        <rsc_op id="15" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-0.dot
--- a/pengine/test10/interleave-0.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-0.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -10,8 +10,6 @@
 "CloneSet_start_0" -> "child_CloneSet:6_start_0 c001n07" [ style = bold]
 "CloneSet_start_0" -> "child_CloneSet:7_start_0 c001n08" [ style = bold]
 "CloneSet_start_0" [ style=bold color="green" fontcolor="orange" ]
-"CloneSet_stop_0" -> "CloneSet_start_0" [ style = bold]
-"CloneSet_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "DcIPaddr_monitor_0 c001n02" -> "probe_complete c001n02" [ style = bold]
 "DcIPaddr_monitor_0 c001n02" [ style=bold color="green" fontcolor="black" ]
 "DcIPaddr_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
@@ -262,8 +260,6 @@
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n09" -> "probe_complete" [ style = bold]
 "probe_complete c001n09" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "CloneSet_start_0" [ style = bold]
-"probe_complete" -> "CloneSet_stop_0" [ style = bold]
 "probe_complete" -> "child_CloneSet:0_start_0 c001n09" [ style = bold]
 "probe_complete" -> "child_CloneSet:1_start_0 c001n02" [ style = bold]
 "probe_complete" -> "child_CloneSet:2_start_0 c001n03" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-0.exp
--- a/pengine/test10/interleave-0.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-0.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1551,14 +1551,7 @@
         <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="163" priority="1000000">
      <action_set>
@@ -1598,18 +1591,6 @@
    </synapse>
    <synapse id="164">
      <action_set>
-       <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0">
-        <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="165">
-     <action_set>
        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -1641,7 +1622,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="166" priority="1000000">
+  <synapse id="165" priority="1000000">
      <action_set>
        <rsc_op id="19" operation="probe_complete" operation_key="probe_complete" on_node="c001n09" on_node_uuid="f67904e0-4dfc-4db1-83a2-e930fc1d20f4">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1710,7 +1691,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="167" priority="1000000">
+  <synapse id="166" priority="1000000">
      <action_set>
        <rsc_op id="40" operation="probe_complete" operation_key="probe_complete" on_node="c001n02" on_node_uuid="e9bdfde9-01b0-421f-acd8-8a65a53e775f">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1770,7 +1751,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="168" priority="1000000">
+  <synapse id="167" priority="1000000">
      <action_set>
        <rsc_op id="58" operation="probe_complete" operation_key="probe_complete" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1827,7 +1808,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="169" priority="1000000">
+  <synapse id="168" priority="1000000">
      <action_set>
        <rsc_op id="75" operation="probe_complete" operation_key="probe_complete" on_node="c001n04" on_node_uuid="c2896699-96b8-4dbc-a94e-6c3b9252b559">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1893,7 +1874,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="170" priority="1000000">
+  <synapse id="169" priority="1000000">
      <action_set>
        <rsc_op id="95" operation="probe_complete" operation_key="probe_complete" on_node="c001n05" on_node_uuid="c13968a2-bcf0-41f6-9133-01e5bbb63cd5">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1962,7 +1943,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="171" priority="1000000">
+  <synapse id="170" priority="1000000">
      <action_set>
        <rsc_op id="116" operation="probe_complete" operation_key="probe_complete" on_node="c001n06" on_node_uuid="f91e6074-699d-48af-80d6-223132f291e2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2004,7 +1985,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="172" priority="1000000">
+  <synapse id="171" priority="1000000">
      <action_set>
        <rsc_op id="128" operation="probe_complete" operation_key="probe_complete" on_node="c001n07" on_node_uuid="208d89a6-e052-4e9d-973d-07c9036c506b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2076,7 +2057,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="173" priority="1000000">
+  <synapse id="172" priority="1000000">
      <action_set>
        <rsc_op id="150" operation="probe_complete" operation_key="probe_complete" on_node="c001n08" on_node_uuid="6427cb5a-c7a5-4bdf-9892-a04ce56f4e6b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-1.dot
--- a/pengine/test10/interleave-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -10,8 +10,6 @@
 "CloneSet_start_0" -> "child_CloneSet:6_start_0 c001n07" [ style = bold]
 "CloneSet_start_0" -> "child_CloneSet:7_start_0 c001n08" [ style = bold]
 "CloneSet_start_0" [ style=bold color="green" fontcolor="orange" ]
-"CloneSet_stop_0" -> "CloneSet_start_0" [ style = bold]
-"CloneSet_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "DcIPaddr_monitor_0 c001n02" -> "probe_complete c001n02" [ style = bold]
 "DcIPaddr_monitor_0 c001n02" [ style=bold color="green" fontcolor="black" ]
 "DcIPaddr_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
@@ -262,8 +260,6 @@
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n09" -> "probe_complete" [ style = bold]
 "probe_complete c001n09" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "CloneSet_start_0" [ style = bold]
-"probe_complete" -> "CloneSet_stop_0" [ style = bold]
 "probe_complete" -> "child_CloneSet:0_start_0 c001n09" [ style = bold]
 "probe_complete" -> "child_CloneSet:1_start_0 c001n02" [ style = bold]
 "probe_complete" -> "child_CloneSet:2_start_0 c001n03" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-1.exp
--- a/pengine/test10/interleave-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1551,14 +1551,7 @@
         <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="163" priority="1000000">
      <action_set>
@@ -1598,18 +1591,6 @@
    </synapse>
    <synapse id="164">
      <action_set>
-       <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0">
-        <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="165">
-     <action_set>
        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -1641,7 +1622,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="166" priority="1000000">
+  <synapse id="165" priority="1000000">
      <action_set>
        <rsc_op id="19" operation="probe_complete" operation_key="probe_complete" on_node="c001n09" on_node_uuid="f67904e0-4dfc-4db1-83a2-e930fc1d20f4">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1710,7 +1691,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="167" priority="1000000">
+  <synapse id="166" priority="1000000">
      <action_set>
        <rsc_op id="40" operation="probe_complete" operation_key="probe_complete" on_node="c001n02" on_node_uuid="e9bdfde9-01b0-421f-acd8-8a65a53e775f">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1770,7 +1751,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="168" priority="1000000">
+  <synapse id="167" priority="1000000">
      <action_set>
        <rsc_op id="58" operation="probe_complete" operation_key="probe_complete" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1827,7 +1808,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="169" priority="1000000">
+  <synapse id="168" priority="1000000">
      <action_set>
        <rsc_op id="75" operation="probe_complete" operation_key="probe_complete" on_node="c001n04" on_node_uuid="c2896699-96b8-4dbc-a94e-6c3b9252b559">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1893,7 +1874,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="170" priority="1000000">
+  <synapse id="169" priority="1000000">
      <action_set>
        <rsc_op id="95" operation="probe_complete" operation_key="probe_complete" on_node="c001n05" on_node_uuid="c13968a2-bcf0-41f6-9133-01e5bbb63cd5">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1962,7 +1943,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="171" priority="1000000">
+  <synapse id="170" priority="1000000">
      <action_set>
        <rsc_op id="116" operation="probe_complete" operation_key="probe_complete" on_node="c001n06" on_node_uuid="f91e6074-699d-48af-80d6-223132f291e2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2004,7 +1985,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="172" priority="1000000">
+  <synapse id="171" priority="1000000">
      <action_set>
        <rsc_op id="128" operation="probe_complete" operation_key="probe_complete" on_node="c001n07" on_node_uuid="208d89a6-e052-4e9d-973d-07c9036c506b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2076,7 +2057,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="173" priority="1000000">
+  <synapse id="172" priority="1000000">
      <action_set>
        <rsc_op id="150" operation="probe_complete" operation_key="probe_complete" on_node="c001n08" on_node_uuid="6427cb5a-c7a5-4bdf-9892-a04ce56f4e6b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-2.dot
--- a/pengine/test10/interleave-2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -10,8 +10,6 @@
 "CloneSet_start_0" -> "child_CloneSet:6_start_0 c001n07" [ style = bold]
 "CloneSet_start_0" -> "child_CloneSet:7_start_0 c001n08" [ style = bold]
 "CloneSet_start_0" [ style=bold color="green" fontcolor="orange" ]
-"CloneSet_stop_0" -> "CloneSet_start_0" [ style = bold]
-"CloneSet_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "DcIPaddr_monitor_0 c001n02" -> "probe_complete c001n02" [ style = bold]
 "DcIPaddr_monitor_0 c001n02" [ style=bold color="green" fontcolor="black" ]
 "DcIPaddr_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
@@ -262,8 +260,6 @@
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n09" -> "probe_complete" [ style = bold]
 "probe_complete c001n09" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "CloneSet_start_0" [ style = bold]
-"probe_complete" -> "CloneSet_stop_0" [ style = bold]
 "probe_complete" -> "child_CloneSet:0_start_0 c001n09" [ style = bold]
 "probe_complete" -> "child_CloneSet:1_start_0 c001n02" [ style = bold]
 "probe_complete" -> "child_CloneSet:2_start_0 c001n03" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-2.exp
--- a/pengine/test10/interleave-2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1551,14 +1551,7 @@
         <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="163" priority="1000000">
      <action_set>
@@ -1598,18 +1591,6 @@
    </synapse>
    <synapse id="164">
      <action_set>
-       <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0">
-        <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="165">
-     <action_set>
        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -1641,7 +1622,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="166" priority="1000000">
+  <synapse id="165" priority="1000000">
      <action_set>
        <rsc_op id="19" operation="probe_complete" operation_key="probe_complete" on_node="c001n09" on_node_uuid="f67904e0-4dfc-4db1-83a2-e930fc1d20f4">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1710,7 +1691,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="167" priority="1000000">
+  <synapse id="166" priority="1000000">
      <action_set>
        <rsc_op id="40" operation="probe_complete" operation_key="probe_complete" on_node="c001n02" on_node_uuid="e9bdfde9-01b0-421f-acd8-8a65a53e775f">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1770,7 +1751,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="168" priority="1000000">
+  <synapse id="167" priority="1000000">
      <action_set>
        <rsc_op id="58" operation="probe_complete" operation_key="probe_complete" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1827,7 +1808,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="169" priority="1000000">
+  <synapse id="168" priority="1000000">
      <action_set>
        <rsc_op id="75" operation="probe_complete" operation_key="probe_complete" on_node="c001n04" on_node_uuid="c2896699-96b8-4dbc-a94e-6c3b9252b559">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1893,7 +1874,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="170" priority="1000000">
+  <synapse id="169" priority="1000000">
      <action_set>
        <rsc_op id="95" operation="probe_complete" operation_key="probe_complete" on_node="c001n05" on_node_uuid="c13968a2-bcf0-41f6-9133-01e5bbb63cd5">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1962,7 +1943,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="171" priority="1000000">
+  <synapse id="170" priority="1000000">
      <action_set>
        <rsc_op id="116" operation="probe_complete" operation_key="probe_complete" on_node="c001n06" on_node_uuid="f91e6074-699d-48af-80d6-223132f291e2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2004,7 +1985,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="172" priority="1000000">
+  <synapse id="171" priority="1000000">
      <action_set>
        <rsc_op id="128" operation="probe_complete" operation_key="probe_complete" on_node="c001n07" on_node_uuid="208d89a6-e052-4e9d-973d-07c9036c506b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2076,7 +2057,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="173" priority="1000000">
+  <synapse id="172" priority="1000000">
      <action_set>
        <rsc_op id="150" operation="probe_complete" operation_key="probe_complete" on_node="c001n08" on_node_uuid="6427cb5a-c7a5-4bdf-9892-a04ce56f4e6b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-2.scores
--- a/pengine/test10/interleave-2.scores	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-2.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -280,53 +280,53 @@ clone_color: child_CloneSet:7 allocation
 clone_color: child_CloneSet:7 allocation score on c001n07: 0
 clone_color: child_CloneSet:7 allocation score on c001n08: 0
 native_color: child_CloneSet:0 allocation score on c001n09: 0
-native_color: child_CloneSet:0 allocation score on c001n02: 0
-native_color: child_CloneSet:0 allocation score on c001n03: 0
-native_color: child_CloneSet:0 allocation score on c001n04: 0
-native_color: child_CloneSet:0 allocation score on c001n05: 0
-native_color: child_CloneSet:0 allocation score on c001n06: 0
-native_color: child_CloneSet:0 allocation score on c001n07: 0
-native_color: child_CloneSet:0 allocation score on c001n08: 0
+native_color: child_CloneSet:0 allocation score on c001n02: -INFINITY
+native_color: child_CloneSet:0 allocation score on c001n03: -INFINITY
+native_color: child_CloneSet:0 allocation score on c001n04: -INFINITY
+native_color: child_CloneSet:0 allocation score on c001n05: -INFINITY
+native_color: child_CloneSet:0 allocation score on c001n06: -INFINITY
+native_color: child_CloneSet:0 allocation score on c001n07: -INFINITY
+native_color: child_CloneSet:0 allocation score on c001n08: -INFINITY
 native_color: child_CloneSet:1 allocation score on c001n09: -INFINITY
 native_color: child_CloneSet:1 allocation score on c001n02: 0
-native_color: child_CloneSet:1 allocation score on c001n03: 0
-native_color: child_CloneSet:1 allocation score on c001n04: 0
-native_color: child_CloneSet:1 allocation score on c001n05: 0
-native_color: child_CloneSet:1 allocation score on c001n06: 0
-native_color: child_CloneSet:1 allocation score on c001n07: 0
-native_color: child_CloneSet:1 allocation score on c001n08: 0
+native_color: child_CloneSet:1 allocation score on c001n03: -INFINITY
+native_color: child_CloneSet:1 allocation score on c001n04: -INFINITY
+native_color: child_CloneSet:1 allocation score on c001n05: -INFINITY
+native_color: child_CloneSet:1 allocation score on c001n06: -INFINITY
+native_color: child_CloneSet:1 allocation score on c001n07: -INFINITY
+native_color: child_CloneSet:1 allocation score on c001n08: -INFINITY
 native_color: child_CloneSet:2 allocation score on c001n09: -INFINITY
 native_color: child_CloneSet:2 allocation score on c001n02: -INFINITY
 native_color: child_CloneSet:2 allocation score on c001n03: 0
-native_color: child_CloneSet:2 allocation score on c001n04: 0
-native_color: child_CloneSet:2 allocation score on c001n05: 0
-native_color: child_CloneSet:2 allocation score on c001n06: 0
-native_color: child_CloneSet:2 allocation score on c001n07: 0
-native_color: child_CloneSet:2 allocation score on c001n08: 0
+native_color: child_CloneSet:2 allocation score on c001n04: -INFINITY
+native_color: child_CloneSet:2 allocation score on c001n05: -INFINITY
+native_color: child_CloneSet:2 allocation score on c001n06: -INFINITY
+native_color: child_CloneSet:2 allocation score on c001n07: -INFINITY
+native_color: child_CloneSet:2 allocation score on c001n08: -INFINITY
 native_color: child_CloneSet:3 allocation score on c001n09: -INFINITY
 native_color: child_CloneSet:3 allocation score on c001n02: -INFINITY
 native_color: child_CloneSet:3 allocation score on c001n03: -INFINITY
 native_color: child_CloneSet:3 allocation score on c001n04: 0
-native_color: child_CloneSet:3 allocation score on c001n05: 0
-native_color: child_CloneSet:3 allocation score on c001n06: 0
-native_color: child_CloneSet:3 allocation score on c001n07: 0
-native_color: child_CloneSet:3 allocation score on c001n08: 0
+native_color: child_CloneSet:3 allocation score on c001n05: -INFINITY
+native_color: child_CloneSet:3 allocation score on c001n06: -INFINITY
+native_color: child_CloneSet:3 allocation score on c001n07: -INFINITY
+native_color: child_CloneSet:3 allocation score on c001n08: -INFINITY
 native_color: child_CloneSet:4 allocation score on c001n09: -INFINITY
 native_color: child_CloneSet:4 allocation score on c001n02: -INFINITY
 native_color: child_CloneSet:4 allocation score on c001n03: -INFINITY
 native_color: child_CloneSet:4 allocation score on c001n04: -INFINITY
 native_color: child_CloneSet:4 allocation score on c001n05: 0
-native_color: child_CloneSet:4 allocation score on c001n06: 0
-native_color: child_CloneSet:4 allocation score on c001n07: 0
-native_color: child_CloneSet:4 allocation score on c001n08: 0
+native_color: child_CloneSet:4 allocation score on c001n06: -INFINITY
+native_color: child_CloneSet:4 allocation score on c001n07: -INFINITY
+native_color: child_CloneSet:4 allocation score on c001n08: -INFINITY
 native_color: child_CloneSet:5 allocation score on c001n09: -INFINITY
 native_color: child_CloneSet:5 allocation score on c001n02: -INFINITY
 native_color: child_CloneSet:5 allocation score on c001n03: -INFINITY
 native_color: child_CloneSet:5 allocation score on c001n04: -INFINITY
 native_color: child_CloneSet:5 allocation score on c001n05: -INFINITY
 native_color: child_CloneSet:5 allocation score on c001n06: 0
-native_color: child_CloneSet:5 allocation score on c001n07: 0
-native_color: child_CloneSet:5 allocation score on c001n08: 0
+native_color: child_CloneSet:5 allocation score on c001n07: -INFINITY
+native_color: child_CloneSet:5 allocation score on c001n08: -INFINITY
 native_color: child_CloneSet:6 allocation score on c001n09: -INFINITY
 native_color: child_CloneSet:6 allocation score on c001n02: -INFINITY
 native_color: child_CloneSet:6 allocation score on c001n03: -INFINITY
@@ -334,7 +334,7 @@ native_color: child_CloneSet:6 allocatio
 native_color: child_CloneSet:6 allocation score on c001n05: -INFINITY
 native_color: child_CloneSet:6 allocation score on c001n06: -INFINITY
 native_color: child_CloneSet:6 allocation score on c001n07: 0
-native_color: child_CloneSet:6 allocation score on c001n08: 0
+native_color: child_CloneSet:6 allocation score on c001n08: -INFINITY
 native_color: child_CloneSet:7 allocation score on c001n09: -INFINITY
 native_color: child_CloneSet:7 allocation score on c001n02: -INFINITY
 native_color: child_CloneSet:7 allocation score on c001n03: -INFINITY
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-3.dot
--- a/pengine/test10/interleave-3.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-3.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -10,8 +10,6 @@
 "CloneSet_start_0" -> "child_CloneSet:6_start_0 c001n07" [ style = bold]
 "CloneSet_start_0" -> "child_CloneSet:7_start_0 c001n08" [ style = bold]
 "CloneSet_start_0" [ style=bold color="green" fontcolor="orange" ]
-"CloneSet_stop_0" -> "CloneSet_start_0" [ style = bold]
-"CloneSet_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "DcIPaddr_monitor_0 c001n02" -> "probe_complete c001n02" [ style = bold]
 "DcIPaddr_monitor_0 c001n02" [ style=bold color="green" fontcolor="black" ]
 "DcIPaddr_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
@@ -262,8 +260,6 @@
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n09" -> "probe_complete" [ style = bold]
 "probe_complete c001n09" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "CloneSet_start_0" [ style = bold]
-"probe_complete" -> "CloneSet_stop_0" [ style = bold]
 "probe_complete" -> "child_CloneSet:0_start_0 c001n09" [ style = bold]
 "probe_complete" -> "child_CloneSet:1_start_0 c001n02" [ style = bold]
 "probe_complete" -> "child_CloneSet:2_start_0 c001n03" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-3.exp
--- a/pengine/test10/interleave-3.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-3.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1551,14 +1551,7 @@
         <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="163" priority="1000000">
      <action_set>
@@ -1598,18 +1591,6 @@
    </synapse>
    <synapse id="164">
      <action_set>
-       <pseudo_event id="229" operation="stop" operation_key="CloneSet_stop_0">
-        <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="165">
-     <action_set>
        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -1641,7 +1622,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="166" priority="1000000">
+  <synapse id="165" priority="1000000">
      <action_set>
        <rsc_op id="19" operation="probe_complete" operation_key="probe_complete" on_node="c001n09" on_node_uuid="f67904e0-4dfc-4db1-83a2-e930fc1d20f4">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1710,7 +1691,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="167" priority="1000000">
+  <synapse id="166" priority="1000000">
      <action_set>
        <rsc_op id="40" operation="probe_complete" operation_key="probe_complete" on_node="c001n02" on_node_uuid="e9bdfde9-01b0-421f-acd8-8a65a53e775f">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1770,7 +1751,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="168" priority="1000000">
+  <synapse id="167" priority="1000000">
      <action_set>
        <rsc_op id="58" operation="probe_complete" operation_key="probe_complete" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1827,7 +1808,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="169" priority="1000000">
+  <synapse id="168" priority="1000000">
      <action_set>
        <rsc_op id="75" operation="probe_complete" operation_key="probe_complete" on_node="c001n04" on_node_uuid="c2896699-96b8-4dbc-a94e-6c3b9252b559">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1893,7 +1874,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="170" priority="1000000">
+  <synapse id="169" priority="1000000">
      <action_set>
        <rsc_op id="95" operation="probe_complete" operation_key="probe_complete" on_node="c001n05" on_node_uuid="c13968a2-bcf0-41f6-9133-01e5bbb63cd5">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -1962,7 +1943,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="171" priority="1000000">
+  <synapse id="170" priority="1000000">
      <action_set>
        <rsc_op id="116" operation="probe_complete" operation_key="probe_complete" on_node="c001n06" on_node_uuid="f91e6074-699d-48af-80d6-223132f291e2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2004,7 +1985,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="172" priority="1000000">
+  <synapse id="171" priority="1000000">
      <action_set>
        <rsc_op id="128" operation="probe_complete" operation_key="probe_complete" on_node="c001n07" on_node_uuid="208d89a6-e052-4e9d-973d-07c9036c506b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -2076,7 +2057,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="173" priority="1000000">
+  <synapse id="172" priority="1000000">
      <action_set>
        <rsc_op id="150" operation="probe_complete" operation_key="probe_complete" on_node="c001n08" on_node_uuid="6427cb5a-c7a5-4bdf-9892-a04ce56f4e6b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/interleave-3.scores
--- a/pengine/test10/interleave-3.scores	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/interleave-3.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -279,55 +279,55 @@ native_color: child_CloneSet:7 allocatio
 native_color: child_CloneSet:7 allocation score on c001n06: -INFINITY
 native_color: child_CloneSet:7 allocation score on c001n07: -INFINITY
 native_color: child_CloneSet:7 allocation score on c001n08: 0
-native_color: child_DoFencing:0 allocation score on c001n09: 0
+native_color: child_DoFencing:0 allocation score on c001n09: -INFINITY
 native_color: child_DoFencing:0 allocation score on c001n02: 200
-native_color: child_DoFencing:0 allocation score on c001n03: 0
-native_color: child_DoFencing:0 allocation score on c001n04: 0
-native_color: child_DoFencing:0 allocation score on c001n05: 0
-native_color: child_DoFencing:0 allocation score on c001n06: 0
-native_color: child_DoFencing:0 allocation score on c001n07: 0
-native_color: child_DoFencing:0 allocation score on c001n08: 0
-native_color: child_DoFencing:1 allocation score on c001n09: 0
+native_color: child_DoFencing:0 allocation score on c001n03: -INFINITY
+native_color: child_DoFencing:0 allocation score on c001n04: -INFINITY
+native_color: child_DoFencing:0 allocation score on c001n05: -INFINITY
+native_color: child_DoFencing:0 allocation score on c001n06: -INFINITY
+native_color: child_DoFencing:0 allocation score on c001n07: -INFINITY
+native_color: child_DoFencing:0 allocation score on c001n08: -INFINITY
+native_color: child_DoFencing:1 allocation score on c001n09: -INFINITY
 native_color: child_DoFencing:1 allocation score on c001n02: -INFINITY
 native_color: child_DoFencing:1 allocation score on c001n03: 200
-native_color: child_DoFencing:1 allocation score on c001n04: 0
-native_color: child_DoFencing:1 allocation score on c001n05: 0
-native_color: child_DoFencing:1 allocation score on c001n06: 0
-native_color: child_DoFencing:1 allocation score on c001n07: 0
-native_color: child_DoFencing:1 allocation score on c001n08: 0
-native_color: child_DoFencing:2 allocation score on c001n09: 0
+native_color: child_DoFencing:1 allocation score on c001n04: -INFINITY
+native_color: child_DoFencing:1 allocation score on c001n05: -INFINITY
+native_color: child_DoFencing:1 allocation score on c001n06: -INFINITY
+native_color: child_DoFencing:1 allocation score on c001n07: -INFINITY
+native_color: child_DoFencing:1 allocation score on c001n08: -INFINITY
+native_color: child_DoFencing:2 allocation score on c001n09: -INFINITY
 native_color: child_DoFencing:2 allocation score on c001n02: -INFINITY
 native_color: child_DoFencing:2 allocation score on c001n03: -INFINITY
 native_color: child_DoFencing:2 allocation score on c001n04: 200
-native_color: child_DoFencing:2 allocation score on c001n05: 0
-native_color: child_DoFencing:2 allocation score on c001n06: 0
-native_color: child_DoFencing:2 allocation score on c001n07: 0
-native_color: child_DoFencing:2 allocation score on c001n08: 0
-native_color: child_DoFencing:3 allocation score on c001n09: 0
+native_color: child_DoFencing:2 allocation score on c001n05: -INFINITY
+native_color: child_DoFencing:2 allocation score on c001n06: -INFINITY
+native_color: child_DoFencing:2 allocation score on c001n07: -INFINITY
+native_color: child_DoFencing:2 allocation score on c001n08: -INFINITY
+native_color: child_DoFencing:3 allocation score on c001n09: -INFINITY
 native_color: child_DoFencing:3 allocation score on c001n02: -INFINITY
 native_color: child_DoFencing:3 allocation score on c001n03: -INFINITY
 native_color: child_DoFencing:3 allocation score on c001n04: -INFINITY
 native_color: child_DoFencing:3 allocation score on c001n05: 200
-native_color: child_DoFencing:3 allocation score on c001n06: 0
-native_color: child_DoFencing:3 allocation score on c001n07: 0
-native_color: child_DoFencing:3 allocation score on c001n08: 0
-native_color: child_DoFencing:4 allocation score on c001n09: 0
+native_color: child_DoFencing:3 allocation score on c001n06: -INFINITY
+native_color: child_DoFencing:3 allocation score on c001n07: -INFINITY
+native_color: child_DoFencing:3 allocation score on c001n08: -INFINITY
+native_color: child_DoFencing:4 allocation score on c001n09: -INFINITY
 native_color: child_DoFencing:4 allocation score on c001n02: -INFINITY
 native_color: child_DoFencing:4 allocation score on c001n03: -INFINITY
 native_color: child_DoFencing:4 allocation score on c001n04: -INFINITY
 native_color: child_DoFencing:4 allocation score on c001n05: -INFINITY
 native_color: child_DoFencing:4 allocation score on c001n06: 200
-native_color: child_DoFencing:4 allocation score on c001n07: 0
-native_color: child_DoFencing:4 allocation score on c001n08: 0
-native_color: child_DoFencing:5 allocation score on c001n09: 0
+native_color: child_DoFencing:4 allocation score on c001n07: -INFINITY
+native_color: child_DoFencing:4 allocation score on c001n08: -INFINITY
+native_color: child_DoFencing:5 allocation score on c001n09: -INFINITY
 native_color: child_DoFencing:5 allocation score on c001n02: -INFINITY
 native_color: child_DoFencing:5 allocation score on c001n03: -INFINITY
 native_color: child_DoFencing:5 allocation score on c001n04: -INFINITY
 native_color: child_DoFencing:5 allocation score on c001n05: -INFINITY
 native_color: child_DoFencing:5 allocation score on c001n06: -INFINITY
 native_color: child_DoFencing:5 allocation score on c001n07: 200
-native_color: child_DoFencing:5 allocation score on c001n08: 0
-native_color: child_DoFencing:6 allocation score on c001n09: 0
+native_color: child_DoFencing:5 allocation score on c001n08: -INFINITY
+native_color: child_DoFencing:6 allocation score on c001n09: -INFINITY
 native_color: child_DoFencing:6 allocation score on c001n02: -INFINITY
 native_color: child_DoFencing:6 allocation score on c001n03: -INFINITY
 native_color: child_DoFencing:6 allocation score on c001n04: -INFINITY
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-0.dot
--- a/pengine/test10/master-0.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-0.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -35,8 +35,6 @@
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc1:2_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:3_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_start_0" -> "child_rsc1:0_start_0 node1" [ style = bold]
@@ -45,6 +43,4 @@
 "rsc1_start_0" -> "child_rsc1:3_start_0 node2" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-0.exp
--- a/pengine/test10/master-0.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-0.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -159,14 +159,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="21" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="15" priority="1000000">
      <action_set>
@@ -194,18 +187,6 @@
    </synapse>
    <synapse id="16">
      <action_set>
-       <pseudo_event id="21" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="17">
-     <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -219,7 +200,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18" priority="1000000">
+  <synapse id="17" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -243,7 +224,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="19" priority="1000000">
+  <synapse id="18" priority="1000000">
      <action_set>
        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-1.dot
--- a/pengine/test10/master-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -38,8 +38,6 @@
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc1:2_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:3_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_promote_0" -> "child_rsc1:1_promote_0 node2" [ style = bold]
 "rsc1_promote_0" [ style=bold color="green" fontcolor="orange" ]
@@ -53,6 +51,4 @@
 "rsc1_start_0" -> "rsc1_promote_0" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-1.exp
--- a/pengine/test10/master-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -175,14 +175,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="16" priority="1000000">
      <action_set>
@@ -210,18 +203,6 @@
    </synapse>
    <synapse id="17">
      <action_set>
-       <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="18">
-     <action_set>
        <pseudo_event id="24" operation="promote" operation_key="rsc1_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -235,7 +216,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="19" priority="1000000">
+  <synapse id="18" priority="1000000">
      <action_set>
        <pseudo_event id="25" operation="promoted" operation_key="rsc1_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -247,7 +228,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="20">
+  <synapse id="19">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -262,7 +243,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="21" priority="1000000">
+  <synapse id="20" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -286,7 +267,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="22" priority="1000000">
+  <synapse id="21" priority="1000000">
      <action_set>
        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-10.dot
--- a/pengine/test10/master-10.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-10.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -71,8 +71,6 @@
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc1:2_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:3_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-post_notify_promoted_0" -> "child_rsc1:0_monitor_11000 node1" [ style = bold]
 "rsc1_confirmed-post_notify_promoted_0" -> "child_rsc1:1_monitor_1000 node2" [ style = bold]
@@ -125,6 +123,4 @@
 "rsc1_start_0" -> "rsc1_promote_0" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-10.exp
--- a/pengine/test10/master-10.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-10.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -412,14 +412,8 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="27" operation="notified" operation_key="rsc1_confirmed-pre_notify_start_0"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="30" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
    <synapse id="32" priority="1000000">
@@ -507,18 +501,6 @@
    </synapse>
    <synapse id="37">
      <action_set>
-       <pseudo_event id="30" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="38">
-     <action_set>
        <pseudo_event id="36" operation="promote" operation_key="rsc1_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -535,7 +517,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="39" priority="1000000">
+  <synapse id="38" priority="1000000">
      <action_set>
        <pseudo_event id="37" operation="promoted" operation_key="rsc1_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -547,7 +529,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="40">
+  <synapse id="39">
      <action_set>
        <pseudo_event id="38" operation="notify" operation_key="rsc1_pre_notify_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -559,7 +541,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="41">
+  <synapse id="40">
      <action_set>
        <pseudo_event id="39" operation="notified" operation_key="rsc1_confirmed-pre_notify_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -583,7 +565,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="42" priority="1000000">
+  <synapse id="41" priority="1000000">
      <action_set>
        <pseudo_event id="40" operation="notify" operation_key="rsc1_post_notify_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="post" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -598,7 +580,7 @@
       </trigger>
      </inputs>
    </synapse>
-   <synapse id="43" priority="1000000">
+  <synapse id="42" priority="1000000">
      <action_set>
        <pseudo_event id="41" operation="notified" operation_key="rsc1_confirmed-post_notify_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -622,7 +604,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="44">
+  <synapse id="43">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -637,7 +619,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="45" priority="1000000">
+  <synapse id="44" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -661,7 +643,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="46" priority="1000000">
+  <synapse id="45" priority="1000000">
      <action_set>
        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-11.dot
--- a/pengine/test10/master-11.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-11.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -20,8 +20,6 @@
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1:0_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" -> "simple-rsc_start_0 node2" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_promote_0" -> "child_rsc1:1_promote_0 node2" [ style = bold]
@@ -34,8 +32,6 @@
 "rsc1_start_0" -> "rsc1_promote_0" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "simple-rsc_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "simple-rsc_monitor_0 node1" [ style=bold color="green" fontcolor="black" ]
 "simple-rsc_monitor_0 node2" -> "probe_complete node2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-11.exp
--- a/pengine/test10/master-11.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-11.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -120,14 +120,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="17" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="11" priority="1000000">
      <action_set>
@@ -149,18 +142,6 @@
    </synapse>
    <synapse id="12">
      <action_set>
-       <pseudo_event id="17" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="13">
-     <action_set>
        <pseudo_event id="19" operation="promote" operation_key="rsc1_promote_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -174,7 +155,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="14" priority="1000000">
+  <synapse id="13" priority="1000000">
      <action_set>
        <pseudo_event id="20" operation="promoted" operation_key="rsc1_promoted_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -186,7 +167,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="15">
+  <synapse id="14">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -201,7 +182,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="16" priority="1000000">
+  <synapse id="15" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -219,7 +200,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="17" priority="1000000">
+  <synapse id="16" priority="1000000">
      <action_set>
        <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-2.dot
--- a/pengine/test10/master-2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -62,8 +62,6 @@
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc1:2_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:3_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-post_notify_promoted_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-post_notify_running_0" -> "rsc1_pre_notify_promote_0" [ style = bold]
@@ -108,6 +106,4 @@
 "rsc1_start_0" -> "rsc1_promote_0" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-2.exp
--- a/pengine/test10/master-2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -333,14 +333,8 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="23" operation="notified" operation_key="rsc1_confirmed-pre_notify_start_0"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="26" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
    <synapse id="28" priority="1000000">
@@ -428,18 +422,6 @@
    </synapse>
    <synapse id="33">
      <action_set>
-       <pseudo_event id="26" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="34">
-     <action_set>
        <pseudo_event id="32" operation="promote" operation_key="rsc1_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -456,7 +438,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="35" priority="1000000">
+  <synapse id="34" priority="1000000">
      <action_set>
        <pseudo_event id="33" operation="promoted" operation_key="rsc1_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -468,7 +450,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="36">
+  <synapse id="35">
      <action_set>
        <pseudo_event id="34" operation="notify" operation_key="rsc1_pre_notify_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -480,7 +462,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="37">
+  <synapse id="36">
      <action_set>
        <pseudo_event id="35" operation="notified" operation_key="rsc1_confirmed-pre_notify_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -504,7 +486,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="38" priority="1000000">
+  <synapse id="37" priority="1000000">
      <action_set>
        <pseudo_event id="36" operation="notify" operation_key="rsc1_post_notify_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="post" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -519,7 +501,7 @@
       </trigger>
      </inputs>
    </synapse>
-   <synapse id="39" priority="1000000">
+  <synapse id="38" priority="1000000">
      <action_set>
        <pseudo_event id="37" operation="notified" operation_key="rsc1_confirmed-post_notify_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="promote" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -543,7 +525,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="40">
+  <synapse id="39">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -558,7 +540,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="41" priority="1000000">
+  <synapse id="40" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -582,7 +564,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="42" priority="1000000">
+  <synapse id="41" priority="1000000">
      <action_set>
        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-3.dot
--- a/pengine/test10/master-3.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-3.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -38,8 +38,6 @@
 "probe_complete" -> "child_rsc1:1_start_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc1:2_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:3_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_promote_0" -> "child_rsc1:1_promote_0 node2" [ style = bold]
 "rsc1_promote_0" [ style=bold color="green" fontcolor="orange" ]
@@ -53,6 +51,4 @@
 "rsc1_start_0" -> "rsc1_promote_0" [ style = bold]
 "rsc1_start_0" -> "rsc1_running_0" [ style = bold]
 "rsc1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"rsc1_stop_0" -> "rsc1_start_0" [ style = bold]
-"rsc1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-3.exp
--- a/pengine/test10/master-3.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-3.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -175,14 +175,7 @@
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="16" priority="1000000">
      <action_set>
@@ -210,18 +203,6 @@
    </synapse>
    <synapse id="17">
      <action_set>
-       <pseudo_event id="22" operation="stop" operation_key="rsc1_stop_0">
-        <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="18">
-     <action_set>
        <pseudo_event id="24" operation="promote" operation_key="rsc1_promote_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -235,7 +216,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="19" priority="1000000">
+  <synapse id="18" priority="1000000">
      <action_set>
        <pseudo_event id="25" operation="promoted" operation_key="rsc1_promoted_0">
         <attributes CRM_meta_clone_max="5" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -247,7 +228,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="20">
+  <synapse id="19">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -262,7 +243,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="21" priority="1000000">
+  <synapse id="20" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -286,7 +267,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="22" priority="1000000">
+  <synapse id="21" priority="1000000">
      <action_set>
        <rsc_op id="9" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-7.dot
--- a/pengine/test10/master-7.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-7.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -112,11 +112,15 @@
 "probe_complete c001n03" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n08" -> "probe_complete" [ style = bold]
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
+"probe_complete" -> "DcIPaddr_stop_0 c001n01" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_stop_0 c001n01" [ style = bold]
-"probe_complete" -> "master_rsc_1_stop_0" [ style = bold]
+"probe_complete" -> "heartbeat_192.168.100.182_stop_0 c001n03" [ style = bold]
+"probe_complete" -> "lsb_dummy_stop_0 c001n02" [ style = bold]
+"probe_complete" -> "ocf_192.168.100.181_stop_0 c001n03" [ style = bold]
+"probe_complete" -> "ocf_192.168.100.183_stop_0 c001n03" [ style = bold]
 "probe_complete" -> "ocf_msdummy:0_stop_0 c001n01" [ style = bold]
 "probe_complete" -> "ocf_msdummy:4_stop_0 c001n01" [ style = bold]
+"probe_complete" -> "rsc_c001n01_stop_0 c001n01" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc_c001n01_monitor_5000 c001n03" [ style=bold color="green" fontcolor="black" ]
 "rsc_c001n01_start_0 c001n03" -> "rsc_c001n01_monitor_5000 c001n03" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-7.exp
--- a/pengine/test10/master-7.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-7.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -7,6 +7,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <crm_event id="105" operation="stonith" operation_key="stonith" on_node="c001n01" on_node_uuid="de937e3d-0309-4b5d-b85c-f96edc1ed8e3"/>
        </trigger>
      </inputs>
@@ -79,7 +82,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs/>
+    <inputs/>
    </synapse>
    <synapse id="6">
      <action_set>
@@ -111,6 +114,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="41" operation="stop" operation_key="heartbeat_192.168.100.182_stop_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193"/>
        </trigger>
        <trigger>
@@ -156,6 +162,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="44" operation="stop" operation_key="ocf_192.168.100.183_stop_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193"/>
        </trigger>
        <trigger>
@@ -208,6 +217,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <pseudo_event id="49" operation="stop" operation_key="group-1_stop_0"/>
        </trigger>
      </inputs>
@@ -251,7 +263,11 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </rsc_op>
      </action_set>
-    <inputs/>
+    <inputs>
+      <trigger>
+        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
    </synapse>
    <synapse id="17">
      <action_set>
@@ -287,6 +303,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <crm_event id="105" operation="stonith" operation_key="stonith" on_node="c001n01" on_node_uuid="de937e3d-0309-4b5d-b85c-f96edc1ed8e3"/>
        </trigger>
      </inputs>
@@ -374,11 +393,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="28" priority="1000000">
      <action_set>
@@ -538,9 +553,6 @@
      </action_set>
      <inputs>
        <trigger>
-        <pseudo_event id="18" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="101" operation="demote" operation_key="master_rsc_1_demote_0"/>
        </trigger>
        <trigger>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-8.dot
--- a/pengine/test10/master-8.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-8.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -123,12 +123,15 @@
 "probe_complete c001n03" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n08" -> "probe_complete" [ style = bold]
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
+"probe_complete" -> "DcIPaddr_stop_0 c001n01" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_stop_0 c001n01" [ style = bold]
-"probe_complete" -> "master_rsc_1_start_0" [ style = bold]
-"probe_complete" -> "master_rsc_1_stop_0" [ style = bold]
+"probe_complete" -> "heartbeat_192.168.100.182_stop_0 c001n03" [ style = bold]
+"probe_complete" -> "lsb_dummy_stop_0 c001n02" [ style = bold]
+"probe_complete" -> "ocf_192.168.100.181_stop_0 c001n03" [ style = bold]
+"probe_complete" -> "ocf_192.168.100.183_stop_0 c001n03" [ style = bold]
 "probe_complete" -> "ocf_msdummy:0_start_0 c001n03" [ style = bold]
 "probe_complete" -> "ocf_msdummy:0_stop_0 c001n01" [ style = bold]
+"probe_complete" -> "rsc_c001n01_stop_0 c001n01" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc_c001n01_monitor_5000 c001n03" [ style=bold color="green" fontcolor="black" ]
 "rsc_c001n01_start_0 c001n03" -> "rsc_c001n01_monitor_5000 c001n03" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-8.exp
--- a/pengine/test10/master-8.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-8.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -7,6 +7,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <crm_event id="103" operation="stonith" operation_key="stonith" on_node="c001n01" on_node_uuid="de937e3d-0309-4b5d-b85c-f96edc1ed8e3"/>
        </trigger>
      </inputs>
@@ -79,7 +82,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs/>
+    <inputs/>
    </synapse>
    <synapse id="6">
      <action_set>
@@ -111,6 +114,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="41" operation="stop" operation_key="heartbeat_192.168.100.182_stop_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193"/>
        </trigger>
        <trigger>
@@ -156,6 +162,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="44" operation="stop" operation_key="ocf_192.168.100.183_stop_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193"/>
        </trigger>
        <trigger>
@@ -208,6 +217,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <pseudo_event id="49" operation="stop" operation_key="group-1_stop_0"/>
        </trigger>
      </inputs>
@@ -251,7 +263,11 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </rsc_op>
      </action_set>
-    <inputs/>
+    <inputs>
+      <trigger>
+        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
    </synapse>
    <synapse id="17">
      <action_set>
@@ -287,6 +303,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <crm_event id="103" operation="stonith" operation_key="stonith" on_node="c001n01" on_node_uuid="de937e3d-0309-4b5d-b85c-f96edc1ed8e3"/>
        </trigger>
      </inputs>
@@ -374,11 +393,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="28" priority="1000000">
      <action_set>
@@ -564,9 +579,6 @@
      </action_set>
      <inputs>
        <trigger>
-        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="95" operation="stop" operation_key="master_rsc_1_stop_0"/>
        </trigger>
        <trigger>
@@ -600,9 +612,6 @@
      </action_set>
      <inputs>
        <trigger>
-        <pseudo_event id="17" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="99" operation="demote" operation_key="master_rsc_1_demote_0"/>
        </trigger>
        <trigger>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-9.dot
--- a/pengine/test10/master-9.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-9.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -22,9 +22,6 @@
 "do_shutdown ibm1" [ style=bold color="green" fontcolor="black" ]
 "heartbeat_127.0.0.12_monitor_5000 va1" [ style=dashed color="red" fontcolor="black"  ]
 "lsb_dummy_monitor_5000 va1" [ style=dashed color="red" fontcolor="black"  ]
-"master_rsc_1_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"master_rsc_1_stop_0" -> "master_rsc_1_start_0" [ style = bold]
-"master_rsc_1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "ocf_127.0.0.11_monitor_5000 va1" [ style=dashed color="red" fontcolor="black"  ]
 "ocf_127.0.0.13_monitor_5000 va1" [ style=dashed color="red" fontcolor="black"  ]
 "ocf_msdummy:0_monitor_5000 va1" [ style=dashed color="red" fontcolor="black"  ]
@@ -57,10 +54,7 @@
 "probe_complete ibm1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete va1" -> "probe_complete" [ style = bold]
 "probe_complete va1" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:1_stop_0 ibm1" [ style = bold]
-"probe_complete" -> "master_rsc_1_start_0" [ style = bold]
-"probe_complete" -> "master_rsc_1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc_ibm1_monitor_5000 va1" [ style=dashed color="red" fontcolor="black"  ]
 "rsc_sgi2_monitor_5000 va1" [ style=dashed color="red" fontcolor="black"  ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-9.exp
--- a/pengine/test10/master-9.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-9.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -69,11 +69,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="7" priority="1000000">
      <action_set>
@@ -200,40 +196,13 @@
    </synapse>
    <synapse id="20">
      <action_set>
-       <pseudo_event id="57" operation="start" operation_key="master_rsc_1_start_0">
-        <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="4" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="59" operation="stop" operation_key="master_rsc_1_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="21">
-     <action_set>
-       <pseudo_event id="59" operation="stop" operation_key="master_rsc_1_stop_0">
-        <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_master_max="4" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="22">
-     <action_set>
        <pseudo_event id="3" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="23">
+  <synapse id="21">
      <action_set>
        <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -248,7 +217,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="24" priority="1000000">
+  <synapse id="22" priority="1000000">
      <action_set>
        <rsc_op id="5" operation="probe_complete" operation_key="probe_complete" on_node="va1" on_node_uuid="b8f81462-2d65-42bf-bbb1-70db0ea29e5b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -284,7 +253,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="25" priority="1000000">
+  <synapse id="23" priority="1000000">
      <action_set>
        <rsc_op id="15" operation="probe_complete" operation_key="probe_complete" on_node="ibm1" on_node_uuid="d0d76dd9-7a01-4c12-bbec-98aa2a669638">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -317,7 +286,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="26">
+  <synapse id="24">
      <action_set>
       <crm_event id="67" operation="do_shutdown" operation_key="do_shutdown" on_node="ibm1" on_node_uuid="d0d76dd9-7a01-4c12-bbec-98aa2a669638">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-depend.dot
--- a/pengine/test10/master-depend.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-depend.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -9,8 +9,6 @@ digraph "g" {
 "cman_clone_start_0" -> "cman:0_start_0 vbox4" [ style = bold]
 "cman_clone_start_0" -> "cman_clone_running_0" [ style = bold]
 "cman_clone_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"cman_clone_stop_0" -> "cman_clone_start_0" [ style = bold]
-"cman_clone_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "drbd0:0_monitor_0 vbox4" -> "probe_complete vbox4" [ style = bold]
 "drbd0:0_monitor_0 vbox4" [ style=bold color="green" fontcolor="black"  ]
 "drbd0:0_monitor_60000 vbox4" [ style=bold color="green" fontcolor="black"  ]
@@ -34,16 +32,10 @@ digraph "g" {
 "drbd_start_0" -> "drbd0:0_start_0 vbox4" [ style = bold]
 "drbd_start_0" -> "drbd_running_0" [ style = bold]
 "drbd_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"drbd_stop_0" -> "drbd_start_0" [ style = bold]
-"drbd_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete vbox4" -> "probe_complete" [ style = bold]
 "probe_complete vbox4" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "cman:0_start_0 vbox4" [ style = bold]
-"probe_complete" -> "cman_clone_start_0" [ style = bold]
-"probe_complete" -> "cman_clone_stop_0" [ style = bold]
 "probe_complete" -> "drbd0:0_start_0 vbox4" [ style = bold]
-"probe_complete" -> "drbd_start_0" [ style = bold]
-"probe_complete" -> "drbd_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "vmnci36_monitor_0 vbox4" -> "probe_complete vbox4" [ style = bold]
 "vmnci36_monitor_0 vbox4" [ style=bold color="green" fontcolor="black"  ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-depend.exp
--- a/pengine/test10/master-depend.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-depend.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -61,14 +61,8 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="16" operation="notified" operation_key="drbd_confirmed-pre_notify_start_0"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="19" operation="stop" operation_key="drbd_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
    <synapse id="5" priority="1000000">
@@ -138,18 +132,6 @@
    </synapse>
    <synapse id="10">
      <action_set>
-       <pseudo_event id="19" operation="stop" operation_key="drbd_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="2" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="11">
-     <action_set>
        <rsc_op id="5" operation="monitor" operation_key="cman:0_monitor_0" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
          <primitive id="cman:0" long-id="cman_clone:cman:0" class="lsb" type="cman"/>
         <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -157,7 +139,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="12">
+  <synapse id="11">
      <action_set>
        <rsc_op id="37" operation="start" operation_key="cman:0_start_0" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
          <primitive id="cman:0" long-id="cman_clone:cman:0" class="lsb" type="cman"/>
@@ -173,22 +155,15 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="13">
+  <synapse id="12">
      <action_set>
        <pseudo_event id="38" operation="start" operation_key="cman_clone_start_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="40" operation="stop" operation_key="cman_clone_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
-   <synapse id="14" priority="1000000">
+  <synapse id="13" priority="1000000">
      <action_set>
        <pseudo_event id="39" operation="running" operation_key="cman_clone_running_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -203,19 +178,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="15">
-     <action_set>
-       <pseudo_event id="40" operation="stop" operation_key="cman_clone_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="16">
+  <synapse id="14">
      <action_set>
        <rsc_op id="6" operation="monitor" operation_key="clvmd:0_monitor_0" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
          <primitive id="clvmd:0" long-id="clvmd_clone:clvmd:0" class="lsb" type="lxclvmd"/>
@@ -224,7 +187,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="17">
+  <synapse id="15">
      <action_set>
        <rsc_op id="7" operation="monitor" operation_key="vmnci36_monitor_0" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
          <primitive id="vmnci36" long-id="vmnci36" class="ocf" provider="heartbeat" type="vm"/>
@@ -233,7 +196,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="18">
+  <synapse id="16">
      <action_set>
        <rsc_op id="8" operation="monitor" operation_key="vmnci37_monitor_0" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
          <primitive id="vmnci37" long-id="vmnci37" class="ocf" provider="heartbeat" type="vm"/>
@@ -242,7 +205,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="19">
+  <synapse id="17">
      <action_set>
        <rsc_op id="9" operation="monitor" operation_key="vmnci38_monitor_0" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
          <primitive id="vmnci38" long-id="vmnci38" class="ocf" provider="heartbeat" type="vm"/>
@@ -251,7 +214,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="20">
+  <synapse id="18">
      <action_set>
        <rsc_op id="10" operation="monitor" operation_key="vmnci55_monitor_0" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
          <primitive id="vmnci55" long-id="vmnci55" class="ocf" provider="heartbeat" type="vm"/>
@@ -260,7 +223,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="21">
+  <synapse id="19">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -272,7 +235,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="22" priority="1000000">
+  <synapse id="20" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="vbox4" on_node_uuid="a9a4b0ab-fc17-48ab-9d91-29e398e15cb6">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-ordering.dot
--- a/pengine/test10/master-ordering.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-ordering.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -59,8 +59,6 @@ digraph "g" {
 "ms_drbd_mysql_start_0" -> "drbd_mysql:0_start_0 webcluster01" [ style = bold]
 "ms_drbd_mysql_start_0" -> "ms_drbd_mysql_running_0" [ style = bold]
 "ms_drbd_mysql_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"ms_drbd_mysql_stop_0" -> "ms_drbd_mysql_start_0" [ style = bold]
-"ms_drbd_mysql_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "ms_drbd_www_confirmed-post_notify_running_0" [ style=bold color="green" fontcolor="orange"  ]
 "ms_drbd_www_confirmed-pre_notify_start_0" -> "ms_drbd_www_post_notify_running_0" [ style = bold]
 "ms_drbd_www_confirmed-pre_notify_start_0" -> "ms_drbd_www_start_0" [ style = bold]
@@ -75,8 +73,6 @@ digraph "g" {
 "ms_drbd_www_start_0" -> "drbd_www:0_start_0 webcluster01" [ style = bold]
 "ms_drbd_www_start_0" -> "ms_drbd_www_running_0" [ style = bold]
 "ms_drbd_www_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"ms_drbd_www_stop_0" -> "ms_drbd_www_start_0" [ style = bold]
-"ms_drbd_www_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "mysql-proxy:0_monitor_0 webcluster01" -> "probe_complete webcluster01" [ style = bold]
 "mysql-proxy:0_monitor_0 webcluster01" [ style=bold color="green" fontcolor="black"  ]
 "mysql-server_monitor_0 webcluster01" -> "probe_complete webcluster01" [ style = bold]
@@ -93,9 +89,5 @@ digraph "g" {
 "probe_complete" -> "extip_2_start_0 webcluster01" [ style = bold]
 "probe_complete" -> "intip_1_master_start_0 webcluster01" [ style = bold]
 "probe_complete" -> "intip_2_slave_start_0 webcluster01" [ style = bold]
-"probe_complete" -> "ms_drbd_mysql_start_0" [ style = bold]
-"probe_complete" -> "ms_drbd_mysql_stop_0" [ style = bold]
-"probe_complete" -> "ms_drbd_www_start_0" [ style = bold]
-"probe_complete" -> "ms_drbd_www_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/master-ordering.exp
--- a/pengine/test10/master-ordering.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/master-ordering.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -209,9 +209,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <rsc_op id="25" operation="start" operation_key="intip_1_master_start_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298"/>
        </trigger>
        <trigger>
@@ -220,9 +217,6 @@
        <trigger>
         <pseudo_event id="33" operation="notified" operation_key="ms_drbd_www_confirmed-pre_notify_start_0"/>
        </trigger>
-       <trigger>
-        <pseudo_event id="36" operation="stop" operation_key="ms_drbd_www_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
   <synapse id="18" priority="1000000">
@@ -292,18 +286,6 @@
    </synapse>
   <synapse id="23">
      <action_set>
-      <pseudo_event id="36" operation="stop" operation_key="ms_drbd_www_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="2" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="24">
-     <action_set>
       <rsc_op id="11" operation="monitor" operation_key="ocfs2_www:0_monitor_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="ocfs2_www:0" long-id="clone_ocfs2_www:ocfs2_www:0" class="ocf" provider="heartbeat" type="Filesystem"/>
         <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" device="/dev/drbd0" directory="/data/www" fstype="ocfs2"/>
@@ -311,7 +293,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="25">
+  <synapse id="24">
      <action_set>
       <rsc_op id="12" operation="monitor" operation_key="ocfs2_www:1_monitor_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="ocfs2_www:1" long-id="clone_ocfs2_www:ocfs2_www:1" class="ocf" provider="heartbeat" type="Filesystem"/>
@@ -320,7 +302,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="26">
+  <synapse id="25">
      <action_set>
       <rsc_op id="13" operation="monitor" operation_key="apache2:0_monitor_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="apache2:0" long-id="clone_webservice:group_webservice:0:apache2:0" class="ocf" provider="heartbeat" type="apache"/>
@@ -329,7 +311,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="27">
+  <synapse id="26">
      <action_set>
       <rsc_op id="14" operation="monitor" operation_key="mysql-proxy:0_monitor_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="mysql-proxy:0" long-id="clone_webservice:group_webservice:0:mysql-proxy:0" class="lsb" type="mysql-proxy"/>
@@ -338,7 +320,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="28">
+  <synapse id="27">
      <action_set>
       <rsc_op id="15" operation="monitor" operation_key="drbd_mysql:0_monitor_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="drbd_mysql:0" long-id="ms_drbd_mysql:drbd_mysql:0" class="ocf" provider="heartbeat" type="drbd"/>
@@ -347,7 +329,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="29">
+  <synapse id="28">
      <action_set>
       <rsc_op id="70" operation="start" operation_key="drbd_mysql:0_start_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="drbd_mysql:0" long-id="ms_drbd_mysql:drbd_mysql:0" class="ocf" provider="heartbeat" type="drbd"/>
@@ -369,7 +351,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="30" priority="1000000">
+  <synapse id="29" priority="1000000">
      <action_set>
       <rsc_op id="134" operation="notify" operation_key="drbd_mysql:0_post_notify_start_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="drbd_mysql:0" long-id="ms_drbd_mysql:drbd_mysql:0" class="ocf" provider="heartbeat" type="drbd"/>
@@ -382,7 +364,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="31">
+  <synapse id="30">
      <action_set>
       <pseudo_event id="71" operation="start" operation_key="ms_drbd_mysql_start_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -390,9 +372,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <rsc_op id="25" operation="start" operation_key="intip_1_master_start_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298"/>
        </trigger>
        <trigger>
@@ -401,12 +380,9 @@
        <trigger>
         <pseudo_event id="74" operation="notified" operation_key="ms_drbd_mysql_confirmed-pre_notify_start_0"/>
        </trigger>
-       <trigger>
-        <pseudo_event id="77" operation="stop" operation_key="ms_drbd_mysql_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
-  <synapse id="32" priority="1000000">
+  <synapse id="31" priority="1000000">
      <action_set>
       <pseudo_event id="72" operation="running" operation_key="ms_drbd_mysql_running_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -421,7 +397,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="33">
+  <synapse id="32">
      <action_set>
       <pseudo_event id="73" operation="notify" operation_key="ms_drbd_mysql_pre_notify_start_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="start" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -429,7 +405,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="34">
+  <synapse id="33">
      <action_set>
       <pseudo_event id="74" operation="notified" operation_key="ms_drbd_mysql_confirmed-pre_notify_start_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="start" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -441,7 +417,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="35" priority="1000000">
+  <synapse id="34" priority="1000000">
      <action_set>
       <pseudo_event id="75" operation="notify" operation_key="ms_drbd_mysql_post_notify_running_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="start" CRM_meta_notify_type="post" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -456,7 +432,7 @@
       </trigger>
      </inputs>
    </synapse>
-  <synapse id="36" priority="1000000">
+  <synapse id="35" priority="1000000">
      <action_set>
       <pseudo_event id="76" operation="notified" operation_key="ms_drbd_mysql_confirmed-post_notify_running_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_notify_operation="start" CRM_meta_notify_type="pre" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -471,19 +447,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="37">
-     <action_set>
-      <pseudo_event id="77" operation="stop" operation_key="ms_drbd_mysql_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="38">
+  <synapse id="36">
      <action_set>
       <rsc_op id="16" operation="monitor" operation_key="fs_mysql_monitor_0" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
          <primitive id="fs_mysql" long-id="fs_mysql" class="ocf" provider="heartbeat" type="Filesystem"/>
@@ -492,7 +456,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="39">
+  <synapse id="37">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -504,7 +468,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="40" priority="1000000">
+  <synapse id="38" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="webcluster01" on_node_uuid="49e81295-8e2f-4aeb-98f3-a14de6f62298">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/migrate-start-complex.dot
--- a/pengine/test10/migrate-start-complex.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/migrate-start-complex.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -17,8 +17,6 @@ digraph "g" {
 "clone-bottom_start_0" -> "bottom:1_start_0 dom0-01" [ style = bold]
 "clone-bottom_start_0" -> "clone-bottom_running_0" [ style = bold]
 "clone-bottom_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"clone-bottom_stop_0" -> "clone-bottom_start_0" [ style = bold]
-"clone-bottom_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "clone-dom0-iscsi1_running_0" -> "domU-test01_migrate_from_0 dom0-01" [ style = bold]
 "clone-dom0-iscsi1_running_0" -> "domU-test01_migrate_to_0 dom0-02" [ style = bold]
 "clone-dom0-iscsi1_running_0" [ style=bold color="green" fontcolor="orange"  ]
@@ -46,8 +44,8 @@ digraph "g" {
 "probe_complete dom0-02" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "bottom:0_start_0 dom0-02" [ style = bold]
 "probe_complete" -> "bottom:1_start_0 dom0-01" [ style = bold]
-"probe_complete" -> "clone-bottom_start_0" [ style = bold]
-"probe_complete" -> "clone-bottom_stop_0" [ style = bold]
+"probe_complete" -> "domU-test01_migrate_to_0 dom0-02" [ style = bold]
+"probe_complete" -> "top_stop_0 dom0-02" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "top_start_0 dom0-01" [ style=bold color="green" fontcolor="black"  ]
 "top_stop_0 dom0-02" -> "all_stopped" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/migrate-start-complex.exp
--- a/pengine/test10/migrate-start-complex.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/migrate-start-complex.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -6,7 +6,11 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
-    <inputs/>
+    <inputs>
+      <trigger>
+        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
   </synapse>
   <synapse id="1">
     <action_set>
@@ -33,6 +37,9 @@
     </action_set>
     <inputs>
       <trigger>
+        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="7" operation="stop" operation_key="top_stop_0" on_node="dom0-02" on_node_uuid="dom0-02"/>
       </trigger>
       <trigger>
@@ -193,14 +200,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="30" operation="stop" operation_key="clone-bottom_stop_0"/>
-      </trigger>
-    </inputs>
+    <inputs/>
   </synapse>
   <synapse id="14" priority="1000000">
     <action_set>
@@ -222,18 +222,6 @@
   </synapse>
   <synapse id="15">
     <action_set>
-      <pseudo_event id="30" operation="stop" operation_key="clone-bottom_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="16">
-    <action_set>
       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
@@ -250,7 +238,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="17">
+  <synapse id="16">
     <action_set>
       <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -265,7 +253,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="18" priority="1000000">
+  <synapse id="17" priority="1000000">
     <action_set>
       <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="dom0-02" on_node_uuid="dom0-02">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -277,7 +265,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="19" priority="1000000">
+  <synapse id="18" priority="1000000">
     <action_set>
       <rsc_op id="5" operation="probe_complete" operation_key="probe_complete" on_node="dom0-01" on_node_uuid="dom0-01">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-0.dot
--- a/pengine/test10/notify-0.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-0.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -13,8 +13,6 @@
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1:1_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc2:0_stop_0 node1" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_start_0" -> "child_rsc1:1_start_0 node1" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-0.exp
--- a/pengine/test10/notify-0.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-0.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -30,11 +30,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="3" priority="1000000">
      <action_set>
@@ -82,11 +78,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="2" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="7" priority="1000000">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-1.dot
--- a/pengine/test10/notify-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -21,8 +21,6 @@
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1:1_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc2:0_stop_0 node1" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-post_notify_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-pre_notify_start_0" -> "rsc1_post_notify_running_0" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-1.exp
--- a/pengine/test10/notify-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -71,9 +71,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="12" operation="notified" operation_key="rsc1_confirmed-pre_notify_start_0"/>
        </trigger>
      </inputs>
@@ -195,9 +192,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="31" operation="notified" operation_key="rsc2_confirmed-pre_notify_stop_0"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-2.dot
--- a/pengine/test10/notify-2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -21,8 +21,6 @@
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_rsc1:1_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc2:0_stop_0 node1" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-post_notify_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-pre_notify_start_0" -> "rsc1_post_notify_running_0" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-2.exp
--- a/pengine/test10/notify-2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -71,9 +71,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="12" operation="notified" operation_key="rsc1_confirmed-pre_notify_start_0"/>
        </trigger>
      </inputs>
@@ -195,9 +192,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="31" operation="notified" operation_key="rsc2_confirmed-pre_notify_stop_0"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-3.dot
--- a/pengine/test10/notify-3.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-3.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -40,9 +40,6 @@
 "probe_complete" -> "child_rsc1:1_start_0 node1" [ style = bold]
 "probe_complete" -> "child_rsc1:1_stop_0 node2" [ style = bold]
 "probe_complete" -> "child_rsc2:0_stop_0 node1" [ style = bold]
-"probe_complete" -> "rsc1_start_0" [ style = bold]
-"probe_complete" -> "rsc1_stop_0" [ style = bold]
-"probe_complete" -> "rsc2_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-post_notify_running_0" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_confirmed-post_notify_stopped_0" -> "all_stopped" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/notify-3.exp
--- a/pengine/test10/notify-3.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/notify-3.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -138,9 +138,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="17" operation="notified" operation_key="rsc1_confirmed-pre_notify_start_0"/>
        </trigger>
        <trigger>
@@ -234,9 +231,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="23" operation="notified" operation_key="rsc1_confirmed-pre_notify_stop_0"/>
        </trigger>
      </inputs>
@@ -376,9 +370,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="36" operation="notified" operation_key="rsc2_confirmed-pre_notify_stop_0"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/novell-252693-2.dot
--- a/pengine/test10/novell-252693-2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/novell-252693-2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -114,17 +114,12 @@
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "configstoreclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "configstorecloneset_start_0" [ style = bold]
 "probe_complete" -> "evmsclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "evmscloneset_start_0" [ style = bold]
 "probe_complete" -> "evmsdclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "evmsdcloneset_start_0" [ style = bold]
 "probe_complete" -> "imagestoreclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "imagestorecloneset_start_0" [ style = bold]
 "probe_complete" -> "sles10_migrate_from_0 node1" [ style = bold]
 "probe_complete" -> "sles10_migrate_to_0 node2" [ style = bold]
 "probe_complete" -> "stonithclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "stonithcloneset_start_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "sles10_migrate_from_0 node1" -> "all_stopped" [ style = bold]
 "sles10_migrate_from_0 node1" -> "sles10_monitor_10000 node1" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/novell-252693-2.exp
--- a/pengine/test10/novell-252693-2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/novell-252693-2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -43,11 +43,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="4" priority="1000000">
      <action_set>
@@ -108,11 +104,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="9" priority="1000000">
      <action_set>
@@ -201,9 +193,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="29" operation="running" operation_key="evmsdcloneset_running_0"/>
        </trigger>
        <trigger>
@@ -370,9 +359,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="36" operation="running" operation_key="evmscloneset_running_0"/>
        </trigger>
        <trigger>
@@ -542,9 +528,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="36" operation="running" operation_key="evmscloneset_running_0"/>
        </trigger>
        <trigger>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/novell-252693-3.dot
--- a/pengine/test10/novell-252693-3.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/novell-252693-3.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -135,20 +135,14 @@
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "configstoreclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "configstorecloneset_start_0" [ style = bold]
 "probe_complete" -> "evmsclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "evmscloneset_start_0" [ style = bold]
 "probe_complete" -> "evmsdclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "evmsdcloneset_start_0" [ style = bold]
 "probe_complete" -> "imagestoreclone:0_start_0 node1" [ style = bold]
 "probe_complete" -> "imagestoreclone:0_stop_0 node2" [ style = bold]
 "probe_complete" -> "imagestoreclone:1_start_0 node2" [ style = bold]
-"probe_complete" -> "imagestorecloneset_start_0" [ style = bold]
-"probe_complete" -> "imagestorecloneset_stop_0" [ style = bold]
 "probe_complete" -> "sles10_start_0 node1" [ style = bold]
 "probe_complete" -> "sles10_stop_0 node2" [ style = bold]
 "probe_complete" -> "stonithclone:1_start_0 node1" [ style = bold]
-"probe_complete" -> "stonithcloneset_start_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "sles10_monitor_0 node1" -> "probe_complete node1" [ style = bold]
 "sles10_monitor_0 node1" [ style=bold color="green" fontcolor="black"  ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/novell-252693-3.exp
--- a/pengine/test10/novell-252693-3.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/novell-252693-3.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -43,11 +43,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="4" priority="1000000">
      <action_set>
@@ -108,11 +104,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="9" priority="1000000">
      <action_set>
@@ -201,9 +193,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="29" operation="running" operation_key="evmsdcloneset_running_0"/>
        </trigger>
        <trigger>
@@ -424,9 +413,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="36" operation="running" operation_key="evmscloneset_running_0"/>
        </trigger>
        <trigger>
@@ -526,9 +512,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="61" operation="notified" operation_key="imagestorecloneset_confirmed-pre_notify_stop_0"/>
        </trigger>
        <trigger>
@@ -689,9 +672,6 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="36" operation="running" operation_key="evmscloneset_running_0"/>
        </trigger>
        <trigger>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/order-clone.scores
--- a/pengine/test10/order-clone.scores	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/order-clone.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -115,15 +115,15 @@ native_color: ocfs2-2:3 allocation score
 native_color: ocfs2-2:3 allocation score on hex-8: -INFINITY
 native_color: ocfs2-2:3 allocation score on hex-9: -INFINITY
 native_color: ocfs2-2:3 allocation score on hex-0: -INFINITY
-native_color: vg1:0 allocation score on hex-7: 0
+native_color: vg1:0 allocation score on hex-7: -INFINITY
 native_color: vg1:0 allocation score on hex-8: 0
-native_color: vg1:0 allocation score on hex-9: 0
-native_color: vg1:0 allocation score on hex-0: 0
-native_color: vg1:1 allocation score on hex-7: 0
+native_color: vg1:0 allocation score on hex-9: -INFINITY
+native_color: vg1:0 allocation score on hex-0: -INFINITY
+native_color: vg1:1 allocation score on hex-7: -INFINITY
 native_color: vg1:1 allocation score on hex-8: -INFINITY
 native_color: vg1:1 allocation score on hex-9: 0
-native_color: vg1:1 allocation score on hex-0: 0
-native_color: vg1:2 allocation score on hex-7: 0
+native_color: vg1:1 allocation score on hex-0: -INFINITY
+native_color: vg1:2 allocation score on hex-7: -INFINITY
 native_color: vg1:2 allocation score on hex-8: -INFINITY
 native_color: vg1:2 allocation score on hex-9: -INFINITY
 native_color: vg1:2 allocation score on hex-0: 0
@@ -131,15 +131,15 @@ native_color: vg1:3 allocation score on 
 native_color: vg1:3 allocation score on hex-8: -INFINITY
 native_color: vg1:3 allocation score on hex-9: -INFINITY
 native_color: vg1:3 allocation score on hex-0: -INFINITY
-native_color: o2cb:0 allocation score on hex-7: 0
+native_color: o2cb:0 allocation score on hex-7: -INFINITY
 native_color: o2cb:0 allocation score on hex-8: 0
-native_color: o2cb:0 allocation score on hex-9: 0
-native_color: o2cb:0 allocation score on hex-0: 0
-native_color: o2cb:1 allocation score on hex-7: 0
+native_color: o2cb:0 allocation score on hex-9: -INFINITY
+native_color: o2cb:0 allocation score on hex-0: -INFINITY
+native_color: o2cb:1 allocation score on hex-7: -INFINITY
 native_color: o2cb:1 allocation score on hex-8: -INFINITY
 native_color: o2cb:1 allocation score on hex-9: 0
-native_color: o2cb:1 allocation score on hex-0: 0
-native_color: o2cb:2 allocation score on hex-7: 0
+native_color: o2cb:1 allocation score on hex-0: -INFINITY
+native_color: o2cb:2 allocation score on hex-7: -INFINITY
 native_color: o2cb:2 allocation score on hex-8: -INFINITY
 native_color: o2cb:2 allocation score on hex-9: -INFINITY
 native_color: o2cb:2 allocation score on hex-0: 0
@@ -187,15 +187,15 @@ clone_color: clvm:3 allocation score on 
 clone_color: clvm:3 allocation score on hex-8: 0
 clone_color: clvm:3 allocation score on hex-9: 0
 clone_color: clvm:3 allocation score on hex-0: 0
-native_color: clvm:0 allocation score on hex-7: 0
+native_color: clvm:0 allocation score on hex-7: -INFINITY
 native_color: clvm:0 allocation score on hex-8: 0
-native_color: clvm:0 allocation score on hex-9: 0
-native_color: clvm:0 allocation score on hex-0: 0
-native_color: clvm:1 allocation score on hex-7: 0
+native_color: clvm:0 allocation score on hex-9: -INFINITY
+native_color: clvm:0 allocation score on hex-0: -INFINITY
+native_color: clvm:1 allocation score on hex-7: -INFINITY
 native_color: clvm:1 allocation score on hex-8: -INFINITY
 native_color: clvm:1 allocation score on hex-9: 0
-native_color: clvm:1 allocation score on hex-0: 0
-native_color: clvm:2 allocation score on hex-7: 0
+native_color: clvm:1 allocation score on hex-0: -INFINITY
+native_color: clvm:2 allocation score on hex-7: -INFINITY
 native_color: clvm:2 allocation score on hex-8: -INFINITY
 native_color: clvm:2 allocation score on hex-9: -INFINITY
 native_color: clvm:2 allocation score on hex-0: 0
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/order-serialize-set.dot
--- a/pengine/test10/order-serialize-set.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/order-serialize-set.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -3,7 +3,6 @@ digraph "g" {
 "all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "base_migrate_from_0 xen-b" -> "all_stopped" [ style = bold]
 "base_migrate_from_0 xen-b" -> "base_monitor_10000 xen-b" [ style = bold]
-"base_migrate_from_0 xen-b" -> "xen-set-start-end" [ style = bold]
 "base_migrate_from_0 xen-b" [ style=bold color="green" fontcolor="black"  ]
 "base_migrate_to_0 xen-a" -> "all_stopped" [ style = bold]
 "base_migrate_to_0 xen-a" -> "base_migrate_from_0 xen-b" [ style = bold]
@@ -17,7 +16,6 @@ digraph "g" {
 "core-101_migrate_from_0 xen-b" -> "core-200_migrate_to_0 xen-a" [ style = bold]
 "core-101_migrate_from_0 xen-b" -> "edge_migrate_from_0 xen-b" [ style = bold]
 "core-101_migrate_from_0 xen-b" -> "edge_migrate_to_0 xen-a" [ style = bold]
-"core-101_migrate_from_0 xen-b" -> "xen-set-start-end" [ style = bold]
 "core-101_migrate_from_0 xen-b" [ style=bold color="green" fontcolor="black"  ]
 "core-101_migrate_to_0 xen-a" -> "all_stopped" [ style = bold]
 "core-101_migrate_to_0 xen-a" -> "core-101_migrate_from_0 xen-b" [ style = bold]
@@ -29,7 +27,6 @@ digraph "g" {
 "core-200_migrate_from_0 xen-b" -> "core-200_monitor_10000 xen-b" [ style = bold]
 "core-200_migrate_from_0 xen-b" -> "edge_migrate_from_0 xen-b" [ style = bold]
 "core-200_migrate_from_0 xen-b" -> "edge_migrate_to_0 xen-a" [ style = bold]
-"core-200_migrate_from_0 xen-b" -> "xen-set-start-end" [ style = bold]
 "core-200_migrate_from_0 xen-b" [ style=bold color="green" fontcolor="black"  ]
 "core-200_migrate_to_0 xen-a" -> "all_stopped" [ style = bold]
 "core-200_migrate_to_0 xen-a" -> "core-200_migrate_from_0 xen-b" [ style = bold]
@@ -45,7 +42,6 @@ digraph "g" {
 "db_migrate_from_0 xen-b" -> "db_monitor_10000 xen-b" [ style = bold]
 "db_migrate_from_0 xen-b" -> "edge_migrate_from_0 xen-b" [ style = bold]
 "db_migrate_from_0 xen-b" -> "edge_migrate_to_0 xen-a" [ style = bold]
-"db_migrate_from_0 xen-b" -> "xen-set-start-end" [ style = bold]
 "db_migrate_from_0 xen-b" [ style=bold color="green" fontcolor="black"  ]
 "db_migrate_to_0 xen-a" -> "all_stopped" [ style = bold]
 "db_migrate_to_0 xen-a" -> "db_migrate_from_0 xen-b" [ style = bold]
@@ -55,7 +51,6 @@ digraph "g" {
 "edge_migrate_from_0 xen-b" -> "base_migrate_from_0 xen-b" [ style = bold]
 "edge_migrate_from_0 xen-b" -> "base_migrate_to_0 xen-a" [ style = bold]
 "edge_migrate_from_0 xen-b" -> "edge_monitor_10000 xen-b" [ style = bold]
-"edge_migrate_from_0 xen-b" -> "xen-set-start-end" [ style = bold]
 "edge_migrate_from_0 xen-b" [ style=bold color="green" fontcolor="black"  ]
 "edge_migrate_to_0 xen-a" -> "all_stopped" [ style = bold]
 "edge_migrate_to_0 xen-a" -> "edge_migrate_from_0 xen-b" [ style = bold]
@@ -67,16 +62,4 @@ digraph "g" {
 "xen-a-fencing_stop_0 xen-b" -> "xen-a-fencing_start_0 xen-b" [ style = bold]
 "xen-a-fencing_stop_0 xen-b" [ style=bold color="green" fontcolor="black"  ]
 "xen-b-fencing_stop_0 xen-a" [ style=bold color="green" fontcolor="black"  ]
-"xen-set-start-begin" -> "base_migrate_from_0 xen-b" [ style = bold]
-"xen-set-start-begin" -> "base_migrate_to_0 xen-a" [ style = bold]
-"xen-set-start-begin" -> "core-101_migrate_from_0 xen-b" [ style = bold]
-"xen-set-start-begin" -> "core-101_migrate_to_0 xen-a" [ style = bold]
-"xen-set-start-begin" -> "core-200_migrate_from_0 xen-b" [ style = bold]
-"xen-set-start-begin" -> "core-200_migrate_to_0 xen-a" [ style = bold]
-"xen-set-start-begin" -> "db_migrate_from_0 xen-b" [ style = bold]
-"xen-set-start-begin" -> "db_migrate_to_0 xen-a" [ style = bold]
-"xen-set-start-begin" -> "edge_migrate_from_0 xen-b" [ style = bold]
-"xen-set-start-begin" -> "edge_migrate_to_0 xen-a" [ style = bold]
-"xen-set-start-begin" [ style=bold color="green" fontcolor="orange"  ]
-"xen-set-start-end" [ style=bold color="green" fontcolor="orange"  ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/order-serialize-set.exp
--- a/pengine/test10/order-serialize-set.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/order-serialize-set.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -8,26 +8,26 @@
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="14" operation="start" operation_key="xen-a-fencing_start_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="12" operation="start" operation_key="xen-a-fencing_start_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="1">
     <action_set>
-      <rsc_op id="14" operation="start" operation_key="xen-a-fencing_start_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="12" operation="start" operation_key="xen-a-fencing_start_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="xen-a-fencing" long-id="xen-a-fencing" class="stonith" type="external/ipmi"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2" hostname="xen-a" interface="lanplus" ipaddr="217.148.178.55" passwd="****" userid="root"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="18" operation="stop" operation_key="xen-a-fencing_stop_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="16" operation="stop" operation_key="xen-a-fencing_stop_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="2">
     <action_set>
-      <rsc_op id="18" operation="stop" operation_key="xen-a-fencing_stop_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="16" operation="stop" operation_key="xen-a-fencing_stop_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="xen-a-fencing" long-id="xen-a-fencing" class="stonith" type="external/ipmi"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
@@ -36,355 +36,292 @@
   </synapse>
   <synapse id="3">
     <action_set>
-      <rsc_op id="19" operation="stop" operation_key="xen-b-fencing_stop_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
+      <rsc_op id="17" operation="stop" operation_key="xen-b-fencing_stop_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
         <primitive id="xen-b-fencing" long-id="xen-b-fencing" class="stonith" type="external/ipmi"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="13" operation="all_stopped" operation_key="all_stopped"/>
+        <pseudo_event id="11" operation="all_stopped" operation_key="all_stopped"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="4">
     <action_set>
-      <rsc_op id="20" operation="migrate_to" operation_key="db_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
+      <rsc_op id="18" operation="migrate_to" operation_key="db_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
         <primitive id="db" long-id="db" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_to" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="db" xmfile="/etc/xen/db.cfg"/>
       </rsc_op>
     </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
-      </trigger>
-    </inputs>
+    <inputs/>
   </synapse>
   <synapse id="5">
     <action_set>
-      <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="db" long-id="db" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_source_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_from" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="db" xmfile="/etc/xen/db.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="20" operation="migrate_to" operation_key="db_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="18" operation="migrate_to" operation_key="db_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="6">
     <action_set>
-      <rsc_op id="22" operation="monitor" operation_key="db_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="20" operation="monitor" operation_key="db_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="db" long-id="db" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_timeout="20000" crm_feature_set="3.0.2" name="db" xmfile="/etc/xen/db.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="7">
     <action_set>
-      <rsc_op id="25" operation="migrate_to" operation_key="core-101_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
+      <rsc_op id="23" operation="migrate_to" operation_key="core-101_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
         <primitive id="core-101" long-id="core-101" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_to" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="core-101" xmfile="/etc/xen/core-101.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="8">
     <action_set>
-      <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="core-101" long-id="core-101" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_source_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_from" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="core-101" xmfile="/etc/xen/core-101.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="25" operation="migrate_to" operation_key="core-101_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="23" operation="migrate_to" operation_key="core-101_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="9">
     <action_set>
-      <rsc_op id="27" operation="monitor" operation_key="core-101_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="25" operation="monitor" operation_key="core-101_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="core-101" long-id="core-101" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_timeout="30000" crm_feature_set="3.0.2" name="core-101" xmfile="/etc/xen/core-101.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="10">
     <action_set>
-      <rsc_op id="28" operation="migrate_to" operation_key="core-200_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
+      <rsc_op id="26" operation="migrate_to" operation_key="core-200_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
         <primitive id="core-200" long-id="core-200" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_to" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="core-200" xmfile="/etc/xen/core-200.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="11">
     <action_set>
-      <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="27" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="core-200" long-id="core-200" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_source_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_from" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="core-200" xmfile="/etc/xen/core-200.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="28" operation="migrate_to" operation_key="core-200_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="26" operation="migrate_to" operation_key="core-200_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="12">
     <action_set>
-      <rsc_op id="30" operation="monitor" operation_key="core-200_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="28" operation="monitor" operation_key="core-200_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="core-200" long-id="core-200" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_timeout="20000" crm_feature_set="3.0.2" name="core-200" xmfile="/etc/xen/core-200.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="27" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="13">
     <action_set>
-      <rsc_op id="33" operation="migrate_to" operation_key="edge_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
+      <rsc_op id="31" operation="migrate_to" operation_key="edge_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
         <primitive id="edge" long-id="edge" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_to" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="edge" xmfile="/etc/xen/edge.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="27" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="14">
     <action_set>
-      <rsc_op id="34" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="32" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="edge" long-id="edge" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_source_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_from" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="edge" xmfile="/etc/xen/edge.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="27" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="33" operation="migrate_to" operation_key="edge_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="31" operation="migrate_to" operation_key="edge_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="15">
     <action_set>
-      <rsc_op id="35" operation="monitor" operation_key="edge_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="33" operation="monitor" operation_key="edge_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="edge" long-id="edge" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_timeout="20000" crm_feature_set="3.0.2" name="edge" xmfile="/etc/xen/edge.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="34" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="32" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="16">
     <action_set>
-      <rsc_op id="36" operation="migrate_to" operation_key="base_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
+      <rsc_op id="34" operation="migrate_to" operation_key="base_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7">
         <primitive id="base" long-id="base" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_to" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="base" xmfile="/etc/xen/base.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="27" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="34" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="32" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="17">
     <action_set>
-      <rsc_op id="37" operation="migrate_from" operation_key="base_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="35" operation="migrate_from" operation_key="base_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="base" long-id="base" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_migrate_source="xen-a" CRM_meta_migrate_source_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7" CRM_meta_migrate_target="xen-b" CRM_meta_name="migrate_from" CRM_meta_timeout="400000" crm_feature_set="3.0.2" name="base" xmfile="/etc/xen/base.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="27" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="32" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="34" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="36" operation="migrate_to" operation_key="base_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="34" operation="migrate_to" operation_key="base_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="18">
     <action_set>
-      <rsc_op id="38" operation="monitor" operation_key="base_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
+      <rsc_op id="36" operation="monitor" operation_key="base_monitor_10000" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331">
         <primitive id="base" long-id="base" class="ocf" provider="heartbeat" type="Xen"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_timeout="20000" crm_feature_set="3.0.2" name="base" xmfile="/etc/xen/base.cfg"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="37" operation="migrate_from" operation_key="base_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="35" operation="migrate_from" operation_key="base_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="19">
     <action_set>
-      <pseudo_event id="11" operation="xen-set-start-end" operation_key="xen-set-start-end">
+      <pseudo_event id="11" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="18" operation="migrate_to" operation_key="db_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="19" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="23" operation="migrate_to" operation_key="core-101_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
       <trigger>
-        <rsc_op id="34" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="24" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="37" operation="migrate_from" operation_key="base_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="20">
-    <action_set>
-      <pseudo_event id="12" operation="xen-set-start-begin" operation_key="xen-set-start-begin">
-        <attributes crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="21">
-    <action_set>
-      <pseudo_event id="13" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <rsc_op id="20" operation="migrate_to" operation_key="db_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="26" operation="migrate_to" operation_key="core-200_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
       <trigger>
-        <rsc_op id="21" operation="migrate_from" operation_key="db_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="27" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="25" operation="migrate_to" operation_key="core-101_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="31" operation="migrate_to" operation_key="edge_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
       <trigger>
-        <rsc_op id="26" operation="migrate_from" operation_key="core-101_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="32" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
       <trigger>
-        <rsc_op id="28" operation="migrate_to" operation_key="core-200_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
+        <rsc_op id="34" operation="migrate_to" operation_key="base_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
       </trigger>
       <trigger>
-        <rsc_op id="29" operation="migrate_from" operation_key="core-200_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="33" operation="migrate_to" operation_key="edge_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="34" operation="migrate_from" operation_key="edge_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="36" operation="migrate_to" operation_key="base_migrate_to_0" on_node="xen-a" on_node_uuid="445a93d5-655e-430b-b45d-47d79a2f78c7"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="37" operation="migrate_from" operation_key="base_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
+        <rsc_op id="35" operation="migrate_from" operation_key="base_migrate_from_0" on_node="xen-b" on_node_uuid="9cb7f556-e0a7-4073-8845-2d7c1d54e331"/>
       </trigger>
     </inputs>
   </synapse>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/order-sets.dot
--- a/pengine/test10/order-sets.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/order-sets.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -1,52 +1,32 @@
 digraph "g" {
 "all_stopped" [ style=bold color="green" fontcolor="orange"  ]
-"order-1-set-1-start-begin" -> "world1_start_0 ubuntu_1" [ style = bold]
-"order-1-set-1-start-begin" -> "world2_start_0 ubuntu_1" [ style = bold]
-"order-1-set-1-start-begin" -> "world3_start_0 ubuntu_1" [ style = bold]
-"order-1-set-1-start-begin" -> "world4_start_0 ubuntu_1" [ style = bold]
-"order-1-set-1-start-begin" [ style=bold color="green" fontcolor="orange"  ]
-"order-1-set-1-start-end" [ style=bold color="green" fontcolor="orange"  ]
-"order-1-set-1-stop-begin" -> "world1_stop_0 ubuntu_2" [ style = bold]
-"order-1-set-1-stop-begin" -> "world2_stop_0 ubuntu_2" [ style = bold]
-"order-1-set-1-stop-begin" -> "world3_stop_0 ubuntu_2" [ style = bold]
-"order-1-set-1-stop-begin" -> "world4_stop_0 ubuntu_2" [ style = bold]
-"order-1-set-1-stop-begin" [ style=bold color="green" fontcolor="orange"  ]
-"order-1-set-1-stop-end" [ style=bold color="green" fontcolor="orange"  ]
 "world1_monitor_10000 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
-"world1_start_0 ubuntu_1" -> "order-1-set-1-start-end" [ style = bold]
 "world1_start_0 ubuntu_1" -> "world1_monitor_10000 ubuntu_1" [ style = bold]
 "world1_start_0 ubuntu_1" -> "world2_start_0 ubuntu_1" [ style = bold]
 "world1_start_0 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
 "world1_stop_0 ubuntu_2" -> "all_stopped" [ style = bold]
-"world1_stop_0 ubuntu_2" -> "order-1-set-1-stop-end" [ style = bold]
 "world1_stop_0 ubuntu_2" -> "world1_start_0 ubuntu_1" [ style = bold]
 "world1_stop_0 ubuntu_2" [ style=bold color="green" fontcolor="black"  ]
 "world2_monitor_10000 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
-"world2_start_0 ubuntu_1" -> "order-1-set-1-start-end" [ style = bold]
 "world2_start_0 ubuntu_1" -> "world2_monitor_10000 ubuntu_1" [ style = bold]
 "world2_start_0 ubuntu_1" -> "world3_start_0 ubuntu_1" [ style = bold]
 "world2_start_0 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
 "world2_stop_0 ubuntu_2" -> "all_stopped" [ style = bold]
-"world2_stop_0 ubuntu_2" -> "order-1-set-1-stop-end" [ style = bold]
 "world2_stop_0 ubuntu_2" -> "world1_stop_0 ubuntu_2" [ style = bold]
 "world2_stop_0 ubuntu_2" -> "world2_start_0 ubuntu_1" [ style = bold]
 "world2_stop_0 ubuntu_2" [ style=bold color="green" fontcolor="black"  ]
 "world3_monitor_10000 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
-"world3_start_0 ubuntu_1" -> "order-1-set-1-start-end" [ style = bold]
 "world3_start_0 ubuntu_1" -> "world3_monitor_10000 ubuntu_1" [ style = bold]
 "world3_start_0 ubuntu_1" -> "world4_start_0 ubuntu_1" [ style = bold]
 "world3_start_0 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
 "world3_stop_0 ubuntu_2" -> "all_stopped" [ style = bold]
-"world3_stop_0 ubuntu_2" -> "order-1-set-1-stop-end" [ style = bold]
 "world3_stop_0 ubuntu_2" -> "world2_stop_0 ubuntu_2" [ style = bold]
 "world3_stop_0 ubuntu_2" -> "world3_start_0 ubuntu_1" [ style = bold]
 "world3_stop_0 ubuntu_2" [ style=bold color="green" fontcolor="black"  ]
 "world4_monitor_10000 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
-"world4_start_0 ubuntu_1" -> "order-1-set-1-start-end" [ style = bold]
 "world4_start_0 ubuntu_1" -> "world4_monitor_10000 ubuntu_1" [ style = bold]
 "world4_start_0 ubuntu_1" [ style=bold color="green" fontcolor="black"  ]
 "world4_stop_0 ubuntu_2" -> "all_stopped" [ style = bold]
-"world4_stop_0 ubuntu_2" -> "order-1-set-1-stop-end" [ style = bold]
 "world4_stop_0 ubuntu_2" -> "world3_stop_0 ubuntu_2" [ style = bold]
 "world4_stop_0 ubuntu_2" -> "world4_start_0 ubuntu_1" [ style = bold]
 "world4_stop_0 ubuntu_2" [ style=bold color="green" fontcolor="black"  ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/order-sets.exp
--- a/pengine/test10/order-sets.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/order-sets.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -1,266 +1,183 @@
 <transition_graph cluster-delay="5s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
   <synapse id="0">
     <action_set>
-      <rsc_op id="13" operation="stop" operation_key="world1_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
+      <rsc_op id="9" operation="stop" operation_key="world1_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
         <primitive id="world1" long-id="world1" class="ocf" provider="bbnd" type="world1test"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="8" operation="order-1-set-1-stop-begin" operation_key="order-1-set-1-stop-begin"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="16" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="12" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="1">
     <action_set>
-      <rsc_op id="14" operation="start" operation_key="world1_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
+      <rsc_op id="10" operation="start" operation_key="world1_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world1" long-id="world1" class="ocf" provider="bbnd" type="world1test"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="6" operation="order-1-set-1-start-begin" operation_key="order-1-set-1-start-begin"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="13" operation="stop" operation_key="world1_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="9" operation="stop" operation_key="world1_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="2">
     <action_set>
-      <rsc_op id="15" operation="monitor" operation_key="world1_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
+      <rsc_op id="11" operation="monitor" operation_key="world1_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world1" long-id="world1" class="ocf" provider="bbnd" type="world1test"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_on_fail="restart" CRM_meta_requires="nothing" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="14" operation="start" operation_key="world1_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
+        <rsc_op id="10" operation="start" operation_key="world1_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="3">
     <action_set>
-      <rsc_op id="16" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
+      <rsc_op id="12" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
         <primitive id="world2" long-id="world2" class="ocf" provider="bbnd" type="world2test"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="8" operation="order-1-set-1-stop-begin" operation_key="order-1-set-1-stop-begin"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="19" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="15" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="4">
     <action_set>
-      <rsc_op id="17" operation="start" operation_key="world2_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
+      <rsc_op id="13" operation="start" operation_key="world2_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world2" long-id="world2" class="ocf" provider="bbnd" type="world2test"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="6" operation="order-1-set-1-start-begin" operation_key="order-1-set-1-start-begin"/>
+        <rsc_op id="10" operation="start" operation_key="world1_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
       </trigger>
       <trigger>
-        <rsc_op id="14" operation="start" operation_key="world1_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="16" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="12" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="5">
     <action_set>
-      <rsc_op id="18" operation="monitor" operation_key="world2_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
+      <rsc_op id="14" operation="monitor" operation_key="world2_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world2" long-id="world2" class="ocf" provider="bbnd" type="world2test"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_on_fail="restart" CRM_meta_requires="nothing" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="17" operation="start" operation_key="world2_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
+        <rsc_op id="13" operation="start" operation_key="world2_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="6">
     <action_set>
-      <rsc_op id="19" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
+      <rsc_op id="15" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
         <primitive id="world3" long-id="world3" class="ocf" provider="bbnd" type="world3test"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="8" operation="order-1-set-1-stop-begin" operation_key="order-1-set-1-stop-begin"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="22" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="18" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="7">
     <action_set>
-      <rsc_op id="20" operation="start" operation_key="world3_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
+      <rsc_op id="16" operation="start" operation_key="world3_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world3" long-id="world3" class="ocf" provider="bbnd" type="world3test"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="6" operation="order-1-set-1-start-begin" operation_key="order-1-set-1-start-begin"/>
+        <rsc_op id="13" operation="start" operation_key="world2_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
       </trigger>
       <trigger>
-        <rsc_op id="17" operation="start" operation_key="world2_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="19" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="15" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="8">
     <action_set>
-      <rsc_op id="21" operation="monitor" operation_key="world3_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
+      <rsc_op id="17" operation="monitor" operation_key="world3_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world3" long-id="world3" class="ocf" provider="bbnd" type="world3test"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_on_fail="restart" CRM_meta_requires="nothing" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="20" operation="start" operation_key="world3_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
+        <rsc_op id="16" operation="start" operation_key="world3_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="9">
     <action_set>
-      <rsc_op id="22" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
+      <rsc_op id="18" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2">
+        <primitive id="world4" long-id="world4" class="ocf" provider="bbnd" type="world4test"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="10">
+    <action_set>
+      <rsc_op id="19" operation="start" operation_key="world4_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world4" long-id="world4" class="ocf" provider="bbnd" type="world4test"/>
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="8" operation="order-1-set-1-stop-begin" operation_key="order-1-set-1-stop-begin"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="10">
-    <action_set>
-      <rsc_op id="23" operation="start" operation_key="world4_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
-        <primitive id="world4" long-id="world4" class="ocf" provider="bbnd" type="world4test"/>
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </rsc_op>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="6" operation="order-1-set-1-start-begin" operation_key="order-1-set-1-start-begin"/>
+        <rsc_op id="16" operation="start" operation_key="world3_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
       </trigger>
       <trigger>
-        <rsc_op id="20" operation="start" operation_key="world3_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="22" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="18" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="11">
     <action_set>
-      <rsc_op id="24" operation="monitor" operation_key="world4_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
+      <rsc_op id="20" operation="monitor" operation_key="world4_monitor_10000" on_node="ubuntu_1" on_node_uuid="ubuntu_1">
         <primitive id="world4" long-id="world4" class="ocf" provider="bbnd" type="world4test"/>
         <attributes CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_on_fail="restart" CRM_meta_requires="nothing" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </rsc_op>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="23" operation="start" operation_key="world4_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
+        <rsc_op id="19" operation="start" operation_key="world4_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
       </trigger>
     </inputs>
   </synapse>
   <synapse id="12">
     <action_set>
-      <pseudo_event id="5" operation="order-1-set-1-start-end" operation_key="order-1-set-1-start-end">
+      <pseudo_event id="5" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
     <inputs>
       <trigger>
-        <rsc_op id="14" operation="start" operation_key="world1_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
+        <rsc_op id="9" operation="stop" operation_key="world1_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
       <trigger>
-        <rsc_op id="17" operation="start" operation_key="world2_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
+        <rsc_op id="12" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
       <trigger>
-        <rsc_op id="20" operation="start" operation_key="world3_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
+        <rsc_op id="15" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
       <trigger>
-        <rsc_op id="23" operation="start" operation_key="world4_start_0" on_node="ubuntu_1" on_node_uuid="ubuntu_1"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="13">
-    <action_set>
-      <pseudo_event id="6" operation="order-1-set-1-start-begin" operation_key="order-1-set-1-start-begin">
-        <attributes crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="14">
-    <action_set>
-      <pseudo_event id="7" operation="order-1-set-1-stop-end" operation_key="order-1-set-1-stop-end">
-        <attributes crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <rsc_op id="13" operation="stop" operation_key="world1_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="16" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="19" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="22" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="15">
-    <action_set>
-      <pseudo_event id="8" operation="order-1-set-1-stop-begin" operation_key="order-1-set-1-stop-begin">
-        <attributes crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs/>
-  </synapse>
-  <synapse id="16">
-    <action_set>
-      <pseudo_event id="9" operation="all_stopped" operation_key="all_stopped">
-        <attributes crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <rsc_op id="13" operation="stop" operation_key="world1_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="16" operation="stop" operation_key="world2_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="19" operation="stop" operation_key="world3_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
-      </trigger>
-      <trigger>
-        <rsc_op id="22" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
+        <rsc_op id="18" operation="stop" operation_key="world4_stop_0" on_node="ubuntu_2" on_node_uuid="ubuntu_2"/>
       </trigger>
     </inputs>
   </synapse>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/orphan-1.dot
--- a/pengine/test10/orphan-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/orphan-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -16,6 +16,7 @@
 "probe_complete c001n03" [ style=bold color="green" fontcolor="black" ]
 "probe_complete c001n08" -> "probe_complete" [ style = bold]
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
+"probe_complete" -> "rsc_c001n08_stop_0 c001n08" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc_c001n01_monitor_0 c001n02" -> "probe_complete c001n02" [ style = bold]
 "rsc_c001n01_monitor_0 c001n02" [ style=bold color="green" fontcolor="black" ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/orphan-1.exp
--- a/pengine/test10/orphan-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/orphan-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -141,7 +141,11 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </rsc_op>
      </action_set>
-     <inputs/>
+    <inputs>
+      <trigger>
+        <pseudo_event id="7" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
    </synapse>
    <synapse id="16">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/probe-0.dot
--- a/pengine/test10/probe-0.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/probe-0.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -27,15 +27,11 @@
 "configstorecloneset_start_0" -> "configstoreclone:1_start_0 x32c47" [ style = bold]
 "configstorecloneset_start_0" -> "configstorecloneset_running_0" [ style = bold]
 "configstorecloneset_start_0" [ style=bold color="green" fontcolor="orange" ]
-"configstorecloneset_stop_0" -> "configstorecloneset_start_0" [ style = bold]
-"configstorecloneset_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete x32c47" -> "probe_complete" [ style = bold]
 "probe_complete x32c47" [ style=bold color="green" fontcolor="black" ]
 "probe_complete x32c48" -> "probe_complete" [ style = bold]
 "probe_complete x32c48" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "configstoreclone:0_start_0 x32c48" [ style = bold]
 "probe_complete" -> "configstoreclone:1_start_0 x32c47" [ style = bold]
-"probe_complete" -> "configstorecloneset_start_0" [ style = bold]
-"probe_complete" -> "configstorecloneset_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/probe-0.exp
--- a/pengine/test10/probe-0.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/probe-0.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -83,14 +83,8 @@
      </action_set>
      <inputs>
        <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
          <pseudo_event id="38" operation="notified" operation_key="configstorecloneset_confirmed-pre_notify_start_0"/>
        </trigger>
-       <trigger>
-         <pseudo_event id="41" operation="stop" operation_key="configstorecloneset_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
    <synapse id="7" priority="1000000">
@@ -166,18 +160,6 @@
    </synapse>
    <synapse id="12">
      <action_set>
-       <pseudo_event id="41" operation="stop" operation_key="configstorecloneset_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="true" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="13">
-     <action_set>
        <pseudo_event id="4" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -191,7 +173,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="14" priority="1000000">
+  <synapse id="13" priority="1000000">
      <action_set>
        <rsc_op id="5" operation="probe_complete" operation_key="probe_complete" on_node="x32c48" on_node_uuid="ca93fea5-67c9-473d-9ce0-7ed7fb823872">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -203,7 +185,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="15" priority="1000000">
+  <synapse id="14" priority="1000000">
      <action_set>
        <rsc_op id="7" operation="probe_complete" operation_key="probe_complete" on_node="x32c47" on_node_uuid="a1dbc8cc-4d33-41e7-a75a-cd4f93b26410">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/probe-4.scores
--- a/pengine/test10/probe-4.scores	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/probe-4.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -167,3 +167,5 @@ native_color: FencingChild:1 allocation 
 native_color: FencingChild:1 allocation score on pcmk-2: -INFINITY
 native_color: FencingChild:1 allocation score on pcmk-3: -INFINITY
 native_color: FencingChild:1 allocation score on pcmk-4: -INFINITY
+Transition failed: terminated
+An invalid transition was produced
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/quorum-5.dot
--- a/pengine/test10/quorum-5.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/quorum-5.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -12,25 +12,14 @@
 "child_DoFencing_2_start_0 hadev2" -> "child_DoFencing_2_monitor_5000 hadev2" [ style = bold]
 "child_DoFencing_2_start_0 hadev2" -> "group1_running_0" [ style = bold]
 "child_DoFencing_2_start_0 hadev2" [ style=bold color="green" fontcolor="black" ]
-"child_DoFencing_2_stop_0" -> "group1_stopped_0" [ style = bold]
-"child_DoFencing_2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "group1_running_0" [ style=bold color="green" fontcolor="orange" ]
 "group1_start_0" -> "child_DoFencing_1_start_0 hadev2" [ style = bold]
 "group1_start_0" -> "child_DoFencing_2_start_0 hadev2" [ style = bold]
 "group1_start_0" -> "group1_running_0" [ style = bold]
 "group1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"group1_stop_0" -> "child_DoFencing_2_stop_0" [ style = bold]
-"group1_stop_0" -> "group1_start_0" [ style = bold]
-"group1_stop_0" -> "group1_stopped_0" [ style = bold]
-"group1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"group1_stopped_0" -> "group1_start_0" [ style = bold]
-"group1_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete hadev2" -> "probe_complete" [ style = bold]
 "probe_complete hadev2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "child_DoFencing_1_start_0 hadev2" [ style = bold]
 "probe_complete" -> "child_DoFencing_2_start_0 hadev2" [ style = bold]
-"probe_complete" -> "child_DoFencing_2_stop_0" [ style = bold]
-"probe_complete" -> "group1_start_0" [ style = bold]
-"probe_complete" -> "group1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/quorum-5.exp
--- a/pengine/test10/quorum-5.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/quorum-5.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -5,17 +5,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="12" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="13" operation="stopped" operation_key="group1_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="1">
      <action_set>
@@ -37,33 +27,6 @@
    </synapse>
    <synapse id="2">
      <action_set>
-       <pseudo_event id="12" operation="stop" operation_key="group1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="3">
-     <action_set>
-       <pseudo_event id="13" operation="stopped" operation_key="group1_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="12" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="17" operation="stop" operation_key="child_DoFencing_2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="4">
-     <action_set>
        <rsc_op id="4" operation="monitor" operation_key="child_DoFencing_1_monitor_0" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
          <primitive id="child_DoFencing_1" long-id="group1:child_DoFencing_1" class="stonith" type="ssh"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" hostlist="hadev1 hadev2 hadev3 "/>
@@ -71,7 +34,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="5">
+  <synapse id="3">
      <action_set>
        <rsc_op id="6" operation="start" operation_key="child_DoFencing_1_start_0" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
          <primitive id="child_DoFencing_1" long-id="group1:child_DoFencing_1" class="stonith" type="ssh"/>
@@ -87,7 +50,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="6">
+  <synapse id="4">
      <action_set>
        <rsc_op id="7" operation="monitor" operation_key="child_DoFencing_1_monitor_5000" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
          <primitive id="child_DoFencing_1" long-id="group1:child_DoFencing_1" class="stonith" type="ssh"/>
@@ -100,7 +63,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="7">
+  <synapse id="5">
      <action_set>
        <rsc_op id="5" operation="monitor" operation_key="child_DoFencing_2_monitor_0" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
          <primitive id="child_DoFencing_2" long-id="group1:child_DoFencing_2" class="stonith" type="ssh"/>
@@ -109,7 +72,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="8">
+  <synapse id="6">
      <action_set>
        <rsc_op id="8" operation="start" operation_key="child_DoFencing_2_start_0" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
          <primitive id="child_DoFencing_2" long-id="group1:child_DoFencing_2" class="stonith" type="ssh"/>
@@ -128,7 +91,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="9">
+  <synapse id="7">
      <action_set>
        <rsc_op id="9" operation="monitor" operation_key="child_DoFencing_2_monitor_5000" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
          <primitive id="child_DoFencing_2" long-id="group1:child_DoFencing_2" class="stonith" type="ssh"/>
@@ -141,22 +104,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="10">
-     <action_set>
-      <pseudo_event id="17" operation="stop" operation_key="child_DoFencing_2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="12" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="11">
+  <synapse id="8">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -168,7 +116,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="12" priority="1000000">
+  <synapse id="9" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/quorum-6.dot
--- a/pengine/test10/quorum-6.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/quorum-6.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -3,8 +3,6 @@
 "DoFencing_start_0" -> "DoFencing_running_0" [ style = bold]
 "DoFencing_start_0" -> "child_DoFencing:0_start_0 hadev2" [ style = bold]
 "DoFencing_start_0" [ style=bold color="green" fontcolor="orange" ]
-"DoFencing_stop_0" -> "DoFencing_start_0" [ style = bold]
-"DoFencing_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_DoFencing:0_monitor_0 hadev2" -> "probe_complete hadev2" [ style = bold]
 "child_DoFencing:0_monitor_0 hadev2" [ style=bold color="green" fontcolor="black" ]
 "child_DoFencing:0_monitor_5000 hadev2" [ style=bold color="green" fontcolor="black" ]
@@ -27,8 +25,6 @@
 "child_DoFencing:7_monitor_0 hadev2" [ style=bold color="green" fontcolor="black" ]
 "probe_complete hadev2" -> "probe_complete" [ style = bold]
 "probe_complete hadev2" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_start_0" [ style = bold]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_start_0 hadev2" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 }
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/quorum-6.exp
--- a/pengine/test10/quorum-6.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/quorum-6.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -106,14 +106,7 @@
         <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="16" operation="stop" operation_key="DoFencing_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="11" priority="1000000">
      <action_set>
@@ -132,18 +125,6 @@
    </synapse>
    <synapse id="12">
      <action_set>
-       <pseudo_event id="16" operation="stop" operation_key="DoFencing_stop_0">
-        <attributes CRM_meta_clone_max="8" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="13">
-     <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -154,7 +135,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="14" priority="1000000">
+  <synapse id="13" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="hadev2" on_node_uuid="190b75b6-5585-42d9-8cde-eb6041843ae3">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-11.dot
--- a/pengine/test10/rec-node-11.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-11.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -16,12 +16,11 @@
 "group1_stopped_0" [ style=bold color="green" fontcolor="orange" ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "group1_start_0" [ style = bold]
-"probe_complete" -> "group1_stop_0" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node2" [ style = bold]
 "probe_complete" -> "rsc1_stop_0 node1" [ style = bold]
 "probe_complete" -> "rsc2_start_0 node2" [ style = bold]
 "probe_complete" -> "rsc2_stop_0 node1" [ style = bold]
+"probe_complete" -> "rsc3_stop_0 node2" [ style = bold]
 "probe_complete" -> "stonith-1_start_0 node2" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_monitor_0 node2" -> "probe_complete node2" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-11.exp
--- a/pengine/test10/rec-node-11.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-11.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -29,9 +29,6 @@
      </action_set>
      <inputs>
        <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
         <pseudo_event id="14" operation="stop" operation_key="group1_stop_0"/>
        </trigger>
        <trigger>
@@ -68,9 +65,6 @@
      </action_set>
      <inputs>
        <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-      <trigger>
         <crm_event id="20" operation="stonith" operation_key="stonith" on_node="node1" on_node_uuid="uuid1"/>
       </trigger>
      </inputs>
@@ -200,6 +194,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <pseudo_event id="15" operation="stopped" operation_key="group1_stopped_0"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-12.dot
--- a/pengine/test10/rec-node-12.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-12.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -14,8 +14,6 @@
 "DoFencing_start_0" -> "child_DoFencing:1_start_0 c001n08" [ style = bold]
 "DoFencing_start_0" -> "child_DoFencing:2_start_0 c001n03" [ style = bold]
 "DoFencing_start_0" [ style=bold color="green" fontcolor="orange" ]
-"DoFencing_stop_0" -> "DoFencing_start_0" [ style = bold]
-"DoFencing_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "all_stopped" -> "DcIPaddr_start_0 c001n08" [ style = bold]
 "all_stopped" -> "rsc_c001n01_start_0 c001n01" [ style = bold]
 "all_stopped" -> "rsc_c001n02_start_0 c001n03" [ style = bold]
@@ -68,8 +66,6 @@
 "probe_complete c001n08" -> "probe_complete" [ style = bold]
 "probe_complete c001n08" [ style=bold color="green" fontcolor="black" ]
 "probe_complete" -> "DcIPaddr_start_0 c001n08" [ style = bold]
-"probe_complete" -> "DoFencing_start_0" [ style = bold]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:0_start_0 c001n01" [ style = bold]
 "probe_complete" -> "child_DoFencing:1_start_0 c001n08" [ style = bold]
 "probe_complete" -> "child_DoFencing:2_start_0 c001n03" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-12.exp
--- a/pengine/test10/rec-node-12.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-12.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -480,14 +480,7 @@
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-         <pseudo_event id="51" operation="stop" operation_key="DoFencing_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
    <synapse id="44" priority="1000000">
      <action_set>
@@ -512,18 +505,6 @@
    </synapse>
    <synapse id="45">
      <action_set>
-       <pseudo_event id="51" operation="stop" operation_key="DoFencing_stop_0">
-        <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="46">
-     <action_set>
        <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
@@ -534,7 +515,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="47">
+  <synapse id="46">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -552,7 +533,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="48" priority="1000000">
+  <synapse id="47" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="c001n08" on_node_uuid="6427cb5a-c7a5-4bdf-9892-a04ce56f4e6b">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -588,7 +569,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="49" priority="1000000">
+  <synapse id="48" priority="1000000">
      <action_set>
        <rsc_op id="13" operation="probe_complete" operation_key="probe_complete" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -624,7 +605,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="50" priority="1000000">
+  <synapse id="49" priority="1000000">
      <action_set>
        <rsc_op id="23" operation="probe_complete" operation_key="probe_complete" on_node="c001n01" on_node_uuid="de937e3d-0309-4b5d-b85c-f96edc1ed8e3">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -660,7 +641,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="51">
+  <synapse id="50">
      <action_set>
        <pseudo_event id="53" operation="stonith_up" operation_key="stonith_up">
         <attributes crm_feature_set="3.0.2"/>
@@ -678,7 +659,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="52">
+  <synapse id="51">
      <action_set>
       <pseudo_event id="54" operation="stonith_complete" operation_key="stonith_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -693,7 +674,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="53">
+  <synapse id="52">
     <action_set>
       <crm_event id="55" operation="stonith" operation_key="stonith" on_node="c001n02" on_node_uuid="e9bdfde9-01b0-421f-acd8-8a65a53e775f">
         <attributes CRM_meta_on_node="c001n02" CRM_meta_on_node_uuid="e9bdfde9-01b0-421f-acd8-8a65a53e775f" CRM_meta_stonith_action="reboot" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-15.dot
--- a/pengine/test10/rec-node-15.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-15.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -86,6 +86,9 @@
 "probe_complete sapcl01" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete sapcl02" -> "probe_complete" [ style = bold]
 "probe_complete sapcl02" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete" -> "Filesystem_13_stop_0 sapcl02" [ style = bold]
+"probe_complete" -> "IPaddr_192_168_1_102_stop_0 sapcl02" [ style = bold]
+"probe_complete" -> "LVM_12_stop_0 sapcl02" [ style = bold]
 "probe_complete" -> "stonith-1_start_0 sapcl01" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "stonith sapcl03" -> "all_stopped" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-15.exp
--- a/pengine/test10/rec-node-15.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-15.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -104,6 +104,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="8" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="27" operation="stop" operation_key="LVM_12_stop_0" on_node="sapcl02" on_node_uuid="09fa194c-d7e1-41fa-a0d0-afd79a139181"/>
        </trigger>
        <trigger>
@@ -152,6 +155,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="8" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <rsc_op id="30" operation="stop" operation_key="Filesystem_13_stop_0" on_node="sapcl02" on_node_uuid="09fa194c-d7e1-41fa-a0d0-afd79a139181"/>
        </trigger>
        <trigger>
@@ -203,6 +209,9 @@
      </action_set>
      <inputs>
        <trigger>
+        <pseudo_event id="8" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
         <pseudo_event id="35" operation="stop" operation_key="app02_stop_0"/>
        </trigger>
      </inputs>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-2.dot
--- a/pengine/test10/rec-node-2.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-2.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -9,41 +9,19 @@
 "group1_start_0" -> "rsc3_start_0 node2" [ style = bold]
 "group1_start_0" -> "rsc4_start_0 node2" [ style = bold]
 "group1_start_0" [ style=bold color="green" fontcolor="orange" ]
-"group1_stop_0" -> "group1_start_0" [ style = bold]
-"group1_stop_0" -> "group1_stopped_0" [ style = bold]
-"group1_stop_0" -> "rsc3_stop_0" [ style = bold]
-"group1_stop_0" -> "rsc4_stop_0" [ style = bold]
-"group1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"group1_stopped_0" -> "group1_start_0" [ style = bold]
-"group1_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "group2_running_0" [ style=bold color="green" fontcolor="orange" ]
 "group2_start_0" -> "group2_running_0" [ style = bold]
 "group2_start_0" -> "rsc5_start_0 node2" [ style = bold]
 "group2_start_0" -> "rsc6_start_0 node2" [ style = bold]
 "group2_start_0" [ style=bold color="green" fontcolor="orange" ]
-"group2_stop_0" -> "group2_start_0" [ style = bold]
-"group2_stop_0" -> "group2_stopped_0" [ style = bold]
-"group2_stop_0" -> "rsc5_stop_0" [ style = bold]
-"group2_stop_0" -> "rsc6_stop_0" [ style = bold]
-"group2_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"group2_stopped_0" -> "group2_start_0" [ style = bold]
-"group2_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node2" -> "probe_complete" [ style = bold]
 "probe_complete node2" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "group1_start_0" [ style = bold]
-"probe_complete" -> "group1_stop_0" [ style = bold]
-"probe_complete" -> "group2_start_0" [ style = bold]
-"probe_complete" -> "group2_stop_0" [ style = bold]
 "probe_complete" -> "rsc1_start_0 node2" [ style = bold]
 "probe_complete" -> "rsc2_start_0 node2" [ style = bold]
 "probe_complete" -> "rsc3_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc3_stop_0" [ style = bold]
 "probe_complete" -> "rsc4_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc4_stop_0" [ style = bold]
 "probe_complete" -> "rsc5_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc5_stop_0" [ style = bold]
 "probe_complete" -> "rsc6_start_0 node2" [ style = bold]
-"probe_complete" -> "rsc6_stop_0" [ style = bold]
 "probe_complete" -> "stonith-1_start_0 node2" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_monitor_0 node2" -> "probe_complete node2" [ style = bold]
@@ -57,33 +35,19 @@
 "rsc3_start_0 node2" -> "group1_running_0" [ style = bold]
 "rsc3_start_0 node2" -> "rsc4_start_0 node2" [ style = bold]
 "rsc3_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"rsc3_stop_0" -> "all_stopped" [ style = bold]
-"rsc3_stop_0" -> "group1_stopped_0" [ style = bold]
-"rsc3_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc4_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "rsc4_monitor_0 node2" [ style=bold color="green" fontcolor="black" ]
 "rsc4_start_0 node2" -> "group1_running_0" [ style = bold]
 "rsc4_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"rsc4_stop_0" -> "all_stopped" [ style = bold]
-"rsc4_stop_0" -> "group1_stopped_0" [ style = bold]
-"rsc4_stop_0" -> "rsc3_stop_0" [ style = bold]
-"rsc4_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc5_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "rsc5_monitor_0 node2" [ style=bold color="green" fontcolor="black" ]
 "rsc5_start_0 node2" -> "group2_running_0" [ style = bold]
 "rsc5_start_0 node2" -> "rsc6_start_0 node2" [ style = bold]
 "rsc5_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"rsc5_stop_0" -> "all_stopped" [ style = bold]
-"rsc5_stop_0" -> "group2_stopped_0" [ style = bold]
-"rsc5_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "rsc6_monitor_0 node2" -> "probe_complete node2" [ style = bold]
 "rsc6_monitor_0 node2" [ style=bold color="green" fontcolor="black" ]
 "rsc6_start_0 node2" -> "group2_running_0" [ style = bold]
 "rsc6_start_0 node2" [ style=bold color="green" fontcolor="black" ]
-"rsc6_stop_0" -> "all_stopped" [ style = bold]
-"rsc6_stop_0" -> "group2_stopped_0" [ style = bold]
-"rsc6_stop_0" -> "rsc5_stop_0" [ style = bold]
-"rsc6_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "stonith node1" -> "all_stopped" [ style = bold]
 "stonith node1" -> "stonith_complete" [ style = bold]
 "stonith node1" [ style=bold color="green" fontcolor="black" ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rec-node-2.exp
--- a/pengine/test10/rec-node-2.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/rec-node-2.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -77,17 +77,7 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="18" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="19" operation="stopped" operation_key="group1_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
   <synapse id="7">
      <action_set>
@@ -109,36 +99,6 @@
    </synapse>
   <synapse id="8">
      <action_set>
-      <pseudo_event id="18" operation="stop" operation_key="group1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="9">
-     <action_set>
-      <pseudo_event id="19" operation="stopped" operation_key="group1_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="18" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="31" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="32" operation="stop" operation_key="rsc4_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="10">
-     <action_set>
       <rsc_op id="7" operation="monitor" operation_key="rsc3_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc3" long-id="group1:rsc3" class="heartbeat" type="apache"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -146,7 +106,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="11">
+  <synapse id="9">
      <action_set>
       <rsc_op id="14" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc3" long-id="group1:rsc3" class="heartbeat" type="apache"/>
@@ -165,25 +125,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="12">
-     <action_set>
-      <pseudo_event id="31" operation="stop" operation_key="rsc3_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="18" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="32" operation="stop" operation_key="rsc4_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="13">
+  <synapse id="10">
      <action_set>
       <rsc_op id="8" operation="monitor" operation_key="rsc4_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc4" long-id="group1:rsc4" class="heartbeat" type="apache"/>
@@ -192,7 +134,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="14">
+  <synapse id="11">
      <action_set>
       <rsc_op id="15" operation="start" operation_key="rsc4_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc4" long-id="group1:rsc4" class="heartbeat" type="apache"/>
@@ -214,40 +156,15 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="15">
-     <action_set>
-      <pseudo_event id="32" operation="stop" operation_key="rsc4_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="18" operation="stop" operation_key="group1_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="16">
+  <synapse id="12">
      <action_set>
       <pseudo_event id="22" operation="start" operation_key="group2_start_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="24" operation="stop" operation_key="group2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="25" operation="stopped" operation_key="group2_stopped_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
-  <synapse id="17">
+  <synapse id="13">
      <action_set>
       <pseudo_event id="23" operation="running" operation_key="group2_running_0">
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -265,37 +182,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="18">
-     <action_set>
-      <pseudo_event id="24" operation="stop" operation_key="group2_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="19">
-     <action_set>
-      <pseudo_event id="25" operation="stopped" operation_key="group2_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="24" operation="stop" operation_key="group2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="33" operation="stop" operation_key="rsc5_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="34" operation="stop" operation_key="rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="20">
+  <synapse id="14">
      <action_set>
       <rsc_op id="9" operation="monitor" operation_key="rsc5_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc5" long-id="group2:rsc5" class="heartbeat" type="apache"/>
@@ -304,7 +191,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="21">
+  <synapse id="15">
      <action_set>
       <rsc_op id="20" operation="start" operation_key="rsc5_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc5" long-id="group2:rsc5" class="heartbeat" type="apache"/>
@@ -323,25 +210,7 @@
       </trigger>
      </inputs>
    </synapse>
-  <synapse id="22">
-     <action_set>
-      <pseudo_event id="33" operation="stop" operation_key="rsc5_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="24" operation="stop" operation_key="group2_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="34" operation="stop" operation_key="rsc6_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="23">
+  <synapse id="16">
      <action_set>
       <rsc_op id="10" operation="monitor" operation_key="rsc6_monitor_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc6" long-id="group2:rsc6" class="heartbeat" type="apache"/>
@@ -350,7 +219,7 @@
      </action_set>
      <inputs/>
    </synapse>
-  <synapse id="24">
+  <synapse id="17">
      <action_set>
       <rsc_op id="21" operation="start" operation_key="rsc6_start_0" on_node="node2" on_node_uuid="uuid2">
          <primitive id="rsc6" long-id="group2:rsc6" class="heartbeat" type="apache"/>
@@ -372,22 +241,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="25">
-     <action_set>
-      <pseudo_event id="34" operation="stop" operation_key="rsc6_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-         <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="24" operation="stop" operation_key="group2_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-  <synapse id="26">
+  <synapse id="18">
      <action_set>
        <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
@@ -397,21 +251,9 @@
        <trigger>
         <crm_event id="28" operation="stonith" operation_key="stonith" on_node="node1" on_node_uuid="uuid1"/>
        </trigger>
-       <trigger>
-        <pseudo_event id="31" operation="stop" operation_key="rsc3_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="32" operation="stop" operation_key="rsc4_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="33" operation="stop" operation_key="rsc5_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="34" operation="stop" operation_key="rsc6_stop_0"/>
-       </trigger>
      </inputs>
    </synapse>
-  <synapse id="27">
+  <synapse id="19">
      <action_set>
        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -423,7 +265,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="28" priority="1000000">
+  <synapse id="20" priority="1000000">
      <action_set>
        <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="uuid2">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -453,7 +295,7 @@
        </trigger>
      </inputs>
    </synapse>
-  <synapse id="29">
+  <synapse id="21">
      <action_set>
       <pseudo_event id="26" operation="stonith_up" operation_key="stonith_up">
         <attributes crm_feature_set="3.0.2"/>
@@ -465,7 +307,7 @@
       </trigger>
     </inputs>
    </synapse>
-  <synapse id="30">
+  <synapse id="22">
      <action_set>
       <pseudo_event id="27" operation="stonith_complete" operation_key="stonith_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -480,7 +322,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="31">
+  <synapse id="23">
     <action_set>
       <crm_event id="28" operation="stonith" operation_key="stonith" on_node="node1" on_node_uuid="uuid1">
         <attributes CRM_meta_on_node="node1" CRM_meta_on_node_uuid="uuid1" CRM_meta_stonith_action="reboot" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone-1.dot
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,103 @@
+digraph "g" {
+"baseclone_running_0" [ style=bold color="green" fontcolor="orange"  ]
+"baseclone_start_0" -> "baseclone_running_0" [ style = bold]
+"baseclone_start_0" -> "basegrp:1_start_0" [ style = bold]
+"baseclone_start_0" [ style=bold color="green" fontcolor="orange"  ]
+"basegrp:1_running_0" -> "baseclone_running_0" [ style = bold]
+"basegrp:1_running_0" [ style=bold color="green" fontcolor="orange"  ]
+"basegrp:1_start_0" -> "basegrp:1_running_0" [ style = bold]
+"basegrp:1_start_0" -> "clvmd:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" -> "controld:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" -> "fs2:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" -> "iscsi1:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" -> "iscsi2:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" -> "o2cb:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" -> "vg1:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" -> "vg2:1_start_0 sys3" [ style = bold]
+"basegrp:1_start_0" [ style=bold color="green" fontcolor="orange"  ]
+"clvmd:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"clvmd:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"clvmd:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"clvmd:1_start_0 sys3" -> "o2cb:1_start_0 sys3" [ style = bold]
+"clvmd:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"controld:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"controld:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"controld:1_monitor_10000 sys3" [ style=bold color="green" fontcolor="black"  ]
+"controld:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"controld:1_start_0 sys3" -> "clvmd:1_start_0 sys3" [ style = bold]
+"controld:1_start_0 sys3" -> "controld:1_monitor_10000 sys3" [ style = bold]
+"controld:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"fs2:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"fs2:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"fs2:1_monitor_20000 sys3" [ style=bold color="green" fontcolor="black"  ]
+"fs2:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"fs2:1_start_0 sys3" -> "fs2:1_monitor_20000 sys3" [ style = bold]
+"fs2:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"iscsi1:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"iscsi1:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"iscsi1:1_monitor_120000 sys3" [ style=bold color="green" fontcolor="black"  ]
+"iscsi1:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"iscsi1:1_start_0 sys3" -> "iscsi1:1_monitor_120000 sys3" [ style = bold]
+"iscsi1:1_start_0 sys3" -> "iscsi2:1_start_0 sys3" [ style = bold]
+"iscsi1:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"iscsi2:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"iscsi2:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"iscsi2:1_monitor_120000 sys3" [ style=bold color="green" fontcolor="black"  ]
+"iscsi2:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"iscsi2:1_start_0 sys3" -> "iscsi2:1_monitor_120000 sys3" [ style = bold]
+"iscsi2:1_start_0 sys3" -> "vg1:1_start_0 sys3" [ style = bold]
+"iscsi2:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"load_stopped_sys2 sys2" [ style=bold color="green" fontcolor="orange"  ]
+"load_stopped_sys3 sys3" [ style=bold color="green" fontcolor="orange"  ]
+"nfs1:0_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"nfs1:0_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"o2cb:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"o2cb:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"o2cb:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"o2cb:1_start_0 sys3" -> "iscsi1:1_start_0 sys3" [ style = bold]
+"o2cb:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete sys3" -> "probe_complete" [ style = bold]
+"probe_complete sys3" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete" -> "clvmd:1_start_0 sys3" [ style = bold]
+"probe_complete" -> "controld:1_start_0 sys3" [ style = bold]
+"probe_complete" -> "fs2:1_start_0 sys3" [ style = bold]
+"probe_complete" -> "iscsi1:1_start_0 sys3" [ style = bold]
+"probe_complete" -> "iscsi2:1_start_0 sys3" [ style = bold]
+"probe_complete" -> "o2cb:1_start_0 sys3" [ style = bold]
+"probe_complete" -> "stonithsys2_start_0 sys3" [ style = bold]
+"probe_complete" -> "stonithsys3_start_0 sys2" [ style = bold]
+"probe_complete" -> "stonithsys3_stop_0 sys2" [ style = bold]
+"probe_complete" -> "vg1:1_start_0 sys3" [ style = bold]
+"probe_complete" -> "vg2:1_start_0 sys3" [ style = bold]
+"probe_complete" [ style=bold color="green" fontcolor="orange"  ]
+"stonithsys2_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"stonithsys2_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"stonithsys2_monitor_15000 sys3" [ style=bold color="green" fontcolor="black"  ]
+"stonithsys2_start_0 sys3" -> "stonithsys2_monitor_15000 sys3" [ style = bold]
+"stonithsys2_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"stonithsys3_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"stonithsys3_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"stonithsys3_monitor_15000 sys2" [ style=bold color="green" fontcolor="black"  ]
+"stonithsys3_start_0 sys2" -> "stonithsys3_monitor_15000 sys2" [ style = bold]
+"stonithsys3_start_0 sys2" [ style=bold color="green" fontcolor="black"  ]
+"stonithsys3_stop_0 sys2" -> "stonithsys3_start_0 sys2" [ style = bold]
+"stonithsys3_stop_0 sys2" [ style=bold color="green" fontcolor="black"  ]
+"vg1:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"vg1:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"vg1:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"vg1:1_start_0 sys3" -> "vg2:1_start_0 sys3" [ style = bold]
+"vg1:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"vg2:1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"vg2:1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"vg2:1_start_0 sys3" -> "basegrp:1_running_0" [ style = bold]
+"vg2:1_start_0 sys3" -> "fs2:1_start_0 sys3" [ style = bold]
+"vg2:1_start_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"vm1_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"vm1_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"vm2_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"vm2_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"vm3_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"vm3_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+"vm4_monitor_0 sys3" -> "probe_complete sys3" [ style = bold]
+"vm4_monitor_0 sys3" [ style=bold color="green" fontcolor="black"  ]
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone-1.exp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,560 @@
+<transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
+  <synapse id="0" priority="4">
+    <action_set>
+      <rsc_op id="14" operation="monitor" operation_key="vm1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vm1" long-id="vm1" class="ocf" provider="heartbeat" type="Xen"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" xmfile="/etc/xen/vm/vm1"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="1" priority="3">
+    <action_set>
+      <rsc_op id="15" operation="monitor" operation_key="vm2_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vm2" long-id="vm2" class="ocf" provider="heartbeat" type="Xen"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" xmfile="/etc/xen/vm/vm2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="2" priority="2">
+    <action_set>
+      <rsc_op id="16" operation="monitor" operation_key="vm3_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vm3" long-id="vm3" class="ocf" provider="heartbeat" type="Xen"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" xmfile="/etc/xen/vm/vm3"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="3" priority="1">
+    <action_set>
+      <rsc_op id="17" operation="monitor" operation_key="vm4_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vm4" long-id="vm4" class="ocf" provider="heartbeat" type="Xen"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" xmfile="/etc/xen/vm/vm4"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="4">
+    <action_set>
+      <rsc_op id="18" operation="monitor" operation_key="stonithsys2_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="stonithsys2" long-id="stonithsys2" class="stonith" type="external/ipmi"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" hostname="sys2" interface="lan" ipaddr="192.168.1.221" passwd="****" userid="admin"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="5">
+    <action_set>
+      <rsc_op id="31" operation="start" operation_key="stonithsys2_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="stonithsys2" long-id="stonithsys2" class="stonith" type="external/ipmi"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2" hostname="sys2" interface="lan" ipaddr="192.168.1.221" passwd="****" userid="admin"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="6">
+    <action_set>
+      <rsc_op id="32" operation="monitor" operation_key="stonithsys2_monitor_15000" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="stonithsys2" long-id="stonithsys2" class="stonith" type="external/ipmi"/>
+        <attributes CRM_meta_interval="15000" CRM_meta_name="monitor" CRM_meta_start_delay="15000" CRM_meta_timeout="30000" crm_feature_set="3.0.2" hostname="sys2" interface="lan" ipaddr="192.168.1.221" passwd="****" userid="admin"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="31" operation="start" operation_key="stonithsys2_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="7">
+    <action_set>
+      <rsc_op id="2" operation="monitor" operation_key="stonithsys3_monitor_15000" on_node="sys2" on_node_uuid="sys2">
+        <primitive id="stonithsys3" long-id="stonithsys3" class="stonith" type="external/ipmi"/>
+        <attributes CRM_meta_interval="15000" CRM_meta_name="monitor" CRM_meta_start_delay="15000" CRM_meta_timeout="30000" crm_feature_set="3.0.2" hostname="sys3" interface="lan" ipaddr="192.168.1.222" passwd="****" userid="admin"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="start" operation_key="stonithsys3_start_0" on_node="sys2" on_node_uuid="sys2"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8">
+    <action_set>
+      <rsc_op id="10" operation="start" operation_key="stonithsys3_start_0" on_node="sys2" on_node_uuid="sys2">
+        <primitive id="stonithsys3" long-id="stonithsys3" class="stonith" type="external/ipmi"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2" hostname="sys3" interface="lan" ipaddr="192.168.1.222" passwd="****" userid="admin"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="33" operation="stop" operation_key="stonithsys3_stop_0" on_node="sys2" on_node_uuid="sys2"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="9">
+    <action_set>
+      <rsc_op id="19" operation="monitor" operation_key="stonithsys3_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="stonithsys3" long-id="stonithsys3" class="stonith" type="external/ipmi"/>
+        <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" hostname="sys3" interface="lan" ipaddr="192.168.1.222" passwd="****" userid="admin"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="10">
+    <action_set>
+      <rsc_op id="33" operation="stop" operation_key="stonithsys3_stop_0" on_node="sys2" on_node_uuid="sys2">
+        <primitive id="stonithsys3" long-id="stonithsys3" class="stonith" type="external/ipmi"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="11">
+    <action_set>
+      <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="70" operation="start" operation_key="baseclone_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="12">
+    <action_set>
+      <pseudo_event id="67" operation="running" operation_key="basegrp:1_running_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="54" operation="start" operation_key="controld:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="56" operation="start" operation_key="clvmd:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="57" operation="start" operation_key="o2cb:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="58" operation="start" operation_key="iscsi1:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="60" operation="start" operation_key="iscsi2:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="62" operation="start" operation_key="vg1:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="63" operation="start" operation_key="vg2:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="64" operation="start" operation_key="fs2:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="13">
+    <action_set>
+      <rsc_op id="20" operation="monitor" operation_key="controld:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="controld:1" long-id="baseclone:basegrp:1:controld:1" class="ocf" provider="pacemaker" type="controld"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="14">
+    <action_set>
+      <rsc_op id="54" operation="start" operation_key="controld:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="controld:1" long-id="baseclone:basegrp:1:controld:1" class="ocf" provider="pacemaker" type="controld"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="15">
+    <action_set>
+      <rsc_op id="55" operation="monitor" operation_key="controld:1_monitor_10000" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="controld:1" long-id="baseclone:basegrp:1:controld:1" class="ocf" provider="pacemaker" type="controld"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_interval="10000" CRM_meta_name="monitor" CRM_meta_notify="false" CRM_meta_start_delay="0" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="54" operation="start" operation_key="controld:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="16">
+    <action_set>
+      <rsc_op id="21" operation="monitor" operation_key="clvmd:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="clvmd:1" long-id="baseclone:basegrp:1:clvmd:1" class="ocf" provider="lvm2" type="clvmd"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" daemon_timeout="30"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="17">
+    <action_set>
+      <rsc_op id="56" operation="start" operation_key="clvmd:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="clvmd:1" long-id="baseclone:basegrp:1:clvmd:1" class="ocf" provider="lvm2" type="clvmd"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" daemon_timeout="30"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="54" operation="start" operation_key="controld:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="18">
+    <action_set>
+      <rsc_op id="22" operation="monitor" operation_key="o2cb:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="o2cb:1" long-id="baseclone:basegrp:1:o2cb:1" class="ocf" provider="ocfs2" type="o2cb"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="19">
+    <action_set>
+      <rsc_op id="57" operation="start" operation_key="o2cb:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="o2cb:1" long-id="baseclone:basegrp:1:o2cb:1" class="ocf" provider="ocfs2" type="o2cb"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="56" operation="start" operation_key="clvmd:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="20">
+    <action_set>
+      <rsc_op id="23" operation="monitor" operation_key="iscsi1:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="iscsi1:1" long-id="baseclone:basegrp:1:iscsi1:1" class="ocf" provider="heartbeat" type="iscsi"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" portal="192.168.2.2" target="iqn.2010-03.com.example:tar1"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="21">
+    <action_set>
+      <rsc_op id="58" operation="start" operation_key="iscsi1:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="iscsi1:1" long-id="baseclone:basegrp:1:iscsi1:1" class="ocf" provider="heartbeat" type="iscsi"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" portal="192.168.2.2" target="iqn.2010-03.com.example:tar1"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="57" operation="start" operation_key="o2cb:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="22">
+    <action_set>
+      <rsc_op id="59" operation="monitor" operation_key="iscsi1:1_monitor_120000" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="iscsi1:1" long-id="baseclone:basegrp:1:iscsi1:1" class="ocf" provider="heartbeat" type="iscsi"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_interval="120000" CRM_meta_name="monitor" CRM_meta_notify="false" CRM_meta_timeout="30000" crm_feature_set="3.0.2" portal="192.168.2.2" target="iqn.2010-03.com.example:tar1"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="58" operation="start" operation_key="iscsi1:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="23">
+    <action_set>
+      <rsc_op id="24" operation="monitor" operation_key="iscsi2:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="iscsi2:1" long-id="baseclone:basegrp:1:iscsi2:1" class="ocf" provider="heartbeat" type="iscsi"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" portal="192.168.2.2" target="iqn.2010-03.com.example:tar2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="24">
+    <action_set>
+      <rsc_op id="60" operation="start" operation_key="iscsi2:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="iscsi2:1" long-id="baseclone:basegrp:1:iscsi2:1" class="ocf" provider="heartbeat" type="iscsi"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" portal="192.168.2.2" target="iqn.2010-03.com.example:tar2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="58" operation="start" operation_key="iscsi1:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="25">
+    <action_set>
+      <rsc_op id="61" operation="monitor" operation_key="iscsi2:1_monitor_120000" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="iscsi2:1" long-id="baseclone:basegrp:1:iscsi2:1" class="ocf" provider="heartbeat" type="iscsi"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_interval="120000" CRM_meta_name="monitor" CRM_meta_notify="false" CRM_meta_timeout="30000" crm_feature_set="3.0.2" portal="192.168.2.2" target="iqn.2010-03.com.example:tar2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="60" operation="start" operation_key="iscsi2:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="26">
+    <action_set>
+      <rsc_op id="25" operation="monitor" operation_key="vg1:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vg1:1" long-id="baseclone:basegrp:1:vg1:1" class="ocf" provider="heartbeat" type="LVM"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" volgrpname="vg1"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="27">
+    <action_set>
+      <rsc_op id="62" operation="start" operation_key="vg1:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vg1:1" long-id="baseclone:basegrp:1:vg1:1" class="ocf" provider="heartbeat" type="LVM"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" volgrpname="vg1"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="60" operation="start" operation_key="iscsi2:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="28">
+    <action_set>
+      <rsc_op id="26" operation="monitor" operation_key="vg2:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vg2:1" long-id="baseclone:basegrp:1:vg2:1" class="ocf" provider="heartbeat" type="LVM"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" volgrpname="vg2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="29">
+    <action_set>
+      <rsc_op id="63" operation="start" operation_key="vg2:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="vg2:1" long-id="baseclone:basegrp:1:vg2:1" class="ocf" provider="heartbeat" type="LVM"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" volgrpname="vg2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="62" operation="start" operation_key="vg1:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="30">
+    <action_set>
+      <rsc_op id="27" operation="monitor" operation_key="fs2:1_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="fs2:1" long-id="baseclone:basegrp:1:fs2:1" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" device="/dev/vg2/lv1" directory="/mnt" fstype="ocfs2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="31">
+    <action_set>
+      <rsc_op id="64" operation="start" operation_key="fs2:1_start_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="fs2:1" long-id="baseclone:basegrp:1:fs2:1" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2" device="/dev/vg2/lv1" directory="/mnt" fstype="ocfs2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="63" operation="start" operation_key="vg2:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="66" operation="start" operation_key="basegrp:1_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="32">
+    <action_set>
+      <rsc_op id="65" operation="monitor" operation_key="fs2:1_monitor_20000" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="fs2:1" long-id="baseclone:basegrp:1:fs2:1" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_interval="20000" CRM_meta_name="monitor" CRM_meta_notify="false" CRM_meta_timeout="40000" crm_feature_set="3.0.2" device="/dev/vg2/lv1" directory="/mnt" fstype="ocfs2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="64" operation="start" operation_key="fs2:1_start_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="33">
+    <action_set>
+      <pseudo_event id="70" operation="start" operation_key="baseclone_start_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="34" priority="1000000">
+    <action_set>
+      <pseudo_event id="71" operation="running" operation_key="baseclone_running_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="67" operation="running" operation_key="basegrp:1_running_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="70" operation="start" operation_key="baseclone_start_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="35">
+    <action_set>
+      <rsc_op id="28" operation="monitor" operation_key="nfs1:0_monitor_0" on_node="sys3" on_node_uuid="sys3">
+        <primitive id="nfs1:0" long-id="fs1:nfs1:0" class="ocf" provider="heartbeat" type="Filesystem"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" device="192.168.2.2:/fs1" directory="/mnt" fstype="nfs"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="36">
+    <action_set>
+      <pseudo_event id="8" operation="load_stopped_sys2" operation_key="load_stopped_sys2">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="37">
+    <action_set>
+      <pseudo_event id="9" operation="load_stopped_sys3" operation_key="load_stopped_sys3">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="38">
+    <action_set>
+      <pseudo_event id="11" operation="probe_complete" operation_key="probe_complete">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="13" operation="probe_complete" operation_key="probe_complete" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="39" priority="1000000">
+    <action_set>
+      <rsc_op id="13" operation="probe_complete" operation_key="probe_complete" on_node="sys3" on_node_uuid="sys3">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="14" operation="monitor" operation_key="vm1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="15" operation="monitor" operation_key="vm2_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="16" operation="monitor" operation_key="vm3_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="17" operation="monitor" operation_key="vm4_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="18" operation="monitor" operation_key="stonithsys2_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="19" operation="monitor" operation_key="stonithsys3_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="20" operation="monitor" operation_key="controld:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="21" operation="monitor" operation_key="clvmd:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="22" operation="monitor" operation_key="o2cb:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="23" operation="monitor" operation_key="iscsi1:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="24" operation="monitor" operation_key="iscsi2:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="25" operation="monitor" operation_key="vg1:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="26" operation="monitor" operation_key="vg2:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="27" operation="monitor" operation_key="fs2:1_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="28" operation="monitor" operation_key="nfs1:0_monitor_0" on_node="sys3" on_node_uuid="sys3"/>
+      </trigger>
+    </inputs>
+  </synapse>
+</transition_graph>
+
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone-1.scores
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone-1.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,129 @@
+Allocation scores:
+clone_color: baseclone allocation score on sys2: INFINITY
+clone_color: baseclone allocation score on sys3: 10000
+clone_color: basegrp:0 allocation score on sys2: 0
+clone_color: basegrp:0 allocation score on sys3: 0
+clone_color: controld:0 allocation score on sys2: 1
+clone_color: controld:0 allocation score on sys3: 0
+clone_color: clvmd:0 allocation score on sys2: 1
+clone_color: clvmd:0 allocation score on sys3: 0
+clone_color: o2cb:0 allocation score on sys2: 1
+clone_color: o2cb:0 allocation score on sys3: 0
+clone_color: iscsi1:0 allocation score on sys2: 1
+clone_color: iscsi1:0 allocation score on sys3: 0
+clone_color: iscsi2:0 allocation score on sys2: 1
+clone_color: iscsi2:0 allocation score on sys3: 0
+clone_color: vg1:0 allocation score on sys2: 1
+clone_color: vg1:0 allocation score on sys3: 0
+clone_color: vg2:0 allocation score on sys2: 1
+clone_color: vg2:0 allocation score on sys3: 0
+clone_color: fs2:0 allocation score on sys2: 1
+clone_color: fs2:0 allocation score on sys3: 0
+clone_color: basegrp:1 allocation score on sys2: 0
+clone_color: basegrp:1 allocation score on sys3: 0
+clone_color: controld:1 allocation score on sys2: 0
+clone_color: controld:1 allocation score on sys3: 0
+clone_color: clvmd:1 allocation score on sys2: 0
+clone_color: clvmd:1 allocation score on sys3: 0
+clone_color: o2cb:1 allocation score on sys2: 0
+clone_color: o2cb:1 allocation score on sys3: 0
+clone_color: iscsi1:1 allocation score on sys2: 0
+clone_color: iscsi1:1 allocation score on sys3: 0
+clone_color: iscsi2:1 allocation score on sys2: 0
+clone_color: iscsi2:1 allocation score on sys3: 0
+clone_color: vg1:1 allocation score on sys2: 0
+clone_color: vg1:1 allocation score on sys3: 0
+clone_color: vg2:1 allocation score on sys2: 0
+clone_color: vg2:1 allocation score on sys3: 0
+clone_color: fs2:1 allocation score on sys2: 0
+clone_color: fs2:1 allocation score on sys3: 0
+group_color: basegrp:0 allocation score on sys2: 0
+group_color: basegrp:0 allocation score on sys3: 0
+group_color: controld:0 allocation score on sys2: 1
+group_color: controld:0 allocation score on sys3: 0
+group_color: clvmd:0 allocation score on sys2: 1
+group_color: clvmd:0 allocation score on sys3: 0
+group_color: o2cb:0 allocation score on sys2: 1
+group_color: o2cb:0 allocation score on sys3: 0
+group_color: iscsi1:0 allocation score on sys2: 1
+group_color: iscsi1:0 allocation score on sys3: 0
+group_color: iscsi2:0 allocation score on sys2: 1
+group_color: iscsi2:0 allocation score on sys3: 0
+group_color: vg1:0 allocation score on sys2: 1
+group_color: vg1:0 allocation score on sys3: 0
+group_color: vg2:0 allocation score on sys2: 1
+group_color: vg2:0 allocation score on sys3: 0
+group_color: fs2:0 allocation score on sys2: 1
+group_color: fs2:0 allocation score on sys3: 0
+native_color: controld:0 allocation score on sys2: 8
+native_color: controld:0 allocation score on sys3: 0
+native_color: clvmd:0 allocation score on sys2: 7
+native_color: clvmd:0 allocation score on sys3: -INFINITY
+native_color: o2cb:0 allocation score on sys2: 6
+native_color: o2cb:0 allocation score on sys3: -INFINITY
+native_color: iscsi1:0 allocation score on sys2: 5
+native_color: iscsi1:0 allocation score on sys3: -INFINITY
+native_color: iscsi2:0 allocation score on sys2: 4
+native_color: iscsi2:0 allocation score on sys3: -INFINITY
+native_color: vg1:0 allocation score on sys2: 3
+native_color: vg1:0 allocation score on sys3: -INFINITY
+native_color: vg2:0 allocation score on sys2: 2
+native_color: vg2:0 allocation score on sys3: -INFINITY
+native_color: fs2:0 allocation score on sys2: 1
+native_color: fs2:0 allocation score on sys3: -INFINITY
+group_color: basegrp:1 allocation score on sys2: -INFINITY
+group_color: basegrp:1 allocation score on sys3: 0
+group_color: controld:1 allocation score on sys2: -INFINITY
+group_color: controld:1 allocation score on sys3: 0
+group_color: clvmd:1 allocation score on sys2: -INFINITY
+group_color: clvmd:1 allocation score on sys3: 0
+group_color: o2cb:1 allocation score on sys2: -INFINITY
+group_color: o2cb:1 allocation score on sys3: 0
+group_color: iscsi1:1 allocation score on sys2: -INFINITY
+group_color: iscsi1:1 allocation score on sys3: 0
+group_color: iscsi2:1 allocation score on sys2: -INFINITY
+group_color: iscsi2:1 allocation score on sys3: 0
+group_color: vg1:1 allocation score on sys2: -INFINITY
+group_color: vg1:1 allocation score on sys3: 0
+group_color: vg2:1 allocation score on sys2: -INFINITY
+group_color: vg2:1 allocation score on sys3: 0
+group_color: fs2:1 allocation score on sys2: -INFINITY
+group_color: fs2:1 allocation score on sys3: 0
+native_color: controld:1 allocation score on sys2: -INFINITY
+native_color: controld:1 allocation score on sys3: 0
+native_color: clvmd:1 allocation score on sys2: -INFINITY
+native_color: clvmd:1 allocation score on sys3: 0
+native_color: o2cb:1 allocation score on sys2: -INFINITY
+native_color: o2cb:1 allocation score on sys3: 0
+native_color: iscsi1:1 allocation score on sys2: -INFINITY
+native_color: iscsi1:1 allocation score on sys3: 0
+native_color: iscsi2:1 allocation score on sys2: -INFINITY
+native_color: iscsi2:1 allocation score on sys3: 0
+native_color: vg1:1 allocation score on sys2: -INFINITY
+native_color: vg1:1 allocation score on sys3: 0
+native_color: vg2:1 allocation score on sys2: -INFINITY
+native_color: vg2:1 allocation score on sys3: 0
+native_color: fs2:1 allocation score on sys2: -INFINITY
+native_color: fs2:1 allocation score on sys3: 0
+native_color: vm1 allocation score on sys2: INFINITY
+native_color: vm1 allocation score on sys3: 0
+native_color: vm2 allocation score on sys2: -INFINITY
+native_color: vm2 allocation score on sys3: -INFINITY
+native_color: vm3 allocation score on sys2: -INFINITY
+native_color: vm3 allocation score on sys3: -INFINITY
+native_color: vm4 allocation score on sys2: -INFINITY
+native_color: vm4 allocation score on sys3: -INFINITY
+native_color: stonithsys2 allocation score on sys2: -INFINITY
+native_color: stonithsys2 allocation score on sys3: 0
+native_color: stonithsys3 allocation score on sys2: INFINITY
+native_color: stonithsys3 allocation score on sys3: -INFINITY
+clone_color: fs1 allocation score on sys2: 0
+clone_color: fs1 allocation score on sys3: 0
+clone_color: nfs1:0 allocation score on sys2: 0
+clone_color: nfs1:0 allocation score on sys3: 0
+clone_color: nfs1:1 allocation score on sys2: 0
+clone_color: nfs1:1 allocation score on sys3: 0
+native_color: nfs1:0 allocation score on sys2: -INFINITY
+native_color: nfs1:0 allocation score on sys3: -INFINITY
+native_color: nfs1:1 allocation score on sys2: -INFINITY
+native_color: nfs1:1 allocation score on sys3: -INFINITY
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone-1.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone-1.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,310 @@
+<cib validate-with="pacemaker-1.2" crm_feature_set="3.0.1" have-quorum="1" admin_epoch="0" epoch="88" num_updates="4" cib-last-written="Wed Mar 10 13:36:24 2010" dc-uuid="sys2">
+  <configuration>
+    <crm_config>
+      <cluster_property_set id="cib-bootstrap-options">
+        <nvpair id="cib-bootstrap-options-dc-version" name="dc-version" value="1.1.1-c23bbc5262b26f5ad89812b7af9af3785a9a4e81"/>
+        <nvpair id="cib-bootstrap-options-cluster-infrastructure" name="cluster-infrastructure" value="openais"/>
+        <nvpair id="cib-bootstrap-options-expected-quorum-votes" name="expected-quorum-votes" value="2"/>
+        <nvpair id="cib-bootstrap-options-no-quorum-policy" name="no-quorum-policy" value="ignore"/>
+        <nvpair id="cib-bootstrap-options-default-resource-stickiness" name="default-resource-stickiness" value="1000000"/>
+        <nvpair id="cib-bootstrap-options-stonith-enabled" name="stonith-enabled" value="true"/>
+        <nvpair id="cib-bootstrap-options-placement-strategy" name="placement-strategy" value="utilization"/>
+        <nvpair id="cib-bootstrap-options-last-lrm-refresh" name="last-lrm-refresh" value="1268150032"/>
+      </cluster_property_set>
+    </crm_config>
+    <nodes>
+      <node id="sys2" type="normal" uname="sys2">
+        <utilization id="sys2-utilization">
+          <nvpair id="sys2-utilization-memory" name="memory" value="1536"/>
+        </utilization>
+      </node>
+      <node id="sys3" type="normal" uname="sys3">
+        <utilization id="sys3-utilization">
+          <nvpair id="sys3-utilization-memory" name="memory" value="1536"/>
+        </utilization>
+      </node>
+    </nodes>
+    <resources>
+      <primitive class="stonith" id="stonithsys2" type="external/ipmi">
+        <instance_attributes id="stonithsys2-instance_attributes">
+          <nvpair id="stonithsys2-instance_attributes-hostname" name="hostname" value="sys2"/>
+          <nvpair id="stonithsys2-instance_attributes-ipaddr" name="ipaddr" value="192.168.1.221"/>
+          <nvpair id="stonithsys2-instance_attributes-userid" name="userid" value="admin"/>
+          <nvpair id="stonithsys2-instance_attributes-passwd" name="passwd" value="****"/>
+          <nvpair id="stonithsys2-instance_attributes-interface" name="interface" value="lan"/>
+        </instance_attributes>
+        <operations id="stonithsys2-operations">
+          <op id="stonithsys2-monitor-15" interval="15" name="monitor" start-delay="15" timeout="15"/>
+        </operations>
+      </primitive>
+      <primitive class="stonith" id="stonithsys3" type="external/ipmi">
+        <instance_attributes id="stonithsys3-instance_attributes">
+          <nvpair id="stonithsys3-instance_attributes-hostname" name="hostname" value="sys3"/>
+          <nvpair id="stonithsys3-instance_attributes-ipaddr" name="ipaddr" value="192.168.1.222"/>
+          <nvpair id="stonithsys3-instance_attributes-userid" name="userid" value="admin"/>
+          <nvpair id="stonithsys3-instance_attributes-passwd" name="passwd" value="****"/>
+          <nvpair id="stonithsys3-instance_attributes-interface" name="interface" value="lan"/>
+        </instance_attributes>
+        <operations id="stonithsys3-operations">
+          <op id="stonithsys3-monitor-15" interval="15" name="monitor" start-delay="15" timeout="15"/>
+        </operations>
+      </primitive>
+      <primitive class="ocf" id="vm1" provider="heartbeat" type="Xen">
+        <meta_attributes id="vm1-meta_attributes">
+          <nvpair id="vm1-meta_attributes-allow-migrate" name="allow-migrate" value="false"/>
+          <nvpair id="vm1-meta_attributes-migration-threshold" name="migration-threshold" value="2"/>
+          <nvpair id="vm1-meta_attributes-priority" name="priority" value="4"/>
+        </meta_attributes>
+        <instance_attributes id="vm1-instance_attributes">
+          <nvpair id="vm1-instance_attributes-xmfile" name="xmfile" value="/etc/xen/vm/vm1"/>
+        </instance_attributes>
+        <utilization id="vm1-utilization">
+          <nvpair id="vm1-utilization-memory" name="memory" value="512"/>
+        </utilization>
+        <operations id="vm1-operations">
+          <op id="vm1-monitor-10" interval="10" name="monitor" timeout="30"/>
+        </operations>
+      </primitive>
+      <primitive class="ocf" id="vm2" provider="heartbeat" type="Xen">
+        <meta_attributes id="vm2-meta_attributes">
+          <nvpair id="vm2-meta_attributes-allow-migrate" name="allow-migrate" value="true"/>
+          <nvpair id="vm2-meta_attributes-migration-threshold" name="migration-threshold" value="2"/>
+          <nvpair id="vm2-meta_attributes-priority" name="priority" value="3"/>
+          <nvpair id="vm2-meta_attributes-target-role" name="target-role" value="stopped"/>
+        </meta_attributes>
+        <instance_attributes id="vm2-instance_attributes">
+          <nvpair id="vm2-instance_attributes-xmfile" name="xmfile" value="/etc/xen/vm/vm2"/>
+        </instance_attributes>
+        <utilization id="vm2-utilization">
+          <nvpair id="vm2-utilization-memory" name="memory" value="512"/>
+        </utilization>
+        <operations id="vm2-operations">
+          <op id="vm2-stop-0" interval="0" name="stop" timeout="40"/>
+          <op id="vm2-monitor-10" interval="10" name="monitor" timeout="30"/>
+        </operations>
+      </primitive>
+      <primitive class="ocf" id="vm3" provider="heartbeat" type="Xen">
+        <meta_attributes id="vm3-meta_attributes">
+          <nvpair id="vm3-meta_attributes-allow-migrate" name="allow-migrate" value="true"/>
+          <nvpair id="vm3-meta_attributes-migration-threshold" name="migration-threshold" value="2"/>
+          <nvpair id="vm3-meta_attributes-priority" name="priority" value="2"/>
+          <nvpair id="vm3-meta_attributes-target-role" name="target-role" value="stopped"/>
+        </meta_attributes>
+        <instance_attributes id="vm3-instance_attributes">
+          <nvpair id="vm3-instance_attributes-xmfile" name="xmfile" value="/etc/xen/vm/vm3"/>
+        </instance_attributes>
+        <utilization id="vm3-utilization">
+          <nvpair id="vm3-utilization-memory" name="memory" value="512"/>
+        </utilization>
+        <operations id="vm3-operations">
+          <op id="vm3-stop-0" interval="0" name="stop" timeout="40"/>
+          <op id="vm3-monitor-10" interval="10" name="monitor" timeout="30"/>
+        </operations>
+      </primitive>
+      <primitive class="ocf" id="vm4" provider="heartbeat" type="Xen">
+        <meta_attributes id="vm4-meta_attributes">
+          <nvpair id="vm4-meta_attributes-allow-migrate" name="allow-migrate" value="true"/>
+          <nvpair id="vm4-meta_attributes-migration-threshold" name="migration-threshold" value="2"/>
+          <nvpair id="vm4-meta_attributes-priority" name="priority" value="1"/>
+          <nvpair id="vm4-meta_attributes-target-role" name="target-role" value="stopped"/>
+        </meta_attributes>
+        <instance_attributes id="vm4-instance_attributes">
+          <nvpair id="vm4-instance_attributes-xmfile" name="xmfile" value="/etc/xen/vm/vm4"/>
+        </instance_attributes>
+        <utilization id="vm4-utilization">
+          <nvpair id="vm4-utilization-memory" name="memory" value="512"/>
+        </utilization>
+        <operations id="vm4-operations">
+          <op id="vm4-stop-0" interval="0" name="stop" timeout="40"/>
+          <op id="vm4-monitor-10" interval="10" name="monitor" timeout="30"/>
+        </operations>
+      </primitive>
+      <clone id="baseclone">
+        <meta_attributes id="baseclone-meta_attributes">
+          <nvpair id="baseclone-meta_attributes-interleave" name="interleave" value="true"/>
+        </meta_attributes>
+        <group id="basegrp">
+          <primitive class="ocf" id="controld" provider="pacemaker" type="controld">
+            <operations id="controld-operations">
+              <op id="controld-monitor-10" interval="10" name="monitor" start-delay="0" timeout="20"/>
+            </operations>
+          </primitive>
+          <primitive class="ocf" id="clvmd" provider="lvm2" type="clvmd">
+            <instance_attributes id="clvmd-instance_attributes">
+              <nvpair id="clvmd-instance_attributes-daemon_timeout" name="daemon_timeout" value="30"/>
+            </instance_attributes>
+          </primitive>
+          <primitive class="ocf" id="o2cb" provider="ocfs2" type="o2cb"/>
+          <primitive class="ocf" id="iscsi1" provider="heartbeat" type="iscsi">
+            <instance_attributes id="iscsi1-instance_attributes">
+              <nvpair id="iscsi1-instance_attributes-portal" name="portal" value="192.168.2.2"/>
+              <nvpair id="iscsi1-instance_attributes-target" name="target" value="iqn.2010-03.com.example:tar1"/>
+            </instance_attributes>
+            <operations id="iscsi1-operations">
+              <op id="iscsi1-monitor-120" interval="120" name="monitor" timeout="30"/>
+            </operations>
+          </primitive>
+          <primitive class="ocf" id="iscsi2" provider="heartbeat" type="iscsi">
+            <instance_attributes id="iscsi2-instance_attributes">
+              <nvpair id="iscsi2-instance_attributes-portal" name="portal" value="192.168.2.2"/>
+              <nvpair id="iscsi2-instance_attributes-target" name="target" value="iqn.2010-03.com.example:tar2"/>
+            </instance_attributes>
+            <operations id="iscsi2-operations">
+              <op id="iscsi2-monitor-120" interval="120" name="monitor" timeout="30"/>
+            </operations>
+          </primitive>
+          <primitive class="ocf" id="vg1" provider="heartbeat" type="LVM">
+            <instance_attributes id="vg1-instance_attributes">
+              <nvpair id="vg1-instance_attributes-volgrpname" name="volgrpname" value="vg1"/>
+            </instance_attributes>
+            <operations id="vg1-operations">                          </operations>
+          </primitive>
+          <primitive class="ocf" id="vg2" provider="heartbeat" type="LVM">
+            <instance_attributes id="vg2-instance_attributes">
+              <nvpair id="vg2-instance_attributes-volgrpname" name="volgrpname" value="vg2"/>
+            </instance_attributes>
+            <operations id="vg2-operations">                          </operations>
+          </primitive>
+          <primitive class="ocf" id="fs2" provider="heartbeat" type="Filesystem">
+            <instance_attributes id="fs2-instance_attributes">
+              <nvpair id="fs2-instance_attributes-device" name="device" value="/dev/vg2/lv1"/>
+              <nvpair id="fs2-instance_attributes-directory" name="directory" value="/mnt"/>
+              <nvpair id="fs2-instance_attributes-fstype" name="fstype" value="ocfs2"/>
+            </instance_attributes>
+            <operations id="fs2-operations">
+              <op id="fs2-monitor-20" interval="20" name="monitor" timeout="40"/>
+            </operations>
+            <meta_attributes id="fs2-meta_attributes"/>
+          </primitive>
+        </group>
+      </clone>
+      <clone id="fs1">
+        <meta_attributes id="fs1-meta_attributes">
+          <nvpair id="fs1-meta_attributes-interleave" name="interleave" value="true"/>
+          <nvpair id="fs1-meta_attributes-target-role" name="target-role" value="stopped"/>
+        </meta_attributes>
+        <primitive class="ocf" id="nfs1" provider="heartbeat" type="Filesystem">
+          <instance_attributes id="nfs1-instance_attributes">
+            <nvpair id="nfs1-instance_attributes-device" name="device" value="192.168.2.2:/fs1"/>
+            <nvpair id="nfs1-instance_attributes-directory" name="directory" value="/mnt"/>
+            <nvpair id="nfs1-instance_attributes-fstype" name="fstype" value="nfs"/>
+          </instance_attributes>
+          <operations id="nfs1-operations">
+            <op id="nfs1-monitor-20" interval="20" name="monitor" timeout="40"/>
+          </operations>
+        </primitive>
+      </clone>
+    </resources>
+    <constraints>
+      <rsc_location id="loc-stonithsys2" node="sys2" rsc="stonithsys2" score="-INFINITY"/>
+      <rsc_location id="loc-stonithsys3" node="sys3" rsc="stonithsys3" score="-INFINITY"/>
+      <rsc_location id="loc-vm1" node="sys2" rsc="vm1" score="5000"/>
+      <rsc_location id="loc-vm2" node="sys2" rsc="vm2" score="5000"/>
+      <rsc_location id="loc-vm3" node="sys3" rsc="vm3" score="5000"/>
+      <rsc_location id="loc-vm4" node="sys3" rsc="vm4" score="5000"/>
+      <rsc_colocation id="col-vm" score="+INFINITY">
+        <resource_set id="col-vm-1" sequential="false">
+          <resource_ref id="vm1"/>
+          <resource_ref id="vm2"/>
+          <resource_ref id="vm3"/>
+          <resource_ref id="vm4"/>
+        </resource_set>
+        <resource_set id="col-vm-2">
+          <resource_ref id="baseclone"/>
+        </resource_set>
+      </rsc_colocation>
+      <rsc_order id="order-vm" score="+INFINITY">
+        <resource_set id="order-vm-0">
+          <resource_ref id="baseclone"/>
+        </resource_set>
+        <resource_set id="order-vm-2" sequential="false">
+          <resource_ref id="vm1"/>
+          <resource_ref id="vm2"/>
+          <resource_ref id="vm3"/>
+          <resource_ref id="vm4"/>
+        </resource_set>
+      </rsc_order>
+    </constraints>
+    <op_defaults/>
+    <rsc_defaults/>
+  </configuration>
+  <status>
+    <node_state id="sys2" uname="sys2" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="do_state_transition" shutdown="0">
+      <transient_attributes id="sys2">
+        <instance_attributes id="status-sys2">
+          <nvpair id="status-sys2-probe_complete" name="probe_complete" value="true"/>
+        </instance_attributes>
+      </transient_attributes>
+      <lrm id="sys2">
+        <lrm_resources>
+          <lrm_resource id="fs2:0" type="Filesystem" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="fs2:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="25:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;25:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="15" rc-code="7" op-status="0" interval="0" last-run="1268224265" last-rc-change="1268224265" exec-time="80" queue-time="3000" op-digest="220c54922bb36b81c06f9df74d933cb4"/>
+            <lrm_rsc_op id="fs2:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="32:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;32:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="29" rc-code="0" op-status="0" interval="0" last-run="1268224522" last-rc-change="1268224522" exec-time="140" queue-time="0" op-digest="220c54922bb36b81c06f9df74d933cb4"/>
+            <lrm_rsc_op id="fs2:0_monitor_20000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="33:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;33:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="30" rc-code="0" op-status="0" interval="20000" last-run="1268224582" last-rc-change="1268224522" exec-time="70" queue-time="0" op-digest="ee826c2d1cf4c252c655f0a4b75d3d67"/>
+          </lrm_resource>
+          <lrm_resource id="stonithsys2" type="external/ipmi" class="stonith">
+            <lrm_rsc_op id="stonithsys2_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="16:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;16:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="6" rc-code="7" op-status="0" interval="0" last-run="1268224263" last-rc-change="1268224263" exec-time="10" queue-time="1000" op-digest="c396aac3495b8adf2027d56d68e73e83"/>
+          </lrm_resource>
+          <lrm_resource id="stonithsys3" type="external/ipmi" class="stonith">
+            <lrm_rsc_op id="stonithsys3_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="17:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;17:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="7" rc-code="7" op-status="0" interval="0" last-run="1268224263" last-rc-change="1268224263" exec-time="20" queue-time="1000" op-digest="c01873bde93d27fe858bd505b593cb93"/>
+            <lrm_rsc_op id="stonithsys3_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="29:0:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;29:0:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="17" rc-code="0" op-status="0" interval="0" last-run="1268224265" last-rc-change="1268224265" exec-time="10" queue-time="0" op-digest="c01873bde93d27fe858bd505b593cb93"/>
+            <lrm_rsc_op id="stonithsys3_monitor_15000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="16:1:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;16:1:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="18" rc-code="0" op-status="0" interval="15000" last-run="1268224544" last-rc-change="1268224281" exec-time="20220" queue-time="0" op-digest="af1a9012619211f1b8cd6daa86e88d18"/>
+          </lrm_resource>
+          <lrm_resource id="nfs1:0" type="Filesystem" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="nfs1:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="26:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;26:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="16" rc-code="7" op-status="0" interval="0" last-run="1268224265" last-rc-change="1268224265" exec-time="70" queue-time="3000" op-digest="fea0d09fdacb6b2b08e9f70983277236"/>
+          </lrm_resource>
+          <lrm_resource id="o2cb:0" type="o2cb" class="ocf" provider="ocfs2">
+            <lrm_rsc_op id="o2cb:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="20:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;20:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="10" rc-code="7" op-status="0" interval="0" last-run="1268224264" last-rc-change="1268224264" exec-time="40" queue-time="2000" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="o2cb:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="25:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;25:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="22" rc-code="0" op-status="0" interval="0" last-run="1268224513" last-rc-change="1268224513" exec-time="2110" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="vm1" type="Xen" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="vm1_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="12:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;12:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="2" rc-code="7" op-status="0" interval="0" last-run="1268224262" last-rc-change="1268224262" exec-time="220" queue-time="0" op-digest="aba7fe5e6b468160ec01458b6930ca5d"/>
+            <lrm_rsc_op id="vm1_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="14:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;14:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="31" rc-code="0" op-status="0" interval="0" last-run="1268224523" last-rc-change="1268224523" exec-time="2740" queue-time="0" op-digest="aba7fe5e6b468160ec01458b6930ca5d"/>
+            <lrm_rsc_op id="vm1_monitor_10000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="15:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;15:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="32" rc-code="0" op-status="0" interval="10000" last-run="1268224576" last-rc-change="1268224525" exec-time="220" queue-time="0" op-digest="4b8b9033ce3f897de31ef948a6bab49a"/>
+          </lrm_resource>
+          <lrm_resource id="vm2" type="Xen" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="vm2_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="13:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;13:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="3" rc-code="7" op-status="0" interval="0" last-run="1268224262" last-rc-change="1268224262" exec-time="230" queue-time="0" op-digest="cc82c4b22cfa40687da813034a797e9e"/>
+          </lrm_resource>
+          <lrm_resource id="vm3" type="Xen" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="vm3_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="14:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;14:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="4" rc-code="7" op-status="0" interval="0" last-run="1268224262" last-rc-change="1268224262" exec-time="200" queue-time="0" op-digest="e0eb8dace2ff7cea382f3fd8f8d1ce30"/>
+          </lrm_resource>
+          <lrm_resource id="vm4" type="Xen" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="vm4_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="15:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;15:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="5" rc-code="7" op-status="0" interval="0" last-run="1268224262" last-rc-change="1268224262" exec-time="200" queue-time="0" op-digest="cc8a5c9706d7dbfa9ed84dfa850ca330"/>
+          </lrm_resource>
+          <lrm_resource id="iscsi1:0" type="iscsi" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="iscsi1:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="21:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;21:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="11" rc-code="7" op-status="0" interval="0" last-run="1268224264" last-rc-change="1268224264" exec-time="80" queue-time="2000" op-digest="8061f599e24eb0fcc6b14aa1d4009b57"/>
+            <lrm_rsc_op id="iscsi1:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="26:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;26:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="23" rc-code="0" op-status="0" interval="0" last-run="1268224516" last-rc-change="1268224516" exec-time="1630" queue-time="0" op-digest="8061f599e24eb0fcc6b14aa1d4009b57"/>
+            <lrm_rsc_op id="iscsi1:0_monitor_120000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="27:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;27:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="24" rc-code="0" op-status="0" interval="120000" last-run="1268224517" last-rc-change="1268224517" exec-time="80" queue-time="0" op-digest="35b6674708354cbf4e5bba3fd6673a11"/>
+          </lrm_resource>
+          <lrm_resource id="vg1:0" type="LVM" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="vg1:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="23:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;23:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="13" rc-code="7" op-status="0" interval="0" last-run="1268224264" last-rc-change="1268224264" exec-time="250" queue-time="2000" op-digest="4335f09924c29f38b65462e566ca5f2c"/>
+            <lrm_rsc_op id="vg1:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="30:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;30:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="27" rc-code="0" op-status="0" interval="0" last-run="1268224519" last-rc-change="1268224519" exec-time="1960" queue-time="0" op-digest="4335f09924c29f38b65462e566ca5f2c"/>
+          </lrm_resource>
+          <lrm_resource id="iscsi2:0" type="iscsi" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="iscsi2:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="22:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;22:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="12" rc-code="7" op-status="0" interval="0" last-run="1268224264" last-rc-change="1268224264" exec-time="70" queue-time="2000" op-digest="480cccd614c6c6844800be719ec8a790"/>
+            <lrm_rsc_op id="iscsi2:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="28:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;28:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="25" rc-code="0" op-status="0" interval="0" last-run="1268224517" last-rc-change="1268224517" exec-time="1620" queue-time="0" op-digest="480cccd614c6c6844800be719ec8a790"/>
+            <lrm_rsc_op id="iscsi2:0_monitor_120000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="29:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;29:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="26" rc-code="0" op-status="0" interval="120000" last-run="1268224518" last-rc-change="1268224518" exec-time="80" queue-time="0" op-digest="ef4e353a225306d98a5c1755996e0bfe"/>
+          </lrm_resource>
+          <lrm_resource id="clvmd:0" type="clvmd" class="ocf" provider="lvm2">
+            <lrm_rsc_op id="clvmd:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="19:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;19:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="9" rc-code="7" op-status="0" interval="0" last-run="1268224263" last-rc-change="1268224263" exec-time="30" queue-time="1000" op-digest="21015abf7dd336e68f45ef73249ff9c6"/>
+            <lrm_rsc_op id="clvmd:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="24:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;24:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="21" rc-code="0" op-status="0" interval="0" last-run="1268224510" last-rc-change="1268224510" exec-time="3110" queue-time="0" op-digest="21015abf7dd336e68f45ef73249ff9c6"/>
+          </lrm_resource>
+          <lrm_resource id="vg2:0" type="LVM" class="ocf" provider="heartbeat">
+            <lrm_rsc_op id="vg2:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="24:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;24:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="14" rc-code="7" op-status="0" interval="0" last-run="1268224265" last-rc-change="1268224265" exec-time="120" queue-time="3000" op-digest="ca9b527a03cafb9bb11004c41ae4ec8f"/>
+            <lrm_rsc_op id="vg2:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="31:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;31:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="28" rc-code="0" op-status="0" interval="0" last-run="1268224521" last-rc-change="1268224521" exec-time="1330" queue-time="0" op-digest="ca9b527a03cafb9bb11004c41ae4ec8f"/>
+          </lrm_resource>
+          <lrm_resource id="controld:0" type="controld" class="ocf" provider="pacemaker">
+            <lrm_rsc_op id="controld:0_monitor_0" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="18:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:7;18:0:7:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="8" rc-code="7" op-status="0" interval="0" last-run="1268224263" last-rc-change="1268224263" exec-time="50" queue-time="1000" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="controld:0_start_0" operation="start" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="35:11:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;35:11:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="19" rc-code="0" op-status="0" interval="0" last-run="1268224509" last-rc-change="1268224509" exec-time="1070" queue-time="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="controld:0_monitor_10000" operation="monitor" crm-debug-origin="build_active_RAs" crm_feature_set="3.0.1" transition-key="23:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" transition-magic="0:0;23:12:0:af7d7a32-d5e1-4159-82e0-2f2848b4ab1d" call-id="20" rc-code="0" op-status="0" interval="10000" last-run="1268224580" last-rc-change="1268224510" exec-time="40" queue-time="0" op-digest="4811cef7f7f94e3a35a70be7916cb2fd"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="sys3" uname="sys3" ha="active" in_ccm="true" crmd="online" crm-debug-origin="do_state_transition" join="member" expected="member" shutdown="0">
+      <lrm id="sys3">
+        <lrm_resources/>
+      </lrm>
+    </node_state>
+  </status>
+</cib>
\ No newline at end of file
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone.dot
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,24 @@
+digraph "g" {
+"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
+"clone-rsc_stop_0" -> "clone-rsc_stopped_0" [ style = bold]
+"clone-rsc_stop_0" -> "rsc:0_stop_0 node1" [ style = bold]
+"clone-rsc_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"clone-rsc_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc1_stop_0 node1" -> "clone-rsc_stop_0" [ style = bold]
+"rsc1_stop_0 node1" -> "rsc1_start_0 node2" [ style = bold]
+"rsc1_stop_0 node1" -> "rsc:0_stop_0 node1" [ style = bold]
+"rsc1_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc3_stop_0 node1" -> "clone-rsc_stop_0" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc3_start_0 node2" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc:0_stop_0 node1" [ style = bold]
+"rsc3_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc:0_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc:0_stop_0 node1" -> "clone-rsc_stopped_0" [ style = bold]
+"rsc:0_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone.exp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,130 @@
+<transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
+  <synapse id="0">
+    <action_set>
+      <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="1">
+    <action_set>
+      <rsc_op id="6" operation="start" operation_key="rsc1_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="2">
+    <action_set>
+      <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="3">
+    <action_set>
+      <rsc_op id="10" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="4">
+    <action_set>
+      <rsc_op id="11" operation="stop" operation_key="rsc:0_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc:0" long-id="clone-rsc:rsc:0" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="16" operation="stop" operation_key="clone-rsc_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="5">
+    <action_set>
+      <pseudo_event id="16" operation="stop" operation_key="clone-rsc_stop_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="6" priority="1000000">
+    <action_set>
+      <pseudo_event id="17" operation="stopped" operation_key="clone-rsc_stopped_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc:0_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="16" operation="stop" operation_key="clone-rsc_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="7">
+    <action_set>
+      <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc:0_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8" priority="1000000">
+    <action_set>
+      <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="node1">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="9" priority="1000000">
+    <action_set>
+      <rsc_op id="4" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="node2">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+</transition_graph>
+
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone.scores
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,17 @@
+Allocation scores:
+clone_color: clone-rsc allocation score on node1: -INFINITY
+clone_color: clone-rsc allocation score on node2: 0
+clone_color: rsc:0 allocation score on node1: 1
+clone_color: rsc:0 allocation score on node2: 0
+clone_color: rsc:1 allocation score on node1: 0
+clone_color: rsc:1 allocation score on node2: 1
+native_color: rsc:1 allocation score on node1: -INFINITY
+native_color: rsc:1 allocation score on node2: 1
+native_color: rsc:0 allocation score on node1: -INFINITY
+native_color: rsc:0 allocation score on node2: -INFINITY
+native_color: rsc1 allocation score on node1: -INFINITY
+native_color: rsc1 allocation score on node2: 0
+native_color: rsc2 allocation score on node1: -INFINITY
+native_color: rsc2 allocation score on node2: 0
+native_color: rsc3 allocation score on node1: -INFINITY
+native_color: rsc3 allocation score on node2: 0
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-clone.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-clone.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,91 @@
+<cib admin_epoch="0" cib-last-written="Fri May 28 13:58:00 2010" epoch="3" num_updates="18" validate-with="pacemaker-1.2">
+  <configuration>
+    <crm_config>
+      <cluster_property_set id="cib-bootstrap-options">
+        <nvpair id="cib-bootstrap-options-no-quorum-policy" name="no-quorum-policy" value="ignore"/>
+        <nvpair id="cib-bootstrap-options-stonith-enabled" name="stonith-enabled" value="false"/>
+      </cluster_property_set>
+    </crm_config>
+    <nodes>
+      <node id="node1" type="normal" uname="node1">
+        <instance_attributes id="nodes-node1">
+          <nvpair id="nodes-node1-standby" name="standby" value="on"/>
+        </instance_attributes>
+      </node>
+      <node id="node2" type="normal" uname="node2"/>
+    </nodes>
+    <resources>
+      <primitive class="ocf" id="rsc1" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc2" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc3" provider="pacemaker" type="Dummy"/>
+      <clone id="clone-rsc">
+        <primitive class="ocf" id="rsc" provider="pacemaker" type="Dummy"/>
+      </clone>
+    </resources>
+    <constraints>
+      <rsc_order id="order-1" score="INFINITY">
+        <resource_set id="order-1-0">
+          <resource_ref id="clone-rsc"/>
+        </resource_set>
+        <resource_set id="order-1-1" sequential="false">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+      </rsc_order>
+      <rsc_colocation id="coloc-1" score="INFINITY">
+        <resource_set id="coloc-1-0" sequential="false">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+        <resource_set id="coloc-1-1">
+          <resource_ref id="clone-rsc"/>
+        </resource_set>
+      </rsc_colocation>
+    </constraints>
+  </configuration>
+  <status>
+    <node_state id="node1" uname="node1" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node1">
+        <lrm_resources>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc1_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc3_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc:0" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc:0_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc:0_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="node2" uname="node2" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node2">
+        <lrm_resources>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc2_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc:1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc:1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc:1_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+  </status>
+</cib>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-master.dot
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-master.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,52 @@
+digraph "g" {
+"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
+"ms-rsc_demote_0" -> "ms-rsc_demoted_0" [ style = bold]
+"ms-rsc_demote_0" -> "ms-rsc_stop_0" [ style = bold]
+"ms-rsc_demote_0" -> "rsc:0_demote_0 node1" [ style = bold]
+"ms-rsc_demote_0" [ style=bold color="green" fontcolor="orange"  ]
+"ms-rsc_demoted_0" -> "ms-rsc_promote_0" [ style = bold]
+"ms-rsc_demoted_0" -> "ms-rsc_stop_0" [ style = bold]
+"ms-rsc_demoted_0" [ style=bold color="green" fontcolor="orange"  ]
+"ms-rsc_promote_0" -> "rsc:1_promote_0 node2" [ style = bold]
+"ms-rsc_promote_0" [ style=bold color="green" fontcolor="orange"  ]
+"ms-rsc_promoted_0" -> "rsc1_start_0 node2" [ style = bold]
+"ms-rsc_promoted_0" -> "rsc2_start_0 node2" [ style = bold]
+"ms-rsc_promoted_0" -> "rsc3_start_0 node2" [ style = bold]
+"ms-rsc_promoted_0" [ style=bold color="green" fontcolor="orange"  ]
+"ms-rsc_stop_0" -> "ms-rsc_stopped_0" [ style = bold]
+"ms-rsc_stop_0" -> "rsc:0_stop_0 node1" [ style = bold]
+"ms-rsc_stop_0" [ style=bold color="green" fontcolor="orange"  ]
+"ms-rsc_stopped_0" -> "ms-rsc_promote_0" [ style = bold]
+"ms-rsc_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
+"probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc1_stop_0 node1" -> "ms-rsc_demote_0" [ style = bold]
+"rsc1_stop_0 node1" -> "rsc1_start_0 node2" [ style = bold]
+"rsc1_stop_0 node1" -> "rsc:0_demote_0 node1" [ style = bold]
+"rsc1_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc2_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc2_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc2_stop_0 node1" -> "ms-rsc_demote_0" [ style = bold]
+"rsc2_stop_0 node1" -> "rsc2_start_0 node2" [ style = bold]
+"rsc2_stop_0 node1" -> "rsc:0_demote_0 node1" [ style = bold]
+"rsc2_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc3_stop_0 node1" -> "ms-rsc_demote_0" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc3_start_0 node2" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc:0_demote_0 node1" [ style = bold]
+"rsc3_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc:0_demote_0 node1" -> "ms-rsc_demoted_0" [ style = bold]
+"rsc:0_demote_0 node1" -> "rsc:0_stop_0 node1" [ style = bold]
+"rsc:0_demote_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc:0_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc:0_stop_0 node1" -> "ms-rsc_stopped_0" [ style = bold]
+"rsc:0_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc:1_promote_0 node2" -> "ms-rsc_promoted_0" [ style = bold]
+"rsc:1_promote_0 node2" -> "rsc1_start_0 node2" [ style = bold]
+"rsc:1_promote_0 node2" -> "rsc2_start_0 node2" [ style = bold]
+"rsc:1_promote_0 node2" -> "rsc3_start_0 node2" [ style = bold]
+"rsc:1_promote_0 node2" [ style=bold color="green" fontcolor="black"  ]
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-master.exp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-master.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,265 @@
+<transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
+  <synapse id="0">
+    <action_set>
+      <rsc_op id="5" operation="demote" operation_key="rsc:0_demote_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc:0" long-id="ms-rsc:rsc:0" class="ocf" provider="pacemaker" type="Stateful"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="17" operation="demote" operation_key="ms-rsc_demote_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="19" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="21" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="23" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="1">
+    <action_set>
+      <rsc_op id="6" operation="stop" operation_key="rsc:0_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc:0" long-id="ms-rsc:rsc:0" class="ocf" provider="pacemaker" type="Stateful"/>
+        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="demote" operation_key="rsc:0_demote_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="13" operation="stop" operation_key="ms-rsc_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="2">
+    <action_set>
+      <rsc_op id="10" operation="promote" operation_key="rsc:1_promote_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc:1" long-id="ms-rsc:rsc:1" class="ocf" provider="pacemaker" type="Stateful"/>
+        <attributes CRM_meta_clone="1" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="15" operation="promote" operation_key="ms-rsc_promote_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="3">
+    <action_set>
+      <pseudo_event id="13" operation="stop" operation_key="ms-rsc_stop_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="17" operation="demote" operation_key="ms-rsc_demote_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="18" operation="demoted" operation_key="ms-rsc_demoted_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="4" priority="1000000">
+    <action_set>
+      <pseudo_event id="14" operation="stopped" operation_key="ms-rsc_stopped_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="6" operation="stop" operation_key="rsc:0_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="13" operation="stop" operation_key="ms-rsc_stop_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="5">
+    <action_set>
+      <pseudo_event id="15" operation="promote" operation_key="ms-rsc_promote_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <pseudo_event id="14" operation="stopped" operation_key="ms-rsc_stopped_0"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="18" operation="demoted" operation_key="ms-rsc_demoted_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="6" priority="1000000">
+    <action_set>
+      <pseudo_event id="16" operation="promoted" operation_key="ms-rsc_promoted_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="promote" operation_key="rsc:1_promote_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="7">
+    <action_set>
+      <pseudo_event id="17" operation="demote" operation_key="ms-rsc_demote_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="19" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="21" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="23" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8" priority="1000000">
+    <action_set>
+      <pseudo_event id="18" operation="demoted" operation_key="ms-rsc_demoted_0">
+        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="demote" operation_key="rsc:0_demote_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="17" operation="demote" operation_key="ms-rsc_demote_0"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="9">
+    <action_set>
+      <rsc_op id="19" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="10">
+    <action_set>
+      <rsc_op id="20" operation="start" operation_key="rsc1_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="promote" operation_key="rsc:1_promote_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="16" operation="promoted" operation_key="ms-rsc_promoted_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="19" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="11">
+    <action_set>
+      <rsc_op id="21" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc2" long-id="rsc2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="12">
+    <action_set>
+      <rsc_op id="22" operation="start" operation_key="rsc2_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc2" long-id="rsc2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="promote" operation_key="rsc:1_promote_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="16" operation="promoted" operation_key="ms-rsc_promoted_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="21" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="13">
+    <action_set>
+      <rsc_op id="23" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="14">
+    <action_set>
+      <rsc_op id="24" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="promote" operation_key="rsc:1_promote_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <pseudo_event id="16" operation="promoted" operation_key="ms-rsc_promoted_0"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="23" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="15">
+    <action_set>
+      <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="6" operation="stop" operation_key="rsc:0_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="19" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="21" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="23" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="16" priority="1000000">
+    <action_set>
+      <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="node1">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="17" priority="1000000">
+    <action_set>
+      <rsc_op id="4" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="node2">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+</transition_graph>
+
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-master.scores
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-master.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,25 @@
+Allocation scores:
+clone_color: ms-rsc allocation score on node1: -INFINITY
+clone_color: ms-rsc allocation score on node2: 0
+clone_color: rsc:0 allocation score on node1: 1
+clone_color: rsc:0 allocation score on node2: 0
+clone_color: rsc:1 allocation score on node1: 0
+clone_color: rsc:1 allocation score on node2: 1
+native_color: rsc:1 allocation score on node1: -INFINITY
+native_color: rsc:1 allocation score on node2: 1
+native_color: rsc:0 allocation score on node1: -INFINITY
+native_color: rsc:0 allocation score on node2: -INFINITY
+rsc:1 promotion score on node2: 299
+rsc:0 promotion score on none: 0
+rsc:1 promotion score on node2: INFINITY
+rsc:0 promotion score on none: 0
+native_color: rsc1 allocation score on node1: -INFINITY
+native_color: rsc1 allocation score on node2: 1
+rsc:1 promotion score on node2: INFINITY
+rsc:0 promotion score on none: 0
+native_color: rsc2 allocation score on node1: -INFINITY
+native_color: rsc2 allocation score on node2: 1
+rsc:1 promotion score on node2: INFINITY
+rsc:0 promotion score on none: 0
+native_color: rsc3 allocation score on node1: -INFINITY
+native_color: rsc3 allocation score on node2: 1
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-master.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-master.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,100 @@
+<cib admin_epoch="0" cib-last-written="Fri May 28 14:35:33 2010" epoch="3" num_updates="19" validate-with="pacemaker-1.2">
+  <configuration>
+    <crm_config>
+      <cluster_property_set id="cib-bootstrap-options">
+        <nvpair id="cib-bootstrap-options-no-quorum-policy" name="no-quorum-policy" value="ignore"/>
+        <nvpair id="cib-bootstrap-options-stonith-enabled" name="stonith-enabled" value="false"/>
+      </cluster_property_set>
+    </crm_config>
+    <nodes>
+      <node id="node1" type="normal" uname="node1">
+        <instance_attributes id="nodes-node1">
+          <nvpair id="nodes-node1-standby" name="standby" value="on"/>
+        </instance_attributes>
+      </node>
+      <node id="node2" type="normal" uname="node2"/>
+    </nodes>
+    <resources>
+      <master id="ms-rsc">
+        <primitive class="ocf" id="rsc" provider="pacemaker" type="Stateful"/>
+      </master>
+      <primitive class="ocf" id="rsc1" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc2" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc3" provider="pacemaker" type="Dummy"/>
+    </resources>
+    <constraints>
+      <rsc_colocation id="coloc-1" score="INFINITY">
+        <resource_set id="coloc-1-0" sequential="false">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+        <resource_set id="coloc-1-2" role="Master">
+          <resource_ref id="ms-rsc"/>
+        </resource_set>
+      </rsc_colocation>
+      <rsc_location id="pref-ms-rsc-1" rsc="ms-rsc">
+        <rule id="prefer-master-1-rule-0" role="Master" score="500">
+          <expression attribute="#uname" id="pref-ms-rsc-1-expression-0" operation="eq" value="node1"/>
+        </rule>
+        <rule id="prefer-master-1-rule-1" role="Master" score="300">
+          <expression attribute="#uname" id="pref-ms-rsc-1-expression-1" operation="eq" value="node2"/>
+        </rule>
+      </rsc_location>
+      <rsc_order id="order-1" score="INFINITY">
+        <resource_set id="order-1-1" action="promote">
+          <resource_ref id="ms-rsc"/>
+        </resource_set>
+        <resource_set id="order-1-2" sequential="false">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+      </rsc_order>
+    </constraints>
+  </configuration>
+  <status>
+    <node_state id="node1" uname="node1" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node1">
+        <lrm_resources>
+          <lrm_resource id="rsc:0" class="ocf" provider="pacemaker" type="Stateful">
+            <lrm_rsc_op id="rsc:0_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc:0_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc:0_promote_0" operation="promote" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="3:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;3:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="3" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc1_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc2_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc3_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="node2" uname="node2" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node2">
+        <lrm_resources>
+          <lrm_resource id="rsc:1" class="ocf" provider="pacemaker" type="Stateful">
+            <lrm_rsc_op id="rsc:1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc:1_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+  </status>
+</cib>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-false.dot
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-false.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,39 @@
+digraph "g" {
+"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
+"probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_start_0 node2" -> "rsc2_start_0 node2" [ style = bold]
+"rsc1_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc1_stop_0 node1" -> "rsc1_start_0 node2" [ style = bold]
+"rsc1_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc2_start_0 node2" -> "rsc3_start_0 node2" [ style = bold]
+"rsc2_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc2_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc2_stop_0 node1" -> "rsc1_stop_0 node1" [ style = bold]
+"rsc2_stop_0 node1" -> "rsc2_start_0 node2" [ style = bold]
+"rsc2_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_start_0 node2" -> "rsc4_start_0 node2" [ style = bold]
+"rsc3_start_0 node2" -> "rsc5_start_0 node2" [ style = bold]
+"rsc3_start_0 node2" -> "rsc6_start_0 node2" [ style = bold]
+"rsc3_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc2_stop_0 node1" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc3_start_0 node2" [ style = bold]
+"rsc3_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc4_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc4_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc4_stop_0 node1" -> "rsc3_stop_0 node1" [ style = bold]
+"rsc4_stop_0 node1" -> "rsc4_start_0 node2" [ style = bold]
+"rsc4_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc5_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc5_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc5_stop_0 node1" -> "rsc3_stop_0 node1" [ style = bold]
+"rsc5_stop_0 node1" -> "rsc5_start_0 node2" [ style = bold]
+"rsc5_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc6_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc6_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc6_stop_0 node1" -> "rsc3_stop_0 node1" [ style = bold]
+"rsc6_stop_0 node1" -> "rsc6_start_0 node2" [ style = bold]
+"rsc6_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-false.exp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-false.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,211 @@
+<transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
+  <synapse id="0">
+    <action_set>
+      <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="1">
+    <action_set>
+      <rsc_op id="6" operation="start" operation_key="rsc1_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="2">
+    <action_set>
+      <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc2" long-id="rsc2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="3">
+    <action_set>
+      <rsc_op id="8" operation="start" operation_key="rsc2_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc2" long-id="rsc2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="6" operation="start" operation_key="rsc1_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="4">
+    <action_set>
+      <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="5">
+    <action_set>
+      <rsc_op id="10" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="8" operation="start" operation_key="rsc2_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="6">
+    <action_set>
+      <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc4" long-id="rsc4" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="7">
+    <action_set>
+      <rsc_op id="12" operation="start" operation_key="rsc4_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc4" long-id="rsc4" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8">
+    <action_set>
+      <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc5" long-id="rsc5" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="9">
+    <action_set>
+      <rsc_op id="14" operation="start" operation_key="rsc5_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc5" long-id="rsc5" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="10">
+    <action_set>
+      <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc6" long-id="rsc6" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="11">
+    <action_set>
+      <rsc_op id="16" operation="start" operation_key="rsc6_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc6" long-id="rsc6" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="12">
+    <action_set>
+      <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="13" priority="1000000">
+    <action_set>
+      <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="node1">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="14" priority="1000000">
+    <action_set>
+      <rsc_op id="4" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="node2">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+</transition_graph>
+
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-false.scores
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-false.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,13 @@
+Allocation scores:
+native_color: rsc1 allocation score on node1: -INFINITY
+native_color: rsc1 allocation score on node2: 0
+native_color: rsc2 allocation score on node1: -INFINITY
+native_color: rsc2 allocation score on node2: 0
+native_color: rsc3 allocation score on node1: -INFINITY
+native_color: rsc3 allocation score on node2: 0
+native_color: rsc4 allocation score on node1: -INFINITY
+native_color: rsc4 allocation score on node2: 0
+native_color: rsc5 allocation score on node1: -INFINITY
+native_color: rsc5 allocation score on node2: 0
+native_color: rsc6 allocation score on node1: -INFINITY
+native_color: rsc6 allocation score on node2: 0
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-false.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-false.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,110 @@
+<cib admin_epoch="0" cib-last-written="Fri May 28 12:40:09 2010" epoch="1" num_updates="23" validate-with="pacemaker-1.2">
+  <configuration>
+    <crm_config>
+      <cluster_property_set id="cib-bootstrap-options">
+        <nvpair id="cib-bootstrap-options-no-quorum-policy" name="no-quorum-policy" value="ignore"/>
+        <nvpair id="cib-bootstrap-options-stonith-enabled" name="stonith-enabled" value="false"/>
+      </cluster_property_set>
+    </crm_config>
+    <rsc_defaults/>
+    <op_defaults/>
+    <nodes>
+      <node id="node1" type="normal" uname="node1">
+        <instance_attributes id="nodes-node1">
+          <nvpair id="nodes-node1-standby" name="standby" value="on"/>
+        </instance_attributes>
+      </node>
+      <node id="node2" type="normal" uname="node2"/>
+    </nodes>
+    <resources>
+      <primitive class="ocf" id="rsc1" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc2" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc3" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc4" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc5" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc6" provider="pacemaker" type="Dummy"/>
+    </resources>
+    <constraints>
+      <rsc_colocation id="coloc-1" score="INFINITY">
+        <resource_set id="coloc-1-0" sequential="true">
+          <resource_ref id="rsc4"/>
+          <resource_ref id="rsc5"/>
+          <resource_ref id="rsc6"/>
+        </resource_set>
+        <resource_set id="coloc-1-1" sequential="true">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+      </rsc_colocation>
+      <rsc_order id="order-1" score="INFINITY">
+        <resource_set id="order-1-0" sequential="true">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+        <resource_set id="order-1-1" sequential="false">
+          <resource_ref id="rsc4"/>
+          <resource_ref id="rsc5"/>
+          <resource_ref id="rsc6"/>
+        </resource_set>
+      </rsc_order>
+    </constraints>
+  </configuration>
+  <status>
+    <node_state id="node1" uname="node1" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node1">
+        <lrm_resources>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc1_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc2_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc3_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc4" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc4_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc4_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc5" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc5_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc5_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc6" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc6_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc6_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="node2" uname="node2" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node2">
+        <lrm_resources>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc4" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc4_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc5" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc5_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc6" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc6_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+  </status>
+</cib>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-true.dot
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-true.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,39 @@
+digraph "g" {
+"all_stopped" [ style=bold color="green" fontcolor="orange"  ]
+"probe_complete node1" [ style=bold color="green" fontcolor="black"  ]
+"probe_complete node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_start_0 node2" -> "rsc2_start_0 node2" [ style = bold]
+"rsc1_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc1_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc1_stop_0 node1" -> "rsc1_start_0 node2" [ style = bold]
+"rsc1_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc2_start_0 node2" -> "rsc3_start_0 node2" [ style = bold]
+"rsc2_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc2_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc2_stop_0 node1" -> "rsc1_stop_0 node1" [ style = bold]
+"rsc2_stop_0 node1" -> "rsc2_start_0 node2" [ style = bold]
+"rsc2_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_start_0 node2" -> "rsc4_start_0 node2" [ style = bold]
+"rsc3_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc3_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc2_stop_0 node1" [ style = bold]
+"rsc3_stop_0 node1" -> "rsc3_start_0 node2" [ style = bold]
+"rsc3_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc4_start_0 node2" -> "rsc5_start_0 node2" [ style = bold]
+"rsc4_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc4_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc4_stop_0 node1" -> "rsc3_stop_0 node1" [ style = bold]
+"rsc4_stop_0 node1" -> "rsc4_start_0 node2" [ style = bold]
+"rsc4_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc5_start_0 node2" -> "rsc6_start_0 node2" [ style = bold]
+"rsc5_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc5_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc5_stop_0 node1" -> "rsc4_stop_0 node1" [ style = bold]
+"rsc5_stop_0 node1" -> "rsc5_start_0 node2" [ style = bold]
+"rsc5_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+"rsc6_start_0 node2" [ style=bold color="green" fontcolor="black"  ]
+"rsc6_stop_0 node1" -> "all_stopped" [ style = bold]
+"rsc6_stop_0 node1" -> "rsc5_stop_0 node1" [ style = bold]
+"rsc6_stop_0 node1" -> "rsc6_start_0 node2" [ style = bold]
+"rsc6_stop_0 node1" [ style=bold color="green" fontcolor="black"  ]
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-true.exp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-true.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,213 @@
+<transition_graph cluster-delay="60s" stonith-timeout="60s" failed-stop-offset="INFINITY" failed-start-offset="INFINITY" batch-limit="30" transition_id="0">
+  <synapse id="0">
+    <action_set>
+      <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="1">
+    <action_set>
+      <rsc_op id="6" operation="start" operation_key="rsc1_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc1" long-id="rsc1" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="2">
+    <action_set>
+      <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc2" long-id="rsc2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="3">
+    <action_set>
+      <rsc_op id="8" operation="start" operation_key="rsc2_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc2" long-id="rsc2" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="6" operation="start" operation_key="rsc1_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="4">
+    <action_set>
+      <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="5">
+    <action_set>
+      <rsc_op id="10" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc3" long-id="rsc3" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="8" operation="start" operation_key="rsc2_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="6">
+    <action_set>
+      <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc4" long-id="rsc4" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="7">
+    <action_set>
+      <rsc_op id="12" operation="start" operation_key="rsc4_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc4" long-id="rsc4" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="10" operation="start" operation_key="rsc3_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="8">
+    <action_set>
+      <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc5" long-id="rsc5" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="9">
+    <action_set>
+      <rsc_op id="14" operation="start" operation_key="rsc5_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc5" long-id="rsc5" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="12" operation="start" operation_key="rsc4_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="10">
+    <action_set>
+      <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1">
+        <primitive id="rsc6" long-id="rsc6" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="11">
+    <action_set>
+      <rsc_op id="16" operation="start" operation_key="rsc6_start_0" on_node="node2" on_node_uuid="node2">
+        <primitive id="rsc6" long-id="rsc6" class="ocf" provider="pacemaker" type="Dummy"/>
+        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="14" operation="start" operation_key="rsc5_start_0" on_node="node2" on_node_uuid="node2"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="12">
+    <action_set>
+      <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
+        <attributes crm_feature_set="3.0.2"/>
+      </pseudo_event>
+    </action_set>
+    <inputs>
+      <trigger>
+        <rsc_op id="5" operation="stop" operation_key="rsc1_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="7" operation="stop" operation_key="rsc2_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="9" operation="stop" operation_key="rsc3_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="11" operation="stop" operation_key="rsc4_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="13" operation="stop" operation_key="rsc5_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+      <trigger>
+        <rsc_op id="15" operation="stop" operation_key="rsc6_stop_0" on_node="node1" on_node_uuid="node1"/>
+      </trigger>
+    </inputs>
+  </synapse>
+  <synapse id="13" priority="1000000">
+    <action_set>
+      <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="node1" on_node_uuid="node1">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+  <synapse id="14" priority="1000000">
+    <action_set>
+      <rsc_op id="4" operation="probe_complete" operation_key="probe_complete" on_node="node2" on_node_uuid="node2">
+        <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
+      </rsc_op>
+    </action_set>
+    <inputs/>
+  </synapse>
+</transition_graph>
+
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-true.scores
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-true.scores	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,13 @@
+Allocation scores:
+native_color: rsc1 allocation score on node1: -INFINITY
+native_color: rsc1 allocation score on node2: 0
+native_color: rsc2 allocation score on node1: -INFINITY
+native_color: rsc2 allocation score on node2: 0
+native_color: rsc3 allocation score on node1: -INFINITY
+native_color: rsc3 allocation score on node2: 0
+native_color: rsc4 allocation score on node1: -INFINITY
+native_color: rsc4 allocation score on node2: 0
+native_color: rsc5 allocation score on node1: -INFINITY
+native_color: rsc5 allocation score on node2: 0
+native_color: rsc6 allocation score on node1: -INFINITY
+native_color: rsc6 allocation score on node2: 0
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/rsc-sets-seq-true.xml
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/pengine/test10/rsc-sets-seq-true.xml	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,110 @@
+<cib admin_epoch="0" cib-last-written="Fri May 28 12:40:09 2010" epoch="1" num_updates="23" validate-with="pacemaker-1.2">
+  <configuration>
+    <crm_config>
+      <cluster_property_set id="cib-bootstrap-options">
+        <nvpair id="cib-bootstrap-options-no-quorum-policy" name="no-quorum-policy" value="ignore"/>
+        <nvpair id="cib-bootstrap-options-stonith-enabled" name="stonith-enabled" value="false"/>
+      </cluster_property_set>
+    </crm_config>
+    <rsc_defaults/>
+    <op_defaults/>
+    <nodes>
+      <node id="node1" type="normal" uname="node1">
+        <instance_attributes id="nodes-node1">
+          <nvpair id="nodes-node1-standby" name="standby" value="on"/>
+        </instance_attributes>
+      </node>
+      <node id="node2" type="normal" uname="node2"/>
+    </nodes>
+    <resources>
+      <primitive class="ocf" id="rsc1" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc2" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc3" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc4" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc5" provider="pacemaker" type="Dummy"/>
+      <primitive class="ocf" id="rsc6" provider="pacemaker" type="Dummy"/>
+    </resources>
+    <constraints>
+      <rsc_colocation id="coloc-1" score="INFINITY">
+        <resource_set id="coloc-1-0" sequential="true">
+          <resource_ref id="rsc4"/>
+          <resource_ref id="rsc5"/>
+          <resource_ref id="rsc6"/>
+        </resource_set>
+        <resource_set id="coloc-1-1" sequential="true">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+      </rsc_colocation>
+      <rsc_order id="order-1" score="INFINITY">
+        <resource_set id="order-1-0" sequential="true">
+          <resource_ref id="rsc1"/>
+          <resource_ref id="rsc2"/>
+          <resource_ref id="rsc3"/>
+        </resource_set>
+        <resource_set id="order-1-1" sequential="true">
+          <resource_ref id="rsc4"/>
+          <resource_ref id="rsc5"/>
+          <resource_ref id="rsc6"/>
+        </resource_set>
+      </rsc_order>
+    </constraints>
+  </configuration>
+  <status>
+    <node_state id="node1" uname="node1" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node1">
+        <lrm_resources>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc1_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc2_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc3_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc4" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc4_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc4_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc5" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc5_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc5_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc6" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc6_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+            <lrm_rsc_op id="rsc6_start_0" operation="start" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:0;2:-1:0:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="2" rc-code="0" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+    <node_state id="node2" uname="node2" ha="active" in_ccm="true" crmd="online" join="member" expected="member" crm-debug-origin="crm_simulate">
+      <lrm id="node2">
+        <lrm_resources>
+          <lrm_resource id="rsc1" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc1_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc2" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc2_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc3" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc3_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc4" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc4_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc5" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc5_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+          <lrm_resource id="rsc6" class="ocf" provider="pacemaker" type="Dummy">
+            <lrm_rsc_op id="rsc6_monitor_0" operation="monitor" crm-debug-origin="crm_simulate" crm_feature_set="3.0.2" transition-key="1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" transition-magic="0:7;1:-1:7:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" call-id="1" rc-code="7" op-status="0" interval="0" op-digest="f2317cad3d54cec5d7d7aa7d0bf35cf8"/>
+          </lrm_resource>
+        </lrm_resources>
+      </lrm>
+    </node_state>
+  </status>
+</cib>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/simple6.dot
--- a/pengine/test10/simple6.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/simple6.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -2,6 +2,7 @@
 "all_stopped" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete node1" -> "probe_complete" [ style = bold]
 "probe_complete node1" [ style=bold color="green" fontcolor="black" ]
+"probe_complete" -> "rsc1_stop_0 node1" [ style = bold]
 "probe_complete" -> "rsc2_start_0 node1" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc1_stop_0 node1" -> "all_stopped" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/simple6.exp
--- a/pengine/test10/simple6.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/simple6.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -28,7 +28,11 @@
         <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </rsc_op>
      </action_set>
-     <inputs/>
+    <inputs>
+      <trigger>
+        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
+      </trigger>
+    </inputs>
    </synapse>
    <synapse id="3">
      <action_set>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/stonith-3.dot
--- a/pengine/test10/stonith-3.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/stonith-3.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -5,24 +5,11 @@ digraph "g" {
 "clnStonith_start_0" -> "clnStonith_running_0" [ style = bold]
 "clnStonith_start_0" -> "grpStonith:0_start_0" [ style = bold]
 "clnStonith_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"clnStonith_stop_0" -> "clnStonith_start_0" [ style = bold]
-"clnStonith_stop_0" -> "clnStonith_stopped_0" [ style = bold]
-"clnStonith_stop_0" -> "grpStonith:0_stop_0" [ style = bold]
-"clnStonith_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"clnStonith_stopped_0" -> "clnStonith_start_0" [ style = bold]
-"clnStonith_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "grpStonith:0_running_0" -> "clnStonith_running_0" [ style = bold]
 "grpStonith:0_running_0" [ style=bold color="green" fontcolor="orange"  ]
 "grpStonith:0_start_0" -> "grpStonith:0_running_0" [ style = bold]
 "grpStonith:0_start_0" -> "prmStonith:0_start_0 rh5node2" [ style = bold]
 "grpStonith:0_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"grpStonith:0_stop_0" -> "grpStonith:0_start_0" [ style = bold]
-"grpStonith:0_stop_0" -> "grpStonith:0_stopped_0" [ style = bold]
-"grpStonith:0_stop_0" -> "prmStonith:0_stop_0" [ style = bold]
-"grpStonith:0_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"grpStonith:0_stopped_0" -> "clnStonith_stopped_0" [ style = bold]
-"grpStonith:0_stopped_0" -> "grpStonith:0_start_0" [ style = bold]
-"grpStonith:0_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "prmIpPostgreSQLDB_monitor_0 rh5node2" -> "probe_complete rh5node2" [ style = bold]
 "prmIpPostgreSQLDB_monitor_0 rh5node2" [ style=bold color="green" fontcolor="black"  ]
 "prmIpPostgreSQLDB_monitor_30000 rh5node2" [ style=bold color="green" fontcolor="black"  ]
@@ -33,17 +20,10 @@ digraph "g" {
 "prmStonith:0_start_0 rh5node2" -> "grpStonith:0_running_0" [ style = bold]
 "prmStonith:0_start_0 rh5node2" -> "stonith_up" [ style = bold]
 "prmStonith:0_start_0 rh5node2" [ style=bold color="green" fontcolor="black"  ]
-"prmStonith:0_stop_0" -> "grpStonith:0_stopped_0" [ style = bold]
-"prmStonith:0_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete rh5node2" -> "probe_complete" [ style = bold]
 "probe_complete rh5node2" [ style=bold color="green" fontcolor="black"  ]
-"probe_complete" -> "clnStonith_start_0" [ style = bold]
-"probe_complete" -> "clnStonith_stop_0" [ style = bold]
-"probe_complete" -> "grpStonith:0_start_0" [ style = bold]
-"probe_complete" -> "grpStonith:0_stop_0" [ style = bold]
 "probe_complete" -> "prmIpPostgreSQLDB_start_0 rh5node2" [ style = bold]
 "probe_complete" -> "prmStonith:0_start_0 rh5node2" [ style = bold]
-"probe_complete" -> "prmStonith:0_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
 "stonith rh5node1" -> "all_stopped" [ style = bold]
 "stonith rh5node1" -> "stonith_complete" [ style = bold]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/stonith-3.exp
--- a/pengine/test10/stonith-3.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/stonith-3.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -45,15 +45,6 @@
     </action_set>
     <inputs>
       <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="11" operation="stop" operation_key="grpStonith:0_stop_0"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="12" operation="stopped" operation_key="grpStonith:0_stopped_0"/>
-      </trigger>
-      <trigger>
         <pseudo_event id="17" operation="start" operation_key="clnStonith_start_0"/>
       </trigger>
     </inputs>
@@ -75,36 +66,6 @@
   </synapse>
   <synapse id="5">
     <action_set>
-      <pseudo_event id="11" operation="stop" operation_key="grpStonith:0_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="19" operation="stop" operation_key="clnStonith_stop_0"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="6">
-    <action_set>
-      <pseudo_event id="12" operation="stopped" operation_key="grpStonith:0_stopped_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="11" operation="stop" operation_key="grpStonith:0_stop_0"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="25" operation="stop" operation_key="prmStonith:0_stop_0"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="7">
-    <action_set>
       <rsc_op id="5" operation="monitor" operation_key="prmStonith:0_monitor_0" on_node="rh5node2" on_node_uuid="fb62f5f4-015c-466a-8778-7b5c1c5639d6">
         <primitive id="prmStonith:0" long-id="clnStonith:grpStonith:0:prmStonith:0" class="stonith" type="external/ssh"/>
         <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" hostlist="rh5node1 rh5node2" stonith-timeout="70s"/>
@@ -112,7 +73,7 @@
     </action_set>
     <inputs/>
   </synapse>
-  <synapse id="8">
+  <synapse id="6">
     <action_set>
       <rsc_op id="8" operation="start" operation_key="prmStonith:0_start_0" on_node="rh5node2" on_node_uuid="fb62f5f4-015c-466a-8778-7b5c1c5639d6">
         <primitive id="prmStonith:0" long-id="clnStonith:grpStonith:0:prmStonith:0" class="stonith" type="external/ssh"/>
@@ -128,40 +89,15 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="9">
-    <action_set>
-      <pseudo_event id="25" operation="stop" operation_key="prmStonith:0_stop_0">
-        <attributes CRM_meta_clone="0" CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="11" operation="stop" operation_key="grpStonith:0_stop_0"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="10">
+  <synapse id="7">
     <action_set>
       <pseudo_event id="17" operation="start" operation_key="clnStonith_start_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="19" operation="stop" operation_key="clnStonith_stop_0"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="20" operation="stopped" operation_key="clnStonith_stopped_0"/>
-      </trigger>
-    </inputs>
+    <inputs/>
   </synapse>
-  <synapse id="11" priority="1000000">
+  <synapse id="8" priority="1000000">
     <action_set>
       <pseudo_event id="18" operation="running" operation_key="clnStonith_running_0">
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -176,34 +112,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="12">
-    <action_set>
-      <pseudo_event id="19" operation="stop" operation_key="clnStonith_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="13" priority="1000000">
-    <action_set>
-      <pseudo_event id="20" operation="stopped" operation_key="clnStonith_stopped_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="12" operation="stopped" operation_key="grpStonith:0_stopped_0"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="19" operation="stop" operation_key="clnStonith_stop_0"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="14">
+  <synapse id="9">
     <action_set>
       <pseudo_event id="1" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
@@ -215,7 +124,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="15">
+  <synapse id="10">
     <action_set>
       <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -227,7 +136,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="16" priority="1000000">
+  <synapse id="11" priority="1000000">
     <action_set>
       <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="rh5node2" on_node_uuid="fb62f5f4-015c-466a-8778-7b5c1c5639d6">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -242,7 +151,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="17">
+  <synapse id="12">
     <action_set>
       <pseudo_event id="21" operation="stonith_up" operation_key="stonith_up">
         <attributes crm_feature_set="3.0.2"/>
@@ -254,7 +163,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="18">
+  <synapse id="13">
     <action_set>
       <pseudo_event id="22" operation="stonith_complete" operation_key="stonith_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -269,7 +178,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="19">
+  <synapse id="14">
     <action_set>
       <crm_event id="23" operation="stonith" operation_key="stonith" on_node="rh5node1" on_node_uuid="286f4fcb-519e-4a23-b39f-9ab0017d0442">
         <attributes CRM_meta_on_node="rh5node1" CRM_meta_on_node_uuid="286f4fcb-519e-4a23-b39f-9ab0017d0442" CRM_meta_stonith_action="reboot" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/unrunnable-1.dot
--- a/pengine/test10/unrunnable-1.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/unrunnable-1.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -11,34 +11,12 @@
 "child_192.168.100.181_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
 "child_192.168.100.181_monitor_0 c001n03" [ style=bold color="green" fontcolor="black" ]
 "child_192.168.100.181_monitor_5000 c001n03" [ style=dashed color="red" fontcolor="black"  ]
-"child_192.168.100.181_start_0 c001n03" -> "child_192.168.100.181_monitor_5000 c001n03" [ style = dashed]
-"child_192.168.100.181_start_0 c001n03" -> "child_192.168.100.182_start_0 c001n03" [ style = dashed]
-"child_192.168.100.181_start_0 c001n03" -> "group-1_running_0" [ style = dashed]
-"child_192.168.100.181_start_0 c001n03" [ style=dashed color="red" fontcolor="black"  ]
-"child_192.168.100.181_stop_0" -> "all_stopped" [ style = bold]
-"child_192.168.100.181_stop_0" -> "group-1_stopped_0" [ style = bold]
-"child_192.168.100.181_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_192.168.100.182_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
 "child_192.168.100.182_monitor_0 c001n03" [ style=bold color="green" fontcolor="black" ]
 "child_192.168.100.182_monitor_5000 c001n03" [ style=dashed color="red" fontcolor="black"  ]
-"child_192.168.100.182_start_0 c001n03" -> "child_192.168.100.182_monitor_5000 c001n03" [ style = dashed]
-"child_192.168.100.182_start_0 c001n03" -> "child_192.168.100.183_start_0 c001n03" [ style = dashed]
-"child_192.168.100.182_start_0 c001n03" -> "group-1_running_0" [ style = dashed]
-"child_192.168.100.182_start_0 c001n03" [ style=dashed color="red" fontcolor="black"  ]
-"child_192.168.100.182_stop_0" -> "all_stopped" [ style = bold]
-"child_192.168.100.182_stop_0" -> "child_192.168.100.181_stop_0" [ style = bold]
-"child_192.168.100.182_stop_0" -> "group-1_stopped_0" [ style = bold]
-"child_192.168.100.182_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_192.168.100.183_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
 "child_192.168.100.183_monitor_0 c001n03" [ style=bold color="green" fontcolor="black" ]
 "child_192.168.100.183_monitor_5000 c001n03" [ style=dashed color="red" fontcolor="black"  ]
-"child_192.168.100.183_start_0 c001n03" -> "child_192.168.100.183_monitor_5000 c001n03" [ style = dashed]
-"child_192.168.100.183_start_0 c001n03" -> "group-1_running_0" [ style = dashed]
-"child_192.168.100.183_start_0 c001n03" [ style=dashed color="red" fontcolor="black"  ]
-"child_192.168.100.183_stop_0" -> "all_stopped" [ style = bold]
-"child_192.168.100.183_stop_0" -> "child_192.168.100.182_stop_0" [ style = bold]
-"child_192.168.100.183_stop_0" -> "group-1_stopped_0" [ style = bold]
-"child_192.168.100.183_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "child_DoFencing:1_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
 "child_DoFencing:1_monitor_0 c001n03" [ style=bold color="green" fontcolor="black" ]
 "child_DoFencing:1_stop_0 c001n02" -> "DoFencing_stopped_0" [ style = dashed]
@@ -47,32 +25,9 @@
 "child_DoFencing:2_monitor_0 c001n03" [ style=bold color="green" fontcolor="black" ]
 "child_DoFencing:3_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
 "child_DoFencing:3_monitor_0 c001n03" [ style=bold color="green" fontcolor="black" ]
-"group-1_running_0" [ style=dashed color="red" fontcolor="orange"  ]
-"group-1_start_0" -> "child_192.168.100.181_start_0 c001n03" [ style = dashed]
-"group-1_start_0" -> "child_192.168.100.182_start_0 c001n03" [ style = dashed]
-"group-1_start_0" -> "child_192.168.100.183_start_0 c001n03" [ style = dashed]
-"group-1_start_0" -> "group-1_running_0" [ style = dashed]
-"group-1_start_0" [ style=dashed color="red" fontcolor="orange"  ]
-"group-1_stop_0" -> "child_192.168.100.181_stop_0" [ style = bold]
-"group-1_stop_0" -> "child_192.168.100.182_stop_0" [ style = bold]
-"group-1_stop_0" -> "child_192.168.100.183_stop_0" [ style = bold]
-"group-1_stop_0" -> "group-1_start_0" [ style = dashed]
-"group-1_stop_0" -> "group-1_stopped_0" [ style = bold]
-"group-1_stop_0" [ style=bold color="green" fontcolor="orange"  ]
-"group-1_stopped_0" -> "group-1_start_0" [ style = dashed]
-"group-1_stopped_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete c001n03" -> "probe_complete" [ style = bold]
 "probe_complete c001n03" [ style=bold color="green" fontcolor="black" ]
-"probe_complete" -> "DoFencing_stop_0" [ style = bold]
-"probe_complete" -> "child_192.168.100.181_start_0 c001n03" [ style = dashed]
-"probe_complete" -> "child_192.168.100.181_stop_0" [ style = bold]
-"probe_complete" -> "child_192.168.100.182_start_0 c001n03" [ style = dashed]
-"probe_complete" -> "child_192.168.100.182_stop_0" [ style = bold]
-"probe_complete" -> "child_192.168.100.183_start_0 c001n03" [ style = dashed]
-"probe_complete" -> "child_192.168.100.183_stop_0" [ style = bold]
 "probe_complete" -> "child_DoFencing:1_stop_0 c001n02" [ style = dashed]
-"probe_complete" -> "group-1_start_0" [ style = dashed]
-"probe_complete" -> "group-1_stop_0" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange" ]
 "rsc_c001n01_monitor_0 c001n03" -> "probe_complete c001n03" [ style = bold]
 "rsc_c001n01_monitor_0 c001n03" [ style=bold color="green" fontcolor="black" ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/unrunnable-1.exp
--- a/pengine/test10/unrunnable-1.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/unrunnable-1.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -10,39 +10,6 @@
    </synapse>
    <synapse id="1">
      <action_set>
-      <pseudo_event id="26" operation="stop" operation_key="group-1_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="3" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="2">
-     <action_set>
-      <pseudo_event id="27" operation="stopped" operation_key="group-1_stopped_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="26" operation="stop" operation_key="group-1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="46" operation="stop" operation_key="child_192.168.100.181_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="child_192.168.100.182_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="48" operation="stop" operation_key="child_192.168.100.183_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="3">
-     <action_set>
       <rsc_op id="6" operation="monitor" operation_key="child_192.168.100.181_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="child_192.168.100.181" long-id="group-1:child_192.168.100.181" class="ocf" provider="heartbeat" type="IPaddr"/>
         <attributes CRM_meta_op_target_rc="7" CRM_meta_timeout="20000" crm_feature_set="3.0.2" ip="192.168.100.181"/>
@@ -50,25 +17,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="4">
-     <action_set>
-      <pseudo_event id="46" operation="stop" operation_key="child_192.168.100.181_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="3" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="26" operation="stop" operation_key="group-1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="child_192.168.100.182_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="5">
+  <synapse id="2">
      <action_set>
       <rsc_op id="7" operation="monitor" operation_key="child_192.168.100.182_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="child_192.168.100.182" long-id="group-1:child_192.168.100.182" class="ocf" provider="heartbeat" type="IPaddr"/>
@@ -77,25 +26,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="6">
-     <action_set>
-      <pseudo_event id="47" operation="stop" operation_key="child_192.168.100.182_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="3" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="26" operation="stop" operation_key="group-1_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="48" operation="stop" operation_key="child_192.168.100.183_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="7">
+  <synapse id="3">
      <action_set>
       <rsc_op id="8" operation="monitor" operation_key="child_192.168.100.183_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="child_192.168.100.183" long-id="group-1:child_192.168.100.183" class="ocf" provider="heartbeat" type="IPaddr"/>
@@ -104,22 +35,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="8">
-     <action_set>
-      <pseudo_event id="48" operation="stop" operation_key="child_192.168.100.183_stop_0">
-        <attributes CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-       </pseudo_event>
-     </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="3" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="26" operation="stop" operation_key="group-1_stop_0"/>
-       </trigger>
-     </inputs>
-   </synapse>
-   <synapse id="9">
+  <synapse id="4">
      <action_set>
       <rsc_op id="9" operation="monitor" operation_key="rsc_c001n08_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="rsc_c001n08" long-id="rsc_c001n08" class="ocf" provider="heartbeat" type="IPaddr"/>
@@ -128,7 +44,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="10">
+  <synapse id="5">
      <action_set>
       <rsc_op id="10" operation="monitor" operation_key="rsc_c001n02_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="rsc_c001n02" long-id="rsc_c001n02" class="ocf" provider="heartbeat" type="IPaddr"/>
@@ -137,7 +53,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="11">
+  <synapse id="6">
      <action_set>
       <rsc_op id="11" operation="monitor" operation_key="rsc_c001n03_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="rsc_c001n03" long-id="rsc_c001n03" class="ocf" provider="heartbeat" type="IPaddr"/>
@@ -146,7 +62,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="12">
+  <synapse id="7">
      <action_set>
       <rsc_op id="12" operation="monitor" operation_key="rsc_c001n01_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="rsc_c001n01" long-id="rsc_c001n01" class="ocf" provider="heartbeat" type="IPaddr"/>
@@ -155,7 +71,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="13">
+  <synapse id="8">
      <action_set>
       <rsc_op id="13" operation="monitor" operation_key="DoFencing:child_DoFencing:1_monitor_0" internal_operation_key="child_DoFencing:1_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
         <primitive id="DoFencing:child_DoFencing:1" long-id="child_DoFencing:1" class="stonith" type="ssh"/>
@@ -164,7 +80,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="14">
+  <synapse id="9">
      <action_set>
       <rsc_op id="14" operation="monitor" operation_key="child_DoFencing:2_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="child_DoFencing:2" long-id="DoFencing:child_DoFencing:2" class="stonith" type="ssh"/>
@@ -173,7 +89,7 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="15">
+  <synapse id="10">
      <action_set>
       <rsc_op id="15" operation="monitor" operation_key="child_DoFencing:3_monitor_0" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
          <primitive id="child_DoFencing:3" long-id="DoFencing:child_DoFencing:3" class="stonith" type="ssh"/>
@@ -182,19 +98,15 @@
      </action_set>
      <inputs/>
    </synapse>
-   <synapse id="16">
+  <synapse id="11">
      <action_set>
        <pseudo_event id="41" operation="stop" operation_key="DoFencing_stop_0">
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="3" operation="probe_complete" operation_key="probe_complete"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
-   <synapse id="17" priority="1000000">
+  <synapse id="12" priority="1000000">
      <action_set>
        <pseudo_event id="42" operation="stopped" operation_key="DoFencing_stopped_0">
         <attributes CRM_meta_clone_max="4" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="true" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
@@ -206,25 +118,15 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="18">
+  <synapse id="13">
      <action_set>
       <pseudo_event id="2" operation="all_stopped" operation_key="all_stopped">
         <attributes crm_feature_set="3.0.2"/>
        </pseudo_event>
      </action_set>
-     <inputs>
-       <trigger>
-        <pseudo_event id="46" operation="stop" operation_key="child_192.168.100.181_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="47" operation="stop" operation_key="child_192.168.100.182_stop_0"/>
-       </trigger>
-       <trigger>
-        <pseudo_event id="48" operation="stop" operation_key="child_192.168.100.183_stop_0"/>
-       </trigger>
-     </inputs>
+    <inputs/>
    </synapse>
-   <synapse id="19">
+  <synapse id="14">
      <action_set>
       <pseudo_event id="3" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
@@ -236,7 +138,7 @@
        </trigger>
      </inputs>
    </synapse>
-   <synapse id="20" priority="1000000">
+  <synapse id="15" priority="1000000">
      <action_set>
       <rsc_op id="4" operation="probe_complete" operation_key="probe_complete" on_node="c001n03" on_node_uuid="5d9a8c11-8684-43ea-91.0.6e221530c193">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/use-after-free-merge.dot
--- a/pengine/test10/use-after-free-merge.dot	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/use-after-free-merge.dot	Mon Jul 12 18:48:04 2010 +0200
@@ -17,15 +17,11 @@ digraph "g" {
 "ms0_start_0" -> "s0:0_start_0 hex-13" [ style = bold]
 "ms0_start_0" -> "s0:1_start_0 hex-14" [ style = bold]
 "ms0_start_0" [ style=bold color="green" fontcolor="orange"  ]
-"ms0_stop_0" -> "ms0_start_0" [ style = bold]
-"ms0_stop_0" [ style=bold color="green" fontcolor="orange"  ]
 "probe_complete hex-13" -> "probe_complete" [ style = bold]
 "probe_complete hex-13" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete hex-14" -> "probe_complete" [ style = bold]
 "probe_complete hex-14" [ style=bold color="green" fontcolor="black"  ]
 "probe_complete" -> "fencing-sbd_start_0 hex-14" [ style = bold]
-"probe_complete" -> "ms0_start_0" [ style = bold]
-"probe_complete" -> "ms0_stop_0" [ style = bold]
 "probe_complete" -> "s0:0_start_0 hex-13" [ style = bold]
 "probe_complete" -> "s0:1_start_0 hex-14" [ style = bold]
 "probe_complete" [ style=bold color="green" fontcolor="orange"  ]
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/test10/use-after-free-merge.exp
--- a/pengine/test10/use-after-free-merge.exp	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/test10/use-after-free-merge.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -122,14 +122,7 @@
         <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
       </pseudo_event>
     </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-      <trigger>
-        <pseudo_event id="22" operation="stop" operation_key="ms0_stop_0"/>
-      </trigger>
-    </inputs>
+    <inputs/>
   </synapse>
   <synapse id="12" priority="1000000">
     <action_set>
@@ -151,18 +144,6 @@
   </synapse>
   <synapse id="13">
     <action_set>
-      <pseudo_event id="22" operation="stop" operation_key="ms0_stop_0">
-        <attributes CRM_meta_clone_max="2" CRM_meta_clone_node_max="1" CRM_meta_globally_unique="false" CRM_meta_master_max="1" CRM_meta_master_node_max="1" CRM_meta_notify="false" CRM_meta_timeout="20000" crm_feature_set="3.0.2"/>
-      </pseudo_event>
-    </action_set>
-    <inputs>
-      <trigger>
-        <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete"/>
-      </trigger>
-    </inputs>
-  </synapse>
-  <synapse id="14">
-    <action_set>
       <pseudo_event id="2" operation="probe_complete" operation_key="probe_complete">
         <attributes crm_feature_set="3.0.2"/>
       </pseudo_event>
@@ -176,7 +157,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="15" priority="1000000">
+  <synapse id="14" priority="1000000">
     <action_set>
       <rsc_op id="3" operation="probe_complete" operation_key="probe_complete" on_node="hex-13" on_node_uuid="hex-13">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
@@ -197,7 +178,7 @@
       </trigger>
     </inputs>
   </synapse>
-  <synapse id="16" priority="1000000">
+  <synapse id="15" priority="1000000">
     <action_set>
       <rsc_op id="8" operation="probe_complete" operation_key="probe_complete" on_node="hex-14" on_node_uuid="hex-14">
         <attributes CRM_meta_op_no_wait="true" crm_feature_set="3.0.2"/>
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/utils.c
--- a/pengine/utils.c	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/utils.c	Mon Jul 12 18:48:04 2010 +0200
@@ -176,6 +176,12 @@ can_run_resources(const node_t *node)
 	if(node == NULL) {
 		return FALSE;	
 	}
+
+#if 0	
+	if(node->weight < 0) {
+		return FALSE;	
+	}
+#endif
 	
 	if(node->details->online == FALSE
 	   || node->details->shutdown
@@ -255,12 +261,12 @@ compare_capacity(const node_t *node1, co
 /* return -1 if 'a' is more preferred
  * return  1 if 'b' is more preferred
  */
+
 gint sort_node_weight(gconstpointer a, gconstpointer b, gpointer data)
 {
 	int level = LOG_DEBUG_3;
 	const node_t *node1 = (const node_t*)a;
 	const node_t *node2 = (const node_t*)b;
-	const pe_working_set_t *data_set = (const pe_working_set_t*)data;
 
 	int node1_weight = 0;
 	int node2_weight = 0;
@@ -298,11 +304,11 @@ gint sort_node_weight(gconstpointer a, g
 		    node1->details->uname, node1_weight,
 		    node2->details->uname, node2_weight);
 
-	if (safe_str_eq(data_set->placement_strategy, "minimal")) {
+	if (safe_str_eq(pe_dataset->placement_strategy, "minimal")) {
 		goto equal;
 	}
 
-	if (safe_str_eq(data_set->placement_strategy, "balanced")) {
+	if (safe_str_eq(pe_dataset->placement_strategy, "balanced")) {
 		result = compare_capacity(node1, node2);
 		if (result != 0) {
 			return result;
@@ -379,18 +385,14 @@ native_assign_node(resource_t *rsc, GLis
 
 	clear_bit(rsc->flags, pe_rsc_provisional);
 	
-	if(chosen == NULL) {
-		crm_debug("Could not allocate a node for %s", rsc->id);
-		rsc->next_role = RSC_ROLE_STOPPED;
-		return FALSE;
-
-	} else if(force == FALSE
-		  && (can_run_resources(chosen) == FALSE || chosen->weight < 0)) {
+	if(force == FALSE
+	   && chosen != NULL
+	   && (can_run_resources(chosen) == FALSE || chosen->weight < 0)) {
 		crm_debug("All nodes for resource %s are unavailable"
 			  ", unclean or shutting down (%s: %d, %d)",
 			  rsc->id, chosen->details->uname, can_run_resources(chosen), chosen->weight);
 		rsc->next_role = RSC_ROLE_STOPPED;
-		return FALSE;
+		chosen = NULL;
 	}
 
 	/* todo: update the old node for each resource to reflect its
@@ -399,6 +401,7 @@ native_assign_node(resource_t *rsc, GLis
 
 	if(rsc->allocated_to) {
 		node_t *old = rsc->allocated_to;
+		crm_info("Deallocating %s from %s", rsc->id, old->details->uname);
 		old->details->allocated_rsc = g_list_remove(
 			old->details->allocated_rsc, rsc);
 		old->details->num_resources--;
@@ -406,6 +409,38 @@ native_assign_node(resource_t *rsc, GLis
 		calculate_utilization(old, rsc, FALSE);
 	}
 	
+	if(chosen == NULL) {
+	    char *key = NULL;
+	    GListPtr possible_matches = NULL;
+
+	    crm_debug("Could not allocate a node for %s", rsc->id);
+	    rsc->next_role = RSC_ROLE_STOPPED;
+	    
+	    key = generate_op_key(rsc->id, CRMD_ACTION_STOP, 0);
+	    possible_matches = find_actions(rsc->actions, key, NULL);
+
+	    slist_iter(
+		stop, action_t, possible_matches, lpc,
+		stop->optional = FALSE;
+		);
+
+	    g_list_free(possible_matches);
+	    crm_free(key);
+
+	    key = generate_op_key(rsc->id, CRMD_ACTION_START, 0);
+	    possible_matches = find_actions(rsc->actions, key, NULL);
+
+	    slist_iter(
+		start, action_t, possible_matches, lpc,
+		start->runnable = FALSE;
+		);	    
+
+	    g_list_free(possible_matches);
+	    crm_free(key);
+
+	    return FALSE;
+	}
+
 	crm_debug("Assigning %s to %s", chosen->details->uname, rsc->id);
 	crm_free(rsc->allocated_to);
 	rsc->allocated_to = node_copy(chosen);
@@ -414,7 +449,6 @@ native_assign_node(resource_t *rsc, GLis
 	chosen->details->num_resources++;
 	chosen->count++;
 	calculate_utilization(chosen, rsc, TRUE);
-
 	return TRUE;
 }
 
@@ -671,3 +705,20 @@ gboolean can_run_any(GListPtr nodes)
 	return FALSE;
 }
 
+enum rsc_role_e
+minimum_resource_state(resource_t *rsc, gboolean current)
+{
+    enum rsc_role_e min_role = RSC_ROLE_MAX;
+    
+    if(rsc->children) {
+	slist_iter(
+		child_rsc, resource_t, rsc->children, lpc,
+		enum rsc_role_e role = child_rsc->fns->state(child_rsc, current);
+		if(role < min_role) {
+			min_role = role;
+		}
+	    );
+	return min_role;
+    }
+    return rsc->fns->state(rsc, current);
+}
diff -r f059ec7ced7a -r b230ffa2ecdc pengine/utils.h
--- a/pengine/utils.h	Mon May 17 17:57:40 2010 +0200
+++ b/pengine/utils.h	Mon Jul 12 18:48:04 2010 +0200
@@ -63,6 +63,8 @@ extern gboolean can_run_any(GListPtr nod
 extern resource_t *find_compatible_child(
     resource_t *local_child, resource_t *rsc, enum rsc_role_e filter, gboolean current);
 
+extern enum rsc_role_e minimum_resource_state(resource_t *rsc, gboolean current);
+
 #define STONITH_UP "stonith_up"
 #define STONITH_DONE "stonith_complete"
 #define ALL_STOPPED "all_stopped"
diff -r f059ec7ced7a -r b230ffa2ecdc shell/Makefile.am
--- a/shell/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/shell/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -21,6 +21,16 @@ MAINTAINERCLEANFILES    = Makefile.in
 
 sbin_SCRIPTS		= crm
 
-EXTRA_DIST			= crm
+EXTRA_DIST		= crm
 
 SUBDIRS = templates regression modules
+
+if BUILD_HELP
+man8_MANS =	crm.8
+%.8:	%
+	echo Creating $@
+	chmod a+x $<
+	mkdir $(top_builddir)/shell/local
+	cd $(top_builddir)/shell/local && ln -s ../modules crm
+	PATH=$$PATH:$(top_builddir)/tools PYTHONPATH=$(top_builddir)/shell/local help2man --output $@ --no-info --section 8 --name "Part of the Pacemaker cluster resource manager" $(top_builddir)/shell/$<
+endif
diff -r f059ec7ced7a -r b230ffa2ecdc shell/modules/Makefile.am
--- a/shell/modules/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/shell/modules/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -41,6 +41,6 @@ modules	=	__init__.py 	\
 			vars.py		\
 			xmlutil.py
 
-shelllibdir	= $(pythondir)/crm
+shelllibdir	= $(pyexecdir)/crm
 
 shelllib_PYTHON = $(modules)
diff -r f059ec7ced7a -r b230ffa2ecdc shell/modules/cibconfig.py
--- a/shell/modules/cibconfig.py	Mon May 17 17:57:40 2010 +0200
+++ b/shell/modules/cibconfig.py	Mon Jul 12 18:48:04 2010 +0200
@@ -311,6 +311,7 @@ class CibObjectSetCli(CibObjectSet):
         TODO: Implement undo configuration changes.
         '''
         l = []
+        id_list = []
         rc = True
         err_buf.start_tmp_lineno()
         cp = CliParser()
@@ -318,6 +319,12 @@ class CibObjectSetCli(CibObjectSet):
             err_buf.incr_lineno()
             cli_list = cp.parse(cli_text)
             if cli_list:
+                id = find_value(cli_list[0][1],"id")
+                if id:
+                    if id in id_list:
+                        common_err("duplicate element %s" % id)
+                        rc = False
+                    id_list.append(id)
                 l.append(cli_list)
             elif cli_list == False:
                 rc = False
@@ -344,6 +351,7 @@ class CibObjectSetRaw(CibObjectSet):
     '''
     Edit or display one or more CIB objects (XML).
     '''
+    actions_filter = "grep LogActions: | grep -vw Leave"
     def __init__(self, *args):
         CibObjectSet.__init__(self, *args)
         self.obj_list = cib_factory.mkobj_list("xml",*args)
@@ -406,10 +414,12 @@ class CibObjectSetRaw(CibObjectSet):
         rc = pipe_string(cib_verify,self.repr(format = -1))
         cli_display.reset_no_pretty()
         return rc in (0,1)
-    def ptest(self, nograph, scores, utilization, verbosity):
+    def ptest(self, nograph, scores, utilization, actions, verbosity):
         if not cib_factory.is_cib_sane():
             return False
         if verbosity:
+            if actions:
+                verbosity = 'v' * max(3,len(verbosity))
             ptest = "ptest -X -%s" % verbosity.upper()
         if scores:
             ptest = "%s -s" % ptest
@@ -427,6 +437,12 @@ class CibObjectSetRaw(CibObjectSet):
             common_err("no status section found")
             return False
         cib.appendChild(doc.importNode(status,1))
+        # ptest prints to stderr
+        if actions:
+            ptest = "%s 2>&1 | %s | %s" % \
+                (ptest, self.actions_filter, user_prefs.pager)
+        else:
+            ptest = "%s 2>&1 | %s" % (ptest, user_prefs.pager)
         pipe_string(ptest,doc.toprettyxml())
         doc.unlink()
         if dotfile:
@@ -497,7 +513,8 @@ def mkxmlnvpairs(e,oldnode,id_hint):
     as instance_attributes.
     NB: Other tags not containing nvpairs are fine if the dict is empty.
     '''
-    node = cib_factory.createElement(e[0])
+    xml_node_type = e[0] in vars.defaults_tags and "meta_attributes" or e[0]
+    node = cib_factory.createElement(xml_node_type)
     match_node = lookup_node(node,oldnode)
     #if match_node:
         #print "found nvpairs set:",match_node.tagName,match_node.getAttribute("id")
@@ -512,6 +529,8 @@ def mkxmlnvpairs(e,oldnode,id_hint):
     if v:
         node.setAttribute("id",v)
         e[1].remove(["$id",v])
+    elif e[0] in vars.nvset_cli_names:
+        node.setAttribute("id",id_hint)
     else:
         if e[0] == "operations": # operations don't need no id
             set_id(node,match_node,id_hint,id_required = False)
@@ -600,8 +619,8 @@ conv_list = {
     "params": "instance_attributes",
     "meta": "meta_attributes",
     "property": "cluster_property_set",
-    "rsc_defaults": "meta_attributes",
-    "op_defaults": "meta_attributes",
+    "rsc_defaults": "rsc_defaults",
+    "op_defaults": "op_defaults",
     "attributes": "instance_attributes",
     "utilization": "utilization",
     "operations": "operations",
@@ -616,7 +635,7 @@ def mkxmlnode(e,oldnode,id_hint):
     '''
     if e[0] in conv_list:
         e[0] = conv_list[e[0]]
-    if e[0] in ("instance_attributes","meta_attributes","operations","cluster_property_set","utilization"):
+    if e[0] in ("instance_attributes","meta_attributes","operations","rsc_defaults","op_defaults","cluster_property_set","utilization"):
         return mkxmlnvpairs(e,oldnode,id_hint)
     elif e[0] == "op":
         return mkxmlop(e,oldnode,id_hint)
@@ -1204,8 +1223,13 @@ class CibProperty(CibObject):
         return headnode
     def matchcli(self,cli_list):
         head = cli_list[0]
-        return self.obj_type == head[0] \
-            and self.obj_id == find_value(head[1],"$id")
+        if self.obj_type != head[0]:
+            return False
+        # if no id specified return True
+        # (match the first of a kind)
+        if not find_value(head[1],"$id"):
+            return True
+        return self.obj_id == find_value(head[1],"$id")
     def check_sanity(self):
         '''
         Match properties with PE metadata.
@@ -2061,8 +2085,9 @@ class CibFactory(Singleton):
     def test_element(self,obj,node):
         if not node.getAttribute("id"):
             return False
-        if not self.verify_element(node):
-            return False
+        if not obj.xml_obj_type in vars.defaults_tags:
+            if not self.verify_element(node):
+                return False
         if user_prefs.is_check_always() \
                 and obj.check_sanity() > 1:
             return False
diff -r f059ec7ced7a -r b230ffa2ecdc shell/modules/cibstatus.py
--- a/shell/modules/cibstatus.py	Mon May 17 17:57:40 2010 +0200
+++ b/shell/modules/cibstatus.py	Mon Jul 12 18:48:04 2010 +0200
@@ -217,10 +217,12 @@ class CibStatus(Singleton):
             show_dot_graph(dotfile)
             vars.tmpfiles.append(dotfile)
         return rc == 0
-    def run(self, nograph, scores, utilization, verbosity):
+    # actions is ignored
+    def run(self, nograph, scores, utilization, actions, verbosity):
         return self._crm_simulate(self.cmd_run, \
             nograph, scores, utilization, verbosity)
-    def simulate(self, nograph, scores, utilization, verbosity):
+    # actions is ignored
+    def simulate(self, nograph, scores, utilization, actions, verbosity):
         return self._crm_simulate(self.cmd_simulate, \
             nograph, scores, utilization, verbosity)
     def get_status(self):
diff -r f059ec7ced7a -r b230ffa2ecdc shell/modules/main.py
--- a/shell/modules/main.py	Mon May 17 17:57:40 2010 +0200
+++ b/shell/modules/main.py	Mon Jul 12 18:48:04 2010 +0200
@@ -147,7 +147,7 @@ def parse_line(lvl,s):
     return True
 
 def prereqs():
-    proglist = "which cibadmin crm_resource crm_attribute crm_mon crm_standby crm_failcount"
+    proglist = "which cibadmin crm_resource crm_attribute crm_mon"
     for prog in proglist.split():
         if not is_program(prog):
             print >> sys.stderr, "%s not available, check your installation"%prog
@@ -167,8 +167,11 @@ def setup_readline():
     try: readline.read_history_file(vars.hist_file)
     except: pass
 
-def usage():
-    print >> sys.stderr, """
+def usage(rc):
+    f = sys.stderr
+    if rc == 0:
+        f = sys.stdout
+    print >> f, """
 usage:
     crm [-D display_type] [-f file] [-hF] [args]
 
@@ -194,7 +197,7 @@ Examples:
     # crm status 
 
     """
-    sys.exit(1)
+    sys.exit(rc)
 
 user_prefs = UserPrefs.getInstance()
 options = Options.getInstance()
@@ -219,11 +222,17 @@ def run():
 
     try:
         opts, args = getopt.getopt(sys.argv[1:], \
-            'hdf:FRD:', ("help","debug","file=",\
+            'hdf:FRD:', ("version","help","debug","file=",\
             "force","regression-tests","display="))
         for o,p in opts:
             if o in ("-h","--help"):
-                usage()
+                usage(0)
+            elif o in ("--version"):
+                print >> sys.stdout,("""%s
+Written by Dejan Muhamedagic
+""" % vars.crm_version)
+                sys.exit(0)
+
             elif o == "-d":
                 user_prefs.set_debug()
             elif o == "-R":
@@ -238,11 +247,14 @@ def run():
                 inp_file = p
     except getopt.GetoptError,msg:
         print msg
-        usage()
+        usage(1)
 
+    # this special case is silly, but we have to keep it to
+    # preserve the backward compatibility
     if len(args) == 1 and args[0].startswith("conf"):
         parse_line(levels,["configure"])
-        options.interactive = True
+        if not inp_file and sys.stdin.isatty():
+            options.interactive = True
     elif len(args) > 0:
         err_buf.reset_lineno()
         options.interactive = False
@@ -263,20 +275,27 @@ def run():
             f = open(inp_file)
         except IOError, msg:
             common_err(msg)
-            usage()
+            usage(2)
         sys.stdin = f
 
     if options.interactive and not options.batch:
         setup_readline()
 
+    rc = 0
     while True:
         if options.interactive and not options.batch:
             vars.prompt = "crm(%s)%s# " % (cib_prompt(),levels.getprompt())
         inp = multi_input(vars.prompt)
         if inp == None:
-            cmd_exit("eof")
-        try: parse_line(levels,shlex.split(inp))
+            if options.interactive:
+                cmd_exit("eof")
+            else:
+                cmd_exit("eof", rc)
+        try:
+            if not parse_line(levels,shlex.split(inp)):
+                rc = 1
         except ValueError, msg:
+            rc = 1
             common_err(msg)
 
 # vim:ts=4:sw=4:et:
diff -r f059ec7ced7a -r b230ffa2ecdc shell/modules/ra.py.in
--- a/shell/modules/ra.py.in	Mon May 17 17:57:40 2010 +0200
+++ b/shell/modules/ra.py.in	Mon Jul 12 18:48:04 2010 +0200
@@ -64,7 +64,7 @@ class RaLrmd(object):
         'List of providers for a class:type.'
         return self.lrmadmin("-P %s %s" % (ra_class,ra_type),True)
     def classes(self):
-        'List of providers for a class:type.'
+        'List of classes.'
         return self.lrmadmin("-C")
     def types(self, ra_class = "ocf", ra_provider = ""):
         'List of types for a class.'
@@ -254,6 +254,10 @@ class RAInfo(object):
         common_err("%s: %s" % (self.ra_string(), s))
     def warn(self, s):
         common_warn("%s: %s" % (self.ra_string(), s))
+    def filter_crmd_attributes(self):
+        for n in self.ra_node.getElementsByTagName("parameter"):
+            if not n.getAttribute("name") in vars.crmd_user_attributes:
+                n.parentNode.removeChild(n)
     def add_extra_stonith_params(self):
         if not vars.stonithd_metadata:
             vars.stonithd_metadata = RAInfo("stonithd","metadata")
@@ -287,6 +291,8 @@ class RAInfo(object):
             return None
         if self.ra_class == "stonith":
             self.add_extra_stonith_params()
+        if self.ra_class == "crmd":
+            self.filter_crmd_attributes()
         return self.ra_node
     def param_type_default(self,n):
         try:
@@ -447,7 +453,7 @@ class RAInfo(object):
         id = "ra_meta-%s" % self.ra_string()
         if wcache.is_cached(id):
             return wcache.retrieve(id)
-        if self.ra_class in ("crmd","pengine","stonithd"):
+        if self.ra_class in vars.meta_progs:
             l = prog_meta(self.ra_class)
         else:
             l = ra_if().meta(self.ra_class,self.ra_type,self.ra_provider)
diff -r f059ec7ced7a -r b230ffa2ecdc shell/modules/ui.py.in
--- a/shell/modules/ui.py.in	Mon May 17 17:57:40 2010 +0200
+++ b/shell/modules/ui.py.in	Mon Jul 12 18:48:04 2010 +0200
@@ -38,7 +38,7 @@ from xmlutil import *
 def cmd_end(cmd,dir = ".."):
     "Go up one level."
     levels.droplevel()
-def cmd_exit(cmd):
+def cmd_exit(cmd,rc = 0):
     "Exit the crm program"
     cmd_end(cmd)
     if options.interactive and not options.batch:
@@ -49,7 +49,7 @@ def cmd_exit(cmd):
         pass
     for f in vars.tmpfiles:
         os.unlink(f)
-    sys.exit()
+    sys.exit(rc)
 
 class UserInterface(object):
     '''
@@ -752,9 +752,9 @@ class RscMgmt(UserInterface):
         'show': "crm_resource --meta -r '%s' -g '%s'",
     }
     rsc_failcount = {
-        'set': "crm_failcount -r '%s' -N '%s' -v '%s'",
-        'delete': "crm_failcount -r '%s' -N '%s' -D",
-        'show': "crm_failcount -r '%s' -N '%s' -G",
+        'set': "crm_attribute -t status -n 'fail-count-%s' -N '%s' -v '%s' -d 0",
+        'delete': "crm_attribute -t status -n 'fail-count-%s' -N '%s' -D -d 0",
+        'show': "crm_attribute -t status -n 'fail-count-%s' -N '%s' -G -d 0",
     }
     rsc_utilization =  {
         'set': "crm_resource -z -r '%s' -p '%s' -v '%s'",
@@ -776,7 +776,7 @@ class RscMgmt(UserInterface):
         self.cmd_table["demote"] = (self.demote,(1,1),0,(rsc_list,))
         self.cmd_table["manage"] = (self.manage,(1,1),0,(rsc_list,))
         self.cmd_table["unmanage"] = (self.unmanage,(1,1),0,(rsc_list,))
-        self.cmd_table["migrate"] = (self.migrate,(1,3),0,(rsc_list,nodes_list))
+        self.cmd_table["migrate"] = (self.migrate,(1,4),0,(rsc_list,nodes_list))
         self.cmd_table["unmigrate"] = (self.unmigrate,(1,1),0,(rsc_list,))
         self.cmd_table["param"] = (self.param,(3,4),1,(rsc_list,attr_cmds))
         self.cmd_table["meta"] = (self.meta,(3,4),1,(rsc_list,attr_cmds))
@@ -843,27 +843,47 @@ class RscMgmt(UserInterface):
             return False
         return set_deep_meta_attr("is-managed","false",rsc)
     def migrate(self,cmd,*args):
-        """usage: migrate <rsc> [<node>] [<lifetime>]"""
+        """usage: migrate <rsc> [<node>] [<lifetime>] [force]"""
         rsc = args[0]
         if not is_name_sane(rsc):
             return False
         node = None
         lifetime = None
+        force = False
         if len(args) == 2:
             if not args[1] in listnodes():
-                lifetime = args[1]
+                if args[1] == "force":
+                    force = True
+                else:
+                    lifetime = args[1]
             else:
                 node = args[1]
         elif len(args) == 3:
+            if not args[1] in listnodes():
+                lifetime = args[1]
+                force = True
+            else:
+                node = args[1]
+                if args[2] == "force":
+                    force = True
+                else:
+                    lifetime = args[2]
+        elif len(args) == 4:
             if not is_name_sane(args[1]):
                 return False
             node = args[1]
             lifetime = args[2]
+            if not args[3] == "force":
+                syntax_err((cmd,force))
+                return False
+            force = True
         opts = ''
         if node:
             opts = "--node='%s'" % node
         if lifetime:
             opts = "%s --lifetime='%s'" % (opts,lifetime)
+        if force or user_prefs.get_force():
+            opts = "%s --force" % opts
         return ext_cmd(self.rsc_migrate % (rsc,opts)) == 0
     def unmigrate(self,cmd,rsc):
         "usage: unmigrate <rsc>"
@@ -948,7 +968,7 @@ class NodeMgmt(UserInterface):
     '''
     Nodes management class
     '''
-    node_standby = "crm_standby -N '%s' -v '%s' %s"
+    node_standby = "crm_attribute -N '%s' -n standby -v '%s' %s"
     node_delete = "cibadmin -D -o nodes -X '<node uname=\"%s\"/>'"
     node_delete_status = "cibadmin -D -o status -X '<node_state uname=\"%s\"/>'"
     hb_delnode = "@datadir@/heartbeat/hb_delnode '%s'"
@@ -1050,6 +1070,8 @@ class NodeMgmt(UserInterface):
         opts = ''
         if lifetime:
             opts = "--lifetime='%s'" % lifetime
+        else:
+            opts = "--lifetime='forever'"
         return ext_cmd(self.node_standby%(node,"on",opts)) == 0
     def online(self,cmd,node = None):
         'usage: online [<node>]'
@@ -1057,7 +1079,7 @@ class NodeMgmt(UserInterface):
             node = vars.this_node
         if not is_name_sane(node):
             return False
-        return ext_cmd(self.node_standby%(node,"off",'')) == 0
+        return ext_cmd(self.node_standby%(node,"off","--lifetime='forever'")) == 0
     def fence(self,cmd,node):
         'usage: fence <node>'
         if not node:
@@ -1129,7 +1151,7 @@ class RA(UserInterface):
         self.help_table = help_sys.load_level("ra")
         self.cmd_table["classes"] = (self.classes,(0,0),0)
         self.cmd_table["list"] = (self.list,(1,2),1)
-        self.cmd_table["providers"] = (self.providers,(1,1),1)
+        self.cmd_table["providers"] = (self.providers,(1,2),1)
         self.cmd_table["meta"] = (self.meta,(1,3),1)
         self.cmd_aliases.update({
             "meta": ("info",),
@@ -1142,9 +1164,9 @@ class RA(UserInterface):
                 print "%s / %s" % (c,' '.join(ra_providers_all(c)))
             else:
                 print "%s" % c
-    def providers(self,cmd,ra_type):
-        "usage: providers <ra>"
-        print ' '.join(ra_providers(ra_type))
+    def providers(self,cmd,ra_type,ra_class = "ocf"):
+        "usage: providers <ra> [<class>]"
+        print ' '.join(ra_providers(ra_type,ra_class))
     def list(self,cmd,c,p = None):
         "usage: list <class> [<provider>]"
         if not c in ra_classes():
@@ -1168,7 +1190,11 @@ class RA(UserInterface):
             else:
                 ra_provider = args[2]
         else:
-            ra_class,ra_provider,ra_type = disambiguate_ra_type(args[0])
+            if args[0] in vars.meta_progs:
+                ra_class = args[0]
+                ra_provider = ra_type = None
+            else:
+                ra_class,ra_provider,ra_type = disambiguate_ra_type(args[0])
         ra = RAInfo(ra_class,ra_type,ra_provider)
         if not ra.mk_ra_node():
             return False
@@ -1182,6 +1208,7 @@ def ptestlike(simfun,def_verb,cmd,*args)
     nograph = False
     scores = False
     utilization = False
+    actions = False
     for p in args:
         if p == "nograph":
             nograph = True
@@ -1189,12 +1216,14 @@ def ptestlike(simfun,def_verb,cmd,*args)
             scores = True
         elif p == "utilization":
             utilization = True
+        elif p == "actions":
+            actions = True
         elif re.match("^vv*$", p):
             verbosity = p
         else:
             bad_usage(cmd,' '.join(args))
             return False
-    return simfun(nograph, scores, utilization, verbosity)
+    return simfun(nograph, scores, utilization, actions, verbosity)
 
 class StatusMgmt(UserInterface):
     '''
@@ -1429,7 +1458,7 @@ class CibConfig(UserInterface):
                 return
         cib_factory.refresh()
     def ptest(self,cmd,*args):
-        "usage: ptest [nograph] [v...] [scores] [utilization]"
+        "usage: ptest [nograph] [v...] [scores] [utilization] [actions]"
         if not cib_factory.is_cib_sane():
             return False
         set_obj = mkset_obj("xml")
diff -r f059ec7ced7a -r b230ffa2ecdc shell/modules/vars.py.in
--- a/shell/modules/vars.py.in	Mon May 17 17:57:40 2010 +0200
+++ b/shell/modules/vars.py.in	Mon Jul 12 18:48:04 2010 +0200
@@ -126,10 +126,13 @@ class Vars(Singleton):
     pe_dir = "@PE_STATE_DIR@"
     crm_conf_dir = "@CRM_CONFIG_DIR@"
     crm_daemon_dir = "@CRM_DAEMON_DIR@"
+    crm_version = "@VERSION@ (Build @BUILD_VERSION@)"
 
     ra_if = None # class interface to RA
     stonithd_metadata = None # stonithd meta data
     pe_metadata = None # PE meta data
     crmd_metadata = None # crmd meta data
+    meta_progs = ("crmd","pengine","stonithd")
+    crmd_user_attributes = ("dc-deadtime","cluster-recheck-interval","expected-quorum-votes")
 
 # vim:ts=4:sw=4:et:
diff -r f059ec7ced7a -r b230ffa2ecdc shell/regression/testcases/Makefile.am
--- a/shell/regression/testcases/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/shell/regression/testcases/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -19,7 +19,7 @@
 MAINTAINERCLEANFILES = Makefile.in
 
 testcasesdir		= 	$(datadir)/$(PACKAGE)/tests/shell/testcases
-testcases_SCRIPTS	=	confbasic-xml.filter xmlonly.sh
+testcases_SCRIPTS	=	confbasic-xml.filter ra.filter xmlonly.sh
 testcases_DATA		=	BSC basicset common.excl \
 	confbasic confbasic-xml delete file node ra resource shadow \
 	confbasic-xml.exp confbasic.exp delete.exp file.exp \
diff -r f059ec7ced7a -r b230ffa2ecdc shell/regression/testcases/node.exp
--- a/shell/regression/testcases/node.exp	Mon May 17 17:57:40 2010 +0200
+++ b/shell/regression/testcases/node.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -4,7 +4,7 @@ node1: normal
 node1: normal
 .SETENV showobj=node1
 .TRY node standby node1
-.EXT crm_standby -N 'node1' -v 'on' 
+.EXT crm_attribute -N 'node1' -n standby -v 'on' --lifetime='forever'
 .INP: configure
 .INP: _regtest on
 .INP: show xml node1
@@ -27,7 +27,7 @@ node1: normal
 </cib>
 
 .TRY node online node1
-.EXT crm_standby -N 'node1' -v 'off' 
+.EXT crm_attribute -N 'node1' -n standby -v 'off' --lifetime='forever'
 .INP: configure
 .INP: _regtest on
 .INP: show xml node1
diff -r f059ec7ced7a -r b230ffa2ecdc shell/regression/testcases/ra.exp
--- a/shell/regression/testcases/ra.exp	Mon May 17 17:57:40 2010 +0200
+++ b/shell/regression/testcases/ra.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -53,11 +53,23 @@ livedangerously (enum): Live Dangerously
     setting this parameter to yes makes it an even worse idea.
     Viva la Vida Loca!
 
-stonith-timeout (time, [60s]): 
-    How long to wait for the STONITH action to complete. Overrides the stonith-timeout cluster property
+stonith-timeout (time, [60s]): How long to wait for the STONITH action to complete.
+    Overrides the stonith-timeout cluster property
 
-priority (integer, [0]): 
-    The priority of the stonith resource. The lower the number, the higher the priority.
+priority (integer, [0]): The priority of the stonith resource. The lower the number, the higher the priority.
+pcmk_arg_map (string): A mapping of host attributes to device arguments.
+    Eg. uname:domain would tell the cluster to pass the machines name as the domain argument to the device.  Useful for devices that have non-standard interfaces
+
+pcmk_host_map (string): A mapping of host names to ports numbers for devices that do not support names.
+    Eg. node1:1,node2:3 would tell the cluster to use port 1 for node1 and port 3 for node2
+
+pcmk_host_list (string): A list of machines controlled by this device (Optional unless pcmk_host_check=static-list).
+pcmk_host_check (string, [dynamic-list]): How to determin which machines are controlled by the device.
+    Allowed values: dynamic-list (query the device), static-list (check the pcmk_host_list attribute), none (assume every device can fence every machine)
+
+pcmk_list_cmd (string, [list]): Which device operation to use for listing machines controlled by the device.
+pcmk_status_cmd (string, [status]): Which device operation to use for testing the state of a machine controlled by the device.
+pcmk_monitor_cmd (string, [monitor]): Which device operation to use for monitoring the health of the device.
 
 Operations' defaults (advisory minimum):
 
diff -r f059ec7ced7a -r b230ffa2ecdc shell/regression/testcases/ra.filter
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/shell/regression/testcases/ra.filter	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,15 @@
+#!/usr/bin/awk -f
+# reduce the providers list to heartbeat and pacemaker
+# (prevents other providers creeping in)
+function reduce(a) {
+	a["heartbeat"]=1; a["pacemaker"]=1;
+	s="";
+	for( i=1; i<=NF; i++ )
+		if( $i in a )
+			s=s" "$i;
+	return substr(s,2);
+}
+n==1 { n=0; print reduce(a); next; }
+/providers IPaddr/ { n=1; }
+/providers Dummy/ { n=1; }
+{ print }
diff -r f059ec7ced7a -r b230ffa2ecdc shell/regression/testcases/resource.exp
--- a/shell/regression/testcases/resource.exp	Mon May 17 17:57:40 2010 +0200
+++ b/shell/regression/testcases/resource.exp	Mon Jul 12 18:48:04 2010 +0200
@@ -289,7 +289,7 @@ Deleted p0 option: id=p0-meta_attributes
 </cib>
 
 .TRY resource failcount p0 set node1 5
-.EXT crm_failcount -r 'p0' -N 'node1' -v '5'
+.EXT crm_attribute -t status -n 'fail-count-p0' -N 'node1' -v '5' -d 0
 .INP: configure
 .INP: _regtest on
 .INP: show xml p0
@@ -308,7 +308,7 @@ Deleted p0 option: id=p0-meta_attributes
 </cib>
 
 .TRY resource failcount p0 show node1
-.EXT crm_failcount -r 'p0' -N 'node1' -G
+.EXT crm_attribute -t status -n 'fail-count-p0' -N 'node1' -G -d 0
 scope=status  name=fail-count-p0 value=0
 .INP: configure
 .INP: _regtest on
@@ -328,7 +328,7 @@ scope=status  name=fail-count-p0 value=0
 </cib>
 
 .TRY resource failcount p0 delete node1
-.EXT crm_failcount -r 'p0' -N 'node1' -D
+.EXT crm_attribute -t status -n 'fail-count-p0' -N 'node1' -D -d 0
 .INP: configure
 .INP: _regtest on
 .INP: show xml p0
@@ -348,6 +348,7 @@ scope=status  name=fail-count-p0 value=0
 
 .TRY resource cleanup p0 node1
 .EXT crm_resource -C -r 'p0' -H 'node1'
+Error performing operation: connection failed
 .INP: configure
 .INP: _regtest on
 .INP: show xml p0
@@ -367,6 +368,7 @@ scope=status  name=fail-count-p0 value=0
 
 .TRY resource cleanup p0
 .EXT crm_resource -C -r 'p0' -H 'node1'
+Error performing operation: connection failed
 .INP: configure
 .INP: _regtest on
 .INP: show xml p0
diff -r f059ec7ced7a -r b230ffa2ecdc shell/templates/clvm
--- a/shell/templates/clvm	Mon May 17 17:57:40 2010 +0200
+++ b/shell/templates/clvm	Mon Jul 12 18:48:04 2010 +0200
@@ -12,9 +12,10 @@
 
 %required
 
-# Name the volume group
-# (for example: vg-1)
-# NB: The clone is going to be named c-<id> (e.g. c-vg-1)
+# Name the volume group (for example: vg-1)
+# The LVM resource will be in a cloned group with the rest
+# of the prerequisite resources. The clone is going to be named c-<id>
+# (e.g. c-vg-1)
 
 %% id 
 
@@ -24,25 +25,27 @@
 
 %generate
 
+primitive %_:id ocf:heartbeat:LVM
+	params volgrpname="%_:volgrpname"
+	op start timeout=60s
+	op stop timeout=60s
+	op monitor interval=30s timeout=60s
+
 primitive dlm ocf:pacemaker:controld
+	op start timeout=90s
+	op stop timeout=100s
 
 primitive clvm ocf:lvm2:clvmd
 	params daemon_timeout="30"
+	op start timeout=90s
+	op stop timeout=100s
 
 primitive cmirror ocf:lvm2:cmirrord
 	params daemon_timeout="30"
+	op start timeout=90s
+	op stop timeout=100s
 
-group lvm2stage dlm clvm cmirror
+group g-%_:id dlm clvm cmirror %_:id
 
-clone c-lvm2stage lvm2stage
+clone c-%_:id g-%_:id
 	meta interleave="true" ordered="true"
-
-primitive %_:id ocf:heartbeat:LVM
-	params volgrpname="%_:volgrpname"
-
-clone c-%_:id %_:id
-	meta interleave="true" ordered="true"
-
-colocation colo-%_:id-lvm2stage inf: c-%_:id c-lvm2stage
-
-order order-%_:id-lvm2stage inf: c-lvm2stage c-%_:id
diff -r f059ec7ced7a -r b230ffa2ecdc shell/templates/ocfs2
--- a/shell/templates/ocfs2	Mon May 17 17:57:40 2010 +0200
+++ b/shell/templates/ocfs2	Mon Jul 12 18:48:04 2010 +0200
@@ -11,9 +11,10 @@
 
 %required
 
-# Name the ocfs2 filesystem
-# (for example: bigfs)
-# NB: The clone is going to be named c-<id> (e.g. c-bigfs)
+# Name the ocfs2 filesystem (for example: bigfs)
+# The filesystem resource will be in a cloned group with the rest
+# of the prerequisite resources. The clone is going to be named c-<id>
+# (e.g. c-bigfs)
 
 %% id 
 
@@ -41,24 +42,27 @@ primitive %_:id ocf:heartbeat:Filesystem
 		fstype="ocfs2"
 		device="%_:device"
 		opt options="%_:options"
+	op start timeout=60s
+	op stop timeout=60s
 
-monitor %_:id 20:40
-
-clone c-%_:id %_:id
-	meta interleave="true" ordered="true"
+monitor %_:id 30s:60s
 
 primitive dlm ocf:pacemaker:controld
+	op start timeout=90s
+	op stop timeout=100s
 
 primitive clvm ocf:lvm2:clvmd
+	op start timeout=90s
+	op stop timeout=100s
 
 primitive cmirror ocf:lvm2:cmirrord
+	op start timeout=90s
+	op stop timeout=100s
 
 primitive o2cb ocf:ocfs2:o2cb
+	op start timeout=90s
+	op stop timeout=100s
 
-group o2stage dlm clvm o2cb cmirror
+group g-%_:id dlm clvm o2cb cmirror %_:id
 
-clone c-o2stage o2stage meta interleave="true"
-
-colocation colo-%_:id-o2stage inf: c-%_:id c-o2stage
-
-order order-%_:id-o2stage 0: c-o2stage c-%_:id
+clone c-%_:id g-%_:id meta interleave="true"
diff -r f059ec7ced7a -r b230ffa2ecdc tools/Makefile.am
--- a/tools/Makefile.am	Mon May 17 17:57:40 2010 +0200
+++ b/tools/Makefile.am	Mon Jul 12 18:48:04 2010 +0200
@@ -36,7 +36,7 @@ EXTRA_DIST		= $(sbin_SCRIPTS)
 
 halibdir		= $(CRM_DAEMON_DIR)
 halib_SCRIPTS		= hb2openais.sh
-halib_PROGRAMS		= attrd pingd
+halib_PROGRAMS		= attrd
 halib_PYTHON		= crm_primitive.py hb2openais-helper.py
 
 sbin_PROGRAMS		= crm_simulate crmadmin cibadmin crm_node crm_attribute crm_resource crm_verify \
@@ -44,7 +44,7 @@ sbin_PROGRAMS		= crm_simulate crmadmin c
 
 testdir			= $(datadir)/$(PACKAGE)/tests/cli
 test_SCRIPTS		= regression.sh
-test_DATA		= regression.exp
+test_DATA		= regression.exp cli.supp
 
 if BUILD_SERVICELOG
 sbin_PROGRAMS		+= notifyServicelogEvent
@@ -54,7 +54,7 @@ sbin_PROGRAMS		+= ipmiservicelogd
 endif
 
 if BUILD_HELP
-man8_MANS =	$(sbin_PROGRAMS:%=%.8) crm_report.8
+man8_MANS =	$(sbin_PROGRAMS:%=%.8) crm_report.8 crm_failcount.8 crm_master.8 crm_standby.8
 endif
 
 ## SOURCES
@@ -115,8 +115,8 @@ iso8601_LDADD		= $(COMMONLIBS)
 attrd_SOURCES		= attrd.c
 attrd_LDADD		= $(COMMONLIBS) $(top_builddir)/lib/common/libcrmcluster.la
 
-pingd_SOURCES		= pingd.c
-pingd_LDADD		= $(COMMONLIBS)
+#pingd_SOURCES		= pingd.c
+#pingd_LDADD		= $(COMMONLIBS)
 
 attrd_updater_SOURCES	= attrd_updater.c
 attrd_updater_LDADD	= $(COMMONLIBS)
@@ -133,10 +133,10 @@ ipmiservicelogd_CFLAGS	= `pkg-config --c
 ipmiservicelogd_LDFLAGS	= `pkg-config --libs OpenIPMI OpenIPMIposix servicelog-1` $(top_builddir)/lib/common/libcrmcommon.la
 endif
 
-%.8:	%
+%.8:	% crm_attribute
 	echo Creating $@
-	chmod a+x $<
-	help2man --output $@ --no-info --section 8 --name "Part of the Pacemaker cluster resource manager" $(top_builddir)/tools/$<
+	chmod a+x $(top_builddir)/tools/$<
+	PATH=$$PATH:$(top_builddir)/tools help2man --output $@ --no-info --section 8 --name "Part of the Pacemaker cluster resource manager" $(top_builddir)/tools/$<
 
 clean-generic:
 	rm -f *.log *.debug *.xml *~
diff -r f059ec7ced7a -r b230ffa2ecdc tools/attrd.c
--- a/tools/attrd.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/attrd.c	Mon Jul 12 18:48:04 2010 +0200
@@ -28,11 +28,6 @@
 #include <errno.h>
 #include <fcntl.h>
 
-
-
-
-
-
 #include <crm/crm.h>
 #include <crm/cib.h>
 #include <crm/msg_xml.h>
@@ -358,7 +353,7 @@ attrd_ha_callback(HA_Message *msg, void*
 
 #endif
 
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 static gboolean
 attrd_ais_dispatch(AIS_Message *wrapper, char *data, int sender) 
 {
@@ -551,7 +546,7 @@ main(int argc, char ** argv)
 	    void *dispatch = NULL;
 	    void *data = NULL;
 	    
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 	    if(is_openais_cluster()) {
 		destroy = attrd_ais_destroy;
 		dispatch = attrd_ais_dispatch;	
diff -r f059ec7ced7a -r b230ffa2ecdc tools/attrd_updater.c
--- a/tools/attrd_updater.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/attrd_updater.c	Mon Jul 12 18:48:04 2010 +0200
@@ -71,8 +71,8 @@ main(int argc, char ** argv)
     int argerr = 0;
     int flag;
     int BE_QUIET = FALSE;
-	
-    crm_system_name = basename(argv[0]);
+
+    crm_log_init_quiet(NULL, LOG_ERR, FALSE, FALSE, argc, argv);
     crm_set_options("?$Vqn:v:d:s:S:RDQU:l:", "command -n attribute [options]", long_options, "Tool for updating cluster node attributes");
 
     if(argc < 2) {
@@ -123,9 +123,7 @@ main(int argc, char ** argv)
     }
 
     if(BE_QUIET == FALSE) {
-	crm_log_init(basename(argv[0]), LOG_ERR, FALSE, FALSE, argc, argv);
-    } else {
-	crm_log_init(basename(argv[0]), LOG_ERR, FALSE, FALSE, 0, NULL);
+	cl_log_args(argc, argv);
     }
     
     if (optind > argc) {
diff -r f059ec7ced7a -r b230ffa2ecdc tools/ccm_epoche.c
--- a/tools/ccm_epoche.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/ccm_epoche.c	Mon Jul 12 18:48:04 2010 +0200
@@ -36,8 +36,6 @@
 
 int command = 0;
 int ccm_fd = 0;
-int try_hb = 1;
-int try_ais = 1;
 gboolean do_quiet = FALSE;
 
 char *target_uuid = NULL;
@@ -45,10 +43,43 @@ char *target_uname = NULL;
 const char *standby_value = NULL;
 const char *standby_scope = NULL;
 
-void ais_membership_destroy(gpointer user_data);
-gboolean ais_membership_dispatch(AIS_Message *wrapper, char *data, int sender);
 #include <../lib/common/stack.h>
 
+static struct crm_option long_options[] = {
+    /* Top-level Options */
+    {"help",       0, 0, '?', "\tThis text"},
+    {"version",    0, 0, '$', "\tVersion information"  },
+    {"verbose",    0, 0, 'V', "\tIncrease debug output"},
+    {"quiet",      0, 0, 'Q', "\tEssential output only"},
+
+    {"-spacer-",   1, 0, '-', "\nStack:"},
+#ifdef SUPPORT_CMAN
+    {"cman",       0, 0, 'c', "\tOnly try connecting to a cman-based cluster"},
+#endif
+#ifdef SUPPORT_COROSYNC
+    {"openais",    0, 0, 'A', "\tOnly try connecting to an OpenAIS-based cluster"},
+#endif
+#ifdef SUPPORT_HEARTBEAT
+    {"heartbeat",  0, 0, 'H', "Only try connecting to a Heartbeat-based cluster"},
+#endif
+    
+    {"-spacer-",      1, 0, '-', "\nCommands:"},
+    {"epoch",	      0, 0, 'e', "\tDisplay the epoch during which this node joined the cluster"},
+    {"quorum",        0, 0, 'q', "\tDisplay a 1 if our partition has quorum, 0 if not"},
+    {"list",          0, 0, 'l', "\tDisplay all known members (past and present) of this cluster (Not available for heartbeat clusters)"},
+    {"partition",     0, 0, 'p', "Display the members of this partition"},
+    {"cluster-id",    0, 0, 'i', "Display this node's cluster id"},
+    {"remove",        1, 0, 'R', "(Advanced, AIS-Only) Remove the (stopped) node with the specified nodeid from the cluster"},
+
+    {"-spacer-", 1, 0, '-', "\nAdditional Options:"},
+    {"force",	 0, 0, 'f'},
+
+    {0, 0, 0, 0}
+};
+
+int local_id = 0;
+
+
 #if SUPPORT_HEARTBEAT
 #  include <ocf/oc_event.h>
 #  include <ocf/oc_membership.h>
@@ -58,13 +89,9 @@ gboolean ais_membership_dispatch(AIS_Mes
 
 oc_ev_t *ccm_token = NULL;
 void oc_ev_special(const oc_ev_t *, oc_ev_class_t , int );
-void ccm_age_callback(
-    oc_ed_t event, void *cookie, size_t size, const void *data);
-gboolean ccm_age_connect(int *ccm_fd);
 
-static int read_local_hb_uuid(void) 
+static gboolean read_local_hb_uuid(void) 
 {
-    int rc = 0;
     cl_uuid_t uuid;
     char *buffer = NULL;
     long start = 0, read_len = 0;
@@ -72,8 +99,8 @@ static int read_local_hb_uuid(void)
     FILE *input = fopen(UUID_FILE, "r");
 	
     if(input == NULL) {
-	cl_perror("Could not open UUID file %s\n", UUID_FILE);
-	return 1;
+	crm_info("Could not open UUID file %s\n", UUID_FILE);
+	return FALSE;
     }
 	
     /* see how big the file is */
@@ -87,8 +114,7 @@ static int read_local_hb_uuid(void)
     fseek(input, 0L, start);
     if(start != ftell(input)) {
 	fprintf(stderr, "fseek not behaving: %ld vs. %ld\n", start, ftell(input));
-	rc = 2;
-	goto bail;
+	exit(2);
     }
 
     buffer = malloc(50);
@@ -96,234 +122,25 @@ static int read_local_hb_uuid(void)
     if(read_len != UUID_LEN) {
 	fprintf(stderr, "Expected and read bytes differ: %d vs. %ld\n",
 		UUID_LEN, read_len);
-	rc = 3;
-	goto bail;
+	exit(3);
 		
     } else if(buffer != NULL) {
 	cl_uuid_unparse(&uuid, buffer);
 	fprintf(stdout, "%s\n", buffer);
-
+	return TRUE;
+	
     } else {
 	fprintf(stderr, "No buffer to unparse\n");
-	rc = 4;
+	exit(4);
     }
 
-  bail:	
     free(buffer);
     fclose(input);
 
-    return rc;
-}
-#endif
-
-static struct crm_option long_options[] = {
-    /* Top-level Options */
-    {"help",       0, 0, '?', "\tThis text"},
-    {"version",    0, 0, '$', "\tVersion information"  },
-    {"verbose",    0, 0, 'V', "\tIncrease debug output"},
-    {"quiet",      0, 0, 'Q', "\tEssential output only"},
-
-    {"-spacer-",   1, 0, '-', "\nStack:", SUPPORT_HEARTBEAT},
-    {"openais",    0, 0, 'A', "\tOnly try connecting to an OpenAIS-based cluster", SUPPORT_HEARTBEAT},
-    {"heartbeat",  0, 0, 'H', "Only try connecting to a Heartbeat-based cluster", SUPPORT_HEARTBEAT},
-    
-    {"-spacer-",      1, 0, '-', "\nCommands:"},
-    {"epoch",	      0, 0, 'e', "\tDisplay the epoch during which this node joined the cluster"},
-    {"quorum",        0, 0, 'q', "\tDisplay a 1 if our partition has quorum, 0 if not"},
-    {"list",          0, 0, 'l', "(AIS-Only) Display all known members (past and present) of this cluster"},
-    {"partition",     0, 0, 'p', "Display the members of this partition"},
-    {"cluster-id",    0, 0, 'i', "Display this node's cluster id"},
-    {"remove",        1, 0, 'R', "(Advanced, AIS-Only) Remove the (stopped) node with the specified nodeid from the cluster"},
-
-    {"-spacer-", 1, 0, '-', "\nAdditional Options:"},
-    {"force",	 0, 0, 'f'},
-
-    {0, 0, 0, 0}
-};
-
-int local_id = 0;
-
-int
-main(int argc, char ** argv)
-{
-    int flag = 0;
-    int argerr = 0;
-    gboolean force_flag = FALSE;
-    gboolean dangerous_cmd = FALSE;
-
-    int option_index = 0;
-
-    crm_peer_init();
-    crm_log_init(basename(argv[0]), LOG_WARNING, FALSE, FALSE, argc, argv);
-    crm_set_options("?V$qepHR:ifl", "command [options]", long_options,
-		    "Tool for displaying low-level node information");
-	
-    while (flag >= 0) {
-	flag = crm_get_option(argc, argv, &option_index);
-	switch(flag) {
-	    case -1:
-		break;
-	    case 'V':
-		cl_log_enable_stderr(TRUE);
-		alter_debug(DEBUG_INC);
-		break;
-	    case '$':
-	    case '?':
-		crm_help(flag, LSB_EXIT_OK);
-		break;
-	    case 'Q':
-		do_quiet = TRUE;
-		break;	
-	    case 'H':
-		try_ais = 0;
-		break;
-	    case 'A':
-		try_hb = 0;
-		break;
-	    case 'f':
-		force_flag = TRUE;
-		break;
-	    case 'R':
-		dangerous_cmd = TRUE;
-		command = flag;
-		target_uname = optarg;
-		break;
-	    case 'p':
-	    case 'e':
-	    case 'q':
-	    case 'i':
-	    case 'l':
-		command = flag;
-	    break;
-	    default:
-		++argerr;
-		break;
-	}
-    }
-    
-    if (optind > argc) {
-	++argerr;
-    }
-    
-    if (argerr) {
-	crm_help('?', LSB_EXIT_GENERIC);
-    }
-
-    if(dangerous_cmd && force_flag == FALSE) {
-	fprintf(stderr, "The supplied command is considered dangerous."
-		"  To prevent accidental destruction of the cluster,"
-		" the --force flag is required in order to proceed.\n");
-	fflush(stderr);
-	exit(LSB_EXIT_GENERIC);
-    }
-
-#if SUPPORT_AIS
-    if(try_ais && init_ais_connection(
-	   ais_membership_dispatch, ais_membership_destroy, NULL, NULL, &local_id)) {
-
-	GMainLoop*  amainloop = NULL;
-	switch(command) {
-	    case 'R':
-		send_ais_text(crm_class_rmpeer, target_uname, TRUE, NULL, crm_msg_ais);
-		return 0;
-		    
-	    case 'e':
-		/* Age makes no sense (yet) in an AIS cluster */
-		fprintf(stdout, "1\n");
-		return 0;
-			
-	    case 'q':
-		send_ais_text(crm_class_quorum, NULL, TRUE, NULL, crm_msg_ais);
-		break;
-
-	    case 'l':
-	    case 'p':
-		crm_info("Requesting the list of configured nodes");
-		send_ais_text(crm_class_members, __FUNCTION__, TRUE, NULL, crm_msg_ais);
-		break;
-
-	    case 'i':
-		printf("%d\n", local_id);
-		return 0;
-
-	    default:
-		fprintf(stderr, "Unknown option '%c'\n", command);
-		crm_help('?', LSB_EXIT_GENERIC);
-	}
-	amainloop = g_main_new(FALSE);
-	g_main_run(amainloop);
-    }
-#endif
-#if SUPPORT_HEARTBEAT
-    if(try_hb && command == 'i') {
-	return read_local_hb_uuid();
-
-    } else if(try_hb && ccm_age_connect(&ccm_fd)) {
-	int rc = 0;
-	fd_set rset;	
-	oc_ev_t *ccm_token = NULL;
-	while (1) {
-
-	    sleep(1);
-	    FD_ZERO(&rset);
-	    FD_SET(ccm_fd, &rset);
-
-	    errno = 0;
-	    rc = select(ccm_fd + 1, &rset, NULL,NULL,NULL);
-
-	    if(rc > 0 && oc_ev_handle_event(ccm_token) != 0) {
-		crm_err("oc_ev_handle_event failed");
-		return 1;
-			    
-	    } else if(rc < 0 && errno != EINTR) {
-		crm_perror(LOG_ERR, "select failed");
-		return 1;
-	    }
-	}
-    }
-#endif
-    return(1);    
+    return FALSE;
 }
 
-#if SUPPORT_HEARTBEAT
-gboolean
-ccm_age_connect(int *ccm_fd) 
-{
-    gboolean did_fail = FALSE;
-    int ret = 0;
-	
-    crm_debug("Registering with CCM");
-    ret = oc_ev_register(&ccm_token);
-    if (ret != 0) {
-	crm_warn("CCM registration failed");
-	did_fail = TRUE;
-    }
-	
-    if(did_fail == FALSE) {
-	crm_debug("Setting up CCM callbacks");
-	ret = oc_ev_set_callback(ccm_token, OC_EV_MEMB_CLASS,
-				 ccm_age_callback, NULL);
-	if (ret != 0) {
-	    crm_warn("CCM callback not set");
-	    did_fail = TRUE;
-	}
-    }
-    if(did_fail == FALSE) {
-	oc_ev_special(ccm_token, OC_EV_MEMB_CLASS, 0/*don't care*/);
-		
-	crm_debug("Activating CCM token");
-	ret = oc_ev_activate(ccm_token, ccm_fd);
-	if (ret != 0){
-	    crm_warn("CCM Activation failed");
-	    did_fail = TRUE;
-	}
-    }
-	
-    return !did_fail;
-}
-
-
-void 
+static void 
 ccm_age_callback(oc_ed_t event, void *cookie, size_t size, const void *data)
 {
     int lpc;
@@ -372,17 +189,164 @@ ccm_age_callback(oc_ed_t event, void *co
     fflush(stdout);
     exit(0);
 }
+
+static gboolean
+ccm_age_connect(int *ccm_fd) 
+{
+    gboolean did_fail = FALSE;
+    int ret = 0;
+	
+    crm_debug("Registering with CCM");
+    ret = oc_ev_register(&ccm_token);
+    if (ret != 0) {
+	crm_info("CCM registration failed: %d", ret);
+	did_fail = TRUE;
+    }
+	
+    if(did_fail == FALSE) {
+	crm_debug("Setting up CCM callbacks");
+	ret = oc_ev_set_callback(ccm_token, OC_EV_MEMB_CLASS,
+				 ccm_age_callback, NULL);
+	if (ret != 0) {
+	    crm_warn("CCM callback not set: %d", ret);
+	    did_fail = TRUE;
+	}
+    }
+    if(did_fail == FALSE) {
+	oc_ev_special(ccm_token, OC_EV_MEMB_CLASS, 0/*don't care*/);
+		
+	crm_debug("Activating CCM token");
+	ret = oc_ev_activate(ccm_token, ccm_fd);
+	if (ret != 0){
+	    crm_warn("CCM Activation failed: %d", ret);
+	    did_fail = TRUE;
+	}
+    }
+	
+    return !did_fail;
+}
+
+static gboolean try_heartbeat(int command)
+{
+    crm_debug("Attempting to process %c command", command);
+    
+    if(command == 'i') {
+	if(read_local_hb_uuid()) {
+	    exit(0);
+	}
+	
+    } else if(ccm_age_connect(&ccm_fd)) {
+	int rc = 0;
+	fd_set rset;	
+	while (1) {
+	    
+	    sleep(1);
+	    FD_ZERO(&rset);
+	    FD_SET(ccm_fd, &rset);
+	    
+	    errno = 0;
+	    rc = select(ccm_fd + 1, &rset, NULL,NULL,NULL);
+	    
+	    if(rc > 0 && oc_ev_handle_event(ccm_token) != 0) {
+		crm_err("oc_ev_handle_event failed");
+		return FALSE;
+		
+	    } else if(rc < 0 && errno != EINTR) {
+		crm_perror(LOG_ERR, "select failed: %d", rc);
+		return FALSE;
+	    }	    
+	}
+    }
+    return FALSE;
+}
 #endif
 
-#if SUPPORT_AIS
-void
+#if SUPPORT_CMAN
+#  include <libcman.h>
+#  define MAX_NODES 256
+static gboolean try_cman(int command)
+{
+
+    int rc = -1, lpc = 0, node_count = 0;
+    cman_node_t node;
+    cman_cluster_t cluster;
+    cman_handle_t cman_handle = NULL;
+    cman_node_t cman_nodes[MAX_NODES];
+
+    memset(&cluster, 0, sizeof(cluster));
+    crm_debug("Attempting to process %c command", command);
+
+    cman_handle = cman_init(NULL);
+    if(cman_handle == NULL || cman_is_active(cman_handle) == FALSE) {
+	crm_info("Couldn't connect to cman");
+	return FALSE;
+    }
+
+    switch(command) {
+	case 'R':
+	    fprintf(stderr, "Node removal not supported for cman based clusters\n");
+	    exit(cib_NOTSUPPORTED);
+	    break;
+	    
+	case 'e':
+	    /* Age makes no sense (yet?) in a cman cluster */
+	    fprintf(stdout, "1\n");
+	    break;
+	    
+	case 'q':
+	    fprintf(stdout, "%d\n", cman_is_quorate(cman_handle));
+	    break;
+	    
+	case 'l':
+	case 'p':
+	    rc = cman_get_nodes(cman_handle, MAX_NODES, &node_count, cman_nodes);
+	    if (rc != 0) {
+		fprintf(stderr, "Couldn't query cman node list: %d %d", rc, errno);
+		goto cman_bail;
+	    }
+	    
+	    for (lpc = 0; lpc < node_count; lpc++) {
+		if(command == 'l') {
+		    printf("%s ", cman_nodes[lpc].cn_name);
+
+		} else if (cman_nodes[lpc].cn_nodeid != 0 && cman_nodes[lpc].cn_member) {
+		    /* Never allow node ID 0 to be considered a member #315711 */
+		    printf("%s ", cman_nodes[lpc].cn_name);
+		}
+	    }
+	    printf("\n");
+	    break;
+	    
+	case 'i':
+	    rc = cman_get_node(cman_handle, CMAN_NODEID_US, &node);
+	    if ( rc != 0) {
+		fprintf(stderr, "Couldn't query cman node id: %d %d", rc, errno);
+		goto cman_bail;
+	    }
+	    fprintf(stdout, "%u\n", node.cn_nodeid);
+	    break;
+	    
+	default:
+	    fprintf(stderr, "Unknown option '%c'\n", command);
+	    crm_help('?', LSB_EXIT_GENERIC);
+    }
+    cman_finish(cman_handle);
+    exit(0);
+
+  cman_bail:
+    cman_finish(cman_handle);
+    exit(LSB_EXIT_GENERIC);
+}
+#endif
+
+#if SUPPORT_COROSYNC
+static void
 ais_membership_destroy(gpointer user_data)
 {
     crm_err("AIS connection terminated");
     ais_fd_sync = -1;
     exit(1);
 }
-#endif
 
 static gint member_sort(gconstpointer a, gconstpointer b) 
 {
@@ -401,7 +365,7 @@ static void crm_add_member(
     }
 }
 
-gboolean
+static gboolean
 ais_membership_dispatch(AIS_Message *wrapper, char *data, int sender) 
 {
     switch(wrapper->header.id) {
@@ -445,3 +409,151 @@ ais_membership_dispatch(AIS_Message *wra
     
     return TRUE;
 }
+
+static gboolean try_corosync(int command)
+{
+    crm_debug("Attempting to process %c command", command);
+
+    if(init_ais_connection_once(
+	   pcmk_cluster_classic_ais,
+	   ais_membership_dispatch, ais_membership_destroy, NULL, NULL, &local_id)) {
+
+	GMainLoop*  amainloop = NULL;
+	switch(command) {
+	    case 'R':
+		send_ais_text(crm_class_rmpeer, target_uname, TRUE, NULL, crm_msg_ais);
+		return 0;
+		    
+	    case 'e':
+		/* Age makes no sense (yet) in an AIS cluster */
+		fprintf(stdout, "1\n");
+		return 0;
+			
+	    case 'q':
+		send_ais_text(crm_class_quorum, NULL, TRUE, NULL, crm_msg_ais);
+		break;
+
+	    case 'l':
+	    case 'p':
+		crm_info("Requesting the list of configured nodes");
+		send_ais_text(crm_class_members, __FUNCTION__, TRUE, NULL, crm_msg_ais);
+		break;
+
+	    case 'i':
+		printf("%d\n", local_id);
+		return 0;
+
+	    default:
+		fprintf(stderr, "Unknown option '%c'\n", command);
+		crm_help('?', LSB_EXIT_GENERIC);
+	}
+	amainloop = g_main_new(FALSE);
+	g_main_run(amainloop);
+    }
+    return FALSE;
+}
+#endif
+
+
+int
+main(int argc, char ** argv)
+{
+    int flag = 0;
+    int argerr = 0;
+    gboolean force_flag = FALSE;
+    gboolean dangerous_cmd = FALSE;
+    unsigned long long try_stack = pcmk_cluster_heartbeat|pcmk_cluster_classic_ais|pcmk_cluster_corosync|pcmk_cluster_cman;
+
+    int option_index = 0;
+
+    
+    crm_peer_init();
+    crm_log_init(NULL, LOG_WARNING, FALSE, FALSE, argc, argv);
+    crm_set_options("?V$qepHAR:iflCc", "command [options]", long_options,
+		    "Tool for displaying low-level node information");
+	
+    while (flag >= 0) {
+	flag = crm_get_option(argc, argv, &option_index);
+	switch(flag) {
+	    case -1:
+		break;
+	    case 'V':
+		cl_log_enable_stderr(TRUE);
+		alter_debug(DEBUG_INC);
+		break;
+	    case '$':
+	    case '?':
+		crm_help(flag, LSB_EXIT_OK);
+		break;
+	    case 'Q':
+		do_quiet = TRUE;
+		break;	
+	    case 'H':
+		try_stack = pcmk_cluster_heartbeat;
+		break;
+	    case 'A':
+		try_stack = pcmk_cluster_classic_ais;
+		break;
+	    case 'C':
+		try_stack = pcmk_cluster_corosync;
+		break;
+	    case 'c':
+		try_stack = pcmk_cluster_cman;
+		break;
+	    case 'f':
+		force_flag = TRUE;
+		break;
+	    case 'R':
+		dangerous_cmd = TRUE;
+		command = flag;
+		target_uname = optarg;
+		break;
+	    case 'p':
+	    case 'e':
+	    case 'q':
+	    case 'i':
+	    case 'l':
+		command = flag;
+	    break;
+	    default:
+		++argerr;
+		break;
+	}
+    }
+    
+    if (optind > argc) {
+	++argerr;
+    }
+    
+    if (argerr) {
+	crm_help('?', LSB_EXIT_GENERIC);
+    }
+
+    if(dangerous_cmd && force_flag == FALSE) {
+	fprintf(stderr, "The supplied command is considered dangerous."
+		"  To prevent accidental destruction of the cluster,"
+		" the --force flag is required in order to proceed.\n");
+	fflush(stderr);
+	exit(LSB_EXIT_GENERIC);
+    }
+
+#if SUPPORT_COROSYNC
+    if(try_stack & pcmk_cluster_classic_ais) {
+	try_corosync(command);
+    }
+#endif
+
+#if SUPPORT_CMAN
+    if(try_stack & pcmk_cluster_cman) {
+	try_cman(command);
+    }
+#endif
+    
+#if SUPPORT_HEARTBEAT
+    if(try_stack & pcmk_cluster_heartbeat) {
+	try_heartbeat(command);
+    }
+#endif
+    
+    return(1);    
+}
diff -r f059ec7ced7a -r b230ffa2ecdc tools/cib_shadow.c
--- a/tools/cib_shadow.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/cib_shadow.c	Mon Jul 12 18:48:04 2010 +0200
@@ -196,6 +196,7 @@ main(int argc, char **argv)
 	    case 'w':
 	    case 'F':
 		command = flag;
+		crm_free(shadow);
 		shadow = crm_strdup(getenv("CIB_shadow"));
 		break;
 	    case 'e':
@@ -203,12 +204,14 @@ main(int argc, char **argv)
 	    case 's':
 	    case 'r':
 		command = flag;
+		crm_free(shadow);
 		shadow = crm_strdup(optarg);
 		break;
 	    case 'C':
 	    case 'D':
 		command = flag;
 		dangerous_cmd = TRUE;
+		crm_free(shadow);
 		shadow = crm_strdup(optarg);
 		break;
 	    case 'V':
@@ -257,16 +260,19 @@ main(int argc, char **argv)
 	const char *local = getenv("CIB_shadow");
 	if(local == NULL) {
 	    fprintf(stderr, "No shadow instance provided\n");
-	    return cib_NOTEXISTS;
+	    rc = cib_NOTEXISTS;
+	    goto done;
 	}
 	fprintf(stdout, "%s\n", local);
-	return 0;
+	rc = 0;
+	goto done;
     }
     
     if(shadow == NULL) {
 	fprintf(stderr, "No shadow instance provided\n");
 	fflush(stderr);
-	return CIBRES_MISSING_FIELD;
+	rc = CIBRES_MISSING_FIELD;
+	goto done;
 
     } else if(command != 's' && command != 'c') {
 	const char *local = getenv("CIB_shadow");
@@ -275,7 +281,8 @@ main(int argc, char **argv)
 		    "  To prevent accidental destruction of the cluster,"
 		    " the --force flag is required in order to proceed.\n", shadow, local);
 	    fflush(stderr);
-	    exit(LSB_EXIT_GENERIC);
+	    rc = LSB_EXIT_GENERIC;
+	    goto done;
 	}
     }
 
@@ -284,7 +291,8 @@ main(int argc, char **argv)
 		"  To prevent accidental destruction of the cluster,"
 		" the --force flag is required in order to proceed.\n");
 	fflush(stderr);
-	exit(LSB_EXIT_GENERIC);
+	rc = LSB_EXIT_GENERIC;
+	goto done;
     }
 
     shadow_file = get_shadow_file(shadow);
@@ -295,16 +303,17 @@ main(int argc, char **argv)
 	    rc = unlink(shadow_file);
 	    if(rc != 0) {
 		fprintf(stderr, "Could not remove shadow instance '%s': %s\n", shadow, strerror(errno));
-		return rc;
+		goto done;
 	    }
 	}
 
 	shadow_teardown(shadow);
-	return rc;
+	goto done;
 
     } else if(command == 'F') {
 	printf("%s\n", shadow_file);
-	return 0;
+	rc = 0;
+	goto done;
     }
 
     if(command == 'd' || command == 'r' || command == 'c' || command == 'C') {
@@ -312,7 +321,7 @@ main(int argc, char **argv)
 	rc = real_cib->cmds->signon(real_cib, crm_system_name, cib_command);
 	if(rc != cib_ok) {
 	    fprintf(stderr, "Signon to CIB failed: %s\n", cib_error2string(rc));
-	    return rc;
+	    goto done;
 	}
     }
     
@@ -323,12 +332,14 @@ main(int argc, char **argv)
 	    fprintf(stderr, "A shadow instance '%s' already exists.\n"
 		   "  To prevent accidental destruction of the cluster,"
 		   " the --force flag is required in order to proceed.\n", shadow);
-	    return cib_EXISTS;
+	    rc = cib_EXISTS;
+	    goto done;
 	}
 
     } else if(rc != 0) {
 	fprintf(stderr, "Could not access shadow instance '%s': %s\n", shadow, strerror(errno));
-	return cib_NOTEXISTS;
+	rc = cib_NOTEXISTS;
+	goto done;
     }
 
     rc = cib_ok;
@@ -340,7 +351,7 @@ main(int argc, char **argv)
 	    rc = real_cib->cmds->query(real_cib, NULL, &output, command_options);
 	    if(rc != cib_ok) {
 		fprintf(stderr, "Could not connect to the CIB: %s\n", cib_error2string(rc));
-		return rc;
+		goto done;
 	    }
 
 	} else {
@@ -352,10 +363,12 @@ main(int argc, char **argv)
 	}
 	
 	rc = write_xml_file(output, shadow_file, FALSE);
+	free_xml(output);
+	
 	if(rc < 0) {
 	    fprintf(stderr, "Could not create the shadow instance '%s': %s\n",
 		    shadow, strerror(errno));
-	    return rc;
+	    goto done;
 	}
 	shadow_setup(shadow, FALSE);
 	rc = cib_ok;
@@ -365,17 +378,20 @@ main(int argc, char **argv)
 	char *editor = getenv("EDITOR");
 	if(editor == NULL) {
 	    fprintf(stderr, "No value for $EDITOR defined\n");
-	    return cib_missing;
+	    rc = cib_missing;
+	    goto done;
 	}
 
 	execlp(editor, "--", shadow_file, NULL);
 	err = strerror(errno);
-	fprintf(stderr, "Could not invoke $EDITOR (%s %s)\n", editor, shadow_file);
-	return cib_missing;
+	fprintf(stderr, "Could not invoke $EDITOR (%s %s): %s\n", editor, shadow_file, err);
+	rc = cib_missing;
+	goto done;
 	
     } else if(command == 's') {
 	shadow_setup(shadow, TRUE);
-	return 0;
+	rc = 0;
+	goto done;
     
     } else if(command == 'P') {
 	/* display the current contents */
@@ -398,15 +414,17 @@ main(int argc, char **argv)
 	
 	if(rc != cib_ok) {
 	    fprintf(stderr, "Could not query the CIB: %s\n", cib_error2string(rc));
-	    return rc;
+	    goto done;
 	}
 
 	diff = diff_xml_object(old_config, new_config, FALSE);
 	if(diff != NULL) {
 	    print_xml_diff(stdout, diff);
-	    return 1;
+	    rc = 1;
+	    goto done;
 	}
-	return 0;	
+	rc = 0;
+	goto done;
 	
     } else if(command == 'C') {
 	/* commit to the cluster */
@@ -419,7 +437,10 @@ main(int argc, char **argv)
 	}	
 	shadow_teardown(shadow);
     }
-
+  done:
+    xmlCleanupParser();
+    crm_free(shadow_file);
+    crm_free(shadow);
     return rc;
 }
 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/cibadmin.c
--- a/tools/cibadmin.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/cibadmin.c	Mon Jul 12 18:48:04 2010 +0200
@@ -117,6 +117,7 @@ static struct crm_option long_options[] 
     {"scope",       1, 0, 'o', "Limit the scope of the operation to a specific section of the CIB."},
     {"-spacer-",    0, 0, '-', "\t\t\tValid values are: nodes, resources, constraints, crm_config, rsc_defaults, op_defaults, status"},
     {"node",	    1, 0, 'N', "(Advanced) Send command to the specified host\n"},
+    {"-space-",	    0, 0, '!', NULL, 1},
 
     {"-spacer-",    0, 0, '-', "\nExamples:\n"},
     {"-spacer-",    0, 0, '-', "Query the configuration from the local node:", pcmk_option_paragraph},
@@ -189,8 +190,8 @@ main(int argc, char **argv)
 	xmlNode *input = NULL;
 	
 	int option_index = 0;
-	crm_log_init("cibadmin", LOG_CRIT, FALSE, FALSE, argc, argv);
-	crm_set_options("V?$o:QDUCEX:t:Srwlsh:MmBfbRx:pP5N:A:uncd", "command [options] [data]", long_options,
+	crm_log_init(NULL, LOG_CRIT, FALSE, FALSE, argc, argv);
+	crm_set_options("!V?$o:QDUCEX:t:Srwlsh:MmBfbRx:pP5N:A:uncd", "command [options] [data]", long_options,
 			"Provides direct access to the cluster configuration."
 			"\n\n Allows the configuration, or sections of it, to be queried, modified, replaced and deleted."
 			"\n\n Where necessary, XML data will be obtained using the -X, -x, or -p options\n");
@@ -277,6 +278,7 @@ main(int argc, char **argv)
 				break;
 			case '?':
 			case '$':
+			case '!':
 				crm_help(flag, LSB_EXIT_OK);
 				break;
 			case 'o':
@@ -437,11 +439,18 @@ main(int argc, char **argv)
 		char *buffer = dump_xml_formatted(output);
 		fprintf(stdout, "%s\n", crm_str(buffer));
 		crm_free(buffer);
+		free_xml(output);
 	}
 
+	crm_debug_3("%s exiting normally", crm_system_name);
+	
+	free_xml(input);
+	crm_free(admin_input_xml);
+	crm_free(admin_input_file);
 	the_cib->cmds->signoff(the_cib);
-	
-	crm_debug_3("%s exiting normally", crm_system_name);
+	cib_delete(the_cib);
+	xmlCleanupParser();
+
 	return -exit_code;
 }
 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/cli.supp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/tools/cli.supp	Mon Jul 12 18:48:04 2010 +0200
@@ -0,0 +1,2 @@
+# Valgrind suppressions file for CLI tools
+
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_attribute.c
--- a/tools/crm_attribute.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_attribute.c	Mon Jul 12 18:48:04 2010 +0200
@@ -120,7 +120,7 @@ main(int argc, char **argv)
 
 	int option_index = 0;
 
-	crm_system_name = basename(argv[0]);
+	crm_log_init_quiet(NULL, LOG_ERR, FALSE, FALSE, argc, argv);
 	crm_set_options("V?$GDQqN:U:u:s:n:v:l:t:zi:!r:d:", "command -n attribute [options]", long_options,
 			"Manage node's attributes and cluster options."
 			"\n\nAllows node attributes and cluster options to be queried, modified and deleted.\n");
@@ -195,9 +195,7 @@ main(int argc, char **argv)
 	}
 
 	if(BE_QUIET == FALSE) {
-	    crm_log_init(basename(argv[0]), LOG_ERR, FALSE, FALSE, argc, argv);
-	} else {
-	    crm_log_init(basename(argv[0]), LOG_ERR, FALSE, FALSE, 0, NULL);
+	    cl_log_args(argc, argv);
 	}
 	
 	if (optind < argc) {
@@ -304,12 +302,15 @@ main(int argc, char **argv)
 		}
 	}
 
-	the_cib->cmds->signoff(the_cib);
 	if(rc == cib_missing_data) {
 		    printf("Please choose from one of the matches above and suppy the 'id' with --attr-id\n");
 	} else if(rc != cib_ok) {
 		fprintf(stderr, "Error performing operation: %s\n",
 			cib_error2string(rc));
 	}
+	
+	the_cib->cmds->signoff(the_cib);
+	cib_delete(the_cib);
+	xmlCleanupParser();
 	return rc;
 }
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_failcount
--- a/tools/crm_failcount	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_failcount	Mon Jul 12 18:48:04 2010 +0200
@@ -3,7 +3,7 @@
 options=""
 target=`uname -n`
 
-TEMP=`getopt -o DGQVN:U:v:i:l:r: --long resource-id:,node:,uname:,attr-value:,delete-attr,get-value,attr-id:,lifetime:,quiet \
+TEMP=`getopt -o DGQVN:U:v:i:l:r: --long help,version,resource-id:,node:,uname:,attr-value:,delete-attr,get-value,attr-id:,lifetime:,quiet \
      -n 'crm_failcount' -- "$@"`
 
 if [ $? != 0 ] ; then echo "crm_failcount - A convenience wrapper for crm_attribute"; echo ""; crm_attribute -?; exit 1 ; fi
@@ -18,8 +18,33 @@ while true ; do
 	-v|--attr-value|-i|--attr-id) options="$options $1 $2"; shift; shift;;
 	-Q|--quiet|-D|--delete-attr|-G|--get-value|-V) options="$options $1"; shift;;
 	-r|--resource-id) options="$options -n fail-count-$2"; shift; shift;;
+	--version) crm_attribute --version; exit 0;;
+	--help) 
+	    echo "crm_failcount - A convenience wrapper for crm_attribute"; 
+	    echo "Set, update or remove the failcount for the specified resource on the named node"; 
+	    echo ""; 
+	    echo "Usage: crm_failcount -r resource_name command [options]"; 
+	    echo "Options:"
+	    echo " --help 		This text"
+	    echo " --version 		Version information"
+	    echo " -V, --verbose 		Increase debug output"
+	    echo " -q, --quiet 		Print only the value on stdout"
+	    echo ""
+	    echo " -r, --resource-id=value	The resource to update."
+	    echo ""
+	    echo "Commands:"
+	    echo " -G, --query 		Query the current value of the attribute/option"
+	    echo " -v, --update=value	Update the value of the attribute/option"
+	    echo " -D, --delete 		Delete the attribute/option"
+	    echo ""
+	    echo "Additional Options:"
+	    echo " -N, --node=value	Set an attribute for the named node (instead of the current one)."
+	    echo " -l, --lifetime=value	Until when should the setting take affect."
+	    echo "	       		Valid values: reboot, forever"
+	    echo " -i, --id=value		(Advanced) The ID used to identify the attribute"
+	    exit 0;;
 	--) shift ; break ;;
-	*) echo "crm_failcount - A convenience wrapper for crm_attribute"; echo ""; crm_attribute -?; exit 1;;
+	*) echo "Unknown option: $1. See --help for details." exit 1;;
     esac
 done
 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_inject.c
--- a/tools/crm_inject.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_inject.c	Mon Jul 12 18:48:04 2010 +0200
@@ -56,6 +56,16 @@ extern void cleanup_alloc_calculations(p
 extern xmlNode * do_calculations(
     pe_working_set_t *data_set, xmlNode *xml_input, ha_time_t *now);
 
+char *use_date = NULL;
+static ha_time_t *get_date(void) 
+{
+    if(use_date) {
+	char *date_m = use_date;
+	return parse_date(&date_m);
+    }
+    return NULL;
+}
+
 static xmlNode *find_resource(xmlNode *cib_node, const char *resource)
 {
     char *xpath = NULL;
@@ -312,7 +322,6 @@ static gboolean exec_rsc_action(crm_grap
     const char *rprovider = NULL;
     const char *target_rc_s = crm_meta_value(action->params, XML_ATTR_TE_TARGET_RC);
     
-    xmlNode *cib_op = NULL;
     xmlNode *cib_node = NULL;
     xmlNode *cib_resource = NULL;
     xmlNode *action_rsc = first_named_child(action->xml, XML_CIB_TAG_RESOURCE);
@@ -367,7 +376,7 @@ static gboolean exec_rsc_action(crm_grap
 	       }
 	);
 	
-    cib_op = inject_op(cib_resource, op, target_outcome);
+    inject_op(cib_resource, op, target_outcome);
     crm_free(op->user_data);
     crm_free(op->output);
     crm_free(op->rsc_id);
@@ -538,22 +547,23 @@ run_simulation(pe_working_set_t *data_se
     } while(graph_rc == transition_active);
 	
     if(graph_rc != transition_complete) {
-	fprintf(stderr, "Transition failed: %s\n", transition_status(graph_rc));
+	fprintf(stdout, "Transition failed: %s\n", transition_status(graph_rc));
 	print_graph(LOG_ERR, transition);
     }
     destroy_graph(transition);
-    CRM_CHECK(graph_rc == transition_complete, fprintf(stderr, "An invalid transition was produced"));
+    if(graph_rc != transition_complete) {
+	fprintf(stdout, "An invalid transition was produced\n");
+    }
 
     if(quiet == FALSE) {
 	xmlNode *cib_object = NULL;
-	ha_time_t *a_date = data_set->now;
 	int rc = global_cib->cmds->query(global_cib, NULL, &cib_object, cib_sync_call|cib_scope_local);
+
 	CRM_ASSERT(rc == cib_ok);
-
 	quiet_log("\nRevised cluster status:\n");
-	set_working_set_defaults(data_set);
+	cleanup_alloc_calculations(data_set);
 	data_set->input = cib_object;
-	data_set->now = a_date;
+	data_set->now = get_date();
 	
 	cluster_status(data_set);
 	print_cluster_status(data_set);
@@ -753,12 +763,13 @@ static void modify_configuration(
 	       resource_t *rsc = NULL;
 	       quiet_log(" + Injecting %s into the configuration\n", spec);
 	       
-	       crm_malloc0(key, strlen(spec));
-	       crm_malloc0(node, strlen(spec));
+	       crm_malloc0(key, strlen(spec)+1);
+	       crm_malloc0(node, strlen(spec)+1);
 	       rc = sscanf(spec, "%[^@]@%[^=]=%d", key, node, &outcome);
 	       CRM_CHECK(rc == 3, fprintf(stderr, "Invalid operation spec: %s.  Only found %d fields\n", spec, rc); continue);
 	       
 	       parse_op_key(key, &resource, &task, &interval);
+	       crm_free(task);
 
 	       rsc = pe_find_resource(data_set->resources, resource);
 	       CRM_CHECK(rsc != NULL, fprintf(stderr, "Invalid resource name: %s\n", resource); continue);
@@ -780,6 +791,7 @@ static void modify_configuration(
 	       
 	       cib_op = inject_op(cib_resource, op, 0);
 	       CRM_ASSERT(cib_op != NULL);
+	       free_lrm_op(op); 
 	       
 	       rc = global_cib->cmds->modify(global_cib, XML_CIB_TAG_STATUS, cib_node, cib_sync_call|cib_scope_local);
 	       CRM_ASSERT(rc == cib_ok);
@@ -819,6 +831,10 @@ setup_input(const char *input, const cha
 	cib_object = filename2xml(input);
     }
 
+    if(get_object_root(XML_CIB_TAG_STATUS, cib_object) == NULL) {
+	create_xml_node(cib_object, XML_CIB_TAG_STATUS);
+    }
+
     if(cli_config_update(&cib_object, NULL, FALSE) == FALSE) {
 	free_xml(cib_object);
 	exit(cib_STALE);
@@ -901,7 +917,6 @@ main(int argc, char ** argv)
     gboolean all_actions = FALSE;
 
     pe_working_set_t data_set;
-    ha_time_t *a_date = NULL;
 
     const char *xml_file = "-";
     const char *quorum = NULL;
@@ -913,7 +928,6 @@ main(int argc, char ** argv)
     int flag = 0;
     int index = 0;
     int argerr = 0;
-    char *use_date = NULL;
 
     GListPtr node_up = NULL;
     GListPtr node_down = NULL;
@@ -922,7 +936,7 @@ main(int argc, char ** argv)
     
     xmlNode *input = NULL;
 
-    crm_log_init("crm_simulate", LOG_ERR, FALSE, FALSE, argc, argv);
+    crm_log_init(NULL, LOG_ERR, FALSE, FALSE, argc, argv);
     crm_set_options("?$VQx:Lpu:d:f:i:RSXD:G:I:O:sUaF:t:q:", "datasource operation [additional options]",
 		    long_options, "Tool for simulating the cluster's response to events");
 
@@ -1042,13 +1056,12 @@ main(int argc, char ** argv)
     global_cib = cib_new();
     global_cib->cmds->signon(global_cib, crm_system_name, cib_command);
 
-    if(use_date != NULL) {
-	char *date_m = use_date;
-	a_date = parse_date(&date_m);
+    set_working_set_defaults(&data_set);
+    data_set.now = get_date();
+    
+    if(data_set.now != NULL) {
 	quiet_log(" + Setting effective cluster time: %s", use_date);
-	log_date(LOG_WARNING, "Set fake 'now' to", a_date, ha_log_date|ha_log_time);
-	crm_free(use_date);
-	use_date = NULL;
+	log_date(LOG_WARNING, "Set fake 'now' to", data_set.now, ha_log_date|ha_log_time);
     }
     
     if(quiet == FALSE) {
@@ -1056,11 +1069,9 @@ main(int argc, char ** argv)
 	rc = global_cib->cmds->query(global_cib, NULL, &cib_object, cib_sync_call|cib_scope_local);
 	CRM_ASSERT(rc == cib_ok);
 	
-	set_working_set_defaults(&data_set);
 	data_set.input = cib_object;
-	data_set.now = a_date;
-	
 	cluster_status(&data_set);
+
 	quiet_log("\nCurrent cluster status:\n");
 	print_cluster_status(&data_set);
 	if(process == FALSE && modified == FALSE) {
@@ -1094,13 +1105,14 @@ main(int argc, char ** argv)
 	if(show_scores && show_utilization) {
 	    printf("Allocation scores and utilization information:\n");
 	} else if(show_scores) {
-	    printf("Allocation scores:\n");
+	    fprintf(stdout, "Allocation scores:\n");
 	} else if(show_utilization) {
 	    printf("Utilization information:\n");
 	}
 	
-	do_calculations(&data_set, input, a_date);
-	
+	cleanup_alloc_calculations(&data_set);
+	do_calculations(&data_set, input, get_date());
+
 	if(graph_file != NULL) {
 	    char *msg_buffer = dump_xml_formatted(data_set.graph);
 	    FILE *graph_strm = fopen(graph_file, "w");
@@ -1145,6 +1157,7 @@ main(int argc, char ** argv)
     
     global_cib->cmds->signoff(global_cib);
     cib_delete(global_cib);
+    crm_free(use_date);
     fflush(stderr);
     return rc;
 }
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_master
--- a/tools/crm_master	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_master	Mon Jul 12 18:48:04 2010 +0200
@@ -1,6 +1,6 @@
 #!/bin/bash
 
-TEMP=`getopt -o DGQVN:U:v:i:l:r: --long resource:,node:,uname:,attr-value:,delete-attr,get-value,attr-id:,lifetime:,quiet \
+TEMP=`getopt -o qDGQVN:U:v:i:l:r: --long version,help,resource:,node:,uname:,attr-value:,id:,update:,delete-attr,get-value,attr-id:,lifetime:,quiet \
      -n 'crm_master' -- "$@"`
 
 if [ $? != 0 ] ; then echo "crm_master - A convenience wrapper for crm_attribute"; echo ""; crm_attribute -?; exit 1 ; fi
@@ -10,11 +10,37 @@ eval set -- "$TEMP"
 
 while true ; do
 	case "$1" in
-	    -N|--node|-U|--uname|-v|--attr-value|-i|--attr-id|-l|--lifetime) options="$options $1 $2"; shift; shift;;
-	    -Q|--quiet|-D|--delete-attr|-G|--get-value|-V) options="$options $1"; shift;;
+	    -N|--node|-U|--uname|-v|--attr-value|--update|-i|--id|--attr-id|-l|--lifetime) options="$options $1 $2"; shift; shift;;
+	    -Q|-q|--quiet|-D|--delete-attr|-G|--get-value|-V) options="$options $1"; shift;;
 	    -r|--resource) OCF_RESOURCE_INSTANCE=$2; shift; shift;;
+	    --version) crm_attribute --version; exit 0;;
+	    --help) 
+		echo "crm_master - A convenience wrapper for crm_attribute"; 
+		echo ""; 
+		echo ""; 
+		echo "Set, update or delete a resource's promotion score"; 
+		echo "This program should normally only be invoked from inside an OCF resource agent"
+		echo ""; 
+		echo "Usage: crm_master command [options]"; 
+		echo "Options:"
+		echo " --help 		This text"
+		echo " --version 		Version information"
+		echo " -V, --verbose 		Increase debug output"
+		echo " -q, --quiet 		Print only the value on stdout"
+		echo ""
+		echo "Commands:"
+		echo " -G, --query 		Query the current value of the attribute/option"
+		echo " -v, --update=value	Update the value of the attribute/option"
+		echo " -D, --delete 		Delete the attribute/option"
+		echo ""
+		echo "Additional Options:"
+		echo " -N, --node=value	Set an attribute for the named node (instead of the current one)."
+		echo " -l, --lifetime=value	Until when should the setting take affect."
+		echo "	       		Valid values: reboot, forever"
+		echo " -i, --id=value		(Advanced) The ID used to identify the attribute"
+		exit 0;;
 	    --) shift ; break ;;
-	    *) echo "crm_master - A convenience wrapper for crm_attribute"; echo ""; echo "Unknown option: $1"; crm_attribute -?; exit 1;;
+	    *) echo "Unknown option: $1. See --help for details." exit 1;;
 	esac
 done
 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_mon.c
--- a/tools/crm_mon.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_mon.c	Mon Jul 12 18:48:04 2010 +0200
@@ -185,6 +185,10 @@ mon_shutdown(int nsig)
     clean_up(LSB_EXIT_OK);
 }
 
+#if ON_DARWIN
+#  define sighandler_t sig_t 
+#endif
+
 #if CURSES_ENABLED
 static sighandler_t ncurses_winch_handler;
 static void
@@ -324,8 +328,7 @@ main(int argc, char **argv)
     int option_index = 0;	
 
     pid_file = crm_strdup("/tmp/ClusterMon.pid");
-    crm_log_init(basename(argv[0]), LOG_CRIT, FALSE, FALSE, 0, NULL);
-
+    crm_log_init_quiet(NULL, LOG_CRIT, FALSE, FALSE, argc, argv);
     crm_set_options("V?$i:nrh:dp:s1wx:oftANS:T:F:H:P:E:e:C:", "mode [options]", long_options,
 		    "Provides a summary of cluster's current state."
 		    "\n\nOutputs varying levels of detail in a number of different formats.\n");
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_report.in
--- a/tools/crm_report.in	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_report.in	Mon Jul 12 18:48:04 2010 +0200
@@ -21,10 +21,11 @@
 # Note the quotes around `$TEMP': they are essential!
 TEMP=`getopt				\
     -o hv?xl:f:t:n:T:Lpc:dSACHu:MV	\
-    --long help,cts:,node:,nodes:,from:,to:logfile:,as-directory,single-node,cluster:,user:,version	\
+    --long help,cts:,node:,nodes:,from:,to:logfile:,as-directory,single-node,cluster:,user:,version,features	\
     -n 'pcmk_report' -- "$@"`
 eval set -- "$TEMP"
 
+
 times=""
 tests=""
 nodes=""
@@ -39,15 +40,6 @@ extra_logs=""
 sanitize_patterns="passw.*"
 log_patterns="CRIT: ERROR:"
 
-# Prefer helpers in the same directory if they exist, to simplify development
-if [ ! -f $report_data/report.common ]; then
-    report_data=@datadir@/@PACKAGE@
-else
-    echo "Using local helpers"
-fi
-
-. $report_data/report.common
-
 usage() {
 
 cat<<EOF
@@ -57,6 +49,7 @@ usage: `basename $0` -f {YYYY-M-D H:M:S}
   -f, --from time	time to start from: YYYY-M-D H:M:S
   -t, --to time		time to finish at (default: now)
   -T, --cts test	CTS test or set of tests to extract
+      --cts-log		CTS master logfile
   -n, --nodes nodes	node names for this cluster
 			only needed if the cluster is not active on the current machine
 			accepts both -n "a b" and -n a -n b
@@ -76,11 +69,27 @@ usage: `basename $0` -f {YYYY-M-D H:M:S}
 EOF
 }
 
+case "$1" in
+    -v|--version)   echo "@VERSION@ - @BUILD_VERSION@"; exit 0;;
+    --features)     echo "@VERSION@ - @BUILD_VERSION@: @PKG_FEATURES@"; exit 0;;
+    -h|--help) usage; exit 0;;
+esac
+
+# Prefer helpers in the same directory if they exist, to simplify development
+if [ ! -f $report_data/report.common ]; then
+    report_data=@datadir@/@PACKAGE@
+else
+    echo "Using local helpers"
+fi
+
+. $report_data/report.common
+
 while true; do
     case "$1" in
 	-x) set -x; shift;;
 	-v) verbose=`expr $verbose + 1`; shift;;
 	-T|--cts) tests="$tests $2"; shift; shift;;
+	--cts-log) ctslog="$2"; shift; shift;;
 	-f|--from) start_time=`get_time "$2"`; shift; shift;;
 	-t|--to) end_time=`get_time "$2"`; shift; shift;;
 	-n|--node|--nodes) nodes="$nodes $2"; shift; shift;;
@@ -94,7 +103,8 @@ while true; do
 	-H|--heartbeat) cluster="heartbeat"; shift;;
 	-c|--cluster)   cluster="$2"; shift; shift;;
 	-u|--user)      ssh_user="$2"; shift; shift;;
-	-v|--version)   echo "$0 @VERSION@ - @BUILD_VERSION@"; shift;;
+	-v|--version)   echo "@VERSION@ - @BUILD_VERSION@"; exit 0; shift;;
+	--features)     echo "@VERSION@ - @BUILD_VERSION@: @CRM_FEATURES@"; exit 0; shift;;
 	-M) search_logs=0; shift;;
 	--) DESTDIR=$2; break;;
 	-h|--help) usage; exit 0;;
@@ -259,7 +269,9 @@ analyze() {
 }
 
 do_cts() {
-    ctslog=`findmsg 1 "CTS: Stack:"`
+    if [ x$ctslog = x ]; then
+	ctslog=`findmsg 1 "CTS: Stack:"`
+    fi
     if [ x$ctslog = x ]; then
 	fatal "No CTS control file detected"
     fi
@@ -297,6 +309,11 @@ do_cts() {
 	line=`grep -n "Running test.*\[ *$end_test\]" $ctslog | tail -1 | sed 's/:.*//'`
 	end_time=`linetime $ctslog $line`
 
+	if [ $end_time -lt $start_time ]; then
+	    debug "Test didn't complete, grabbing everything up to now"
+	    end_time=`date +%s`
+	fi
+
 	log "$msg (`time2str $start_time` to `time2str $end_time`)"
 	collect_data $label $start_time $end_time $ctslog
     done 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_resource.c
--- a/tools/crm_resource.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_resource.c	Mon Jul 12 18:48:04 2010 +0200
@@ -57,12 +57,90 @@ char *our_pid = NULL;
 IPC_Channel *crmd_channel = NULL;
 char *xml_file = NULL;
 int cib_options = cib_sync_call;
+int crmd_replies_needed = 0;
+GMainLoop *mainloop = NULL;
 
 #define CMD_ERR(fmt, args...) do {		\
 	crm_warn(fmt, ##args);			\
 	fprintf(stderr, fmt, ##args);		\
     } while(0)
 
+#define message_timeout_ms 60*1000
+
+static gboolean
+resource_ipc_timeout(gpointer data)
+{
+	fprintf(stderr, "No messages received in %d seconds.. aborting\n",
+		(int)message_timeout_ms/1000);
+	crm_err("No messages received in %d seconds",
+		(int)message_timeout_ms/1000);
+	exit(-1);
+}
+
+static void
+resource_ipc_connection_destroy(gpointer user_data)
+{
+	crm_info("Connection to CRMd was terminated");
+	exit(1);
+}
+
+static void
+start_mainloop(void) 
+{
+    mainloop = g_main_new(FALSE);
+    crmd_replies_needed++; /* The welcome message */
+    fprintf(stderr, "Waiting for %d replies from the CRMd", crmd_replies_needed);
+    crm_debug("Waiting for %d replies from the CRMd", crmd_replies_needed);
+    
+    g_timeout_add(message_timeout_ms, resource_ipc_timeout, NULL);
+    g_main_run(mainloop);
+}
+
+static gboolean
+resource_ipc_callback(IPC_Channel * server, void *private_data)
+{
+    int lpc = 0;
+    xmlNode *msg = NULL;
+    gboolean stay_connected = TRUE;
+	
+    while(IPC_ISRCONN(server)) {
+	if(server->ops->is_message_pending(server) == 0) {
+	    break;
+	}
+
+	msg = xmlfromIPC(server, MAX_IPC_DELAY);
+	if (msg == NULL) {
+	    break;
+	}
+
+	lpc++;
+	fprintf(stderr, ".");
+	crm_log_xml(LOG_DEBUG_2, "[inbound]", msg);
+
+	crmd_replies_needed--;
+	if(crmd_replies_needed == 0) {
+	    fprintf(stderr, " OK\n");
+	    crm_debug("Got all the replies we expected");
+	    exit(0);
+	}
+
+	free_xml(msg);
+	msg = NULL;
+
+	if(server->ch_status != IPC_CONNECT) {
+	    break;
+	}
+    }
+	
+    crm_debug_2("Processed %d messages (%d)", lpc, server->ch_status);
+    
+    if (server->ch_status != IPC_CONNECT) {
+	stay_connected = FALSE;
+    }
+
+    return stay_connected;
+}
+
 static int
 do_find_resource(const char *rsc, pe_working_set_t *data_set)
 {
@@ -330,7 +408,7 @@ static int find_resource_attr(
 	the_cib, xpath_string, &xml_search, cib_sync_call|cib_scope_local|cib_xpath);
 	
     if(rc != cib_ok) {
-	return rc;
+	goto bail;
     }
 
     crm_log_xml_debug(xml_search, "Match");
@@ -350,6 +428,8 @@ static int find_resource_attr(
 	}
     }
 
+  bail:
+    crm_free(xpath_string);
     free_xml(xml_search);
     return rc;
 }
@@ -389,6 +469,7 @@ set_resource_attr(const char *rsc_id, co
 	    attr_id = local_attr_id;
 
 	} else if(rc != cib_NOTEXISTS) {
+	    crm_free(local_attr_id);
 	    return rc;
 
 	} else {
@@ -519,44 +600,6 @@ dump_resource_prop(
 	return cib_NOTEXISTS;
 }
 
-static void
-resource_ipc_connection_destroy(gpointer user_data)
-{
-	crm_info("Connection to CRMd was terminated");
-	exit(1);
-}
-
-static gboolean
-crmd_msg_callback(IPC_Channel * server, void *private_data)
-{
-	int lpc = 0;
-	IPC_Message *msg = NULL;
-	gboolean hack_return_good = TRUE;
-
-	while (server->ch_status != IPC_DISCONNECT
-	       && server->ops->is_message_pending(server) == TRUE) {
-		if (server->ops->recv(server, &msg) != IPC_OK) {
-			perror("Receive failure:");
-			return !hack_return_good;
-		}
-
-		if (msg == NULL) {
-			crm_debug_4("No message this time");
-			continue;
-		}
-
-		lpc++;
-		msg->msg_done(msg);		
-	}
-
-	if (server->ch_status == IPC_DISCONNECT) {
-		crm_debug_2("admin_msg_callback: received HUP");
-		return !hack_return_good;
-	}
-
-	return hack_return_good;
-}
-
 static int
 send_lrm_rsc_op(IPC_Channel *crmd_channel, const char *op,
 		const char *host_uname, const char *rsc_id,
@@ -632,11 +675,10 @@ send_lrm_rsc_op(IPC_Channel *crmd_channe
 
 	if(send_ipc_message(crmd_channel, cmd)) {
 	    rc = 0;
-	    sleep(1); /* dont exit striaght away, give the crmd time
-		       * to process our request
-		       */
+
 	} else {
 	    CMD_ERR("Could not send %s op to the crmd", op);
+	    rc = cib_connection;
 	}
 	
 	free_xml(cmd);
@@ -660,7 +702,10 @@ delete_lrm_rsc(IPC_Channel *crmd_channel
 
     } else if(host_uname == NULL) {
 	slist_iter(node, node_t, data_set->nodes, lpc,
-		   delete_lrm_rsc(crmd_channel, node->details->uname, rsc, data_set));
+		   if(node->details->online) {
+		       delete_lrm_rsc(crmd_channel, node->details->uname, rsc, data_set);
+		   }
+	    );
 	return cib_ok;	
     }
 
@@ -670,6 +715,7 @@ delete_lrm_rsc(IPC_Channel *crmd_channel
 	char *attr_name = NULL;
 	const char *id = rsc->id;
 
+	crmd_replies_needed++;
 	if(rsc->clone_name) {
 	    id = rsc->clone_name;
 	}
@@ -686,6 +732,9 @@ fail_lrm_rsc(IPC_Channel *crmd_channel, 
 	     const char *rsc_id, pe_working_set_t *data_set)
 {
     crm_warn("Failing: %s", rsc_id);
+#if HAVE_STRUCT_LRM_OPS_FAIL_RSC
+    crmd_replies_needed++;
+#endif
     return send_lrm_rsc_op(crmd_channel, CRM_OP_LRM_FAIL, host_uname, rsc_id, FALSE, data_set); 
 }
 
@@ -924,8 +973,10 @@ static void show_location(resource_t *rs
 
     slist_iter(cons, rsc_to_node_t, list, lpc,
 	       slist_iter(node, node_t, cons->node_list_rh, lpc2,
+			  char *score = score2char(node->weight);
 			  fprintf(stdout, "+ '%s': %s = %s \n",
-				  cons->id, node->details->uname, score2char(node->weight));
+				  cons->id, node->details->uname, score);
+			  crm_free(score);
 		   );
 	);
 }
@@ -955,7 +1006,9 @@ static void show_colocation(resource_t *
 	       }
 	       
 	       if(raw) {
-		   fprintf(stdout, "%s '%s': %s = %s\n", prefix, cons->id, peer->id, score2char(cons->score));
+		   char *score = score2char(cons->score);
+		   fprintf(stdout, "%s '%s': %s = %s\n", prefix, cons->id, peer->id, score);
+		   crm_free(score);
 		   continue;
 	       }
 	       
@@ -1074,7 +1127,7 @@ main(int argc, char **argv)
 	int argerr = 0;
 	int flag;
 
-	crm_log_init(basename(argv[0]), LOG_ERR, FALSE, FALSE, argc, argv);
+	crm_log_init(NULL, LOG_ERR, FALSE, FALSE, argc, argv);
 	crm_set_options("V?$LRQxDCPp:WMUr:H:h:v:t:p:g:d:i:s:G:S:fx:lmzu:FOocqN:aA", "(query|command) [options]", long_options,
 			"Perform tasks related to cluster resources.\n  Allows resources to be queried (definition and location), modified, and moved around the cluster.\n");
 
@@ -1200,6 +1253,7 @@ main(int argc, char **argv)
 		cib_options |= cib_scope_local|cib_quorum_override;
 	}
 
+	set_working_set_defaults(&data_set);
 	if(need_cib) {
 		resource_t *rsc = NULL;
 		if(xml_file != NULL) {
@@ -1218,9 +1272,9 @@ main(int argc, char **argv)
 			cib_xml_copy = get_cib_copy(cib_conn);
 		}
 		
-		set_working_set_defaults(&data_set);
 		if(cli_config_update(&cib_xml_copy, NULL, FALSE) == FALSE) {
-		    return cib_STALE;
+		    rc = cib_STALE;
+		    goto bail;
 		}
 
 		data_set.input = cib_xml_copy;
@@ -1240,12 +1294,13 @@ main(int argc, char **argv)
 	   || rsc_cmd == 'F'
 	   || rsc_cmd == 'P') {
 		GCHSource *src = NULL;
-		src = init_client_ipc_comms(CRM_SYSTEM_CRMD, crmd_msg_callback,
+		src = init_client_ipc_comms(CRM_SYSTEM_CRMD, resource_ipc_callback,
 				      NULL, &crmd_channel);
 
 		if(src == NULL) {
 			CMD_ERR("Error signing on to the CRMd service\n");
-			return 1;
+			rc = cib_connection;
+			goto bail;
 		}
 		
 		send_hello_message(
@@ -1269,7 +1324,8 @@ main(int argc, char **argv)
 	    
 	    if(found == 0) {
 		printf("NO resources configured\n");
-		return cib_NOTEXISTS;
+		rc = cib_NOTEXISTS;
+		goto bail;
 	    }
 		
 	} else if(rsc_cmd == 'A') {
@@ -1277,7 +1333,8 @@ main(int argc, char **argv)
 	    xmlNode * cib_constraints = get_object_root(XML_CIB_TAG_CONSTRAINTS, data_set.input);
 	    if(rsc == NULL) {
 		CMD_ERR("Must supply a resource id with -r\n");
-		return cib_NOTEXISTS;
+		rc = cib_NOTEXISTS;
+		goto bail;
 	    }
 
 	    unpack_constraints(cib_constraints, &data_set);
@@ -1291,7 +1348,8 @@ main(int argc, char **argv)
 	    xmlNode * cib_constraints = get_object_root(XML_CIB_TAG_CONSTRAINTS, data_set.input);
 	    if(rsc == NULL) {
 		CMD_ERR("Must supply a resource id with -r\n");
-		return cib_NOTEXISTS;
+		rc = cib_NOTEXISTS;
+		goto bail;
 	    }
 	    unpack_constraints(cib_constraints, &data_set);
 
@@ -1314,10 +1372,16 @@ main(int argc, char **argv)
 		
 	} else if(rsc_cmd == 'C') {
 	    resource_t *rsc = pe_find_resource(data_set.resources, rsc_id);
-	    delete_lrm_rsc(crmd_channel, host_uname, rsc, &data_set);
+	    rc = delete_lrm_rsc(crmd_channel, host_uname, rsc, &data_set);
+	    if(rc == cib_ok) {
+		start_mainloop();
+	    }
 		
 	} else if(rsc_cmd == 'F') {
 		rc = fail_lrm_rsc(crmd_channel, host_uname, rsc_id, &data_set);
+		if(rc == cib_ok) {
+		    start_mainloop();
+		}
 		
 	} else if(rsc_cmd == 'O') {
 	    rc = list_resource_operations(rsc_id, host_uname, TRUE, &data_set);
@@ -1332,21 +1396,24 @@ main(int argc, char **argv)
 	} else if(rsc_cmd == 'W') {
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 		} 
 		rc = do_find_resource(rsc_id, &data_set);
 		
 	} else if(rsc_cmd == 'q') {
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;	
+			goto bail;
 		} 
 		rc = dump_resource(rsc_id, &data_set);
 
 	} else if(rsc_cmd == 'U') {
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 		} 
 		rc = move_resource(rsc_id, NULL, NULL, cib_conn);
 
@@ -1406,7 +1473,8 @@ main(int argc, char **argv)
 	} else if(rsc_cmd == 'G') {
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 		} 
 		rc = dump_resource_prop(rsc_id, prop_name, &data_set);
 
@@ -1414,15 +1482,18 @@ main(int argc, char **argv)
 		xmlNode *msg_data = NULL;
 		if(prop_value == NULL || strlen(prop_value) == 0) {
 			CMD_ERR("You need to supply a value with the -v option\n");
-			return CIBRES_MISSING_FIELD;
+			rc = CIBRES_MISSING_FIELD;
+			goto bail;
 
 		} else if(cib_conn == NULL) {
-			return cib_connection;
+			rc = cib_connection;
+			goto bail;
 		}
 
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 		} 
 		CRM_DEV_ASSERT(rsc_type != NULL);
 		CRM_DEV_ASSERT(prop_name != NULL);
@@ -1439,18 +1510,21 @@ main(int argc, char **argv)
 	} else if(rsc_cmd == 'g') {
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 		} 
 		rc = dump_resource_attr(rsc_id, prop_name, &data_set);
 
 	} else if(rsc_cmd == 'p') {
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 		} 
 		if(prop_value == NULL || strlen(prop_value) == 0) {
 			CMD_ERR("You need to supply a value with the -v option\n");
-			return CIBRES_MISSING_FIELD;
+			rc = CIBRES_MISSING_FIELD;
+			goto bail;			
 		}
 		rc = set_resource_attr(rsc_id, prop_set, prop_id, prop_name,
 				       prop_value, cib_conn, &data_set);
@@ -1458,7 +1532,8 @@ main(int argc, char **argv)
 	} else if(rsc_cmd == 'd') {
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 		} 
 		rc = delete_resource_attr(rsc_id, prop_set, prop_id, prop_name,
 					  cib_conn, &data_set);
@@ -1468,25 +1543,35 @@ main(int argc, char **argv)
 		
 		cmd = create_request(CRM_OP_REPROBE, NULL, host_uname,
 				     CRM_SYSTEM_CRMD, crm_system_name, our_pid);
-		send_ipc_message(crmd_channel, cmd);
+		if(send_ipc_message(crmd_channel, cmd)) {
+		    start_mainloop();
+		}
+
 		free_xml(cmd);
 
 	} else if(rsc_cmd == 'R') {
-		refresh_lrm(crmd_channel, host_uname);
+		rc = refresh_lrm(crmd_channel, host_uname);
+		if(rc == cib_ok) {
+		    start_mainloop();
+		}
 
 	} else if(rsc_cmd == 'D') {
 		xmlNode *msg_data = NULL;
 		
 		if(rsc_id == NULL) {
 			CMD_ERR("Must supply a resource id with -r\n");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
+
 		} 
 		if(rsc_type == NULL) {
 			CMD_ERR("You need to specify a resource type with -t");
-			return cib_NOTEXISTS;
+			rc = cib_NOTEXISTS;
+			goto bail;
 
 		} else if(cib_conn == NULL) {
-			return cib_connection;
+			rc = cib_connection;
+			goto bail;
 		}
 
 		msg_data = create_xml_node(NULL, rsc_type);
@@ -1500,10 +1585,16 @@ main(int argc, char **argv)
 		CMD_ERR("Unknown command: %c\n", rsc_cmd);
 	}
 
+  bail:
+	
 	if(cib_conn != NULL) {
 		cleanup_calculations(&data_set);
 		cib_conn->cmds->signoff(cib_conn);
+		cib_delete(cib_conn);
+	} else {
+	    xmlCleanupParser();
 	}
+	
 	if(rc == cib_no_quorum) {
 		CMD_ERR("Error performing operation: %s\n",
 			cib_error2string(rc));
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_standby
--- a/tools/crm_standby	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_standby	Mon Jul 12 18:48:04 2010 +0200
@@ -5,7 +5,7 @@ options=""
 lifetime=0
 target=`uname -n`
 
-TEMP=`getopt -o DGQVN:U:v:i:l: --long node:,uname:,attr-value:,delete-attr,get-value,attr-id:,lifetime:,quiet \
+TEMP=`getopt -o qDGQVN:U:v:i:l: --long version,help,node:,uname:,id:,attr-value:,delete-attr,get-value,attr-id:,lifetime:,quiet \
      -n 'crm_standby' -- "$@"`
 
 if [ $? != 0 ] ; then echo "crm_standby - A convenience wrapper for crm_attribute"; echo ""; crm_attribute -?; exit 1 ; fi
@@ -21,10 +21,35 @@ while true ; do
 	    -D|--delete-attr) options="$options $1"; op=d; shift;;
 	    -G|--get-value)   options="$options $1"; op=g; shift;;
 	    -l|--lifetime)    options="$options $1 $2"; lifetime=1; shift; shift;;
-	    -i|--attr-id)     options="$options $1 $2"; shift; shift;;
-	    -Q|--quiet|-V)    options="$options $1"; shift;;
+	    -i|--id|--attr-id)     options="$options $1 $2"; shift; shift;;
+	    -Q|-q|--quiet|-V)    options="$options $1"; shift;;
+	    --version) crm_attribute --version; exit 0;;
+	    --help) 
+		echo "crm_standby - A convenience wrapper for crm_attribute"; 
+		echo ""; 
+		echo ""; 
+		echo "Put the name node into and out of standby. Nodes in standby mode may not host cluster resources"; 
+		echo ""; 
+		echo "Usage: crm_standby crm_standby command [options]"; 
+		echo "Options:"
+		echo " --help 		This text"
+		echo " --version 		Version information"
+		echo " -V, --verbose 		Increase debug output"
+		echo " -q, --quiet 		Print only the value on stdout"
+		echo ""
+		echo "Commands:"
+		echo " -G, --query 		Query the current value of the attribute/option"
+		echo " -v, --update=value	Update the value of the attribute/option"
+		echo " -D, --delete 		Delete the attribute/option"
+		echo ""
+		echo "Additional Options:"
+		echo " -N, --node=value	Set an attribute for the named node (instead of the current one)."
+		echo " -l, --lifetime=value	Until when should the setting take affect."
+		echo "	       		Valid values: reboot, forever"
+		echo " -i, --id=value		(Advanced) The ID used to identify the attribute"
+		exit 0;;
 	    --) shift ; break ;;
-	    *) echo "crm_standby - A convenience wrapper for crm_attribute"; echo ""; crm_attribute -?; exit 1;;
+	    *) echo "Unknown option: $1. See --help for details." exit 1;;
 	esac
 done
 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crm_verify.c
--- a/tools/crm_verify.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crm_verify.c	Mon Jul 12 18:48:04 2010 +0200
@@ -97,7 +97,7 @@ main(int argc, char **argv)
 	/* and for good measure... - this enum is a bit field (!) */
 	g_log_set_always_fatal((GLogLevelFlags)0); /*value out of range*/
 
-	crm_log_init(basename(argv[0]), LOG_ERR, FALSE, TRUE, 0, NULL);
+	crm_log_init_quiet(NULL, LOG_ERR, FALSE, TRUE, argc, argv);
 	crm_set_options("V?$X:x:pLS:", "[modifiers] data_source", long_options,
 			"Check a (complete) confiuration for syntax and common conceptual errors."
 			"\n\nChecks the well-formedness of an XML configuration, its conformance to the configured DTD/schema and for the presence of common misconfigurations."
diff -r f059ec7ced7a -r b230ffa2ecdc tools/crmadmin.c
--- a/tools/crmadmin.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/crmadmin.c	Mon Jul 12 18:48:04 2010 +0200
@@ -128,7 +128,7 @@ main(int argc, char **argv)
 	int argerr = 0;
 	int flag;
 
-	crm_log_init(basename(argv[0]), LOG_ERR, FALSE, TRUE, argc, argv);
+	crm_log_init(NULL, LOG_ERR, FALSE, TRUE, argc, argv);
 	crm_set_options("V?$K:S:HE:Dd:i:Nqt:B", "command [options]", long_options,
 			"Development tool for performing some crmd-specific commands."
 			"\n  Likely to be replaced by crm_node in the future" );
diff -r f059ec7ced7a -r b230ffa2ecdc tools/hb2openais.sh.in
--- a/tools/hb2openais.sh.in	Mon May 17 17:57:40 2010 +0200
+++ b/tools/hb2openais.sh.in	Mon Jul 12 18:48:04 2010 +0200
@@ -1,4 +1,4 @@
-#!/bin/sh
+#!/bin/bash
 
  # Copyright (C) 2008,2009 Dejan Muhamedagic <dmuhamedagic@suse.de>
  # 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/notifyServicelogEvent.c
--- a/tools/notifyServicelogEvent.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/notifyServicelogEvent.c	Mon Jul 12 18:48:04 2010 +0200
@@ -93,7 +93,7 @@ main (int argc, char *argv[])
     struct sl_event *event    = NULL;
     uint64_t         event_id = 0;
 	
-    crm_log_init("notifyServicelogEvent", LOG_INFO, FALSE, TRUE, 0, NULL);
+    crm_log_init_quiet("notifyServicelogEvent", LOG_INFO, FALSE, TRUE, argc, argv);
     crm_set_options("?$", "event_id ", long_options, "Gets called upon events written to servicelog database");
 	
     if (argc < 2) {
diff -r f059ec7ced7a -r b230ffa2ecdc tools/pingd.c
--- a/tools/pingd.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/pingd.c	Mon Jul 12 18:48:04 2010 +0200
@@ -1224,7 +1224,7 @@ main(int argc, char **argv)
 	    g_str_hash, g_str_equal,
 	    g_hash_destroy_str, g_hash_destroy_str);
 
-	crm_log_init(basename(argv[0]), LOG_INFO, TRUE, FALSE, argc, argv);
+	crm_log_init(NULL, LOG_INFO, TRUE, FALSE, argc, argv);
 	crm_set_options("V?$p:a:d:s:S:h:Dm:N:Ui:t:n:", NULL, long_options,
 			"Daemon for checking external connectivity and making the results available to the cluster");
 	
@@ -1311,7 +1311,7 @@ main(int argc, char **argv)
 	    goto start_ping;
 	}
 	
-#if SUPPORT_AIS
+#if SUPPORT_COROSYNC
 	if(is_openais_cluster()) {
 	    stand_alone = TRUE;
 	}
diff -r f059ec7ced7a -r b230ffa2ecdc tools/regression.sh
--- a/tools/regression.sh	Mon May 17 17:57:40 2010 +0200
+++ b/tools/regression.sh	Mon Jul 12 18:48:04 2010 +0200
@@ -1,7 +1,7 @@
 #!/bin/bash
 
 : ${shadow=tools-regression}
-base=`dirname $0`
+test_home=`dirname $0`
 num_errors=0
 num_passed=0
 GREP_OPTIONS=
@@ -36,9 +36,14 @@ function usage() {
 
 done=0
 do_save=0
+VALGRIND_CMD=
 while test "$done" = "0"; do
     case "$1" in
-	-v) verbose=1; shift;;
+	-V|--verbose) verbose=1; shift;;
+	-v|--valgrind) 
+	    export G_SLICE=always-malloc
+	    VALGRIND_CMD="valgrind -q --show-reachable=no --leak-check=full --trace-children=no --time-stamp=yes --num-callers=20 --suppressions=$test_home/cli.supp"
+	    shift;;
 	-x) set -x; shift;;
 	-s) do_save=1; shift;;
 	-p) PATH="$2:$PATH"; export PATH; shift 1;;
@@ -49,70 +54,70 @@ while test "$done" = "0"; do
 done
 
 function test_tools() {
-    export CIB_shadow_dir=$base
-    crm_shadow --batch --force --create-empty $shadow
+    export CIB_shadow_dir=$test_home
+    $VALGRIND_CMD crm_shadow --batch --force --create-empty $shadow
     export CIB_shadow=$shadow
-    cibadmin -Q
+    $VALGRIND_CMD cibadmin -Q
     
-    cibadmin -E 
+    $VALGRIND_CMD cibadmin -E 
     assert $? 1 cibadmin "Require --force for CIB erasure"
     
-    cibadmin -E --force
+    $VALGRIND_CMD cibadmin -E --force
     assert $? 0 cibadmin "Allow CIB erasure with --force"
     
-    cibadmin -Q > /tmp/$$.existing.xml
+    $VALGRIND_CMD cibadmin -Q > /tmp/$$.existing.xml
     assert $? 0 cibadmin "Query CIB"
 
-    crm_attribute -n cluster-delay -v 60s
+    $VALGRIND_CMD crm_attribute -n cluster-delay -v 60s
     assert $? 0 crm_attribute "Set cluster option"
 
-    cibadmin -Q -o crm_config | grep cib-bootstrap-options-cluster-delay 
+    $VALGRIND_CMD cibadmin -Q -o crm_config | grep cib-bootstrap-options-cluster-delay 
     assert $? 0 cibadmin "Query new cluster option"
 
-    cibadmin -Q -o crm_config > /tmp/$$.opt.xml
+    $VALGRIND_CMD cibadmin -Q -o crm_config > /tmp/$$.opt.xml
     assert $? 0 cibadmin "Query cluster options"
     
-    cibadmin -D -o crm_config --xml-text '<nvpair id="cib-bootstrap-options-cluster-delay"/>'
+    $VALGRIND_CMD cibadmin -D -o crm_config --xml-text '<nvpair id="cib-bootstrap-options-cluster-delay"/>'
     assert $? 0 cibadmin "Delete nvpair"
     
-    cibadmin -C -o crm_config --xml-file /tmp/$$.opt.xml 
+    $VALGRIND_CMD cibadmin -C -o crm_config --xml-file /tmp/$$.opt.xml 
     assert $? 21 cibadmin "Create operaton should fail with: -21, The object already exists"
     
-    cibadmin -M -o crm_config --xml-file /tmp/$$.opt.xml
+    $VALGRIND_CMD cibadmin -M -o crm_config --xml-file /tmp/$$.opt.xml
     assert $? 0 cibadmin "Modify cluster options section"
     
-    cibadmin -Q -o crm_config | grep cib-bootstrap-options-cluster-delay 
+    $VALGRIND_CMD cibadmin -Q -o crm_config | grep cib-bootstrap-options-cluster-delay 
     assert $? 0 cibadmin "Query updated cluster option"
     
-    crm_attribute -n cluster-delay -v 40s -s duplicate 
+    $VALGRIND_CMD crm_attribute -n cluster-delay -v 40s -s duplicate 
     assert $? 0 crm_attribute "Set duplicate cluster option"
     
-    crm_attribute -n cluster-delay -v 30s 
+    $VALGRIND_CMD crm_attribute -n cluster-delay -v 30s 
     assert $? 216 crm_attribute "Setting multiply defined cluster option should fail with -216, Could not set cluster option"
     
-    crm_attribute -n cluster-delay -v 30s -s duplicate
+    $VALGRIND_CMD crm_attribute -n cluster-delay -v 30s -s duplicate
     assert $? 0 crm_attribute "Set cluster option with -s"
     
-    crm_attribute -n cluster-delay -D -i cib-bootstrap-options-cluster-delay
+    $VALGRIND_CMD crm_attribute -n cluster-delay -D -i cib-bootstrap-options-cluster-delay
     assert $? 0 crm_attribute "Delete cluster option with -i"
     
-    cibadmin -C -o nodes --xml-text '<node id="clusterNode-UUID" uname="clusterNode-UNAME" type="member">'
+    $VALGRIND_CMD cibadmin -C -o nodes --xml-text '<node id="clusterNode-UUID" uname="clusterNode-UNAME" type="member">'
     assert $? 0 cibadmin "Create node entry"
     
-    cibadmin -C -o status --xml-text '<node_state id="clusterNode-UUID" uname="clusterNode-UNAME"/>'
+    $VALGRIND_CMD cibadmin -C -o status --xml-text '<node_state id="clusterNode-UUID" uname="clusterNode-UNAME"/>'
     assert $? 0 cibadmin "Create node status entry"
         
-    crm_attribute -n ram -v 1024M -U clusterNode-UNAME -t nodes
+    $VALGRIND_CMD crm_attribute -n ram -v 1024M -U clusterNode-UNAME -t nodes
     assert $? 0 crm_attribute "Create node attribute"
     
-    cibadmin -Q -o nodes | grep clusterNode-UUID-ram 
+    $VALGRIND_CMD cibadmin -Q -o nodes | grep clusterNode-UUID-ram 
     assert $? 0 cibadmin "Query new node attribute"
     
-    cibadmin -Q | cibadmin -5 -p 2>&1 > /dev/null
+    $VALGRIND_CMD cibadmin -Q | cibadmin -5 -p 2>&1 > /dev/null
     assert $? 0 cibadmin "Digest calculation"
     
     # This update will fail because it has version numbers
-    cibadmin -R --xml-file /tmp/$$.existing.xml
+    $VALGRIND_CMD cibadmin -R --xml-file /tmp/$$.existing.xml
     assert $? 45 cibadmin "Replace operation should fail with: -45, Update was older than existing configuration"
 
     crm_standby -N clusterNode-UNAME -G
@@ -127,49 +132,49 @@ function test_tools() {
     crm_standby -N clusterNode-UNAME -D
     assert $? 0 crm_standby "Delete standby value"
     
-    cibadmin -C -o resources --xml-text '<primitive id="dummy" class="ocf" provider="pacemaker" type="Dummy"/>'
+    $VALGRIND_CMD cibadmin -C -o resources --xml-text '<primitive id="dummy" class="ocf" provider="pacemaker" type="Dummy"/>'
     assert $? 0 cibadmin "Create a resource"
 
-    crm_resource -r dummy --meta -p is-managed -v false
+    $VALGRIND_CMD crm_resource -r dummy --meta -p is-managed -v false
     assert $? 0 crm_resource "Create a resource meta attribute"
 
-    crm_resource -r dummy --meta -g is-managed
+    $VALGRIND_CMD crm_resource -r dummy --meta -g is-managed
     assert $? 0 crm_resource "Query a resource meta attribute"
 
-    crm_resource -r dummy --meta -d is-managed
+    $VALGRIND_CMD crm_resource -r dummy --meta -d is-managed
     assert $? 0 crm_resource "Remove a resource meta attribute"
 
-    crm_resource -r dummy -p delay -v 10s
+    $VALGRIND_CMD crm_resource -r dummy -p delay -v 10s
     assert $? 0 crm_resource "Create a resource attribute"
 
-    crm_resource -L
+    $VALGRIND_CMD crm_resource -L
     assert $? 0 crm_resource "List the configured resources"
 
     crm_failcount -r dummy -v 10 -N clusterNode-UNAME
     assert $? 0 crm_resource "Set a resource's fail-count"
 
-    crm_resource -r dummy -M
+    $VALGRIND_CMD crm_resource -r dummy -M
     assert $? 244 crm_resource "Require a destination when migrating a resource that is stopped"
 
-    crm_resource -r dummy -M -N i.dont.exist
+    $VALGRIND_CMD crm_resource -r dummy -M -N i.dont.exist
     assert $? 234 crm_resource "Don't support migration to non-existant locations"
 
-    crm_resource -r dummy -M -N clusterNode-UNAME
+    $VALGRIND_CMD crm_resource -r dummy -M -N clusterNode-UNAME
     assert $? 0 crm_resource "Migrate a resource"
 
-    crm_resource -r dummy -U
+    $VALGRIND_CMD crm_resource -r dummy -U
     assert $? 0 crm_resource "Un-migrate a resource"
  }
 
-test_tools 2>&1 | sed s/cib-last-written.*\>/\>/ > $base/regression.out
+test_tools 2>&1 | sed s/cib-last-written.*\>/\>/ > $test_home/regression.out
 rc=$?
 
 if [ $do_save = 1 ]; then
-    cp $base/regression.out $base/regression.exp
+    cp $test_home/regression.out $test_home/regression.exp
 fi
 
-grep -e "^*" $base/regression.out
-diff -u $base/regression.exp $base/regression.out 
+grep -e "^*" $test_home/regression.out
+diff -u $test_home/regression.exp $test_home/regression.out 
 diff_rc=$?
 
 if [ $rc != 0 ]; then
diff -r f059ec7ced7a -r b230ffa2ecdc tools/report.collector
--- a/tools/report.collector	Mon May 17 17:57:40 2010 +0200
+++ b/tools/report.collector	Mon Jul 12 18:48:04 2010 +0200
@@ -404,6 +404,7 @@ sys_info() {
     fi
 
     cibadmin --version 2>&1
+    cibadmin -! 2>&1
     case $1 in
 	openais)
 	    : echo "openais version: how?"
@@ -495,6 +496,7 @@ get_logfile() {
 	fi
     fi
 
+    debug "Reading $cf_type log settings"
     case $cf_type in
 	openais|corosync)
 	    debug "Reading log settings from $cf_file"
@@ -514,6 +516,9 @@ get_logfile() {
 		logfile=`getcfvar $cf_type logfile $cf_file`
 	    fi
 	    ;;
+	*) debug "Unknown cluster type: $cf_type"
+	   echo "/var/log/messages"
+	   ;;
     esac
 
     if [ "x$logfile" != "x" -a -f "$logfile" ]; then
diff -r f059ec7ced7a -r b230ffa2ecdc tools/report.common
--- a/tools/report.common	Mon May 17 17:57:40 2010 +0200
+++ b/tools/report.common	Mon Jul 12 18:48:04 2010 +0200
@@ -589,14 +589,10 @@ find_cluster_cf() {
 	    # TODO: Technically these could be anywhere :-/
 	    for cf in /etc/ais/openais.conf /etc/corosync/corosync.conf; do
 		if [ -f $cf ]; then
-		    if 
-			grep -qs pacemaker $cf
-		    then
-			size=`wc -l $cf | awk '{print $1}'`
-			if [ $size -gt $best_size ]; then
-			    best_size=$size
-			    best_file=$cf
-			fi
+		    size=`wc -l $cf | awk '{print $1}'`
+		    if [ $size -gt $best_size ]; then
+			best_size=$size
+			best_file=$cf
 		    fi
 		fi
 	    done
@@ -615,6 +611,9 @@ find_cluster_cf() {
 		echo "$cf"
 	    fi
 	    ;;
+	*)
+	    warning "Unknown cluster type: $1"
+	    ;;
     esac
 }
 
diff -r f059ec7ced7a -r b230ffa2ecdc tools/test.iso8601.c
--- a/tools/test.iso8601.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/test.iso8601.c	Mon Jul 12 18:48:04 2010 +0200
@@ -53,7 +53,7 @@ main(int argc, char **argv)
 	char *input_s = NULL;
 	char *mutable_s = NULL;
 	
-	crm_log_init("iso8601", LOG_INFO, FALSE, TRUE, 0, NULL);
+	crm_log_init_quiet(NULL, LOG_INFO, FALSE, TRUE, argc, argv);
 	crm_set_options("V?d:p:D:WOLn", "command [output modifier] ", long_options, "Display and parse ISO8601 dates and times");
 	
 	if(argc < 2) {
diff -r f059ec7ced7a -r b230ffa2ecdc tools/xml_diff.c
--- a/tools/xml_diff.c	Mon May 17 17:57:40 2010 +0200
+++ b/tools/xml_diff.c	Mon Jul 12 18:48:04 2010 +0200
@@ -85,7 +85,7 @@ main(int argc, char **argv)
 
 	int option_index = 0;
 
-	crm_log_init("crm_diff", LOG_CRIT-1, FALSE, FALSE, 0, NULL);
+	crm_log_init_quiet(NULL, LOG_CRIT-1, FALSE, FALSE, argc, argv);
 	crm_set_options("V?$o:n:p:scfO:N:", "original_xml operation [options]", long_options,
 			"A tool for determining the differences between two xml files and/or applying the differences like a patch\n");
 
